il a tout de problemet je donne le frontend et le backend et corriger la connection des pages avec backend car il doit tout cree par l'admin     les classes les matiere affecter les etudiant et les ensignient et cree les emploit de temps d'apres tout les taches d'admin il cree a chaque compte sont sision pou etudier un cour en ligne   voila le backend project s'appelle backend     j'a 5 aplications    backend/accounts    /models.py   from django.contrib.auth.models import AbstractUser

from django.db import models

class CustomUser(AbstractUser):

    ROLE_CHOICES = (

        ('superadmin', 'Super Admin'),

        ('admin', 'Admin'),

        ('teacher', 'Teacher'),

        ('student', 'Student'),

    )

    role = models.CharField(max_length=15, choices=ROLE_CHOICES, default='student')

    approved = models.BooleanField(default=False)

    specialty = models.ForeignKey(

        'classes.Specialty',

        on_delete=models.SET_NULL,

        null=True,

        blank=True,

        related_name='teachers'

    )

    email = models.EmailField(unique=True)

    USERNAME_FIELD = 'email'

    REQUIRED_FIELDS = ['username']

    def __str__(self):

        return self.username

permissions.py   

# backend/accounts/permissions.py

from rest_framework.permissions import BasePermission

class IsSuperAdmin(BasePermission):

    def has_permission(self, request, view):

        return bool(

            request.user

            and request.user.is_authenticated

            and getattr(request.user, "role", None) == "superadmin"

        )

class IsAdmin(BasePermission):

    def has_permission(self, request, view):

        return bool(

            request.user

            and request.user.is_authenticated

            and getattr(request.user, "role", None) in ["admin", "superadmin"]

        )

class IsTeacher(BasePermission):

    def has_permission(self, request, view):

        return bool(

            request.user

            and request.user.is_authenticated

            and getattr(request.user, "role", None) == "teacher"

        )

class IsStudent(BasePermission):

    def has_permission(self, request, view):

        return bool(

            request.user

            and request.user.is_authenticated

            and getattr(request.user, "role", None) == "student"

        )

serializers.py    

# backend/accounts/serializers.py ? VERSION FINALE CORRIGÉE À 1000%

from rest_framework import serializers

from django.contrib.auth import get_user_model

from django.contrib.auth.password_validation import validate_password

from classes.models import Specialty  # ON UTILISE CELUI DE CLASSES

User = get_user_model()

class UserSerializer(serializers.ModelSerializer):

    specialty = serializers.StringRelatedField(read_only=True)

    class Meta:

        model = User

        fields = (

            "id", "username", "email", "first_name", "last_name",

            "role", "approved", "specialty", "is_staff", "is_superuser"

        )

        read_only_fields = ("id", "approved", "is_staff", "is_superuser")

# accounts/serializers.py ? REMPLACE LE CHAMP specialty DANS RegisterSerializer PAR ÇA :

class RegisterSerializer(serializers.ModelSerializer):

    password = serializers.CharField(write_only=True, required=True, validators=[validate_password])

    

    # ON ACCEPTE LE NOM DE LA SPÉCIALITÉ (beaucoup plus simple pour le frontend)

    specialty = serializers.CharField(required=False, allow_blank=True, allow_null=True)

    class Meta:

        model = User

        fields = ("username", "email", "password", "first_name", "last_name", "role", "specialty")

    def validate(self, attrs):

        role = attrs.get("role")

        specialty_name = attrs.get("specialty")

        if role not in ["teacher", "student"]:

            raise serializers.ValidationError("Rôle invalide.")

        if role == "teacher":

            if not specialty_name:

                raise serializers.ValidationError("La spécialité est obligatoire pour les enseignants.")

            try:

                specialty_obj = Specialty.objects.get(name__iexact=specialty_name.strip())

                attrs["specialty"] = specialty_obj

            except Specialty.DoesNotExist:

                raise serializers.ValidationError(f"Spécialité '{specialty_name}' introuvable.")

        else:

            attrs["specialty"] = None

        return attrs

    def create(self, validated_data):

        password = validated_data.pop("password")

        specialty = validated_data.pop("specialty", None)

        user = User(**validated_data)

        user.set_password(password)

        user.approved = False

        user.save()

        if specialty:

            user.specialty = specialty

            user.save()

        return user

class AdminCreateSerializer(serializers.ModelSerializer):

    password = serializers.CharField(write_only=True, required=True)

    class Meta:

        model = User

        fields = ("username", "email", "password", "role", "first_name", "last_name")

    def validate_role(self, value):

        if value != "admin":

            raise serializers.ValidationError("Ce endpoint ne crée que des comptes admin.")

        return value

    def create(self, validated_data):

        password = validated_data.pop("password")

        user = User(**validated_data)

        user.set_password(password)

        user.role = "admin"

        user.approved = True

        user.is_staff = True

        user.is_superuser = False

        user.save()

        return user

urls.py  

from django.urls import path

from .views import RegisterView, ProfileView, ApproveUserView, AdminCreateView, MyTokenObtainPairView, UserListView, PendingUserListView, get_users_by_role

from rest_framework_simplejwt.views import TokenRefreshView

urlpatterns = [

    path("register/", RegisterView.as_view(), name="register"),

    path("login/", MyTokenObtainPairView.as_view(), name="token_obtain_pair"),

    path("token/refresh/", TokenRefreshView.as_view(), name="token_refresh"),

    path("profile/", ProfileView.as_view(), name="profile"),

    path("approve/<int:pk>/", ApproveUserView.as_view(), name="approve-user"),

    path("admin-create/", AdminCreateView.as_view(), name="admin-create"),

    path("users/", UserListView.as_view(), name="users-list"),

    path("pending/", PendingUserListView.as_view(), name="pending-users"),  # Nouveau

    path('users/', get_users_by_role, name='users-by-role'),

]

views.py

from rest_framework import generics, permissions, status, serializers

from rest_framework.response import Response

from rest_framework_simplejwt.views import TokenObtainPairView

from rest_framework_simplejwt.serializers import TokenObtainPairSerializer

from django.contrib.auth import get_user_model

from django.db.models import Q

from classes.models import Class, Subject  # Pour assign

from notifications.models import Notification  # Pour notif

from .serializers import RegisterSerializer, UserSerializer, AdminCreateSerializer

from .permissions import IsSuperAdmin, IsAdmin

User = get_user_model()

class MyTokenObtainPairSerializer(TokenObtainPairSerializer):

    @classmethod

    def get_token(cls, user):

        token = super().get_token(user)

        token['role'] = user.role

        token['approved'] = user.approved

        return token

    def validate(self, attrs):

        if 'email' in attrs and 'username' not in attrs:

            attrs['username'] = attrs.get('email')

        data = super().validate(attrs)

        if not getattr(self.user, "approved", False):

            raise serializers.ValidationError({"detail": "User account is not approved yet."})

        data['role'] = getattr(self.user, "role", "")

        return data

class MyTokenObtainPairView(TokenObtainPairView):

    serializer_class = MyTokenObtainPairSerializer

class RegisterView(generics.CreateAPIView):

    queryset = User.objects.all()

    serializer_class = RegisterSerializer

    permission_classes = [permissions.AllowAny]

class AdminCreateView(generics.CreateAPIView):

    serializer_class = AdminCreateSerializer

    permission_classes = [IsSuperAdmin]

class ProfileView(generics.RetrieveAPIView):

    serializer_class = UserSerializer

    permission_classes = [permissions.IsAuthenticated]

    def get_object(self):

        return self.request.user

class UserListView(generics.ListAPIView):

    serializer_class = UserSerializer

    permission_classes = [IsAdmin | IsSuperAdmin]

    def get_queryset(self):

        return User.objects.all()

class PendingUserListView(generics.ListAPIView):

    serializer_class = UserSerializer

    permission_classes = [IsAdmin | IsSuperAdmin]

    def get_queryset(self):

        return User.objects.filter(approved=False, role__in=['student', 'teacher'])

# accounts/views.py ? VERSION FINALE QUI ACCEPTE POST SUR /api/accounts/approve/<id>/

class ApproveUserView(generics.UpdateAPIView):

    permission_classes = [IsAdmin | IsSuperAdmin]

    queryset = User.objects.all()

    lookup_field = 'pk'

    def post(self, request, *args, **kwargs):  # POST au lieu de patch

        user = self.get_object()

        action = request.data.get("action", "approve")

        if action == "reject":

            user.delete()

            return Response({"detail": "Compte refusé et supprimé"})

        if user.role == "student":

            class_id = request.data.get("class_id")

            if not class_id:

                return Response({"detail": "class_id requis pour étudiant"}, status=400)

            try:

                cls = Class.objects.get(id=class_id)

                if cls.students.count() >= 30:

                    return Response({"detail": "Classe pleine"}, status=400)

                cls.students.add(user)

            except Class.DoesNotExist:

                return Response({"detail": "Classe invalide"}, status=400)

        user.approved = True

        user.save()

        Notification.objects.create(

            user=user,

            message="Votre compte a été approuvé ! Bienvenue sur ITEAM University !"

        )

        return Response({"detail": f"{user.username} approuvé avec succès !"})

    

# accounts/views.py

from rest_framework.decorators import api_view

from rest_framework.response import Response

from rest_framework import status

from .models import CustomUser

from .serializers import UserSerializer  # Assure-toi que ce serializer existe

@api_view(['GET'])

def get_users_by_role(request):

    """

    Endpoint: GET /api/accounts/users/

    Params: ?role=student&approved=true

    Retourne uniquement les utilisateurs filtrés par rôle et statut approuvé

    """

    role = request.query_params.get('role')

    approved = request.query_params.get('approved')

    users = CustomUser.objects.all()

    if role:

        users = users.filter(role=role)

    if approved == 'true':  # ou approved in ['true', 'True', '1']

        users = users.filter(approved=True)

    serializer = UserSerializer(users, many=True)

    return Response(serializer.data, status=status.HTTP_200_OK)

backend/backend c'est le project                        settings.py

# backend/backend/settings.py ? VERSION FINALE ULTIME (2025)

import os

from pathlib import Path

from datetime import timedelta

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'django-insecure-change-me-in-production-123456789'

DEBUG = True

ALLOWED_HOSTS = ['*']  # OK en dev

INSTALLED_APPS = [

    'django.contrib.admin',

    'django.contrib.auth',

    'django.contrib.contenttypes',

    'django.contrib.sessions',

    'django.contrib.messages',

    'django.contrib.staticfiles',

    # Apps tierces

    'rest_framework',

    'rest_framework_simplejwt',

    'corsheaders',

    'channels',

    # Tes apps

    'accounts',

    'classes',

    'courses',

    'lms_sessions',

    'notifications',

    

]

MIDDLEWARE = [

    'corsheaders.middleware.CorsMiddleware',  # TOUJOURS EN PREMIER

    'django.middleware.security.SecurityMiddleware',

    'django.contrib.sessions.middleware.SessionMiddleware',

    'django.middleware.common.CommonMiddleware',

    'django.middleware.csrf.CsrfViewMiddleware',

    'django.contrib.auth.middleware.AuthenticationMiddleware',

    'django.contrib.messages.middleware.MessageMiddleware',

    'django.middleware.clickjacking.XFrameOptionsMiddleware',

]

ROOT_URLCONF = 'backend.urls'

TEMPLATES = [

    {

        'BACKEND': 'django.template.backends.django.DjangoTemplates',

        'DIRS': [BASE_DIR / 'templates'],

        'APP_DIRS': True,

        'OPTIONS': {

            'context_processors': [

                'django.template.context_processors.debug',

                'django.template.context_processors.request',

                'django.contrib.auth.context_processors.auth',

                'django.contrib.messages.context_processors.messages',

            ],

        },

    },

]

WSGI_APPLICATION = 'backend.wsgi.application'

ASGI_APPLICATION = 'backend.asgi.application'

DATABASES = {

    'default': {

        'ENGINE': 'django.db.backends.sqlite3',

        'NAME': BASE_DIR / 'db.sqlite3',

    }

}

AUTH_USER_MODEL = 'accounts.CustomUser'

REST_FRAMEWORK = {

    'DEFAULT_AUTHENTICATION_CLASSES': (

        'rest_framework_simplejwt.authentication.JWTAuthentication',

    ),

    'DEFAULT_PERMISSION_CLASSES': [

        'rest_framework.permissions.IsAuthenticated',

    ],

}

SIMPLE_JWT = {

    'ACCESS_TOKEN_LIFETIME': timedelta(days=7),

    'REFRESH_TOKEN_LIFETIME': timedelta(days=30),

}

# CORS – EN DEV ON OUVRE TOUT

CORS_ALLOW_ALL_ORIGINS = True  # Change en prod

CORS_ALLOW_CREDENTIALS = True

# Channel Layers (Redis)

CHANNEL_LAYERS = {

    "default": {

        "BACKEND": "channels_redis.core.RedisChannelLayer",

        "CONFIG": {

            "hosts": [("127.0.0.1", 6379)],

        },

    },

}

# Static & Media

STATIC_URL = '/static/'

STATICFILES_DIRS = [BASE_DIR / "static"]

STATIC_ROOT = BASE_DIR / "staticfiles"

MEDIA_URL = '/media/'

MEDIA_ROOT = BASE_DIR / "media"

LANGUAGE_CODE = 'fr-fr'

TIME_ZONE = 'Africa/Casablanca'

USE_I18N = True

USE_TZ = True

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# LOGS POUR VOIR LES ERREURS 500

LOGGING = {

    'version': 1,

    'disable_existing_loggers': False,

    'handlers': {

        'console': {

            'class': 'logging.StreamHandler',

        },

    },

    'root': {

        'handlers': ['console'],

        'level': 'DEBUG',

    },

}

asgi.py

# backend/asgi.py

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_asgi_application()  # Important : charger Django avant Channels

from channels.routing import ProtocolTypeRouter, URLRouter

from channels.auth import AuthMiddlewareStack

import notifications.routing

application = ProtocolTypeRouter({

    "http": get_asgi_application(),

    "websocket": AuthMiddlewareStack(

        URLRouter(

            notifications.routing.websocket_urlpatterns

        )

    ),

})

admin.py

from django.contrib import admin

from accounts.models import CustomUser

from classes.models import Class, Subject

from courses.models import Course, File

from lms_sessions.models import Session, Test, TestScore

from notifications.models import Notification, ChatMessage

admin.site.register(CustomUser)

admin.site.register(Class)

admin.site.register(Subject)

admin.site.register(Course)

admin.site.register(File)

admin.site.register(Session)

admin.site.register(Test)

admin.site.register(TestScore)

admin.site.register(Notification)

admin.site.register(ChatMessage)

urls.py

# backend/urls.py ? LA VÉRITÉ ABSOLUE – VERSION FINALE 2025

from django.contrib import admin

from django.urls import path, include

from django.conf import settings

from django.conf.urls.static import static

urlpatterns = [

    path("admin/", admin.site.urls),

    # API ROUTES – TOUT EST PARFAIT

    path("api/accounts/", include("accounts.urls")),

    path("api/classes/", include("classes.urls")),        # classes + subjects + specialties

    path("api/courses/", include("courses.urls")),

    path("api/lms/", include("lms_sessions.urls")),

    path("api/notifications/", include("notifications.urls")),

    # RACCOURCI DIRECT POUR LE SIGNUP (très utile, on le garde)

    path("api/specialties/", include("classes.urls")),   # PERMET /api/specialties/specialties/

]

if settings.DEBUG:

    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

wsgi.py

"""

WSGI config for backend project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see

https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/

"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_wsgi_application()

backend/classes/      models.py

# classes/models.py ? VERSION FINALE PARFAITE (RIEN À CHANGER)

from django.db import models

from accounts.models import CustomUser

class Specialty(models.Model):

    name = models.CharField(max_length=100, unique=True)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:

        verbose_name_plural = "Specialties"

        ordering = ['name']

    def __str__(self):

        return self.name

class Class(models.Model):

    name = models.CharField(max_length=50, unique=True)

    max_students = models.IntegerField(default=30)

    

    # Relation ManyToMany avec CustomUser

    students = models.ManyToManyField(CustomUser, related_name='enrolled_classes', blank=True)

    def student_count(self):

        return self.students.count()

    def is_full(self):

        return self.student_count() >= self.max_students

    def __str__(self):

        return self.name

class Subject(models.Model):

    name = models.CharField(max_length=100)

    class_assigned = models.ForeignKey(Class, on_delete=models.CASCADE, related_name='subjects')

    teacher = models.ForeignKey(

        CustomUser,

        on_delete=models.SET_NULL,

        null=True,

        blank=True,

        limit_choices_to={'role': 'teacher'},

        related_name='teaching_subjects'

    )

    specialty = models.ForeignKey(Specialty, on_delete=models.SET_NULL, null=True, blank=True)

    class Meta:

        unique_together = ('name', 'class_assigned')

    def __str__(self):

        return f"{self.name} - {self.class_assigned.name}"

serializers.py

# backend/classes/serializers.py ? VERSION FINALE QUI RÉSOUT TOUT (2025)

from rest_framework import serializers

from .models import Class, Subject, Specialty

from accounts.models import CustomUser

# Pour afficher les détails d'un étudiant dans la classe

class StudentInClassSerializer(serializers.ModelSerializer):

    full_name = serializers.CharField(source='get_full_name', read_only=True)

    class Meta:

        model = CustomUser

        fields = ['id', 'username', 'first_name', 'last_name', 'full_name', 'email']

# Pour afficher les matières avec le nom complet du prof

class SubjectInClassSerializer(serializers.ModelSerializer):

    teacher_name = serializers.CharField(source='teacher.get_full_name', read_only=True, allow_null=True)

    teacher_username = serializers.CharField(source='teacher.username', read_only=True, allow_null=True)

    specialty_name = serializers.CharField(source='specialty.name', read_only=True, allow_null=True)

    class Meta:

        model = Subject

        fields = [

            'id', 'name',

            'teacher', 'teacher_name', 'teacher_username',

            'specialty', 'specialty_name'

        ]

# LE PLUS IMPORTANT : ClassSerializer QUI ENVOIE TOUT AU FRONTEND

class ClassSerializer(serializers.ModelSerializer):

    students_count = serializers.SerializerMethodField()

    students = StudentInClassSerializer(many=True, read_only=True)        # ? TOUS LES ÉTUDIANTS

    subjects = SubjectInClassSerializer(many=True, read_only=True)        # ? TOUTES LES MATIÈRES + PROF

    class Meta:

        model = Class

        fields = [

            'id', 'name', 'max_students',

            'students_count', 'students', 'subjects'

        ]

    def get_students_count(self, obj):

        return obj.students.count()

# Les autres serializers (inchangés)

class SpecialtySerializer(serializers.ModelSerializer):

    class Meta:

        model = Specialty

        fields = ['id', 'name']

class SubjectSerializer(serializers.ModelSerializer):

    class_name = serializers.CharField(source='class_assigned.name', read_only=True)

    teacher_name = serializers.CharField(source='teacher.get_full_name', read_only=True, allow_null=True)

    teacher_username = serializers.CharField(source='teacher.username', read_only=True, allow_null=True)

    specialty_name = serializers.CharField(source='specialty.name', read_only=True, allow_null=True)

    class Meta:

        model = Subject

        fields = [

            'id', 'name', 'class_assigned', 'class_name',

            'teacher', 'teacher_name', 'teacher_username',

            'specialty', 'specialty_name'

        ]

urls.py

# classes/urls.py ? RIEN À CHANGER

from rest_framework.routers import DefaultRouter

from .views import ClassViewSet, SubjectViewSet, SpecialtyViewSet

router = DefaultRouter()

router.register(r'classes', ClassViewSet)

router.register(r'subjects', SubjectViewSet)

router.register(r'specialties', SpecialtyViewSet)

urlpatterns = router.urls

views.py

# classes/views.py ? VERSION FINALE CORRIGÉE AVEC GESTION AUTOMATIQUE DES COMPTES

from rest_framework import viewsets, status, permissions

from rest_framework.decorators import action

from rest_framework.response import Response

from django.contrib.auth import get_user_model

from django.shortcuts import get_object_or_404

from django.db.models import Q

from django.db import transaction

from .models import Class, Subject, Specialty

from .serializers import ClassSerializer, SubjectSerializer, SpecialtySerializer

from accounts.permissions import IsAdmin, IsSuperAdmin

User = get_user_model()

# ========================================

# 1. SPÉCIALITÉS ? LISTE PUBLIQUE

# ========================================

class SpecialtyViewSet(viewsets.ModelViewSet):

    queryset = Specialty.objects.all().order_by('name')

    serializer_class = SpecialtySerializer

    def get_permissions(self):

        """

        list/retrieve ? TOUT LE MONDE

        create/update/destroy ? admin seulement

        """

        if self.action in ['list', 'retrieve']:

            return [permissions.AllowAny()]

        return [permissions.IsAdminUser()]

# ========================================

# 2. GESTION DES CLASSES - AVEC LOGIQUE DE SUPPRESSION INTELLIGENTE

# ========================================

class ClassViewSet(viewsets.ModelViewSet):

    queryset = Class.objects.all().prefetch_related('subjects', 'students')

    serializer_class = ClassSerializer

    permission_classes = [IsAdmin | IsSuperAdmin]

    @action(detail=True, methods=['post'], url_path='add-student')

    def add_student(self, request, pk=None):

        """Ajouter un étudiant à la classe et le valider"""

        cls = self.get_object()

        user_id = request.data.get("user_id")

        if not user_id:

            return Response({"detail": "user_id requis"}, status=status.HTTP_400_BAD_REQUEST)

        user = get_object_or_404(User, pk=user_id, role='student')

        if cls.student_count() >= 30:

            return Response({"detail": "Cette classe est pleine (30 étudiants max)"}, status=400)

        cls.students.add(user)

        user.approved = True

        user.save()

        return Response({

            "detail": f"{user.username} ajouté à {cls.name} et approuvé !"

        }, status=200)

    @action(detail=True, methods=['post'], url_path='remove-student')

    def remove_student(self, request, pk=None):

        """Retirer un étudiant de la classe et le remettre en attente"""

        cls = self.get_object()

        user_id = request.data.get("user_id")

        

        if not user_id:

            return Response({"detail": "user_id requis"}, status=400)

        

        user = get_object_or_404(User, pk=user_id, role='student')

        cls.students.remove(user)

        

        # IMPORTANT: Remettre l'étudiant en attente

        user.approved = False

        user.save()

        

        return Response({

            "detail": f"{user.username} retiré de la classe et repassé en attente"

        }, status=200)

    def destroy(self, request, *args, **kwargs):

        """

        NOUVELLE MÉTHODE: Suppression intelligente de classe

        - Supprime la classe et toutes ses matières (cascade automatique)

        - Remet TOUS les étudiants en attente

        - Remet les enseignants en attente SEULEMENT s'ils n'enseignent plus nulle part

        """

        cls = self.get_object()

        

        try:

            with transaction.atomic():

                # 1. Récupérer tous les étudiants AVANT la suppression

                students_to_unapprove = list(cls.students.all())

                

                # 2. Récupérer tous les enseignants concernés AVANT la suppression

                teacher_ids = list(

                    cls.subjects.exclude(teacher__isnull=True)

                    .values_list('teacher_id', flat=True)

                    .distinct()

                )

                

                # 3. Supprimer la classe (les matières sont supprimées automatiquement via CASCADE)

                class_name = cls.name

                cls.delete()

                

                # 4. Remettre TOUS les étudiants en attente

                students_count = 0

                for student in students_to_unapprove:

                    student.approved = False

                    student.save()

                    students_count += 1

                

                # 5. Pour chaque enseignant, vérifier s'il enseigne encore ailleurs

                teachers_unapproved = 0

                for teacher_id in teacher_ids:

                    try:

                        teacher = User.objects.get(id=teacher_id)

                        

                        # Compter combien de matières il enseigne encore (dans d'autres classes)

                        remaining_subjects_count = Subject.objects.filter(teacher=teacher).count()

                        

                        # Si plus aucune matière, remettre en attente

                        if remaining_subjects_count == 0:

                            teacher.approved = False

                            teacher.save()

                            teachers_unapproved += 1

                            

                    except User.DoesNotExist:

                        continue

                

                # 6. Message de confirmation détaillé

                message = f"Classe '{class_name}' supprimée avec succès. "

                message += f"{students_count} étudiant(s) remis en attente. "

                

                if teachers_unapproved > 0:

                    message += f"{teachers_unapproved} enseignant(s) remis en attente (plus de classes assignées)."

                else:

                    message += "Les enseignants restent validés (ils enseignent dans d'autres classes)."

                

                return Response(

                    {"detail": message},

                    status=status.HTTP_200_OK

                )

                

        except Exception as e:

            return Response(

                {"detail": f"Erreur lors de la suppression: {str(e)}"},

                status=status.HTTP_500_INTERNAL_SERVER_ERROR

            )

# ========================================

# 3. GESTION DES MATIÈRES + ASSIGNATION

# ========================================

class SubjectViewSet(viewsets.ModelViewSet):

    queryset = Subject.objects.select_related('teacher', 'class_assigned', 'specialty')

    serializer_class = SubjectSerializer

    permission_classes = [IsAdmin | IsSuperAdmin]

    @action(detail=True, methods=['post'], url_path='assign-teacher')

    def assign_teacher(self, request, pk=None):

        """Assigner un enseignant à une matière"""

        subject = self.get_object()

        teacher_id = request.data.get('teacher_id')

        if not teacher_id:

            return Response({"detail": "teacher_id requis"}, status=400)

        teacher = get_object_or_404(User, pk=teacher_id, role='teacher')

        # Vérification spécialité

        if subject.specialty and teacher.specialty != subject.specialty.name:

            return Response({

                "detail": f"Spécialité requise : {subject.specialty.name}"

            }, status=400)

        # Désassigner l'ancien prof si nécessaire

        old_teacher = subject.teacher

        

        # Assigner le nouveau

        subject.teacher = teacher

        subject.save()

        teacher.approved = True

        teacher.save()

        

        # Si ancien prof existe, vérifier s'il enseigne encore ailleurs

        if old_teacher and old_teacher.id != teacher.id:

            remaining_subjects = Subject.objects.filter(teacher=old_teacher).count()

            if remaining_subjects == 0:

                old_teacher.approved = False

                old_teacher.save()

        return Response({

            "detail": f"{teacher.username} assigné à {subject.name} et approuvé !"

        }, status=200)

    def destroy(self, request, *args, **kwargs):

        """

        Suppression intelligente de matière

        - Si l'enseignant n'a plus de matières après, il est remis en attente

        """

        subject = self.get_object()

        teacher = subject.teacher

        subject_name = subject.name

        

        # Supprimer la matière

        subject.delete()

        

        # Si un enseignant était assigné, vérifier s'il enseigne encore

        if teacher:

            remaining_subjects = Subject.objects.filter(teacher=teacher).count()

            if remaining_subjects == 0:

                teacher.approved = False

                teacher.save()

                return Response({

                    "detail": f"Matière '{subject_name}' supprimée. {teacher.username} remis en attente (plus de matières)."

                }, status=status.HTTP_200_OK)

        

        return Response({

            "detail": f"Matière '{subject_name}' supprimée."

        }, status=status.HTTP_200_OK)

    @action(detail=False, methods=['get'], url_path='teachers-by-specialty')

    def teachers_by_specialty(self, request):

        """Liste des enseignants par spécialité"""

        specialty_id = request.query_params.get('specialty_id')

        if not specialty_id:

            return Response({"detail": "specialty_id requis"}, status=400)

        teachers = User.objects.filter(

            role='teacher',

            specialty_id=specialty_id

        ).values('id', 'username', 'email', 'first_name', 'last_name', 'approved')

        return Response({

            "teachers": list(teachers),

            "count": teachers.count()

        })

backend/courses    models.py

from django.db import models

from classes.models import Subject

from accounts.models import CustomUser

class Course(models.Model):

    title = models.CharField(max_length=200)

    description = models.TextField()

    subject = models.ForeignKey(Subject, on_delete=models.CASCADE)

    teacher = models.ForeignKey(

        CustomUser,

        limit_choices_to={'role': 'teacher'},

        on_delete=models.CASCADE

    )

class File(models.Model):

    course = models.ForeignKey(Course, on_delete=models.CASCADE)

    file = models.FileField(upload_to='courses/files/')

    uploaded_by = models.ForeignKey(CustomUser, on_delete=models.CASCADE)

    uploaded_at = models.DateTimeField(auto_now_add=True)

serializers.py

from rest_framework import serializers

from .models import Course, File

class CourseSerializer(serializers.ModelSerializer):

    class Meta:

        model = Course

        fields = ("id", "title", "description", "subject", "teacher")

        read_only_fields = ("teacher",)

class FileSerializer(serializers.ModelSerializer):

    class Meta:

        model = File

        fields = ("id", "course", "file", "uploaded_by", "uploaded_at")

        read_only_fields = ("uploaded_by", "uploaded_at")

urls.py

from rest_framework import routers

from .views import CourseViewSet

from django.urls import path, include

router = routers.DefaultRouter()

router.register(r"courses", CourseViewSet, basename="courses")

urlpatterns = [path("", include(router.urls))]

views.py

from rest_framework import viewsets, permissions

from .models import Course, File

from .serializers import CourseSerializer, FileSerializer

from accounts.permissions import IsTeacher, IsAdmin, IsStudent

class CourseViewSet(viewsets.ModelViewSet):

    queryset = Course.objects.all()

    serializer_class = CourseSerializer

    def get_permissions(self):

        if self.action in ("create", "update", "partial_update", "destroy"):

            return [IsTeacher() | IsAdmin()]

        return [permissions.IsAuthenticated()]

    def perform_create(self, serializer):

        serializer.save(teacher=self.request.user)

class FileViewSet(viewsets.ModelViewSet):

    queryset = File.objects.all()

    serializer_class = FileSerializer

    def get_permissions(self):

        if self.action == 'create':

            return [IsTeacher()]

        return [IsStudent() | IsTeacher() | IsAdmin()]

    def perform_create(self, serializer):

        serializer.save(uploaded_by=self.request.user)

backend/lms_sessions   models.py

# lms_sessions/models.py

from django.db import models

from accounts.models import CustomUser

class Session(models.Model):

    subject = models.ForeignKey('classes.Subject', on_delete=models.CASCADE, related_name='sessions')

    teacher = models.ForeignKey(CustomUser, on_delete=models.CASCADE, limit_choices_to={'role': 'teacher'})

    start_time = models.DateTimeField(auto_now_add=True)

    end_time = models.DateTimeField(null=True, blank=True)

    is_live = models.BooleanField(default=False)

    recorded_file = models.FileField(upload_to='recorded_sessions/', null=True, blank=True)

    def __str__(self):

        return f"{self.subject.name} - {self.teacher.username} ({'Live' if self.is_live else 'Terminé'})"

class Test(models.Model):

    subject = models.ForeignKey('classes.Subject', on_delete=models.CASCADE)

    title = models.CharField(max_length=200)

    file = models.FileField(upload_to='tests/')

    uploaded_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):

        return self.title

class TestScore(models.Model):

    test = models.ForeignKey(Test, on_delete=models.CASCADE, related_name='scores')

    student = models.ForeignKey(CustomUser, on_delete=models.CASCADE, limit_choices_to={'role': 'student'})

    score = models.FloatField()  # /20

    submitted_at = models.DateTimeField(auto_now_add=True)

    class Meta:

        unique_together = ('test', 'student')

        ordering = ['-score']

    def __str__(self):

        return f"{self.student.username} ? {self.score}/20"

serailizers.py

# lms_sessions/serializers.py

from rest_framework import serializers

from .models import Session, Test, TestScore

class SessionSerializer(serializers.ModelSerializer):

    subject_name = serializers.CharField(source='subject.name', read_only=True)

    teacher_name = serializers.CharField(source='teacher.username', read_only=True)

    class_name = serializers.CharField(source='subject.class_assigned.name', read_only=True)

    class Meta:

        model = Session

        fields = ['id', 'subject', 'subject_name', 'class_name', 'teacher', 'teacher_name', 'start_time', 'end_time', 'is_live']

        read_only_fields = ['teacher', 'start_time', 'end_time']

class TestSerializer(serializers.ModelSerializer):

    subject_name = serializers.CharField(source='subject.name', read_only=True)

    class Meta:

        model = Test

        fields = ['id', 'title', 'file', 'subject', 'subject_name', 'uploaded_at']

        read_only_fields = ['uploaded_at']

class TestScoreSerializer(serializers.ModelSerializer):

    student_name = serializers.CharField(source='student.username', read_only=True)

    test_title = serializers.CharField(source='test.title', read_only=True)

    class Meta:

        model = TestScore

        fields = ['id', 'test', 'test_title', 'student', 'student_name', 'score']

urls.py

# lms_sessions/urls.py

from django.urls import path, include

from rest_framework.routers import DefaultRouter

from .views import SessionViewSet, TestViewSet, TestScoreViewSet

router = DefaultRouter()

router.register(r'sessions', SessionViewSet)

router.register(r'tests', TestViewSet)

router.register(r'scores', TestScoreViewSet)

urlpatterns = [

    path('', include(router.urls)),

]

# lms_sessions/views.py

from rest_framework import viewsets, status

from rest_framework.decorators import action

from rest_framework.response import Response

from rest_framework.permissions import IsAuthenticated

from .models import Session, Test, TestScore

from .serializers import SessionSerializer, TestSerializer, TestScoreSerializer

from accounts.permissions import IsTeacher, IsStudent

class SessionViewSet(viewsets.ModelViewSet):

    queryset = Session.objects.all()

    serializer_class = SessionSerializer

    permission_classes = [IsAuthenticated]

    def perform_create(self, serializer):

        serializer.save(teacher=self.request.user)

    @action(detail=True, methods=['post'])

    def start_live(self, request, pk=None):

        session = self.get_object()

        if session.teacher != request.user:

            return Response({"error": "Pas autorisé"}, status=403)

        session.is_live = True

        session.save()

        return Response({"status": "live démarré", "session_id": session.id})

    @action(detail=True, methods=['post'])

    def stop_live(self, request, pk=None):

        session = self.get_object()

        session.is_live = False

        session.save()

        return Response({"status": "live terminé"})

class TestViewSet(viewsets.ModelViewSet):

    queryset = Test.objects.all()

    serializer_class = TestSerializer

    permission_classes = [IsAuthenticated, IsTeacher]

class TestScoreViewSet(viewsets.ReadOnlyModelViewSet):

    queryset = TestScore.objects.all()

    serializer_class = TestScoreSerializer

    permission_classes = [IsAuthenticated]

    @action(detail=False, methods=['get'])

    def ranking(self, request):

        test_id = request.query_params.get('test_id')

        if not test_id:

            return Response({"error": "test_id requis"}, status=400)

        scores = TestScore.objects.filter(test_id=test_id).select_related('student')

        serializer = self.get_serializer(scores, many=True)

        return Response(serializer.data)

backend/notifiactions  models.py   

# backend/notifications/models.py (version corrigée)

from django.db import models

from accounts.models import CustomUser

class Notification(models.Model):

    TYPE_CHOICES = [

        ('info', 'Information'),

        ('warning', 'Avertissement'),

        ('success', 'Succès'),

        ('error', 'Erreur'),

        ('reminder', 'Rappel'),

    ]

    

    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='notifications')

    title = models.CharField(max_length=255, default="Notification")

    message = models.TextField()

    notification_type = models.CharField(max_length=20, choices=TYPE_CHOICES, default='info')

    is_read = models.BooleanField(default=False)

    created_at = models.DateTimeField(auto_now_add=True)

    scheduled_time = models.DateTimeField(null=True, blank=True)

    

    class Meta:

        ordering = ['-created_at']

    

    def __str__(self):

        return f"{self.user.username} - {self.title}"

class ChatMessage(models.Model):

    session = models.ForeignKey('lms_sessions.Session', on_delete=models.CASCADE, related_name='chat_messages')

    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='chat_messages')

    message = models.TextField()

    timestamp = models.DateTimeField(auto_now_add=True)

    

    class Meta:

        ordering = ['timestamp']

    

    def __str__(self):

        return f"{self.user.username}: {self.message[:50]}"

consumers.py

# notifications/consumers.py

import json

from channels.generic.websocket import AsyncWebsocketConsumer

from channels.db import database_sync_to_async

from accounts.models import CustomUser

from lms_sessions.models import Session

from notifications.models import ChatMessage, Notification

class ChatConsumer(AsyncWebsocketConsumer):

    async def connect(self):

        self.session_id = self.scope["url_route"]["kwargs"]["session_id"]

        self.room_group_name = f"chat_{self.session_id}"

        # Vérifie que l'utilisateur a accès à cette session

        if await self.can_access_session():

            await self.channel_layer.group_add(self.room_group_name, self.channel_name)

            await self.accept()

        else:

            await self.close()

    async def disconnect(self, close_code):

        await self.channel_layer.group_discard(self.room_group_name, self.channel_name)

    async def receive(self, text_data):

        data = json.loads(text_data)

        message = data['message']

        # Sauvegarde du message

        chat_msg = await database_sync_to_async(ChatMessage.objects.create)(

            session_id=self.session_id,

            user=self.scope["user"],

            message=message

        )

        await self.channel_layer.group_send(

            self.room_group_name,

            {

                'type': 'chat_message',

                'message': message,

                'user': self.scope["user"].username,

                'timestamp': chat_msg.timestamp.isoformat()

            }

        )

    async def chat_message(self, event):

        await self.send(text_data=json.dumps({

            'type': 'chat',

            'message': event['message'],

            'user': event['user'],

            'timestamp': event['timestamp']

        }))

    @database_sync_to_async

    def can_access_session(self):

        try:

            session = Session.objects.get(id=self.session_id)

            user = self.scope["user"]

            if user.is_anonymous:

                return False

            # Student dans la classe ou teacher de la matière

            if user.role == "teacher" and session.teacher == user:

                return True

            if user.role == "student" and user in session.subject.class_assigned.students.all():

                return True

            return False

        except Session.DoesNotExist:

            return False

class NotificationConsumer(AsyncWebsocketConsumer):

    async def connect(self):

        if self.scope["user"].is_anonymous:

            await self.close()

            return

        self.user_id = self.scope["user"].id

        self.room_group_name = f"notifications_{self.user_id}"

        await self.channel_layer.group_add(self.room_group_name, self.channel_name)

        await self.accept()

        # Envoi des notifications non lues au connect

        unread = await self.get_unread_notifications()

        for notif in unread:

            await self.send(text_data=json.dumps({

                'type': 'notification',

                'message': notif['message'],

                'created_at': notif['created_at']

            }))

    async def disconnect(self, close_code):

        await self.channel_layer.group_discard(self.room_group_name, self.channel_name)

    async def receive(self, text_data):

        data = json.loads(text_data)

        if data.get('type') == 'mark_read':

            await self.mark_all_read()

    @database_sync_to_async

    def get_unread_notifications(self):

        return list(

            Notification.objects.filter(user=self.scope["user"], read=False)

            .values('message', 'created_at')

        )

    @database_sync_to_async

    def mark_all_read(self):

        Notification.objects.filter(user=self.scope["user"], read=False).update(read=True)

routing.py

# notifications/routing.py

from django.urls import re_path

from . import consumers

websocket_urlpatterns = [

    re_path(r'ws/chat/(?P<session_id>\d+)/$', consumers.ChatConsumer.as_asgi()),

    re_path(r'ws/notifications/(?P<user_id>\d+)/$', consumers.NotificationConsumer.as_asgi()),

]

serializers.py

from rest_framework import serializers

from .models import Notification, ChatMessage

class NotificationSerializer(serializers.ModelSerializer):

    class Meta:

        model = Notification

        fields = "__all__"

        read_only_fields = ("created_at",)

class ChatSerializer(serializers.ModelSerializer):

    class Meta:

        model = ChatMessage

        fields = "__all__"

        read_only_fields = ("timestamp",)

urls.py

from django.urls import path, include

from rest_framework.routers import DefaultRouter

from .views import NotificationViewSet

router = DefaultRouter()

router.register(r"", NotificationViewSet, basename="notifications")

urlpatterns = [

    path("", include(router.urls)),

]

views.py

# backend/notifications/views.py

from rest_framework import viewsets, status

from rest_framework.decorators import action

from rest_framework.response import Response

from rest_framework.permissions import IsAuthenticated

from django.utils import timezone

from datetime import timedelta

from django.db.models import Q

from django_celery_beat.models import PeriodicTask, CrontabSchedule

import json

from .models import Notification

from .serializers import NotificationSerializer

class NotificationViewSet(viewsets.ModelViewSet):

    serializer_class = NotificationSerializer

    permission_classes = [IsAuthenticated]

    def get_queryset(self):

        return Notification.objects.filter(user=self.request.user).order_by('-created_at')

    @action(detail=False, methods=['get'])

    def unread(self, request):

        notifications = self.get_queryset().filter(read=False)

        serializer = self.get_serializer(notifications, many=True)

        return Response(serializer.data)

    @action(detail=False, methods=['post'])

    def mark_all_read(self, request):

        self.get_queryset().filter(read=False).update(read=True)

        return Response({"detail": "Toutes les notifications marquées comme lues"})

    @action(detail=True, methods=['post'])

    def mark_read(self, request, pk=None):

        notification = self.get_object()

        notification.read = True

        notification.save()

        return Response({"detail": "Notification marquée comme lue"})

    @action(detail=False, methods=['post'])

    def send(self, request):

        """Envoyer une notification à un utilisateur"""

        user_id = request.data.get('user_id')

        message = request.data.get('message')

        notification_type = request.data.get('type', 'info')

        

        if not user_id or not message:

            return Response({"detail": "user_id et message requis"}, status=400)

        

        notification = Notification.objects.create(

            user_id=user_id,

            message=message,

            notification_type=notification_type

        )

        

        return Response({

            "detail": "Notification envoyée",

            "notification": NotificationSerializer(notification).data

        })

    @action(detail=False, methods=['post'])

    def schedule_session(self, request):

        """Programmer une notification pour une session à venir"""

        from schedule.models import TimeSlot

        from accounts.models import CustomUser

        from datetime import datetime

        

        session_id = request.data.get('session_id')

        minutes_before = request.data.get('minutes_before', 5)

        

        try:

            time_slot = TimeSlot.objects.get(id=session_id)

            

            # Calculer le temps de la notification

            notification_time = time_slot.start_time - timedelta(minutes=minutes_before)

            

            # Récupérer tous les étudiants de la classe

            students = time_slot.subject.class_assigned.students.all()

            

            # Récupérer l'enseignant

            teacher = time_slot.teacher

            

            # Créer les notifications

            notifications = []

            

            # Notifications pour les étudiants

            for student in students:

                notifications.append(Notification(

                    user=student,

                    message=f"?? Rappel: {time_slot.subject.name} dans {minutes_before} minutes",

                    notification_type='reminder',

                    scheduled_time=notification_time

                ))

            

            # Notification pour l'enseignant

            notifications.append(Notification(

                user=teacher,

                message=f"????? Rappel: Cours de {time_slot.subject.name} dans {minutes_before} minutes",

                notification_type='reminder',

                scheduled_time=notification_time

            ))

            

            Notification.objects.bulk_create(notifications)

            

            # Programmer la tâche Celery

            self.schedule_celery_task(time_slot, minutes_before)

            

            return Response({

                "detail": f"Notifications programmées pour {len(notifications)} personnes"

            })

            

        except TimeSlot.DoesNotExist:

            return Response({"detail": "Session non trouvée"}, status=404)

    def schedule_celery_task(self, time_slot, minutes_before):

        """Programmer une tâche Celery pour envoyer les notifications"""

        from datetime import datetime

        

        notification_time = time_slot.start_time - timedelta(minutes=minutes_before)

        

        # Créer une schedule crontab

        schedule, _ = CrontabSchedule.objects.get_or_create(

            minute=notification_time.minute,

            hour=notification_time.hour,

            day_of_month=notification_time.day,

            month_of_year=notification_time.month,

            day_of_week='*',

        )

        

        # Créer la tâche périodique

        task_name = f'send_session_reminder_{time_slot.id}'

        

        PeriodicTask.objects.create(

            crontab=schedule,

            name=task_name,

            task='notifications.tasks.send_session_reminders',

            args=json.dumps([time_slot.id, minutes_before]),

            one_off=True,  # Tâche unique

            start_time=notification_time

        )

    @action(detail=False, methods=['get'])

    def pending_sessions(self, request):

        """Récupérer les sessions à venir avec notifications"""

        from schedule.models import TimeSlot

        from datetime import datetime, timedelta

        

        user = request.user

        now = timezone.now()

        next_hour = now + timedelta(hours=1)

        

        if user.role == 'student':

            # Sessions des classes de l'étudiant

            classes = user.enrolled_classes.all()

            sessions = TimeSlot.objects.filter(

                subject__class_assigned__in=classes,

                start_time__gte=now,

                start_time__lte=next_hour

            ).select_related('subject', 'teacher')

            

        elif user.role == 'teacher':

            # Sessions de l'enseignant

            sessions = TimeSlot.objects.filter(

                teacher=user,

                start_time__gte=now,

                start_time__lte=next_hour

            ).select_related('subject')

            

        else:

            sessions = TimeSlot.objects.none()

        

        data = []

        for session in sessions:

            time_diff = session.start_time - now

            minutes_left = int(time_diff.total_seconds() / 60)

            

            data.append({

                'id': session.id,

                'subject': session.subject.name,

                'teacher': session.teacher.get_full_name() if user.role == 'student' else 'Vous',

                'start_time': session.start_time,

                'end_time': session.end_time,

                'classroom': session.classroom,

                'minutes_left': minutes_left,

                'needs_notification': minutes_left <= 10 and minutes_left > 0

            })

        

        return Response(data)

app   backend/schedule

models.py

from django.db import models

from accounts.models import CustomUser

from classes.models import Class, Subject

class WeeklySchedule(models.Model):

    class_assigned = models.OneToOneField(Class, on_delete=models.CASCADE, related_name='weekly_schedule')

    created_at = models.DateTimeField(auto_now_add=True)

    updated_at = models.DateTimeField(auto_now=True)

    

    def __str__(self):

        return f"Emploi du temps - {self.class_assigned.name}"

class TimeSlot(models.Model):

    DAY_CHOICES = [

        ('Monday', 'Lundi'),

        ('Tuesday', 'Mardi'),

        ('Wednesday', 'Mercredi'),

        ('Thursday', 'Jeudi'),

        ('Friday', 'Vendredi'),

    ]

    

    day = models.CharField(max_length=10, choices=DAY_CHOICES)

    start_time = models.TimeField()

    end_time = models.TimeField()

    subject = models.ForeignKey(Subject, on_delete=models.CASCADE, related_name='time_slots')

    teacher = models.ForeignKey(CustomUser, on_delete=models.CASCADE, limit_choices_to={'role': 'teacher'})

    classroom = models.CharField(max_length=50, blank=True, null=True)

    schedule = models.ForeignKey(WeeklySchedule, on_delete=models.CASCADE, related_name='time_slots', null=True)

    

    class Meta:

        ordering = ['day', 'start_time']

    

    def __str__(self):

        return f"{self.get_day_display()} {self.start_time}-{self.end_time} - {self.subject.name}"

serializers.py

from rest_framework import serializers

from .models import WeeklySchedule, TimeSlot

from classes.serializers import SubjectSerializer

from accounts.serializers import UserSerializer

class TimeSlotSerializer(serializers.ModelSerializer):

    subject_details = SubjectSerializer(source='subject', read_only=True)

    teacher_details = UserSerializer(source='teacher', read_only=True)

    day_display = serializers.CharField(source='get_day_display', read_only=True)

    

    class Meta:

        model = TimeSlot

        fields = ['id', 'day', 'day_display', 'start_time', 'end_time', 

                 'subject', 'subject_details', 'teacher', 'teacher_details', 

                 'classroom', 'schedule']

class WeeklyScheduleSerializer(serializers.ModelSerializer):

    time_slots = TimeSlotSerializer(many=True, read_only=True)

    class_name = serializers.CharField(source='class_assigned.name', read_only=True)

    

    class Meta:

        model = WeeklySchedule

        fields = ['id', 'class_assigned', 'class_name', 'time_slots', 'created_at', 'updated_at']

urls.py

from django.urls import path, include

from rest_framework.routers import DefaultRouter

from .views import WeeklyScheduleViewSet, TimeSlotViewSet

router = DefaultRouter()

router.register(r'schedules', WeeklyScheduleViewSet, basename='weeklyschedule')  # AJOUTÉ basename

router.register(r'time-slots', TimeSlotViewSet, basename='timeslot')  # AJOUTÉ basename

urlpatterns = [

    path('', include(router.urls)),

]

views.py

from rest_framework import viewsets, status

from rest_framework.decorators import action

from rest_framework.response import Response

from rest_framework.permissions import IsAuthenticated

from django.shortcuts import get_object_or_404

from .models import WeeklySchedule, TimeSlot

from .serializers import WeeklyScheduleSerializer, TimeSlotSerializer

from accounts.permissions import IsAdmin

class WeeklyScheduleViewSet(viewsets.ModelViewSet):

    queryset = WeeklySchedule.objects.all()  # AJOUTÉ

    serializer_class = WeeklyScheduleSerializer

    permission_classes = [IsAdmin]

    

    @action(detail=False, methods=['get'], url_path='class/(?P<class_id>[^/.]+)')

    def class_schedule(self, request, class_id=None):

        """Récupérer l'emploi du temps d'une classe spécifique"""

        try:

            schedule = WeeklySchedule.objects.get(class_assigned_id=class_id)

            serializer = self.get_serializer(schedule)

            return Response(serializer.data)

        except WeeklySchedule.DoesNotExist:

            return Response({"detail": "Aucun emploi du temps trouvé"}, 

                          status=status.HTTP_404_NOT_FOUND)

class TimeSlotViewSet(viewsets.ModelViewSet):

    queryset = TimeSlot.objects.all()  # AJOUTÉ

    serializer_class = TimeSlotSerializer

    permission_classes = [IsAdmin]

backend/live

models.py

# backend/live/models.py (nouveau fichier)

from django.db import models

from django.utils.crypto import get_random_string

from accounts.models import CustomUser

from classes.models import Subject

class LiveSession(models.Model):

    STATUS_CHOICES = [

        ('scheduled', 'Programmée'),

        ('live', 'En cours'),

        ('ended', 'Terminée'),

        ('cancelled', 'Annulée'),

    ]

    

    subject = models.ForeignKey(Subject, on_delete=models.CASCADE, related_name='live_sessions')

    teacher = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='hosted_sessions')

    title = models.CharField(max_length=200)

    description = models.TextField(blank=True)

    meeting_id = models.CharField(max_length=50, unique=True, editable=False)

    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='scheduled')

    start_time = models.DateTimeField()

    end_time = models.DateTimeField(null=True, blank=True)

    max_participants = models.IntegerField(default=50)

    created_at = models.DateTimeField(auto_now_add=True)

    updated_at = models.DateTimeField(auto_now=True)

    

    class Meta:

        ordering = ['-start_time']

    

    def __str__(self):

        return f"{self.title} - {self.subject.name}"

    

    def save(self, *args, **kwargs):

        if not self.meeting_id:

            self.meeting_id = get_random_string(10)

        super().save(*args, **kwargs)

    

    def is_active(self):

        return self.status == 'live'

class LiveParticipant(models.Model):

    session = models.ForeignKey(LiveSession, on_delete=models.CASCADE, related_name='participants')

    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE)

    joined_at = models.DateTimeField(auto_now_add=True)

    left_at = models.DateTimeField(null=True, blank=True)

    is_presenter = models.BooleanField(default=False)

    audio_enabled = models.BooleanField(default=True)

    video_enabled = models.BooleanField(default=True)

    screen_sharing = models.BooleanField(default=False)

    

    class Meta:

        unique_together = ('session', 'user')

    

    def __str__(self):

        return f"{self.user.username} in {self.session.title}"

class ScreenShare(models.Model):

    session = models.ForeignKey(LiveSession, on_delete=models.CASCADE, related_name='screen_shares')

    user = models.ForeignKey(CustomUser, on_delete=models.CASCADE)

    stream_id = models.CharField(max_length=200)

    started_at = models.DateTimeField(auto_now_add=True)

    ended_at = models.DateTimeField(null=True, blank=True)

    is_active = models.BooleanField(default=True)

    

    class Meta:

        ordering = ['-started_at']

serializers.py

# backend/live/serializers.py

from rest_framework import serializers

from .models import LiveSession, LiveParticipant, ScreenShare

from accounts.serializers import UserSerializer

from classes.serializers import SubjectSerializer

class LiveParticipantSerializer(serializers.ModelSerializer):

    user_details = UserSerializer(source='user', read_only=True)

    

    class Meta:

        model = LiveParticipant

        fields = ['id', 'user', 'user_details', 'joined_at', 'left_at', 

                 'is_presenter', 'audio_enabled', 'video_enabled', 'screen_sharing']

class LiveSessionSerializer(serializers.ModelSerializer):

    subject_details = SubjectSerializer(source='subject', read_only=True)

    teacher_details = UserSerializer(source='teacher', read_only=True)

    participants = LiveParticipantSerializer(many=True, read_only=True)

    participants_count = serializers.SerializerMethodField()

    is_active = serializers.BooleanField(read_only=True)

    

    class Meta:

        model = LiveSession

        fields = ['id', 'title', 'description', 'subject', 'subject_details',

                 'teacher', 'teacher_details', 'meeting_id', 'status', 

                 'start_time', 'end_time', 'max_participants', 'participants',

                 'participants_count', 'is_active', 'created_at', 'updated_at']

        read_only_fields = ['meeting_id', 'created_at', 'updated_at']

    

    def get_participants_count(self, obj):

        return obj.participants.count()

class ScreenShareSerializer(serializers.ModelSerializer):

    user_details = UserSerializer(source='user', read_only=True)

    

    class Meta:

        model = ScreenShare

        fields = ['id', 'session', 'user', 'user_details', 'stream_id',

                 'started_at', 'ended_at', 'is_active']

class CreateLiveSessionSerializer(serializers.ModelSerializer):

    class Meta:

        model = LiveSession

        fields = ['title', 'description', 'subject', 'start_time', 'max_participants']

    

    def validate(self, data):

        # Vérifier que l'enseignant peut créer une session pour cette matière

        user = self.context['request'].user

        if user.role != 'teacher':

            raise serializers.ValidationError("Seuls les enseignants peuvent créer des sessions")

        

        subject = data.get('subject')

        if subject.teacher != user:

            raise serializers.ValidationError("Vous n'enseignez pas cette matière")

        

        return data

class JoinLiveSessionSerializer(serializers.Serializer):

    meeting_id = serializers.CharField(max_length=50, required=True)

    user_id = serializers.IntegerField(required=True)

urls.py

from django.urls import path, include

from rest_framework.routers import DefaultRouter

from .views import LiveSessionViewSet, ScreenShareViewSet, JoinSessionView

router = DefaultRouter()

router.register(r'sessions', LiveSessionViewSet, basename='livesession')  # AJOUTÉ basename

router.register(r'screen-shares', ScreenShareViewSet, basename='screenshare')  # AJOUTÉ basename

urlpatterns = [

    path('', include(router.urls)),

    path('join/', JoinSessionView.as_view(), name='join-session'),

]

views.py

from rest_framework import viewsets, status, generics

from rest_framework.decorators import action

from rest_framework.response import Response

from rest_framework.permissions import IsAuthenticated

from rest_framework.views import APIView

from django.shortcuts import get_object_or_404

from django.utils import timezone

from datetime import timedelta

import uuid

from .models import LiveSession, LiveParticipant, ScreenShare

from .serializers import (LiveSessionSerializer, LiveParticipantSerializer,

                         ScreenShareSerializer, CreateLiveSessionSerializer,

                         JoinLiveSessionSerializer)

from accounts.permissions import IsTeacher, IsStudent, IsAdmin

from notifications.models import Notification

class LiveSessionViewSet(viewsets.ModelViewSet):

    queryset = LiveSession.objects.all()  # AJOUTÉ

    serializer_class = LiveSessionSerializer

    permission_classes = [IsAuthenticated]

    

    def get_queryset(self):

        user = self.request.user

        if user.role == 'admin' or user.role == 'superadmin':

            return LiveSession.objects.all()

        elif user.role == 'teacher':

            return LiveSession.objects.filter(teacher=user)

        elif user.role == 'student':

            # Sessions des matières où l'étudiant est inscrit

            student_classes = user.enrolled_classes.all()

            subject_ids = student_classes.values_list('subjects__id', flat=True)

            return LiveSession.objects.filter(subject_id__in=subject_ids)

        return LiveSession.objects.none()

    

    def get_serializer_class(self):

        if self.action == 'create':

            return CreateLiveSessionSerializer

        return LiveSessionSerializer

    

    def perform_create(self, serializer):

        serializer.save(teacher=self.request.user)

        

        # Notifier les étudiants de la classe

        session = serializer.instance

        subject = session.subject

        students = subject.class_assigned.students.all()

        

        for student in students:

            Notification.objects.create(

                user=student,

                title="Nouvelle session live",

                message=f"L'enseignant {self.request.user.get_full_name()} a programmé une session live pour {subject.name}",

                notification_type='info'

            )

    

    @action(detail=False, methods=['get'])

    def active(self, request):

        """Récupérer les sessions actives"""

        sessions = self.get_queryset().filter(status='live')

        serializer = self.get_serializer(sessions, many=True)

        return Response(serializer.data)

    

    @action(detail=False, methods=['get'])

    def upcoming(self, request):

        """Récupérer les sessions à venir"""

        now = timezone.now()

        next_24h = now + timedelta(hours=24)

        sessions = self.get_queryset().filter(

            status='scheduled',

            start_time__range=[now, next_24h]

        )

        serializer = self.get_serializer(sessions, many=True)

        return Response(serializer.data)

    

    @action(detail=True, methods=['post'])

    def start(self, request, pk=None):

        """Démarrer une session"""

        session = self.get_object()

        

        if session.teacher != request.user:

            return Response({"error": "Seul l'enseignant peut démarrer la session"}, 

                          status=status.HTTP_403_FORBIDDEN)

        

        session.status = 'live'

        session.start_time = timezone.now()

        session.save()

        

        # Notifier les étudiants

        students = session.subject.class_assigned.students.all()

        for student in students:

            Notification.objects.create(

                user=student,

                title="Session live démarrée",

                message=f"La session '{session.title}' a commencé. Rejoignez maintenant!",

                notification_type='info'

            )

        

        return Response({"message": "Session démarrée avec succès"})

    

    @action(detail=True, methods=['post'])

    def end(self, request, pk=None):

        """Terminer une session"""

        session = self.get_object()

        

        if session.teacher != request.user and request.user.role not in ['admin', 'superadmin']:

            return Response({"error": "Non autorisé"}, status=status.HTTP_403_FORBIDDEN)

        

        session.status = 'ended'

        session.end_time = timezone.now()

        session.save()

        

        return Response({"message": "Session terminée avec succès"})

    

    @action(detail=True, methods=['post'])

    def join(self, request, pk=None):

        """Rejoindre une session"""

        session = self.get_object()

        user = request.user

        

        # Vérifier les permissions

        if user.role == 'student':

            if user not in session.subject.class_assigned.students.all():

                return Response({"error": "Vous n'êtes pas inscrit dans cette classe"},

                              status=status.HTTP_403_FORBIDDEN)

        

        # Vérifier si la session est active

        if session.status != 'live':

            return Response({"error": "La session n'est pas active"},

                          status=status.HTTP_400_BAD_REQUEST)

        

        # Vérifier le nombre maximum de participants

        if session.participants.count() >= session.max_participants:

            return Response({"error": "Session pleine"},

                          status=status.HTTP_400_BAD_REQUEST)

        

        # Ajouter le participant

        participant, created = LiveParticipant.objects.get_or_create(

            session=session,

            user=user,

            defaults={'is_presenter': user.role == 'teacher'}

        )

        

        if not created:

            participant.left_at = None

            participant.save()

        

        return Response({

            "message": "Vous avez rejoint la session",

            "meeting_id": session.meeting_id,

            "is_presenter": participant.is_presenter

        })

    

    @action(detail=True, methods=['post'])

    def leave(self, request, pk=None):

        """Quitter une session"""

        session = self.get_object()

        user = request.user

        

        try:

            participant = LiveParticipant.objects.get(session=session, user=user)

            participant.left_at = timezone.now()

            participant.save()

            

            # Si c'est l'enseignant qui quitte, terminer la session

            if user.role == 'teacher':

                session.status = 'ended'

                session.end_time = timezone.now()

                session.save()

            

            return Response({"message": "Vous avez quitté la session"})

        except LiveParticipant.DoesNotExist:

            return Response({"error": "Vous n'êtes pas dans cette session"},

                          status=status.HTTP_400_BAD_REQUEST)

    

    @action(detail=True, methods=['get'])

    def participants(self, request, pk=None):

        """Liste des participants"""

        session = self.get_object()

        participants = session.participants.all()

        serializer = LiveParticipantSerializer(participants, many=True)

        return Response(serializer.data)

    

    @action(detail=True, methods=['post'])

    def toggle_audio(self, request, pk=None):

        """Activer/désactiver l'audio"""

        session = self.get_object()

        user = request.user

        

        try:

            participant = LiveParticipant.objects.get(session=session, user=user)

            participant.audio_enabled = not participant.audio_enabled

            participant.save()

            

            return Response({

                "message": f"Audio {'activé' if participant.audio_enabled else 'désactivé'}",

                "audio_enabled": participant.audio_enabled

            })

        except LiveParticipant.DoesNotExist:

            return Response({"error": "Vous n'êtes pas dans cette session"},

                          status=status.HTTP_400_BAD_REQUEST)

    

    @action(detail=True, methods=['post'])

    def toggle_video(self, request, pk=None):

        """Activer/désactiver la vidéo"""

        session = self.get_object()

        user = request.user

        

        try:

            participant = LiveParticipant.objects.get(session=session, user=user)

            participant.video_enabled = not participant.video_enabled

            participant.save()

            

            return Response({

                "message": f"Vidéo {'activée' if participant.video_enabled else 'désactivée'}",

                "video_enabled": participant.video_enabled

            })

        except LiveParticipant.DoesNotExist:

            return Response({"error": "Vous n'êtes pas dans cette session"},

                          status=status.HTTP_400_BAD_REQUEST)

    

    @action(detail=True, methods=['post'])

    def toggle_screen_share(self, request, pk=None):

        """Activer/désactiver le partage d'écran"""

        session = self.get_object()

        user = request.user

        

        try:

            participant = LiveParticipant.objects.get(session=session, user=user)

            participant.screen_sharing = not participant.screen_sharing

            participant.save()

            

            # Créer ou mettre à jour l'entrée ScreenShare

            if participant.screen_sharing:

                ScreenShare.objects.create(

                    session=session,

                    user=user,

                    stream_id=request.data.get('stream_id', str(uuid.uuid4()))

                )

            else:

                screen_share = ScreenShare.objects.filter(

                    session=session,

                    user=user,

                    is_active=True

                ).first()

                if screen_share:

                    screen_share.is_active = False

                    screen_share.ended_at = timezone.now()

                    screen_share.save()

            

            return Response({

                "message": f"Partage d'écran {'activé' if participant.screen_sharing else 'désactivé'}",

                "screen_sharing": participant.screen_sharing

            })

        except LiveParticipant.DoesNotExist:

            return Response({"error": "Vous n'êtes pas dans cette session"},

                          status=status.HTTP_400_BAD_REQUEST)

class JoinSessionView(APIView):

    permission_classes = [IsAuthenticated]

    

    def post(self, request):

        serializer = JoinLiveSessionSerializer(data=request.data)

        if serializer.is_valid():

            meeting_id = serializer.validated_data['meeting_id']

            

            try:

                session = LiveSession.objects.get(meeting_id=meeting_id, status='live')

                

                # Vérifier les permissions

                user = request.user

                if user.role == 'student':

                    if user not in session.subject.class_assigned.students.all():

                        return Response({"error": "Accès non autorisé"},

                                      status=status.HTTP_403_FORBIDDEN)

                

                # Ajouter le participant

                participant, created = LiveParticipant.objects.get_or_create(

                    session=session,

                    user=user,

                    defaults={'is_presenter': user.role == 'teacher'}

                )

                

                return Response({

                    "success": True,

                    "session": LiveSessionSerializer(session).data,

                    "is_presenter": participant.is_presenter

                })

                

            except LiveSession.DoesNotExist:

                return Response({"error": "Session non trouvée ou inactive"},

                              status=status.HTTP_404_NOT_FOUND)

        

        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class ScreenShareViewSet(viewsets.ModelViewSet):

    queryset = ScreenShare.objects.all()  # AJOUTÉ

    serializer_class = ScreenShareSerializer

    permission_classes = [IsAuthenticated]

    

    def get_queryset(self):

        return ScreenShare.objects.filter(is_active=True)

app    backend/tests

models.py

# backend/tests/models.py (VERSION CORRIGÉE - SANS IMPORTATION CIRCULAIRE)

from django.db import models

from accounts.models import CustomUser

from classes.models import Subject

class Quiz(models.Model):

    TYPE_CHOICES = [

        ('quiz', 'Quiz'),

        ('exam', 'Examen'),

        ('assignment', 'Devoir'),

        ('test', 'Test'),

    ]

    

    title = models.CharField(max_length=200)

    subject = models.ForeignKey(Subject, on_delete=models.CASCADE, related_name='quizzes')

    teacher = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='created_quizzes')

    quiz_type = models.CharField(max_length=20, choices=TYPE_CHOICES, default='quiz')

    description = models.TextField(blank=True)

    instructions = models.TextField(blank=True)

    duration = models.IntegerField(help_text="Durée en minutes")

    total_marks = models.IntegerField()

    passing_marks = models.IntegerField()

    start_time = models.DateTimeField()

    end_time = models.DateTimeField()

    is_active = models.BooleanField(default=True)

    created_at = models.DateTimeField(auto_now_add=True)

    updated_at = models.DateTimeField(auto_now=True)

    

    class Meta:

        ordering = ['-created_at']

        verbose_name_plural = "Quizzes"

    

    def __str__(self):

        return self.title

class Question(models.Model):

    TYPE_CHOICES = [

        ('mcq', 'Choix multiple'),

        ('true_false', 'Vrai/Faux'),

        ('short_answer', 'Réponse courte'),

        ('essay', 'Dissertation'),

        ('fill_blank', 'Remplir les blancs'),

    ]

    

    quiz = models.ForeignKey('Quiz', on_delete=models.CASCADE, related_name='questions')  # Utilisez 'Quiz' comme string

    question_type = models.CharField(max_length=20, choices=TYPE_CHOICES, default='mcq')

    text = models.TextField()

    image = models.ImageField(upload_to='questions/', null=True, blank=True)

    marks = models.IntegerField(default=1)

    order = models.IntegerField(default=0)

    

    class Meta:

        ordering = ['order']

    

    def __str__(self):

        return f"Q{self.order}: {self.text[:50]}"

class Choice(models.Model):

    question = models.ForeignKey('Question', on_delete=models.CASCADE, related_name='choices')  # Utilisez 'Question' comme string

    text = models.TextField()

    is_correct = models.BooleanField(default=False)

    order = models.IntegerField(default=0)

    

    class Meta:

        ordering = ['order']

    

    def __str__(self):

        return f"{self.text[:50]} ({'?' if self.is_correct else '?'})"

class StudentAnswer(models.Model):

    student = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='answers')

    quiz = models.ForeignKey('Quiz', on_delete=models.CASCADE, related_name='student_answers')  # Utilisez 'Quiz' comme string

    question = models.ForeignKey('Question', on_delete=models.CASCADE, related_name='student_answers')  # Utilisez 'Question' comme string

    answer_text = models.TextField(blank=True)

    selected_choices = models.ManyToManyField('Choice', blank=True)  # Utilisez 'Choice' comme string

    submitted_at = models.DateTimeField(auto_now=True)

    is_correct = models.BooleanField(default=False)

    marks_obtained = models.FloatField(default=0)

    

    class Meta:

        unique_together = ('student', 'question')

        ordering = ['submitted_at']

    

    def __str__(self):

        return f"{self.student.username} - Q{self.question.order}"

class QuizResult(models.Model):

    student = models.ForeignKey(CustomUser, on_delete=models.CASCADE, related_name='quiz_results')

    quiz = models.ForeignKey('Quiz', on_delete=models.CASCADE, related_name='results')  # Utilisez 'Quiz' comme string

    score = models.FloatField()

    total_marks = models.IntegerField()

    percentage = models.FloatField()

    started_at = models.DateTimeField()

    submitted_at = models.DateTimeField(auto_now_add=True)

    time_taken = models.IntegerField(help_text="Temps pris en secondes")

    is_passed = models.BooleanField(default=False)

    

    class Meta:

        unique_together = ('student', 'quiz')

        ordering = ['-submitted_at']

    

    def __str__(self):

        return f"{self.student.username} - {self.quiz.title}: {self.score}/{self.total_marks}"

    

    def get_grade(self):

        if self.percentage >= 90:

            return 'A+'

        elif self.percentage >= 80:

            return 'A'

        elif self.percentage >= 70:

            return 'B'

        elif self.percentage >= 60:

            return 'C'

        elif self.percentage >= 50:

            return 'D'

        else:

            return 'F'

serializers.py

# backend/tests/serializers.py

from rest_framework import serializers

from .models import Quiz, Question, Choice, StudentAnswer, QuizResult

class ChoiceSerializer(serializers.ModelSerializer):

    class Meta:

        model = Choice

        fields = ['id', 'text', 'is_correct', 'order']

class QuestionSerializer(serializers.ModelSerializer):

    choices = ChoiceSerializer(many=True, read_only=True)

    

    class Meta:

        model = Question

        fields = ['id', 'quiz', 'question_type', 'text', 'image', 

                 'marks', 'order', 'choices']

class QuizSerializer(serializers.ModelSerializer):

    questions_count = serializers.SerializerMethodField()

    subject_name = serializers.CharField(source='subject.name', read_only=True)

    teacher_name = serializers.CharField(source='teacher.get_full_name', read_only=True)

    is_available = serializers.SerializerMethodField()

    time_remaining = serializers.SerializerMethodField()

    

    class Meta:

        model = Quiz

        fields = ['id', 'title', 'subject', 'subject_name', 'teacher', 'teacher_name',

                 'quiz_type', 'description', 'instructions', 'duration', 'total_marks',

                 'passing_marks', 'start_time', 'end_time', 'is_active', 'questions_count',

                 'is_available', 'time_remaining', 'created_at']

    

    def get_questions_count(self, obj):

        return obj.questions.count()

    

    def get_is_available(self, obj):

        from django.utils import timezone

        now = timezone.now()

        return obj.start_time <= now <= obj.end_time and obj.is_active

    

    def get_time_remaining(self, obj):

        from django.utils import timezone

        now = timezone.now()

        if now < obj.start_time:

            return "Pas encore commencé"

        elif now > obj.end_time:

            return "Terminé"

        else:

            remaining = (obj.end_time - now).total_seconds()

            hours = int(remaining // 3600)

            minutes = int((remaining % 3600) // 60)

            return f"{hours}h {minutes}m"

class StudentAnswerSerializer(serializers.ModelSerializer):

    question_text = serializers.CharField(source='question.text', read_only=True)

    

    class Meta:

        model = StudentAnswer

        fields = ['id', 'student', 'quiz', 'question', 'question_text',

                 'answer_text', 'selected_choices', 'is_correct', 

                 'marks_obtained', 'submitted_at']

class QuizResultSerializer(serializers.ModelSerializer):

    student_name = serializers.CharField(source='student.get_full_name', read_only=True)

    quiz_title = serializers.CharField(source='quiz.title', read_only=True)

    grade = serializers.SerializerMethodField()

    

    class Meta:

        model = QuizResult

        fields = ['id', 'student', 'student_name', 'quiz', 'quiz_title',

                 'score', 'total_marks', 'percentage', 'grade', 'started_at',

                 'submitted_at', 'time_taken', 'is_passed']

    

    def get_grade(self, obj):

        return obj.get_grade()

class TakeQuizSerializer(serializers.Serializer):

    quiz_id = serializers.IntegerField(required=True)

    answers = serializers.ListField(

        child=serializers.DictField(),

        required=True

    )

urls.py

from django.urls import path, include

from rest_framework.routers import DefaultRouter

from .views import QuizViewSet, QuestionViewSet, StudentAnswerViewSet, MyQuizzesView

router = DefaultRouter()

router.register(r'quizzes', QuizViewSet, basename='quiz')  # AJOUTÉ basename

router.register(r'questions', QuestionViewSet, basename='question')  # AJOUTÉ basename

router.register(r'answers', StudentAnswerViewSet, basename='studentanswer')  # AJOUTÉ basename

urlpatterns = [

    path('', include(router.urls)),

    path('my-quizzes/', MyQuizzesView.as_view(), name='my-quizzes'),

]

views.py

from rest_framework import viewsets, status, generics

from rest_framework.decorators import action

from rest_framework.response import Response

from rest_framework.permissions import IsAuthenticated

from django.shortcuts import get_object_or_404

from django.utils import timezone

from django.db.models import Q, Count, Avg, Max, Min

from datetime import timedelta

from .models import Quiz, Question, Choice, StudentAnswer, QuizResult

from .serializers import (QuizSerializer, QuestionSerializer, ChoiceSerializer,

                         StudentAnswerSerializer, QuizResultSerializer,

                         TakeQuizSerializer)

from accounts.permissions import IsTeacher, IsStudent, IsAdmin

from notifications.models import Notification

class QuizViewSet(viewsets.ModelViewSet):

    queryset = Quiz.objects.all()  # AJOUTÉ

    serializer_class = QuizSerializer

    permission_classes = [IsAuthenticated]

    

    def get_queryset(self):

        user = self.request.user

        

        if user.role == 'teacher':

            # Quiz créés par l'enseignant

            return Quiz.objects.filter(teacher=user)

        elif user.role == 'student':

            # Quiz des matières où l'étudiant est inscrit

            student_classes = user.enrolled_classes.all()

            subject_ids = student_classes.values_list('subjects__id', flat=True)

            return Quiz.objects.filter(subject_id__in=subject_ids, is_active=True)

        else:

            return Quiz.objects.all()

    

    def get_serializer_class(self):

        if self.action == 'create':

            return QuizSerializer

        return QuizSerializer

    

    def perform_create(self, serializer):

        serializer.save(teacher=self.request.user)

        

        # Notifier les étudiants

        quiz = serializer.instance

        subject = quiz.subject

        students = subject.class_assigned.students.all()

        

        for student in students:

            Notification.objects.create(

                user=student,

                title="Nouveau quiz disponible",

                message=f"Un nouveau quiz '{quiz.title}' a été publié pour {subject.name}",

                notification_type='info'

            )

    

    @action(detail=True, methods=['get'])

    def questions(self, request, pk=None):

        """Récupérer les questions d'un quiz"""

        quiz = self.get_object()

        

        # Pour les étudiants, ne pas montrer les réponses correctes

        if request.user.role == 'student':

            questions = quiz.questions.all()

            serializer = QuestionSerializer(questions, many=True, context={'hide_correct': True})

        else:

            questions = quiz.questions.all()

            serializer = QuestionSerializer(questions, many=True)

        

        return Response(serializer.data)

    

    @action(detail=True, methods=['post'])

    def start(self, request, pk=None):

        """Commencer un quiz"""

        quiz = self.get_object()

        user = request.user

        

        if user.role != 'student':

            return Response({"error": "Seuls les étudiants peuvent passer des quiz"},

                          status=status.HTTP_403_FORBIDDEN)

        

        # Vérifier si l'étudiant est inscrit dans la matière

        if user not in quiz.subject.class_assigned.students.all():

            return Response({"error": "Vous n'êtes pas inscrit dans cette matière"},

                          status=status.HTTP_403_FORBIDDEN)

        

        # Vérifier si le quiz est disponible

        now = timezone.now()

        if now < quiz.start_time:

            return Response({"error": "Le quiz n'a pas encore commencé"},

                          status=status.HTTP_400_BAD_REQUEST)

        if now > quiz.end_time:

            return Response({"error": "Le quiz est terminé"},

                          status=status.HTTP_400_BAD_REQUEST)

        

        # Vérifier si l'étudiant a déjà commencé le quiz

        existing_result = QuizResult.objects.filter(quiz=quiz, student=user).first()

        if existing_result:

            # Calculer le temps restant

            time_elapsed = (now - existing_result.started_at).total_seconds()

            time_remaining = quiz.duration * 60 - time_elapsed

            

            if time_remaining <= 0:

                return Response({"error": "Temps écoulé"},

                              status=status.HTTP_400_BAD_REQUEST)

            

            return Response({

                "message": "Vous avez déjà commencé ce quiz",

                "time_remaining": time_remaining,

                "result_id": existing_result.id

            })

        

        # Créer un nouveau résultat

        result = QuizResult.objects.create(

            student=user,

            quiz=quiz,

            score=0,

            total_marks=quiz.total_marks,

            percentage=0,

            started_at=now,

            time_taken=0,

            is_passed=False

        )

        

        return Response({

            "message": "Quiz démarré",

            "quiz": QuizSerializer(quiz).data,

            "result_id": result.id,

            "time_remaining": quiz.duration * 60

        })

    

    @action(detail=True, methods=['post'])

    def submit(self, request, pk=None):

        """Soumettre les réponses d'un quiz"""

        quiz = self.get_object()

        user = request.user

        

        if user.role != 'student':

            return Response({"error": "Seuls les étudiants peuvent soumettre des quiz"},

                          status=status.HTTP_403_FORBIDDEN)

        

        serializer = TakeQuizSerializer(data=request.data)

        if not serializer.is_valid():

            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

        

        # Récupérer le résultat en cours

        result = QuizResult.objects.filter(quiz=quiz, student=user).first()

        if not result:

            return Response({"error": "Vous n'avez pas commencé ce quiz"},

                          status=status.HTTP_400_BAD_REQUEST)

        

        # Calculer le score

        total_score = 0

        answers_data = serializer.validated_data['answers']

        

        for answer_data in answers_data:

            question_id = answer_data.get('question_id')

            selected_choice_ids = answer_data.get('selected_choice_ids', [])

            answer_text = answer_data.get('answer_text', '')

            

            try:

                question = Question.objects.get(id=question_id, quiz=quiz)

                

                # Créer l'entrée de réponse

                student_answer = StudentAnswer.objects.create(

                    student=user,

                    quiz=quiz,

                    question=question,

                    answer_text=answer_text

                )

                

                # Ajouter les choix sélectionnés

                if selected_choice_ids:

                    choices = Choice.objects.filter(id__in=selected_choice_ids, question=question)

                    student_answer.selected_choices.set(choices)

                

                # Vérifier si la réponse est correcte

                if question.question_type == 'mcq':

                    correct_choices = question.choices.filter(is_correct=True)

                    selected_correct = student_answer.selected_choices.filter(is_correct=True).count()

                    

                    if correct_choices.count() > 0 and selected_correct == correct_choices.count():

                        student_answer.is_correct = True

                        student_answer.marks_obtained = question.marks

                        total_score += question.marks

                elif question.question_type == 'true_false':

                    # Pour vrai/faux, on aurait besoin d'une logique spécifique

                    pass

                

                student_answer.save()

                

            except Question.DoesNotExist:

                continue

        

        # Mettre à jour le résultat

        result.score = total_score

        result.percentage = (total_score / quiz.total_marks) * 100

        result.is_passed = result.percentage >= quiz.passing_marks

        result.submitted_at = timezone.now()

        result.time_taken = int((result.submitted_at - result.started_at).total_seconds())

        result.save()

        

        return Response({

            "message": "Quiz soumis avec succès",

            "score": total_score,

            "total_marks": quiz.total_marks,

            "percentage": result.percentage,

            "is_passed": result.is_passed,

            "time_taken": result.time_taken

        })

    

    @action(detail=True, methods=['get'])

    def results(self, request, pk=None):

        """Résultats d'un quiz"""

        quiz = self.get_object()

        user = request.user

        

        if user.role == 'student':

            # L'étudiant ne voit que son résultat

            results = QuizResult.objects.filter(quiz=quiz, student=user)

        else:

            # L'enseignant voit tous les résultats

            results = QuizResult.objects.filter(quiz=quiz)

        

        serializer = QuizResultSerializer(results, many=True)

        

        # Statistiques pour l'enseignant

        if user.role == 'teacher':

            stats = {

                'total_students': quiz.subject.class_assigned.students.count(),

                'submitted_count': results.count(),

                'average_score': results.aggregate(Avg('score'))['score__avg'] or 0,

                'highest_score': results.aggregate(Max('score'))['score__max'] or 0,

                'lowest_score': results.aggregate(Min('score'))['score__min'] or 0,

                'pass_rate': (results.filter(is_passed=True).count() / results.count() * 100) if results.count() > 0 else 0

            }

            return Response({

                'results': serializer.data,

                'stats': stats

            })

        

        return Response(serializer.data)

    

    @action(detail=True, methods=['get'])

    def ranking(self, request, pk=None):

        """Classement des étudiants pour un quiz"""

        quiz = self.get_object()

        

        results = QuizResult.objects.filter(quiz=quiz).order_by('-score', 'time_taken')

        serializer = QuizResultSerializer(results, many=True)

        

        # Ajouter le rang

        ranked_data = []

        for rank, result in enumerate(results, 1):

            data = serializer.data[rank-1]

            data['rank'] = rank

            ranked_data.append(data)

        

        return Response(ranked_data)

class QuestionViewSet(viewsets.ModelViewSet):

    queryset = Question.objects.all()  # AJOUTÉ

    serializer_class = QuestionSerializer

    permission_classes = [IsTeacher | IsAdmin]

    

    def perform_create(self, serializer):

        serializer.save()

class StudentAnswerViewSet(viewsets.ReadOnlyModelViewSet):

    queryset = StudentAnswer.objects.all()  # AJOUTÉ

    serializer_class = StudentAnswerSerializer

    permission_classes = [IsTeacher | IsAdmin]

class MyQuizzesView(generics.ListAPIView):

    serializer_class = QuizSerializer

    permission_classes = [IsAuthenticated]

    

    def get_queryset(self):

        user = self.request.user

        

        if user.role == 'student':

            # Quiz disponibles pour l'étudiant

            student_classes = user.enrolled_classes.all()

            subject_ids = student_classes.values_list('subjects__id', flat=True)

            

            now = timezone.now()

            return Quiz.objects.filter(

                subject_id__in=subject_ids,

                is_active=True,

                end_time__gte=now

            ).order_by('start_time')

        

        return Quiz.objects.none()

nouveau   backend/backend/settings.py

# backend/backend/settings.py ? VERSION CORRIGÉE

import os

from pathlib import Path

from datetime import timedelta

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'django-insecure-change-me-in-production-123456789'

DEBUG = True

ALLOWED_HOSTS = ['*']

INSTALLED_APPS = [

    'django.contrib.admin',

    'django.contrib.auth',

    'django.contrib.contenttypes',

    'django.contrib.sessions',

    'django.contrib.messages',

    'django.contrib.staticfiles',

    # Apps tierces

    'rest_framework',

    'rest_framework_simplejwt',

    'corsheaders',

    'channels',

    'django_celery_beat',

    # Tes apps

    'accounts',

    'classes',

    'courses',

    'lms_sessions',

    'notifications',

    'live',

    'tests',

    'schedule',

]

MIDDLEWARE = [

    'corsheaders.middleware.CorsMiddleware',

    'django.middleware.security.SecurityMiddleware',

    'django.contrib.sessions.middleware.SessionMiddleware',

    'django.middleware.common.CommonMiddleware',

    'django.middleware.csrf.CsrfViewMiddleware',

    'django.contrib.auth.middleware.AuthenticationMiddleware',

    'django.contrib.messages.middleware.MessageMiddleware',

    'django.middleware.clickjacking.XFrameOptionsMiddleware',

]

ROOT_URLCONF = 'backend.urls'

TEMPLATES = [

    {

        'BACKEND': 'django.template.backends.django.DjangoTemplates',

        'DIRS': [BASE_DIR / 'templates'],

        'APP_DIRS': True,

        'OPTIONS': {

            'context_processors': [

                'django.template.context_processors.debug',

                'django.template.context_processors.request',

                'django.contrib.auth.context_processors.auth',

                'django.contrib.messages.context_processors.messages',

            ],

        },

    },

]

WSGI_APPLICATION = 'backend.wsgi.application'

ASGI_APPLICATION = 'backend.asgi.application'

DATABASES = {

    'default': {

        'ENGINE': 'django.db.backends.sqlite3',

        'NAME': BASE_DIR / 'db.sqlite3',

    }

}

AUTH_USER_MODEL = 'accounts.CustomUser'

REST_FRAMEWORK = {

    'DEFAULT_AUTHENTICATION_CLASSES': (

        'rest_framework_simplejwt.authentication.JWTAuthentication',

    ),

    'DEFAULT_PERMISSION_CLASSES': [

        'rest_framework.permissions.IsAuthenticated',

    ],

}

SIMPLE_JWT = {

    'ACCESS_TOKEN_LIFETIME': timedelta(days=7),

    'REFRESH_TOKEN_LIFETIME': timedelta(days=30),

}

CORS_ALLOW_ALL_ORIGINS = True

CORS_ALLOW_CREDENTIALS = True

# Channel Layers - Version simplifiée pour développement

CHANNEL_LAYERS = {

    "default": {

        "BACKEND": "channels.layers.InMemoryChannelLayer",

    },

}

# Static & Media

STATIC_URL = '/static/'

STATICFILES_DIRS = [BASE_DIR / "static"]

STATIC_ROOT = BASE_DIR / "staticfiles"

MEDIA_URL = '/media/'

MEDIA_ROOT = BASE_DIR / "media"

LANGUAGE_CODE = 'fr-fr'

TIME_ZONE = 'Africa/Casablanca'

USE_I18N = True

USE_TZ = True

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

LOGGING = {

    'version': 1,

    'disable_existing_loggers': False,

    'handlers': {

        'console': {

            'class': 'logging.StreamHandler',

        },

    },

    'root': {

        'handlers': ['console'],

        'level': 'DEBUG',

    },

}

nouveau   backend/backend/urls.py# backend/urls.py (version finale)

from django.contrib import admin

from django.urls import path, include

from django.conf import settings

from django.conf.urls.static import static

urlpatterns = [

    path("admin/", admin.site.urls),

    

    # API ROUTES

    path("api/accounts/", include("accounts.urls")),

    path("api/classes/", include("classes.urls")),

    path("api/courses/", include("courses.urls")),

    path("api/lms/", include("lms_sessions.urls")),

    path("api/notifications/", include("notifications.urls")),

    path("api/schedule/", include("schedule.urls")),

    path("api/live/", include("live.urls")),

    path("api/tests/", include("tests.urls")),

    

    # RACCOURCI

    path("api/specialties/", include("classes.urls")),

]

if settings.DEBUG:

    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

   je donne les pages necciser pour compronde le concept de classification lorsque cree un classe   voila page  ManageClasses.jsx    

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import api from "../../services/api";
import { toast } from "react-toastify";

export default function ManageClasses() {
  const navigate = useNavigate();
  const [classes, setClasses] = useState([]);
  const [availableStudents, setAvailableStudents] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [specialties, setSpecialties] = useState([]);
  const [loading, setLoading] = useState(false);

  const [step, setStep] = useState(0);
  const [tempClassName, setTempClassName] = useState("");
  const [selectedStudentId, setSelectedStudentId] = useState("");
  const [selectedSpecialtyId, setSelectedSpecialtyId] = useState("");
  const [selectedTeacherId, setSelectedTeacherId] = useState("");

  useEffect(() => {
    loadAllData();
  }, []);

  const loadAllData = async () => {
    setLoading(true);
    try {
      const [classesRes, usersRes, teachersRes, specsRes] = await Promise.all([
        api.get("classes/classes/"),
        api.get("accounts/users/"),
        api.get("accounts/users/?role=teacher"),
        api.get("classes/specialties/")
      ]);

      setClasses(classesRes.data || []);
      setTeachers(teachersRes.data || []);

      const enrolledIds = new Set();
      (classesRes.data || []).forEach(cls => {
        cls.students?.forEach(s => enrolledIds.add(s.id));
      });

      const freeStudents = (usersRes.data || [])
        .filter(u => u.role === "student")
        .filter(u => !enrolledIds.has(u.id));

      setAvailableStudents(freeStudents);

      const specsWithTeachers = (specsRes.data || []).filter(spec =>
        teachersRes.data.some(t => t.specialty === spec.name)
      );
      setSpecialties(specsWithTeachers);

    } catch (err) {
      toast.error("Erreur lors du chargement des données");
    } finally {
      setLoading(false);
    }
  };

  // NOUVELLE FONCTION : Création COMPLÈTE de la classe
  const createCompleteClass = async () => {
    if (!tempClassName.trim()) {
      toast.error("Nom de classe requis");
      return;
    }

    if (!selectedStudentId) {
      toast.error("Choisissez un étudiant");
      return;
    }

    if (!selectedSpecialtyId || !selectedTeacherId) {
      toast.error("Choisissez spécialité et professeur");
      return;
    }

    try {
      // ÉTAPE 1 : Créer la classe
      const classResponse = await api.post("classes/classes/", {
        name: tempClassName.trim()
      });

      const classId = classResponse.data.id;
      toast.success(`Classe "${tempClassName}" créée !`);

      // ÉTAPE 2 : Ajouter l'étudiant
      await api.post(`classes/classes/${classId}/add-student/`, {
        user_id: Number(selectedStudentId)
      });
      toast.success("Étudiant ajouté et validé !");

      // ÉTAPE 3 : Ajouter la matière
      const specialty = specialties.find(s => s.id == selectedSpecialtyId);
      await api.post("classes/subjects/", {
        name: specialty.name,
        class_assigned: classId,
        specialty: selectedSpecialtyId,
        teacher: selectedTeacherId
      });
      toast.success("Matière ajoutée !");

      // ÉTAPE 4 : Tout est terminé !
      toast.success("Classe créée avec succès !", { autoClose: 3000 });

      // Réinitialiser tout
      setStep(0);
      setTempClassName("");
      setSelectedStudentId("");
      setSelectedSpecialtyId("");
      setSelectedTeacherId("");

      // Recharger les données
      loadAllData();

    } catch (err) {
      console.error("ERREUR COMPLÈTE :", err.response?.data || err);
      
      // En cas d'erreur, essayer de supprimer la classe si elle a été créée
      if (err.response?.status === 400 && err.response.data?.id) {
        try {
          await api.delete(`classes/classes/${err.response.data.id}/`);
          toast.info("Classe partiellement créée a été supprimée");
        } catch (deleteErr) {
          // Ignorer l'erreur de suppression
        }
      }

      toast.error(
        err.response?.data?.name?.[0] ||
        err.response?.data?.detail ||
        "Erreur lors de la création de la classe"
      );
    }
  };

  const deleteClass = async (cls) => {
    if (!window.confirm(
      `Supprimer définitivement la classe "${cls.name}" ?\n\n` +
      `?? CONSÉQUENCES:\n` +
      `• Tous les étudiants seront remis en attente\n` +
      `• Les enseignants seront remis en attente s'ils n'enseignent plus ailleurs\n` +
      `• Toutes les matières seront supprimées`
    )) return;

    try {
      await api.delete(`classes/classes/${cls.id}/`);
      toast.success("Classe supprimée - Comptes mis à jour automatiquement");
      loadAllData();
    } catch (err) {
      console.error("Erreur détaillée:", err.response?.data || err);
      toast.error(err.response?.data?.detail || "Impossible de supprimer la classe");
    }
  };

  // Fonction pour annuler la création
  const cancelCreation = () => {
    setStep(0);
    setTempClassName("");
    setSelectedStudentId("");
    setSelectedSpecialtyId("");
    setSelectedTeacherId("");
    toast.info("Création annulée");
  };

  if (loading) {
    return (
      <div style={{
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        height: '80vh'
      }}>
        <div style={{
          fontSize: '1.5rem',
          color: '#c62828',
          textAlign: 'center'
        }}>
          Chargement des classes...
        </div>
      </div>
    );
  }

  return (
    <div className="admin-container">
      <div className="page-header">
        <h1 className="page-title" style={{ color: "#c62828" }}>
          Gestion des Classes
        </h1>

        <button
          onClick={() => setStep(1)}
          className="btn-primary"
          style={{
            padding: "16px 32px",
            fontSize: "1.1rem",
            fontWeight: "700",
            backgroundColor: availableStudents.length > 0 ? "#c62828" : "#cccccc",
            color: "white",
            border: "none",
            borderRadius: "12px",
            cursor: availableStudents.length > 0 ? "pointer" : "not-allowed",
            opacity: availableStudents.length > 0 ? 1 : 0.6,
            transition: "all 0.3s ease"
          }}
          disabled={availableStudents.length === 0}
          title={availableStudents.length === 0 ? "Aucun étudiant disponible" : ""}
        >
          + Créer une Classe
          {availableStudents.length > 0 && ` (${availableStudents.length} étudiants disponibles)`}
        </button>
      </div>

      {/* MODAL DE CRÉATION - ÉTAPE 1 : Nom et étudiant */}
      {step === 1 && (
        <div className="modal-overlay" style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000
        }}>
          <div className="modal-content" style={{
            background: 'white',
            padding: '40px',
            borderRadius: '20px',
            width: '90%',
            maxWidth: '600px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h2 style={{ color: "#c62828", margin: 0 }}>
                Étape 1/2 : Informations de base
              </h2>
              <div style={{
                backgroundColor: '#ffebee',
                color: '#c62828',
                padding: '8px 16px',
                borderRadius: '20px',
                fontWeight: 'bold'
              }}>
                Étape 1
              </div>
            </div>

            <div style={{ marginBottom: '30px' }}>
              <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555' }}>
                Nom de la classe *
              </label>
              <input
                placeholder="Ex: ING1 Cybersécurité 2025"
                value={tempClassName}
                onChange={(e) => setTempClassName(e.target.value)}
                style={{
                  width: "100%",
                  padding: "16px",
                  marginBottom: "20px",
                  borderRadius: "12px",
                  border: "2px solid #ddd",
                  fontSize: '1.1rem'
                }}
              />

              <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555' }}>
                Premier étudiant *
              </label>
              <select
                value={selectedStudentId}
                onChange={(e) => setSelectedStudentId(e.target.value)}
                style={{
                  width: "100%",
                  padding: "16px",
                  borderRadius: "12px",
                  border: "2px solid #c62828",
                  fontSize: '1.1rem',
                  backgroundColor: 'white'
                }}
              >
                <option value="">— Choisir un étudiant libre —</option>
                {availableStudents.map(s => (
                  <option key={s.id} value={s.id}>
                    {s.username} ? {s.first_name} {s.last_name} {!s.approved && " (en attente)"}
                  </option>
                ))}
              </select>
            </div>

            <div style={{ marginTop: "25px", display: "flex", gap: "12px", justifyContent: 'flex-end' }}>
              <button
                onClick={cancelCreation}
                style={{
                  padding: "12px 24px",
                  fontSize: "1rem",
                  fontWeight: "600",
                  backgroundColor: "#666",
                  color: "white",
                  border: "none",
                  borderRadius: "8px",
                  cursor: "pointer",
                  transition: "all 0.3s ease"
                }}
              >
                Annuler
              </button>

              <button
                onClick={() => {
                  if (!tempClassName.trim()) {
                    toast.error("Nom de classe requis");
                    return;
                  }
                  if (!selectedStudentId) {
                    toast.error("Choisissez un étudiant");
                    return;
                  }
                  setStep(2);
                }}
                style={{
                  padding: "12px 24px",
                  fontSize: "1rem",
                  fontWeight: "600",
                  backgroundColor: "#c62828",
                  color: "white",
                  border: "none",
                  borderRadius: "8px",
                  cursor: "pointer",
                  transition: "all 0.3s ease",
                  opacity: (tempClassName.trim() && selectedStudentId) ? 1 : 0.6
                }}
                disabled={!tempClassName.trim() || !selectedStudentId}
              >
                Suivant ? Matière
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL DE CRÉATION - ÉTAPE 2 : Matière */}
      {step === 2 && (
        <div className="modal-overlay" style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000
        }}>
          <div className="modal-content" style={{
            background: 'white',
            padding: '40px',
            borderRadius: '20px',
            width: '90%',
            maxWidth: '600px',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h2 style={{ color: "#c62828", margin: 0 }}>
                Étape 2/2 : Première matière
              </h2>
              <div style={{
                backgroundColor: '#ffebee',
                color: '#c62828',
                padding: '8px 16px',
                borderRadius: '20px',
                fontWeight: 'bold'
              }}>
                Étape 2
              </div>
            </div>

            <div style={{ marginBottom: '20px', padding: '15px', backgroundColor: '#f9f9f9', borderRadius: '12px' }}>
              <p style={{ margin: 0, color: '#555' }}>
                <strong>Récapitulatif :</strong>
              </p>
              <p style={{ margin: '5px 0', color: '#555' }}>
                Classe : <strong>{tempClassName}</strong>
              </p>
              <p style={{ margin: '5px 0', color: '#555' }}>
                Étudiant : <strong>
                  {availableStudents.find(s => s.id == selectedStudentId)?.username || "Non sélectionné"}
                </strong>
              </p>
            </div>

            <div style={{ marginBottom: '30px' }}>
              <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555' }}>
                Spécialité de la matière *
              </label>
              <select
                value={selectedSpecialtyId}
                onChange={(e) => {
                  setSelectedSpecialtyId(e.target.value);
                  setSelectedTeacherId("");
                }}
                style={{
                  width: "100%",
                  padding: "16px",
                  marginBottom: "20px",
                  borderRadius: "12px",
                  border: "2px solid #c62828",
                  fontSize: '1.1rem'
                }}
              >
                <option value="">— Choisir spécialité —</option>
                {specialties.map(s => (
                  <option key={s.id} value={s.id}>{s.name}</option>
                ))}
              </select>

              {selectedSpecialtyId && (
                <>
                  <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#555' }}>
                    Professeur assigné *
                  </label>
                  <select
                    value={selectedTeacherId}
                    onChange={(e) => setSelectedTeacherId(e.target.value)}
                    style={{
                      width: "100%",
                      padding: "16px",
                      borderRadius: "12px",
                      border: "2px solid #c62828",
                      fontSize: '1.1rem'
                    }}
                  >
                    <option value="">— Choisir professeur —</option>
                    {teachers
                      .filter(t => t.specialty === specialties.find(s => s.id == selectedSpecialtyId)?.name)
                      .map(t => (
                        <option key={t.id} value={t.id}>
                          {t.username} - {t.first_name} {t.last_name} {t.approved ? "?" : " (en attente)"}
                        </option>
                      ))}
                  </select>
                </>
              )}
            </div>

            <div style={{ marginTop: "25px", display: "flex", gap: "12px", justifyContent: 'flex-end' }}>
              <button
                onClick={() => setStep(1)}
                style={{
                  padding: "12px 24px",
                  fontSize: "1rem",
                  fontWeight: "600",
                  backgroundColor: "#666",
                  color: "white",
                  border: "none",
                  borderRadius: "8px",
                  cursor: "pointer",
                  transition: "all 0.3s ease"
                }}
              >
                ? Retour
              </button>

              <button
                onClick={cancelCreation}
                style={{
                  padding: "12px 24px",
                  fontSize: "1rem",
                  fontWeight: "600",
                  backgroundColor: "#ff4444",
                  color: "white",
                  border: "none",
                  borderRadius: "8px",
                  cursor: "pointer",
                  transition: "all 0.3s ease"
                }}
              >
                Annuler tout
              </button>

              <button
                onClick={createCompleteClass}
                style={{
                  padding: "12px 24px",
                  fontSize: "1rem",
                  fontWeight: "600",
                  backgroundColor: "#c62828",
                  color: "white",
                  border: "none",
                  borderRadius: "8px",
                  cursor: "pointer",
                  transition: "all 0.3s ease",
                  opacity: (selectedSpecialtyId && selectedTeacherId) ? 1 : 0.6
                }}
                disabled={!selectedSpecialtyId || !selectedTeacherId}
              >
                Créer la classe complète
              </button>
            </div>
          </div>
        </div>
      )}

      {/* LISTE DES CLASSES */}
      <div style={{ marginTop: "3rem" }}>
        {classes.length === 0 ? (
          <div style={{
            textAlign: "center",
            padding: "80px 20px",
            color: "#999",
            fontSize: "1.3rem",
            backgroundColor: '#f9f9f9',
            borderRadius: '12px'
          }}>
            Aucune classe créée pour le moment
            {availableStudents.length > 0 && (
              <div style={{ marginTop: '20px' }}>
                <button
                  onClick={() => setStep(1)}
                  style={{
                    padding: '12px 24px',
                    backgroundColor: '#c62828',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '1rem'
                  }}
                >
                  Créer votre première classe
                </button>
              </div>
            )}
          </div>
        ) : (
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))',
            gap: "20px"
          }}>
            {classes.map(cls => (
              <div
                key={cls.id}
                onClick={() => navigate(`/admin/class/${cls.id}`)}
                style={{
                  cursor: "pointer",
                  padding: "24px",
                  borderRadius: "16px",
                  background: "white",
                  boxShadow: "0 8px 25px rgba(0,0,0,0.1)",
                  transition: "all 0.3s ease",
                  border: '2px solid transparent',
                  position: 'relative'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.transform = "translateY(-5px)";
                  e.currentTarget.style.borderColor = '#c62828';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.transform = "none";
                  e.currentTarget.style.borderColor = 'transparent';
                }}
              >
                <h3 style={{ color: "#c62828", margin: "0 0 12px 0", fontSize: "1.4rem" }}>
                  {cls.name}
                </h3>
                <p style={{ margin: "8px 0", fontWeight: "600", color: '#555' }}>
                  ????? {cls.students?.length || 0}/30 étudiants
                </p>
                <p style={{ margin: "8px 0", fontWeight: "600", color: '#555' }}>
                  ?? {cls.subjects?.length || 0} matière(s)
                </p>
                <p style={{ margin: "8px 0", fontSize: '0.9rem', color: '#777' }}>
                  Cliquez pour gérer les détails
                </p>

                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    deleteClass(cls);
                  }}
                  style={{
                    marginTop: "16px",
                    width: "100%",
                    padding: "12px",
                    fontSize: "1rem",
                    fontWeight: "600",
                    borderRadius: "8px",
                    border: "2px solid #c62828",
                    color: "#c62828",
                    backgroundColor: "transparent",
                    cursor: "pointer",
                    transition: "all 0.3s ease"
                  }}
                  onMouseEnter={(e) => {
                    e.target.style.backgroundColor = "#c62828";
                    e.target.style.color = "white";
                  }}
                  onMouseLeave={(e) => {
                    e.target.style.backgroundColor = "transparent";
                    e.target.style.color = "#c62828";
                  }}
                >
                  Supprimer la classe
                </button>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

ClassDetails.jsx   

import React, { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import api from "../../services/api";
import { toast } from "react-toastify";

export default function ClassDetails() {
  const { id } = useParams();
  const navigate = useNavigate();

  const [cls, setCls] = useState(null);
  const [pendingStudents, setPendingStudents] = useState([]);
  const [allSpecialties, setAllSpecialties] = useState([]);
  const [availableSpecialties, setAvailableSpecialties] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [loading, setLoading] = useState(false);

  const [selectedSpecialtyId, setSelectedSpecialtyId] = useState("");
  const [selectedTeacherId, setSelectedTeacherId] = useState("");
  const [showDeleteModal, setShowDeleteModal] = useState(false);

  useEffect(() => {
    loadAllData();
  }, [id]);

  const loadAllData = async () => {
    setLoading(true);
    try {
      const [classRes, pendingRes, teachersRes, specsRes] = await Promise.all([
        api.get(`classes/classes/${id}/`),
        api.get("accounts/pending/"),
        api.get("accounts/users/?role=teacher"),
        api.get("classes/specialties/")
      ]);

      const currentClass = classRes.data;
      setCls(currentClass);
      setTeachers(teachersRes.data || []);
      setAllSpecialties(specsRes.data || []);

      // Filtrer les étudiants en attente réels
      const realPendingStudents = (pendingRes.data || [])
        .filter(u => u.role === "student" && u.approved === false);
      setPendingStudents(realPendingStudents);

      // Trouver les spécialités disponibles (non utilisées dans cette classe)
      const usedSpecialtyIds = new Set(
        currentClass.subjects?.map(sub => sub.specialty) || []
      );

      const available = specsRes.data.filter(spec =>
        !usedSpecialtyIds.has(spec.id) &&
        teachersRes.data.some(t => t.specialty === spec.name)
      );

      setAvailableSpecialties(available);

    } catch (err) {
      console.error("Erreur:", err);
      toast.error("Erreur lors du chargement des données");
      navigate("/admin/classes");
    } finally {
      setLoading(false);
    }
  };

  const addStudent = async (studentId) => {
    if (!studentId) return;
    try {
      await api.post(`classes/classes/${id}/add-student/`, { user_id: studentId });
      toast.success("Étudiant ajouté et validé !");
      loadAllData();
    } catch (err) {
      toast.error(err.response?.data?.detail || "Erreur lors de l'ajout de l'étudiant");
    }
  };

  const removeStudent = async (studentId) => {
    if (!window.confirm("Retirer cet étudiant de la classe ? Il sera remis en attente.")) return;
    try {
      await api.post(`classes/classes/${id}/remove-student/`, { user_id: studentId });
      toast.success("Étudiant retiré et mis en attente");
      loadAllData();
    } catch (err) {
      toast.error(err.response?.data?.detail || "Erreur lors du retrait");
    }
  };

  const addSubject = async () => {
    if (!selectedSpecialtyId || !selectedTeacherId) {
      return toast.error("Choisissez spécialité et professeur");
    }

    const specialty = allSpecialties.find(s => s.id == selectedSpecialtyId);
    if (!specialty) {
      return toast.error("Spécialité introuvable");
    }

    try {
      // Créer la matière
      await api.post("classes/subjects/", {
        name: specialty.name,
        class_assigned: id,
        specialty: selectedSpecialtyId,
        teacher: selectedTeacherId
      });

      // Valider automatiquement l'enseignant (géré par le backend)
      const teacher = teachers.find(t => t.id == selectedTeacherId);
      if (teacher && !teacher.approved) {
        toast.info(`Enseignant ${teacher.username} validé automatiquement`);
      }

      toast.success(`Matière "${specialty.name}" ajoutée avec succès !`);
      
      // Réinitialiser
      setSelectedSpecialtyId("");
      setSelectedTeacherId("");
      
      // Recharger
      loadAllData();

    } catch (err) {
      console.error("Erreur:", err.response?.data || err);
      toast.error(err.response?.data?.detail || "Erreur lors de l'ajout de la matière");
    }
  };

  const deleteSubject = async (subjectId, subjectName) => {
    if (!window.confirm(`Supprimer la matière "${subjectName}" ?\nL'enseignant sera remis en attente s'il n'enseigne plus ailleurs.`)) return;
    try {
      await api.delete(`classes/subjects/${subjectId}/`);
      toast.success("Matière supprimée");
      loadAllData();
    } catch (err) {
      toast.error(err.response?.data?.detail || "Erreur lors de la suppression");
    }
  };

  const deleteClass = async () => {
    if (!window.confirm(
      `Supprimer définitivement la classe "${cls?.name}" ?\n\n` +
      `?? CONSÉQUENCES:\n` +
      `• Tous les étudiants seront remis en attente\n` +
      `• Les enseignants seront remis en attente s'ils n'enseignent plus ailleurs\n` +
      `• Toutes les matières seront supprimées`
    )) return;
    
    try {
      await api.delete(`classes/classes/${id}/`);
      toast.success("Classe supprimée - Comptes mis à jour automatiquement");
      navigate("/admin/classes");
    } catch (err) {
      toast.error(err.response?.data?.detail || "Erreur lors de la suppression");
    }
  };

  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '80vh' 
      }}>
        <div style={{ 
          fontSize: '1.5rem', 
          color: '#c62828',
          textAlign: 'center'
        }}>
          Chargement des détails de la classe...
        </div>
      </div>
    );
  }

  if (!cls) {
    return (
      <div style={{ padding: "100px", textAlign: "center", fontSize: "1.5rem" }}>
        Classe introuvable
      </div>
    );
  }

  return (
    <div className="admin-container">
      {/* EN-TÊTE */}
      <div style={{ 
        margin: "2rem 0", 
        display: "flex", 
        justifyContent: "space-between", 
        alignItems: "center", 
        flexWrap: "wrap", 
        gap: "20px",
        padding: "20px",
        background: "#ffebee",
        borderRadius: "16px",
        boxShadow: "0 8px 25px rgba(198,40,40,0.15)"
      }}>
        <div style={{ display: "flex", alignItems: "center", gap: "20px" }}>
          <button
            onClick={() => navigate("/admin/classes")}
            style={{
              background: "none",
              border: "none",
              color: "#c62828",
              fontSize: "1.1rem",
              fontWeight: "bold",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "8px",
              padding: "8px 16px",
              borderRadius: "8px",
              backgroundColor: 'rgba(198, 40, 40, 0.1)',
              transition: 'all 0.3s ease'
            }}
            onMouseEnter={(e) => {
              e.target.style.backgroundColor = 'rgba(198, 40, 40, 0.2)';
            }}
            onMouseLeave={(e) => {
              e.target.style.backgroundColor = 'rgba(198, 40, 40, 0.1)';
            }}
          >
            ? Retour aux classes
          </button>

          <h1 style={{ color: "#c62828", fontSize: "2.8rem", margin: 0, fontWeight: "bold" }}>
            {cls.name}
          </h1>
        </div>

        <button
          onClick={deleteClass}
          style={{
            padding: "14px 28px",
            fontSize: "1.1rem",
            fontWeight: "600",
            backgroundColor: "#c62828",
            color: "white",
            border: "none",
            borderRadius: "12px",
            cursor: "pointer",
            transition: "all 0.3s ease"
          }}
          onMouseEnter={(e) => {
            e.target.style.backgroundColor = "#8e0000";
            e.target.style.transform = "translateY(-3px)";
          }}
          onMouseLeave={(e) => {
            e.target.style.backgroundColor = "#c62828";
            e.target.style.transform = "none";
          }}
        >
          Supprimer la classe
        </button>
      </div>

      {/* MODAL DE CONFIRMATION SUPPRESSION */}
      {showDeleteModal && (
        <div className="modal-overlay" style={{ zIndex: 9999 }}>
          <div className="modal-content" style={{
            maxWidth: "500px",
            padding: "40px",
            borderRadius: "20px",
            background: "white",
            textAlign: "center",
            boxShadow: "0 20px 50px rgba(198,40,40,0.4)"
          }}>
            <h2 style={{ color: "#c62828", marginBottom: "20px" }}>
              Supprimer la classe ?
            </h2>
            <p style={{ color: "#555", marginBottom: "30px" }}>
              <strong>"{cls.name}"</strong> sera supprimée définitivement.<br />
              Toutes les données seront perdues.
            </p>
            <div style={{ display: "flex", gap: "20px", justifyContent: "center" }}>
              <button
                onClick={() => {
                  deleteClass();
                  setShowDeleteModal(false);
                }}
                style={{
                  padding: "16px 36px",
                  backgroundColor: "#c62828",
                  color: "white",
                  border: "none",
                  borderRadius: "12px",
                  fontWeight: "bold",
                  cursor: "pointer",
                  transition: 'all 0.3s ease'
                }}
              >
                Oui, supprimer
              </button>
              <button
                onClick={() => setShowDeleteModal(false)}
                style={{
                  padding: "16px 36px",
                  backgroundColor: "#666",
                  color: "white",
                  border: "none",
                  borderRadius: "12px",
                  fontWeight: "bold",
                  cursor: "pointer",
                  transition: 'all 0.3s ease'
                }}
              >
                Annuler
              </button>
            </div>
          </div>
        </div>
      )}

      {/* CONTENU PRINCIPAL */}
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(350px, 1fr))', 
        gap: "30px",
        marginTop: '30px'
      }}>

        {/* ÉTUDIANTS */}
        <div style={{
          background: "white",
          padding: "30px",
          borderRadius: "20px",
          boxShadow: "0 10px 30px rgba(0,0,0,0.1)",
          border: "2px solid #ffebee"
        }}>
          <h2 style={{ color: "#c62828", marginBottom: "20px" }}>
            Étudiants ({cls.students?.length || 0}/30)
          </h2>

          {/* Menu déroulant pour ajouter un étudiant */}
          <select
            onChange={(e) => { 
              if (e.target.value) {
                addStudent(e.target.value); 
                e.target.value = ""; 
              }
            }}
            style={{ 
              width: "100%", 
              padding: "16px", 
              margin: "15px 0", 
              borderRadius: "12px", 
              border: "2px solid #c62828", 
              fontSize: "1.1rem",
              backgroundColor: 'white',
              cursor: 'pointer'
            }}
            disabled={pendingStudents.length === 0 || cls.students?.length >= 30}
          >
            <option value="">
              {pendingStudents.length === 0 
                ? "Aucun étudiant en attente disponible" 
                : `+ Ajouter un étudiant (${pendingStudents.length} en attente)`}
            </option>
            {pendingStudents.map(s => (
              <option key={s.id} value={s.id}>
                {s.username} ? {s.first_name} {s.last_name}
              </option>
            ))}
          </select>

          {/* Liste des étudiants */}
          <div style={{ maxHeight: "500px", overflowY: "auto", marginTop: "20px" }}>
            {cls.students?.length > 0 ? cls.students.map(stu => (
              <div key={stu.id} style={{
                padding: "16px", 
                background: "#ffebee", 
                margin: "12px 0",
                borderRadius: "14px", 
                border: "2px solid #c62828",
                display: "flex", 
                justifyContent: "space-between", 
                alignItems: "center",
                transition: 'all 0.3s ease'
              }}>
                <div>
                  <strong style={{ color: '#c62828' }}>{stu.username}</strong><br />
                  <span style={{ color: '#555' }}>
                    {stu.first_name} {stu.last_name}
                  </span>
                </div>
                <button
                  onClick={() => removeStudent(stu.id)}
                  style={{
                    background: "#c62828", 
                    color: "white", 
                    border: "none",
                    padding: "10px 18px", 
                    borderRadius: "10px", 
                    cursor: "pointer",
                    fontWeight: "bold", 
                    transition: "0.3s",
                    fontSize: '0.9rem'
                  }}
                  onMouseEnter={(e) => e.target.style.backgroundColor = "#8e0000"}
                  onMouseLeave={(e) => e.target.style.backgroundColor = "#c62828"}
                >
                  Retirer
                </button>
              </div>
            )) : (
              <div style={{ 
                textAlign: "center", 
                color: "#999", 
                padding: "40px",
                backgroundColor: '#f9f9f9',
                borderRadius: '12px'
              }}>
                <p style={{ fontSize: '1.2rem', marginBottom: '10px' }}>
                  Aucun étudiant inscrit
                </p>
                <p style={{ fontSize: '0.9rem' }}>
                  Ajoutez des étudiants depuis la liste en attente
                </p>
              </div>
            )}
          </div>
        </div>

        {/* AJOUTER MATIÈRE */}
        <div style={{
          background: "white",
          padding: "30px",
          borderRadius: "20px",
          boxShadow: "0 10px 30px rgba(0,0,0,0.1)",
          border: "2px solid #ffebee"
        }}>
          <h2 style={{ color: "#c62828", marginBottom: "20px" }}>
            Ajouter une matière
          </h2>

          {/* Sélection spécialité */}
          <select
            value={selectedSpecialtyId}
            onChange={(e) => { 
              setSelectedSpecialtyId(e.target.value); 
              setSelectedTeacherId(""); 
            }}
            style={{ 
              width: "100%", 
              padding: "16px", 
              margin: "15px 0", 
              borderRadius: "12px", 
              border: "2px solid #c62828",
              fontSize: '1.1rem',
              backgroundColor: 'white',
              cursor: 'pointer'
            }}
            disabled={availableSpecialties.length === 0}
          >
            <option value="">
              {availableSpecialties.length === 0 
                ? "Toutes les spécialités sont déjà assignées" 
                : "— Choisir la spécialité —"}
            </option>
            {availableSpecialties.map(s => (
              <option key={s.id} value={s.id}>{s.name}</option>
            ))}
          </select>

          {/* Sélection enseignant */}
          {selectedSpecialtyId && (
            <select
              value={selectedTeacherId}
              onChange={(e) => setSelectedTeacherId(e.target.value)}
              style={{ 
                width: "100%", 
                padding: "16px", 
                margin: "10px 0", 
                borderRadius: "12px", 
                border: "2px solid #c62828",
                fontSize: '1.1rem',
                backgroundColor: 'white',
                cursor: 'pointer'
              }}
            >
              <option value="">— Choisir le professeur —</option>
              {teachers
                .filter(t => t.specialty === allSpecialties.find(s => s.id == selectedSpecialtyId)?.name)
                .map(t => (
                  <option key={t.id} value={t.id}>
                    {t.username} - {t.first_name} {t.last_name} {t.approved ? "?" : " (en attente)"}
                  </option>
                ))}
            </select>
          )}

          <button
            onClick={addSubject}
            style={{
              width: "100%", 
              marginTop: "20px", 
              padding: "16px",
              backgroundColor: (selectedSpecialtyId && selectedTeacherId) ? "#c62828" : "#cccccc",
              color: "white", 
              border: "none", 
              borderRadius: "12px",
              fontSize: "1.1rem", 
              fontWeight: "600", 
              cursor: (selectedSpecialtyId && selectedTeacherId) ? "pointer" : "not-allowed",
              transition: "all 0.3s ease"
            }}
            disabled={!selectedSpecialtyId || !selectedTeacherId}
          >
            {selectedSpecialtyId && selectedTeacherId 
              ? "Ajouter la matière" 
              : "Sélectionnez spécialité et professeur"}
          </button>
        </div>

        {/* MATIÈRES */}
        <div style={{
          background: "white",
          padding: "30px",
          borderRadius: "20px",
          boxShadow: "0 10px 30px rgba(0,0,0,0.1)",
          border: "2px solid #ffebee",
          gridColumn: 'span 2'
        }}>
          <h2 style={{ color: "#c62828", marginBottom: "20px" }}>
            Matières ({cls.subjects?.length || 0})
          </h2>
          
          {cls.subjects?.length > 0 ? (
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', 
              gap: '20px' 
            }}>
              {cls.subjects.map(sub => (
                <div key={sub.id} style={{
                  padding: "20px", 
                  background: "#fff0f0", 
                  borderRadius: "16px", 
                  border: "2px dashed #c62828", 
                  position: "relative",
                  boxShadow: "0 4px 15px rgba(198,40,40,0.1)",
                  transition: 'all 0.3s ease'
                }}>
                  <button
                    onClick={() => deleteSubject(sub.id, sub.name)}
                    style={{
                      position: "absolute", 
                      top: "12px", 
                      right: "12px",
                      width: "36px", 
                      height: "36px", 
                      borderRadius: "50%",
                      backgroundColor: "#c62828", 
                      color: "white", 
                      border: "none",
                      fontSize: "1.2rem", 
                      fontWeight: "bold", 
                      cursor: "pointer",
                      boxShadow: "0 4px 15px rgba(198,40,40,0.4)",
                      transition: "all 0.3s ease",
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.backgroundColor = "#8e0000";
                      e.target.style.transform = "scale(1.1)";
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.backgroundColor = "#c62828";
                      e.target.style.transform = "scale(1)";
                    }}
                    title="Supprimer cette matière"
                  >
                    ×
                  </button>
                  <h3 style={{ 
                    margin: "0 0 10px 0", 
                    color: "#c62828", 
                    paddingRight: "40px", 
                    fontSize: "1.3rem" 
                  }}>
                    {sub.name}
                  </h3>
                  <p style={{ margin: "8px 0", fontWeight: "600", color: '#555' }}>
                    ????? Prof: {sub.teacher_name || "Non assigné"}
                  </p>
                  {sub.teacher_username && (
                    <p style={{ margin: "4px 0", fontSize: '0.9rem', color: '#777' }}>
                      ({sub.teacher_username})
                    </p>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <div style={{ 
              textAlign: "center", 
              color: "#999", 
              padding: "60px 20px",
              backgroundColor: '#f9f9f9',
              borderRadius: '12px'
            }}>
              <p style={{ fontSize: '1.2rem', marginBottom: '10px' }}>
                Aucune matière ajoutée
              </p>
              <p style={{ fontSize: '0.9rem' }}>
                Ajoutez des matières à cette classe
              </p>
            </div>
          )}
        </div>

      </div>
    </div>
  );
}

 et corriger ces pages par rapport le backend que j'envoyer pour cree les emploit et chaque emploit afficher a les etudiant et les esigiant qui relier a cette classe et les empoit edeensignient et d"etudiant il obliger relier car i les etudiant il doit ensignier des matiere par des ensignient   je veut la page cre empoit et gerer otomatique tout deponde les matierer et les classes que l'admin cree corriger AdminCourses.jsx   

// src/pages/admin/AdminCourses.jsx
import React, { useState, useEffect } from 'react';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardHeader,
  CardContent,
  CardActions,
  Typography,
  Button,
  TextField,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  IconButton,
  Chip,
  Avatar,
  LinearProgress,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Box,
  Tooltip,
  Fab
} from '@mui/material';
import {
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  GetApp as DownloadIcon,
  Visibility as ViewIcon,
  School as SchoolIcon,
  Person as PersonIcon,
  Folder as FolderIcon
} from '@mui/icons-material';
import { styled } from '@mui/material/styles';

const StyledCard = styled(Card)(({ theme }) => ({
  borderRadius: '12px',
  boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
  transition: 'transform 0.2s, box-shadow 0.2s',
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: '0 8px 24px rgba(0,0,0,0.1)'
  }
}));

const CourseCard = styled(Card)(({ theme }) => ({
  height: '100%',
  display: 'flex',
  flexDirection: 'column',
  border: '1px solid #e0e0e0',
  '&:hover': {
    borderColor: theme.palette.primary.main,
    backgroundColor: '#f9f9f9'
  }
}));

export default function AdminCourses() {
  const [courses, setCourses] = useState([]);
  const [subjects, setSubjects] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [openDialog, setOpenDialog] = useState(false);
  const [editingCourse, setEditingCourse] = useState(null);
  const [filter, setFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');

  const [courseForm, setCourseForm] = useState({
    title: '',
    description: '',
    subject: '',
    teacher: '',
    files: []
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      setLoading(true);
      const [coursesRes, subjectsRes, teachersRes] = await Promise.all([
        api.get('/courses/courses/'),
        api.get('/classes/subjects/'),
        api.get('/accounts/users/?role=teacher&approved=true')
      ]);

      setCourses(coursesRes.data);
      setSubjects(subjectsRes.data);
      setTeachers(teachersRes.data);
    } catch (err) {
      console.error('Erreur:', err);
      toast.error('Erreur de chargement des données');
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const courseData = {
        title: courseForm.title,
        description: courseForm.description,
        subject: parseInt(courseForm.subject),
        teacher: parseInt(courseForm.teacher)
      };

      let response;
      if (editingCourse) {
        response = await api.put(`/courses/courses/${editingCourse.id}/`, courseData);
        setCourses(courses.map(c => c.id === editingCourse.id ? response.data : c));
        toast.success('Cours mis à jour avec succès');
      } else {
        response = await api.post('/courses/courses/', courseData);
        setCourses([...courses, response.data]);
        toast.success('Cours créé avec succès');
      }

      handleCloseDialog();
      loadData();
    } catch (err) {
      console.error('Erreur:', err.response?.data || err);
      toast.error('Erreur lors de la sauvegarde');
    }
  };

  const handleDelete = async (courseId) => {
    if (!window.confirm('Êtes-vous sûr de vouloir supprimer ce cours ?')) return;

    try {
      await api.delete(`/courses/courses/${courseId}/`);
      setCourses(courses.filter(c => c.id !== courseId));
      toast.success('Cours supprimé avec succès');
    } catch (err) {
      toast.error('Erreur lors de la suppression');
    }
  };

  const handleOpenDialog = (course = null) => {
    if (course) {
      setEditingCourse(course);
      setCourseForm({
        title: course.title,
        description: course.description,
        subject: course.subject?.id || '',
        teacher: course.teacher?.id || '',
        files: []
      });
    } else {
      setEditingCourse(null);
      setCourseForm({
        title: '',
        description: '',
        subject: '',
        teacher: '',
        files: []
      });
    }
    setOpenDialog(true);
  };

  const handleCloseDialog = () => {
    setOpenDialog(false);
    setEditingCourse(null);
    setCourseForm({
      title: '',
      description: '',
      subject: '',
      teacher: '',
      files: []
    });
  };

  const filteredCourses = courses.filter(course => {
    if (filter !== 'all' && course.subject?.id !== parseInt(filter)) return false;
    if (searchTerm && !course.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item>
            <Typography variant="h4" component="h1" fontWeight="600">
              ?? Gestion des Cours
            </Typography>
            <Typography variant="body1" color="textSecondary">
              Créez et gérez les cours pour toutes les classes
            </Typography>
          </Grid>
          <Grid item>
            <Fab
              color="primary"
              onClick={() => handleOpenDialog()}
              sx={{ boxShadow: 3 }}
            >
              <AddIcon />
            </Fab>
          </Grid>
        </Grid>
      </Box>

      {/* Filters */}
      <Card sx={{ mb: 3, p: 2 }}>
        <Grid container spacing={2} alignItems="center">
          <Grid item xs={12} md={4}>
            <TextField
              fullWidth
              label="?? Rechercher un cours"
              variant="outlined"
              size="small"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </Grid>
          <Grid item xs={12} md={4}>
            <FormControl fullWidth size="small">
              <InputLabel>Filtrer par matière</InputLabel>
              <Select
                value={filter}
                onChange={(e) => setFilter(e.target.value)}
                label="Filtrer par matière"
              >
                <MenuItem value="all">Toutes les matières</MenuItem>
                {subjects.map(subject => (
                  <MenuItem key={subject.id} value={subject.id}>
                    {subject.name}
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>
          <Grid item xs={12} md={4}>
            <Button
              variant="outlined"
              startIcon={<DownloadIcon />}
              onClick={() => toast.info('Export en cours...')}
              fullWidth
            >
              Exporter la liste
            </Button>
          </Grid>
        </Grid>
      </Card>

      {/* Stats */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={3}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Total Cours
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {courses.length}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'primary.main' }}>
                  <FolderIcon />
                </Avatar>
              </Box>
            </CardContent>
          </StyledCard>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Matières
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {new Set(courses.map(c => c.subject?.id)).size}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'secondary.main' }}>
                  <SchoolIcon />
                </Avatar>
              </Box>
            </CardContent>
          </StyledCard>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Enseignants
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {new Set(courses.map(c => c.teacher?.id)).size}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'success.main' }}>
                  <PersonIcon />
                </Avatar>
              </Box>
            </CardContent>
          </StyledCard>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Cours Actifs
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {courses.length}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'warning.main' }}>
                  <ViewIcon />
                </Avatar>
              </Box>
            </CardContent>
          </StyledCard>
        </Grid>
      </Grid>

      {/* Courses Grid */}
      <Grid container spacing={3}>
        {filteredCourses.map(course => (
          <Grid item xs={12} sm={6} md={4} key={course.id}>
            <CourseCard>
              <CardHeader
                avatar={
                  <Avatar sx={{ bgcolor: 'primary.main' }}>
                    {course.subject?.name?.charAt(0) || 'C'}
                  </Avatar>
                }
                action={
                  <Box>
                    <Tooltip title="Modifier">
                      <IconButton size="small" onClick={() => handleOpenDialog(course)}>
                        <EditIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                    <Tooltip title="Supprimer">
                      <IconButton size="small" onClick={() => handleDelete(course.id)}>
                        <DeleteIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                  </Box>
                }
                title={
                  <Typography variant="h6" noWrap>
                    {course.title}
                  </Typography>
                }
                subheader={
                  <Box display="flex" alignItems="center" gap={1}>
                    <Chip
                      label={course.subject?.name || 'Inconnu'}
                      size="small"
                      color="primary"
                      variant="outlined"
                    />
                  </Box>
                }
              />
              <CardContent sx={{ flexGrow: 1 }}>
                <Typography variant="body2" color="textSecondary" paragraph>
                  {course.description?.substring(0, 150) || 'Aucune description...'}
                </Typography>
                <Box display="flex" alignItems="center" gap={1} mb={1}>
                  <PersonIcon fontSize="small" color="action" />
                  <Typography variant="body2">
                    {course.teacher?.username || 'Enseignant non assigné'}
                  </Typography>
                </Box>
              </CardContent>
              <CardActions sx={{ justifyContent: 'space-between', p: 2 }}>
                <Button
                  size="small"
                  startIcon={<ViewIcon />}
                  onClick={() => toast.info('Fonctionnalité à venir')}
                >
                  Détails
                </Button>
                <Typography variant="caption" color="textSecondary">
                  Créé le {new Date(course.created_at).toLocaleDateString('fr-FR')}
                </Typography>
              </CardActions>
            </CourseCard>
          </Grid>
        ))}
      </Grid>

      {/* Add/Edit Dialog */}
      <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="md" fullWidth>
        <DialogTitle>
          {editingCourse ? '?? Modifier le cours' : '? Créer un nouveau cours'}
        </DialogTitle>
        <form onSubmit={handleSubmit}>
          <DialogContent>
            <Grid container spacing={2}>
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  label="Titre du cours"
                  value={courseForm.title}
                  onChange={(e) => setCourseForm({...courseForm, title: e.target.value})}
                  required
                  margin="normal"
                />
              </Grid>
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  label="Description"
                  multiline
                  rows={4}
                  value={courseForm.description}
                  onChange={(e) => setCourseForm({...courseForm, description: e.target.value})}
                  margin="normal"
                />
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControl fullWidth margin="normal">
                  <InputLabel>Matière *</InputLabel>
                  <Select
                    value={courseForm.subject}
                    onChange={(e) => setCourseForm({...courseForm, subject: e.target.value})}
                    label="Matière *"
                    required
                  >
                    <MenuItem value="">
                      <em>Sélectionner une matière</em>
                    </MenuItem>
                    {subjects.map(subject => (
                      <MenuItem key={subject.id} value={subject.id}>
                        {subject.name} - {subject.class_name}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12} sm={6}>
                <FormControl fullWidth margin="normal">
                  <InputLabel>Enseignant *</InputLabel>
                  <Select
                    value={courseForm.teacher}
                    onChange={(e) => setCourseForm({...courseForm, teacher: e.target.value})}
                    label="Enseignant *"
                    required
                  >
                    <MenuItem value="">
                      <em>Sélectionner un enseignant</em>
                    </MenuItem>
                    {teachers.map(teacher => (
                      <MenuItem key={teacher.id} value={teacher.id}>
                        {teacher.username} ({teacher.email})
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
            </Grid>
          </DialogContent>
          <DialogActions sx={{ p: 3 }}>
            <Button onClick={handleCloseDialog} color="inherit">
              Annuler
            </Button>
            <Button type="submit" variant="contained" color="primary">
              {editingCourse ? 'Mettre à jour' : 'Créer le cours'}
            </Button>
          </DialogActions>
        </form>
      </Dialog>

      {filteredCourses.length === 0 && (
        <Box textAlign="center" py={8}>
          <SchoolIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" color="textSecondary">
            {searchTerm || filter !== 'all' 
              ? 'Aucun cours ne correspond à vos critères'
              : 'Aucun cours disponible'}
          </Typography>
          <Button
            variant="outlined"
            startIcon={<AddIcon />}
            onClick={() => handleOpenDialog()}
            sx={{ mt: 2 }}
          >
            Créer votre premier cours
          </Button>
        </Box>
      )}
    </Container>
  );
}

corriger pour uploader les cours de l'univirsity a l'etudiant et session StudentCourses.jsx     qui voir les cours qui  deux type general qui uploader l'admin et specifique qui uploader l''ensignien   et voila la partie AdminSchedule.jsx   pour cree les emploit des etudiant et d'ensignient 

// src/pages/admin/AdminSchedule.jsx
import React, { useState, useEffect } from 'react';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  TextField,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  IconButton,
  Chip,
  Paper,
  Box,
  Tooltip,
  Tabs,
  Tab,
  LinearProgress,
  Avatar,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow
} from '@mui/material';
import {
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Schedule as ScheduleIcon,
  Class as ClassIcon,
  Person as PersonIcon,
  Room as RoomIcon,
  AccessTime as TimeIcon,
  CalendarToday as CalendarIcon,
  AutoAwesome as AutoAwesomeIcon,
  Refresh as RefreshIcon
} from '@mui/icons-material';
import { styled } from '@mui/material/styles';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';

const StyledCard = styled(Card)(({ theme }) => ({
  borderRadius: '12px',
  boxShadow: '0 4px 12px rgba(0,0,0,0.05)',
  border: '1px solid #e0e0e0'
}));

const TimeSlotCard = styled(Paper)(({ theme }) => ({
  padding: '16px',
  marginBottom: '12px',
  borderRadius: '8px',
  borderLeft: '4px solid',
  borderLeftColor: theme.palette.primary.main,
  cursor: 'pointer',
  transition: 'all 0.2s',
  '&:hover': {
    transform: 'translateX(4px)',
    boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
  }
}));

const DayColumn = styled(Box)(({ theme }) => ({
  minHeight: '600px',
  backgroundColor: '#fafafa',
  borderRadius: '8px',
  padding: '16px',
  border: '1px solid #e0e0e0'
}));

export default function AdminSchedule() {
  const [classes, setClasses] = useState([]);
  const [selectedClass, setSelectedClass] = useState('');
  const [schedule, setSchedule] = useState(null);
  const [timeSlots, setTimeSlots] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [subjects, setSubjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);
  const [openDialog, setOpenDialog] = useState(false);
  const [tabValue, setTabValue] = useState(0);
  
  const [newTimeSlot, setNewTimeSlot] = useState({
    day: 'Monday',
    start_time: '08:30',
    end_time: '10:00',
    subject: '',
    teacher: '',
    classroom: 'Salle 101'
  });

  const days = [
    { id: 'Monday', label: 'Lundi', color: '#2196F3' },
    { id: 'Tuesday', label: 'Mardi', color: '#4CAF50' },
    { id: 'Wednesday', label: 'Mercredi', color: '#FF9800' },
    { id: 'Thursday', label: 'Jeudi', color: '#9C27B0' },
    { id: 'Friday', label: 'Vendredi', color: '#F44336' }
  ];

  useEffect(() => {
    loadClasses();
    loadTeachers();
  }, []);

  useEffect(() => {
    if (selectedClass) {
      loadClassSchedule(selectedClass);
      loadClassSubjects(selectedClass);
    }
  }, [selectedClass]);

  const loadClasses = async () => {
    try {
      const res = await api.get('/classes/classes/');
      setClasses(res.data);
    } catch (err) {
      toast.error('Erreur chargement classes');
    } finally {
      setLoading(false);
    }
  };

  const loadTeachers = async () => {
    try {
      const res = await api.get('/accounts/users/?role=teacher&approved=true');
      setTeachers(res.data);
    } catch (err) {
      console.error('Erreur teachers:', err);
    }
  };

  const loadClassSubjects = async (classId) => {
    try {
      const res = await api.get('/classes/subjects/');
      const filtered = res.data.filter(subject => subject.class_assigned == classId);
      setSubjects(filtered);
    } catch (err) {
      console.error('Erreur subjects:', err);
    }
  };

  const loadClassSchedule = async (classId) => {
    setLoading(true);
    try {
      const res = await api.get(`/schedule/schedules/class/${classId}/`);
      if (res.data) {
        setSchedule(res.data);
        setTimeSlots(res.data.time_slots || []);
      } else {
        setSchedule(null);
        setTimeSlots([]);
      }
    } catch (err) {
      console.error('Erreur schedule:', err);
      setSchedule(null);
      setTimeSlots([]);
    } finally {
      setLoading(false);
    }
  };

  const handleGenerateSchedule = async () => {
    if (!selectedClass) {
      toast.error('Veuillez sélectionner une classe');
      return;
    }

    setGenerating(true);
    try {
      // Créer schedule si nécessaire
      let scheduleId = schedule?.id;
      if (!scheduleId) {
        const createRes = await api.post('/schedule/schedules/', {
          class_assigned: parseInt(selectedClass)
        });
        scheduleId = createRes.data.id;
        setSchedule(createRes.data);
      }

      // Générer des créneaux automatiquement
      const classData = classes.find(c => c.id == selectedClass);
      const classSubjects = subjects;
      
      if (classSubjects.length === 0) {
        toast.warning('Aucune matière trouvée pour cette classe');
        return;
      }

      const generatedSlots = [];
      const teachersBySubject = {};
      
      // Associer chaque matière à un enseignant
      classSubjects.forEach(subject => {
        const teacher = teachers.find(t => t.id === subject.teacher);
        if (teacher) {
          teachersBySubject[subject.id] = teacher.id;
        }
      });

      // Générer pour chaque jour
      days.forEach(day => {
        const times = [
          ['08:30', '10:00'],
          ['10:15', '11:45'],
          ['13:00', '14:30'],
          ['14:45', '16:15']
        ];

        times.forEach(([start, end], index) => {
          if (classSubjects[index % classSubjects.length]) {
            const subject = classSubjects[index % classSubjects.length];
            const teacherId = teachersBySubject[subject.id];
            
            if (teacherId) {
              generatedSlots.push({
                day: day.id,
                start_time: start,
                end_time: end,
                subject: subject.id,
                teacher: teacherId,
                classroom: `Salle ${Math.floor(Math.random() * 10) + 101}`,
                schedule: scheduleId
              });
            }
          }
        });
      });

      // Envoyer chaque créneau
      for (const slot of generatedSlots) {
        await api.post('/schedule/time-slots/', slot);
      }

      toast.success('Emploi du temps généré avec succès !');
      loadClassSchedule(selectedClass);
    } catch (err) {
      console.error('Erreur génération:', err);
      toast.error('Erreur lors de la génération');
    } finally {
      setGenerating(false);
    }
  };

  const handleAddTimeSlot = async (e) => {
    e.preventDefault();
    
    if (!selectedClass) {
      toast.error('Veuillez sélectionner une classe');
      return;
    }

    try {
      let scheduleId = schedule?.id;
      if (!scheduleId) {
        const scheduleRes = await api.post('/schedule/schedules/', {
          class_assigned: parseInt(selectedClass)
        });
        scheduleId = scheduleRes.data.id;
        setSchedule(scheduleRes.data);
      }

      const slotData = {
        ...newTimeSlot,
        schedule: scheduleId
      };

      const res = await api.post('/schedule/time-slots/', slotData);
      setTimeSlots([...timeSlots, res.data]);
      
      setNewTimeSlot({
        day: 'Monday',
        start_time: '08:30',
        end_time: '10:00',
        subject: '',
        teacher: '',
        classroom: 'Salle 101'
      });
      
      setOpenDialog(false);
      toast.success('Créneau ajouté avec succès');
    } catch (err) {
      toast.error('Erreur ajout créneau');
    }
  };

  const handleDeleteTimeSlot = async (slotId) => {
    if (!window.confirm('Supprimer ce créneau ?')) return;
    
    try {
      await api.delete(`/schedule/time-slots/${slotId}/`);
      setTimeSlots(timeSlots.filter(slot => slot.id !== slotId));
      toast.success('Créneau supprimé');
    } catch (err) {
      toast.error('Erreur suppression');
    }
  };

  const formatTime = (timeStr) => {
    if (!timeStr) return '';
    const [hours, minutes] = timeStr.split(':');
    return `${hours}h${minutes}`;
  };

  const getDaySlots = (dayId) => {
    return timeSlots
      .filter(slot => slot.day === dayId)
      .sort((a, b) => a.start_time.localeCompare(b.start_time));
  };

  const getSubjectName = (subjectId) => {
    const subject = subjects.find(s => s.id == subjectId);
    return subject?.name || 'Inconnu';
  };

  const getTeacherName = (teacherId) => {
    const teacher = teachers.find(t => t.id == teacherId);
    return teacher?.username || 'Inconnu';
  };

  const onDragEnd = (result) => {
    if (!result.destination) return;
    
    const items = Array.from(timeSlots);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);
    
    setTimeSlots(items);
  };

  if (loading && !selectedClass) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item>
            <Typography variant="h4" component="h1" fontWeight="600">
              ?? Gestion des Emplois du Temps
            </Typography>
            <Typography variant="body1" color="textSecondary">
              Créez et gérez les emplois du temps des classes
            </Typography>
          </Grid>
          <Grid item>
            <Button
              variant="contained"
              startIcon={<AutoAwesomeIcon />}
              onClick={handleGenerateSchedule}
              disabled={!selectedClass || generating}
              sx={{ mr: 2 }}
            >
              {generating ? 'Génération...' : '?? Générer automatiquement'}
            </Button>
            <Button
              variant="outlined"
              startIcon={<AddIcon />}
              onClick={() => setOpenDialog(true)}
              disabled={!selectedClass}
            >
              Ajouter un créneau
            </Button>
          </Grid>
        </Grid>
      </Box>

      {/* Class Selector */}
      <Card sx={{ mb: 4, p: 3 }}>
        <Grid container spacing={3} alignItems="center">
          <Grid item xs={12} md={4}>
            <FormControl fullWidth>
              <InputLabel>Classe</InputLabel>
              <Select
                value={selectedClass}
                onChange={(e) => setSelectedClass(e.target.value)}
                label="Classe"
              >
                <MenuItem value="">
                  <em>Sélectionner une classe</em>
                </MenuItem>
                {classes.map(cls => (
                  <MenuItem key={cls.id} value={cls.id}>
                    <Box display="flex" alignItems="center" gap={1}>
                      <ClassIcon fontSize="small" />
                      {cls.name} ({cls.students_count || 0} étudiants)
                    </Box>
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>
          {selectedClass && (
            <>
              <Grid item xs={12} md={8}>
                <Box display="flex" gap={2} flexWrap="wrap">
                  <Chip
                    icon={<ScheduleIcon />}
                    label={`${timeSlots.length} créneaux`}
                    variant="outlined"
                  />
                  <Chip
                    icon={<PersonIcon />}
                    label={`${subjects.length} matières`}
                    variant="outlined"
                  />
                  <Chip
                    icon={<RoomIcon />}
                    label="5 jours/semaine"
                    variant="outlined"
                  />
                  <Button
                    size="small"
                    startIcon={<RefreshIcon />}
                    onClick={() => loadClassSchedule(selectedClass)}
                  >
                    Actualiser
                  </Button>
                </Box>
              </Grid>
            </>
          )}
        </Grid>
      </Card>

      {selectedClass ? (
        <>
          {/* Tabs */}
          <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
            <Tabs value={tabValue} onChange={(e, v) => setTabValue(v)}>
              <Tab icon={<CalendarIcon />} label="Vue semaine" />
              <Tab icon={<ScheduleIcon />} label="Vue jour" />
              <Tab icon={<RoomIcon />} label="Salles" />
            </Tabs>
          </Box>

          {/* Weekly Schedule */}
          {tabValue === 0 && (
            <Grid container spacing={2}>
              {days.map(day => (
                <Grid item xs={12} md={2.4} key={day.id}>
                  <DayColumn>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                      <Typography variant="h6" fontWeight="600" color={day.color}>
                        {day.label}
                      </Typography>
                      <Chip
                        label={getDaySlots(day.id).length}
                        size="small"
                        color="primary"
                      />
                    </Box>
                    
                    <DragDropContext onDragEnd={onDragEnd}>
                      <Droppable droppableId={day.id}>
                        {(provided) => (
                          <Box
                            ref={provided.innerRef}
                            {...provided.droppableProps}
                          >
                            {getDaySlots(day.id).map((slot, index) => (
                              <Draggable
                                key={slot.id}
                                draggableId={String(slot.id)}
                                index={index}
                              >
                                {(provided) => (
                                  <TimeSlotCard
                                    ref={provided.innerRef}
                                    {...provided.draggableProps}
                                    {...provided.dragHandleProps}
                                  >
                                    <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={1}>
                                      <Typography variant="subtitle2" fontWeight="600">
                                        {getSubjectName(slot.subject)}
                                      </Typography>
                                      <IconButton
                                        size="small"
                                        onClick={() => handleDeleteTimeSlot(slot.id)}
                                      >
                                        <DeleteIcon fontSize="small" />
                                      </IconButton>
                                    </Box>
                                    <Box display="flex" alignItems="center" gap={1} mb={1}>
                                      <TimeIcon fontSize="small" color="action" />
                                      <Typography variant="caption">
                                        {formatTime(slot.start_time)} - {formatTime(slot.end_time)}
                                      </Typography>
                                    </Box>
                                    <Box display="flex" alignItems="center" gap={1} mb={1}>
                                      <PersonIcon fontSize="small" color="action" />
                                      <Typography variant="caption">
                                        {getTeacherName(slot.teacher)}
                                      </Typography>
                                    </Box>
                                    {slot.classroom && (
                                      <Box display="flex" alignItems="center" gap={1}>
                                        <RoomIcon fontSize="small" color="action" />
                                        <Typography variant="caption">
                                          {slot.classroom}
                                        </Typography>
                                      </Box>
                                    )}
                                  </TimeSlotCard>
                                )}
                              </Draggable>
                            ))}
                            {provided.placeholder}
                          </Box>
                        )}
                      </Droppable>
                    </DragDropContext>

                    {getDaySlots(day.id).length === 0 && (
                      <Box textAlign="center" py={4}>
                        <Typography variant="body2" color="textSecondary">
                          Aucun cours ce jour
                        </Typography>
                        <Button
                          size="small"
                          startIcon={<AddIcon />}
                          onClick={() => {
                            setNewTimeSlot({...newTimeSlot, day: day.id});
                            setOpenDialog(true);
                          }}
                          sx={{ mt: 1 }}
                        >
                          Ajouter
                        </Button>
                      </Box>
                    )}
                  </DayColumn>
                </Grid>
              ))}
            </Grid>
          )}

          {/* Day View */}
          {tabValue === 1 && (
            <Card>
              <CardContent>
                <TableContainer>
                  <Table>
                    <TableHead>
                      <TableRow>
                        <TableCell>Horaire</TableCell>
                        <TableCell>Matière</TableCell>
                        <TableCell>Enseignant</TableCell>
                        <TableCell>Salle</TableCell>
                        <TableCell>Jour</TableCell>
                        <TableCell>Actions</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {timeSlots
                        .sort((a, b) => {
                          const dayOrder = {Monday: 1, Tuesday: 2, Wednesday: 3, Thursday: 4, Friday: 5};
                          if (dayOrder[a.day] !== dayOrder[b.day]) {
                            return dayOrder[a.day] - dayOrder[b.day];
                          }
                          return a.start_time.localeCompare(b.start_time);
                        })
                        .map(slot => (
                          <TableRow key={slot.id} hover>
                            <TableCell>
                              <Box display="flex" alignItems="center" gap={1}>
                                <TimeIcon fontSize="small" />
                                {formatTime(slot.start_time)} - {formatTime(slot.end_time)}
                              </Box>
                            </TableCell>
                            <TableCell>{getSubjectName(slot.subject)}</TableCell>
                            <TableCell>{getTeacherName(slot.teacher)}</TableCell>
                            <TableCell>{slot.classroom}</TableCell>
                            <TableCell>
                              <Chip
                                label={days.find(d => d.id === slot.day)?.label}
                                size="small"
                                variant="outlined"
                              />
                            </TableCell>
                            <TableCell>
                              <Tooltip title="Supprimer">
                                <IconButton size="small" onClick={() => handleDeleteTimeSlot(slot.id)}>
                                  <DeleteIcon fontSize="small" />
                                </IconButton>
                              </Tooltip>
                            </TableCell>
                          </TableRow>
                        ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </CardContent>
            </Card>
          )}
        </>
      ) : (
        <Box textAlign="center" py={8}>
          <ScheduleIcon sx={{ fontSize: 64, color: 'text.secondary', mb: 2 }} />
          <Typography variant="h6" color="textSecondary" gutterBottom>
            Sélectionnez une classe
          </Typography>
          <Typography variant="body2" color="textSecondary" paragraph>
            Choisissez une classe pour afficher ou créer son emploi du temps
          </Typography>
        </Box>
      )}

      {/* Add TimeSlot Dialog */}
      <Dialog open={openDialog} onClose={() => setOpenDialog(false)} maxWidth="sm" fullWidth>
        <DialogTitle>
          <Box display="flex" alignItems="center" gap={1}>
            <AddIcon />
            Ajouter un créneau horaire
          </Box>
        </DialogTitle>
        <form onSubmit={handleAddTimeSlot}>
          <DialogContent>
            <Grid container spacing={2}>
              <Grid item xs={12}>
                <FormControl fullWidth margin="normal">
                  <InputLabel>Jour</InputLabel>
                  <Select
                    value={newTimeSlot.day}
                    onChange={(e) => setNewTimeSlot({...newTimeSlot, day: e.target.value})}
                    label="Jour"
                    required
                  >
                    {days.map(day => (
                      <MenuItem key={day.id} value={day.id}>
                        {day.label}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={6}>
                <TextField
                  fullWidth
                  label="Heure début"
                  type="time"
                  value={newTimeSlot.start_time}
                  onChange={(e) => setNewTimeSlot({...newTimeSlot, start_time: e.target.value})}
                  required
                  InputLabelProps={{ shrink: true }}
                />
              </Grid>
              <Grid item xs={6}>
                <TextField
                  fullWidth
                  label="Heure fin"
                  type="time"
                  value={newTimeSlot.end_time}
                  onChange={(e) => setNewTimeSlot({...newTimeSlot, end_time: e.target.value})}
                  required
                  InputLabelProps={{ shrink: true }}
                />
              </Grid>
              <Grid item xs={12}>
                <FormControl fullWidth margin="normal">
                  <InputLabel>Matière</InputLabel>
                  <Select
                    value={newTimeSlot.subject}
                    onChange={(e) => setNewTimeSlot({...newTimeSlot, subject: e.target.value})}
                    label="Matière"
                    required
                  >
                    <MenuItem value="">
                      <em>Sélectionner une matière</em>
                    </MenuItem>
                    {subjects.map(subject => (
                      <MenuItem key={subject.id} value={subject.id}>
                        {subject.name}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12}>
                <FormControl fullWidth margin="normal">
                  <InputLabel>Enseignant</InputLabel>
                  <Select
                    value={newTimeSlot.teacher}
                    onChange={(e) => setNewTimeSlot({...newTimeSlot, teacher: e.target.value})}
                    label="Enseignant"
                    required
                  >
                    <MenuItem value="">
                      <em>Sélectionner un enseignant</em>
                    </MenuItem>
                    {teachers.map(teacher => (
                      <MenuItem key={teacher.id} value={teacher.id}>
                        {teacher.username}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  label="Salle"
                  value={newTimeSlot.classroom}
                  onChange={(e) => setNewTimeSlot({...newTimeSlot, classroom: e.target.value})}
                  margin="normal"
                />
              </Grid>
            </Grid>
          </DialogContent>
          <DialogActions sx={{ p: 3 }}>
            <Button onClick={() => setOpenDialog(false)} color="inherit">
              Annuler
            </Button>
            <Button type="submit" variant="contained" color="primary">
              Ajouter le créneau
            </Button>
          </DialogActions>
        </form>
      </Dialog>
    </Container>
  );
}

voila les partie niccesaire pour corriger les autres pages    les pages dans src/pages/student qui tout il doit obligatoir verifier partie backend  et apres la partie backend corriger tout les pages deja j'envoyer le plut important il fonction avec le backend car touts les pages il afficher direct eureur de fonctionner a serveur mais le seveur lence avec sucee alors le probleme de affecter chaque page a le backend ou une movese backend tout je veut corriger pour assurer que tout les page et fonctionner sur le backend et relier avec la partie admin car le classe deja cree par admin et deja il doit gerer tout lapartie stydent et teacher par rapport les classes cree    voila les pages   src/pages/student  StudentClassDetails.jsx// src/pages/student/StudentClassDetails.jsx
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Box,
  LinearProgress,
  Tabs,
  Tab,
  Avatar,
  IconButton,
  Paper,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
  Divider,
  Badge,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  InputAdornment,
  alpha,
  styled
} from '@mui/material';
import {
  ArrowBack as ArrowBackIcon,
  People as PeopleIcon,
  Book as BookIcon,
  VideoCall as VideoCallIcon,
  Assignment as AssignmentIcon,
  Chat as ChatIcon,
  Schedule as ScheduleIcon,
  Folder as FolderIcon,
  MoreVert as MoreVertIcon,
  Search as SearchIcon,
  FilterList as FilterIcon,
  Add as AddIcon,
  Download as DownloadIcon,
  Visibility as ViewIcon,
  PlayCircle as PlayIcon,
  AccessTime as TimeIcon,
  Person as PersonIcon,
  School as SchoolIcon
} from '@mui/icons-material';

const SubjectCard = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(3),
  borderRadius: '12px',
  height: '100%',
  cursor: 'pointer',
  transition: 'all 0.2s',
  border: '1px solid transparent',
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: theme.shadows[8],
    borderColor: theme.palette.primary.main,
    backgroundColor: alpha(theme.palette.primary.main, 0.02)
  }
}));

const LiveSessionCard = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(2),
  borderRadius: '12px',
  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  color: 'white',
  position: 'relative',
  overflow: 'hidden',
  '&::before': {
    content: '""',
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'rgba(0,0,0,0.1)'
  }
}));

export default function StudentClassDetails() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [classData, setClassData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [openChat, setOpenChat] = useState(false);
  const [message, setMessage] = useState('');
  const [chatMessages, setChatMessages] = useState([]);
  const [liveSessions, setLiveSessions] = useState([]);
  const [activeLiveSession, setActiveLiveSession] = useState(null);

  useEffect(() => {
    loadClassData();
    loadLiveSessions();
    loadChatMessages();
  }, [id]);

  const loadClassData = async () => {
    try {
      setLoading(true);
      const res = await api.get(`/classes/classes/${id}/`);
      setClassData(res.data);
    } catch (err) {
      console.error('Erreur:', err);
      toast.error('Erreur de chargement de la classe');
      navigate('/student/dashboard');
    } finally {
      setLoading(false);
    }
  };

  const loadLiveSessions = async () => {
    try {
      const res = await api.get('/live/sessions/active/');
      const filtered = res.data.filter(session => 
        session.subject?.class_assigned?.toString() === id
      );
      setLiveSessions(filtered);
      
      // Simuler une session active
      if (filtered.length === 0) {
        setLiveSessions([
          {
            id: 1,
            title: 'Algorithmique - Séance Live',
            teacher: 'Dr. Smith',
            start_time: new Date().toISOString(),
            participants_count: 12,
            is_active: true,
            subject: { name: 'Algorithmique' }
          }
        ]);
      }
    } catch (err) {
      console.error('Erreur sessions:', err);
    }
  };

  const loadChatMessages = () => {
    // Simuler des messages de chat
    const mockMessages = [
      { id: 1, user: 'Dr. Smith', message: 'Bonjour à tous ! La session commence maintenant.', time: '10:00', isTeacher: true },
      { id: 2, user: 'Ahmed', message: 'Bonjour professeur !', time: '10:01', isTeacher: false },
      { id: 3, user: 'Fatima', message: 'J\'ai une question sur l\'exercice 3', time: '10:02', isTeacher: false },
      { id: 4, user: 'Dr. Smith', message: 'Je vais expliquer maintenant.', time: '10:03', isTeacher: true }
    ];
    setChatMessages(mockMessages);
  };

  const joinLiveSession = (sessionId) => {
    navigate(`/live-session/${sessionId}`);
  };

  const sendMessage = () => {
    if (!message.trim()) return;
    
    const newMessage = {
      id: chatMessages.length + 1,
      user: 'Moi',
      message: message,
      time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
      isTeacher: false
    };
    
    setChatMessages([...chatMessages, newMessage]);
    setMessage('');
  };

  const downloadResource = (resource) => {
    toast.info(`Téléchargement de ${resource.name}...`);
    // Implémentation du téléchargement réel
  };

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  if (!classData) {
    return (
      <Container maxWidth="xl" sx={{ py: 4, textAlign: 'center' }}>
        <Typography variant="h5" color="textSecondary">
          Classe introuvable
        </Typography>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/student/dashboard')}
          sx={{ mt: 2 }}
        >
          Retour au tableau de bord
        </Button>
      </Container>
    );
  }

  const tabs = [
    { label: 'Matières', icon: <BookIcon />, count: classData.subjects?.length || 0 },
    { label: 'Cours', icon: <FolderIcon />, count: 8 },
    { label: 'Live', icon: <VideoCallIcon />, count: liveSessions.length },
    { label: 'Chat', icon: <ChatIcon />, count: chatMessages.length },
    { label: 'Emploi du temps', icon: <ScheduleIcon /> },
    { label: 'Membres', icon: <PeopleIcon />, count: classData.students?.length || 0 }
  ];

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/student/dashboard')}
          sx={{ mb: 2 }}
        >
          Retour
        </Button>
        
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item>
            <Typography variant="h4" component="h1" fontWeight="600">
              {classData.name}
            </Typography>
            <Box display="flex" alignItems="center" gap={2} mt={1}>
              <Chip
                icon={<PeopleIcon />}
                label={`${classData.students?.length || 0} étudiants`}
                size="small"
                color="primary"
                variant="outlined"
              />
              <Chip
                icon={<BookIcon />}
                label={`${classData.subjects?.length || 0} matières`}
                size="small"
                color="secondary"
                variant="outlined"
              />
              <Chip
                icon={<SchoolIcon />}
                label="ING1 Informatique"
                size="small"
                variant="outlined"
              />
            </Box>
          </Grid>
          <Grid item>
            <Box display="flex" gap={1}>
              <Button
                variant="outlined"
                startIcon={<ScheduleIcon />}
                onClick={() => navigate(`/student/schedule/${id}`)}
              >
                Emploi du temps
              </Button>
              <Button
                variant="contained"
                startIcon={<ChatIcon />}
                onClick={() => setOpenChat(true)}
              >
                Ouvrir le chat
              </Button>
            </Box>
          </Grid>
        </Grid>
      </Box>

      {/* Live Sessions Banner */}
      {liveSessions.filter(s => s.is_active).length > 0 && (
        <LiveSessionCard sx={{ mb: 4 }}>
          <Grid container alignItems="center" spacing={2}>
            <Grid item xs={12} md={8}>
              <Box position="relative" zIndex={1}>
                <Typography variant="h6" fontWeight="600" gutterBottom>
                  ?? Session en cours
                </Typography>
                <Typography variant="body1">
                  {liveSessions[0].title} avec {liveSessions[0].teacher}
                </Typography>
                <Box display="flex" alignItems="center" gap={2} mt={1}>
                  <Chip
                    label="EN DIRECT"
                    size="small"
                    sx={{ background: 'rgba(255,255,255,0.2)', color: 'white' }}
                  />
                  <Typography variant="body2">
                    ?? {liveSessions[0].participants_count} participants
                  </Typography>
                </Box>
              </Box>
            </Grid>
            <Grid item xs={12} md={4} textAlign="right">
              <Button
                variant="contained"
                startIcon={<PlayIcon />}
                sx={{
                  background: 'white',
                  color: '#764ba2',
                  '&:hover': { background: 'rgba(255,255,255,0.9)' }
                }}
                onClick={() => joinLiveSession(liveSessions[0].id)}
              >
                Rejoindre
              </Button>
            </Grid>
          </Grid>
        </LiveSessionCard>
      )}

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 4 }}>
        <Tabs
          value={tabValue}
          onChange={(e, v) => setTabValue(v)}
          variant="scrollable"
          scrollButtons="auto"
        >
          {tabs.map((tab, index) => (
            <Tab
              key={index}
              icon={tab.icon}
              iconPosition="start"
              label={
                <Box display="flex" alignItems="center" gap={1}>
                  {tab.label}
                  {tab.count !== undefined && (
                    <Badge
                      badgeContent={tab.count}
                      color="primary"
                      sx={{ '& .MuiBadge-badge': { fontSize: '0.7rem' } }}
                    />
                  )}
                </Box>
              }
            />
          ))}
        </Tabs>
      </Box>

      {/* Subjects Tab */}
      {tabValue === 0 && (
        <Grid container spacing={3}>
          {classData.subjects?.map(subject => (
            <Grid item xs={12} sm={6} md={4} key={subject.id}>
              <SubjectCard onClick={() => navigate(`/student/subject/${subject.id}`)}>
                <Box display="flex" alignItems="flex-start" justifyContent="space-between" mb={2}>
                  <Avatar sx={{ bgcolor: 'primary.main', mb: 1 }}>
                    <BookIcon />
                  </Avatar>
                  <IconButton size="small">
                    <MoreVertIcon />
                  </IconButton>
                </Box>
                
                <Typography variant="h6" fontWeight="600" gutterBottom>
                  {subject.name}
                </Typography>
                
                {subject.teacher_name && (
                  <Box display="flex" alignItems="center" gap={1} mb={2}>
                    <PersonIcon fontSize="small" color="action" />
                    <Typography variant="body2" color="textSecondary">
                      {subject.teacher_name}
                    </Typography>
                  </Box>
                )}
                
                <Box display="flex" justifyContent="space-between" alignItems="center" mt={3}>
                  <Button
                    size="small"
                    startIcon={<FolderIcon />}
                    onClick={(e) => {
                      e.stopPropagation();
                      navigate(`/student/subject/${subject.id}?tab=courses`);
                    }}
                  >
                    Cours
                  </Button>
                  <Button
                    size="small"
                    startIcon={<AssignmentIcon />}
                    onClick={(e) => {
                      e.stopPropagation();
                      navigate(`/student/subject/${subject.id}?tab=tests`);
                    }}
                  >
                    Tests
                  </Button>
                </Box>
              </SubjectCard>
            </Grid>
          ))}
        </Grid>
      )}

      {/* Courses Tab */}
      {tabValue === 1 && (
        <Card>
          <CardContent>
            <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
              <Typography variant="h6" fontWeight="600">
                ?? Cours disponibles
              </Typography>
              <Box display="flex" gap={1}>
                <TextField
                  size="small"
                  placeholder="Rechercher un cours..."
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <SearchIcon />
                      </InputAdornment>
                    )
                  }}
                />
                <Button startIcon={<FilterIcon />} size="small">
                  Filtrer
                </Button>
              </Box>
            </Box>

            <List disablePadding>
              {[
                { id: 1, title: 'Introduction à l\'Algorithmique', teacher: 'Dr. Smith', date: '2024-01-15', files: 3 },
                { id: 2, title: 'Structures de données', teacher: 'Dr. Smith', date: '2024-01-18', files: 5 },
                { id: 3, title: 'Algorithmes de tri', teacher: 'Dr. Smith', date: '2024-01-22', files: 2 },
                { id: 4, title: 'Complexité algorithmique', teacher: 'Dr. Smith', date: '2024-01-25', files: 4 }
              ].map((course, index) => (
                <React.Fragment key={course.id}>
                  <ListItem
                    alignItems="flex-start"
                    sx={{
                      '&:hover': { backgroundColor: 'action.hover' },
                      borderRadius: 1,
                      mb: 1
                    }}
                    secondaryAction={
                      <Box display="flex" gap={1}>
                        <IconButton size="small" onClick={() => downloadResource(course)}>
                          <DownloadIcon />
                        </IconButton>
                        <IconButton size="small" onClick={() => toast.info('Vue détaillée')}>
                          <ViewIcon />
                        </IconButton>
                      </Box>
                    }
                  >
                    <ListItemAvatar>
                      <Avatar sx={{ bgcolor: 'primary.main' }}>
                        <FolderIcon />
                      </Avatar>
                    </ListItemAvatar>
                    <ListItemText
                      primary={
                        <Typography variant="subtitle1" fontWeight="600">
                          {course.title}
                        </Typography>
                      }
                      secondary={
                        <>
                          <Typography variant="body2" color="textSecondary">
                            ????? {course.teacher} • ?? {new Date(course.date).toLocaleDateString('fr-FR')}
                          </Typography>
                          <Chip
                            label={`${course.files} fichiers`}
                            size="small"
                            variant="outlined"
                            sx={{ mt: 1 }}
                          />
                        </>
                      }
                    />
                  </ListItem>
                  {index < 3 && <Divider />}
                </React.Fragment>
              ))}
            </List>
          </CardContent>
        </Card>
      )}

      {/* Live Sessions Tab */}
      {tabValue === 2 && (
        <Grid container spacing={3}>
          {liveSessions.map(session => (
            <Grid item xs={12} md={6} key={session.id}>
              <Card>
                <CardContent>
                  <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={2}>
                    <Box>
                      <Typography variant="h6" fontWeight="600" gutterBottom>
                        {session.title}
                      </Typography>
                      <Typography variant="body2" color="textSecondary">
                        ?? {session.subject?.name} • ????? {session.teacher}
                      </Typography>
                    </Box>
                    <Chip
                      label={session.is_active ? 'EN DIRECT' : 'TERMINÉE'}
                      color={session.is_active ? 'error' : 'default'}
                      size="small"
                    />
                  </Box>
                  
                  <Box display="flex" alignItems="center" justifyContent="space-between" mt={3}>
                    <Box display="flex" alignItems="center" gap={2}>
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <PeopleIcon fontSize="small" />
                        <Typography variant="body2">
                          {session.participants_count || 0} participants
                        </Typography>
                      </Box>
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <TimeIcon fontSize="small" />
                        <Typography variant="body2">
                          {new Date(session.start_time).toLocaleTimeString('fr-FR', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                          })}
                        </Typography>
                      </Box>
                    </Box>
                    <Button
                      variant={session.is_active ? 'contained' : 'outlined'}
                      startIcon={session.is_active ? <PlayIcon /> : <ViewIcon />}
                      onClick={() => session.is_active ? joinLiveSession(session.id) : toast.info('Voir l\'enregistrement')}
                    >
                      {session.is_active ? 'Rejoindre' : 'Voir'}
                    </Button>
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          ))}
        </Grid>
      )}

      {/* Chat Dialog */}
      <Dialog
        open={openChat}
        onClose={() => setOpenChat(false)}
        maxWidth="sm"
        fullWidth
        PaperProps={{ sx: { height: '80vh' } }}
      >
        <DialogTitle sx={{ borderBottom: 1, borderColor: 'divider' }}>
          <Box display="flex" alignItems="center" gap={1}>
            <ChatIcon />
            Chat de la classe - {classData.name}
          </Box>
        </DialogTitle>
        <DialogContent sx={{ p: 0, display: 'flex', flexDirection: 'column' }}>
          {/* Messages */}
          <Box flex={1} p={2} sx={{ overflowY: 'auto' }}>
            {chatMessages.map(msg => (
              <Box
                key={msg.id}
                sx={{
                  mb: 2,
                  display: 'flex',
                  flexDirection: msg.isTeacher ? 'row' : 'row-reverse'
                }}
              >
                <Paper
                  sx={{
                    p: 2,
                    maxWidth: '70%',
                    bgcolor: msg.isTeacher ? 'primary.main' : 'grey.100',
                    color: msg.isTeacher ? 'white' : 'text.primary',
                    borderRadius: 2,
                    borderTopLeftRadius: msg.isTeacher ? 2 : 12,
                    borderTopRightRadius: msg.isTeacher ? 12 : 2
                  }}
                >
                  <Typography variant="caption" display="block" mb={0.5}>
                    <strong>{msg.user}</strong> • {msg.time}
                  </Typography>
                  <Typography variant="body2">
                    {msg.message}
                  </Typography>
                </Paper>
              </Box>
            ))}
          </Box>

          {/* Input */}
          <Box p={2} sx={{ borderTop: 1, borderColor: 'divider' }}>
            <TextField
              fullWidth
              placeholder="Écrivez votre message..."
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
              InputProps={{
                endAdornment: (
                  <InputAdornment position="end">
                    <IconButton onClick={sendMessage} color="primary">
                      <SendIcon />
                    </IconButton>
                  </InputAdornment>
                )
              }}
            />
          </Box>
        </DialogContent>
        <DialogActions sx={{ p: 2, borderTop: 1, borderColor: 'divider' }}>
          <Button onClick={() => setOpenChat(false)}>Fermer</Button>
        </DialogActions>
      </Dialog>

      {/* Floating Action Button for Quick Actions */}
      <Fab
        color="primary"
        sx={{ position: 'fixed', bottom: 24, right: 24 }}
        onClick={() => toast.info('Menu rapide')}
      >
        <AddIcon />
      </Fab>
    </Container>
  );
}StudentCourses.jsx  // src/pages/student/StudentCourses.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';

export default function StudentCourses() {
  const navigate = useNavigate();
  const [courses, setCourses] = useState([]);
  const [filteredCourses, setFilteredCourses] = useState([]);
  const [subjects, setSubjects] = useState([]);
  const [selectedSubject, setSelectedSubject] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    total: 0,
    subjects: 0,
    teachers: 0,
    lastUpdated: null
  });

  useEffect(() => {
    loadData();
  }, []);

  useEffect(() => {
    filterCourses();
  }, [selectedSubject, searchTerm, courses]);

  const loadData = async () => {
    try {
      // Récupérer les cours accessibles à l'étudiant
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userClasses = user.enrolled_classes || [];
      
      let allCourses = [];
      let allSubjects = new Set();
      let allTeachers = new Set();

      // Récupérer les matières des classes de l'étudiant
      for (const classId of userClasses) {
        try {
          const subjectsRes = await api.get(`/classes/classes/${classId}/`);
          const classSubjects = subjectsRes.data?.subjects || [];
          
          // Récupérer les cours pour chaque matière
          for (const subject of classSubjects) {
            allSubjects.add(subject.name);
            
            const coursesRes = await api.get('/courses/courses/', {
              params: { subject: subject.id }
            });
            
            const subjectCourses = coursesRes.data || [];
            subjectCourses.forEach(course => {
              allTeachers.add(course.teacher_name);
              allCourses.push({
                ...course,
                subject_name: subject.name,
                class_name: subjectsRes.data.name
              });
            });
          }
        } catch (err) {
          console.error(`Erreur chargement classe ${classId}:`, err);
        }
      }

      setCourses(allCourses);
      setSubjects(Array.from(allSubjects));
      setStats({
        total: allCourses.length,
        subjects: allSubjects.size,
        teachers: allTeachers.size,
        lastUpdated: new Date()
      });

    } catch (err) {
      console.error('Erreur chargement cours:', err);
      toast.error('Erreur lors du chargement des cours');
    } finally {
      setLoading(false);
    }
  };

  const filterCourses = () => {
    let filtered = [...courses];

    // Filtrer par matière
    if (selectedSubject !== 'all') {
      filtered = filtered.filter(course => course.subject_name === selectedSubject);
    }

    // Filtrer par recherche
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = filtered.filter(course =>
        course.title.toLowerCase().includes(term) ||
        course.description.toLowerCase().includes(term) ||
        course.teacher_name?.toLowerCase().includes(term)
      );
    }

    setFilteredCourses(filtered);
  };

  const downloadFile = async (fileUrl, fileName) => {
    try {
      // Pour les démos, on simule juste le téléchargement
      const link = document.createElement('a');
      link.href = fileUrl;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      toast.success('Téléchargement démarré');
    } catch (err) {
      toast.error('Erreur lors du téléchargement');
    }
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Chargement de vos cours...</p>
      </div>
    );
  }

  return (
    <div className="student-courses-container">
      {/* En-tête */}
      <div className="courses-header">
        <div className="header-left">
          <button onClick={() => navigate('/student/dashboard')} className="back-btn">
            ? Retour
          </button>
          <h1>?? Mes Cours</h1>
          <p>Accédez à toutes vos ressources pédagogiques</p>
        </div>
        
        <div className="header-stats">
          <div className="stat-badge">
            <span className="stat-value">{stats.total}</span>
            <span className="stat-label">Cours</span>
          </div>
          <div className="stat-badge">
            <span className="stat-value">{stats.subjects}</span>
            <span className="stat-label">Matières</span>
          </div>
          <div className="stat-badge">
            <span className="stat-value">{stats.teachers}</span>
            <span className="stat-label">Enseignants</span>
          </div>
        </div>
      </div>

      {/* Filtres et recherche */}
      <div className="courses-controls">
        <div className="search-box">
          <input
            type="text"
            placeholder="?? Rechercher un cours, un enseignant..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
        
        <div className="filter-controls">
          <select
            value={selectedSubject}
            onChange={(e) => setSelectedSubject(e.target.value)}
            className="subject-filter"
          >
            <option value="all">Toutes les matières</option>
            {subjects.map((subject, index) => (
              <option key={index} value={subject}>{subject}</option>
            ))}
          </select>
          
          <button className="refresh-btn" onClick={loadData}>
            ?? Actualiser
          </button>
        </div>
      </div>

      {/* Résultats */}
      <div className="courses-content">
        {filteredCourses.length === 0 ? (
          <div className="empty-courses">
            <div className="empty-icon">??</div>
            <h2>Aucun cours trouvé</h2>
            <p>
              {searchTerm || selectedSubject !== 'all' 
                ? 'Aucun cours ne correspond à vos critères de recherche'
                : 'Vous n\'avez pas encore accès à des cours. Contactez votre administrateur.'}
            </p>
            {(searchTerm || selectedSubject !== 'all') && (
              <button
                onClick={() => {
                  setSearchTerm('');
                  setSelectedSubject('all');
                }}
                className="btn-clear-filters"
              >
                Effacer les filtres
              </button>
            )}
          </div>
        ) : (
          <>
            <div className="results-info">
              <span>{filteredCourses.length} cours trouvés</span>
              <div className="sort-controls">
                <span>Trier par:</span>
                <select>
                  <option>Date (plus récent)</option>
                  <option>Date (plus ancien)</option>
                  <option>Titre (A-Z)</option>
                  <option>Matière</option>
                </select>
              </div>
            </div>

            <div className="courses-grid">
              {filteredCourses.map(course => (
                <div key={course.id} className="course-card">
                  <div className="course-header">
                    <div className="course-subject">
                      <span className="subject-badge">{course.subject_name}</span>
                      <span className="class-badge">{course.class_name}</span>
                    </div>
                    <div className="course-actions">
                      <button
                        onClick={() => navigate(`/student/course/${course.id}`)}
                        className="btn-view"
                      >
                        ??? Voir
                      </button>
                    </div>
                  </div>
                  
                  <div className="course-body">
                    <h3 className="course-title">{course.title}</h3>
                    <p className="course-description">{course.description}</p>
                    
                    <div className="course-info">
                      <div className="info-item">
                        <span className="info-icon">?????</span>
                        <span className="info-text">{course.teacher_name || 'Enseignant'}</span>
                      </div>
                      <div className="info-item">
                        <span className="info-icon">??</span>
                        <span className="info-text">
                          Publié le {new Date(course.created_at).toLocaleDateString('fr-FR')}
                        </span>
                      </div>
                      <div className="info-item">
                        <span className="info-icon">??</span>
                        <span className="info-text">{course.files_count || 0} fichiers</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="course-footer">
                    <button
                      onClick={() => navigate(`/student/course/${course.id}`)}
                      className="btn-access"
                    >
                      Accéder au cours ?
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </>
        )}
      </div>

      {/* Aide et informations */}
      <div className="courses-help">
        <h3>?? Comment accéder aux cours ?</h3>
        <div className="help-steps">
          <div className="step">
            <div className="step-number">1</div>
            <div className="step-content">
              <h4>Cliquez sur "Voir"</h4>
              <p>Accédez aux détails d'un cours pour voir tous les fichiers</p>
            </div>
          </div>
          <div className="step">
            <div className="step-number">2</div>
            <div className="step-content">
              <h4>Téléchargez les ressources</h4>
              <p>Téléchargez les fichiers PDF, présentations et exercices</p>
            </div>
          </div>
          <div className="step">
            <div className="step-number">3</div>
            <div className="step-content">
              <h4>Organisez votre travail</h4>
              <p>Créez des dossiers sur votre ordinateur pour chaque matière</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}  StudentDashboard.jsx   // src/pages/student/StudentDashboard.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import api from '../../services/api';
import { toast } from 'react-toastify';
import {
  Container,
  Grid,
  Card,
  CardContent,
  CardActions,
  Typography,
  Button,
  Avatar,
  Chip,
  Box,
  LinearProgress,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
  Divider,
  IconButton,
  Paper,
  alpha,
  styled
} from '@mui/material';
import {
  School as SchoolIcon,
  Assignment as AssignmentIcon,
  Schedule as ScheduleIcon,
  VideoLibrary as VideoIcon,
  Notifications as NotificationsIcon,
  TrendingUp as TrendingUpIcon,
  People as PeopleIcon,
  Book as BookIcon,
  EmojiEvents as TrophyIcon,
  ArrowForward as ArrowForwardIcon,
  MoreVert as MoreVertIcon,
  CheckCircle as CheckCircleIcon,
  Announcement as AnnouncementIcon,
  AccessTime as AccessTimeIcon
} from '@mui/icons-material';

const StyledCard = styled(Card)(({ theme }) => ({
  borderRadius: '12px',
  height: '100%',
  transition: 'transform 0.2s, box-shadow 0.2s',
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: theme.shadows[8]
  }
}));

const QuickActionCard = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(3),
  textAlign: 'center',
  borderRadius: '12px',
  cursor: 'pointer',
  transition: 'all 0.2s',
  '&:hover': {
    backgroundColor: alpha(theme.palette.primary.main, 0.04),
    transform: 'scale(1.02)'
  }
}));

export default function StudentDashboard() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [dashboardData, setDashboardData] = useState({
    stats: {
      totalClasses: 0,
      activeCourses: 0,
      pendingAssignments: 0,
      averageGrade: 0,
      attendanceRate: 0,
      completedTests: 0
    },
    upcomingClasses: [],
    recentGrades: [],
    notifications: [],
    liveSessions: []
  });

  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    try {
      setLoading(true);
      
      // Récupérer les données de l'étudiant
      const [classesRes, gradesRes, notificationsRes] = await Promise.all([
        api.get('/classes/classes/'),
        api.get('/tests/scores/'),
        api.get('/notifications/?unread=true')
      ]);

      // Calculer les statistiques
      const studentClasses = classesRes.data.filter(cls => 
        cls.students?.some(s => s.id === user.id)
      );

      const stats = {
        totalClasses: studentClasses.length,
        activeCourses: studentClasses.reduce((sum, cls) => sum + (cls.subjects?.length || 0), 0),
        pendingAssignments: 3, // À implémenter
        averageGrade: 15.2,
        attendanceRate: 92,
        completedTests: gradesRes.data.length
      };

      // Données simulées pour les sessions à venir
      const upcomingClasses = [
        {
          id: 1,
          subject: 'Algorithmique',
          teacher: 'Dr. Smith',
          time: '10:00 - 12:00',
          room: 'Salle 101',
          type: 'Cours',
          color: '#2196F3'
        },
        {
          id: 2,
          subject: 'Base de Données',
          teacher: 'Prof. Johnson',
          time: '14:00 - 16:00',
          room: 'Lab 302',
          type: 'TP',
          color: '#4CAF50'
        }
      ];

      const recentGrades = [
        { subject: 'Algorithmique', grade: 16, max: 20, date: '2024-01-15', trend: 'up' },
        { subject: 'Programmation Web', grade: 18, max: 20, date: '2024-01-10', trend: 'up' },
        { subject: 'Mathématiques', grade: 14, max: 20, date: '2024-01-05', trend: 'stable' }
      ];

      setDashboardData({
        stats,
        upcomingClasses,
        recentGrades,
        notifications: notificationsRes.data,
        liveSessions: [] // À implémenter
      });

    } catch (error) {
      console.error('Erreur:', error);
      toast.error('Erreur lors du chargement du tableau de bord');
    } finally {
      setLoading(false);
    }
  };

  const getGradeColor = (percentage) => {
    if (percentage >= 80) return '#4CAF50';
    if (percentage >= 60) return '#FF9800';
    return '#F44336';
  };

  const quickActions = [
    {
      id: 1,
      title: 'Mes Cours',
      icon: <BookIcon fontSize="large" />,
      color: '#2196F3',
      path: '/student/courses'
    },
    {
      id: 2,
      title: 'Emploi du temps',
      icon: <ScheduleIcon fontSize="large" />,
      color: '#4CAF50',
      path: '/student/schedule'
    },
    {
      id: 3,
      title: 'Tests & Examens',
      icon: <AssignmentIcon fontSize="large" />,
      color: '#FF9800',
      path: '/student/tests'
    },
    {
      id: 4,
      title: 'Sessions Live',
      icon: <VideoIcon fontSize="large" />,
      color: '#9C27B0',
      path: '/student/live'
    }
  ];

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item>
            <Typography variant="h4" component="h1" fontWeight="600">
              ?? Bonjour, {user?.username} !
            </Typography>
            <Typography variant="body1" color="textSecondary">
              Voici votre tableau de bord étudiant
            </Typography>
          </Grid>
          <Grid item>
            <Chip
              icon={<SchoolIcon />}
              label={`Année 2024-2025`}
              color="primary"
              variant="outlined"
              sx={{ mr: 2 }}
            />
            <Button
              variant="outlined"
              startIcon={<NotificationsIcon />}
              onClick={() => navigate('/student/notifications')}
            >
              Notifications ({dashboardData.notifications.length})
            </Button>
          </Grid>
        </Grid>
      </Box>

      {/* Stats Grid */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Classes
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.totalClasses}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'primary.main' }}>
                  <SchoolIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={100}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>

        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Cours actifs
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.activeCourses}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'secondary.main' }}>
                  <BookIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={100}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>

        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Moyenne générale
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.averageGrade.toFixed(1)}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'success.main' }}>
                  <TrendingUpIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={dashboardData.stats.averageGrade * 5}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>

        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Présence
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.attendanceRate}%
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'info.main' }}>
                  <CheckCircleIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={dashboardData.stats.attendanceRate}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>

        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Devoirs en attente
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.pendingAssignments}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'warning.main' }}>
                  <AssignmentIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={dashboardData.stats.pendingAssignments * 20}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>

        <Grid item xs={12} sm={6} md={4} lg={2}>
          <StyledCard>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Tests terminés
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {dashboardData.stats.completedTests}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'error.main' }}>
                  <TrophyIcon />
                </Avatar>
              </Box>
              <LinearProgress
                variant="determinate"
                value={(dashboardData.stats.completedTests / 10) * 100}
                sx={{ mt: 2, height: 6, borderRadius: 3 }}
              />
            </CardContent>
          </StyledCard>
        </Grid>
      </Grid>

      {/* Quick Actions */}
      <Typography variant="h6" sx={{ mb: 3, fontWeight: 600 }}>
        ? Actions rapides
      </Typography>
      <Grid container spacing={3} sx={{ mb: 4 }}>
        {quickActions.map(action => (
          <Grid item xs={12} sm={6} md={3} key={action.id}>
            <QuickActionCard onClick={() => navigate(action.path)}>
              <Box sx={{ color: action.color, mb: 2 }}>
                {action.icon}
              </Box>
              <Typography variant="subtitle1" fontWeight="600">
                {action.title}
              </Typography>
            </QuickActionCard>
          </Grid>
        ))}
      </Grid>

      {/* Main Content */}
      <Grid container spacing={3}>
        {/* Prochaines classes */}
        <Grid item xs={12} md={6}>
          <StyledCard>
            <CardContent>
              <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
                <Typography variant="h6" fontWeight="600">
                  <AccessTimeIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                  Prochaines classes
                </Typography>
                <Button
                  size="small"
                  endIcon={<ArrowForwardIcon />}
                  onClick={() => navigate('/student/schedule')}
                >
                  Voir tout
                </Button>
              </Box>
              
              <List disablePadding>
                {dashboardData.upcomingClasses.map((cls, index) => (
                  <React.Fragment key={cls.id}>
                    <ListItem
                      alignItems="flex-start"
                      sx={{
                        '&:hover': { backgroundColor: 'action.hover' },
                        borderRadius: 1,
                        mb: 1
                      }}
                    >
                      <ListItemAvatar>
                        <Avatar sx={{ bgcolor: cls.color }}>
                          {cls.type === 'TP' ? <PeopleIcon /> : <SchoolIcon />}
                        </Avatar>
                      </ListItemAvatar>
                      <ListItemText
                        primary={
                          <Typography variant="subtitle1" fontWeight="600">
                            {cls.subject}
                          </Typography>
                        }
                        secondary={
                          <>
                            <Typography variant="body2" color="textSecondary">
                              ????? {cls.teacher} • ?? {cls.time}
                            </Typography>
                            <Box display="flex" alignItems="center" gap={1} mt={0.5}>
                              <Chip
                                label={cls.type}
                                size="small"
                                variant="outlined"
                                sx={{ height: 20 }}
                              />
                              <Chip
                                icon={<SchoolIcon fontSize="small" />}
                                label={cls.room}
                                size="small"
                                variant="outlined"
                                sx={{ height: 20 }}
                              />
                            </Box>
                          </>
                        }
                      />
                      <IconButton size="small">
                        <MoreVertIcon />
                      </IconButton>
                    </ListItem>
                    {index < dashboardData.upcomingClasses.length - 1 && <Divider />}
                  </React.Fragment>
                ))}
              </List>

              {dashboardData.upcomingClasses.length === 0 && (
                <Box textAlign="center" py={4}>
                  <ScheduleIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="body1" color="textSecondary">
                    Aucune classe à venir
                  </Typography>
                </Box>
              )}
            </CardContent>
          </StyledCard>
        </Grid>

        {/* Dernières notes */}
        <Grid item xs={12} md={6}>
          <StyledCard>
            <CardContent>
              <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
                <Typography variant="h6" fontWeight="600">
                  <TrendingUpIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                  Dernières notes
                </Typography>
                <Button
                  size="small"
                  endIcon={<ArrowForwardIcon />}
                  onClick={() => navigate('/student/grades')}
                >
                  Voir tout
                </Button>
              </Box>

              <List disablePadding>
                {dashboardData.recentGrades.map((grade, index) => {
                  const percentage = (grade.grade / grade.max) * 100;
                  return (
                    <React.Fragment key={index}>
                      <ListItem
                        alignItems="flex-start"
                        sx={{
                          '&:hover': { backgroundColor: 'action.hover' },
                          borderRadius: 1,
                          mb: 1
                        }}
                      >
                        <ListItemAvatar>
                          <Avatar sx={{ bgcolor: getGradeColor(percentage) }}>
                            {grade.trend === 'up' ? '??' : grade.trend === 'down' ? '??' : '??'}
                          </Avatar>
                        </ListItemAvatar>
                        <ListItemText
                          primary={
                            <Typography variant="subtitle1" fontWeight="600">
                              {grade.subject}
                            </Typography>
                          }
                          secondary={
                            <Typography variant="body2" color="textSecondary">
                              {new Date(grade.date).toLocaleDateString('fr-FR')}
                            </Typography>
                          }
                        />
                        <Box textAlign="right">
                          <Typography
                            variant="h5"
                            fontWeight="600"
                            color={getGradeColor(percentage)}
                          >
                            {grade.grade}/{grade.max}
                          </Typography>
                          <Typography variant="caption" color="textSecondary">
                            {percentage.toFixed(1)}%
                          </Typography>
                        </Box>
                      </ListItem>
                      {index < dashboardData.recentGrades.length - 1 && <Divider />}
                    </React.Fragment>
                  );
                })}
              </List>

              {dashboardData.recentGrades.length === 0 && (
                <Box textAlign="center" py={4}>
                  <AssignmentIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="body1" color="textSecondary">
                    Aucune note disponible
                  </Typography>
                </Box>
              )}
            </CardContent>
          </StyledCard>
        </Grid>

        {/* Notifications */}
        <Grid item xs={12}>
          <StyledCard>
            <CardContent>
              <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
                <Typography variant="h6" fontWeight="600">
                  <NotificationsIcon sx={{ mr: 1, verticalAlign: 'middle' }} />
                  Dernières notifications
                </Typography>
                <Button
                  size="small"
                  endIcon={<ArrowForwardIcon />}
                  onClick={() => navigate('/student/notifications')}
                >
                  Voir tout
                </Button>
              </Box>

              <Grid container spacing={2}>
                {dashboardData.notifications.slice(0, 4).map((notification, index) => (
                  <Grid item xs={12} sm={6} md={3} key={notification.id}>
                    <Paper
                      sx={{
                        p: 2,
                        borderRadius: 2,
                        borderLeft: '4px solid',
                        borderLeftColor: 'primary.main',
                        height: '100%'
                      }}
                    >
                      <Box display="flex" alignItems="flex-start" gap={1}>
                        <AnnouncementIcon color="primary" fontSize="small" />
                        <Box>
                          <Typography variant="subtitle2" fontWeight="600" gutterBottom>
                            {notification.title}
                          </Typography>
                          <Typography variant="body2" color="textSecondary">
                            {notification.message}
                          </Typography>
                          <Typography variant="caption" color="textSecondary" display="block" mt={1}>
                            {new Date(notification.created_at).toLocaleDateString('fr-FR')}
                          </Typography>
                        </Box>
                      </Box>
                    </Paper>
                  </Grid>
                ))}
              </Grid>

              {dashboardData.notifications.length === 0 && (
                <Box textAlign="center" py={4}>
                  <NotificationsIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
                  <Typography variant="body1" color="textSecondary">
                    Aucune notification
                  </Typography>
                </Box>
              )}
            </CardContent>
          </StyledCard>
        </Grid>
      </Grid>
    </Container>
  );
} StudentSchedule.jsx  // src/pages/student/StudentSchedule.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Box,
  LinearProgress,
  Tabs,
  Tab,
  Paper,
  Avatar,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  alpha,
  styled,
  useTheme,
  useMediaQuery
} from '@mui/material';
import {
  ArrowBack as ArrowBackIcon,
  Today as TodayIcon,
  CalendarMonth as CalendarMonthIcon,
  TableChart as TableChartIcon,
  Download as DownloadIcon,
  Print as PrintIcon,
  Share as ShareIcon,
  FilterList as FilterIcon,
  Refresh as RefreshIcon,
  AccessTime as TimeIcon,
  Room as RoomIcon,
  Person as PersonIcon,
  School as SchoolIcon,
  Notifications as NotificationsIcon,
  AddAlert as AddAlertIcon,
  ChevronLeft as ChevronLeftIcon,
  ChevronRight as ChevronRightIcon
} from '@mui/icons-material';
import { AdapterDateFns } from '@mui/x-date-pickers/AdapterDateFns';
import { LocalizationProvider, DatePicker } from '@mui/x-date-pickers';
import frLocale from 'date-fns/locale/fr';

const TimeSlotCard = styled(Paper)(({ theme, color }) => ({
  padding: theme.spacing(2),
  marginBottom: theme.spacing(1),
  borderRadius: '8px',
  borderLeft: '4px solid',
  borderLeftColor: color || theme.palette.primary.main,
  backgroundColor: alpha(color || theme.palette.primary.main, 0.05),
  transition: 'all 0.2s',
  '&:hover': {
    transform: 'translateX(4px)',
    boxShadow: theme.shadows[2]
  }
}));

const DayColumn = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(2),
  minHeight: '600px',
  borderRadius: '12px',
  backgroundColor: theme.palette.background.default
}));

export default function StudentSchedule() {
  const navigate = useNavigate();
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [schedule, setSchedule] = useState(null);
  const [timeSlots, setTimeSlots] = useState([]);
  const [filter, setFilter] = useState('all');
  const [openExport, setOpenExport] = useState(false);
  const [currentWeek, setCurrentWeek] = useState(0);

  useEffect(() => {
    loadSchedule();
  }, []);

  const loadSchedule = async () => {
    try {
      setLoading(true);
      // Récupérer l'emploi du temps de l'étudiant
      const res = await api.get('/schedule/schedules/student/my-schedule/');
      
      if (res.data) {
        setSchedule(res.data);
        setTimeSlots(res.data.time_slots || []);
        
        // Simuler des données si nécessaire
        if (res.data.time_slots?.length === 0) {
          const mockSlots = generateMockSchedule();
          setTimeSlots(mockSlots);
        }
      } else {
        // Générer un emploi du temps simulé
        const mockSlots = generateMockSchedule();
        setTimeSlots(mockSlots);
      }
    } catch (err) {
      console.error('Erreur:', err);
      // Générer des données simulées en cas d'erreur
      const mockSlots = generateMockSchedule();
      setTimeSlots(mockSlots);
    } finally {
      setLoading(false);
    }
  };

  const generateMockSchedule = () => {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const subjects = [
      { id: 1, name: 'Algorithmique', color: '#2196F3', teacher: 'Dr. Smith' },
      { id: 2, name: 'Base de Données', color: '#4CAF50', teacher: 'Prof. Johnson' },
      { id: 3, name: 'Programmation Web', color: '#FF9800', teacher: 'Dr. Williams' },
      { id: 4, name: 'Mathématiques', color: '#9C27B0', teacher: 'Prof. Martin' },
      { id: 5, name: 'Anglais', color: '#F44336', teacher: 'Mrs. Brown' }
    ];
    
    const timeSlots = [];
    const timeRanges = [
      ['08:30', '10:00'],
      ['10:15', '11:45'],
      ['13:00', '14:30'],
      ['14:45', '16:15']
    ];

    days.forEach(day => {
      timeRanges.forEach(([start, end], index) => {
        const subject = subjects[index % subjects.length];
        timeSlots.push({
          id: `${day}-${index}`,
          day: day,
          start_time: start,
          end_time: end,
          subject: subject.id,
          subject_name: subject.name,
          teacher_name: subject.teacher,
          classroom: `Salle ${Math.floor(Math.random() * 10) + 101}`,
          color: subject.color
        });
      });
    });

    return timeSlots;
  };

  const days = [
    { id: 'Monday', label: 'Lundi', short: 'Lun' },
    { id: 'Tuesday', label: 'Mardi', short: 'Mar' },
    { id: 'Wednesday', label: 'Mercredi', short: 'Mer' },
    { id: 'Thursday', label: 'Jeudi', short: 'Jeu' },
    { id: 'Friday', label: 'Vendredi', short: 'Ven' }
  ];

  const formatTime = (time) => {
    if (!time) return '';
    const [hours, minutes] = time.split(':');
    return `${hours}h${minutes}`;
  };

  const getDaySlots = (dayId) => {
    return timeSlots
      .filter(slot => slot.day === dayId)
      .sort((a, b) => a.start_time.localeCompare(b.start_time));
  };

  const getNextClass = () => {
    const now = new Date();
    const currentDay = days[now.getDay() === 0 ? 6 : now.getDay() - 1]; // Ajuster pour lundi=0
    const currentTime = now.getHours() * 100 + now.getMinutes();

    const upcomingSlots = timeSlots.filter(slot => {
      const slotTime = parseInt(slot.start_time.replace(':', ''));
      return slot.day === currentDay.id && slotTime > currentTime;
    });

    return upcomingSlots[0] || null;
  };

  const handleExport = () => {
    toast.success('Export de l\'emploi du temps');
    setOpenExport(false);
  };

  const nextClass = getNextClass();

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  return (
    <LocalizationProvider dateAdapter={AdapterDateFns} adapterLocale={frLocale}>
      <Container maxWidth="xl" sx={{ py: 4 }}>
        {/* Header */}
        <Box sx={{ mb: 4 }}>
          <Button
            startIcon={<ArrowBackIcon />}
            onClick={() => navigate('/student/dashboard')}
            sx={{ mb: 2 }}
          >
            Retour
          </Button>
          
          <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
            <Grid item>
              <Typography variant="h4" component="h1" fontWeight="600">
                ?? Mon Emploi du Temps
              </Typography>
              <Typography variant="body1" color="textSecondary">
                Consultez votre planning hebdomadaire
              </Typography>
            </Grid>
            <Grid item>
              <Box display="flex" gap={1}>
                <Button
                  variant="outlined"
                  startIcon={<DownloadIcon />}
                  onClick={() => setOpenExport(true)}
                >
                  Exporter
                </Button>
                <Button
                  variant="outlined"
                  startIcon={<PrintIcon />}
                  onClick={() => window.print()}
                >
                  Imprimer
                </Button>
                <Button
                  variant="contained"
                  startIcon={<ShareIcon />}
                  onClick={() => toast.info('Lien de partage copié')}
                >
                  Partager
                </Button>
              </Box>
            </Grid>
          </Grid>
        </Box>

        {/* Next Class Banner */}
        {nextClass && (
          <Card sx={{ mb: 4, bgcolor: 'primary.main', color: 'white' }}>
            <CardContent>
              <Grid container alignItems="center" spacing={2}>
                <Grid item xs={12} md={8}>
                  <Box display="flex" alignItems="center" gap={2}>
                    <NotificationsIcon fontSize="large" />
                    <Box>
                      <Typography variant="h6" fontWeight="600">
                        Prochain cours
                      </Typography>
                      <Typography variant="body1">
                        {nextClass.subject_name} avec {nextClass.teacher_name}
                      </Typography>
                      <Box display="flex" alignItems="center" gap={2} mt={1}>
                        <Chip
                          icon={<TimeIcon />}
                          label={`${formatTime(nextClass.start_time)} - ${formatTime(nextClass.end_time)}`}
                          size="small"
                          sx={{ background: 'rgba(255,255,255,0.2)', color: 'white' }}
                        />
                        <Chip
                          icon={<RoomIcon />}
                          label={nextClass.classroom}
                          size="small"
                          sx={{ background: 'rgba(255,255,255,0.2)', color: 'white' }}
                        />
                      </Box>
                    </Box>
                  </Box>
                </Grid>
                <Grid item xs={12} md={4} textAlign="right">
                  <Button
                    variant="contained"
                    startIcon={<AddAlertIcon />}
                    sx={{
                      background: 'white',
                      color: 'primary.main',
                      '&:hover': { background: 'rgba(255,255,255,0.9)' }
                    }}
                    onClick={() => toast.info('Rappel ajouté')}
                  >
                    Ajouter un rappel
                  </Button>
                </Grid>
              </Grid>
            </CardContent>
          </Card>
        )}

        {/* Controls */}
        <Card sx={{ mb: 4, p: 2 }}>
          <Grid container spacing={2} alignItems="center">
            <Grid item xs={12} md={4}>
              <Box display="flex" alignItems="center" gap={1}>
                <IconButton onClick={() => setCurrentWeek(currentWeek - 1)}>
                  <ChevronLeftIcon />
                </IconButton>
                <Typography variant="h6" fontWeight="600">
                  Semaine {currentWeek + 1}
                </Typography>
                <IconButton onClick={() => setCurrentWeek(currentWeek + 1)}>
                  <ChevronRightIcon />
                </IconButton>
              </Box>
            </Grid>
            <Grid item xs={12} md={4}>
              <FormControl fullWidth size="small">
                <InputLabel>Filtrer par matière</InputLabel>
                <Select
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                  label="Filtrer par matière"
                >
                  <MenuItem value="all">Toutes les matières</MenuItem>
                  {[...new Set(timeSlots.map(s => s.subject_name))].map(subject => (
                    <MenuItem key={subject} value={subject}>
                      {subject}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            <Grid item xs={12} md={4} textAlign="right">
              <Button
                startIcon={<RefreshIcon />}
                onClick={loadSchedule}
              >
                Actualiser
              </Button>
            </Grid>
          </Grid>
        </Card>

        {/* Schedule View */}
        {isMobile ? (
          // Mobile View
          <Box>
            <Tabs
              value={tabValue}
              onChange={(e, v) => setTabValue(v)}
              variant="scrollable"
              scrollButtons="auto"
              sx={{ mb: 3 }}
            >
              {days.map((day, index) => (
                <Tab
                  key={day.id}
                  label={
                    <Box textAlign="center">
                      <Typography variant="caption" display="block">
                        {day.short}
                      </Typography>
                      <Typography variant="body2" fontWeight="600">
                        {index + 1}
                      </Typography>
                    </Box>
                  }
                />
              ))}
            </Tabs>

            {days.map((day, index) => (
              tabValue === index && (
                <Card key={day.id} sx={{ mb: 2 }}>
                  <CardContent>
                    <Typography variant="h6" fontWeight="600" gutterBottom>
                      {day.label}
                    </Typography>
                    {getDaySlots(day.id).length > 0 ? (
                      getDaySlots(day.id).map(slot => (
                        <TimeSlotCard key={slot.id} color={slot.color}>
                          <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={1}>
                            <Typography variant="subtitle1" fontWeight="600">
                              {slot.subject_name}
                            </Typography>
                            <Chip
                              label={`${formatTime(slot.start_time)} - ${formatTime(slot.end_time)}`}
                              size="small"
                            />
                          </Box>
                          <Box display="flex" alignItems="center" gap={1} mb={1}>
                            <PersonIcon fontSize="small" color="action" />
                            <Typography variant="body2">
                              {slot.teacher_name}
                            </Typography>
                          </Box>
                          <Box display="flex" alignItems="center" gap={1}>
                            <RoomIcon fontSize="small" color="action" />
                            <Typography variant="body2">
                              {slot.classroom}
                            </Typography>
                          </Box>
                        </TimeSlotCard>
                      ))
                    ) : (
                      <Box textAlign="center" py={4}>
                        <Typography variant="body2" color="textSecondary">
                          Aucun cours ce jour
                        </Typography>
                      </Box>
                    )}
                  </CardContent>
                </Card>
              )
            ))}
          </Box>
        ) : (
          // Desktop View - Weekly Grid
          <Grid container spacing={2}>
            {days.map(day => (
              <Grid item xs={12} md={2.4} key={day.id}>
                <DayColumn>
                  <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
                    <Typography variant="h6" fontWeight="600" color="primary">
                      {day.label}
                    </Typography>
                    <Chip
                      label={getDaySlots(day.id).length}
                      size="small"
                      color="primary"
                    />
                  </Box>

                  {getDaySlots(day.id).length > 0 ? (
                    getDaySlots(day.id).map(slot => (
                      <TimeSlotCard key={slot.id} color={slot.color}>
                        <Box mb={1}>
                          <Typography variant="caption" color="textSecondary" display="block">
                            {formatTime(slot.start_time)} - {formatTime(slot.end_time)}
                          </Typography>
                          <Typography variant="subtitle2" fontWeight="600">
                            {slot.subject_name}
                          </Typography>
                        </Box>
                        <Box display="flex" alignItems="center" gap={1} mb={0.5}>
                          <PersonIcon fontSize="small" color="action" />
                          <Typography variant="caption">
                            {slot.teacher_name}
                          </Typography>
                        </Box>
                        <Box display="flex" alignItems="center" gap={1}>
                          <RoomIcon fontSize="small" color="action" />
                          <Typography variant="caption">
                            {slot.classroom}
                          </Typography>
                        </Box>
                      </TimeSlotCard>
                    ))
                  ) : (
                    <Box textAlign="center" py={4}>
                      <Typography variant="body2" color="textSecondary">
                        Aucun cours
                      </Typography>
                    </Box>
                  )}
                </DayColumn>
              </Grid>
            ))}
          </Grid>
        )}

        {/* Stats */}
        <Grid container spacing={3} sx={{ mt: 4 }}>
          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box display="flex" alignItems="center" justifyContent="space-between">
                  <Box>
                    <Typography color="textSecondary" variant="body2">
                      Cours cette semaine
                    </Typography>
                    <Typography variant="h4" fontWeight="600">
                      {timeSlots.length}
                    </Typography>
                  </Box>
                  <Avatar sx={{ bgcolor: 'primary.main' }}>
                    <SchoolIcon />
                  </Avatar>
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box display="flex" alignItems="center" justifyContent="space-between">
                  <Box>
                    <Typography color="textSecondary" variant="body2">
                      Heures de cours
                    </Typography>
                    <Typography variant="h4" fontWeight="600">
                      {timeSlots.length * 1.5}h
                    </Typography>
                  </Box>
                  <Avatar sx={{ bgcolor: 'secondary.main' }}>
                    <TimeIcon />
                  </Avatar>
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box display="flex" alignItems="center" justifyContent="space-between">
                  <Box>
                    <Typography color="textSecondary" variant="body2">
                      Matières différentes
                    </Typography>
                    <Typography variant="h4" fontWeight="600">
                      {new Set(timeSlots.map(s => s.subject_name)).size}
                    </Typography>
                  </Box>
                  <Avatar sx={{ bgcolor: 'success.main' }}>
                    <BookIcon />
                  </Avatar>
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Card>
              <CardContent>
                <Box display="flex" alignItems="center" justifyContent="space-between">
                  <Box>
                    <Typography color="textSecondary" variant="body2">
                      Taux de présence
                    </Typography>
                    <Typography variant="h4" fontWeight="600">
                      92%
                    </Typography>
                  </Box>
                  <Avatar sx={{ bgcolor: 'warning.main' }}>
                    <CheckCircleIcon />
                  </Avatar>
                </Box>
              </CardContent>
            </Card>
          </Grid>
        </Grid>

        {/* Export Dialog */}
        <Dialog open={openExport} onClose={() => setOpenExport(false)} maxWidth="sm" fullWidth>
          <DialogTitle>Exporter l'emploi du temps</DialogTitle>
          <DialogContent>
            <Grid container spacing={2} sx={{ mt: 1 }}>
              <Grid item xs={12}>
                <FormControl fullWidth>
                  <InputLabel>Format</InputLabel>
                  <Select label="Format" defaultValue="pdf">
                    <MenuItem value="pdf">PDF</MenuItem>
                    <MenuItem value="excel">Excel</MenuItem>
                    <MenuItem value="image">Image</MenuItem>
                    <MenuItem value="calendar">Calendrier (ICS)</MenuItem>
                  </Select>
                </FormControl>
              </Grid>
              <Grid item xs={12}>
                <DatePicker
                  label="Date de début"
                  value={selectedDate}
                  onChange={(newValue) => setSelectedDate(newValue)}
                  slotProps={{ textField: { fullWidth: true } }}
                />
              </Grid>
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  label="Période (semaines)"
                  type="number"
                  defaultValue={1}
                  InputProps={{ inputProps: { min: 1, max: 52 } }}
                />
              </Grid>
            </Grid>
          </DialogContent>
          <DialogActions>
            <Button onClick={() => setOpenExport(false)}>Annuler</Button>
            <Button onClick={handleExport} variant="contained">
              Exporter
            </Button>
          </DialogActions>
        </Dialog>
      </Container>
    </LocalizationProvider>
  );
}   StudentSubjectDetails.jsx  // src/pages/student/StudentSubjectDetails.jsx
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate, useLocation } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Box,
  LinearProgress,
  Tabs,
  Tab,
  Avatar,
  IconButton,
  Paper,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
  Divider,
  TextField,
  InputAdornment,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Rating,
  alpha,
  styled,
  Breadcrumbs,
  Link
} from '@mui/material';
import {
  ArrowBack as ArrowBackIcon,
  Book as BookIcon,
  Assignment as AssignmentIcon,
  VideoLibrary as VideoIcon,
  Download as DownloadIcon,
  Visibility as ViewIcon,
  AccessTime as TimeIcon,
  Person as PersonIcon,
  School as SchoolIcon,
  Folder as FolderIcon,
  Article as ArticleIcon,
  Quiz as QuizIcon,
  EmojiEvents as TrophyIcon,
  CalendarToday as CalendarIcon,
  Search as SearchIcon,
  FilterList as FilterIcon,
  Share as ShareIcon,
  Bookmark as BookmarkIcon,
  MoreVert as MoreVertIcon,
  NavigateNext as NavigateNextIcon
} from '@mui/icons-material';

const ResourceCard = styled(Paper)(({ theme }) => ({
  padding: theme.spacing(3),
  borderRadius: '12px',
  height: '100%',
  cursor: 'pointer',
  transition: 'all 0.2s',
  border: '1px solid',
  borderColor: theme.palette.divider,
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: theme.shadows[8],
    borderColor: theme.palette.primary.main
  }
}));

const TestCard = styled(Paper)(({ theme, status }) => ({
  padding: theme.spacing(3),
  borderRadius: '12px',
  borderLeft: '4px solid',
  borderLeftColor: status === 'active' ? '#4CAF50' : 
                  status === 'upcoming' ? '#2196F3' : 
                  status === 'ended' ? '#9E9E9E' : '#FF9800',
  transition: 'all 0.2s',
  '&:hover': {
    transform: 'translateY(-2px)',
    boxShadow: theme.shadows[4]
  }
}));

export default function StudentSubjectDetails() {
  const { id } = useParams();
  const navigate = useNavigate();
  const location = useLocation();
  const [subject, setSubject] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [resources, setResources] = useState([]);
  const [tests, setTests] = useState([]);
  const [grades, setGrades] = useState([]);
  const [openResource, setOpenResource] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');

  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const tab = params.get('tab');
    if (tab === 'courses') setTabValue(1);
    if (tab === 'tests') setTabValue(2);
    if (tab === 'grades') setTabValue(3);

    loadSubjectData();
  }, [id, location]);

  const loadSubjectData = async () => {
    try {
      setLoading(true);
      const [subjectRes, coursesRes, testsRes] = await Promise.all([
        api.get(`/classes/subjects/${id}/`),
        api.get('/courses/courses/', { params: { subject: id } }),
        api.get('/tests/quizzes/', { params: { subject: id } })
      ]);

      setSubject(subjectRes.data);
      
      // Préparer les ressources
      const resourcesData = [];
      coursesRes.data.forEach(course => {
        resourcesData.push({
          id: course.id,
          type: 'course',
          title: course.title,
          description: course.description,
          teacher: course.teacher_name,
          date: course.created_at,
          files: 3,
          icon: <BookIcon />
        });
      });

      // Ajouter des ressources simulées
      resourcesData.push(
        {
          id: 101,
          type: 'pdf',
          title: 'Guide d\'étude - Algorithmes',
          description: 'Document complet sur les algorithmes de base',
          teacher: 'Dr. Smith',
          date: '2024-01-20',
          files: 1,
          icon: <ArticleIcon />
        },
        {
          id: 102,
          type: 'video',
          title: 'Vidéo - Introduction aux structures de données',
          description: 'Tutoriel vidéo explicatif',
          teacher: 'Dr. Smith',
          date: '2024-01-18',
          duration: '45:23',
          icon: <VideoIcon />
        }
      );

      setResources(resourcesData);
      setTests(testsRes.data);

      // Notes simulées
      setGrades([
        { test: 'Quiz 1 - Algorithmes', score: 16, max: 20, date: '2024-01-15', rank: 5 },
        { test: 'TP - Structures de données', score: 18, max: 20, date: '2024-01-10', rank: 2 },
        { test: 'Examen partiel', score: 14, max: 20, date: '2024-01-05', rank: 12 }
      ]);

    } catch (err) {
      console.error('Erreur:', err);
      toast.error('Erreur de chargement de la matière');
      navigate('/student/dashboard');
    } finally {
      setLoading(false);
    }
  };

  const handleDownload = (resource) => {
    toast.success(`Téléchargement de "${resource.title}"`);
    // Implémenter le téléchargement réel
  };

  const handleView = (resource) => {
    setOpenResource(resource);
  };

  const handleStartTest = (test) => {
    if (test.status === 'active') {
      navigate(`/student/take-test/${test.id}`);
    } else {
      toast.info(`Le test "${test.title}" n'est pas encore disponible`);
    }
  };

  const filteredResources = resources.filter(resource =>
    resource.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
    resource.description.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const getTestStatus = (test) => {
    const now = new Date();
    const start = new Date(test.start_time);
    const end = new Date(test.end_time);
    
    if (now < start) return 'upcoming';
    if (now > end) return 'ended';
    return 'active';
  };

  const getStatusLabel = (status) => {
    switch (status) {
      case 'active': return { label: 'Actif', color: 'success' };
      case 'upcoming': return { label: 'À venir', color: 'info' };
      case 'ended': return { label: 'Terminé', color: 'default' };
      default: return { label: 'Inconnu', color: 'default' };
    }
  };

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  if (!subject) {
    return (
      <Container maxWidth="xl" sx={{ py: 4, textAlign: 'center' }}>
        <Typography variant="h5" color="textSecondary">
          Matière introuvable
        </Typography>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/student/dashboard')}
          sx={{ mt: 2 }}
        >
          Retour au tableau de bord
        </Button>
      </Container>
    );
  }

  const tabs = [
    { label: 'Aperçu', icon: <BookIcon /> },
    { label: 'Ressources', icon: <FolderIcon />, count: resources.length },
    { label: 'Tests & Examens', icon: <QuizIcon />, count: tests.length },
    { label: 'Mes notes', icon: <TrophyIcon />, count: grades.length },
    { label: 'Calendrier', icon: <CalendarIcon /> }
  ];

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Breadcrumbs */}
      <Breadcrumbs separator={<NavigateNextIcon fontSize="small" />} sx={{ mb: 3 }}>
        <Link
          color="inherit"
          onClick={() => navigate('/student/dashboard')}
          sx={{ cursor: 'pointer' }}
        >
          Tableau de bord
        </Link>
        <Link
          color="inherit"
          onClick={() => navigate(`/student/class/${subject.class_assigned}`)}
          sx={{ cursor: 'pointer' }}
        >
          {subject.class_name}
        </Link>
        <Typography color="text.primary">{subject.name}</Typography>
      </Breadcrumbs>

      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item xs={12} md={8}>
            <Box display="flex" alignItems="center" gap={2} mb={2}>
              <Avatar sx={{ bgcolor: 'primary.main', width: 64, height: 64 }}>
                <BookIcon fontSize="large" />
              </Avatar>
              <Box>
                <Typography variant="h4" component="h1" fontWeight="600">
                  {subject.name}
                </Typography>
                <Box display="flex" alignItems="center" gap={2} mt={1}>
                  {subject.teacher_name && (
                    <Chip
                      icon={<PersonIcon />}
                      label={subject.teacher_name}
                      size="small"
                      variant="outlined"
                    />
                  )}
                  {subject.specialty_name && (
                    <Chip
                      icon={<SchoolIcon />}
                      label={subject.specialty_name}
                      size="small"
                      variant="outlined"
                    />
                  )}
                  <Chip
                    icon={<SchoolIcon />}
                    label={subject.class_name}
                    size="small"
                    variant="outlined"
                  />
                </Box>
              </Box>
            </Box>
          </Grid>
          <Grid item xs={12} md={4} textAlign="right">
            <Box display="flex" gap={1} justifyContent={{ xs: 'flex-start', md: 'flex-end' }}>
              <Button
                variant="outlined"
                startIcon={<BookmarkIcon />}
                onClick={() => toast.info('Matière ajoutée aux favoris')}
              >
                Favoris
              </Button>
              <Button
                variant="contained"
                startIcon={<ShareIcon />}
                onClick={() => toast.info('Lien de partage copié')}
              >
                Partager
              </Button>
            </Box>
          </Grid>
        </Grid>
      </Box>

      {/* Stats Cards */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Ressources
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {resources.length}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'primary.main' }}>
                  <FolderIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Tests disponibles
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {tests.filter(t => getTestStatus(t) === 'active').length}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'secondary.main' }}>
                  <QuizIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Moyenne
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {grades.length > 0 
                      ? (grades.reduce((sum, g) => sum + (g.score / g.max * 20), 0) / grades.length).toFixed(1)
                      : '0.0'
                    }
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'success.main' }}>
                  <TrophyIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={3}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Progression
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    68%
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'warning.main' }}>
                  <TrendingUpIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 4 }}>
        <Tabs
          value={tabValue}
          onChange={(e, v) => setTabValue(v)}
          variant="scrollable"
          scrollButtons="auto"
        >
          {tabs.map((tab, index) => (
            <Tab
              key={index}
              icon={tab.icon}
              iconPosition="start"
              label={
                <Box display="flex" alignItems="center" gap={1}>
                  {tab.label}
                  {tab.count !== undefined && (
                    <Chip label={tab.count} size="small" />
                  )}
                </Box>
              }
            />
          ))}
        </Tabs>
      </Box>

      {/* Overview Tab */}
      {tabValue === 0 && (
        <Grid container spacing={3}>
          <Grid item xs={12} md={8}>
            <Card>
              <CardContent>
                <Typography variant="h6" fontWeight="600" gutterBottom>
                  ?? Description
                </Typography>
                <Typography paragraph>
                  Bienvenue dans le cours de {subject.name}. Cette matière couvre les concepts fondamentaux 
                  et avancés nécessaires pour maîtriser le domaine. Vous trouverez ici toutes les ressources 
                  nécessaires pour votre apprentissage.
                </Typography>
                
                <Typography variant="h6" fontWeight="600" gutterBottom sx={{ mt: 4 }}>
                  ?? Prochaines échéances
                </Typography>
                <List disablePadding>
                  {tests.slice(0, 3).map((test, index) => (
                    <React.Fragment key={test.id}>
                      <ListItem
                        sx={{
                          '&:hover': { backgroundColor: 'action.hover' },
                          borderRadius: 1
                        }}
                        secondaryAction={
                          <Chip
                            label={getStatusLabel(getTestStatus(test)).label}
                            size="small"
                            color={getStatusLabel(getTestStatus(test)).color}
                          />
                        }
                      >
                        <ListItemAvatar>
                          <Avatar sx={{ bgcolor: 'primary.main' }}>
                            <QuizIcon />
                          </Avatar>
                        </ListItemAvatar>
                        <ListItemText
                          primary={
                            <Typography variant="subtitle1" fontWeight="600">
                              {test.title}
                            </Typography>
                          }
                          secondary={
                            <Typography variant="body2" color="textSecondary">
                              <TimeIcon fontSize="small" sx={{ verticalAlign: 'middle', mr: 0.5 }} />
                              {new Date(test.start_time).toLocaleDateString('fr-FR')} • 
                              Durée: {test.duration} min
                            </Typography>
                          }
                        />
                      </ListItem>
                      {index < 2 && <Divider />}
                    </React.Fragment>
                  ))}
                </List>
              </CardContent>
            </Card>
          </Grid>
          
          <Grid item xs={12} md={4}>
            <Card>
              <CardContent>
                <Typography variant="h6" fontWeight="600" gutterBottom>
                  ????? Enseignant
                </Typography>
                <Box display="flex" alignItems="center" gap={2} mb={3}>
                  <Avatar sx={{ width: 64, height: 64 }}>
                    {subject.teacher_name?.charAt(0) || 'P'}
                  </Avatar>
                  <Box>
                    <Typography variant="subtitle1" fontWeight="600">
                      {subject.teacher_name || 'Non assigné'}
                    </Typography>
                    <Typography variant="body2" color="textSecondary">
                      Professeur de {subject.name}
                    </Typography>
                  </Box>
                </Box>
                
                <Button
                  fullWidth
                  variant="outlined"
                  startIcon={<ChatIcon />}
                  onClick={() => toast.info('Ouverture du chat')}
                  sx={{ mb: 2 }}
                >
                  Contacter
                </Button>
                
                <Typography variant="h6" fontWeight="600" gutterBottom sx={{ mt: 4 }}>
                  ?? Mes stats
                </Typography>
                <Box>
                  <Box display="flex" justifyContent="space-between" mb={1}>
                    <Typography variant="body2">Progression</Typography>
                    <Typography variant="body2" fontWeight="600">68%</Typography>
                  </Box>
                  <LinearProgress variant="determinate" value={68} sx={{ height: 8, borderRadius: 4 }} />
                  
                  <Box display="flex" justifyContent="space-between" mt={3} mb={1}>
                    <Typography variant="body2">Temps passé</Typography>
                    <Typography variant="body2" fontWeight="600">24h 30m</Typography>
                  </Box>
                  <LinearProgress variant="determinate" value={75} sx={{ height: 8, borderRadius: 4 }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
        </Grid>
      )}

      {/* Resources Tab */}
      {tabValue === 1 && (
        <>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={4}>
            <Typography variant="h6" fontWeight="600">
              ?? Ressources ({resources.length})
            </Typography>
            <Box display="flex" gap={1}>
              <TextField
                size="small"
                placeholder="Rechercher une ressource..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <SearchIcon />
                    </InputAdornment>
                  )
                }}
                sx={{ width: 300 }}
              />
              <Button startIcon={<FilterIcon />} size="small">
                Filtrer
              </Button>
            </Box>
          </Box>

          <Grid container spacing={3}>
            {filteredResources.map(resource => (
              <Grid item xs={12} sm={6} md={4} key={resource.id}>
                <ResourceCard>
                  <Box display="flex" alignItems="flex-start" justifyContent="space-between" mb={2}>
                    <Avatar sx={{ bgcolor: 'primary.main' }}>
                      {resource.icon}
                    </Avatar>
                    <IconButton size="small">
                      <MoreVertIcon />
                    </IconButton>
                  </Box>
                  
                  <Typography variant="h6" fontWeight="600" gutterBottom>
                    {resource.title}
                  </Typography>
                  
                  <Typography variant="body2" color="textSecondary" paragraph sx={{ mb: 2 }}>
                    {resource.description}
                  </Typography>
                  
                  <Box display="flex" alignItems="center" gap={1} mb={3}>
                    <PersonIcon fontSize="small" color="action" />
                    <Typography variant="caption">
                      {resource.teacher}
                    </Typography>
                    <Typography variant="caption" color="textSecondary" sx={{ ml: 'auto' }}>
                      {new Date(resource.date).toLocaleDateString('fr-FR')}
                    </Typography>
                  </Box>
                  
                  <Box display="flex" justifyContent="space-between">
                    <Button
                      size="small"
                      startIcon={<ViewIcon />}
                      onClick={() => handleView(resource)}
                    >
                      Voir
                    </Button>
                    <Button
                      size="small"
                      startIcon={<DownloadIcon />}
                      onClick={() => handleDownload(resource)}
                    >
                      Télécharger
                    </Button>
                  </Box>
                </ResourceCard>
              </Grid>
            ))}
          </Grid>
        </>
      )}

      {/* Tests Tab */}
      {tabValue === 2 && (
        <>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={4}>
            <Typography variant="h6" fontWeight="600">
              ?? Tests & Examens ({tests.length})
            </Typography>
            <Button
              variant="outlined"
              startIcon={<CalendarIcon />}
              onClick={() => toast.info('Calendrier des tests')}
            >
              Calendrier
            </Button>
          </Box>

          <Grid container spacing={3}>
            {tests.map(test => {
              const status = getTestStatus(test);
              const statusInfo = getStatusLabel(status);
              
              return (
                <Grid item xs={12} key={test.id}>
                  <TestCard status={status}>
                    <Grid container alignItems="center" spacing={2}>
                      <Grid item xs={12} md={8}>
                        <Box display="flex" alignItems="center" gap={2} mb={1}>
                          <Typography variant="h6" fontWeight="600">
                            {test.title}
                          </Typography>
                          <Chip
                            label={statusInfo.label}
                            size="small"
                            color={statusInfo.color}
                          />
                        </Box>
                        
                        <Typography variant="body2" color="textSecondary" paragraph>
                          {test.description || 'Aucune description'}
                        </Typography>
                        
                        <Box display="flex" gap={3} flexWrap="wrap">
                          <Box display="flex" alignItems="center" gap={0.5}>
                            <TimeIcon fontSize="small" color="action" />
                            <Typography variant="body2">
                              Durée: {test.duration} min
                            </Typography>
                          </Box>
                          <Box display="flex" alignItems="center" gap={0.5}>
                            <AssignmentIcon fontSize="small" color="action" />
                            <Typography variant="body2">
                              Total: {test.total_marks} points
                            </Typography>
                          </Box>
                          <Box display="flex" alignItems="center" gap={0.5}>
                            <SchoolIcon fontSize="small" color="action" />
                            <Typography variant="body2">
                              Passage: {test.passing_marks} points
                            </Typography>
                          </Box>
                        </Box>
                      </Grid>
                      
                      <Grid item xs={12} md={4} textAlign="right">
                        <Box mb={2}>
                          <Typography variant="caption" color="textSecondary" display="block">
                            Début
                          </Typography>
                          <Typography variant="body2" fontWeight="600">
                            {new Date(test.start_time).toLocaleDateString('fr-FR')}
                          </Typography>
                          <Typography variant="caption" color="textSecondary" display="block" mt={1}>
                            Fin
                          </Typography>
                          <Typography variant="body2" fontWeight="600">
                            {new Date(test.end_time).toLocaleDateString('fr-FR')}
                          </Typography>
                        </Box>
                        
                        <Button
                          variant={status === 'active' ? 'contained' : 'outlined'}
                          fullWidth
                          onClick={() => handleStartTest(test)}
                          disabled={status !== 'active'}
                        >
                          {status === 'active' ? 'Commencer' : 
                           status === 'upcoming' ? 'À venir' : 'Terminé'}
                        </Button>
                      </Grid>
                    </Grid>
                  </TestCard>
                </Grid>
              );
            })}
          </Grid>
        </>
      )}

      {/* Grades Tab */}
      {tabValue === 3 && (
        <>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={4}>
            <Typography variant="h6" fontWeight="600">
              ?? Mes notes ({grades.length})
            </Typography>
            <Button
              variant="outlined"
              startIcon={<DownloadIcon />}
              onClick={() => toast.info('Export des notes')}
            >
              Exporter
            </Button>
          </Box>

          <Card>
            <CardContent>
              <TableContainer>
                <Table>
                  <TableHead>
                    <TableRow>
                      <TableCell>Test</TableCell>
                      <TableCell align="right">Note</TableCell>
                      <TableCell align="right">Sur</TableCell>
                      <TableCell align="right">Pourcentage</TableCell>
                      <TableCell align="right">Classement</TableCell>
                      <TableCell align="right">Date</TableCell>
                      <TableCell align="right">Actions</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {grades.map((grade, index) => {
                      const percentage = (grade.score / grade.max) * 100;
                      return (
                        <TableRow key={index} hover>
                          <TableCell>
                            <Typography variant="subtitle2" fontWeight="600">
                              {grade.test}
                            </Typography>
                          </TableCell>
                          <TableCell align="right">
                            <Typography
                              variant="subtitle1"
                              fontWeight="600"
                              color={percentage >= 80 ? 'success.main' : 
                                     percentage >= 60 ? 'warning.main' : 'error.main'}
                            >
                              {grade.score}
                            </Typography>
                          </TableCell>
                          <TableCell align="right">
                            <Typography variant="body2">
                              {grade.max}
                            </Typography>
                          </TableCell>
                          <TableCell align="right">
                            <Chip
                              label={`${percentage.toFixed(1)}%`}
                              size="small"
                              color={percentage >= 80 ? 'success' : 
                                     percentage >= 60 ? 'warning' : 'error'}
                            />
                          </TableCell>
                          <TableCell align="right">
                            <Box display="flex" alignItems="center" justifyContent="flex-end" gap={1}>
                              <TrophyIcon fontSize="small" color="action" />
                              <Typography variant="body2">
                                {grade.rank}ème
                              </Typography>
                            </Box>
                          </TableCell>
                          <TableCell align="right">
                            <Typography variant="body2">
                              {new Date(grade.date).toLocaleDateString('fr-FR')}
                            </Typography>
                          </TableCell>
                          <TableCell align="right">
                            <IconButton size="small">
                              <ViewIcon />
                            </IconButton>
                          </TableCell>
                        </TableRow>
                      );
                    })}
                  </TableBody>
                </Table>
              </TableContainer>
            </CardContent>
          </Card>

          {/* Stats Summary */}
          <Grid container spacing={3} sx={{ mt: 2 }}>
            <Grid item xs={12} md={4}>
              <Card>
                <CardContent>
                  <Typography variant="h6" fontWeight="600" gutterBottom>
                    ?? Performance
                  </Typography>
                  <Box textAlign="center" py={3}>
                    <Typography variant="h2" fontWeight="600" color="primary.main">
                      {grades.length > 0 
                        ? (grades.reduce((sum, g) => sum + (g.score / g.max * 20), 0) / grades.length).toFixed(1)
                        : '0.0'
                      }
                    </Typography>
                    <Typography variant="body2" color="textSecondary">
                      Moyenne générale /20
                    </Typography>
                  </Box>
                </CardContent>
              </Card>
            </Grid>
            
            <Grid item xs={12} md={8}>
              <Card>
                <CardContent>
                  <Typography variant="h6" fontWeight="600" gutterBottom>
                    ?? Évolution
                  </Typography>
                  <Box height={200} display="flex" alignItems="flex-end" gap={1} mt={3}>
                    {grades.map((grade, index) => {
                      const percentage = (grade.score / grade.max) * 100;
                      return (
                        <Box key={index} flex={1} textAlign="center">
                          <Box
                            sx={{
                              height: `${percentage}px`,
                              bgcolor: percentage >= 80 ? 'success.main' : 
                                       percentage >= 60 ? 'warning.main' : 'error.main',
                              borderRadius: 1,
                              mx: 'auto',
                              width: '80%'
                            }}
                          />
                          <Typography variant="caption" display="block" mt={1}>
                            Test {index + 1}
                          </Typography>
                        </Box>
                      );
                    })}
                  </Box>
                </CardContent>
              </Card>
            </Grid>
          </Grid>
        </>
      )}

      {/* Resource View Dialog */}
      <Dialog
        open={!!openResource}
        onClose={() => setOpenResource(null)}
        maxWidth="md"
        fullWidth
      >
        {openResource && (
          <>
            <DialogTitle>
              <Box display="flex" alignItems="center" gap={1}>
                {openResource.icon}
                {openResource.title}
              </Box>
            </DialogTitle>
            <DialogContent>
              <Typography paragraph>
                {openResource.description}
              </Typography>
              <Box mt={2}>
                <Typography variant="subtitle2" gutterBottom>
                  Détails:
                </Typography>
                <List dense>
                  <ListItem>
                    <ListItemText
                      primary="Enseignant"
                      secondary={openResource.teacher}
                    />
                  </ListItem>
                  <ListItem>
                    <ListItemText
                      primary="Date de publication"
                      secondary={new Date(openResource.date).toLocaleDateString('fr-FR')}
                    />
                  </ListItem>
                  {openResource.files && (
                    <ListItem>
                      <ListItemText
                        primary="Nombre de fichiers"
                        secondary={openResource.files}
                      />
                    </ListItem>
                  )}
                </List>
              </Box>
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setOpenResource(null)}>Fermer</Button>
              <Button
                variant="contained"
                startIcon={<DownloadIcon />}
                onClick={() => {
                  handleDownload(openResource);
                  setOpenResource(null);
                }}
              >
                Télécharger
              </Button>
            </DialogActions>
          </>
        )}
      </Dialog>
    </Container>
  );
}StudentTests.jsx  // src/pages/student/StudentTests.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import {
  Container,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Box,
  LinearProgress,
  Tabs,
  Tab,
  Avatar,
  IconButton,
  Paper,
  List,
  ListItem,
  ListItemAvatar,
  ListItemText,
  Divider,
  TextField,
  InputAdornment,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Rating,
  alpha,
  styled,
  CircularProgress
} from '@mui/material';
import {
  ArrowBack as ArrowBackIcon,
  Quiz as QuizIcon,
  Assignment as AssignmentIcon,
  EmojiEvents as TrophyIcon,
  AccessTime as TimeIcon,
  TrendingUp as TrendingUpIcon,
  FilterList as FilterIcon,
  Search as SearchIcon,
  PlayArrow as PlayArrowIcon,
  Visibility as ViewIcon,
  Download as DownloadIcon,
  MoreVert as MoreVertIcon,
  CheckCircle as CheckCircleIcon,
  Error as ErrorIcon,
  Schedule as ScheduleIcon,
  BarChart as BarChartIcon,
  People as PeopleIcon
} from '@mui/icons-material';

const TestCard = styled(Paper)(({ theme, status }) => ({
  padding: theme.spacing(3),
  borderRadius: '12px',
  height: '100%',
  border: '2px solid',
  borderColor: status === 'active' ? theme.palette.success.main :
               status === 'upcoming' ? theme.palette.info.main :
               status === 'ended' ? theme.palette.grey[400] :
               theme.palette.warning.main,
  transition: 'all 0.2s',
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: theme.shadows[8],
    backgroundColor: alpha(
      status === 'active' ? theme.palette.success.main :
      status === 'upcoming' ? theme.palette.info.main :
      status === 'ended' ? theme.palette.grey[400] :
      theme.palette.warning.main,
      0.02
    )
  }
}));

const ProgressCircle = styled(CircularProgress)(({ theme, value }) => ({
  color: value >= 80 ? theme.palette.success.main :
         value >= 60 ? theme.palette.warning.main :
         theme.palette.error.main
}));

export default function StudentTests() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [tabValue, setTabValue] = useState(0);
  const [tests, setTests] = useState([]);
  const [results, setResults] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filter, setFilter] = useState('all');
  const [selectedTest, setSelectedTest] = useState(null);
  const [openDetails, setOpenDetails] = useState(false);

  useEffect(() => {
    loadTests();
    loadResults();
  }, []);

  const loadTests = async () => {
    try {
      setLoading(true);
      const res = await api.get('/tests/quizzes/');
      
      // Simuler des données si nécessaire
      if (res.data.length === 0) {
        const mockTests = generateMockTests();
        setTests(mockTests);
      } else {
        setTests(res.data);
      }
    } catch (err) {
      console.error('Erreur:', err);
      const mockTests = generateMockTests();
      setTests(mockTests);
    } finally {
      setLoading(false);
    }
  };

  const loadResults = async () => {
    try {
      const res = await api.get('/tests/scores/');
      if (res.data.length === 0) {
        const mockResults = generateMockResults();
        setResults(mockResults);
      } else {
        setResults(res.data);
      }
    } catch (err) {
      console.error('Erreur résultats:', err);
      const mockResults = generateMockResults();
      setResults(mockResults);
    }
  };

  const generateMockTests = () => {
    const now = new Date();
    return [
      {
        id: 1,
        title: 'Quiz Algorithmique - Chapitre 1',
        subject: 'Algorithmique',
        teacher: 'Dr. Smith',
        type: 'quiz',
        duration: 45,
        total_marks: 20,
        passing_marks: 10,
        start_time: new Date(now.getTime() + 86400000).toISOString(), // Demain
        end_time: new Date(now.getTime() + 172800000).toISOString(), // Après-demain
        status: 'upcoming',
        description: 'Quiz sur les bases de l\'algorithmique'
      },
      {
        id: 2,
        title: 'Examen Base de Données',
        subject: 'Base de Données',
        teacher: 'Prof. Johnson',
        type: 'exam',
        duration: 120,
        total_marks: 40,
        passing_marks: 20,
        start_time: new Date(now.getTime() - 172800000).toISOString(), // Avant-hier
        end_time: new Date(now.getTime() - 86400000).toISOString(), // Hier
        status: 'ended',
        description: 'Examen final de base de données'
      },
      {
        id: 3,
        title: 'Devoir Programmation Web',
        subject: 'Programmation Web',
        teacher: 'Dr. Williams',
        type: 'assignment',
        duration: 60,
        total_marks: 30,
        passing_marks: 15,
        start_time: new Date(now.getTime() - 43200000).toISOString(), // Il y a 12h
        end_time: new Date(now.getTime() + 43200000).toISOString(), // Dans 12h
        status: 'active',
        description: 'Devoir sur les concepts avancés'
      },
      {
        id: 4,
        title: 'Test Mathématiques',
        subject: 'Mathématiques',
        teacher: 'Prof. Martin',
        type: 'test',
        duration: 90,
        total_marks: 25,
        passing_marks: 12,
        start_time: new Date(now.getTime() + 604800000).toISOString(), // Dans 1 semaine
        end_time: new Date(now.getTime() + 691200000).toISOString(),
        status: 'upcoming',
        description: 'Test sur les fonctions et dérivées'
      }
    ];
  };

  const generateMockResults = () => {
    return [
      {
        id: 1,
        test_title: 'Quiz Algorithmique - Chapitre 1',
        subject: 'Algorithmique',
        score: 16,
        total_marks: 20,
        percentage: 80,
        grade: 'B',
        date: '2024-01-15',
        rank: 5,
        time_taken: 35,
        is_passed: true
      },
      {
        id: 2,
        test_title: 'Examen Base de Données',
        subject: 'Base de Données',
        score: 32,
        total_marks: 40,
        percentage: 80,
        grade: 'B',
        date: '2024-01-10',
        rank: 2,
        time_taken: 110,
        is_passed: true
      },
      {
        id: 3,
        test_title: 'Devoir Programmation Web',
        subject: 'Programmation Web',
        score: 25,
        total_marks: 30,
        percentage: 83.3,
        grade: 'A',
        date: '2024-01-05',
        rank: 3,
        time_taken: 55,
        is_passed: true
      }
    ];
  };

  const getTestStatus = (test) => {
    const now = new Date();
    const start = new Date(test.start_time);
    const end = new Date(test.end_time);
    
    if (now < start) return 'upcoming';
    if (now > end) return 'ended';
    return 'active';
  };

  const getStatusInfo = (status) => {
    switch (status) {
      case 'active': return { label: 'Actif', color: 'success', icon: <PlayArrowIcon /> };
      case 'upcoming': return { label: 'À venir', color: 'info', icon: <ScheduleIcon /> };
      case 'ended': return { label: 'Terminé', color: 'default', icon: <CheckCircleIcon /> };
      default: return { label: 'Inconnu', color: 'default', icon: <ErrorIcon /> };
    }
  };

  const getTypeIcon = (type) => {
    switch (type) {
      case 'quiz': return '?';
      case 'exam': return '??';
      case 'assignment': return '??';
      case 'test': return '??';
      default: return '??';
    }
  };

  const handleStartTest = (test) => {
    if (getTestStatus(test) === 'active') {
      navigate(`/student/take-test/${test.id}`);
    } else {
      toast.info(`Le test "${test.title}" n'est pas encore disponible`);
    }
  };

  const handleViewResults = (result) => {
    setSelectedTest(result);
    setOpenDetails(true);
  };

  const filteredTests = tests.filter(test => {
    if (filter !== 'all' && getTestStatus(test) !== filter) return false;
    if (searchTerm && !test.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });

  const stats = {
    totalTests: tests.length,
    activeTests: tests.filter(t => getTestStatus(t) === 'active').length,
    completedTests: results.length,
    averageScore: results.length > 0 
      ? results.reduce((sum, r) => sum + r.percentage, 0) / results.length 
      : 0,
    passedTests: results.filter(r => r.is_passed).length
  };

  if (loading) {
    return (
      <Container maxWidth="xl" sx={{ py: 4 }}>
        <LinearProgress />
      </Container>
    );
  }

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Button
          startIcon={<ArrowBackIcon />}
          onClick={() => navigate('/student/dashboard')}
          sx={{ mb: 2 }}
        >
          Retour
        </Button>
        
        <Grid container alignItems="center" justifyContent="space-between" spacing={2}>
          <Grid item>
            <Typography variant="h4" component="h1" fontWeight="600">
              ?? Tests & Examens
            </Typography>
            <Typography variant="body1" color="textSecondary">
              Gérez vos tests, quiz et examens
            </Typography>
          </Grid>
          <Grid item>
            <Button
              variant="contained"
              startIcon={<BarChartIcon />}
              onClick={() => navigate('/student/grades')}
            >
              Mes statistiques
            </Button>
          </Grid>
        </Grid>
      </Box>

      {/* Stats */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid item xs={12} sm={6} md={2.4}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Total tests
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {stats.totalTests}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'primary.main' }}>
                  <QuizIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={2.4}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Actifs
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {stats.activeTests}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'success.main' }}>
                  <PlayArrowIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={2.4}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Terminés
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {stats.completedTests}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'info.main' }}>
                  <CheckCircleIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={2.4}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Moyenne
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {stats.averageScore.toFixed(1)}%
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'warning.main' }}>
                  <TrendingUpIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
        <Grid item xs={12} sm={6} md={2.4}>
          <Card>
            <CardContent>
              <Box display="flex" alignItems="center" justifyContent="space-between">
                <Box>
                  <Typography color="textSecondary" variant="body2">
                    Réussis
                  </Typography>
                  <Typography variant="h4" fontWeight="600">
                    {stats.passedTests}/{stats.completedTests}
                  </Typography>
                </Box>
                <Avatar sx={{ bgcolor: 'success.main' }}>
                  <TrophyIcon />
                </Avatar>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 4 }}>
        <Tabs value={tabValue} onChange={(e, v) => setTabValue(v)}>
          <Tab label="Tests disponibles" icon={<QuizIcon />} iconPosition="start" />
          <Tab label="Mes résultats" icon={<TrophyIcon />} iconPosition="start" />
          <Tab label="Calendrier" icon={<ScheduleIcon />} iconPosition="start" />
        </Tabs>
      </Box>

      {/* Tests Available Tab */}
      {tabValue === 0 && (
        <>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={4}>
            <Typography variant="h6" fontWeight="600">
              Tests disponibles ({filteredTests.length})
            </Typography>
            <Box display="flex" gap={1}>
              <TextField
                size="small"
                placeholder="Rechercher un test..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <SearchIcon />
                    </InputAdornment>
                  )
                }}
                sx={{ width: 300 }}
              />
              <FormControl size="small" sx={{ minWidth: 150 }}>
                <Select
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                  displayEmpty
                >
                  <MenuItem value="all">Tous les tests</MenuItem>
                  <MenuItem value="active">Actifs</MenuItem>
                  <MenuItem value="upcoming">À venir</MenuItem>
                  <MenuItem value="ended">Terminés</MenuItem>
                </Select>
              </FormControl>
            </Box>
          </Box>

          <Grid container spacing={3}>
            {filteredTests.map(test => {
              const status = getTestStatus(test);
              const statusInfo = getStatusInfo(status);
              
              return (
                <Grid item xs={12} md={6} key={test.id}>
                  <TestCard status={status}>
                    <Box display="flex" alignItems="flex-start" justifyContent="space-between" mb={2}>
                      <Box>
                        <Box display="flex" alignItems="center" gap={1} mb={1}>
                          <Typography variant="h5">
                            {getTypeIcon(test.type)}
                          </Typography>
                          <Typography variant="h6" fontWeight="600">
                            {test.title}
                          </Typography>
                        </Box>
                        <Chip
                          icon={statusInfo.icon}
                          label={statusInfo.label}
                          size="small"
                          color={statusInfo.color}
                          sx={{ mb: 1 }}
                        />
                      </Box>
                      <IconButton size="small">
                        <MoreVertIcon />
                      </IconButton>
                    </Box>

                    <Typography variant="body2" color="textSecondary" paragraph>
                      {test.description || 'Aucune description'}
                    </Typography>

                    <Grid container spacing={2} sx={{ mb: 3 }}>
                      <Grid item xs={6}>
                        <Box display="flex" alignItems="center" gap={1}>
                          <SchoolIcon fontSize="small" color="action" />
                          <Typography variant="body2">
                            {test.subject}
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6}>
                        <Box display="flex" alignItems="center" gap={1}>
                          <PersonIcon fontSize="small" color="action" />
                          <Typography variant="body2">
                            {test.teacher}
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6}>
                        <Box display="flex" alignItems="center" gap={1}>
                          <TimeIcon fontSize="small" color="action" />
                          <Typography variant="body2">
                            {test.duration} min
                          </Typography>
                        </Box>
                      </Grid>
                      <Grid item xs={6}>
                        <Box display="flex" alignItems="center" gap={1}>
                          <AssignmentIcon fontSize="small" color="action" />
                          <Typography variant="body2">
                            {test.total_marks} points
                          </Typography>
                        </Box>
                      </Grid>
                    </Grid>

                    <Box display="flex" justifyContent="space-between" alignItems="center">
                      <Box>
                        <Typography variant="caption" color="textSecondary" display="block">
                          Début
                        </Typography>
                        <Typography variant="body2" fontWeight="600">
                          {new Date(test.start_time).toLocaleDateString('fr-FR')}
                        </Typography>
                      </Box>
                      
                      <Button
                        variant={status === 'active' ? 'contained' : 'outlined'}
                        startIcon={status === 'active' ? <PlayArrowIcon /> : <ViewIcon />}
                        onClick={() => status === 'active' ? handleStartTest(test) : toast.info('Voir détails')}
                        disabled={status === 'upcoming'}
                      >
                        {status === 'active' ? 'Commencer' : 
                         status === 'upcoming' ? 'À venir' : 'Voir résultats'}
                      </Button>
                    </Box>
                  </TestCard>
                </Grid>
              );
            })}
          </Grid>
        </>
      )}

      {/* Results Tab */}
      {tabValue === 1 && (
        <>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={4}>
            <Typography variant="h6" fontWeight="600">
              Mes résultats ({results.length})
            </Typography>
            <Button
              variant="outlined"
              startIcon={<DownloadIcon />}
              onClick={() => toast.success('Export des résultats')}
            >
              Exporter
            </Button>
          </Box>

          <Grid container spacing={3}>
            {results.map(result => (
              <Grid item xs={12} md={6} key={result.id}>
                <Card>
                  <CardContent>
                    <Box display="flex" alignItems="center" justifyContent="space-between" mb={2}>
                      <Typography variant="h6" fontWeight="600">
                        {result.test_title}
                      </Typography>
                      <Chip
                        label={result.is_passed ? 'Réussi' : 'Échoué'}
                        color={result.is_passed ? 'success' : 'error'}
                        size="small"
                      />
                    </Box>

                    <Grid container spacing={2} sx={{ mb: 3 }}>
                      <Grid item xs={6}>
                        <Typography variant="body2" color="textSecondary">
                          Matière
                        </Typography>
                        <Typography variant="body1" fontWeight="600">
                          {result.subject}
                        </Typography>
                      </Grid>
                      <Grid item xs={6}>
                        <Typography variant="body2" color="textSecondary">
                          Date
                        </Typography>
                        <Typography variant="body1" fontWeight="600">
                          {new Date(result.date).toLocaleDateString('fr-FR')}
                        </Typography>
                      </Grid>
                    </Grid>

                    <Box display="flex" alignItems="center" justifyContent="space-between" mb={3}>
                      <Box textAlign="center">
                        <ProgressCircle
                          variant="determinate"
                          value={result.percentage}
                          size={80}
                          thickness={4}
                        />
                        <Box
                          sx={{
                            position: 'absolute',
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)'
                          }}
                        >
                          <Typography variant="h6" fontWeight="600">
                            {result.percentage}%
                          </Typography>
                        </Box>
                      </Box>
                      
                      <Box textAlign="center">
                        <Typography variant="h2" fontWeight="600" color="primary.main">
                          {result.score}/{result.total_marks}
                        </Typography>
                        <Typography variant="body2" color="textSecondary">
                          Note
                        </Typography>
                      </Box>
                      
                      <Box textAlign="center">
                        <Typography variant="h4" fontWeight="600">
                          {result.grade}
                        </Typography>
                        <Typography variant="body2" color="textSecondary">
                          Grade
                        </Typography>
                      </Box>
                    </Box>

                    <Box display="flex" justifyContent="space-between" alignItems="center">
                      <Box display="flex" alignItems="center" gap={2}>
                        <Box display="flex" alignItems="center" gap={0.5}>
                          <TimeIcon fontSize="small" />
                          <Typography variant="body2">
                            {result.time_taken} min
                          </Typography>
                        </Box>
                        <Box display="flex" alignItems="center" gap={0.5}>
                          <PeopleIcon fontSize="small" />
                          <Typography variant="body2">
                            {result.rank}ème
                          </Typography>
                        </Box>
                      </Box>
                      
                      <Button
                        variant="outlined"
                        startIcon={<ViewIcon />}
                        onClick={() => handleViewResults(result)}
                      >
                        Détails
                      </Button>
                    </Box>
                  </CardContent>
                </Card>
              </Grid>
            ))}
          </Grid>
        </>
      )}

      {/* Calendar Tab */}
      {tabValue === 2 && (
        <Card>
          <CardContent>
            <Typography variant="h6" fontWeight="600" gutterBottom>
              ?? Calendrier des tests
            </Typography>
            
            <TableContainer>
              <Table>
                <TableHead>
                  <TableRow>
                    <TableCell>Test</TableCell>
                    <TableCell>Matière</TableCell>
                    <TableCell>Type</TableCell>
                    <TableCell>Début</TableCell>
                    <TableCell>Fin</TableCell>
                    <TableCell>Durée</TableCell>
                    <TableCell>Status</TableCell>
                    <TableCell>Actions</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {tests.map(test => {
                    const status = getTestStatus(test);
                    const statusInfo = getStatusInfo(status);
                    
                    return (
                      <TableRow key={test.id} hover>
                        <TableCell>
                          <Typography variant="subtitle2" fontWeight="600">
                            {test.title}
                          </Typography>
                        </TableCell>
                        <TableCell>{test.subject}</TableCell>
                        <TableCell>
                          <Chip
                            label={test.type}
                            size="small"
                            variant="outlined"
                          />
                        </TableCell>
                        <TableCell>
                          {new Date(test.start_time).toLocaleDateString('fr-FR')}
                          <br />
                          <Typography variant="caption" color="textSecondary">
                            {new Date(test.start_time).toLocaleTimeString('fr-FR', { 
                              hour: '2-digit', 
                              minute: '2-digit' 
                            })}
                          </Typography>
                        </TableCell>
                        <TableCell>
                          {new Date(test.end_time).toLocaleDateString('fr-FR')}
                          <br />
                          <Typography variant="caption" color="textSecondary">
                            {new Date(test.end_time).toLocaleTimeString('fr-FR', { 
                              hour: '2-digit', 
                              minute: '2-digit' 
                            })}
                          </Typography>
                        </TableCell>
                        <TableCell>{test.duration} min</TableCell>
                        <TableCell>
                          <Chip
                            icon={statusInfo.icon}
                            label={statusInfo.label}
                            size="small"
                            color={statusInfo.color}
                          />
                        </TableCell>
                        <TableCell>
                          <Button
                            size="small"
                            onClick={() => handleStartTest(test)}
                            disabled={status !== 'active'}
                          >
                            {status === 'active' ? 'Commencer' : 'Voir'}
                          </Button>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </TableContainer>
          </CardContent>
        </Card>
      )}

      {/* Results Details Dialog */}
      <Dialog
        open={openDetails}
        onClose={() => setOpenDetails(false)}
        maxWidth="md"
        fullWidth
      >
        {selectedTest && (
          <>
            <DialogTitle>
              <Box display="flex" alignItems="center" gap={1}>
                <TrophyIcon />
                Résultats détaillés
              </Box>
            </DialogTitle>
            <DialogContent>
              <Grid container spacing={3}>
                <Grid item xs={12}>
                  <Typography variant="h6" gutterBottom>
                    {selectedTest.test_title}
                  </Typography>
                  <Typography variant="body2" color="textSecondary" paragraph>
                    {selectedTest.subject} • {new Date(selectedTest.date).toLocaleDateString('fr-FR')}
                  </Typography>
                </Grid>
                
                <Grid item xs={12} md={6}>
                  <Card>
                    <CardContent>
                      <Typography variant="subtitle2" gutterBottom>
                        Performance
                      </Typography>
                      <Box textAlign="center" py={2}>
                        <ProgressCircle
                          variant="determinate"
                          value={selectedTest.percentage}
                          size={120}
                          thickness={4}
                        />
                        <Box
                          sx={{
                            position: 'absolute',
                            top: '50%',
                            left: '50%',
                            transform: 'translate(-50%, -50%)'
                          }}
                        >
                          <Typography variant="h3" fontWeight="600">
                            {selectedTest.percentage}%
                          </Typography>
                        </Box>
                      </Box>
                    </CardContent>
                  </Card>
                </Grid>
                
                <Grid item xs={12} md={6}>
                  <Card>
                    <CardContent>
                      <Typography variant="subtitle2" gutterBottom>
                        Détails
                      </Typography>
                      <List dense>
                        <ListItem>
                          <ListItemText
                            primary="Note"
                            secondary={
                              <Typography variant="h6" color="primary">
                                {selectedTest.score}/{selectedTest.total_marks}
                              </Typography>
                            }
                          />
                        </ListItem>
                        <ListItem>
                          <ListItemText
                            primary="Grade"
                            secondary={
                              <Typography variant="h6" color="primary">
                                {selectedTest.grade}
                              </Typography>
                            }
                          />
                        </ListItem>
                        <ListItem>
                          <ListItemText
                            primary="Classement"
                            secondary={`${selectedTest.rank}ème`}
                          />
                        </ListItem>
                        <ListItem>
                          <ListItemText
                            primary="Temps pris"
                            secondary={`${selectedTest.time_taken} minutes`}
                          />
                        </ListItem>
                        <ListItem>
                          <ListItemText
                            primary="Statut"
                            secondary={
                              <Chip
                                label={selectedTest.is_passed ? 'Réussi' : 'Échoué'}
                                color={selectedTest.is_passed ? 'success' : 'error'}
                                size="small"
                              />
                            }
                          />
                        </ListItem>
                      </List>
                    </CardContent>
                  </Card>
                </Grid>
              </Grid>
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setOpenDetails(false)}>Fermer</Button>
              <Button
                variant="contained"
                startIcon={<DownloadIcon />}
                onClick={() => {
                  toast.success('Téléchargement des résultats');
                  setOpenDetails(false);
                }}
              >
                Télécharger
              </Button>
            </DialogActions>
          </>
        )}
      </Dialog>
    </Container>
  );
}  aussi corriger tout les pages src/pages/teacher CreateTest.jsximport React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import './CreateTest.css';  // Ajoutez cette ligne
import '../../App.css';     // Si vous avez des styles globaux


export default function CreateTest() {
  const navigate = useNavigate();
  const [subjects, setSubjects] = useState([]);
  const [loading, setLoading] = useState(true);
  const [testType, setTestType] = useState('quiz');
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    subject: '',
    duration: 60,
    total_marks: 20,
    passing_marks: 10,
    start_time: '',
    end_time: '',
    instructions: '',
    questions: []
  });
  const [currentQuestion, setCurrentQuestion] = useState({
    text: '',
    type: 'mcq',
    marks: 1,
    choices: [
      { text: '', is_correct: false },
      { text: '', is_correct: false },
      { text: '', is_correct: false },
      { text: '', is_correct: false }
    ]
  });
  const [activeTab, setActiveTab] = useState('basic');

  useEffect(() => {
    loadSubjects();
  }, []);

  const loadSubjects = async () => {
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const res = await api.get('/classes/subjects/');
      const teacherSubjects = res.data.filter(subject => subject.teacher === user.id);
      setSubjects(teacherSubjects);
    } catch (err) {
      toast.error('Erreur chargement des matières');
    } finally {
      setLoading(false);
    }
  };

  const handleAddQuestion = () => {
    if (!currentQuestion.text.trim()) {
      toast.error('Le texte de la question est requis');
      return;
    }

    if (currentQuestion.type === 'mcq') {
      const hasCorrect = currentQuestion.choices.some(c => c.is_correct);
      if (!hasCorrect) {
        toast.error('Au moins un choix doit être correct');
        return;
      }
    }

    const newQuestion = {
      ...currentQuestion,
      id: formData.questions.length + 1
    };

    setFormData(prev => ({
      ...prev,
      questions: [...prev.questions, newQuestion]
    }));

    // Réinitialiser la question courante
    setCurrentQuestion({
      text: '',
      type: 'mcq',
      marks: 1,
      choices: [
        { text: '', is_correct: false },
        { text: '', is_correct: false },
        { text: '', is_correct: false },
        { text: '', is_correct: false }
      ]
    });

    toast.success('Question ajoutée');
  };

  const handleRemoveQuestion = (index) => {
    setFormData(prev => ({
      ...prev,
      questions: prev.questions.filter((_, i) => i !== index)
    }));
  };

  const updateChoice = (index, field, value) => {
    const newChoices = [...currentQuestion.choices];
    if (field === 'is_correct') {
      // Pour MCQ simple, un seul choix correct
      if (value) {
        newChoices.forEach((c, i) => {
          c.is_correct = i === index;
        });
      }
    } else {
      newChoices[index][field] = value;
    }
    setCurrentQuestion(prev => ({ ...prev, choices: newChoices }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!formData.subject) {
      toast.error('Veuillez sélectionner une matière');
      return;
    }

    if (!formData.title.trim()) {
      toast.error('Le titre du test est requis');
      return;
    }

    if (formData.questions.length === 0) {
      toast.error('Ajoutez au moins une question');
      return;
    }

    try {
      // Préparer les données pour l'API
      const testData = {
        title: formData.title,
        description: formData.description,
        subject: formData.subject,
        quiz_type: testType,
        duration: parseInt(formData.duration),
        total_marks: parseInt(formData.total_marks),
        passing_marks: parseInt(formData.passing_marks),
        start_time: formData.start_time || new Date().toISOString(),
        end_time: formData.end_time || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
        instructions: formData.instructions,
        questions: formData.questions
      };

      // Envoyer à l'API
      const res = await api.post('/tests/quizzes/', testData);
      
      toast.success('Test créé avec succès !');
      navigate('/teacher/dashboard');

    } catch (err) {
      toast.error('Erreur lors de la création du test');
      console.error(err);
    }
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Chargement...</p>
      </div>
    );
  }

  if (subjects.length === 0) {
    return (
      <div className="empty-container">
        <div className="empty-icon">??</div>
        <h2>Aucune matière assignée</h2>
        <p>Vous devez être assigné à une matière pour créer des tests</p>
        <button onClick={() => navigate('/teacher/dashboard')} className="btn-primary">
          Retour au tableau de bord
        </button>
      </div>
    );
  }

  return (
    <div className="create-test-container">
      <div className="test-header">
        <button onClick={() => navigate('/teacher/dashboard')} className="back-btn">
          ? Retour
        </button>
        <h1>?? Créer un nouveau test</h1>
        <p>Créez des quiz, examens ou devoirs pour vos étudiants</p>
      </div>

      <div className="test-tabs">
        <button 
          className={`tab-btn ${activeTab === 'basic' ? 'active' : ''}`}
          onClick={() => setActiveTab('basic')}
        >
          Informations de base
        </button>
        <button 
          className={`tab-btn ${activeTab === 'questions' ? 'active' : ''}`}
          onClick={() => setActiveTab('questions')}
        >
          Questions ({formData.questions.length})
        </button>
        <button 
          className={`tab-btn ${activeTab === 'preview' ? 'active' : ''}`}
          onClick={() => setActiveTab('preview')}
        >
          Aperçu
        </button>
      </div>

      <form onSubmit={handleSubmit} className="test-form">
        {activeTab === 'basic' && (
          <div className="basic-info">
            <div className="form-row">
              <div className="form-group">
                <label>Type de test *</label>
                <select 
                  value={testType} 
                  onChange={(e) => setTestType(e.target.value)}
                  className="form-select"
                >
                  <option value="quiz">Quiz</option>
                  <option value="exam">Examen</option>
                  <option value="assignment">Devoir</option>
                  <option value="test">Test</option>
                </select>
              </div>

              <div className="form-group">
                <label>Matière *</label>
                <select 
                  value={formData.subject}
                  onChange={(e) => setFormData({...formData, subject: e.target.value})}
                  className="form-select"
                  required
                >
                  <option value="">Sélectionnez une matière</option>
                  {subjects.map(subject => (
                    <option key={subject.id} value={subject.id}>
                      {subject.name} - {subject.class_name}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            <div className="form-group">
              <label>Titre du test *</label>
              <input
                type="text"
                value={formData.title}
                onChange={(e) => setFormData({...formData, title: e.target.value})}
                placeholder="Ex: Quiz Algorithmique - Chapitre 1"
                className="form-input"
                required
              />
            </div>

            <div className="form-group">
              <label>Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({...formData, description: e.target.value})}
                placeholder="Description du contenu du test..."
                className="form-textarea"
                rows="3"
              />
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Durée (minutes) *</label>
                <input
                  type="number"
                  value={formData.duration}
                  onChange={(e) => setFormData({...formData, duration: e.target.value})}
                  className="form-input"
                  min="5"
                  max="240"
                  required
                />
              </div>

              <div className="form-group">
                <label>Note totale *</label>
                <input
                  type="number"
                  value={formData.total_marks}
                  onChange={(e) => setFormData({...formData, total_marks: e.target.value})}
                  className="form-input"
                  min="1"
                  max="100"
                  required
                />
              </div>

              <div className="form-group">
                <label>Note de passage *</label>
                <input
                  type="number"
                  value={formData.passing_marks}
                  onChange={(e) => setFormData({...formData, passing_marks: e.target.value})}
                  className="form-input"
                  min="1"
                  max={formData.total_marks}
                  required
                />
              </div>
            </div>

            <div className="form-row">
              <div className="form-group">
                <label>Date de début</label>
                <input
                  type="datetime-local"
                  value={formData.start_time}
                  onChange={(e) => setFormData({...formData, start_time: e.target.value})}
                  className="form-input"
                />
              </div>

              <div className="form-group">
                <label>Date de fin</label>
                <input
                  type="datetime-local"
                  value={formData.end_time}
                  onChange={(e) => setFormData({...formData, end_time: e.target.value})}
                  className="form-input"
                />
              </div>
            </div>

            <div className="form-group">
              <label>Instructions pour les étudiants</label>
              <textarea
                value={formData.instructions}
                onChange={(e) => setFormData({...formData, instructions: e.target.value})}
                placeholder="Instructions spéciales, consignes..."
                className="form-textarea"
                rows="4"
              />
            </div>
          </div>
        )}

        {activeTab === 'questions' && (
          <div className="questions-section">
            <div className="add-question">
              <h3>Ajouter une question</h3>
              
              <div className="form-group">
                <label>Type de question</label>
                <select 
                  value={currentQuestion.type}
                  onChange={(e) => setCurrentQuestion({...currentQuestion, type: e.target.value})}
                  className="form-select"
                >
                  <option value="mcq">Choix multiple</option>
                  <option value="true_false">Vrai/Faux</option>
                  <option value="short_answer">Réponse courte</option>
                  <option value="essay">Dissertation</option>
                  <option value="fill_blank">Remplir les blancs</option>
                </select>
              </div>

              <div className="form-group">
                <label>Texte de la question *</label>
                <textarea
                  value={currentQuestion.text}
                  onChange={(e) => setCurrentQuestion({...currentQuestion, text: e.target.value})}
                  placeholder="Entrez votre question..."
                  className="form-textarea"
                  rows="3"
                />
              </div>

              <div className="form-group">
                <label>Points *</label>
                <input
                  type="number"
                  value={currentQuestion.marks}
                  onChange={(e) => setCurrentQuestion({...currentQuestion, marks: parseInt(e.target.value)})}
                  className="form-input"
                  min="1"
                  max="10"
                />
              </div>

              {currentQuestion.type === 'mcq' && (
                <div className="choices-section">
                  <h4>Choix de réponse</h4>
                  {currentQuestion.choices.map((choice, index) => (
                    <div key={index} className="choice-item">
                      <input
                        type="radio"
                        name="correctChoice"
                        checked={choice.is_correct}
                        onChange={(e) => updateChoice(index, 'is_correct', e.target.checked)}
                        className="choice-radio"
                      />
                      <input
                        type="text"
                        value={choice.text}
                        onChange={(e) => updateChoice(index, 'text', e.target.value)}
                        placeholder={`Choix ${index + 1}`}
                        className="choice-input"
                      />
                      <button
                        type="button"
                        onClick={() => {
                          const newChoices = currentQuestion.choices.filter((_, i) => i !== index);
                          setCurrentQuestion({...currentQuestion, choices: newChoices});
                        }}
                        className="remove-choice-btn"
                      >
                        ?
                      </button>
                    </div>
                  ))}
                  <button
                    type="button"
                    onClick={() => setCurrentQuestion(prev => ({
                      ...prev,
                      choices: [...prev.choices, { text: '', is_correct: false }]
                    }))}
                    className="add-choice-btn"
                  >
                    + Ajouter un choix
                  </button>
                </div>
              )}

              <button
                type="button"
                onClick={handleAddQuestion}
                className="btn-add-question"
              >
                + Ajouter cette question
              </button>
            </div>

            <div className="questions-list">
              <h3>Questions ajoutées ({formData.questions.length})</h3>
              
              {formData.questions.length === 0 ? (
                <div className="no-questions">
                  <p>Aucune question ajoutée. Ajoutez votre première question ci-dessus.</p>
                </div>
              ) : (
                <div className="questions-grid">
                  {formData.questions.map((question, index) => (
                    <div key={index} className="question-card">
                      <div className="question-header">
                        <span className="question-number">Q{index + 1}</span>
                        <span className="question-type">{question.type}</span>
                        <span className="question-marks">{question.marks} points</span>
                        <button
                          type="button"
                          onClick={() => handleRemoveQuestion(index)}
                          className="remove-question-btn"
                        >
                          ?
                        </button>
                      </div>
                      <div className="question-text">{question.text}</div>
                      {question.type === 'mcq' && (
                        <div className="question-choices">
                          {question.choices.map((choice, cIndex) => (
                            <div key={cIndex} className={`choice ${choice.is_correct ? 'correct' : ''}`}>
                              {choice.is_correct ? '?' : '?'} {choice.text}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'preview' && (
          <div className="preview-section">
            <h3>Aperçu du test</h3>
            
            <div className="test-preview">
              <div className="preview-header">
                <h2>{formData.title || "Titre du test"}</h2>
                <div className="preview-meta">
                  <span>Type: {testType}</span>
                  <span>Durée: {formData.duration} min</span>
                  <span>Total: {formData.total_marks} points</span>
                  <span>Passage: {formData.passing_marks} points</span>
                </div>
              </div>

              {formData.description && (
                <div className="preview-description">
                  <p>{formData.description}</p>
                </div>
              )}

              {formData.instructions && (
                <div className="preview-instructions">
                  <h4>Instructions:</h4>
                  <p>{formData.instructions}</p>
                </div>
              )}

              <div className="preview-questions">
                <h4>Questions ({formData.questions.length})</h4>
                {formData.questions.map((question, index) => (
                  <div key={index} className="preview-question">
                    <div className="preview-question-header">
                      <strong>Q{index + 1}. {question.text}</strong>
                      <span>{question.marks} points</span>
                    </div>
                    {question.type === 'mcq' && (
                      <div className="preview-choices">
                        {question.choices.map((choice, cIndex) => (
                          <div key={cIndex} className="preview-choice">
                            {String.fromCharCode(65 + cIndex)}. {choice.text}
                            {choice.is_correct && ' ?'}
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        <div className="form-actions">
          <button
            type="button"
            onClick={() => {
              if (activeTab === 'basic') {
                navigate('/teacher/dashboard');
              } else {
                setActiveTab(activeTab === 'questions' ? 'basic' : 'questions');
              }
            }}
            className="btn-cancel"
          >
            {activeTab === 'basic' ? 'Annuler' : 'Retour'}
          </button>
          
          <button
            type="button"
            onClick={() => {
              if (activeTab === 'basic') {
                setActiveTab('questions');
              } else if (activeTab === 'questions') {
                setActiveTab('preview');
              }
            }}
            className="btn-next"
            disabled={activeTab === 'preview'}
          >
            Suivant ?
          </button>
          
          {activeTab === 'preview' && (
            <button
              type="submit"
              className="btn-submit"
              disabled={!formData.subject || formData.questions.length === 0}
            >
              ? Créer le test
            </button>
          )}
        </div>
      </form>
    </div>
  );
}  GradeTests.jsx  import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';
import './GradeTests.css';  // Ajoutez cette ligne
import '../../App.css'; 

export default function GradeTests() {
  const navigate = useNavigate();
  const [tests, setTests] = useState([]);
  const [selectedTest, setSelectedTest] = useState(null);
  const [submissions, setSubmissions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [grading, setGrading] = useState(false);

  useEffect(() => {
    loadTests();
  }, []);

  const loadTests = async () => {
    try {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const res = await api.get('/tests/quizzes/');
      const teacherTests = res.data.filter(test => test.teacher === user.id);
      setTests(teacherTests);
    } catch (err) {
      toast.error('Erreur chargement des tests');
    } finally {
      setLoading(false);
    }
  };

  const loadSubmissions = async (testId) => {
    try {
      const res = await api.get(`/tests/scores/test/${testId}/`);
      setSubmissions(res.data);
      setSelectedTest(testId);
    } catch (err) {
      toast.error('Erreur chargement des soumissions');
    }
  };

  const handleGradeSubmission = async (submissionId, score) => {
    setGrading(true);
    try {
      await api.put(`/tests/scores/${submissionId}/`, { score });
      toast.success('Note mise à jour');
      
      // Rafraîchir les soumissions
      if (selectedTest) {
        await loadSubmissions(selectedTest);
      }
    } catch (err) {
      toast.error('Erreur lors de la notation');
    } finally {
      setGrading(false);
    }
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Chargement des tests...</p>
      </div>
    );
  }

  return (
    <div className="grade-tests-container">
      <div className="grade-header">
        <button onClick={() => navigate('/teacher/dashboard')} className="back-btn">
          ? Retour
        </button>
        <h1>?? Notation des tests</h1>
        <p>Consultez et notez les soumissions de vos étudiants</p>
      </div>

      <div className="grade-content">
        <div className="tests-sidebar">
          <h3>Mes tests ({tests.length})</h3>
          <div className="tests-list">
            {tests.length === 0 ? (
              <div className="no-tests">
                <p>Aucun test créé</p>
                <button 
                  onClick={() => navigate('/teacher/create-test')}
                  className="btn-create-test"
                >
                  + Créer un test
                </button>
              </div>
            ) : (
              tests.map(test => (
                <div
                  key={test.id}
                  className={`test-item ${selectedTest === test.id ? 'selected' : ''}`}
                  onClick={() => loadSubmissions(test.id)}
                >
                  <div className="test-info">
                    <h4>{test.title}</h4>
                    <div className="test-meta">
                      <span>?? {test.subject_name}</span>
                      <span>?? {test.students_count || 0} étudiants</span>
                      <span>?? {test.submissions_count || 0} soumis</span>
                    </div>
                  </div>
                  <div className="test-status">
                    <span className={`status-badge ${test.is_active ? 'active' : 'ended'}`}>
                      {test.is_active ? 'Actif' : 'Terminé'}
                    </span>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>

        <div className="submissions-main">
          {!selectedTest ? (
            <div className="select-test-prompt">
              <div className="prompt-icon">??</div>
              <h3>Sélectionnez un test</h3>
              <p>Choisissez un test dans la liste pour voir les soumissions</p>
            </div>
          ) : (
            <>
              <div className="submissions-header">
                <h2>Soumissions</h2>
                <div className="submission-stats">
                  <span className="stat">Total: {submissions.length}</span>
                  <span className="stat">Notés: {submissions.filter(s => s.graded).length}</span>
                  <span className="stat">En attente: {submissions.filter(s => !s.graded).length}</span>
                </div>
              </div>

              {submissions.length === 0 ? (
                <div className="no-submissions">
                  <div className="empty-icon">??</div>
                  <h3>Aucune soumission</h3>
                  <p>Les étudiants n'ont pas encore soumis ce test</p>
                </div>
              ) : (
                <div className="submissions-list">
                  {submissions.map(submission => (
                    <div key={submission.id} className="submission-card">
                      <div className="student-info">
                        <div className="student-avatar">
                          {submission.student_name?.charAt(0).toUpperCase() || 'S'}
                        </div>
                        <div className="student-details">
                          <h4>{submission.student_name || 'Étudiant'}</h4>
                          <p className="student-email">{submission.student_email || ''}</p>
                          <div className="submission-time">
                            Soumis le: {new Date(submission.submitted_at).toLocaleDateString('fr-FR')}
                          </div>
                        </div>
                      </div>

                      <div className="submission-grade">
                        {submission.graded ? (
                          <div className="grade-display">
                            <div className="grade-score">
                              <span className="score-value">{submission.score || 0}</span>
                              <span className="score-total">/{submission.total_marks || 20}</span>
                            </div>
                            <div className="grade-percentage">
                              {Math.round((submission.score / submission.total_marks) * 100)}%
                            </div>
                            <button
                              onClick={() => handleGradeSubmission(submission.id, submission.score)}
                              className="btn-edit-grade"
                              disabled={grading}
                            >
                              Modifier
                            </button>
                          </div>
                        ) : (
                          <div className="grade-input">
                            <input
                              type="number"
                              defaultValue={submission.score || 0}
                              min="0"
                              max={submission.total_marks || 20}
                              className="score-input"
                              placeholder="Note"
                            />
                            <span className="score-max">/{submission.total_marks || 20}</span>
                            <button
                              onClick={() => {
                                const input = document.querySelector(`.score-input`);
                                handleGradeSubmission(submission.id, parseFloat(input.value));
                              }}
                              className="btn-save-grade"
                              disabled={grading}
                            >
                              {grading ? '...' : 'Sauvegarder'}
                            </button>
                          </div>
                        )}
                      </div>

                      <div className="submission-actions">
                        <button
                          onClick={() => navigate(`/teacher/submission/${submission.id}`)}
                          className="btn-view-submission"
                        >
                          Voir la copie
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}  TeacherDashboard.jsx  // src/pages/teacher/TeacherDashboard.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { toast } from 'react-toastify';
import api from '../../services/api';
import './TeacherDashboard.css';

export default function TeacherDashboard() {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const [dashboardData, setDashboardData] = useState({
    subjects: [],
    upcomingClasses: [],
    pendingGrades: [],
    activeSessions: [],
    stats: {
      totalStudents: 0,
      activeClasses: 0,
      averageAttendance: 0,
      publishedCourses: 0
    }
  });
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('overview');
  const [recentActivity, setRecentActivity] = useState([]);

  useEffect(() => {
    loadDashboardData();
  }, []);

  const loadDashboardData = async () => {
    try {
      const teacherId = user?.id;
      
      // Récupérer les données de l'enseignant
      const [subjectsRes, scheduleRes, liveSessionsRes] = await Promise.all([
        api.get('/classes/subjects/'),
        api.get('/schedule/time-slots/'),
        api.get('/live/sessions/')
      ]);

      // Filtrer les matières de l'enseignant
      const teacherSubjects = subjectsRes.data.filter(subject => 
        subject.teacher === teacherId
      );

      // Sessions live actives
      const activeLiveSessions = liveSessionsRes.data.filter(session => 
        session.status === 'live' && session.teacher === teacherId
      );

      // Classes à venir aujourd'hui
      const today = new Date();
      const todayKey = getDayName(today.getDay());
      const upcomingClasses = scheduleRes.data.filter(slot => 
        slot.teacher === teacherId && 
        slot.day === todayKey &&
        new Date(`2000-01-01T${slot.start_time}`) > today
      );

      // Calculer les statistiques
      const totalStudents = teacherSubjects.reduce((sum, subject) => 
        sum + (subject.class_assigned_details?.students_count || 0), 0
      );

      const uniqueClasses = [...new Set(teacherSubjects.map(s => s.class_assigned))].length;

      setDashboardData({
        subjects: teacherSubjects,
        upcomingClasses: upcomingClasses.slice(0, 3),
        pendingGrades: [],
        activeSessions: activeLiveSessions,
        stats: {
          totalStudents,
          activeClasses: uniqueClasses,
          averageAttendance: 85,
          publishedCourses: teacherSubjects.length * 2 // Estimation
        }
      });

      // Activité récente
      setRecentActivity([
        { id: 1, type: 'course', action: 'uploaded', title: 'Introduction à Python', time: '2h ago', subject: 'Programmation' },
        { id: 2, type: 'quiz', action: 'created', title: 'Quiz Algorithmique', time: '1d ago', subject: 'Algorithmique' },
        { id: 3, type: 'live', action: 'conducted', title: 'Session Live DB', time: '2d ago', subject: 'Base de Données' },
        { id: 4, type: 'grade', action: 'graded', title: 'TP1 - 25 copies', time: '3d ago', subject: 'Web Development' }
      ]);

    } catch (error) {
      console.error('Dashboard error:', error);
      toast.error('Erreur de chargement du tableau de bord');
    } finally {
      setLoading(false);
    }
  };

  const getDayName = (dayNumber) => {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days[dayNumber] || 'Monday';
  };

  const startLiveSession = async (subjectId) => {
    try {
      const subject = dashboardData.subjects.find(s => s.id === subjectId);
      if (!subject) return;

      const response = await api.post('/live/sessions/', {
        title: `Session Live - ${subject.name}`,
        description: 'Session en direct avec les étudiants',
        subject: subjectId,
        start_time: new Date().toISOString(),
        max_participants: 50
      });

      // Démarrer la session
      await api.post(`/live/sessions/${response.data.id}/start/`);
      
      navigate(`/live-session/${response.data.meeting_id}`);
      toast.success('Session live démarrée');
    } catch (error) {
      toast.error('Erreur démarrage session');
    }
  };

  const joinClassChat = (classId) => {
    navigate(`/teacher/class/${classId}/chat`);
  };

  if (loading) {
    return (
      <div className="teacher-dashboard-loading">
        <div className="loading-spinner"></div>
        <p>Chargement de votre espace enseignant...</p>
      </div>
    );
  }

  return (
    <div className="teacher-dashboard-container">
      {/* Header */}
      <div className="dashboard-header">
        <div className="header-left">
          <div className="welcome-section">
            <h1>Bienvenue, {user?.first_name || user?.username} ?????</h1>
            <p className="role-badge">Enseignant</p>
            <p className="welcome-message">Gérez vos classes, cours et sessions en direct</p>
          </div>
          <div className="quick-stats">
            <div className="stat-item">
              <span className="stat-icon">??</span>
              <div>
                <h3>{dashboardData.stats.totalStudents}</h3>
                <p>Étudiants</p>
              </div>
            </div>
            <div className="stat-item">
              <span className="stat-icon">??</span>
              <div>
                <h3>{dashboardData.stats.activeClasses}</h3>
                <p>Classes</p>
              </div>
            </div>
            <div className="stat-item">
              <span className="stat-icon">??</span>
              <div>
                <h3>{dashboardData.stats.publishedCourses}</h3>
                <p>Cours</p>
              </div>
            </div>
          </div>
        </div>
        <div className="header-right">
          <div className="date-time">
            <div className="date">{new Date().toLocaleDateString('fr-FR', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}</div>
            <div className="time">{new Date().toLocaleTimeString('fr-FR', { 
              hour: '2-digit', 
              minute: '2-digit' 
            })}</div>
          </div>
          <button 
            className="btn-start-live"
            onClick={() => navigate('/teacher/live-session/new')}
          >
            ?? Démarrer un live
          </button>
        </div>
      </div>

      {/* Main Content Grid */}
      <div className="dashboard-grid">
        {/* Left Column */}
        <div className="column-left">
          {/* Mes Classes */}
          <div className="dashboard-card">
            <div className="card-header">
              <h2>?? Mes Classes Actives</h2>
              <button 
                className="btn-view-all"
                onClick={() => navigate('/teacher/classes')}
              >
                Voir tout ?
              </button>
            </div>
            <div className="classes-grid">
              {dashboardData.subjects.slice(0, 4).map(subject => (
                <div key={subject.id} className="class-card">
                  <div className="class-header">
                    <h3>{subject.name}</h3>
                    <span className="class-code">{subject.class_assigned_details?.name}</span>
                  </div>
                  <div className="class-stats">
                    <span className="stat">?? {subject.class_assigned_details?.students_count || 0} étudiants</span>
                    <span className="stat">?? 2 cours/semaine</span>
                  </div>
                  <div className="class-actions">
                    <button 
                      className="btn-action chat"
                      onClick={() => joinClassChat(subject.class_assigned)}
                    >
                      ?? Chat
                    </button>
                    <button 
                      className="btn-action live"
                      onClick={() => startLiveSession(subject.id)}
                    >
                      ?? Live
                    </button>
                    <button 
                      className="btn-action manage"
                      onClick={() => navigate(`/teacher/subject/${subject.id}`)}
                    >
                      ?? Gérer
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Sessions à Venir */}
          <div className="dashboard-card">
            <h2>? Aujourd'hui</h2>
            {dashboardData.upcomingClasses.length > 0 ? (
              <div className="schedule-list">
                {dashboardData.upcomingClasses.map(session => (
                  <div key={session.id} className="schedule-item">
                    <div className="session-time">
                      <div className="time">{session.start_time} - {session.end_time}</div>
                      <div className="room">{session.classroom || 'Salle virtuelle'}</div>
                    </div>
                    <div className="session-info">
                      <h4>{session.subject_details?.name}</h4>
                      <p>{session.subject_details?.class_name}</p>
                    </div>
                    <button 
                      className="btn-join"
                      onClick={() => startLiveSession(session.subject)}
                    >
                      Rejoindre
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div className="no-sessions">
                <p>Aucun cours programmé aujourd'hui</p>
                <button 
                  className="btn-schedule"
                  onClick={() => navigate('/teacher/schedule')}
                >
                  Planifier un cours
                </button>
              </div>
            )}
          </div>
        </div>

        {/* Right Column */}
        <div className="column-right">
          {/* Sessions Live Actives */}
          <div className="dashboard-card">
            <h2>?? Sessions en Direct</h2>
            {dashboardData.activeSessions.length > 0 ? (
              <div className="live-sessions">
                {dashboardData.activeSessions.map(session => (
                  <div key={session.id} className="live-session-card">
                    <div className="live-status">
                      <span className="pulse-dot"></span>
                      <span className="status-text">En direct</span>
                    </div>
                    <h4>{session.title}</h4>
                    <p className="subject">{session.subject_details?.name}</p>
                    <div className="participants">
                      <span>?? {session.participants_count || 0} participants</span>
                    </div>
                    <button 
                      className="btn-join-live"
                      onClick={() => navigate(`/live-session/${session.meeting_id}`)}
                    >
                      Rejoindre
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div className="no-live">
                <div className="live-icon">??</div>
                <p>Aucune session en cours</p>
                <button 
                  className="btn-start-live-sm"
                  onClick={() => navigate('/teacher/live-session/new')}
                >
                  Démarrer une session
                </button>
              </div>
            )}
          </div>

          {/* Activité Récente */}
          <div className="dashboard-card">
            <div className="card-header">
              <h2>?? Activité Récente</h2>
              <button className="btn-refresh" onClick={loadDashboardData}>
                ?? Actualiser
              </button>
            </div>
            <div className="activity-list">
              {recentActivity.map(activity => (
                <div key={activity.id} className="activity-item">
                  <div className="activity-icon">
                    {activity.type === 'course' ? '??' : 
                     activity.type === 'quiz' ? '??' : 
                     activity.type === 'live' ? '??' : '??'}
                  </div>
                  <div className="activity-content">
                    <div className="activity-title">
                      <strong>{activity.action === 'uploaded' ? 'Cours publié:' : 
                              activity.action === 'created' ? 'Quiz créé:' :
                              activity.action === 'conducted' ? 'Session live:' : 'Notes publiées:'}</strong>
                      {activity.title}
                    </div>
                    <div className="activity-meta">
                      <span className="subject">{activity.subject}</span>
                      <span className="time">{activity.time}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Actions Rapides */}
          <div className="dashboard-card quick-actions">
            <h2>? Actions Rapides</h2>
            <div className="actions-grid">
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/upload-course')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Publier un cours</span>
              </button>
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/create-test')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Créer un test</span>
              </button>
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/grade-tests')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Noter les copies</span>
              </button>
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/schedule')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Emploi du temps</span>
              </button>
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/announcements')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Annonce</span>
              </button>
              <button 
                className="action-btn"
                onClick={() => navigate('/teacher/analytics')}
              >
                <span className="action-icon">??</span>
                <span className="action-text">Analytiques</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Notifications */}
      <div className="notifications-section">
        <div className="dashboard-card">
          <h2>?? Notifications</h2>
          <div className="notifications-list">
            <div className="notification-item unread">
              <div className="notification-icon">??</div>
              <div className="notification-content">
                <p><strong>Ahmed Boudiaf</strong> a soumis le devoir "TP Algorithmique"</p>
                <span className="notification-time">Il y a 15 minutes</span>
              </div>
              <button className="btn-grade">Noter</button>
            </div>
            <div className="notification-item">
              <div className="notification-icon">??</div>
              <div className="notification-content">
                <p>Votre session live "Base de Données" commence dans 30 minutes</p>
                <span className="notification-time">Il y a 1 heure</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
} TeacherSchedule.jsx  // src/pages/teacher/TeacherSchedule.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { toast } from 'react-toastify';
import api from '../../services/api';
import './TeacherSchedule.css';

export default function TeacherSchedule() {
  const { user } = useAuth();
  const navigate = useNavigate();
  const [scheduleData, setScheduleData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState('week');
  const [showAddModal, setShowAddModal] = useState(false);
  const [newEvent, setNewEvent] = useState({
    title: '',
    subject: '',
    day: '',
    start_time: '08:30',
    end_time: '10:00',
    classroom: '',
    type: 'course'
  });
  const [subjects, setSubjects] = useState([]);

  useEffect(() => {
    loadSchedule();
    loadSubjects();
  }, []);

  const loadSchedule = async () => {
    try {
      const response = await api.get('/schedule/time-slots/');
      const teacherSlots = response.data.filter(slot => slot.teacher === user.id);
      setScheduleData(teacherSlots);
    } catch (error) {
      toast.error('Erreur chargement emploi du temps');
      console.error('Erreur:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadSubjects = async () => {
    try {
      const response = await api.get('/classes/subjects/');
      const teacherSubjects = response.data.filter(subject => subject.teacher === user.id);
      setSubjects(teacherSubjects);
    } catch (error) {
      console.error('Erreur chargement matières:', error);
    }
  };

  const handleAddEvent = async () => {
    try {
      const subject = subjects.find(s => s.id === parseInt(newEvent.subject));
      if (!subject) {
        toast.error('Matière non trouvée');
        return;
      }

      const eventData = {
        day: newEvent.day,
        start_time: newEvent.start_time,
        end_time: newEvent.end_time,
        subject: parseInt(newEvent.subject),
        teacher: user.id,
        classroom: newEvent.classroom,
        schedule: 1
      };

      await api.post('/schedule/time-slots/', eventData);
      toast.success('Cours ajouté avec succès');
      setShowAddModal(false);
      setNewEvent({
        title: '',
        subject: '',
        day: '',
        start_time: '08:30',
        end_time: '10:00',
        classroom: '',
        type: 'course'
      });
      loadSchedule();
    } catch (error) {
      console.error('Erreur:', error);
      toast.error('Erreur ajout cours: ' + (error.response?.data?.message || error.message));
    }
  };

  const handleDeleteEvent = async (eventId) => {
    if (!window.confirm('Supprimer ce créneau ?')) return;
    
    try {
      await api.delete(`/schedule/time-slots/${eventId}/`);
      toast.success('Créneau supprimé');
      loadSchedule();
    } catch (error) {
      toast.error('Erreur suppression');
    }
  };

  const startLiveSession = async (subjectId) => {
    try {
      const response = await api.post('/live-sessions/start/', { subject_id: subjectId });
      const sessionId = response.data.session_id;
      navigate(`/teacher/live/${sessionId}`);
    } catch (error) {
      toast.error('Erreur démarrage session live');
    }
  };

  const formatDaySchedule = () => {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const daySchedule = {};
    
    days.forEach(day => {
      daySchedule[day] = scheduleData
        .filter(slot => slot.day === day)
        .sort((a, b) => a.start_time.localeCompare(b.start_time));
    });
    
    return daySchedule;
  };

  const getEventColor = (subjectName) => {
    const colors = {
      'Algorithmique': '#FF6B6B',
      'Base de Données': '#4ECDC4',
      'Programmation Web': '#45B7D1',
      'Mathématiques': '#96CEB4',
      'Anglais': '#FFEAA7',
      'Systèmes': '#DDA0DD'
    };
    return colors[subjectName] || '#667eea';
  };

  const daySchedule = formatDaySchedule();

  if (loading) {
    return (
      <div className="schedule-loading">
        <div className="loading-spinner"></div>
        <p>Chargement de l'emploi du temps...</p>
      </div>
    );
  }

  return (
    <div className="teacher-schedule-container">
      {/* Header */}
      <div className="schedule-header">
        <button onClick={() => navigate('/teacher/dashboard')} className="back-btn">
          ? Retour
        </button>
        <div className="header-content">
          <h1>?? Mon Emploi du Temps</h1>
          <p>Gérez vos horaires de cours et sessions</p>
        </div>
        <div className="header-actions">
          <button 
            className="btn-add-event"
            onClick={() => setShowAddModal(true)}
          >
            + Ajouter un cours
          </button>
          <div className="view-toggle">
            <button 
              className={viewMode === 'week' ? 'active' : ''}
              onClick={() => setViewMode('week')}
            >
              Semaine
            </button>
            <button 
              className={viewMode === 'day' ? 'active' : ''}
              onClick={() => setViewMode('day')}
            >
              Jour
            </button>
            <button 
              className={viewMode === 'month' ? 'active' : ''}
              onClick={() => setViewMode('month')}
            >
              Mois
            </button>
          </div>
        </div>
      </div>

      {/* Statistiques */}
      <div className="schedule-stats">
        <div className="stat-card">
          <div className="stat-icon">??</div>
          <div className="stat-content">
            <h3>{scheduleData.length}</h3>
            <p>Cours/semaine</p>
          </div>
        </div>
        <div className="stat-card">
          <div className="stat-icon">??</div>
          <div className="stat-content">
            <h3>{[...new Set(scheduleData.map(s => s.subject_details?.class_name))].length}</h3>
            <p>Classes</p>
          </div>
        </div>
        <div className="stat-card">
          <div className="stat-icon">?</div>
          <div className="stat-content">
            <h3>{scheduleData.reduce((sum, slot) => {
              const start = new Date(`2000-01-01T${slot.start_time}`);
              const end = new Date(`2000-01-01T${slot.end_time}`);
              return sum + (end - start) / (1000 * 60 * 60);
            }, 0).toFixed(1)}h</h3>
            <p>Heures/semaine</p>
          </div>
        </div>
      </div>

      {/* Contenu principal - Vue semaine */}
      <div className="schedule-content">
        <div className="weekly-schedule">
          <div className="week-header">
            <h2>Semaine du {new Date().toLocaleDateString('fr-FR', { 
              day: '2-digit', 
              month: 'long', 
              year: 'numeric' 
            })}</h2>
            <div className="week-navigation">
              <button className="nav-btn">?</button>
              <span>Cette semaine</span>
              <button className="nav-btn">?</button>
            </div>
          </div>
          
          <div className="week-grid">
            {Object.entries(daySchedule).map(([day, slots]) => (
              <div key={day} className="day-column">
                <div className="day-header">
                  <h3>{getFrenchDay(day)}</h3>
                  <span className="slot-count">{slots.length} cours</span>
                </div>
                <div className="day-slots">
                  {slots.length > 0 ? (
                    slots.map(slot => (
                      <div 
                        key={slot.id} 
                        className="time-slot"
                        style={{ borderLeftColor: getEventColor(slot.subject_details?.name) }}
                      >
                        <div className="slot-time">
                          {slot.start_time.substring(0, 5)} - {slot.end_time.substring(0, 5)}
                        </div>
                        <div className="slot-content">
                          <h4>{slot.subject_details?.name || 'Sans nom'}</h4>
                          <p className="class-info">{slot.subject_details?.class_name || 'Sans classe'}</p>
                          {slot.classroom && (
                            <p className="classroom">?? {slot.classroom}</p>
                          )}
                        </div>
                        <div className="slot-actions">
                          <button 
                            className="btn-action"
                            onClick={() => handleDeleteEvent(slot.id)}
                            title="Supprimer"
                          >
                            ???
                          </button>
                          <button 
                            className="btn-action"
                            onClick={() => startLiveSession(slot.subject)}
                            title="Démarrer live"
                          >
                            ??
                          </button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="no-classes">
                      <p>Aucun cours</p>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Modal d'ajout */}
      {showAddModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="modal-header">
              <h2>? Ajouter un nouveau cours</h2>
              <button onClick={() => setShowAddModal(false)} className="close-btn">
                ×
              </button>
            </div>
            
            <div className="modal-body">
              <div className="form-group">
                <label>Titre du cours *</label>
                <input
                  type="text"
                  value={newEvent.title}
                  onChange={(e) => setNewEvent({...newEvent, title: e.target.value})}
                  placeholder="Ex: Introduction à Python"
                />
              </div>
              
              <div className="form-row">
                <div className="form-group">
                  <label>Matière *</label>
                  <select
                    value={newEvent.subject}
                    onChange={(e) => setNewEvent({...newEvent, subject: e.target.value})}
                    required
                  >
                    <option value="">Sélectionner une matière</option>
                    {subjects.map(subject => (
                      <option key={subject.id} value={subject.id}>
                        {subject.name} - {subject.class_name}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label>Jour *</label>
                  <select
                    value={newEvent.day}
                    onChange={(e) => setNewEvent({...newEvent, day: e.target.value})}
                    required
                  >
                    <option value="">Sélectionner un jour</option>
                    <option value="Monday">Lundi</option>
                    <option value="Tuesday">Mardi</option>
                    <option value="Wednesday">Mercredi</option>
                    <option value="Thursday">Jeudi</option>
                    <option value="Friday">Vendredi</option>
                    <option value="Saturday">Samedi</option>
                  </select>
                </div>
              </div>
              
              <div className="form-row">
                <div className="form-group">
                  <label>Heure de début *</label>
                  <input
                    type="time"
                    value={newEvent.start_time}
                    onChange={(e) => setNewEvent({...newEvent, start_time: e.target.value})}
                    required
                  />
                </div>
                
                <div className="form-group">
                  <label>Heure de fin *</label>
                  <input
                    type="time"
                    value={newEvent.end_time}
                    onChange={(e) => setNewEvent({...newEvent, end_time: e.target.value})}
                    required
                  />
                </div>
              </div>
              
              <div className="form-group">
                <label>Salle/Environnement</label>
                <input
                  type="text"
                  value={newEvent.classroom}
                  onChange={(e) => setNewEvent({...newEvent, classroom: e.target.value})}
                  placeholder="Ex: Salle 101 ou Teams Meeting"
                />
              </div>
              
              <div className="form-group">
                <label>Type de session</label>
                <div className="type-selector">
                  <button 
                    type="button"
                    className={`type-btn ${newEvent.type === 'course' ? 'active' : ''}`}
                    onClick={() => setNewEvent({...newEvent, type: 'course'})}
                  >
                    ?? Cours
                  </button>
                  <button 
                    type="button"
                    className={`type-btn ${newEvent.type === 'td' ? 'active' : ''}`}
                    onClick={() => setNewEvent({...newEvent, type: 'td'})}
                  >
                    ?? TD
                  </button>
                  <button 
                    type="button"
                    className={`type-btn ${newEvent.type === 'live' ? 'active' : ''}`}
                    onClick={() => setNewEvent({...newEvent, type: 'live'})}
                  >
                    ?? Live
                  </button>
                </div>
              </div>
            </div>
            
            <div className="modal-footer">
              <button 
                className="btn-cancel"
                onClick={() => setShowAddModal(false)}
              >
                Annuler
              </button>
              <button 
                className="btn-save"
                onClick={handleAddEvent}
                disabled={!newEvent.title || !newEvent.subject || !newEvent.day || !newEvent.start_time || !newEvent.end_time}
              >
                Ajouter le cours
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

const getFrenchDay = (englishDay) => {
  const days = {
    'Monday': 'Lundi',
    'Tuesday': 'Mardi',
    'Wednesday': 'Mercredi',
    'Thursday': 'Jeudi',
    'Friday': 'Vendredi',
    'Saturday': 'Samedi',
    'Sunday': 'Dimanche'
  };
  return days[englishDay] || englishDay;
};    TeacherSubjectManagement.jsx // src/pages/teacher/TeacherSubjectManagement.jsx
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../../context/AuthContext';
import { toast } from 'react-toastify';
import api from '../../services/api';


export default function TeacherSubjectManagement() {
  const { id } = useParams();
  const { user } = useAuth();
  const navigate = useNavigate();
  const [subject, setSubject] = useState(null);
  const [courses, setCourses] = useState([]);
  const [files, setFiles] = useState([]);
  const [students, setStudents] = useState([]);
  const [activeTab, setActiveTab] = useState('courses');
  const [loading, setLoading] = useState(true);
  const [showCourseModal, setShowCourseModal] = useState(false);
  const [newCourse, setNewCourse] = useState({
    title: '',
    description: '',
    files: []
  });
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    loadSubjectData();
  }, [id]);

  const loadSubjectData = async () => {
    try {
      const [subjectRes, coursesRes, classRes] = await Promise.all([
        api.get(`/classes/subjects/${id}/`),
        api.get('/courses/courses/', { params: { subject: id } }),
        api.get(`/classes/classes/${subjectRes.data.class_assigned}/`)
      ]);

      setSubject(subjectRes.data);
      setCourses(coursesRes.data);
      setStudents(classRes.data.students || []);

      // Récupérer les fichiers
      const allFiles = [];
      for (const course of coursesRes.data) {
        try {
          const filesRes = await api.get('/courses/files/', { params: { course: course.id } });
          allFiles.push(...filesRes.data.map(file => ({ ...file, course_title: course.title })));
        } catch (err) {
          console.error('Erreur fichiers:', err);
        }
      }
      setFiles(allFiles);

    } catch (error) {
      toast.error('Erreur chargement des données');
      navigate('/teacher/dashboard');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateCourse = async (e) => {
    e.preventDefault();
    setUploading(true);

    try {
      // Créer le cours
      const courseData = {
        title: newCourse.title,
        description: newCourse.description,
        subject: parseInt(id),
        teacher: user.id
      };

      const courseRes = await api.post('/courses/courses/', courseData);

      // Uploader les fichiers
      for (const file of newCourse.files) {
        const formData = new FormData();
        formData.append('course', courseRes.data.id);
        formData.append('file', file);
        formData.append('uploaded_by', user.id);

        await api.post('/courses/files/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
      }

      toast.success('Cours publié avec succès !');
      setShowCourseModal(false);
      setNewCourse({ title: '', description: '', files: [] });
      loadSubjectData();
    } catch (error) {
      toast.error('Erreur publication cours');
    } finally {
      setUploading(false);
    }
  };

  const handleFileUpload = (e) => {
    const selectedFiles = Array.from(e.target.files);
    setNewCourse(prev => ({
      ...prev,
      files: [...prev.files, ...selectedFiles]
    }));
  };

  const removeFile = (index) => {
    setNewCourse(prev => ({
      ...prev,
      files: prev.files.filter((_, i) => i !== index)
    }));
  };

  const deleteCourse = async (courseId) => {
    if (!window.confirm('Supprimer ce cours ?')) return;
    
    try {
      await api.delete(`/courses/courses/${courseId}/`);
      toast.success('Cours supprimé');
      loadSubjectData();
    } catch (error) {
      toast.error('Erreur suppression');
    }
  };

  const startLiveSession = async () => {
    try {
      const response = await api.post('/live/sessions/', {
        title: `Session Live - ${subject.name}`,
        description: 'Session en direct',
        subject: parseInt(id),
        start_time: new Date().toISOString(),
        max_participants: 50
      });

      await api.post(`/live/sessions/${response.data.id}/start/`);
      navigate(`/live-session/${response.data.meeting_id}`);
    } catch (error) {
      toast.error('Erreur démarrage session');
    }
  };

  const createTest = () => {
    navigate(`/teacher/create-test?subject=${id}`);
  };

  if (loading) {
    return (
      <div className="subject-loading">
        <div className="loading-spinner"></div>
        <p>Chargement de la matière...</p>
      </div>
    );
  }

  if (!subject) {
    return (
      <div className="subject-not-found">
        <h2>Matière non trouvée</h2>
        <button onClick={() => navigate('/teacher/dashboard')}>
          Retour au tableau de bord
        </button>
      </div>
    );
  }

  return (
    <div className="subject-management-container">
      {/* Header */}
      <div className="subject-header">
        <button onClick={() => navigate('/teacher/dashboard')} className="back-btn">
          ? Retour
        </button>
        <div className="subject-info">
          <div className="subject-title">
            <h1>{subject.name}</h1>
            <span className="class-code">{subject.class_name}</span>
          </div>
          <div className="subject-meta">
            <span className="meta-item">
              <span className="meta-icon">?????</span>
              {subject.teacher_name || user.username}
            </span>
            <span className="meta-item">
              <span className="meta-icon">??</span>
              {students.length} étudiants
            </span>
            <span className="meta-item">
              <span className="meta-icon">??</span>
              {courses.length} cours
            </span>
          </div>
        </div>
        <div className="subject-actions">
          <button className="btn-live" onClick={startLiveSession}>
            ?? Démarrer un live
          </button>
          <button className="btn-test" onClick={createTest}>
            ?? Créer un test
          </button>
          <button className="btn-announce">
            ?? Annonce
          </button>
        </div>
      </div>

      {/* Navigation */}
      <div className="subject-nav">
        <nav className="nav-tabs">
          <button 
            className={`nav-tab ${activeTab === 'courses' ? 'active' : ''}`}
            onClick={() => setActiveTab('courses')}
          >
            ?? Cours
          </button>
          <button 
            className={`nav-tab ${activeTab === 'files' ? 'active' : ''}`}
            onClick={() => setActiveTab('files')}
          >
            ?? Fichiers
          </button>
          <button 
            className={`nav-tab ${activeTab === 'students' ? 'active' : ''}`}
            onClick={() => setActiveTab('students')}
          >
            ?? Étudiants
          </button>
          <button 
            className={`nav-tab ${activeTab === 'chat' ? 'active' : ''}`}
            onClick={() => navigate(`/teacher/class/${subject.class_assigned}/chat`)}
          >
            ?? Chat
          </button>
          <button 
            className={`nav-tab ${activeTab === 'analytics' ? 'active' : ''}`}
            onClick={() => setActiveTab('analytics')}
          >
            ?? Analytics
          </button>
        </nav>
      </div>

      {/* Content */}
      <div className="subject-content">
        {activeTab === 'courses' && (
          <div className="courses-section">
            <div className="section-header">
              <h2>Cours publiés</h2>
              <button 
                className="btn-add-course"
                onClick={() => setShowCourseModal(true)}
              >
                + Nouveau cours
              </button>
            </div>
            
            {courses.length === 0 ? (
              <div className="empty-courses">
                <div className="empty-icon">??</div>
                <h3>Aucun cours publié</h3>
                <p>Commencez par publier votre premier cours</p>
                <button 
                  className="btn-add-first"
                  onClick={() => setShowCourseModal(true)}
                >
                  Publier un cours
                </button>
              </div>
            ) : (
              <div className="courses-grid">
                {courses.map(course => (
                  <div key={course.id} className="course-card">
                    <div className="course-header">
                      <h3>{course.title}</h3>
                      <div className="course-actions">
                        <button 
                          className="btn-edit"
                          onClick={() => {/* Éditer */}}
                        >
                          ??
                        </button>
                        <button 
                          className="btn-delete"
                          onClick={() => deleteCourse(course.id)}
                        >
                          ???
                        </button>
                      </div>
                    </div>
                    <div className="course-body">
                      <p className="course-description">{course.description}</p>
                      <div className="course-meta">
                        <span className="meta">
                          ?? Publié le {new Date(course.created_at).toLocaleDateString('fr-FR')}
                        </span>
                        <span className="meta">
                          ?? {files.filter(f => f.course === course.id).length} fichiers
                        </span>
                      </div>
                    </div>
                    <div className="course-footer">
                      <button 
                        className="btn-view-files"
                        onClick={() => setActiveTab('files')}
                      >
                        Voir les fichiers
                      </button>
                      <button className="btn-share">
                        Partager
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'files' && (
          <div className="files-section">
            <div className="section-header">
              <h2>Fichiers partagés</h2>
              <div className="file-actions">
                <input
                  type="text"
                  placeholder="?? Rechercher un fichier..."
                  className="search-input"
                />
                <button className="btn-upload">
                  ?? Uploader
                </button>
              </div>
            </div>
            
            {files.length === 0 ? (
              <div className="empty-files">
                <div className="empty-icon">??</div>
                <h3>Aucun fichier partagé</h3>
                <p>Les fichiers apparaîtront après publication de cours</p>
              </div>
            ) : (
              <div className="files-table">
                <div className="table-header">
                  <div className="col-name">Nom</div>
                  <div className="col-course">Cours</div>
                  <div className="col-date">Date</div>
                  <div className="col-size">Taille</div>
                  <div className="col-actions">Actions</div>
                </div>
                <div className="table-body">
                  {files.map(file => (
                    <div key={file.id} className="file-row">
                      <div className="col-name">
                        <div className="file-icon">
                          {getFileIcon(file.file)}
                        </div>
                        <div className="file-info">
                          <div className="file-name">
                            {file.file.split('/').pop()}
                          </div>
                          <div className="file-type">
                            {getFileType(file.file)}
                          </div>
                        </div>
                      </div>
                      <div className="col-course">
                        {file.course_title || 'N/A'}
                      </div>
                      <div className="col-date">
                        {new Date(file.uploaded_at).toLocaleDateString('fr-FR')}
                      </div>
                      <div className="col-size">
                        {(file.file_size || 0).toLocaleString()} KB
                      </div>
                      <div className="col-actions">
                        <button 
                          className="btn-download"
                          onClick={() => window.open(`http://localhost:8000${file.file}`, '_blank')}
                        >
                          ??
                        </button>
                        <button className="btn-share">
                          ??
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'students' && (
          <div className="students-section">
            <div className="section-header">
              <h2>Liste des étudiants</h2>
              <div className="student-stats">
                <span className="stat">{students.length} étudiants</span>
                <span className="stat">85% présence</span>
                <span className="stat">15.2 moyenne</span>
              </div>
            </div>
            
            <div className="students-table">
              <div className="table-header">
                <div className="col-student">Étudiant</div>
                <div className="col-email">Email</div>
                <div className="col-presence">Présence</div>
                <div className="col-moyenne">Moyenne</div>
                <div className="col-status">Status</div>
              </div>
              <div className="table-body">
                {students.map(student => (
                  <div key={student.id} className="student-row">
                    <div className="col-student">
                      <div className="student-avatar">
                        {student.first_name?.charAt(0) || student.username?.charAt(0)}
                      </div>
                      <div className="student-info">
                        <div className="student-name">
                          {student.first_name} {student.last_name}
                        </div>
                        <div className="student-username">
                          @{student.username}
                        </div>
                      </div>
                    </div>
                    <div className="col-email">
                      {student.email}
                    </div>
                    <div className="col-presence">
                      <div className="presence-bar">
                        <div 
                          className="presence-fill"
                          style={{ width: `${Math.random() * 100}%` }}
                        ></div>
                      </div>
                      <span className="presence-percent">
                        {Math.floor(Math.random() * 100)}%
                      </span>
                    </div>
                    <div className="col-moyenne">
                      <span className="grade-badge">
                        {Math.random() * 20 + 10 | 0}/20
                      </span>
                    </div>
                    <div className="col-status">
                      <span className="status active">
                        ? Actif
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeTab === 'analytics' && (
          <div className="analytics-section">
            <div className="analytics-grid">
              <div className="analytics-card">
                <h3>?? Performance générale</h3>
                <div className="stats">
                  <div className="stat-item">
                    <div className="stat-value">15.2</div>
                    <div className="stat-label">Moyenne classe</div>
                  </div>
                  <div className="stat-item">
                    <div className="stat-value">85%</div>
                    <div className="stat-label">Taux présence</div>
                  </div>
                  <div className="stat-item">
                    <div className="stat-value">92%</div>
                    <div className="stat-label">Taux réussite</div>
                  </div>
                </div>
              </div>
              
              <div className="analytics-card">
                <h3>?? Engagement</h3>
                <div className="engagement-chart">
                  {/* Graphique simple */}
                  <div className="chart-bars">
                    {[65, 80, 75, 90, 85, 95].map((height, i) => (
                      <div 
                        key={i}
                        className="chart-bar"
                        style={{ height: `${height}%` }}
                      ></div>
                    ))}
                  </div>
                  <div className="chart-labels">
                    <span>Lun</span>
                    <span>Mar</span>
                    <span>Mer</span>
                    <span>Jeu</span>
                    <span>Ven</span>
                    <span>Sam</span>
                  </div>
                </div>
              </div>
              
              <div className="analytics-card">
                <h3>?? Ressources utilisées</h3>
                <div className="resources-list">
                  <div className="resource-item">
                    <span className="resource-name">Cours Python</span>
                    <span className="resource-views">245 vues</span>
                  </div>
                  <div className="resource-item">
                    <span className="resource-name">TD Algorithmique</span>
                    <span className="resource-views">189 vues</span>
                  </div>
                  <div className="resource-item">
                    <span className="resource-name">Quiz DB</span>
                    <span className="resource-views">156 vues</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Modal nouveau cours */}
      {showCourseModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="modal-header">
              <h2>?? Publier un nouveau cours</h2>
              <button 
                className="close-btn"
                onClick={() => setShowCourseModal(false)}
              >
                ×
              </button>
            </div>
            
            <form onSubmit={handleCreateCourse}>
              <div className="modal-body">
                <div className="form-group">
                  <label>Titre du cours *</label>
                  <input
                    type="text"
                    value={newCourse.title}
                    onChange={(e) => setNewCourse({...newCourse, title: e.target.value})}
                    placeholder="Ex: Introduction à la programmation Python"
                    required
                  />
                </div>
                
                <div className="form-group">
                  <label>Description</label>
                  <textarea
                    value={newCourse.description}
                    onChange={(e) => setNewCourse({...newCourse, description: e.target.value})}
                    placeholder="Description détaillée du cours..."
                    rows="4"
                  />
                </div>
                
                <div className="form-group">
                  <label>Fichiers à joindre</label>
                  <div className="file-upload-area">
                    <label className="upload-label">
                      <input
                        type="file"
                        multiple
                        onChange={handleFileUpload}
                        disabled={uploading}
                      />
                      <div className="upload-box">
                        <div className="upload-icon">??</div>
                        <p>Glissez-déposez vos fichiers ici</p>
                        <p className="upload-hint">ou cliquez pour parcourir</p>
                      </div>
                    </label>
                    
                    {newCourse.files.length > 0 && (
                      <div className="files-list">
                        {newCourse.files.map((file, index) => (
                          <div key={index} className="file-item">
                            <div className="file-icon">
                              {getFileIcon(file.name)}
                            </div>
                            <div className="file-info">
                              <div className="file-name">{file.name}</div>
                              <div className="file-size">
                                {(file.size / 1024).toFixed(1)} KB
                              </div>
                            </div>
                            <button
                              type="button"
                              onClick={() => removeFile(index)}
                              className="remove-file"
                            >
                              ×
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
              
              <div className="modal-footer">
                <button
                  type="button"
                  className="btn-cancel"
                  onClick={() => setShowCourseModal(false)}
                  disabled={uploading}
                >
                  Annuler
                </button>
                <button
                  type="submit"
                  className="btn-publish"
                  disabled={uploading || !newCourse.title}
                >
                  {uploading ? 'Publication...' : 'Publier le cours'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

// Fonctions utilitaires
const getFileIcon = (filename) => {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    pdf: '??',
    doc: '??',
    docx: '??',
    ppt: '??',
    pptx: '??',
    xls: '??',
    xlsx: '??',
    zip: '???',
    rar: '???',
    jpg: '???',
    jpeg: '???',
    png: '???',
    mp4: '??',
    mp3: '??',
    txt: '??'
  };
  return icons[ext] || '??';
};

const getFileType = (filename) => {
  const ext = filename.split('.').pop().toLowerCase();
  return ext.toUpperCase();
};  UploadCourse.jsx // src/pages/teacher/UploadCourse.jsx
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../../services/api';

export default function UploadCourse() {
  const navigate = useNavigate();
  const [subjects, setSubjects] = useState([]);
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    subject: '',
    files: []
  });
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadSubjects();
  }, []);

  const loadSubjects = async () => {
    try {
      const res = await api.get('/classes/subjects/');
      // Filtrer seulement les matières de l'enseignant connecté
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const teacherSubjects = res.data.filter(subject => 
        subject.teacher === user.id
      );
      setSubjects(teacherSubjects);
    } catch (err) {
      toast.error('Erreur chargement matières');
    } finally {
      setLoading(false);
    }
  };

  const handleFileChange = (e) => {
    const files = Array.from(e.target.files);
    setFormData(prev => ({
      ...prev,
      files: [...prev.files, ...files]
    }));
  };

  const removeFile = (index) => {
    setFormData(prev => ({
      ...prev,
      files: prev.files.filter((_, i) => i !== index)
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!formData.subject || !formData.title) {
      toast.error('Titre et matière requis');
      return;
    }

    setUploading(true);
    setUploadProgress(0);

    try {
      // 1. Créer le cours
      const courseRes = await api.post('/courses/courses/', {
        title: formData.title,
        description: formData.description,
        subject: formData.subject
      });

      const courseId = courseRes.data.id;

      // 2. Uploader les fichiers
      for (let i = 0; i < formData.files.length; i++) {
        const file = formData.files[i];
        const formDataFile = new FormData();
        formDataFile.append('course', courseId);
        formDataFile.append('file', file);

        await api.post('/courses/files/', formDataFile, {
          headers: { 'Content-Type': 'multipart/form-data' },
          onUploadProgress: (progressEvent) => {
            const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
            setUploadProgress(progress);
          }
        });

        // Mettre à jour la progression
        const progress = Math.round(((i + 1) / formData.files.length) * 100);
        setUploadProgress(progress);
      }

      toast.success('Cours publié avec succès !');
      navigate('/teacher/dashboard');

    } catch (err) {
      console.error('Erreur:', err.response?.data || err);
      toast.error('Erreur lors de la publication du cours');
    } finally {
      setUploading(false);
      setUploadProgress(0);
    }
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Chargement des matières...</p>
      </div>
    );
  }

  if (subjects.length === 0) {
    return (
      <div className="empty-subjects">
        <div className="empty-icon">??</div>
        <h2>Aucune matière assignée</h2>
        <p>Vous devez être assigné à une matière pour publier des cours</p>
        <button onClick={() => navigate('/teacher/dashboard')} className="btn-back">
          Retour au tableau de bord
        </button>
      </div>
    );
  }

  return (
    <div className="upload-course-container">
      <div className="upload-header">
        <button onClick={() => navigate('/teacher/dashboard')} className="back-btn">
          ? Retour
        </button>
        <h1>?? Publier un nouveau cours</h1>
        <p>Partagez des ressources pédagogiques avec vos étudiants</p>
      </div>

      <div className="upload-content">
        <form onSubmit={handleSubmit} className="upload-form">
          {/* Section informations */}
          <div className="form-section">
            <h2>Informations du cours</h2>
            
            <div className="form-group">
              <label>Titre du cours *</label>
              <input
                type="text"
                value={formData.title}
                onChange={(e) => setFormData({...formData, title: e.target.value})}
                placeholder="Ex: Introduction à l'algorithmique"
                required
                disabled={uploading}
              />
            </div>

            <div className="form-group">
              <label>Matière *</label>
              <select
                value={formData.subject}
                onChange={(e) => setFormData({...formData, subject: e.target.value})}
                required
                disabled={uploading}
              >
                <option value="">Sélectionnez une matière</option>
                {subjects.map(subject => (
                  <option key={subject.id} value={subject.id}>
                    {subject.name} - {subject.class_name}
                  </option>
                ))}
              </select>
            </div>

            <div className="form-group">
              <label>Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({...formData, description: e.target.value})}
                placeholder="Décrivez le contenu de ce cours..."
                rows="4"
                disabled={uploading}
              />
            </div>
          </div>

          {/* Section fichiers */}
          <div className="form-section">
            <h2>Fichiers à partager</h2>
            
            <div className="file-upload-area">
              <div className="upload-dropzone">
                <input
                  type="file"
                  id="file-upload"
                  multiple
                  onChange={handleFileChange}
                  disabled={uploading}
                  style={{ display: 'none' }}
                />
                <label htmlFor="file-upload" className="upload-label">
                  <div className="upload-icon">??</div>
                  <h3>Glissez-déposez vos fichiers ici</h3>
                  <p>ou cliquez pour parcourir</p>
                  <p className="upload-hint">
                    Formats acceptés: PDF, DOC, PPT, ZIP, Images, Vidéos
                  </p>
                </label>
              </div>

              {/* Liste des fichiers */}
              {formData.files.length > 0 && (
                <div className="file-list">
                  <h4>Fichiers sélectionnés ({formData.files.length})</h4>
                  <div className="files-grid">
                    {formData.files.map((file, index) => (
                      <div key={index} className="file-item">
                        <div className="file-icon">
                          {getFileIcon(file.name)}
                        </div>
                        <div className="file-info">
                          <div className="file-name">{file.name}</div>
                          <div className="file-size">
                            {(file.size / 1024 / 1024).toFixed(2)} MB
                          </div>
                        </div>
                        <button
                          type="button"
                          onClick={() => removeFile(index)}
                          className="remove-file-btn"
                          disabled={uploading}
                        >
                          ?
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Barre de progression */}
          {uploading && (
            <div className="upload-progress">
              <div className="progress-label">
                Publication en cours... {uploadProgress}%
              </div>
              <div className="progress-bar">
                <div 
                  className="progress-fill"
                  style={{ width: `${uploadProgress}%` }}
                ></div>
              </div>
              <p className="progress-hint">
                Ne quittez pas cette page pendant l'upload
              </p>
            </div>
          )}

          {/* Boutons d'action */}
          <div className="form-actions">
            <button
              type="button"
              onClick={() => navigate('/teacher/dashboard')}
              className="btn-cancel"
              disabled={uploading}
            >
              Annuler
            </button>
            <button
              type="submit"
              className="btn-submit"
              disabled={uploading || !formData.subject || !formData.title}
            >
              {uploading ? 'Publication...' : '?? Publier le cours'}
            </button>
          </div>
        </form>

        {/* Informations */}
        <div className="upload-info">
          <h3>?? Conseils pour un bon cours</h3>
          <ul>
            <li>Utilisez un titre clair et descriptif</li>
            <li>Organisez vos fichiers par thème</li>
            <li>Privilégiez les formats compatibles (PDF)</li>
            <li>Limitez la taille des fichiers à 100MB</li>
            <li>Ajoutez une description pour guider les étudiants</li>
          </ul>

          <h3>?? Statistiques de publication</h3>
          <div className="stats-grid">
            <div className="stat-item">
              <div className="stat-value">24h</div>
              <div className="stat-label">Délai de modération</div>
            </div>
            <div className="stat-item">
              <div className="stat-value">100MB</div>
              <div className="stat-label">Limite par fichier</div>
            </div>
            <div className="stat-item">
              <div className="stat-value">10</div>
              <div className="stat-label">Fichiers max</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function getFileIcon(filename) {
  const extension = filename.split('.').pop().toLowerCase();
  
  switch (extension) {
    case 'pdf':
      return '??';
    case 'doc':
    case 'docx':
      return '??';
    case 'ppt':
    case 'pptx':
      return '??';
    case 'xls':
    case 'xlsx':
      return '??';
    case 'zip':
    case 'rar':
      return '???';
    case 'jpg':
    case 'jpeg':
    case 'png':
    case 'gif':
      return '???';
    case 'mp4':
    case 'avi':
    case 'mov':
      return '??';
    case 'mp3':
    case 'wav':
      return '??';
    default:
      return '??';
  }
}   