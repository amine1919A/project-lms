
/**
 * @license agora-rtc-react
 * @version 2.5.1
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */

"use strict";var AgoraRTC=(()=>{var g8=Object.create;var Dp=Object.defineProperty;var S8=Object.getOwnPropertyDescriptor;var T8=Object.getOwnPropertyNames;var R8=Object.getPrototypeOf,C8=Object.prototype.hasOwnProperty;var Pp=(M,F)=>()=>(F||M((F={exports:{}}).exports,F),F.exports),v8=(M,F)=>{for(var H in F)Dp(M,H,{get:F[H],enumerable:!0})},Np=(M,F,H,z)=>{if(F&&typeof F=="object"||typeof F=="function")for(let ot of T8(F))!C8.call(M,ot)&&ot!==H&&Dp(M,ot,{get:()=>F[ot],enumerable:!(z=S8(F,ot))||z.enumerable});return M},lo=(M,F,H)=>(Np(M,F,"default"),H&&Np(H,F,"default")),Bt=(M,F,H)=>(H=M!=null?g8(R8(M)):{},Np(F||!M||!M.__esModule?Dp(H,"default",{value:M,enumerable:!0}):H,M)),y8=M=>Np(Dp({},"__esModule",{value:!0}),M);var us=Pp((US,xS)=>{"use strict";(function(M,F){typeof US=="object"&&typeof xS<"u"?xS.exports=F():typeof define=="function"&&define.amd?define(F):(M=typeof globalThis<"u"?globalThis:M||self).AgoraRTC=F()})(US,function(){"use strict";function M(t,e){return e.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(i){if(i!=="default"&&!(i in t)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}})}),Object.freeze(t)}var F=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function H(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var z=function(t){try{return!!t()}catch{return!0}},ot=!z(function(){var t=function(){}.bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),bt=ot,_t=Function.prototype,de=_t.call,Jt=bt&&_t.bind.bind(de,de),ft=bt?Jt:function(t){return function(){return de.apply(t,arguments)}},At=ft({}.isPrototypeOf),ee=function(t){return t&&t.Math===Math&&t},xt=ee(typeof globalThis=="object"&&globalThis)||ee(typeof window=="object"&&window)||ee(typeof self=="object"&&self)||ee(typeof F=="object"&&F)||ee(typeof F=="object"&&F)||function(){return this}()||Function("return this")(),fn=ot,sn=Function.prototype,lt=sn.apply,vt=sn.call,Te=typeof Reflect=="object"&&Reflect.apply||(fn?vt.bind(lt):function(){return vt.apply(lt,arguments)}),Ni=ft,Jn=Ni({}.toString),ho=Ni("".slice),vn=function(t){return ho(Jn(t),8,-1)},WL=vn,HL=ft,zc=function(t){if(WL(t)==="Function")return HL(t)},t_=typeof document=="object"&&document.all,an=t_===void 0&&t_!==void 0?function(t){return typeof t=="function"||t===t_}:function(t){return typeof t=="function"},wl={},Qn=!z(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),KL=ot,Ol=Function.prototype.call,hn=KL?Ol.bind(Ol):function(){return Ol.apply(Ol,arguments)},Nl={},KS={}.propertyIsEnumerable,YS=Object.getOwnPropertyDescriptor,YL=YS&&!KS.call({1:2},1);Nl.f=YL?function(t){var e=YS(this,t);return!!e&&e.enumerable}:KS;var wo,Dl,Oo=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},qL=z,zL=vn,e_=Object,XL=ft("".split),Pl=qL(function(){return!e_("z").propertyIsEnumerable(0)})?function(t){return zL(t)==="String"?XL(t,""):e_(t)}:e_,Ll=function(t){return t==null},JL=Ll,QL=TypeError,No=function(t){if(JL(t))throw new QL("Can't call method on "+t);return t},ZL=Pl,$L=No,Do=function(t){return ZL($L(t))},tk=an,Dn=function(t){return typeof t=="object"?t!==null:tk(t)},pi={},n_=pi,i_=xt,ek=an,qS=function(t){return ek(t)?t:void 0},Bn=function(t,e){return arguments.length<2?qS(n_[t])||qS(i_[t]):n_[t]&&n_[t][e]||i_[t]&&i_[t][e]},zS=xt.navigator,XS=zS&&zS.userAgent,po=XS?String(XS):"",JS=xt,r_=po,QS=JS.process,ZS=JS.Deno,$S=QS&&QS.versions||ZS&&ZS.version,tT=$S&&$S.v8;tT&&(Dl=(wo=tT.split("."))[0]>0&&wo[0]<4?1:+(wo[0]+wo[1])),!Dl&&r_&&(!(wo=r_.match(/Edge\/(\d+)/))||wo[1]>=74)&&(wo=r_.match(/Chrome\/(\d+)/))&&(Dl=+wo[1]);var Es=Dl,eT=Es,nk=z,ik=xt.String,ma=!!Object.getOwnPropertySymbols&&!nk(function(){var t=Symbol("symbol detection");return!ik(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&eT&&eT<41}),nT=ma&&!Symbol.sham&&typeof Symbol.iterator=="symbol",rk=Bn,ok=an,sk=At,ak=Object,Xc=nT?function(t){return typeof t=="symbol"}:function(t){var e=rk("Symbol");return ok(e)&&sk(e.prototype,ak(t))},ck=String,Ea=function(t){try{return ck(t)}catch{return"Object"}},dk=an,lk=Ea,uk=TypeError,_i=function(t){if(dk(t))return t;throw new uk(lk(t)+" is not a function")},hk=_i,pk=Ll,Jc=function(t,e){var n=t[e];return pk(n)?void 0:hk(n)},o_=hn,s_=an,a_=Dn,_k=TypeError,iT={exports:{}},rT=xt,mk=Object.defineProperty,Ek=xt,fk=function(t,e){try{mk(rT,t,{value:e,configurable:!0,writable:!0})}catch{rT[t]=e}return e},oT="__core-js_shared__",sT=iT.exports=Ek[oT]||fk(oT,{});(sT.versions||(sT.versions=[])).push({version:"3.46.0",mode:"pure",copyright:"\xA9 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var c_=iT.exports,aT=c_,fa=function(t,e){return aT[t]||(aT[t]=e||{})},gk=No,Sk=Object,pr=function(t){return Sk(gk(t))},Tk=pr,Rk=ft({}.hasOwnProperty),yn=Object.hasOwn||function(t,e){return Rk(Tk(t),e)},Ck=ft,vk=0,yk=Math.random(),Ik=Ck(1.1.toString),d_=function(t){return"Symbol("+(t===void 0?"":t)+")_"+Ik(++vk+yk,36)},Ak=fa,cT=yn,bk=d_,wk=ma,Ok=nT,ga=xt.Symbol,l_=Ak("wks"),Nk=Ok?ga.for||ga:ga&&ga.withoutSetter||bk,Me=function(t){return cT(l_,t)||(l_[t]=wk&&cT(ga,t)?ga[t]:Nk("Symbol."+t)),l_[t]},Dk=hn,dT=Dn,lT=Xc,Pk=Jc,Lk=function(t,e){var n,i;if(e==="string"&&s_(n=t.toString)&&!a_(i=o_(n,t))||s_(n=t.valueOf)&&!a_(i=o_(n,t))||e!=="string"&&s_(n=t.toString)&&!a_(i=o_(n,t)))return i;throw new _k("Can't convert object to primitive value")},kk=TypeError,Mk=Me("toPrimitive"),Uk=function(t,e){if(!dT(t)||lT(t))return t;var n,i=Pk(t,Mk);if(i){if(e===void 0&&(e="default"),n=Dk(i,t,e),!dT(n)||lT(n))return n;throw new kk("Can't convert object to primitive value")}return e===void 0&&(e="number"),Lk(t,e)},xk=Xc,u_=function(t){var e=Uk(t,"string");return xk(e)?e:e+""},uT=Dn,h_=xt.document,Vk=uT(h_)&&uT(h_.createElement),p_=function(t){return Vk?h_.createElement(t):{}},Fk=p_,hT=!Qn&&!z(function(){return Object.defineProperty(Fk("div"),"a",{get:function(){return 7}}).a!==7}),Bk=Qn,jk=hn,Gk=Nl,Wk=Oo,Hk=Do,Kk=u_,Yk=yn,qk=hT,pT=Object.getOwnPropertyDescriptor;wl.f=Bk?pT:function(t,e){if(t=Hk(t),e=Kk(e),qk)try{return pT(t,e)}catch{}if(Yk(t,e))return Wk(!jk(Gk.f,t,e),t[e])};var zk=z,Xk=an,Jk=/#|\.prototype\./,Qc=function(t,e){var n=Zk[Qk(t)];return n===t1||n!==$k&&(Xk(e)?zk(e):!!e)},Qk=Qc.normalize=function(t){return String(t).replace(Jk,".").toLowerCase()},Zk=Qc.data={},$k=Qc.NATIVE="N",t1=Qc.POLYFILL="P",_T=Qc,e1=_i,n1=ot,i1=zc(zc.bind),Po=function(t,e){return e1(t),e===void 0?t:n1?i1(t,e):function(){return t.apply(e,arguments)}},Ki={},mT=Qn&&z(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),r1=Dn,o1=String,s1=TypeError,ri=function(t){if(r1(t))return t;throw new s1(o1(t)+" is not an object")},a1=Qn,c1=hT,d1=mT,kl=ri,ET=u_,l1=TypeError,__=Object.defineProperty,u1=Object.getOwnPropertyDescriptor,m_="enumerable",E_="configurable",f_="writable";Ki.f=a1?d1?function(t,e,n){if(kl(t),e=ET(e),kl(n),typeof t=="function"&&e==="prototype"&&"value"in n&&f_ in n&&!n[f_]){var i=u1(t,e);i&&i[f_]&&(t[e]=n.value,n={configurable:E_ in n?n[E_]:i[E_],enumerable:m_ in n?n[m_]:i[m_],writable:!1})}return __(t,e,n)}:__:function(t,e,n){if(kl(t),e=ET(e),kl(n),c1)try{return __(t,e,n)}catch{}if("get"in n||"set"in n)throw new l1("Accessors not supported");return"value"in n&&(t[e]=n.value),t};var h1=Ki,p1=Oo,fs=Qn?function(t,e,n){return h1.f(t,e,p1(1,n))}:function(t,e,n){return t[e]=n,t},Zc=xt,_1=Te,m1=zc,E1=an,f1=wl.f,g1=_T,Sa=pi,S1=Po,Ta=fs,fT=yn,T1=function(t){var e=function(n,i,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,i)}return new t(n,i,r)}return _1(t,this,arguments)};return e.prototype=t.prototype,e},Yt=function(t,e){var n,i,r,o,s,a,c,d,l,u=t.target,h=t.global,p=t.stat,S=t.proto,E=h?Zc:p?Zc[u]:Zc[u]&&Zc[u].prototype,f=h?Sa:Sa[u]||Ta(Sa,u,{})[u],R=f.prototype;for(o in e)i=!(n=g1(h?o:u+(p?".":"#")+o,t.forced))&&E&&fT(E,o),a=f[o],i&&(c=t.dontCallGetSet?(l=f1(E,o))&&l.value:E[o]),s=i&&c?c:e[o],(n||S||typeof a!=typeof s)&&(d=t.bind&&i?S1(s,Zc):t.wrap&&i?T1(s):S&&E1(s)?m1(s):s,(t.sham||s&&s.sham||a&&a.sham)&&Ta(d,"sham",!0),Ta(f,o,d),S&&(fT(Sa,r=u+"Prototype")||Ta(Sa,r,{}),Ta(Sa[r],o,s),t.real&&R&&(n||!R[o])&&Ta(R,o,s)))},R1=Math.ceil,C1=Math.floor,v1=Math.trunc||function(t){var e=+t;return(e>0?C1:R1)(e)},y1=v1,g_=function(t){var e=+t;return e!=e||e===0?0:y1(e)},I1=g_,A1=Math.max,b1=Math.min,S_=function(t,e){var n=I1(t);return n<0?A1(n+e,0):b1(n,e)},w1=g_,O1=Math.min,gT=function(t){var e=w1(t);return e>0?O1(e,9007199254740991):0},N1=gT,Lo=function(t){return N1(t.length)},D1=Do,P1=S_,L1=Lo,ST=function(t){return function(e,n,i){var r=D1(e),o=L1(r);if(o===0)return!t&&-1;var s,a=P1(i,o);if(t&&n!=n){for(;o>a;)if((s=r[a++])!=s)return!0}else for(;o>a;a++)if((t||a in r)&&r[a]===n)return t||a||0;return!t&&-1}},T_={includes:ST(!0),indexOf:ST(!1)},k1=T_.includes;Yt({target:"Array",proto:!0,forced:z(function(){return!Array(1).includes()})},{includes:function(t){return k1(this,t,arguments.length>1?arguments[1]:void 0)}});var M1=xt,U1=pi,Di=function(t,e){var n=U1[t+"Prototype"],i=n&&n[e];if(i)return i;var r=M1[t],o=r&&r.prototype;return o&&o[e]},x1=Di("Array","includes"),V1=Dn,F1=vn,B1=Me("match"),R_=function(t){var e;return V1(t)&&((e=t[B1])!==void 0?!!e:F1(t)==="RegExp")},j1=R_,G1=TypeError,TT={};TT[Me("toStringTag")]="z";var C_=String(TT)==="[object z]",W1=C_,H1=an,Ml=vn,K1=Me("toStringTag"),Y1=Object,q1=Ml(function(){return arguments}())==="Arguments",ko=W1?Ml:function(t){var e,n,i;return t===void 0?"Undefined":t===null?"Null":typeof(n=function(r,o){try{return r[o]}catch{}}(e=Y1(t),K1))=="string"?n:q1?Ml(e):(i=Ml(e))==="Object"&&H1(e.callee)?"Arguments":i},z1=ko,X1=String,oi=function(t){if(z1(t)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return X1(t)},J1=Me("match"),Q1=Yt,Z1=function(t){if(j1(t))throw new G1("The method doesn't accept regular expressions");return t},$1=No,RT=oi,tM=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[J1]=!1,"/./"[t](e)}catch{}}return!1},eM=ft("".indexOf);Q1({target:"String",proto:!0,forced:!tM("includes")},{includes:function(t){return!!~eM(RT($1(this)),RT(Z1(t)),arguments.length>1?arguments[1]:void 0)}});var nM=Di("String","includes"),CT=At,iM=x1,rM=nM,v_=Array.prototype,y_=String.prototype,oM=function(t){var e=t.includes;return t===v_||CT(v_,t)&&e===v_.includes?iM:typeof t=="string"||t===y_||CT(y_,t)&&e===y_.includes?rM:e},B=H(oM),sM=_i,aM=pr,cM=Pl,dM=Lo,vT=TypeError,yT="Reduce of empty array with no initial value",IT=function(t){return function(e,n,i,r){var o=aM(e),s=cM(o),a=dM(o);if(sM(n),a===0&&i<2)throw new vT(yT);var c=t?a-1:0,d=t?-1:1;if(i<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw new vT(yT)}for(;t?c>=0:a>c;c+=d)c in s&&(r=n(r,s[c],c,o));return r}},lM={left:IT(!1),right:IT(!0)},uM=z,Ul=function(t,e){var n=[][t];return!!n&&uM(function(){n.call(null,e||function(){return 1},1)})},$c=xt,hM=po,pM=vn,xl=function(t){return hM.slice(0,t.length)===t},I_=xl("Bun/")?"BUN":xl("Cloudflare-Workers")?"CLOUDFLARE":xl("Deno/")?"DENO":xl("Node.js/")?"NODE":$c.Bun&&typeof Bun.version=="string"?"BUN":$c.Deno&&typeof Deno.version=="object"?"DENO":pM($c.process)==="process"?"NODE":$c.window&&$c.document?"BROWSER":"REST",Vl=I_==="NODE",_M=lM.left;Yt({target:"Array",proto:!0,forced:!Vl&&Es>79&&Es<83||!Ul("reduce")},{reduce:function(t){var e=arguments.length;return _M(this,t,e,e>1?arguments[1]:void 0)}});var mM=Di("Array","reduce"),EM=At,fM=mM,A_=Array.prototype,gM=function(t){var e=t.reduce;return t===A_||EM(A_,t)&&e===A_.reduce?fM:e},AT=gM,Pi=H(AT),SM=vn,td=Array.isArray||function(t){return SM(t)==="Array"},TM=Yt,RM=td,CM=ft([].reverse),bT=[1,2];TM({target:"Array",proto:!0,forced:String(bT)===String(bT.reverse())},{reverse:function(){return RM(this)&&(this.length=this.length),CM(this)}});var vM=Di("Array","reverse"),yM=At,IM=vM,b_=Array.prototype,AM=function(t){var e=t.reverse;return t===b_||yM(b_,t)&&e===b_.reverse?IM:e},wT=AM,OT=H(wT),bM=d_,NT=fa("keys"),Fl=function(t){return NT[t]||(NT[t]=bM(t))},wM=!z(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),OM=yn,NM=an,DM=pr,PM=wM,DT=Fl("IE_PROTO"),w_=Object,LM=w_.prototype,O_=PM?w_.getPrototypeOf:function(t){var e=DM(t);if(OM(e,DT))return e[DT];var n=e.constructor;return NM(n)&&e instanceof n?n.prototype:e instanceof w_?LM:null},kM=ft,MM=_i,UM=Dn,xM=function(t){return UM(t)||t===null},VM=String,FM=TypeError,BM=function(t,e,n){try{return kM(MM(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}},jM=Dn,GM=No,WM=function(t){if(xM(t))return t;throw new FM("Can't set "+VM(t)+" as a prototype")},HM=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=BM(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(i,r){return GM(i),WM(r),jM(i)&&(e?t(i,r):i.__proto__=r),i}}():void 0),Bl={},jl={},N_=yn,KM=Do,YM=T_.indexOf,qM=jl,PT=ft([].push),LT=function(t,e){var n,i=KM(t),r=0,o=[];for(n in i)!N_(qM,n)&&N_(i,n)&&PT(o,n);for(;e.length>r;)N_(i,n=e[r++])&&(~YM(o,n)||PT(o,n));return o},D_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],zM=LT,XM=D_.concat("length","prototype");Bl.f=Object.getOwnPropertyNames||function(t){return zM(t,XM)};var ed={};ed.f=Object.getOwnPropertySymbols;var JM=Bn,QM=Bl,ZM=ed,$M=ri,tU=ft([].concat),eU=JM("Reflect","ownKeys")||function(t){var e=QM.f($M(t)),n=ZM.f;return n?tU(e,n(t)):e},kT=yn,nU=eU,iU=wl,rU=Ki,P_={},oU=LT,sU=D_,Gl=Object.keys||function(t){return oU(t,sU)},aU=Qn,cU=mT,dU=Ki,lU=ri,uU=Do,hU=Gl;P_.f=aU&&!cU?Object.defineProperties:function(t,e){lU(t);for(var n,i=uU(e),r=hU(e),o=r.length,s=0;o>s;)dU.f(t,n=r[s++],i[n]);return t};var Wl,MT=Bn("document","documentElement"),pU=ri,_U=P_,UT=D_,mU=jl,EU=MT,fU=p_,L_="prototype",k_="script",xT=Fl("IE_PROTO"),M_=function(){},VT=function(t){return"<"+k_+">"+t+"</"+k_+">"},FT=function(t){t.write(VT("")),t.close();var e=t.parentWindow.Object;return t=null,e},Hl=function(){try{Wl=new ActiveXObject("htmlfile")}catch{}var t,e,n;Hl=typeof document<"u"?document.domain&&Wl?FT(Wl):(e=fU("iframe"),n="java"+k_+":",e.style.display="none",EU.appendChild(e),e.src=String(n),(t=e.contentWindow.document).open(),t.write(VT("document.F=Object")),t.close(),t.F):FT(Wl);for(var i=UT.length;i--;)delete Hl[L_][UT[i]];return Hl()};mU[xT]=!0;var nd=Object.create||function(t,e){var n;return t!==null?(M_[L_]=pU(t),n=new M_,M_[L_]=null,n[xT]=t):n=Hl(),e===void 0?n:_U.f(n,e)},gU=Dn,SU=fs,BT=Error,TU=ft("".replace),RU=String(new BT("zxcasd").stack),jT=/\n\s*at [^:]*:[^\n]*/,CU=jT.test(RU),vU=Oo,yU=!z(function(){var t=new Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",vU(1,7)),t.stack!==7)}),IU=fs,AU=function(t,e){if(CU&&typeof t=="string"&&!BT.prepareStackTrace)for(;e--;)t=TU(t,jT,"");return t},bU=yU,GT=Error.captureStackTrace,Ra={},wU=Ra,OU=Me("iterator"),NU=Array.prototype,WT=function(t){return t!==void 0&&(wU.Array===t||NU[OU]===t)},DU=ko,HT=Jc,PU=Ll,LU=Ra,kU=Me("iterator"),Kl=function(t){if(!PU(t))return HT(t,kU)||HT(t,"@@iterator")||LU[DU(t)]},MU=hn,UU=_i,xU=ri,VU=Ea,FU=Kl,BU=TypeError,U_=function(t,e){var n=arguments.length<2?FU(t):e;if(UU(n))return xU(MU(n,t));throw new BU(VU(t)+" is not iterable")},jU=hn,KT=ri,GU=Jc,YT=function(t,e,n){var i,r;KT(t);try{if(!(i=GU(t,"return"))){if(e==="throw")throw n;return n}i=jU(i,t)}catch(o){r=!0,i=o}if(e==="throw")throw n;if(r)throw i;return KT(i),n},WU=Po,HU=hn,KU=ri,YU=Ea,qU=WT,zU=Lo,qT=At,XU=U_,JU=Kl,zT=YT,QU=TypeError,Yl=function(t,e){this.stopped=t,this.result=e},XT=Yl.prototype,id=function(t,e,n){var i,r,o,s,a,c,d,l=n&&n.that,u=!(!n||!n.AS_ENTRIES),h=!(!n||!n.IS_RECORD),p=!(!n||!n.IS_ITERATOR),S=!(!n||!n.INTERRUPTED),E=WU(e,l),f=function(v){return i&&zT(i,"normal"),new Yl(!0,v)},R=function(v){return u?(KU(v),S?E(v[0],v[1],f):E(v[0],v[1])):S?E(v,f):E(v)};if(h)i=t.iterator;else if(p)i=t;else{if(!(r=JU(t)))throw new QU(YU(t)+" is not iterable");if(qU(r)){for(o=0,s=zU(t);s>o;o++)if((a=R(t[o]))&&qT(XT,a))return a;return new Yl(!1)}i=XU(t,r)}for(c=h?t.next:i.next;!(d=HU(c,i)).done;){try{a=R(d.value)}catch(v){zT(i,"throw",v)}if(typeof a=="object"&&a&&qT(XT,a))return a}return new Yl(!1)},ZU=oi,$U=Yt,t2=At,e2=O_,ql=HM,n2=function(t,e,n){for(var i=nU(e),r=rU.f,o=iU.f,s=0;s<i.length;s++){var a=i[s];kT(t,a)||n&&kT(n,a)||r(t,a,o(e,a))}},JT=nd,x_=fs,V_=Oo,i2=function(t,e){gU(e)&&"cause"in e&&SU(t,"cause",e.cause)},r2=function(t,e,n,i){bU&&(GT?GT(t,e):IU(t,"stack",AU(n,i)))},o2=id,s2=function(t,e){return t===void 0?arguments.length<2?"":e:ZU(t)},a2=Me("toStringTag"),zl=Error,c2=[].push,Ca=function(t,e){var n,i=t2(F_,this);ql?n=ql(new zl,i?e2(this):F_):(n=i?this:JT(F_),x_(n,a2,"Error")),e!==void 0&&x_(n,"message",s2(e)),r2(n,Ca,n.stack,1),arguments.length>2&&i2(n,arguments[2]);var r=[];return o2(t,c2,{that:r}),x_(n,"errors",r),n};ql?ql(Ca,zl):n2(Ca,zl,{name:!0});var F_=Ca.prototype=JT(zl.prototype,{constructor:V_(1,Ca),message:V_(1,""),name:V_(1,"AggregateError")});$U({global:!0,constructor:!0,arity:2},{AggregateError:Ca});var Xl,rd,Jl,d2=an,QT=xt.WeakMap,l2=d2(QT)&&/native code/.test(String(QT)),ZT=xt,u2=Dn,h2=fs,B_=yn,j_=c_,p2=Fl,_2=jl,$T="Object already initialized",G_=ZT.TypeError,m2=ZT.WeakMap;if(l2||j_.state){var Br=j_.state||(j_.state=new m2);Br.get=Br.get,Br.has=Br.has,Br.set=Br.set,Xl=function(t,e){if(Br.has(t))throw new G_($T);return e.facade=t,Br.set(t,e),e},rd=function(t){return Br.get(t)||{}},Jl=function(t){return Br.has(t)}}else{var va=p2("state");_2[va]=!0,Xl=function(t,e){if(B_(t,va))throw new G_($T);return e.facade=t,h2(t,va,e),e},rd=function(t){return B_(t,va)?t[va]:{}},Jl=function(t){return B_(t,va)}}var gs,tR,eR,Ss={set:Xl,get:rd,has:Jl,enforce:function(t){return Jl(t)?rd(t):Xl(t,{})},getterFor:function(t){return function(e){var n;if(!u2(e)||(n=rd(e)).type!==t)throw new G_("Incompatible receiver, "+t+" required");return n}}},W_=Qn,E2=yn,nR=Function.prototype,f2=W_&&Object.getOwnPropertyDescriptor,H_=E2(nR,"name"),iR={EXISTS:H_,PROPER:H_&&function(){}.name==="something",CONFIGURABLE:H_&&(!W_||W_&&f2(nR,"name").configurable)},g2=fs,Mo=function(t,e,n,i){return i&&i.enumerable?t[e]=n:g2(t,e,n),t},S2=z,T2=an,R2=Dn,C2=nd,rR=O_,v2=Mo,K_=Me("iterator"),oR=!1;[].keys&&("next"in(eR=[].keys())?(tR=rR(rR(eR)))!==Object.prototype&&(gs=tR):oR=!0);var y2=!R2(gs)||S2(function(){var t={};return gs[K_].call(t)!==t});T2((gs=y2?{}:C2(gs))[K_])||v2(gs,K_,function(){return this});var sR={IteratorPrototype:gs,BUGGY_SAFARI_ITERATORS:oR},I2=ko,A2=C_?{}.toString:function(){return"[object "+I2(this)+"]"},b2=C_,w2=Ki.f,O2=fs,N2=yn,D2=A2,aR=Me("toStringTag"),_o=function(t,e,n,i){var r=n?t:t&&t.prototype;r&&(N2(r,aR)||w2(r,aR,{configurable:!0,value:e}),i&&!b2&&O2(r,"toString",D2))},P2=sR.IteratorPrototype,L2=nd,k2=Oo,M2=_o,U2=Ra,x2=function(){return this},Y_=function(t,e,n,i){var r=e+" Iterator";return t.prototype=L2(P2,{next:k2(+!i,n)}),M2(t,r,!1,!0),U2[r]=x2,t},V2=Yt,F2=hn,B2=iR,j2=Y_,G2=O_,W2=_o,cR=Mo,dR=Ra,H2=sR,K2=B2.PROPER,Ql=H2.BUGGY_SAFARI_ITERATORS,q_=Me("iterator"),lR="keys",Zl="values",uR="entries",Y2=function(){return this},hR=function(t,e,n,i,r,o,s){j2(n,e,i);var a,c,d,l=function(R){if(R===r&&E)return E;if(!Ql&&R&&R in p)return p[R];switch(R){case lR:case Zl:case uR:return function(){return new n(this,R)}}return function(){return new n(this)}},u=e+" Iterator",h=!1,p=t.prototype,S=p[q_]||p["@@iterator"]||r&&p[r],E=!Ql&&S||l(r),f=e==="Array"&&p.entries||S;if(f&&(a=G2(f.call(new t)))!==Object.prototype&&a.next&&(W2(a,u,!0,!0),dR[u]=Y2),K2&&r===Zl&&S&&S.name!==Zl&&(h=!0,E=function(){return F2(S,this)}),r)if(c={values:l(Zl),keys:o?E:l(lR),entries:l(uR)},s)for(d in c)(Ql||h||!(d in p))&&cR(p,d,c[d]);else V2({target:e,proto:!0,forced:Ql||h},c);return s&&p[q_]!==E&&cR(p,q_,E,{name:r}),dR[e]=E,c},$l=function(t,e){return{value:t,done:e}},q2=Do,pR=Ra,_R=Ss;Ki.f;var z2=hR,tu=$l,mR="Array Iterator",X2=_R.set,J2=_R.getterFor(mR);z2(Array,"Array",function(t,e){X2(this,{type:mR,target:q2(t),index:0,kind:e})},function(){var t=J2(this),e=t.target,n=t.index++;if(!e||n>=e.length)return t.target=null,tu(void 0,!0);switch(t.kind){case"keys":return tu(n,!1);case"values":return tu(e[n],!1)}return tu([n,e[n]],!1)},"values"),pR.Arguments=pR.Array;var Q2=Ki,eu=function(t,e,n){return Q2.f(t,e,n)},Z2=Bn,$2=eu,tx=Qn,ER=Me("species"),ex=At,nx=TypeError,z_=function(t,e){if(ex(e,t))return t;throw new nx("Incorrect invocation")},ix=an,X_=c_,rx=ft(Function.toString);ix(X_.inspectSource)||(X_.inspectSource=function(t){return rx(t)});var fR=X_.inspectSource,ox=ft,sx=z,gR=an,ax=ko,cx=fR,SR=function(){},TR=Bn("Reflect","construct"),J_=/^\s*(?:class|function)\b/,dx=ox(J_.exec),lx=!J_.test(SR),od=function(t){if(!gR(t))return!1;try{return TR(SR,[],t),!0}catch{return!1}},RR=function(t){if(!gR(t))return!1;switch(ax(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return lx||!!dx(J_,cx(t))}catch{return!0}};RR.sham=!0;var sd,ya,CR,Q_,nu=!TR||sx(function(){var t;return od(od.call)||!od(Object)||!od(function(){t=!0})||t})?RR:od,ux=nu,hx=Ea,px=TypeError,vR=ri,_x=function(t){if(ux(t))return t;throw new px(hx(t)+" is not a constructor")},mx=Ll,Ex=Me("species"),Z_=function(t,e){var n,i=vR(t).constructor;return i===void 0||mx(n=vR(i)[Ex])?e:_x(n)},Uo=ft([].slice),fx=TypeError,Ts=function(t,e){if(t<e)throw new fx("Not enough arguments");return t},yR=/(?:ipad|iphone|ipod).*applewebkit/i.test(po),Li=xt,gx=Te,Sx=Po,IR=an,Tx=yn,AR=z,bR=MT,Rx=Uo,wR=p_,Cx=Ts,vx=yR,yx=Vl,$_=Li.setImmediate,tm=Li.clearImmediate,Ix=Li.process,em=Li.Dispatch,Ax=Li.Function,OR=Li.MessageChannel,bx=Li.String,nm=0,ad={},NR="onreadystatechange";AR(function(){sd=Li.location});var im=function(t){if(Tx(ad,t)){var e=ad[t];delete ad[t],e()}},rm=function(t){return function(){im(t)}},DR=function(t){im(t.data)},PR=function(t){Li.postMessage(bx(t),sd.protocol+"//"+sd.host)};$_&&tm||($_=function(t){Cx(arguments.length,1);var e=IR(t)?t:Ax(t),n=Rx(arguments,1);return ad[++nm]=function(){gx(e,void 0,n)},ya(nm),nm},tm=function(t){delete ad[t]},yx?ya=function(t){Ix.nextTick(rm(t))}:em&&em.now?ya=function(t){em.now(rm(t))}:OR&&!vx?(Q_=(CR=new OR).port2,CR.port1.onmessage=DR,ya=Sx(Q_.postMessage,Q_)):Li.addEventListener&&IR(Li.postMessage)&&!Li.importScripts&&sd&&sd.protocol!=="file:"&&!AR(PR)?(ya=PR,Li.addEventListener("message",DR,!1)):ya=NR in wR("script")?function(t){bR.appendChild(wR("script"))[NR]=function(){bR.removeChild(this),im(t)}}:function(t){setTimeout(rm(t),0)});var iu={set:$_,clear:tm},LR=xt,wx=Qn,Ox=Object.getOwnPropertyDescriptor,kR=function(t){if(!wx)return LR[t];var e=Ox(LR,t);return e&&e.value},MR=function(){this.head=null,this.tail=null};MR.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var Ia,om,sm,am,UR,xR=MR,Nx=/ipad|iphone|ipod/i.test(po)&&typeof Pebble<"u",Dx=/web0s(?!.*chrome)/i.test(po),Aa=xt,Px=kR,VR=Po,cm=iu.set,Lx=xR,kx=yR,Mx=Nx,Ux=Dx,dm=Vl,FR=Aa.MutationObserver||Aa.WebKitMutationObserver,BR=Aa.document,jR=Aa.process,ru=Aa.Promise,lm=Px("queueMicrotask");if(!lm){var ou=new Lx,su=function(){var t,e;for(dm&&(t=jR.domain)&&t.exit();e=ou.get();)try{e()}catch(n){throw ou.head&&Ia(),n}t&&t.enter()};kx||dm||Ux||!FR||!BR?!Mx&&ru&&ru.resolve?((am=ru.resolve(void 0)).constructor=ru,UR=VR(am.then,am),Ia=function(){UR(su)}):dm?Ia=function(){jR.nextTick(su)}:(cm=VR(cm,Aa),Ia=function(){cm(su)}):(om=!0,sm=BR.createTextNode(""),new FR(su).observe(sm,{characterData:!0}),Ia=function(){sm.data=om=!om}),lm=function(t){ou.head||Ia(),ou.add(t)}}var GR=lm,ba=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},Rs=xt.Promise,xx=xt,cd=Rs,Vx=an,Fx=_T,Bx=fR,jx=Me,WR=I_,um=Es,HR=cd&&cd.prototype,Gx=jx("species"),KR=!1,YR=Vx(xx.PromiseRejectionEvent),Wx=Fx("Promise",function(){var t=Bx(cd),e=t!==String(cd);if(!e&&um===66||!HR.catch||!HR.finally)return!0;if(!um||um<51||!/native code/.test(t)){var n=new cd(function(r){r(1)}),i=function(r){r(function(){},function(){})};if((n.constructor={})[Gx]=i,!(KR=n.then(function(){})instanceof i))return!0}return!(e||WR!=="BROWSER"&&WR!=="DENO"||YR)}),dd={CONSTRUCTOR:Wx,REJECTION_EVENT:YR,SUBCLASSING:KR},jr={},qR=_i,Hx=TypeError,Kx=function(t){var e,n;this.promise=new t(function(i,r){if(e!==void 0||n!==void 0)throw new Hx("Bad Promise constructor");e=i,n=r}),this.resolve=qR(e),this.reject=qR(n)};jr.f=function(t){return new Kx(t)};var hm,zR,XR,Yx=Yt,au=Vl,xo=xt,qx=pi,ld=hn,zx=Mo,Xx=_o,Jx=function(t){var e=Z2(t);tx&&e&&!e[ER]&&$2(e,ER,{configurable:!0,get:function(){return this}})},Qx=_i,pm=an,Zx=Dn,$x=z_,tV=Z_,JR=iu.set,_m=GR,eV=function(t,e){try{arguments.length===1?console.error(t):console.error(t,e)}catch{}},nV=ba,iV=xR,QR=Ss,mm=Rs,ZR=dd,$R=jr,cu="Promise",tC=ZR.CONSTRUCTOR,rV=ZR.REJECTION_EVENT,Em=QR.getterFor(cu),oV=QR.set,sV=mm&&mm.prototype,ud=mm,fm=sV,eC=xo.TypeError,gm=xo.document,Sm=xo.process,Tm=$R.f,aV=Tm,cV=!!(gm&&gm.createEvent&&xo.dispatchEvent),nC="unhandledrejection",iC=function(t){var e;return!(!Zx(t)||!pm(e=t.then))&&e},rC=function(t,e){var n,i,r,o=e.value,s=e.state===1,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(s||(e.rejection===2&&lV(e),e.rejection=1),a===!0?n=o:(l&&l.enter(),n=a(o),l&&(l.exit(),r=!0)),n===t.promise?d(new eC("Promise-chain cycle")):(i=iC(n))?ld(i,n,c,d):c(n)):d(o)}catch(u){l&&!r&&l.exit(),d(u)}},oC=function(t,e){t.notified||(t.notified=!0,_m(function(){for(var n,i=t.reactions;n=i.get();)rC(n,t);t.notified=!1,e&&!t.rejection&&dV(t)}))},sC=function(t,e,n){var i,r;cV?((i=gm.createEvent("Event")).promise=e,i.reason=n,i.initEvent(t,!1,!0),xo.dispatchEvent(i)):i={promise:e,reason:n},!rV&&(r=xo["on"+t])?r(i):t===nC&&eV("Unhandled promise rejection",n)},dV=function(t){ld(JR,xo,function(){var e,n=t.facade,i=t.value;if(aC(t)&&(e=nV(function(){au?Sm.emit("unhandledRejection",i,n):sC(nC,n,i)}),t.rejection=au||aC(t)?2:1,e.error))throw e.value})},aC=function(t){return t.rejection!==1&&!t.parent},lV=function(t){ld(JR,xo,function(){var e=t.facade;au?Sm.emit("rejectionHandled",e):sC("rejectionhandled",e,t.value)})},wa=function(t,e,n){return function(i){t(e,i,n)}},Oa=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,oC(t,!0))},Rm=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw new eC("Promise can't be resolved itself");var i=iC(e);i?_m(function(){var r={done:!1};try{ld(i,e,wa(Rm,r,t),wa(Oa,r,t))}catch(o){Oa(r,o,t)}}):(t.value=e,t.state=1,oC(t,!1))}catch(r){Oa({done:!1},r,t)}}};tC&&(fm=(ud=function(t){$x(this,fm),Qx(t),ld(hm,this);var e=Em(this);try{t(wa(Rm,e),wa(Oa,e))}catch(n){Oa(e,n)}}).prototype,(hm=function(t){oV(this,{type:cu,done:!1,notified:!1,parent:!1,reactions:new iV,rejection:!1,state:0,value:null})}).prototype=zx(fm,"then",function(t,e){var n=Em(this),i=Tm(tV(this,ud));return n.parent=!0,i.ok=!pm(t)||t,i.fail=pm(e)&&e,i.domain=au?Sm.domain:void 0,n.state===0?n.reactions.add(i):_m(function(){rC(i,n)}),i.promise}),zR=function(){var t=new hm,e=Em(t);this.promise=t,this.resolve=wa(Rm,e),this.reject=wa(Oa,e)},$R.f=Tm=function(t){return t===ud||t===XR?new zR(t):aV(t)}),Yx({global:!0,constructor:!0,wrap:!0,forced:tC},{Promise:ud}),XR=qx.Promise,Xx(ud,cu,!1,!0),Jx(cu);var cC=Me("iterator"),dC=!1;try{var uV=0,lC={next:function(){return{done:!!uV++}},return:function(){dC=!0}};lC[cC]=function(){return this},Array.from(lC,function(){throw 2})}catch{}var hV=Rs,pV=function(t,e){try{if(!e&&!dC)return!1}catch{return!1}var n=!1;try{var i={};i[cC]=function(){return{next:function(){return{done:n=!0}}}},t(i)}catch{}return n},du=dd.CONSTRUCTOR||!pV(function(t){hV.all(t).then(void 0,function(){})}),_V=hn,mV=_i,EV=jr,fV=ba,gV=id;Yt({target:"Promise",stat:!0,forced:du},{all:function(t){var e=this,n=EV.f(e),i=n.resolve,r=n.reject,o=fV(function(){var s=mV(e.resolve),a=[],c=0,d=1;gV(t,function(l){var u=c++,h=!1;d++,_V(s,e,l).then(function(p){h||(h=!0,a[u]=p,--d||i(a))},r)}),--d||i(a)});return o.error&&r(o.value),n.promise}});var SV=Yt,TV=dd.CONSTRUCTOR;Rs&&Rs.prototype,SV({target:"Promise",proto:!0,forced:TV,real:!0},{catch:function(t){return this.then(void 0,t)}});var RV=hn,CV=_i,vV=jr,yV=ba,IV=id;Yt({target:"Promise",stat:!0,forced:du},{race:function(t){var e=this,n=vV.f(e),i=n.reject,r=yV(function(){var o=CV(e.resolve);IV(t,function(s){RV(o,e,s).then(n.resolve,i)})});return r.error&&i(r.value),n.promise}});var AV=jr;Yt({target:"Promise",stat:!0,forced:dd.CONSTRUCTOR},{reject:function(t){var e=AV.f(this);return(0,e.reject)(t),e.promise}});var bV=ri,wV=Dn,OV=jr,uC=function(t,e){if(bV(t),wV(e)&&e.constructor===t)return e;var n=OV.f(t);return(0,n.resolve)(e),n.promise},NV=Yt,DV=Rs,PV=dd.CONSTRUCTOR,LV=uC,kV=Bn("Promise"),MV=!PV;NV({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return LV(MV&&this===kV?DV:this,t)}});var UV=hn,xV=_i,VV=jr,FV=ba,BV=id;Yt({target:"Promise",stat:!0,forced:du},{allSettled:function(t){var e=this,n=VV.f(e),i=n.resolve,r=n.reject,o=FV(function(){var s=xV(e.resolve),a=[],c=0,d=1;BV(t,function(l){var u=c++,h=!1;d++,UV(s,e,l).then(function(p){h||(h=!0,a[u]={status:"fulfilled",value:p},--d||i(a))},function(p){h||(h=!0,a[u]={status:"rejected",reason:p},--d||i(a))})}),--d||i(a)});return o.error&&r(o.value),n.promise}});var jV=hn,GV=_i,WV=Bn,HV=jr,KV=ba,YV=id,hC="No one promise resolved";Yt({target:"Promise",stat:!0,forced:du},{any:function(t){var e=this,n=WV("AggregateError"),i=HV.f(e),r=i.resolve,o=i.reject,s=KV(function(){var a=GV(e.resolve),c=[],d=0,l=1,u=!1;YV(t,function(h){var p=d++,S=!1;l++,jV(a,e,h).then(function(E){S||u||(u=!0,r(E))},function(E){S||u||(S=!0,c[p]=E,--l||o(new n(c,hC)))})}),--l||o(new n(c,hC))});return s.error&&o(s.value),i.promise}});var qV=Yt,zV=Te,XV=Uo,JV=jr,QV=_i,pC=ba,Cm=xt.Promise,_C=!1;qV({target:"Promise",stat:!0,forced:!Cm||!Cm.try||pC(function(){Cm.try(function(t){_C=t===8},8)}).error||!_C},{try:function(t){var e=arguments.length>1?XV(arguments,1):[],n=JV.f(this),i=pC(function(){return zV(QV(t),void 0,e)});return(i.error?n.reject:n.resolve)(i.value),n.promise}});var ZV=jr;Yt({target:"Promise",stat:!0},{withResolvers:function(){var t=ZV.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var $V=Yt,vm=Rs,tF=z,eF=Bn,nF=an,iF=Z_,mC=uC,rF=vm&&vm.prototype;$V({target:"Promise",proto:!0,real:!0,forced:!!vm&&tF(function(){rF.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=iF(this,eF("Promise")),n=nF(t);return this.then(n?function(i){return mC(e,t()).then(function(){return i})}:t,n?function(i){return mC(e,t()).then(function(){throw i})}:t)}});var ym=ft,oF=g_,sF=oi,aF=No,cF=ym("".charAt),EC=ym("".charCodeAt),dF=ym("".slice),fC=function(t){return function(e,n){var i,r,o=sF(aF(e)),s=oF(n),a=o.length;return s<0||s>=a?t?"":void 0:(i=EC(o,s))<55296||i>56319||s+1===a||(r=EC(o,s+1))<56320||r>57343?t?cF(o,s):i:t?dF(o,s,s+2):r-56320+(i-55296<<10)+65536}},Im={codeAt:fC(!1),charAt:fC(!0)},lF=Im.charAt,uF=oi,gC=Ss,hF=hR,SC=$l,TC="String Iterator",pF=gC.set,_F=gC.getterFor(TC);hF(String,"String",function(t){pF(this,{type:TC,string:uF(t),index:0})},function(){var t,e=_F(this),n=e.string,i=e.index;return i>=n.length?SC(void 0,!0):(t=lF(n,i),e.index+=t.length,SC(t,!1))});var mF=pi.Promise,EF={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},fF=xt,gF=_o,RC=Ra;for(var Am in EF)gF(fF[Am],Am),RC[Am]=RC.Array;var CC=mF,Y=H(CC),SF=Di("Array","values"),TF=ko,RF=yn,CF=At,vF=SF,bm=Array.prototype,yF={DOMTokenList:!0,NodeList:!0},IF=function(t){var e=t.values;return t===bm||CF(bm,t)&&e===bm.values||RF(yF,TF(t))?vF:e},si=H(IF),vC=Ea,AF=TypeError,yC=Uo,bF=Math.floor,wm=function(t,e){var n=t.length;if(n<8)for(var i,r,o=1;o<n;){for(r=o,i=t[o];r&&e(t[r-1],i)>0;)t[r]=t[--r];r!==o++&&(t[r]=i)}else for(var s=bF(n/2),a=wm(yC(t,0,s),e),c=wm(yC(t,s),e),d=a.length,l=c.length,u=0,h=0;u<d||h<l;)t[u+h]=u<d&&h<l?e(a[u],c[h])<=0?a[u++]:c[h++]:u<d?a[u++]:c[h++];return t},IC=wm,AC=po.match(/firefox\/(\d+)/i),wF=!!AC&&+AC[1],OF=/MSIE|Trident/.test(po),bC=po.match(/AppleWebKit\/(\d+)\./),NF=!!bC&&+bC[1],DF=Yt,wC=ft,PF=_i,LF=pr,OC=Lo,kF=function(t,e){if(!delete t[e])throw new AF("Cannot delete property "+vC(e)+" of "+vC(t))},NC=oi,Om=z,MF=IC,UF=Ul,DC=wF,xF=OF,PC=Es,LC=NF,Vo=[],kC=wC(Vo.sort),VF=wC(Vo.push),FF=Om(function(){Vo.sort(void 0)}),BF=Om(function(){Vo.sort(null)}),jF=UF("sort"),MC=!Om(function(){if(PC)return PC<70;if(!(DC&&DC>3)){if(xF)return!0;if(LC)return LC<603;var t,e,n,i,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Vo.push({k:e+i,v:n})}for(Vo.sort(function(o,s){return s.v-o.v}),i=0;i<Vo.length;i++)e=Vo[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});DF({target:"Array",proto:!0,forced:FF||!BF||!jF||!MC},{sort:function(t){t!==void 0&&PF(t);var e=LF(this);if(MC)return t===void 0?kC(e):kC(e,t);var n,i,r=[],o=OC(e);for(i=0;i<o;i++)i in e&&VF(r,e[i]);for(MF(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:NC(a)>NC(c)?1:-1}}(t)),n=OC(r),i=0;i<n;)e[i]=r[i++];for(;i<o;)kF(e,i++);return e}});var GF=Di("Array","sort"),WF=At,HF=GF,Nm=Array.prototype,KF=function(t){var e=t.sort;return t===Nm||WF(Nm,t)&&e===Nm.sort?HF:e},Cs=H(KF),YF=Yt,qF=ft,zF=S_,XF=RangeError,UC=String.fromCharCode,xC=String.fromCodePoint,JF=qF([].join);YF({target:"String",stat:!0,arity:1,forced:!!xC&&xC.length!==1},{fromCodePoint:function(t){for(var e,n=[],i=arguments.length,r=0;i>r;){if(e=+arguments[r++],zF(e,1114111)!==e)throw new XF(e+" is not a valid code point");n[r]=e<65536?UC(e):UC(55296+((e-=65536)>>10),e%1024+56320)}return JF(n,"")}});var QF=z,ZF=Me("iterator"),lu=!QF(function(){var t=new URL("b?a=1&b=2&c=3","https://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2&b=3"),i="";return t.pathname="c%20d",e.forEach(function(r,o){e.delete("b"),i+=o+r}),n.delete("a",2),n.delete("b",void 0),!t.toJSON||!n.has("a",1)||n.has("a",2)||!n.has("a",void 0)||n.has("b")||!e.size&&!0||!e.sort||t.href!=="https://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[ZF]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://\u0442\u0435\u0441\u0442").host!=="xn--e1aybc"||new URL("https://a#\u0431").hash!=="#%D0%B1"||i!=="a1c3"||new URL("https://x",void 0).host!=="x"}),$F=Mo,Dm=Yt,VC=xt,Pm=kR,tB=Bn,uu=hn,_r=ft,hd=Qn,FC=lu,BC=Mo,eB=eu,nB=function(t,e,n){for(var i in e)n&&n.unsafe&&t[i]?t[i]=e[i]:$F(t,i,e[i],n);return t},iB=_o,rB=Y_,Lm=Ss,jC=z_,km=an,oB=yn,sB=Po,aB=ko,cB=ri,GC=Dn,ai=oi,dB=nd,WC=Oo,HC=U_,lB=Kl,hu=$l,Na=Ts,uB=IC,hB=Me("iterator"),Da="URLSearchParams",KC=Da+"Iterator",YC=Lm.set,Yi=Lm.getterFor(Da),pB=Lm.getterFor(KC),qC=Pm("fetch"),pu=Pm("Request"),pd=Pm("Headers"),Mm=pu&&pu.prototype,zC=pd&&pd.prototype,_B=VC.TypeError,mB=VC.encodeURIComponent,EB=String.fromCharCode,fB=tB("String","fromCodePoint"),gB=parseInt,_u=_r("".charAt),XC=_r([].join),Fo=_r([].push),JC=_r("".replace),SB=_r([].shift),QC=_r([].splice),ZC=_r("".split),$C=_r("".slice),TB=_r(/./.exec),RB=/\+/g,CB=/^[0-9a-f]+$/i,tv=function(t,e){var n=$C(t,e,e+2);return TB(CB,n)?gB(n,16):NaN},vB=function(t){for(var e=0,n=128;n>0&&t&n;n>>=1)e++;return e},yB=function(t){var e=null;switch(t.length){case 1:e=t[0];break;case 2:e=(31&t[0])<<6|63&t[1];break;case 3:e=(15&t[0])<<12|(63&t[1])<<6|63&t[2];break;case 4:e=(7&t[0])<<18|(63&t[1])<<12|(63&t[2])<<6|63&t[3]}return e>1114111?null:e},ev=function(t){for(var e=(t=JC(t,RB," ")).length,n="",i=0;i<e;){var r=_u(t,i);if(r==="%"){if(_u(t,i+1)==="%"||i+3>e){n+="%",i++;continue}var o=tv(t,i+1);if(o!=o){n+=r,i++;continue}i+=2;var s=vB(o);if(s===0)r=EB(o);else{if(s===1||s>4){n+="\uFFFD",i++;continue}for(var a=[o],c=1;c<s&&!(++i+3>e||_u(t,i)!=="%");){var d=tv(t,i+1);if(d!=d){i+=3;break}if(d>191||d<128)break;Fo(a,d),i+=2,c++}if(a.length!==s){n+="\uFFFD";continue}var l=yB(a);l===null?n+="\uFFFD":r=fB(l)}}n+=r,i++}return n},IB=/[!'()~]|%20/g,AB={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},bB=function(t){return AB[t]},nv=function(t){return JC(mB(t),IB,bB)},Um=rB(function(t,e){YC(this,{type:KC,target:Yi(t).entries,index:0,kind:e})},Da,function(){var t=pB(this),e=t.target,n=t.index++;if(!e||n>=e.length)return t.target=null,hu(void 0,!0);var i=e[n];switch(t.kind){case"keys":return hu(i.key,!1);case"values":return hu(i.value,!1)}return hu([i.key,i.value],!1)},!0),iv=function(t){this.entries=[],this.url=null,t!==void 0&&(GC(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?_u(t,0)==="?"?$C(t,1):t:ai(t)))};iv.prototype={type:Da,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,i,r,o,s,a,c=this.entries,d=lB(t);if(d)for(n=(e=HC(t,d)).next;!(i=uu(n,e)).done;){if(o=(r=HC(cB(i.value))).next,(s=uu(o,r)).done||(a=uu(o,r)).done||!uu(o,r).done)throw new _B("Expected sequence with length 2");Fo(c,{key:ai(s.value),value:ai(a.value)})}else for(var l in t)oB(t,l)&&Fo(c,{key:l,value:ai(t[l])})},parseQuery:function(t){if(t)for(var e,n,i=this.entries,r=ZC(t,"&"),o=0;o<r.length;)(e=r[o++]).length&&(n=ZC(e,"="),Fo(i,{key:ev(SB(n)),value:ev(XC(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],i=0;i<e.length;)t=e[i++],Fo(n,nv(t.key)+"="+nv(t.value));return XC(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var mu=function(){jC(this,Pa);var t=YC(this,new iv(arguments.length>0?arguments[0]:void 0));hd||(this.size=t.entries.length)},Pa=mu.prototype;if(nB(Pa,{append:function(t,e){var n=Yi(this);Na(arguments.length,2),Fo(n.entries,{key:ai(t),value:ai(e)}),hd||this.length++,n.updateURL()},delete:function(t){for(var e=Yi(this),n=Na(arguments.length,1),i=e.entries,r=ai(t),o=n<2?void 0:arguments[1],s=o===void 0?o:ai(o),a=0;a<i.length;){var c=i[a];if(c.key!==r||s!==void 0&&c.value!==s)a++;else if(QC(i,a,1),s!==void 0)break}hd||(this.size=i.length),e.updateURL()},get:function(t){var e=Yi(this).entries;Na(arguments.length,1);for(var n=ai(t),i=0;i<e.length;i++)if(e[i].key===n)return e[i].value;return null},getAll:function(t){var e=Yi(this).entries;Na(arguments.length,1);for(var n=ai(t),i=[],r=0;r<e.length;r++)e[r].key===n&&Fo(i,e[r].value);return i},has:function(t){for(var e=Yi(this).entries,n=Na(arguments.length,1),i=ai(t),r=n<2?void 0:arguments[1],o=r===void 0?r:ai(r),s=0;s<e.length;){var a=e[s++];if(a.key===i&&(o===void 0||a.value===o))return!0}return!1},set:function(t,e){var n=Yi(this);Na(arguments.length,1);for(var i,r=n.entries,o=!1,s=ai(t),a=ai(e),c=0;c<r.length;c++)(i=r[c]).key===s&&(o?QC(r,c--,1):(o=!0,i.value=a));o||Fo(r,{key:s,value:a}),hd||(this.size=r.length),n.updateURL()},sort:function(){var t=Yi(this);uB(t.entries,function(e,n){return e.key>n.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,n=Yi(this).entries,i=sB(t,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((e=n[r++]).value,e.key,this)},keys:function(){return new Um(this,"keys")},values:function(){return new Um(this,"values")},entries:function(){return new Um(this,"entries")}},{enumerable:!0}),BC(Pa,hB,Pa.entries,{name:"entries"}),BC(Pa,"toString",function(){return Yi(this).serialize()},{enumerable:!0}),hd&&eB(Pa,"size",{get:function(){return Yi(this).entries.length},configurable:!0,enumerable:!0}),iB(mu,Da),Dm({global:!0,constructor:!0,forced:!FC},{URLSearchParams:mu}),!FC&&km(pd)){var wB=_r(zC.has),OB=_r(zC.set),rv=function(t){if(GC(t)){var e,n=t.body;if(aB(n)===Da)return e=t.headers?new pd(t.headers):new pd,wB(e,"content-type")||OB(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),dB(t,{body:WC(0,ai(n)),headers:WC(0,e)})}return t};if(km(qC)&&Dm({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return qC(t,arguments.length>1?rv(arguments[1]):{})}}),km(pu)){var xm=function(t){return jC(this,Mm),new pu(t,arguments.length>1?rv(arguments[1]):{})};Mm.constructor=xm,xm.prototype=Mm,Dm({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:xm})}}var qi,NB={URLSearchParams:mu,getState:Yi},DB=pi.URLSearchParams,ov=Qn,PB=ft,LB=hn,kB=z,Vm=Gl,MB=ed,UB=Nl,xB=pr,VB=Pl,La=Object.assign,sv=Object.defineProperty,FB=PB([].concat),BB=!La||kB(function(){if(ov&&La({b:1},La(sv({},"a",{enumerable:!0,get:function(){sv(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},n=Symbol("assign detection"),i="abcdefghijklmnopqrst";return t[n]=7,i.split("").forEach(function(r){e[r]=r}),La({},t)[n]!==7||Vm(La({},e)).join("")!==i})?function(t,e){for(var n=xB(t),i=arguments.length,r=1,o=MB.f,s=UB.f;i>r;)for(var a,c=VB(arguments[r++]),d=o?FB(Vm(c),o(c)):Vm(c),l=d.length,u=0;l>u;)a=d[u++],ov&&!LB(s,c,a)||(n[a]=c[a]);return n}:La,jB=ri,GB=YT,WB=Qn,HB=Ki,KB=Oo,Fm=function(t,e,n){WB?HB.f(t,e,KB(0,n)):t[e]=n},YB=Po,qB=hn,zB=pr,XB=function(t,e,n,i){try{return i?e(jB(n)[0],n[1]):e(n)}catch(r){GB(t,"throw",r)}},JB=WT,QB=nu,ZB=Lo,av=Fm,$B=U_,tj=Kl,cv=Array,vs=ft,Bm=2147483647,ej=/[^\0-\u007E]/,dv=/[.\u3002\uFF0E\uFF61]/g,lv="Overflow: input needs wider integers to process",uv=RangeError,nj=vs(dv.exec),ka=Math.floor,jm=String.fromCharCode,hv=vs("".charCodeAt),pv=vs([].join),Bo=vs([].push),ij=vs("".replace),rj=vs("".split),oj=vs("".toLowerCase),_v=function(t){return t+22+75*(t<26)},sj=function(t,e,n){var i=0;for(t=n?ka(t/700):t>>1,t+=ka(t/e);t>455;)t=ka(t/35),i+=36;return ka(i+36*t/(t+38))},aj=function(t){var e=[];t=function(R){for(var v=[],I=0,w=R.length;I<w;){var O=hv(R,I++);if(O>=55296&&O<=56319&&I<w){var A=hv(R,I++);(64512&A)==56320?Bo(v,((1023&O)<<10)+(1023&A)+65536):(Bo(v,O),I--)}else Bo(v,O)}return v}(t);var n,i,r=t.length,o=128,s=0,a=72;for(n=0;n<t.length;n++)(i=t[n])<128&&Bo(e,jm(i));var c=e.length,d=c;for(c&&Bo(e,"-");d<r;){var l=Bm;for(n=0;n<t.length;n++)(i=t[n])>=o&&i<l&&(l=i);var u=d+1;if(l-o>ka((Bm-s)/u))throw new uv(lv);for(s+=(l-o)*u,o=l,n=0;n<t.length;n++){if((i=t[n])<o&&++s>Bm)throw new uv(lv);if(i===o){for(var h=s,p=36;;){var S=p<=a?1:p>=a+26?26:p-a;if(h<S)break;var E=h-S,f=36-S;Bo(e,jm(_v(S+E%f))),h=ka(E/f),p+=36}Bo(e,jm(_v(h))),a=sj(s,u,d===c),s=0,d++}}s++,o++}return pv(e,"")},cj=Yt,Gm=Qn,dj=lu,Wm=xt,mv=Po,zi=ft,Eu=Mo,Xi=eu,lj=z_,Hm=yn,Km=BB,Ma=function(t){var e=zB(t),n=QB(this),i=arguments.length,r=i>1?arguments[1]:void 0,o=r!==void 0;o&&(r=YB(r,i>2?arguments[2]:void 0));var s,a,c,d,l,u,h=tj(e),p=0;if(!h||this===cv&&JB(h))for(s=ZB(e),a=n?new this(s):cv(s);s>p;p++)u=o?r(e[p],p):e[p],av(a,p,u);else for(a=n?new this:[],l=(d=$B(e,h)).next;!(c=qB(l,d)).done;p++)u=o?XB(d,r,[c.value,p],!0):c.value,av(a,p,u);return a.length=p,a},mr=Uo,uj=Im.codeAt,hj=function(t){var e,n,i=[],r=rj(ij(oj(t),dv,"."),".");for(e=0;e<r.length;e++)n=r[e],Bo(i,nj(ej,n)?"xn--"+aj(n):n);return pv(i,".")},mo=oi,pj=_o,_j=Ts,Ev=NB,fv=Ss,mj=fv.set,fu=fv.getterFor("URL"),Ej=Ev.URLSearchParams,fj=Ev.getState,_d=Wm.URL,Ym=Wm.TypeError,gu=Wm.parseInt,gj=Math.floor,gv=Math.pow,Ji=zi("".charAt),Er=zi(/./.exec),md=zi([].join),Sj=zi(1.1.toString),Tj=zi([].pop),Ua=zi([].push),qm=zi("".replace),Rj=zi([].shift),Cj=zi("".split),Ed=zi("".slice),Su=zi("".toLowerCase),vj=zi([].unshift),zm="Invalid scheme",ys="Invalid host",Sv="Invalid port",Tv=/[a-z]/i,yj=/[\d+-.a-z]/i,Xm=/\d/,Ij=/^0x/i,Aj=/^[0-7]+$/,bj=/^\d+$/,Rv=/^[\da-f]+$/i,wj=/[\0\t\n\r #%/:<>?@[\\\]^|]/,Oj=/[\0\t\n\r #/:<>?@[\\\]^|]/,Nj=/^[\u0000-\u0020]+/,Dj=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,Pj=/[\t\n\r]/g,fd=function(t){var e,n,i,r;if(typeof t=="number"){for(e=[],n=0;n<4;n++)vj(e,t%256),t=gj(t/256);return md(e,".")}if(typeof t=="object"){for(e="",i=function(o){for(var s=null,a=1,c=null,d=0,l=0;l<8;l++)o[l]!==0?(d>a&&(s=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:s}(t),n=0;n<8;n++)r&&t[n]===0||(r&&(r=!1),i===n?(e+=n?":":"::",r=!0):(e+=Sj(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},Tu={},Cv=Km({},Tu,{" ":1,'"':1,"<":1,">":1,"`":1}),vv=Km({},Cv,{"#":1,"?":1,"{":1,"}":1}),Jm=Km({},vv,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),jo=function(t,e){var n=uj(t,0);return n>32&&n<127&&!Hm(e,t)?t:encodeURIComponent(t)},Ru={ftp:21,file:null,http:80,https:443,ws:80,wss:443},gd=function(t,e){var n;return t.length===2&&Er(Tv,Ji(t,0))&&((n=Ji(t,1))===":"||!e&&n==="|")},yv=function(t){var e;return t.length>1&&gd(Ed(t,0,2))&&(t.length===2||(e=Ji(t,2))==="/"||e==="\\"||e==="?"||e==="#")},Lj=function(t){return t==="."||Su(t)==="%2e"},Qm={},Iv={},Zm={},Av={},bv={},$m={},wv={},Ov={},Cu={},vu={},tE={},eE={},nE={},iE={},Nv={},rE={},xa={},Gr={},Dv={},Is={},Eo={},oE=function(t,e,n){var i,r,o,s=mo(t);if(e){if(r=this.parse(s))throw new Ym(r);this.searchParams=null}else{if(n!==void 0&&(i=new oE(n,!0)),r=this.parse(s,null,i))throw new Ym(r);(o=fj(new Ej)).bindURL(this),this.searchParams=o}};oE.prototype={type:"URL",parse:function(t,e,n){var i,r,o,s,a,c=this,d=e||Qm,l=0,u="",h=!1,p=!1,S=!1;for(t=mo(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=qm(t,Nj,""),t=qm(t,Dj,"$1")),t=qm(t,Pj,""),i=Ma(t);l<=i.length;){switch(r=i[l],d){case Qm:if(!r||!Er(Tv,r)){if(e)return zm;d=Zm;continue}u+=Su(r),d=Iv;break;case Iv:if(r&&(Er(yj,r)||r==="+"||r==="-"||r==="."))u+=Su(r);else{if(r!==":"){if(e)return zm;u="",d=Zm,l=0;continue}if(e&&(c.isSpecial()!==Hm(Ru,u)||u==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=u,e)return void(c.isSpecial()&&Ru[c.scheme]===c.port&&(c.port=null));u="",c.scheme==="file"?d=iE:c.isSpecial()&&n&&n.scheme===c.scheme?d=Av:c.isSpecial()?d=Ov:i[l+1]==="/"?(d=bv,l++):(c.cannotBeABaseURL=!0,Ua(c.path,""),d=Dv)}break;case Zm:if(!n||n.cannotBeABaseURL&&r!=="#")return zm;if(n.cannotBeABaseURL&&r==="#"){c.scheme=n.scheme,c.path=mr(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=Eo;break}d=n.scheme==="file"?iE:$m;continue;case Av:if(r!=="/"||i[l+1]!=="/"){d=$m;continue}d=Cu,l++;break;case bv:if(r==="/"){d=vu;break}d=Gr;continue;case $m:if(c.scheme=n.scheme,r===qi)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=mr(n.path),c.query=n.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=wv;else if(r==="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=mr(n.path),c.query="",d=Is;else{if(r!=="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=mr(n.path),c.path.length--,d=Gr;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=mr(n.path),c.query=n.query,c.fragment="",d=Eo}break;case wv:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=Gr;continue}d=vu}else d=Cu;break;case Ov:if(d=Cu,r!=="/"||Ji(u,l+1)!=="/")continue;l++;break;case Cu:if(r!=="/"&&r!=="\\"){d=vu;continue}break;case vu:if(r==="@"){h&&(u="%40"+u),h=!0,o=Ma(u);for(var E=0;E<o.length;E++){var f=o[E];if(f!==":"||S){var R=jo(f,Jm);S?c.password+=R:c.username+=R}else S=!0}u=""}else if(r===qi||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(h&&u==="")return"Invalid authority";l-=Ma(u).length+1,u="",d=tE}else u+=r;break;case tE:case eE:if(e&&c.scheme==="file"){d=rE;continue}if(r!==":"||p){if(r===qi||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&u==="")return ys;if(e&&u===""&&(c.includesCredentials()||c.port!==null))return;if(s=c.parseHost(u))return s;if(u="",d=xa,e)return;continue}r==="["?p=!0:r==="]"&&(p=!1),u+=r}else{if(u==="")return ys;if(s=c.parseHost(u))return s;if(u="",d=nE,e===eE)return}break;case nE:if(!Er(Xm,r)){if(r===qi||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||e){if(u!==""){var v=gu(u,10);if(v>65535)return Sv;c.port=c.isSpecial()&&v===Ru[c.scheme]?null:v,u=""}if(e)return;d=xa;continue}return Sv}u+=r;break;case iE:if(c.scheme="file",r==="/"||r==="\\")d=Nv;else{if(!n||n.scheme!=="file"){d=Gr;continue}switch(r){case qi:c.host=n.host,c.path=mr(n.path),c.query=n.query;break;case"?":c.host=n.host,c.path=mr(n.path),c.query="",d=Is;break;case"#":c.host=n.host,c.path=mr(n.path),c.query=n.query,c.fragment="",d=Eo;break;default:yv(md(mr(i,l),""))||(c.host=n.host,c.path=mr(n.path),c.shortenPath()),d=Gr;continue}}break;case Nv:if(r==="/"||r==="\\"){d=rE;break}n&&n.scheme==="file"&&!yv(md(mr(i,l),""))&&(gd(n.path[0],!0)?Ua(c.path,n.path[0]):c.host=n.host),d=Gr;continue;case rE:if(r===qi||r==="/"||r==="\\"||r==="?"||r==="#"){if(!e&&gd(u))d=Gr;else if(u===""){if(c.host="",e)return;d=xa}else{if(s=c.parseHost(u))return s;if(c.host==="localhost"&&(c.host=""),e)return;u="",d=xa}continue}u+=r;break;case xa:if(c.isSpecial()){if(d=Gr,r!=="/"&&r!=="\\")continue}else if(e||r!=="?")if(e||r!=="#"){if(r!==qi&&(d=Gr,r!=="/"))continue}else c.fragment="",d=Eo;else c.query="",d=Is;break;case Gr:if(r===qi||r==="/"||r==="\\"&&c.isSpecial()||!e&&(r==="?"||r==="#")){if((a=Su(a=u))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||Ua(c.path,"")):Lj(u)?r==="/"||r==="\\"&&c.isSpecial()||Ua(c.path,""):(c.scheme==="file"&&!c.path.length&&gd(u)&&(c.host&&(c.host=""),u=Ji(u,0)+":"),Ua(c.path,u)),u="",c.scheme==="file"&&(r===qi||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)Rj(c.path);r==="?"?(c.query="",d=Is):r==="#"&&(c.fragment="",d=Eo)}else u+=jo(r,vv);break;case Dv:r==="?"?(c.query="",d=Is):r==="#"?(c.fragment="",d=Eo):r!==qi&&(c.path[0]+=jo(r,Tu));break;case Is:e||r!=="#"?r!==qi&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":jo(r,Tu)):(c.fragment="",d=Eo);break;case Eo:r!==qi&&(c.fragment+=jo(r,Cv))}l++}},parseHost:function(t){var e,n,i;if(Ji(t,0)==="["){if(Ji(t,t.length-1)!=="]"||(e=function(r){var o,s,a,c,d,l,u,h=[0,0,0,0,0,0,0,0],p=0,S=null,E=0,f=function(){return Ji(r,E)};if(f()===":"){if(Ji(r,1)!==":")return;E+=2,S=++p}for(;f();){if(p===8)return;if(f()!==":"){for(o=s=0;s<4&&Er(Rv,f());)o=16*o+gu(f(),16),E++,s++;if(f()==="."){if(s===0||(E-=s,p>6))return;for(a=0;f();){if(c=null,a>0){if(!(f()==="."&&a<4))return;E++}if(!Er(Xm,f()))return;for(;Er(Xm,f());){if(d=gu(f(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;E++}h[p]=256*h[p]+c,++a!=2&&a!==4||p++}if(a!==4)return;break}if(f()===":"){if(E++,!f())return}else if(f())return;h[p++]=o}else{if(S!==null)return;E++,S=++p}}if(S!==null)for(l=p-S,p=7;p!==0&&l>0;)u=h[p],h[p--]=h[S+l-1],h[S+--l]=u;else if(p!==8)return;return h}(Ed(t,1,-1)),!e))return ys;this.host=e}else if(this.isSpecial()){if(t=hj(t),Er(wj,t)||(e=function(r){var o,s,a,c,d,l,u,h=Cj(r,".");if(h.length&&h[h.length-1]===""&&h.length--,(o=h.length)>4)return r;for(s=[],a=0;a<o;a++){if((c=h[a])==="")return r;if(d=10,c.length>1&&Ji(c,0)==="0"&&(d=Er(Ij,c)?16:8,c=Ed(c,d===8?1:2)),c==="")l=0;else{if(!Er(d===10?bj:d===8?Aj:Rv,c))return r;l=gu(c,d)}Ua(s,l)}for(a=0;a<o;a++)if(l=s[a],a===o-1){if(l>=gv(256,5-o))return null}else if(l>255)return null;for(u=Tj(s),a=0;a<s.length;a++)u+=s[a]*gv(256,3-a);return u}(t),e===null))return ys;this.host=e}else{if(Er(Oj,t))return ys;for(e="",n=Ma(t),i=0;i<n.length;i++)e+=jo(n[i],Tu);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Hm(Ru,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme==="file"&&e===1&&gd(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,i=t.password,r=t.host,o=t.port,s=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=n+(i?":"+i:"")+"@"),d+=fd(r),o!==null&&(d+=":"+o)):e==="file"&&(d+="//"),d+=t.cannotBeABaseURL?s[0]:s.length?"/"+md(s,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw new Ym(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t==="blob")try{return new Va(t.path[0]).origin}catch{return"null"}return t!=="file"&&this.isSpecial()?t+"://"+fd(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(mo(t)+":",Qm)},getUsername:function(){return this.username},setUsername:function(t){var e=Ma(mo(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=jo(e[n],Jm)}},getPassword:function(){return this.password},setPassword:function(t){var e=Ma(mo(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=jo(e[n],Jm)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?fd(t):fd(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,tE)},getHostname:function(){var t=this.host;return t===null?"":fd(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,eE)},getPort:function(){var t=this.port;return t===null?"":mo(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=mo(t))===""?this.port=null:this.parse(t,nE))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+md(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,xa))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=mo(t))===""?this.query=null:(Ji(t,0)==="?"&&(t=Ed(t,1)),this.query="",this.parse(t,Is)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=mo(t))!==""?(Ji(t,0)==="#"&&(t=Ed(t,1)),this.fragment="",this.parse(t,Eo)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Va=function(t){var e=lj(this,ci),n=_j(arguments.length,1)>1?arguments[1]:void 0,i=mj(e,new oE(t,!1,n));Gm||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash())},ci=Va.prototype,Qi=function(t,e){return{get:function(){return fu(this)[t]()},set:e&&function(n){return fu(this)[e](n)},configurable:!0,enumerable:!0}};if(Gm&&(Xi(ci,"href",Qi("serialize","setHref")),Xi(ci,"origin",Qi("getOrigin")),Xi(ci,"protocol",Qi("getProtocol","setProtocol")),Xi(ci,"username",Qi("getUsername","setUsername")),Xi(ci,"password",Qi("getPassword","setPassword")),Xi(ci,"host",Qi("getHost","setHost")),Xi(ci,"hostname",Qi("getHostname","setHostname")),Xi(ci,"port",Qi("getPort","setPort")),Xi(ci,"pathname",Qi("getPathname","setPathname")),Xi(ci,"search",Qi("getSearch","setSearch")),Xi(ci,"searchParams",Qi("getSearchParams")),Xi(ci,"hash",Qi("getHash","setHash"))),Eu(ci,"toJSON",function(){return fu(this).serialize()},{enumerable:!0}),Eu(ci,"toString",function(){return fu(this).serialize()},{enumerable:!0}),_d){var Pv=_d.createObjectURL,Lv=_d.revokeObjectURL;Pv&&Eu(Va,"createObjectURL",mv(Pv,_d)),Lv&&Eu(Va,"revokeObjectURL",mv(Lv,_d))}pj(Va,"URL"),cj({global:!0,constructor:!0,forced:!dj,sham:!Gm},{URL:Va});var kj=Yt,kv=z,Mj=Ts,Mv=oi,Uj=lu,sE=Bn("URL"),xj=Uj&&kv(function(){sE.canParse()}),Vj=kv(function(){return sE.canParse.length!==1});kj({target:"URL",stat:!0,forced:!xj||Vj},{canParse:function(t){var e=Mj(arguments.length,1),n=Mv(t),i=e<2||arguments[1]===void 0?void 0:Mv(arguments[1]);try{return!!new sE(n,i)}catch{return!1}}});var Fj=Yt,Bj=Ts,Uv=oi,jj=lu,Gj=Bn("URL");Fj({target:"URL",stat:!0,forced:!jj},{parse:function(t){var e=Bj(arguments.length,1),n=Uv(t),i=e<2||arguments[1]===void 0?void 0:Uv(arguments[1]);try{return new Gj(n,i)}catch{return null}}});var yu=H(pi.URL);let xv=!0,Vv=!0;function Iu(t,e,n){let i=t.match(e);return i&&i.length>=n&&parseInt(i[n],10)}function As(t,e,n){if(!t.RTCPeerConnection)return;let i=t.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);let c=d=>{let l=n(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};let o=i.removeEventListener;i.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);let c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function Wj(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(xv=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function Hj(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(Vv=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function Fv(){if(typeof window=="object"){if(xv)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function aE(t,e){Vv&&console.warn(t+" is deprecated, please use "+e+" instead.")}function Bv(t){return Object.prototype.toString.call(t)==="[object Object]"}function jv(t){var e;return Bv(t)?Pi(e=Object.keys(t)).call(e,function(n,i){let r=Bv(t[i]),o=r?jv(t[i]):t[i],s=r&&!Object.keys(o).length;return o===void 0||s?n:Object.assign(n,{[i]:o})},{}):t}function cE(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?cE(t,t.get(e[i]),n):i.endsWith("Ids")&&e[i].forEach(r=>{cE(t,t.get(r),n)})}))}function Gv(t,e,n){let i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;let o=[];return t.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{t.forEach(a=>{a.type===i&&a.trackId===s.id&&cE(t,a,r)})}),r}let Wv=Fv;function Hv(t,e){let n=t&&t.navigator;if(!n.mediaDevices)return;let i=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;let d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);let l=function(u,h){return u?u+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){let c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=i(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});let d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return n.mediaDevices.enumerateDevices().then(u=>{u=u.filter(p=>p.kind==="videoinput");let h=u.find(p=>l.some(S=>{var E;return B(E=p.label.toLowerCase()).call(E,S)}));return!h&&u.length&&B(l).call(l,"back")&&(h=u[u.length-1]),h&&(s.video.deviceId=c.exact?{exact:h.deviceId}:{ideal:h.deviceId}),s.video=i(s.video),Wv("chrome: "+JSON.stringify(s)),a(s)})}s.video=i(s.video)}return Wv("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(s,a,c){r(s,d=>{n.webkitGetUserMedia(d,a,l=>{c&&c(o(l))})})}.bind(n),n.mediaDevices.getUserMedia){let s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return d},d=>Y.reject(o(d))))}}}function Kv(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function Yv(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.track.id):{track:i.track};let o=new Event("track");o.track=i.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===i.id):{track:i};let o=new Event("track");o.track=i,o.receiver=r,o.transceiver={receiver:r},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else As(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function qv(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){let e=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};let o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);let a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1)}}let n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o))})};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{let s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){let e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){let n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function zv(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);let o=function(a){let c={};return a.result().forEach(d=>{let l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(u=>{l[u]=d.stat(u)}),c[l.id]=l}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){let a=function(c){i(s(o(c)))};return e.apply(this,[a,n])}return new Y((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(i,r)}}function Xv(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){let n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){let r=n.apply(this,[]);return r.forEach(o=>o._pc=this),r});let i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){let r=i.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){let r=this;return this._pc.getStats().then(o=>Gv(o,r.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){let n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){let i=n.apply(this,[]);return i.forEach(r=>r._pc=this),i}),As(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){let i=this;return this._pc.getStats().then(r=>Gv(r,i.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){let n=arguments[0],i,r,o;return this.getSenders().forEach(s=>{s.track===n&&(i?o=!0:i=s)}),this.getReceivers().forEach(s=>(s.track===n&&(r?o=!0:r=s),s.track===n)),o||i&&r?Y.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():Y.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Jv(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};let n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(l=>l.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();n.apply(this,arguments);let a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a)};let i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],i.apply(this,arguments)};let r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function Qv(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return Jv(t);let n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){let c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};let i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){let d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};let r=t.RTCPeerConnection.prototype.removeStream;function o(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(p.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let h=this._streams[d.id];if(h)h.addTrack(c),Y.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let p=new t.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){let d=t.RTCPeerConnection.prototype[c],l={[c](){let u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{let p=o(this,h);u[0].apply(null,[p])},h=>{u[1]&&u[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then(h=>o(this,h))}};t.RTCPeerConnection.prototype[c]=l[c]});let s=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(h.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};let a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){let c=a.get.apply(this);return c.type===""?c:o(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(u=>c.track===u)&&(d=this._streams[l])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function dE(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){let i=t.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=r[n]})}function Zv(t,e){As(t,"negotiationneeded",n=>{let i=n.target;if(!(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n})}var $v=Object.freeze({__proto__:null,fixNegotiationNeeded:Zv,shimAddTrackRemoveTrack:Qv,shimAddTrackRemoveTrackWithNative:Jv,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(i=>{let r=n.video&&n.video.width,o=n.video&&n.video.height,s=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:s||3}},r&&(n.video.mandatory.maxWidth=r),o&&(n.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:qv,shimGetStats:zv,shimGetUserMedia:Hv,shimMediaStream:Kv,shimOnTrack:Yv,shimPeerConnection:dE,shimSenderReceiverGetStats:Xv});function ty(t,e){let n=t&&t.navigator,i=t&&t.MediaStreamTrack;if(n.getUserMedia=function(r,o,s){aE("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(o,s)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){let r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},i&&i.prototype.getSettings){let s=i.prototype.getSettings;i.prototype.getSettings=function(){let a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){let s=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function ey(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function lE(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let o=t.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=s[r]});let n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[r,o,s]=arguments;return i.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=n[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:n[d.type]||d.type}))})}return a}).then(o,s)}}function ny(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;let e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i});let n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){let i=n.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Y.resolve(new Map)}}function iy(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;let e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){let n=e.apply(this,[]);return n.forEach(i=>i._pc=this),n}),As(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function ry(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){aE("removeStream","removeTrack"),this.getSenders().forEach(n=>{var i;n.track&&B(i=e.getTracks()).call(i,n.track)&&this.removeTrack(n)})})}function oy(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function sy(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];let i=n.length>0;i&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let r=e.apply(this,arguments);if(i){let{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return r})}function ay(t){if(typeof t!="object"||!t.RTCRtpSender)return;let e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){let n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function cy(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Y.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function dy(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Y.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var ly=Object.freeze({__proto__:null,shimAddTransceiver:sy,shimCreateAnswer:dy,shimCreateOffer:cy,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){let i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,Y.reject(i)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:ay,shimGetUserMedia:ty,shimOnTrack:ey,shimPeerConnection:lE,shimRTCDataChannel:oy,shimReceiverGetStats:iy,shimRemoveStream:ry,shimSenderGetStats:ny});function uy(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),B(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach(r=>e.call(this,r,n)),n.getVideoTracks().forEach(r=>e.call(this,r,n))},t.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{var a;this._localStreams?B(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);let i=e.getTracks();this.getSenders().forEach(r=>{B(i).call(i,r.track)&&this.removeTrack(r)})})}}function hy(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),B(o=this._remoteStreams).call(o,r))return;this._remoteStreams.push(r);let s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){let n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach(r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);let o=new Event("addstream");o.stream=r,n.dispatchEvent(o)})}),e.apply(n,arguments)}}}function py(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype,n=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),Y.resolve()):u},e.createAnswer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=i.apply(this,[l]);return d?(u.then(c,d),Y.resolve()):u};let a=function(c,d,l){let u=r.apply(this,[c]);return l?(u.then(d,l),Y.resolve()):u};e.setLocalDescription=a,a=function(c,d,l){let u=o.apply(this,[c]);return l?(u.then(d,l),Y.resolve()):u},e.setRemoteDescription=a,a=function(c,d,l){let u=s.apply(this,[c]);return l?(u.then(d,l),Y.resolve()):u},e.addIceCandidate=a}function _y(t){let e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let n=e.mediaDevices,i=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=r=>i(my(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(n,i,r){e.mediaDevices.getUserMedia(n).then(i,r)}.bind(e))}function my(t){return t&&t.video!==void 0?Object.assign({},t,{video:jv(t.video)}):t}function Ey(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,i){if(n&&n.iceServers){let r=[];for(let o=0;o<n.iceServers.length;o++){let s=n.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(aE("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(n.iceServers[o])}n.iceServers=r}return new e(n,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function fy(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function gy(t){let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);let i=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);let r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function Sy(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var Ty=Object.freeze({__proto__:null,shimAudioContext:Sy,shimCallbacksAPI:py,shimConstraints:my,shimCreateOfferLegacy:gy,shimGetUserMedia:_y,shimLocalStreamsAPI:uy,shimRTCIceServerUrls:Ey,shimRemoteStreamsAPI:hy,shimTrackEventTransceiver:fy}),Ry=`	
\v\f\r \xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF`,Kj=No,Yj=oi,uE=Ry,Cy=ft("".replace),qj=RegExp("^["+uE+"]+"),zj=RegExp("(^|[^"+uE+"])["+uE+"]+$"),hE=function(t){return function(e){var n=Yj(Kj(e));return 1&t&&(n=Cy(n,qj,"")),2&t&&(n=Cy(n,zj,"$1")),n}},Xj={start:hE(1),end:hE(2),trim:hE(3)},Jj=iR.PROPER,Qj=z,vy=Ry,Zj=Xj.trim;Yt({target:"String",proto:!0,forced:function(t){return Qj(function(){return!!vy[t]()||"\u200B\x85\u180E"[t]()!=="\u200B\x85\u180E"||Jj&&vy[t].name!==t})}("trim")},{trim:function(){return Zj(this)}});var $j=Di("String","trim"),tG=At,eG=$j,pE=String.prototype,nG=function(t){var e=t.trim;return typeof t=="string"||t===pE||tG(pE,t)&&e===pE.trim?eG:e},Pn=H(nG),yy={exports:{}};(function(t){let e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(n){return n.split(`
m=`).map((i,r)=>(r>0?"m="+i:i).trim()+`\r
`)},e.getDescription=function(n){let i=e.splitSections(n);return i&&i[0]},e.getMediaSections=function(n){let i=e.splitSections(n);return i.shift(),i},e.matchPrefix=function(n,i){return e.splitLines(n).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");let r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let o=8;o<i.length;o+=2)switch(i[o]){case"raddr":r.relatedAddress=i[o+1];break;case"rport":r.relatedPort=parseInt(i[o+1],10);break;case"tcptype":r.tcpType=i[o+1];break;case"ufrag":r.ufrag=i[o+1],r.usernameFragment=i[o+1];break;default:r[i[o]]===void 0&&(r[i[o]]=i[o+1])}return r},e.writeCandidate=function(n){let i=[];i.push(n.foundation);let r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);let o=n.type;return i.push("typ"),i.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let i=n.substring(9).split(" "),r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);let r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(n){let i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){let i={},r,o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){let o=[];Object.keys(n.parameters).forEach(s=>{n.parameters[s]!==void 0?o.push(s+"="+n.parameters[s]):o.push(s)}),i+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return i},e.parseRtcpFb=function(n){let i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{i+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(n){let i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},o=n.indexOf(":",i);return o>-1?(r.attribute=n.substring(i+1,o),r.value=n.substring(o+1)):r.attribute=n.substring(i+1),r},e.parseSsrcGroup=function(n){let i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(n){let i=e.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(n){let i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:e.matchPrefix(n+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},e.parseCryptoLine=function(n){let i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;let i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,i){return e.matchPrefix(n+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,i){let r=e.matchPrefix(n+i,"a=ice-ufrag:")[0],o=e.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(n){let i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(n)[0].split(" ");i.profile=r[2];for(let s=3;s<r.length;s++){let a=r[s],c=e.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){let d=e.parseRtpMap(c),l=e.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach(s=>{i.headerExtensions.push(e.parseExtmap(s))});let o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a)})}),i},e.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s)});let o=0;return i.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(s=>{r+=e.writeExtmap(s)}),r},e.parseRtpEncodingParameters=function(n){let i=[],r=e.parseRtpParameters(n),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(n,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc,d,l=e.matchPrefix(n,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(p=>parseInt(p,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let u=e.matchPrefix(n,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,i.forEach(h=>{h.maxBitrate=u})),i},e.parseRtcpParameters=function(n){let i={},r=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);let o=e.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;let s=e.matchPrefix(n,"a=rtcp-mux");return i.mux=s.length>0,i},e.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},e.parseMsid=function(n){let i,r=e.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};let o=e.matchPrefix(n,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(i=o[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(n){let i=e.parseMLine(n),r=e.matchPrefix(n,"a=max-message-size:"),o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);let s=e.matchPrefix(n,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};let a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){let c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,i,r){let o,s=i!==void 0?i:2;return o=n||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,i){let r=e.splitLines(n);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){let i=e.splitLines(n)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(n){let i=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;let i=e.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},t.exports=e})(yy);var Iy=yy.exports,Fa=H(Iy),iG=M({__proto__:null,default:Fa},[Iy]);function Au(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;let e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){let i=new e(n),r=Fa.parseCandidate(n.candidate),o=Object.assign(i,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,As(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n))}function _E(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||As(t,"icecandidate",e=>{if(e.candidate){let n=Fa.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function bu(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let n=function(a){if(!a||!a.sdp)return!1;let c=Fa.splitSections(a.sdp);return c.shift(),c.some(d=>{let l=Fa.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},i=function(a){let c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;let d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);let l=Fa.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){let{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){let a=i(arguments[0]),c=r(a),d=o(arguments[0],a),l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);let u={};Object.defineProperty(u,"maxMessageSize",{get:()=>l}),this._sctp=u}return s.apply(this,arguments)}}function wu(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(i,r){let o=i.send;i.send=function(){let s=arguments[0],a=s.length||s.size||s.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}let n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){let i=n.apply(this,arguments);return e(i,this),i},As(t,"datachannel",i=>(e(i.channel,i.target),i))}function mE(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;let e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{let i=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;let s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function EE(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;let n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let r=i.sdp.split(`
`).filter(o=>Pn(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&i instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return n.apply(this,arguments)}}function Ou(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let n=t.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Y.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Y.resolve())})}function Nu(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let n=t.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>n.apply(this,[r]))})}var rG=Object.freeze({__proto__:null,removeExtmapAllowMixed:EE,shimAddIceCandidateNullOrEmpty:Ou,shimConnectionState:mE,shimMaxMessageSize:bu,shimParameterlessSetLocalDescription:Nu,shimRTCIceCandidate:Au,shimRTCIceCandidateRelayProtocol:_E,shimSendThrowTypeError:wu});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},n=Fv,i=function(o){let s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;let{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=Iu(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=Iu(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=Iu(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(t),r={browserDetails:i,commonShim:rG,extractVersion:Iu,disableLog:Wj,disableWarnings:Hj,sdp:iG};switch(i.browser){case"chrome":if(!$v||!dE||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=$v,Ou(t,i),Nu(t),Hv(t,i),Kv(t),dE(t,i),Yv(t),Qv(t,i),qv(t),zv(t),Xv(t),Zv(t,i),Au(t),_E(t),mE(t),bu(t,i),wu(t),EE(t,i);break;case"firefox":if(!ly||!lE||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=ly,Ou(t,i),Nu(t),ty(t,i),lE(t,i),ey(t),ry(t),ny(t),iy(t),oy(t),sy(t),ay(t),cy(t),dy(t),Au(t),mE(t),bu(t,i),wu(t);break;case"safari":if(!Ty||!e.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=Ty,Ou(t,i),Nu(t),Ey(t),gy(t),py(t),uy(t),hy(t),fy(t),_y(t),Sy(t),Au(t),_E(t),bu(t,i),wu(t),EE(t,i);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var oG=z,Ay=xt.RegExp,sG=!oG(function(){var t=!0;try{Ay(".","d")}catch{t=!1}var e={},n="",i=t?"dgimsy":"gimsy",r=function(a,c){Object.defineProperty(e,a,{get:function(){return n+=c,!0}})},o={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var s in t&&(o.hasIndices="d"),o)r(s,o[s]);return Object.getOwnPropertyDescriptor(Ay.prototype,"flags").get.call(e)!==i||n!==i}),aG=ri,cG=hn,dG=yn,lG=At,by={correct:sG},uG=function(){var t=aG(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},hG=RegExp.prototype,fE=by.correct?function(t){return t.flags}:function(t){return by.correct||!lG(hG,t)||dG(t,"flags")?t.flags:cG(uG,t)},gE=ft,pG=pr,_G=Math.floor,SE=gE("".charAt),mG=gE("".replace),TE=gE("".slice),EG=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,fG=/\$([$&'`]|\d{1,2})/g,gG=Yt,SG=hn,RE=ft,wy=No,TG=an,RG=Dn,CG=R_,Ba=oi,vG=Jc,yG=fE,IG=function(t,e,n,i,r,o){var s=n+t.length,a=i.length,c=fG;return r!==void 0&&(r=pG(r),c=EG),mG(o,c,function(d,l){var u;switch(SE(l,0)){case"$":return"$";case"&":return t;case"`":return TE(e,0,n);case"'":return TE(e,s);case"<":u=r[TE(l,1,-1)];break;default:var h=+l;if(h===0)return d;if(h>a){var p=_G(h/10);return p===0?d:p<=a?i[p-1]===void 0?SE(l,1):i[p-1]+SE(l,1):d}u=i[h-1]}return u===void 0?"":u})},AG=Me("replace"),bG=TypeError,CE=RE("".indexOf),wG=RE("".replace),Oy=RE("".slice),OG=Math.max;gG({target:"String",proto:!0},{replaceAll:function(t,e){var n,i,r,o,s,a,c,d,l,u,h=wy(this),p=0,S="";if(RG(t)){if((n=CG(t))&&(i=Ba(wy(yG(t))),!~CE(i,"g")))throw new bG("`.replaceAll` does not allow non-global regexes");if(r=vG(t,AG))return SG(r,t,h,e);if(n)return wG(Ba(h),t,e)}for(o=Ba(h),s=Ba(t),(a=TG(e))||(e=Ba(e)),c=s.length,d=OG(1,c),l=CE(o,s);l!==-1;)u=a?Ba(e(s,l,o)):IG(s,o,l,[],void 0,e),S+=Oy(o,p,l)+u,p=l+c,l=l+d>o.length?-1:CE(o,s,l+d);return p<o.length&&(S+=Oy(o,p)),S}});var NG=Di("String","replaceAll"),DG=At,PG=NG,vE=String.prototype,LG=function(t){var e=t.replaceAll;return typeof t=="string"||t===vE||DG(vE,t)&&e===vE.replaceAll?PG:e},kG=H(LG),yE=xt;Yt({global:!0,forced:yE.globalThis!==yE},{globalThis:yE});var Ny=H(xt),IE={exports:{}};(function(t,e){(function(n,i){var r="function",o="undefined",s="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",S="architecture",E="console",f="mobile",R="tablet",v="smarttv",I="wearable",w="embedded",O="Amazon",A="Apple",N="ASUS",k="BlackBerry",V="Browser",J="Chrome",ut="Firefox",dt="Google",Ct="Honor",St="Huawei",Gt="LG",fe="Microsoft",U="Motorola",K="Nvidia",$="OnePlus",x="Opera",m="OPPO",y="Samsung",b="Sharp",G="Sony",mt="Xiaomi",ce="Zebra",Je="Facebook",Wi="Chromium OS",ds="Mac OS",bp=" Browser",xc=function(Ve){for(var We={},_e=0;_e<Ve.length;_e++)We[Ve[_e].toUpperCase()]=Ve[_e];return We},wp=function(Ve,We){return typeof Ve===a&&da(We).indexOf(da(Ve))!==-1},da=function(Ve){return Ve.toLowerCase()},Cl=function(Ve,We){if(typeof Ve===a)return Ve=Ve.replace(/^\s\s*/,""),typeof We===o?Ve:Ve.substring(0,500)},la=function(Ve,We){for(var _e,ii,Ur,Ne,bo,Ut,xr=0;xr<We.length&&!bo;){var ua=We[xr],co=We[xr+1];for(_e=ii=0;_e<ua.length&&!bo&&ua[_e];)if(bo=ua[_e++].exec(Ve))for(Ur=0;Ur<co.length;Ur++)Ut=bo[++ii],typeof(Ne=co[Ur])===s&&Ne.length>0?Ne.length===2?typeof Ne[1]==r?this[Ne[0]]=Ne[1].call(this,Ut):this[Ne[0]]=Ne[1]:Ne.length===3?typeof Ne[1]!==r||Ne[1].exec&&Ne[1].test?this[Ne[0]]=Ut?Ut.replace(Ne[1],Ne[2]):i:this[Ne[0]]=Ut?Ne[1].call(this,Ut,Ne[2]):i:Ne.length===4&&(this[Ne[0]]=Ut?Ne[3].call(this,Ut.replace(Ne[1],Ne[2])):i):this[Ne]=Ut||i;xr+=2}},ls=function(Ve,We){for(var _e in We)if(typeof We[_e]===s&&We[_e].length>0){for(var ii=0;ii<We[_e].length;ii++)if(wp(We[_e][ii],Ve))return _e==="?"?i:_e}else if(wp(We[_e],Ve))return _e==="?"?i:_e;return We.hasOwnProperty("*")?We["*"]:Ve},fL={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},gL={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,x+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[p,[l,x+" GX"]],[/\bopr\/([\w\.]+)/i],[p,[l,x]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[p,[l,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[p,[l,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/quark(?:pc)?\/([-\w\.]+)/i],[p,[l,"Quark"]],[/\bddg\/([\w\.]+)/i],[p,[l,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+V]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[p,[l,"Smart Lenovo "+V]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+V],p],[/\bfocus\/([\w\.]+)/i],[p,[l,ut+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,x+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,x+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI"+bp]],[/fxios\/([\w\.-]+)/i],[p,[l,ut]],[/\bqihoobrowser\/?([\w\.]*)/i],[p,[l,"360"]],[/\b(qq)\/([\w\.]+)/i],[[l,/(.+)/,"$1Browser"],p],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1"+bp],p],[/samsungbrowser\/([\w\.]+)/i],[p,[l,y+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[p,[l,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[l,"Sogou Mobile"],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[l,p],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[l],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[p,l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,Je],p],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[p,[l,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,J+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,J+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+V]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,ls,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/(wolvic|librewolf)\/([\w\.]+)/i],[l,p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,ut+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[l,[p,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[S,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[S,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[S,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[S,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[S,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[S,/ower/,"",da]],[/ sun4\w[;\)]/i],[[S,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[S,da]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,y],[u,R]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,y],[u,f]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[h,A],[u,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,A],[u,R]],[/(macintosh);/i],[d,[h,A]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,b],[u,f]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[d,[h,Ct],[u,R]],[/honor([-\w ]+)[;\)]/i],[d,[h,Ct],[u,f]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[d,[h,St],[u,R]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,St],[u,f]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[d,/_/g," "],[h,mt],[u,R]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[d,/_/g," "],[h,mt],[u,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,m],[u,f]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[d,[h,ls,{OnePlus:["304","403","203"],"*":m}],[u,R]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,f]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,U],[u,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,U],[u,R]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,Gt],[u,R]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,Gt],[u,f]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[d,[h,"Lenovo"],[u,R]],[/(nokia) (t[12][01])/i],[h,d,[u,R]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[d,/_/g," "],[u,f],[h,"Nokia"]],[/(pixel (c|tablet))\b/i],[d,[h,dt],[u,R]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,dt],[u,f]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,G],[u,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,G],[u,R]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,$],[u,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,O],[u,R]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,O],[u,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,R]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,k],[u,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,N],[u,R]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,N],[u,f]],[/(nexus 9)/i],[d,[h,"HTC"],[u,R]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,f]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[h,"TCL"],[u,R]],[/(itel) ((\w+))/i],[[h,da],d,[u,ls,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,R]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,f]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[h,"Ulefone"],[u,f]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[h,"Energizer"],[u,f]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[h,"Cat"],[u,f]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[h,"Smartfren"],[u,f]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[h,"Nothing"],[u,f]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[d,[h,"Archos"],[u,R]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[d,[h,"Archos"],[u,f]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[h,d,[u,R]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,f]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,R]],[/(surface duo)/i],[d,[h,fe],[u,R]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,f]],[/(u304aa)/i],[d,[h,"AT&T"],[u,f]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,f]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,R]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,R]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,R]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,R]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,R]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,R]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,f]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,f]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,R]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,R]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,R]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,R]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,R]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,f]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,R]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,R]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,R]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[d,[h,K],[u,R]],[/(sprint) (\w+)/i],[h,d,[u,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,fe],[u,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,ce],[u,R]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,ce],[u,f]],[/smart-tv.+(samsung)/i],[h,[u,v]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,y],[u,v]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,Gt],[u,v]],[/(apple) ?tv/i],[h,[d,A+" TV"],[u,v]],[/crkey/i],[[d,J+"cast"],[h,dt],[u,v]],[/droid.+aft(\w+)( bui|\))/i],[d,[h,O],[u,v]],[/(shield \w+ tv)/i],[d,[h,K],[u,v]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,b],[u,v]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,G],[u,v]],[/(mi(tv|box)-?\w+) bui/i],[d,[h,mt],[u,v]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,v]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,Cl],[d,Cl],[u,v]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[d,[u,v]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,v]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,E]],[/droid.+; (shield)( bui|\))/i],[d,[h,K],[u,E]],[/(playstation \w+)/i],[d,[h,G],[u,E]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,fe],[u,E]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[d,[h,y],[u,I]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[h,d,[u,I]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[d,[h,m],[u,I]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,A],[u,I]],[/(opwwe\d{3})/i],[d,[h,$],[u,I]],[/(moto 360)/i],[d,[h,U],[u,I]],[/(smartwatch 3)/i],[d,[h,G],[u,I]],[/(g watch r)/i],[d,[h,Gt],[u,I]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,ce],[u,I]],[/droid.+; (glass) \d/i],[d,[h,dt],[u,I]],[/(pico) (4|neo3(?: link|pro)?)/i],[h,d,[u,I]],[/; (quest( \d| pro)?)/i],[d,[h,Je],[u,I]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,w]],[/(aeobc)\b/i],[d,[h,O],[u,w]],[/(homepod).+mac os/i],[d,[h,A],[u,w]],[/windows iot/i],[[u,w]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[u,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,R]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,R]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,f]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[l,p],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[l,p],[/ladybird\//i],[[l,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[l,[p,ls,fL]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,ls,fL],[l,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,ds],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(ubuntu) ([\w\.]+) like android/i],[[l,/(.+)/,"$1 Touch"],p],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[l,p],[/\(bb(10);/i],[p,[l,k]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,ut+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,J+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,Wi],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[l,p]]},Mr=function(Ve,We){if(typeof Ve===s&&(We=Ve,Ve=i),!(this instanceof Mr))return new Mr(Ve,We).getResult();var _e=typeof n!==o&&n.navigator?n.navigator:i,ii=Ve||(_e&&_e.userAgent?_e.userAgent:""),Ur=_e&&_e.userAgentData?_e.userAgentData:i,Ne=We?function(Ut,xr){var ua={};for(var co in Ut)xr[co]&&xr[co].length%2==0?ua[co]=xr[co].concat(Ut[co]):ua[co]=Ut[co];return ua}(gL,We):gL,bo=_e&&_e.userAgent==ii;return this.getBrowser=function(){var Ut={};return Ut[l]=i,Ut[p]=i,la.call(Ut,ii,Ne.browser),Ut[c]=function(xr){return typeof xr===a?xr.replace(/[^\d\.]/g,"").split(".")[0]:i}(Ut[p]),bo&&_e&&_e.brave&&typeof _e.brave.isBrave==r&&(Ut[l]="Brave"),Ut},this.getCPU=function(){var Ut={};return Ut[S]=i,la.call(Ut,ii,Ne.cpu),Ut},this.getDevice=function(){var Ut={};return Ut[h]=i,Ut[d]=i,Ut[u]=i,la.call(Ut,ii,Ne.device),bo&&!Ut[u]&&Ur&&Ur.mobile&&(Ut[u]=f),bo&&Ut[d]=="Macintosh"&&_e&&typeof _e.standalone!==o&&_e.maxTouchPoints&&_e.maxTouchPoints>2&&(Ut[d]="iPad",Ut[u]=R),Ut},this.getEngine=function(){var Ut={};return Ut[l]=i,Ut[p]=i,la.call(Ut,ii,Ne.engine),Ut},this.getOS=function(){var Ut={};return Ut[l]=i,Ut[p]=i,la.call(Ut,ii,Ne.os),bo&&!Ut[l]&&Ur&&Ur.platform&&Ur.platform!="Unknown"&&(Ut[l]=Ur.platform.replace(/chrome os/i,Wi).replace(/macos/i,ds)),Ut},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return ii},this.setUA=function(Ut){return ii=typeof Ut===a&&Ut.length>500?Cl(Ut,500):Ut,this},this.setUA(ii),this};Mr.VERSION="0.7.41",Mr.BROWSER=xc([l,p,c]),Mr.CPU=xc([S]),Mr.DEVICE=xc([d,h,u,E,f,v,R,I,w]),Mr.ENGINE=Mr.OS=xc([l,p]),t.exports&&(e=t.exports=Mr),e.UAParser=Mr;var Vc=typeof n!==o&&(n.jQuery||n.Zepto);if(Vc&&!Vc.ua){var Op=new Mr;Vc.ua=Op.getResult(),Vc.ua.get=function(){return Op.getUA()},Vc.ua.set=function(Ve){Op.setUA(Ve);var We=Op.getResult();for(var _e in We)Vc.ua[_e]=We[_e]}}})(typeof window=="object"?window:F)})(IE,IE.exports);var MG=H(IE.exports),Dy=iu.clear;Yt({global:!0,bind:!0,enumerable:!0,forced:xt.clearImmediate!==Dy},{clearImmediate:Dy});var Py=xt,UG=Te,xG=an,VG=I_,FG=po,BG=Uo,jG=Ts,GG=Py.Function,WG=/MSIE .\./.test(FG)||VG==="BUN"&&function(){var t=Py.Bun.version.split(".");return t.length<3||t[0]==="0"&&(t[1]<3||t[1]==="3"&&t[2]==="0")}(),HG=Yt,Ly=xt,ky=iu.set,KG=function(t,e){var n=e?2:1;return WG?function(i,r){var o=jG(arguments.length,1)>n,s=xG(i)?i:GG(i),a=o?BG(arguments,n):[],c=o?function(){UG(s,this,a)}:s;return e?t(c,r):t(c)}:t},My=Ly.setImmediate?KG(ky,!1):ky;HG({global:!0,bind:!0,enumerable:!0,forced:Ly.setImmediate!==My},{setImmediate:My});var Uy=H(pi.setImmediate),YG=xt,qG=GR,zG=_i,XG=Ts,JG=Qn;Yt({global:!0,enumerable:!0,dontCallGetSet:!0,forced:z(function(){return JG&&Object.getOwnPropertyDescriptor(YG,"queueMicrotask").value.length!==1})},{queueMicrotask:function(t){XG(arguments.length,1),qG(zG(t))}});var xy=H(pi.queueMicrotask);function Vy(t,e){return function(){return t.apply(e,arguments)}}let{toString:QG}=Object.prototype,{getPrototypeOf:AE}=Object,{iterator:Du,toStringTag:Fy}=Symbol,Pu=(bE=Object.create(null),t=>{let e=QG.call(t);return bE[e]||(bE[e]=e.slice(8,-1).toLowerCase())});var bE;let fr=t=>(t=t.toLowerCase(),e=>Pu(e)===t),Lu=t=>e=>typeof e===t,{isArray:ja}=Array,Ga=Lu("undefined");function Sd(t){return t!==null&&!Ga(t)&&t.constructor!==null&&!Ga(t.constructor)&&mi(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}let By=fr("ArrayBuffer"),ZG=Lu("string"),mi=Lu("function"),jy=Lu("number"),Td=t=>t!==null&&typeof t=="object",ku=t=>{if(Pu(t)!=="object")return!1;let e=AE(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||Fy in t||Du in t)},$G=fr("Date"),t3=fr("File"),e3=fr("Blob"),n3=fr("FileList"),i3=fr("URLSearchParams"),[r3,o3,s3,a3]=["ReadableStream","Request","Response","Headers"].map(fr);function Rd(t,e){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),ja(t))for(n=0,i=t.length;n<i;n++)e.call(null,t[n],n,t);else{if(Sd(t))return;let o=r?Object.getOwnPropertyNames(t):Object.keys(t),s=o.length,a;for(n=0;n<s;n++)a=o[n],e.call(null,t[a],a,t)}}function Gy(t,e){if(Sd(t))return null;e=e.toLowerCase();let n=Object.keys(t),i,r=n.length;for(;r-- >0;)if(i=n[r],e===i.toLowerCase())return i;return null}let bs=Ny!==void 0?Ny:typeof self<"u"?self:typeof window<"u"?window:global,Wy=t=>!Ga(t)&&t!==bs,c3=(wE=typeof Uint8Array<"u"&&AE(Uint8Array),t=>wE&&t instanceof wE);var wE;let d3=fr("HTMLFormElement"),Hy=(t=>{let{hasOwnProperty:e}=t;return(n,i)=>e.call(n,i)})(Object.prototype),l3=fr("RegExp"),Ky=(t,e)=>{let n=Object.getOwnPropertyDescriptors(t),i={};Rd(n,(r,o)=>{let s;(s=e(r,o,t))!==!1&&(i[o]=s||r)}),Object.defineProperties(t,i)},u3=fr("AsyncFunction"),Yy=(qy=typeof Uy=="function",zy=mi(bs.postMessage),qy?Uy:zy?(OE="axios@".concat(Math.random()),Mu=[],bs.addEventListener("message",t=>{let{source:e,data:n}=t;e===bs&&n===OE&&Mu.length&&Mu.shift()()},!1),t=>{Mu.push(t),bs.postMessage(OE,"*")}):t=>setTimeout(t));var qy,zy,OE,Mu;let h3=xy!==void 0?xy.bind(bs):typeof process<"u"&&process.nextTick||Yy;var X={isArray:ja,isArrayBuffer:By,isBuffer:Sd,isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||mi(t.append)&&((e=Pu(t))==="formdata"||e==="object"&&mi(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&By(t.buffer),e},isString:ZG,isNumber:jy,isBoolean:t=>t===!0||t===!1,isObject:Td,isPlainObject:ku,isEmptyObject:t=>{if(!Td(t)||Sd(t))return!1;try{return Object.keys(t).length===0&&Object.getPrototypeOf(t)===Object.prototype}catch{return!1}},isReadableStream:r3,isRequest:o3,isResponse:s3,isHeaders:a3,isUndefined:Ga,isDate:$G,isFile:t3,isBlob:e3,isRegExp:l3,isFunction:mi,isStream:t=>Td(t)&&mi(t.pipe),isURLSearchParams:i3,isTypedArray:c3,isFileList:n3,forEach:Rd,merge:function t(){let{caseless:e,skipUndefined:n}=Wy(this)&&this||{},i={},r=(o,s)=>{let a=e&&Gy(i,s)||s;ku(i[a])&&ku(o)?i[a]=t(i[a],o):ku(o)?i[a]=t({},o):ja(o)?i[a]=o.slice():n&&Ga(o)||(i[a]=o)};for(let o=0,s=arguments.length;o<s;o++)arguments[o]&&Rd(arguments[o],r);return i},extend:function(t,e,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Rd(e,(r,o)=>{n&&mi(r)?t[o]=Vy(r,n):t[o]=r},{allOwnKeys:i}),t},trim:t=>Pn(t)?Pn(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,n,i)=>{t.prototype=Object.create(e.prototype,i),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},toFlatObject:(t,e,n,i)=>{let r,o,s,a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),o=r.length;o-- >0;)s=r[o],i&&!i(s,t,e)||a[s]||(e[s]=t[s],a[s]=!0);t=n!==!1&&AE(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:Pu,kindOfTest:fr,endsWith:(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;let i=t.indexOf(e,n);return i!==-1&&i===n},toArray:t=>{if(!t)return null;if(ja(t))return t;let e=t.length;if(!jy(e))return null;let n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{let n=(t&&t[Du]).call(t),i;for(;(i=n.next())&&!i.done;){let r=i.value;e.call(t,r[0],r[1])}},matchAll:(t,e)=>{let n,i=[];for(;(n=t.exec(e))!==null;)i.push(n);return i},isHTMLForm:d3,hasOwnProperty:Hy,hasOwnProp:Hy,reduceDescriptors:Ky,freezeMethods:t=>{Ky(t,(e,n)=>{if(mi(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;let i=t[n];mi(i)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(t,e)=>{let n={},i=r=>{r.forEach(o=>{n[o]=!0})};return ja(t)?i(t):i(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,i){return n.toUpperCase()+i}),noop:()=>{},toFiniteNumber:(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,findKey:Gy,global:bs,isContextDefined:Wy,isSpecCompliantForm:function(t){return!!(t&&mi(t.append)&&t[Fy]==="FormData"&&t[Du])},toJSONObject:t=>{let e=new Array(10),n=(i,r)=>{if(Td(i)){if(e.indexOf(i)>=0)return;if(Sd(i))return i;if(!("toJSON"in i)){e[r]=i;let o=ja(i)?[]:{};return Rd(i,(s,a)=>{let c=n(s,r+1);!Ga(c)&&(o[a]=c)}),e[r]=void 0,o}}return i};return n(t,0)},isAsyncFn:u3,isThenable:t=>t&&(Td(t)||mi(t))&&mi(t.then)&&mi(t.catch),setImmediate:Yy,asap:h3,isIterable:t=>t!=null&&mi(t[Du])};function ne(t,e,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r,this.status=r.status?r.status:null)}X.inherits(ne,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:X.toJSONObject(this.config),code:this.code,status:this.status}}});let Xy=ne.prototype,Jy={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Jy[t]={value:t}}),Object.defineProperties(ne,Jy),Object.defineProperty(Xy,"isAxiosError",{value:!0}),ne.from=(t,e,n,i,r,o)=>{let s=Object.create(Xy);X.toFlatObject(t,s,function(d){return d!==Error.prototype},d=>d!=="isAxiosError");let a=t&&t.message?t.message:"Error",c=e==null&&t?t.code:e;return ne.call(s,a,c,n,i,r),t&&s.cause==null&&Object.defineProperty(s,"cause",{value:t,configurable:!0}),s.name=t&&t.name||"Error",o&&Object.assign(s,o),s};function NE(t){return X.isPlainObject(t)||X.isArray(t)}function Qy(t){return X.endsWith(t,"[]")?t.slice(0,-2):t}function Zy(t,e,n){return t?t.concat(e).map(function(i,r){return i=Qy(i),!n&&r?"["+i+"]":i}).join(n?".":""):e}let p3=X.toFlatObject(X,{},null,function(t){return/^is[A-Z]/.test(t)});function Uu(t,e,n){if(!X.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;let i=(n=X.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(h,p){return!X.isUndefined(p[h])})).metaTokens,r=n.visitor||d,o=n.dots,s=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&X.isSpecCompliantForm(e);if(!X.isFunction(r))throw new TypeError("visitor must be a function");function c(h){if(h===null)return"";if(X.isDate(h))return h.toISOString();if(X.isBoolean(h))return h.toString();if(!a&&X.isBlob(h))throw new ne("Blob is not supported. Use a Buffer instead.");return X.isArrayBuffer(h)||X.isTypedArray(h)?a&&typeof Blob=="function"?new Blob([h]):Buffer.from(h):h}function d(h,p,S){let E=h;if(h&&!S&&typeof h=="object"){if(X.endsWith(p,"{}"))p=i?p:p.slice(0,-2),h=JSON.stringify(h);else if(X.isArray(h)&&function(f){return X.isArray(f)&&!f.some(NE)}(h)||(X.isFileList(h)||X.endsWith(p,"[]"))&&(E=X.toArray(h)))return p=Qy(p),E.forEach(function(f,R){!X.isUndefined(f)&&f!==null&&e.append(s===!0?Zy([p],R,o):s===null?p:p+"[]",c(f))}),!1}return!!NE(h)||(e.append(Zy(S,p,o),c(h)),!1)}let l=[],u=Object.assign(p3,{defaultVisitor:d,convertValue:c,isVisitable:NE});if(!X.isObject(t))throw new TypeError("data must be an object");return function h(p,S){if(!X.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+S.join("."));l.push(p),X.forEach(p,function(E,f){(!(X.isUndefined(E)||E===null)&&r.call(e,E,X.isString(f)?Pn(f).call(f):f,S,u))===!0&&h(E,S?S.concat(f):[f])}),l.pop()}}(t),e}function $y(t){let e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function DE(t,e){this._pairs=[],t&&Uu(t,this,e)}let tI=DE.prototype;function _3(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function eI(t,e,n){if(!e)return t;let i=n&&n.encode||_3;X.isFunction(n)&&(n={serialize:n});let r=n&&n.serialize,o;if(o=r?r(e,n):X.isURLSearchParams(e)?e.toString():new DE(e,n).toString(i),o){let s=t.indexOf("#");s!==-1&&(t=t.slice(0,s)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}tI.append=function(t,e){this._pairs.push([t,e])},tI.toString=function(t){let e=t?function(n){return t.call(this,n,$y)}:$y;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var nI=class{constructor(){this.handlers=[]}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){X.forEach(this.handlers,function(e){e!==null&&t(e)})}},iI={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},rI={exports:{}},m3=Yt,E3=Qn,oI=Ki.f;m3({target:"Object",stat:!0,forced:Object.defineProperty!==oI,sham:!E3},{defineProperty:oI});var sI=pi.Object,f3=rI.exports=function(t,e,n){return sI.defineProperty(t,e,n)};sI.defineProperty.sham&&(f3.sham=!0);var aI=H(rI.exports),g3=TypeError,cI=td,S3=nu,T3=Dn,R3=Me("species"),dI=Array,C3=function(t){var e;return cI(t)&&(e=t.constructor,(S3(e)&&(e===dI||cI(e.prototype))||T3(e)&&(e=e[R3])===null)&&(e=void 0)),e===void 0?dI:e},lI=function(t,e){return new(C3(t))(e===0?0:e)},v3=z,y3=Es,I3=Me("species"),uI=function(t){return y3>=51||!v3(function(){var e=[];return(e.constructor={})[I3]=function(){return{foo:1}},e[t](Boolean).foo!==1})},A3=Yt,b3=z,w3=td,O3=Dn,N3=pr,D3=Lo,hI=function(t){if(t>9007199254740991)throw g3("Maximum allowed index exceeded");return t},pI=Fm,P3=lI,L3=uI,k3=Es,_I=Me("isConcatSpreadable"),M3=k3>=51||!b3(function(){var t=[];return t[_I]=!1,t.concat()[0]!==t}),U3=function(t){if(!O3(t))return!1;var e=t[_I];return e!==void 0?!!e:w3(t)};A3({target:"Array",proto:!0,arity:1,forced:!M3||!L3("concat")},{concat:function(t){var e,n,i,r,o,s=N3(this),a=P3(s,0),c=0;for(e=-1,i=arguments.length;e<i;e++)if(U3(o=e===-1?s:arguments[e]))for(r=D3(o),hI(c+r),n=0;n<r;n++,c++)n in o&&pI(a,c,o[n]);else hI(c+1),pI(a,c++,o);return a.length=c,a}});var mI={},x3=vn,V3=Do,EI=Bl.f,F3=Uo,fI=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];mI.f=function(t){return fI&&x3(t)==="Window"?function(e){try{return EI(e)}catch{return F3(fI)}}(t):EI(V3(t))};var Wa={},B3=Me;Wa.f=B3;var gI=pi,j3=yn,G3=Wa,W3=Ki.f,cn=function(t){var e=gI.Symbol||(gI.Symbol={});j3(e,t)||W3(e,t,{value:G3.f(t)})},H3=hn,K3=Bn,Y3=Me,q3=Mo,SI=function(){var t=K3("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,i=Y3("toPrimitive");e&&!e[i]&&q3(e,i,function(r){return H3(n,this)},{arity:1})},z3=Po,X3=Pl,J3=pr,Q3=Lo,Z3=lI,TI=ft([].push),Go=function(t){var e=t===1,n=t===2,i=t===3,r=t===4,o=t===6,s=t===7,a=t===5||o;return function(c,d,l,u){for(var h,p,S=J3(c),E=X3(S),f=Q3(E),R=z3(d,l),v=0,I=u||Z3,w=e?I(c,f):n||s?I(c,0):void 0;f>v;v++)if((a||v in E)&&(p=R(h=E[v],v,S),t))if(e)w[v]=p;else if(p)switch(t){case 3:return!0;case 5:return h;case 6:return v;case 2:TI(w,h)}else switch(t){case 4:return!1;case 7:TI(w,h)}return o?-1:i||r?r:w}},RI={forEach:Go(0),map:Go(1),filter:Go(2),some:Go(3),every:Go(4),find:Go(5),findIndex:Go(6),filterReject:Go(7)},xu=Yt,Cd=xt,PE=hn,$3=ft,Ha=Qn,Ka=ma,tW=z,Ln=yn,eW=At,LE=ri,Vu=Do,kE=u_,nW=oi,ME=Oo,Ya=nd,CI=Gl,iW=Bl,vI=mI,rW=ed,yI=wl,II=Ki,oW=P_,AI=Nl,bI=Mo,sW=eu,UE=fa,wI=jl,OI=d_,aW=Me,cW=Wa,dW=cn,lW=SI,uW=_o,NI=Ss,Fu=RI.forEach,Ei=Fl("hidden"),Bu="Symbol",vd="prototype",hW=NI.set,DI=NI.getterFor(Bu),gr=Object[vd],ws=Cd.Symbol,ju=ws&&ws[vd],pW=Cd.RangeError,_W=Cd.TypeError,xE=Cd.QObject,PI=yI.f,Os=II.f,LI=vI.f,mW=AI.f,kI=$3([].push),fo=UE("symbols"),yd=UE("op-symbols"),EW=UE("wks"),VE=!xE||!xE[vd]||!xE[vd].findChild,MI=function(t,e,n){var i=PI(gr,e);i&&delete gr[e],Os(t,e,n),i&&t!==gr&&Os(gr,e,i)},FE=Ha&&tW(function(){return Ya(Os({},"a",{get:function(){return Os(this,"a",{value:7}).a}})).a!==7})?MI:Os,BE=function(t,e){var n=fo[t]=Ya(ju);return hW(n,{type:Bu,tag:t,description:e}),Ha||(n.description=e),n},Gu=function(t,e,n){t===gr&&Gu(yd,e,n),LE(t);var i=kE(e);return LE(n),Ln(fo,i)?(n.enumerable?(Ln(t,Ei)&&t[Ei][i]&&(t[Ei][i]=!1),n=Ya(n,{enumerable:ME(0,!1)})):(Ln(t,Ei)||Os(t,Ei,ME(1,Ya(null))),t[Ei][i]=!0),FE(t,i,n)):Os(t,i,n)},jE=function(t,e){LE(t);var n=Vu(e),i=CI(n).concat(FI(n));return Fu(i,function(r){Ha&&!PE(UI,n,r)||Gu(t,r,n[r])}),t},UI=function(t){var e=kE(t),n=PE(mW,this,e);return!(this===gr&&Ln(fo,e)&&!Ln(yd,e))&&(!(n||!Ln(this,e)||!Ln(fo,e)||Ln(this,Ei)&&this[Ei][e])||n)},xI=function(t,e){var n=Vu(t),i=kE(e);if(n!==gr||!Ln(fo,i)||Ln(yd,i)){var r=PI(n,i);return!r||!Ln(fo,i)||Ln(n,Ei)&&n[Ei][i]||(r.enumerable=!0),r}},VI=function(t){var e=LI(Vu(t)),n=[];return Fu(e,function(i){Ln(fo,i)||Ln(wI,i)||kI(n,i)}),n},FI=function(t){var e=t===gr,n=LI(e?yd:Vu(t)),i=[];return Fu(n,function(r){!Ln(fo,r)||e&&!Ln(gr,r)||kI(i,fo[r])}),i};Ka||(ws=function(){if(eW(ju,this))throw new _W("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?nW(arguments[0]):void 0,e=OI(t),n=function(i){var r=this===void 0?Cd:this;r===gr&&PE(n,yd,i),Ln(r,Ei)&&Ln(r[Ei],e)&&(r[Ei][e]=!1);var o=ME(1,i);try{FE(r,e,o)}catch(s){if(!(s instanceof pW))throw s;MI(r,e,o)}};return Ha&&VE&&FE(gr,e,{configurable:!0,set:n}),BE(e,t)},bI(ju=ws[vd],"toString",function(){return DI(this).tag}),bI(ws,"withoutSetter",function(t){return BE(OI(t),t)}),AI.f=UI,II.f=Gu,oW.f=jE,yI.f=xI,iW.f=vI.f=VI,rW.f=FI,cW.f=function(t){return BE(aW(t),t)},Ha&&sW(ju,"description",{configurable:!0,get:function(){return DI(this).description}})),xu({global:!0,constructor:!0,wrap:!0,forced:!Ka,sham:!Ka},{Symbol:ws}),Fu(CI(EW),function(t){dW(t)}),xu({target:Bu,stat:!0,forced:!Ka},{useSetter:function(){VE=!0},useSimple:function(){VE=!1}}),xu({target:"Object",stat:!0,forced:!Ka,sham:!Ha},{create:function(t,e){return e===void 0?Ya(t):jE(Ya(t),e)},defineProperty:Gu,defineProperties:jE,getOwnPropertyDescriptor:xI}),xu({target:"Object",stat:!0,forced:!Ka},{getOwnPropertyNames:VI}),lW(),uW(ws,Bu),wI[Ei]=!0;var BI=ma&&!!Symbol.for&&!!Symbol.keyFor,fW=Yt,gW=Bn,SW=yn,TW=oi,jI=fa,RW=BI,GE=jI("string-to-symbol-registry"),CW=jI("symbol-to-string-registry");fW({target:"Symbol",stat:!0,forced:!RW},{for:function(t){var e=TW(t);if(SW(GE,e))return GE[e];var n=gW("Symbol")(e);return GE[e]=n,CW[n]=e,n}});var vW=Yt,yW=yn,IW=Xc,AW=Ea,bW=BI,GI=fa("symbol-to-string-registry");vW({target:"Symbol",stat:!0,forced:!bW},{keyFor:function(t){if(!IW(t))throw new TypeError(AW(t)+" is not a symbol");if(yW(GI,t))return GI[t]}});var WI=td,wW=an,HI=vn,OW=oi,KI=ft([].push),NW=Yt,YI=Bn,qI=Te,DW=hn,Id=ft,zI=z,XI=an,JI=Xc,QI=Uo,PW=function(t){if(wW(t))return t;if(WI(t)){for(var e=t.length,n=[],i=0;i<e;i++){var r=t[i];typeof r=="string"?KI(n,r):typeof r!="number"&&HI(r)!=="Number"&&HI(r)!=="String"||KI(n,OW(r))}var o=n.length,s=!0;return function(a,c){if(s)return s=!1,c;if(WI(this))return c;for(var d=0;d<o;d++)if(n[d]===a)return c}}},LW=ma,kW=String,Wo=YI("JSON","stringify"),Wu=Id(/./.exec),ZI=Id("".charAt),MW=Id("".charCodeAt),UW=Id("".replace),xW=Id(1.1.toString),VW=/[\uD800-\uDFFF]/g,$I=/^[\uD800-\uDBFF]$/,tA=/^[\uDC00-\uDFFF]$/,eA=!LW||zI(function(){var t=YI("Symbol")("stringify detection");return Wo([t])!=="[null]"||Wo({a:t})!=="{}"||Wo(Object(t))!=="{}"}),nA=zI(function(){return Wo("\uDF06\uD834")!=='"\\udf06\\ud834"'||Wo("\uDEAD")!=='"\\udead"'}),FW=function(t,e){var n=QI(arguments),i=PW(e);if(XI(i)||t!==void 0&&!JI(t))return n[1]=function(r,o){if(XI(i)&&(o=DW(i,this,kW(r),o)),!JI(o))return o},qI(Wo,null,n)},BW=function(t,e,n){var i=ZI(n,e-1),r=ZI(n,e+1);return Wu($I,t)&&!Wu(tA,r)||Wu(tA,t)&&!Wu($I,i)?"\\u"+xW(MW(t,0),16):t};Wo&&NW({target:"JSON",stat:!0,arity:3,forced:eA||nA},{stringify:function(t,e,n){var i=QI(arguments),r=qI(eA?FW:Wo,null,i);return nA&&typeof r=="string"?UW(r,VW,BW):r}});var iA=ed,jW=pr;Yt({target:"Object",stat:!0,forced:!ma||z(function(){iA.f(1)})},{getOwnPropertySymbols:function(t){var e=iA.f;return e?e(jW(t)):[]}}),cn("asyncDispose"),cn("asyncIterator"),cn("dispose"),cn("hasInstance"),cn("isConcatSpreadable"),cn("iterator"),cn("match"),cn("matchAll"),cn("replace"),cn("search"),cn("species"),cn("split");var GW=SI;cn("toPrimitive"),GW();var WW=Bn,HW=_o;cn("toStringTag"),HW(WW("Symbol"),"Symbol"),cn("unscopables"),_o(xt.JSON,"JSON",!0);var KW=pi.Symbol,YW=Me,qW=Ki.f,rA=YW("metadata"),oA=Function.prototype;oA[rA]===void 0&&qW(oA,rA,{value:null}),cn("metadata");var zW=KW,XW=ft,WE=Bn("Symbol"),JW=WE.keyFor,QW=XW(WE.prototype.valueOf),sA=WE.isRegisteredSymbol||function(t){try{return JW(QW(t))!==void 0}catch{return!1}};Yt({target:"Symbol",stat:!0},{isRegisteredSymbol:sA});for(var ZW=fa,aA=Bn,$W=ft,t5=Xc,e5=Me,Hu=aA("Symbol"),cA=Hu.isWellKnownSymbol,dA=aA("Object","getOwnPropertyNames"),n5=$W(Hu.prototype.valueOf),lA=ZW("wks"),HE=0,uA=dA(Hu),i5=uA.length;HE<i5;HE++)try{var hA=uA[HE];t5(Hu[hA])&&e5(hA)}catch{}var pA=function(t){if(cA&&cA(t))return!0;try{for(var e=n5(t),n=0,i=dA(lA),r=i.length;n<r;n++)if(lA[i[n]]==e)return!0}catch{}return!1};Yt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:pA}),cn("customMatcher"),cn("observable"),Yt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:sA}),Yt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:pA}),cn("matcher"),cn("metadataKey"),cn("patternMatch"),cn("replaceAll");var qa=H(zW),_A=H(Wa.f("iterator"));function Ad(t){return Ad=typeof qa=="function"&&typeof _A=="symbol"?function(e){return typeof e}:function(e){return e&&typeof qa=="function"&&e.constructor===qa&&e!==qa.prototype?"symbol":typeof e},Ad(t)}var r5=H(Wa.f("toPrimitive"));function o5(t){var e=function(n,i){if(Ad(n)!="object"||!n)return n;var r=n[r5];if(r!==void 0){var o=r.call(n,i||"default");if(Ad(o)!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(n)}(t,"string");return Ad(e)=="symbol"?e:e+""}function g(t,e,n){return(e=o5(e))in t?aI(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var mA=H(DB),s5={isBrowser:!0,classes:{URLSearchParams:mA!==void 0?mA:DE,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};let KE=typeof window<"u"&&typeof document<"u",YE=typeof navigator=="object"&&navigator||void 0,a5=KE&&(!YE||["ReactNative","NativeScript","NS"].indexOf(YE.product)<0),c5=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",d5=KE&&window.location.href||"http://localhost";function EA(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function fA(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?EA(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):EA(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}var Zn=fA(fA({},Object.freeze({__proto__:null,hasBrowserEnv:KE,hasStandardBrowserEnv:a5,hasStandardBrowserWebWorkerEnv:c5,navigator:YE,origin:d5})),s5);function gA(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function l5(t,e){return Uu(t,new Zn.classes.URLSearchParams,function(n){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?gA(Object(r),!0).forEach(function(o){g(n,o,r[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):gA(Object(r)).forEach(function(o){Object.defineProperty(n,o,Object.getOwnPropertyDescriptor(r,o))})}return n}({visitor:function(n,i,r,o){return Zn.isNode&&X.isBuffer(n)?(this.append(i,n.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},e))}var u5=Im.charAt,SA=hn,h5=ri,p5=an,_5=vn,m5=/./.exec,E5=TypeError,f5=Yt,TA=hn,RA=zc,g5=Y_,Ku=$l,CA=No,vA=gT,bd=oi,S5=ri,T5=Dn,R5=vn,C5=R_,yA=fE,v5=Jc,y5=z,I5=Z_,A5=function(t,e,n){return e+(n?u5(t,e).length:1)},b5=function(t,e){var n=t.exec;if(p5(n)){var i=SA(n,t,e);return i!==null&&h5(i),i}if(_5(t)==="RegExp")return SA(m5,t,e);throw new E5("RegExp#exec called on incompatible receiver")},IA=Ss,w5=Me("matchAll"),AA="RegExp String",bA=AA+" Iterator",O5=IA.set,N5=IA.getterFor(bA),D5=TypeError,qE=RA("".indexOf),Yu=RA("".matchAll),zE=!!Yu&&!y5(function(){Yu("a",/./)}),P5=g5(function(t,e,n,i){O5(this,{type:bA,regexp:t,string:e,global:n,unicode:i,done:!1})},AA,function(){var t=N5(this);if(t.done)return Ku(void 0,!0);var e=t.regexp,n=t.string,i=b5(e,n);return i===null?(t.done=!0,Ku(void 0,!0)):t.global?(bd(i[0])===""&&(e.lastIndex=A5(n,vA(e.lastIndex),t.unicode)),Ku(i,!1)):(t.done=!0,Ku(i,!1))}),wA=function(t){var e,n,i,r=S5(this),o=bd(t),s=I5(r,RegExp),a=bd(yA(r));return e=new s(s===RegExp?r.source:r,a),n=!!~qE(a,"g"),i=!!~qE(a,"u"),e.lastIndex=vA(r.lastIndex),new P5(e,o,n,i)};f5({target:"String",proto:!0,forced:zE},{matchAll:function(t){var e,n,i,r,o=CA(this);if(T5(t)){if(C5(t)&&(e=bd(CA(yA(t))),!~qE(e,"g")))throw new D5("`.matchAll` does not allow non-global regexes");if(zE)return Yu(o,t);if((i=v5(t,w5))===void 0&&R5(t)==="RegExp"&&(i=wA),i)return TA(i,t,o)}else if(zE)return Yu(o,t);return n=bd(o),r=new RegExp(t,"g"),TA(wA,r,n)}});var L5=Di("String","matchAll"),k5=At,M5=L5,XE=String.prototype,U5=function(t){var e=t.matchAll;return typeof t=="string"||t===XE||k5(XE,t)&&e===XE.matchAll?M5:e},x5=H(U5);function OA(t){function e(n,i,r,o){let s=n[o++];if(s==="__proto__")return!0;let a=Number.isFinite(+s),c=o>=n.length;return s=!s&&X.isArray(r)?r.length:s,c?(X.hasOwnProp(r,s)?r[s]=[r[s],i]:r[s]=i,!a):(r[s]&&X.isObject(r[s])||(r[s]=[]),e(n,i,r[s],o)&&X.isArray(r[s])&&(r[s]=function(d){let l={},u=Object.keys(d),h,p=u.length,S;for(h=0;h<p;h++)S=u[h],l[S]=d[S];return l}(r[s])),!a)}if(X.isFormData(t)&&X.isFunction(t.entries)){let n={};return X.forEachEntry(t,(i,r)=>{e(function(o){return x5(X).call(X,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(i),r,n,0)}),n}return null}let JE={transitional:iI,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){let n=e.getContentType()||"",i=n.indexOf("application/json")>-1,r=X.isObject(t);if(r&&X.isHTMLForm(t)&&(t=new FormData(t)),X.isFormData(t))return i?JSON.stringify(OA(t)):t;if(X.isArrayBuffer(t)||X.isBuffer(t)||X.isStream(t)||X.isFile(t)||X.isBlob(t)||X.isReadableStream(t))return t;if(X.isArrayBufferView(t))return t.buffer;if(X.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return l5(t,this.formSerializer).toString();if((o=X.isFileList(t))||n.indexOf("multipart/form-data")>-1){let s=this.env&&this.env.FormData;return Uu(o?{"files[]":t}:t,s&&new s,this.formSerializer)}}return r||i?(e.setContentType("application/json",!1),function(s,a,c){if(X.isString(s))try{return(a||JSON.parse)(s),Pn(X).call(X,s)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){let e=this.transitional||JE.transitional,n=e&&e.forcedJSONParsing,i=this.responseType==="json";if(X.isResponse(t)||X.isReadableStream(t))return t;if(t&&X.isString(t)&&(n&&!this.responseType||i)){let r=!(e&&e.silentJSONParsing)&&i;try{return JSON.parse(t,this.parseReviver)}catch(o){if(r)throw o.name==="SyntaxError"?ne.from(o,ne.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Zn.classes.FormData,Blob:Zn.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};X.forEach(["delete","get","head","post","put","patch"],t=>{JE.headers[t]={}});var QE=JE;let V5=X.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),NA=Symbol("internals");function wd(t){var e;return t&&Pn(e=String(t)).call(e).toLowerCase()}function qu(t){return t===!1||t==null?t:X.isArray(t)?t.map(qu):String(t)}function ZE(t,e,n,i,r){return X.isFunction(i)?i.call(this,e,n):(r&&(e=n),X.isString(e)?X.isString(i)?e.indexOf(i)!==-1:X.isRegExp(i)?i.test(e):void 0:void 0)}class zu{constructor(e){e&&this.set(e)}set(e,n,i){let r=this;function o(c,d,l){let u=wd(d);if(!u)throw new Error("header name must be a non-empty string");let h=X.findKey(r,u);(!h||r[h]===void 0||l===!0||l===void 0&&r[h]!==!1)&&(r[h||d]=qu(c))}let s=(c,d)=>X.forEach(c,(l,u)=>o(l,u,d));if(X.isPlainObject(e)||e instanceof this.constructor)s(e,n);else if(X.isString(e)&&(e=Pn(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(Pn(a=e).call(a)))s((c=>{let d={},l,u,h;return c&&c.split(`
`).forEach(function(p){var S,E;h=p.indexOf(":"),l=Pn(S=p.substring(0,h)).call(S).toLowerCase(),u=Pn(E=p.substring(h+1)).call(E),!l||d[l]&&V5[l]||(l==="set-cookie"?d[l]?d[l].push(u):d[l]=[u]:d[l]=d[l]?d[l]+", "+u:u)}),d})(e),n);else if(X.isObject(e)&&X.isIterable(e)){let c,d,l={};for(let u of e){if(!X.isArray(u))throw TypeError("Object iterator must return a key-value pair");l[d=u[0]]=(c=l[d])?X.isArray(c)?[...c,u[1]]:[c,u[1]]:u[1]}s(l,n)}else e!=null&&o(n,e,i);var a;return this}get(e,n){if(e=wd(e)){let i=X.findKey(this,e);if(i){let r=this[i];if(!n)return r;if(n===!0)return function(o){let s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(r);if(X.isFunction(n))return n.call(this,r,i);if(X.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=wd(e)){let i=X.findKey(this,e);return!(!i||this[i]===void 0||n&&!ZE(0,this[i],i,n))}return!1}delete(e,n){let i=this,r=!1;function o(s){if(s=wd(s)){let a=X.findKey(i,s);!a||n&&!ZE(0,i[a],a,n)||(delete i[a],r=!0)}}return X.isArray(e)?e.forEach(o):o(e),r}clear(e){let n=Object.keys(this),i=n.length,r=!1;for(;i--;){let o=n[i];e&&!ZE(0,this[o],o,e,!0)||(delete this[o],r=!0)}return r}normalize(e){let n=this,i={};return X.forEach(this,(r,o)=>{var s;let a=X.findKey(i,o);if(a)return n[a]=qu(r),void delete n[o];let c=e?function(d){return Pn(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(l,u,h)=>u.toUpperCase()+h)}(o):Pn(s=String(o)).call(s);c!==o&&delete n[o],n[c]=qu(r),i[c]=!0}),this}concat(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(e){let n=Object.create(null);return X.forEach(this,(i,r)=>{i!=null&&i!==!1&&(n[r]=e&&X.isArray(i)?i.join(", "):i)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[n,i]=e;return n+": "+i}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){let n=new this(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return r.forEach(s=>n.set(s)),n}static accessor(e){let n=(this[NA]=this[NA]={accessors:{}}).accessors,i=this.prototype;function r(o){let s=wd(o);n[s]||(function(a,c){let d=X.toCamelCase(" "+c);["get","set","has"].forEach(l=>{Object.defineProperty(a,l+d,{value:function(u,h,p){return this[l].call(this,c,u,h,p)},configurable:!0})})}(i,o),n[s]=!0)}return X.isArray(e)?e.forEach(r):r(e),this}}zu.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),X.reduceDescriptors(zu.prototype,(t,e)=>{let{value:n}=t,i=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(r){this[i]=r}}}),X.freezeMethods(zu);var Sr=zu;function $E(t,e){let n=this||QE,i=e||n,r=Sr.from(i.headers),o=i.data;return X.forEach(t,function(s){o=s.call(n,o,r.normalize(),e?e.status:void 0)}),r.normalize(),o}function DA(t){return!(!t||!t.__CANCEL__)}function za(t,e,n){ne.call(this,t??"canceled",ne.ERR_CANCELED,e,n),this.name="CanceledError"}function PA(t,e,n){let i=n.config.validateStatus;n.status&&i&&!i(n.status)?e(new ne("Request failed with status code "+n.status,[ne.ERR_BAD_REQUEST,ne.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):t(n)}X.inherits(za,ne,{__CANCEL__:!0});let Xu=function(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,i=0,r=function(o,s){o=o||10;let a=new Array(o),c=new Array(o),d,l=0,u=0;return s=s!==void 0?s:1e3,function(h){let p=Date.now(),S=c[u];d||(d=p),a[l]=h,c[l]=p;let E=u,f=0;for(;E!==l;)f+=a[E++],E%=o;if(l=(l+1)%o,l===u&&(u=(u+1)%o),p-d<s)return;let R=S&&p-S;return R?Math.round(1e3*f/R):void 0}}(50,250);return function(o,s){let a,c,d=0,l=1e3/s,u=function(h){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),o(...h)};return[function(){let h=Date.now(),p=h-d;for(var S=arguments.length,E=new Array(S),f=0;f<S;f++)E[f]=arguments[f];p>=l?u(E,h):(a=E,c||(c=setTimeout(()=>{c=null,u(a)},l-p)))},()=>a&&u(a)]}(o=>{let s=o.loaded,a=o.lengthComputable?o.total:void 0,c=s-i,d=r(c);i=s,t({loaded:s,total:a,progress:a?s/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&s<=a?(a-s)/d:void 0,event:o,lengthComputable:a!=null,[e?"download":"upload"]:!0})},n)},LA=(t,e)=>{let n=t!=null;return[i=>e[0]({lengthComputable:n,total:t,loaded:i}),e[1]]},kA=t=>function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return X.asap(()=>t(...n))};var F5=Zn.hasStandardBrowserEnv?((t,e)=>n=>(n=new yu(n,Zn.origin),t.protocol===n.protocol&&t.host===n.host&&(e||t.port===n.port)))(new yu(Zn.origin),Zn.navigator&&/(msie|trident)/i.test(Zn.navigator.userAgent)):()=>!0,B5=Zn.hasStandardBrowserEnv?{write(t,e,n,i,r,o,s){if(typeof document>"u")return;let a=["".concat(t,"=").concat(encodeURIComponent(e))];X.isNumber(n)&&a.push("expires=".concat(new Date(n).toUTCString())),X.isString(i)&&a.push("path=".concat(i)),X.isString(r)&&a.push("domain=".concat(r)),o===!0&&a.push("secure"),X.isString(s)&&a.push("SameSite=".concat(s)),document.cookie=a.join("; ")},read(t){if(typeof document>"u")return null;let e=document.cookie.match(new RegExp("(?:^|; )"+t+"=([^;]*)"));return e?decodeURIComponent(e[1]):null},remove(t){this.write(t,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function MA(t,e,n){let i=!function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}(e);return t&&(i||n==0)?function(r,o){return o?r.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):r}(t,e):e}function UA(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function tf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?UA(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):UA(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let xA=t=>t instanceof Sr?tf({},t):t;function Ns(t,e){e=e||{};let n={};function i(d,l,u,h){return X.isPlainObject(d)&&X.isPlainObject(l)?X.merge.call({caseless:h},d,l):X.isPlainObject(l)?X.merge({},l):X.isArray(l)?l.slice():l}function r(d,l,u,h){return X.isUndefined(l)?X.isUndefined(d)?void 0:i(void 0,d,0,h):i(d,l,0,h)}function o(d,l){if(!X.isUndefined(l))return i(void 0,l)}function s(d,l){return X.isUndefined(l)?X.isUndefined(d)?void 0:i(void 0,d):i(void 0,l)}function a(d,l,u){return u in e?i(d,l):u in t?i(void 0,d):void 0}let c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,l,u)=>r(xA(d),xA(l),0,!0)};return X.forEach(Object.keys(tf(tf({},t),e)),function(d){let l=c[d]||r,u=l(t[d],e[d],d);X.isUndefined(u)&&l!==a||(n[d]=u)}),n}var VA=t=>{let e=Ns({},t),{data:n,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:o,headers:s,auth:a}=e;if(e.headers=s=Sr.from(s),e.url=eI(MA(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),a&&s.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):""))),X.isFormData(n)){if(Zn.hasStandardBrowserEnv||Zn.hasStandardBrowserWebWorkerEnv)s.setContentType(void 0);else if(X.isFunction(n.getHeaders)){let c=n.getHeaders(),d=["content-type","content-length"];Object.entries(c).forEach(l=>{let[u,h]=l;B(d).call(d,u.toLowerCase())&&s.set(u,h)})}}if(Zn.hasStandardBrowserEnv&&(i&&X.isFunction(i)&&(i=i(e)),i||i!==!1&&F5(e.url))){let c=r&&o&&B5.read(o);c&&s.set(r,c)}return e},j5=typeof XMLHttpRequest<"u"&&function(t){return new Y(function(e,n){let i=VA(t),r=i.data,o=Sr.from(i.headers).normalize(),s,a,c,d,l,{responseType:u,onUploadProgress:h,onDownloadProgress:p}=i;function S(){d&&d(),l&&l(),i.cancelToken&&i.cancelToken.unsubscribe(s),i.signal&&i.signal.removeEventListener("abort",s)}let E=new XMLHttpRequest;function f(){if(!E)return;let v=Sr.from("getAllResponseHeaders"in E&&E.getAllResponseHeaders());PA(function(I){e(I),S()},function(I){n(I),S()},{data:u&&u!=="text"&&u!=="json"?E.response:E.responseText,status:E.status,statusText:E.statusText,headers:v,config:t,request:E}),E=null}E.open(i.method.toUpperCase(),i.url,!0),E.timeout=i.timeout,"onloadend"in E?E.onloadend=f:E.onreadystatechange=function(){E&&E.readyState===4&&(E.status!==0||E.responseURL&&E.responseURL.indexOf("file:")===0)&&setTimeout(f)},E.onabort=function(){E&&(n(new ne("Request aborted",ne.ECONNABORTED,t,E)),E=null)},E.onerror=function(v){let I=new ne(v&&v.message?v.message:"Network Error",ne.ERR_NETWORK,t,E);I.event=v||null,n(I),E=null},E.ontimeout=function(){let v=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded",I=i.transitional||iI;i.timeoutErrorMessage&&(v=i.timeoutErrorMessage),n(new ne(v,I.clarifyTimeoutError?ne.ETIMEDOUT:ne.ECONNABORTED,t,E)),E=null},r===void 0&&o.setContentType(null),"setRequestHeader"in E&&X.forEach(o.toJSON(),function(v,I){E.setRequestHeader(I,v)}),X.isUndefined(i.withCredentials)||(E.withCredentials=!!i.withCredentials),u&&u!=="json"&&(E.responseType=i.responseType),p&&([c,l]=Xu(p,!0),E.addEventListener("progress",c)),h&&E.upload&&([a,d]=Xu(h),E.upload.addEventListener("progress",a),E.upload.addEventListener("loadend",d)),(i.cancelToken||i.signal)&&(s=v=>{E&&(n(!v||v.type?new za(null,t,E):v),E.abort(),E=null)},i.cancelToken&&i.cancelToken.subscribe(s),i.signal&&(i.signal.aborted?s():i.signal.addEventListener("abort",s)));let R=function(v){let I=/^([-+\w]{1,25})(:?\/\/|:)/.exec(v);return I&&I[1]||""}(i.url);R&&Zn.protocols.indexOf(R)===-1?n(new ne("Unsupported protocol "+R+":",ne.ERR_BAD_REQUEST,t)):E.send(r||null)})},G5=(t,e)=>{let{length:n}=t=t?t.filter(Boolean):[];if(e||n){let i,r=new AbortController,o=function(d){if(!i){i=!0,a();let l=d instanceof Error?d:this.reason;r.abort(l instanceof ne?l:new za(l instanceof Error?l.message:l))}},s=e&&setTimeout(()=>{s=null,o(new ne("timeout ".concat(e," of ms exceeded"),ne.ETIMEDOUT))},e),a=()=>{t&&(s&&clearTimeout(s),s=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));let{signal:c}=r;return c.unsubscribe=()=>X.asap(a),c}},ef=H(CC),FA=Wa.f("asyncIterator"),W5=H(FA);function nf(t,e){this.v=t,this.k=e}function jn(t){return function(){return new Od(t.apply(this,arguments))}}function Od(t){var e,n;function i(o,s){try{var a=t[o](s),c=a.value,d=c instanceof nf;ef.resolve(d?c.v:c).then(function(l){if(d){var u=o==="return"?"return":"next";if(!c.k||l.done)return i(u,l);l=t[u](l).value}r(a.done?"return":"normal",l)},function(l){i("throw",l)})}catch(l){r("throw",l)}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?i(e.key,e.arg):n=null}this._invoke=function(o,s){return new ef(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};n?n=n.next=d:(e=n=d,i(o,s))})},typeof t.return!="function"&&(this.return=void 0)}function yt(t){return new nf(t,0)}function Xa(t){var e={},n=!1;function i(r,o){return n=!0,o=new ef(function(s){s(t[r](o))}),{done:!1,value:new nf(o,1)}}return e[qa!==void 0&&_A||"@@iterator"]=function(){return this},e.next=function(r){return n?(n=!1,r):i("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return n?(n=!1,r):i("return",r)}),e}Od.prototype[typeof qa=="function"&&W5||"@@asyncIterator"]=function(){return this},Od.prototype.next=function(t){return this._invoke("next",t)},Od.prototype.throw=function(t){return this._invoke("throw",t)},Od.prototype.return=function(t){return this._invoke("return",t)};var Ju=H(FA);function rf(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Ju,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new Qu(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Qu(t){function e(n){if(Object(n)!==n)return Y.reject(new TypeError(n+" is not an object."));var i=n.done;return Y.resolve(n.value).then(function(r){return{value:r,done:i}})}return Qu=function(n){this.s=n,this.n=n.next},Qu.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Y.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Y.reject(n):e(i.apply(this.s,arguments))}},new Qu(t)}let H5=function*(t,e){let n=t.byteLength;if(!e||n<e)return void(yield t);let i,r=0;for(;r<n;)i=r+e,yield t.slice(r,i),r=i},K5=function(){var t=jn(function*(e,n){var i,r=!1,o=!1;try{for(var s,a=rf(Y5(e));r=!(s=yield yt(a.next())).done;r=!1){let c=s.value;yield*Xa(rf(H5(c,n)))}}catch(c){o=!0,i=c}finally{try{r&&a.return!=null&&(yield yt(a.return()))}finally{if(o)throw i}}});return function(e,n){return t.apply(this,arguments)}}(),Y5=function(){var t=jn(function*(e){if(e[Ju])return void(yield*Xa(rf(e)));let n=e.getReader();try{for(;;){let{done:i,value:r}=yield yt(n.read());if(i)break;yield r}}finally{yield yt(n.cancel())}});return function(e){return t.apply(this,arguments)}}(),BA=(t,e,n,i)=>{let r=K5(t,e),o,s=0,a=c=>{o||(o=!0,i&&i(c))};return new ReadableStream({async pull(c){try{let{done:d,value:l}=await r.next();if(d)return a(),void c.close();let u=l.byteLength;if(n){let h=s+=u;n(h)}c.enqueue(new Uint8Array(l))}catch(d){throw a(d),d}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function jA(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function GA(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?jA(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):jA(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let{isFunction:Zu}=X,q5=(t=>{let{Request:e,Response:n}=t;return{Request:e,Response:n}})(X.global),{ReadableStream:WA,TextEncoder:HA}=X.global,KA=function(t){try{for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return!!t(...n)}catch{return!1}},z5=t=>{t=X.merge.call({skipUndefined:!0},q5,t);let{fetch:e,Request:n,Response:i}=t,r=e?Zu(e):typeof fetch=="function",o=Zu(n),s=Zu(i);if(!r)return!1;let a=r&&Zu(WA),c=r&&(typeof HA=="function"?(d=new HA,S=>d.encode(S)):async S=>new Uint8Array(await new n(S).arrayBuffer()));var d;let l=o&&a&&KA(()=>{let S=!1,E=new n(Zn.origin,{body:new WA,method:"POST",get duplex(){return S=!0,"half"}}).headers.has("Content-Type");return S&&!E}),u=s&&a&&KA(()=>X.isReadableStream(new i("").body)),h={stream:u&&(S=>S.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach(S=>{!h[S]&&(h[S]=(E,f)=>{let R=E&&E[S];if(R)return R.call(E);throw new ne("Response type '".concat(S,"' is not supported"),ne.ERR_NOT_SUPPORT,f)})});let p=async(S,E)=>{let f=X.toFiniteNumber(S.getContentLength());return f??(async R=>R==null?0:X.isBlob(R)?R.size:X.isSpecCompliantForm(R)?(await new n(Zn.origin,{method:"POST",body:R}).arrayBuffer()).byteLength:X.isArrayBufferView(R)||X.isArrayBuffer(R)?R.byteLength:(X.isURLSearchParams(R)&&(R+=""),X.isString(R)?(await c(R)).byteLength:void 0))(E)};return async S=>{let{url:E,method:f,data:R,signal:v,cancelToken:I,timeout:w,onDownloadProgress:O,onUploadProgress:A,responseType:N,headers:k,withCredentials:V="same-origin",fetchOptions:J}=VA(S),ut=e||fetch;N=N?(N+"").toLowerCase():"text";let dt=G5([v,I&&I.toAbortSignal()],w),Ct=null,St=dt&&dt.unsubscribe&&(()=>{dt.unsubscribe()}),Gt;try{if(A&&l&&f!=="get"&&f!=="head"&&(Gt=await p(k,R))!==0){let m,y=new n(E,{method:"POST",body:R,duplex:"half"});if(X.isFormData(R)&&(m=y.headers.get("content-type"))&&k.setContentType(m),y.body){let[b,G]=LA(Gt,Xu(kA(A)));R=BA(y.body,65536,b,G)}}X.isString(V)||(V=V?"include":"omit");let fe=o&&"credentials"in n.prototype,U=GA(GA({},J),{},{signal:dt,method:f.toUpperCase(),headers:k.normalize().toJSON(),body:R,duplex:"half",credentials:fe?V:void 0});Ct=o&&new n(E,U);let K=await(o?ut(Ct,J):ut(E,U)),$=u&&(N==="stream"||N==="response");if(u&&(O||$&&St)){let m={};["status","statusText","headers"].forEach(mt=>{m[mt]=K[mt]});let y=X.toFiniteNumber(K.headers.get("content-length")),[b,G]=O&&LA(y,Xu(kA(O),!0))||[];K=new i(BA(K.body,65536,b,()=>{G&&G(),St&&St()}),m)}N=N||"text";let x=await h[X.findKey(h,N)||"text"](K,S);return!$&&St&&St(),await new Y((m,y)=>{PA(m,y,{data:x,headers:Sr.from(K.headers),status:K.status,statusText:K.statusText,config:S,request:Ct})})}catch(fe){throw St&&St(),fe&&fe.name==="TypeError"&&/Load failed|fetch/i.test(fe.message)?Object.assign(new ne("Network Error",ne.ERR_NETWORK,S,Ct),{cause:fe.cause||fe}):ne.from(fe,fe&&fe.code,S,Ct)}}},X5=new Map,YA=t=>{let e=t&&t.env||{},{fetch:n,Request:i,Response:r}=e,o=[i,r,n],s,a,c=o.length,d=X5;for(;c--;)s=o[c],a=d.get(s),a===void 0&&d.set(s,a=c?new Map:z5(e)),d=a;return a};YA();let of={http:null,xhr:j5,fetch:{get:YA}};X.forEach(of,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});let qA=t=>"- ".concat(t),J5=t=>X.isFunction(t)||t===null||t===!1;var zA={getAdapter:function(t,e){t=X.isArray(t)?t:[t];let{length:n}=t,i,r,o={};for(let s=0;s<n;s++){let a;if(i=t[s],r=i,!J5(i)&&(r=of[(a=String(i)).toLowerCase()],r===void 0))throw new ne("Unknown adapter '".concat(a,"'"));if(r&&(X.isFunction(r)||(r=r.get(e))))break;o[a||"#"+s]=r}if(!r){let s=Object.entries(o).map(a=>{let[c,d]=a;return"adapter ".concat(c," ")+(d===!1?"is not supported by the environment":"is not available in the build")});throw new ne("There is no suitable adapter to dispatch the request "+(n?s.length>1?`since :
`+s.map(qA).join(`
`):" "+qA(s[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:of};function sf(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new za(null,t)}function XA(t){return sf(t),t.headers=Sr.from(t.headers),t.data=$E.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),zA.getAdapter(t.adapter||QE.adapter,t)(t).then(function(e){return sf(t),e.data=$E.call(t,t.transformResponse,e),e.headers=Sr.from(e.headers),e},function(e){return DA(e)||(sf(t),e&&e.response&&(e.response.data=$E.call(t,t.transformResponse,e.response),e.response.headers=Sr.from(e.response.headers))),Y.reject(e)})}let JA="1.13.2",$u={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{$u[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});let QA={};$u.transitional=function(t,e,n){function i(r,o){return"[Axios v"+JA+"] Transitional option '"+r+"'"+o+(n?". "+n:"")}return(r,o,s)=>{if(t===!1)throw new ne(i(o," has been removed"+(e?" in "+e:"")),ne.ERR_DEPRECATED);return e&&!QA[o]&&(QA[o]=!0,console.warn(i(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,o,s)}},$u.spelling=function(t){return(e,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(t)),!0)};var th={assertOptions:function(t,e,n){if(typeof t!="object")throw new ne("options must be an object",ne.ERR_BAD_OPTION_VALUE);let i=Object.keys(t),r=i.length;for(;r-- >0;){let o=i[r],s=e[o];if(s){let a=t[o],c=a===void 0||s(a,o,t);if(c!==!0)throw new ne("option "+o+" must be "+c,ne.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new ne("Unknown option "+o,ne.ERR_BAD_OPTION)}},validators:$u};let Wr=th.validators,eh=class{constructor(t){this.defaults=t||{},this.interceptors={request:new nI,response:new nI}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let i={};Error.captureStackTrace?Error.captureStackTrace(i):i=new Error;let r=i.stack?i.stack.replace(/^.+\n/,""):"";try{n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r}catch{}}throw n}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=Ns(this.defaults,e);let{transitional:n,paramsSerializer:i,headers:r}=e;n!==void 0&&th.assertOptions(n,{silentJSONParsing:Wr.transitional(Wr.boolean),forcedJSONParsing:Wr.transitional(Wr.boolean),clarifyTimeoutError:Wr.transitional(Wr.boolean)},!1),i!=null&&(X.isFunction(i)?e.paramsSerializer={serialize:i}:th.assertOptions(i,{encode:Wr.function,serialize:Wr.function},!0)),e.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),th.assertOptions(e,{baseUrl:Wr.spelling("baseURL"),withXsrfToken:Wr.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=r&&X.merge(r.common,r[e.method]);r&&X.forEach(["delete","get","head","post","put","patch","common"],p=>{delete r[p]}),e.headers=Sr.concat(o,r);let s=[],a=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(e)===!1||(a=a&&p.synchronous,s.unshift(p.fulfilled,p.rejected))});let c=[],d;this.interceptors.response.forEach(function(p){c.push(p.fulfilled,p.rejected)});let l,u=0;if(!a){let p=[XA.bind(this),void 0];for(p.unshift(...s),p.push(...c),l=p.length,d=Y.resolve(e);u<l;)d=d.then(p[u++],p[u++]);return d}l=s.length;let h=e;for(;u<l;){let p=s[u++],S=s[u++];try{h=p(h)}catch(E){S.call(this,E);break}}try{d=XA.call(this,h)}catch(p){return Y.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(t){return eI(MA((t=Ns(this.defaults,t)).baseURL,t.url,t.allowAbsoluteUrls),t.params,t.paramsSerializer)}};X.forEach(["delete","get","head","options"],function(t){eh.prototype[t]=function(e,n){return this.request(Ns(n||{},{method:t,url:e,data:(n||{}).data}))}}),X.forEach(["post","put","patch"],function(t){function e(n){return function(i,r,o){return this.request(Ns(o||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}eh.prototype[t]=e(),eh.prototype[t+"Form"]=e(!0)});var nh=eh;class af{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Y(function(r){n=r});let i=this;this.promise.then(r=>{if(!i._listeners)return;let o=i._listeners.length;for(;o-- >0;)i._listeners[o](r);i._listeners=null}),this.promise.then=r=>{let o,s=new Y(a=>{i.subscribe(a),o=a}).then(r);return s.cancel=function(){i.unsubscribe(o)},s},e(function(r,o,s){i.reason||(i.reason=new za(r,o,s),n(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;let n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){let e=new AbortController,n=i=>{e.abort(i)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new af(function(i){e=i}),cancel:e}}}var Q5=af;let cf={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(cf).forEach(t=>{let[e,n]=t;cf[n]=e});var Z5=cf;let In=function t(e){let n=new nh(e),i=Vy(nh.prototype.request,n);return X.extend(i,nh.prototype,n,{allOwnKeys:!0}),X.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return t(Ns(e,r))},i}(QE);In.Axios=nh,In.CanceledError=za,In.CancelToken=Q5,In.isCancel=DA,In.VERSION=JA,In.toFormData=Uu,In.AxiosError=ne,In.Cancel=In.CanceledError,In.all=function(t){return Y.all(t)},In.spread=function(t){return function(e){return t.apply(null,e)}},In.isAxiosError=function(t){return X.isObject(t)&&t.isAxiosError===!0},In.mergeConfig=Ns,In.AxiosHeaders=Sr,In.formToJSON=t=>OA(X.isHTMLForm(t)?new FormData(t):t),In.getAdapter=zA.getAdapter,In.HttpStatusCode=Z5,In.default=In;var Gn=In;let $5=()=>{};function Nd(){let t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:$5};return t.promise=new Y((e,n)=>{t.resolve=i=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(i),t.value=i)},t.reject=i=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(i))}}),t}let ih=new Map,rh=new Map,Hr=new Map,Ke=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),jt=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({}),df=new MG,Tr=df.getResult(),lf=null;function Vt(t){if(!lf){t&&df.setUA(t),Tr=df.getResult();let e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return jt.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return jt.CHROME;case"Safari":case"Mobile Safari":return jt.SAFARI;case"Edge":return jt.EDGE;case"Firefox":return jt.FIREFOX;case"QQ":case"QQBrowser":return jt.QQ;case"Opera":return jt.OPERA;case"WeChat":return jt.WECHAT;default:return a.browser.name||""}}(Tr),n=ZA(Tr),i=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(Tr),r=Tr.os.version,o=ZA(Tr,!1),s=Tr.device.type;if(!(e&&n&&i&&r))return{name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};lf={name:e,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s}}return lf}function ZA(t){let e,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",n?e.split(".")[0]:e}function oh(){return Vt().os}function $A(){let t=Vt();return"".concat(t.os," ").concat(t.osVersion)}function sh(){let t=Vt();return!!(Tr.engine.name==="WebKit"&&t.os===Ke.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==jt.SAFARI||An()&&t.name!==jt.SAFARI)}function go(){return Vt().name===jt.CHROME}function $e(){return Vt().name===jt.SAFARI}function tb(){let t=Vt();if(t.name!==jt.SAFARI||!t.browserVersion)return!1;let e=t.browserVersion.split(".");return Number(e[0])>15||Number(e[0])===15&&Number(e[1])>=4}function eb(){return Vt().name===jt.EDGE}function ue(){return Vt().name===jt.FIREFOX}function An(){return Vt().os===Ke.IOS}function Rr(t){let e=Vt();return!(e.name!==jt.CHROME||!e.osVersion)&&Number(e.version)>=t}function nb(t){let e=Vt();return!(e.name!==jt.CHROME||!e.osVersion)&&Number(e.version)<t}function uf(t,e,n){let i=Vt();return!(i.name!==t||!i.osVersion)&&(n?Number(i.version)>=e&&Number(i.version)<=n:Number(i.version)===e)}function Ho(t){let e=Vt();return!(e.name!==jt.EDGE||!e.osVersion)&&Number(e.version)>=t}function hf(t){let e=Vt();return!(e.name!==jt.FIREFOX||!e.osVersion)&&Number(e.version)>=t}function ib(t){let e=Vt();return!(e.name!==jt.SAFARI||!e.osVersion)&&Number(e.version)>=t}function rb(t,e,n){let i=Vt();if(i.os!==Ke.IOS||!i.osVersion)return!1;let r=i.osVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])>e||Number(r[0])>t:e?Number(r[0])===t&&Number(r[1])>=e||Number(r[0])>t:Number(r[0])>=t}function ob(t,e,n){let i=Vt();if(i.os!==Ke.IOS||!i.osVersion)return!1;let r=i.osVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function pf(t,e,n){let i=Vt();if(i.name!==jt.SAFARI||!i.osVersion||!i.browserVersion)return!1;let r=i.browserVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function Ds(t){let e=Vt();return!(e.name!==jt.OPERA||!e.osVersion)&&Number(e.version)>=t}function sb(){let t=Vt();if(t.os!==Ke.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Ja(){let t=Vt();if(t.os!==Ke.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===15}function _f(){let t=Vt();if(t.os!==Ke.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===16}function ab(){let t=Vt();if(t.os!==Ke.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Zi(){return $e()&&navigator.maxTouchPoints>0}function cb(){return Vt().name===jt.WECHAT}function db(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function lb(){let t=oh();return function(){let{deviceType:e}=Vt();return e==="mobile"||e==="tablet"}()||t===Ke.ANDROID||t===Ke.IOS||t===Ke.HARMONY_OS}function Kr(){let t=Vt();return t.name!==jt.EDGE&&t.name!==jt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Dd(){return oh()===Ke.ANDROID}function Pd(){let t=Vt();return Dd()&&(t.name===jt.CHROME||t.name===jt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Et(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ub(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function W(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?ub(Object(n),!0).forEach(function(i){Et(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ub(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let C=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({}),L=class extends Error{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(e),Et(this,"code",void 0),Et(this,"message",void 0),Et(this,"data",void 0),Et(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return t==="error"&&(e||console).error(this.toString()),t==="warning"&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function $i(t,e){if(typeof t!="boolean")throw new L(C.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function De(t,e,n){if(!B(n).call(n,t))throw new L(C.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function ie(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<n||t>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(t))throw new L(C.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function mf(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new L(C.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&ie(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&ie(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&ie(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&ie(t.ideal,"".concat(e,".ideal"),1,1/0)}else ie(t,e,1,1/0)}function dn(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new L(C.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!hb(t,n,i,r))throw new L(C.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function So(t,e){if(!Array.isArray(t))throw new L(C.INVALID_PARAMS,"".concat(e," should be an array"))}function Ce(t){return t==null}function hb(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=n&&t.length>=e&&(!i||function(r){if(typeof r!="string")return!1;for(let o=0;o<r.length;o+=1){let s=r.charCodeAt(o);if(s<0||s>255)return!1}return!0}(t))}function pb(t,e,n){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,n);let i=t.getUint32(e,n),r=t.getUint32(e+4,n),o=+!!n,s=+!n;return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function _b(t,e,n,i){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,n,i);let r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));i?(t.setUint32(e+4,r,i),t.setUint32(e,o,i)):(t.setUint32(e,r,i),t.setUint32(e+4,o,i))}var Ld=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(Ld||{}),Ef=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(Ef||{});let mb=new class{constructor(){Et(this,"_clientSize",null),Et(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),Et(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),Et(this,"getStyle",t=>window.getComputedStyle(t,null)),Et(this,"checkCssVisibleProperty",t=>{var e;let n=!0,i=this.getStyle(t),{display:r,visibility:o,opacity:s,filter:a}=i;return(r==="none"||B(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter(c=>{var d;let l=c.split("(")[0];return B(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{let[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{let[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(n=!1);break;case"blur":l>3&&(n=!1);break;case"opacity":l<.1&&(n=!1)}}),n)}),Et(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let n=!0,i=!0,r=s=>e(s),o=t;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n}),Et(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),Et(this,"getSizeAboutClient",t=>{let{width:e,height:n,left:i,right:r,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),Et(this,"checkActualSize",()=>{let{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)}),Et(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),Et(this,"checkCoverForAPoint",(t,e,n)=>{let i=this.elementFromPoint(t,e);return i!==null&&i!==n}),Et(this,"getPointPositionList",()=>{let{width:t,height:e,left:n,top:i}=this._clientSize,r=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){let l=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(i*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:l,y:u})}return[...s]}),Et(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),Et(this,"checkSizeIsVisible",(t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10)),Et(this,"checkSizeOfPartInClient",()=>{let{left:t,right:e,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize,a,c,d,l;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;l=i<r?i:r;let u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,s)}),Et(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),Et(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Ld.COVERED);{let e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(Ld.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Ld.SIZE)}}return this.returnHiddenResult(Ld.STYLE)}return this.returnHiddenResult(Ef.UNMOUNTED)}return this.returnHiddenResult(Ef.INVALID_HTML_ELEMENT)}),Et(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function ff(t){return new TextEncoder().encode(t)}let Eb=function(t,e){let n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},gf=async t=>function(e,n){let i="";return new Uint8Array(e).forEach(r=>{i+=r.toString(n).padStart(2,"0")}),i}(await crypto.subtle.digest("SHA-256",ff(t)),16),ge=class{constructor(){Et(this,"_events",{}),Et(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);let n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);let n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;let n=this._events[t],i=this._indexOfListener(n,e);i!==-1&&n.splice(i,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);let e=this._events[t].map(o=>o);for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){let s=e[o];s.once&&this.off(t,s.listener),s.listener.apply(this,i||[])}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,n)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o?.toString()))}})}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return-1}},kd=null;function fb(){if(kd)return kd;if(window.electron)return kd=window.electron;if(!window.require)return null;try{return kd=window.require("electron"),kd}catch{return null}}let me=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",t.PRELOAD_MEDIA_FAILED="preloadMediaFailed",t.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",t.VOS_FALLBACK_CN="vosFallbackCN",t.DATACHANNEL_FAILBACK="datachannelFailback",t}({}),re=function(t){return t.TRACER="tracer",t}({});function gb(t){return ie(t.timeout,"config.timeout",0,1e5),ie(t.timeoutFactor,"config.timeoutFactor",0,100,!1),ie(t.maxRetryCount,"config.maxRetryConfig",0,1/0),ie(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let t4=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),Dt=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.FALLBACK_TO_HLS="FALLBACK_TO_HLS",t.UID_CONFLICT="UID_CONFLICT",t}({});function Ps(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function Sb(t){return dn(t.turnServerURL,"turnServerURL"),dn(t.username,"username"),dn(t.password,"password"),t.udpport&&ie(t.udpport,"udpport",1,99999,!0),t.forceturn&&$i(t.forceturn,"forceturn"),t.security&&$i(t.security,"security"),t.tcpport&&ie(t.tcpport,"tcpport",1,99999,!0),!0}let Qa=function(t){return t[t.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",t[t.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",t[t.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",t}({});function Sf(t){return t.level!==void 0&&De(t.level,"level",[1,2,3]),t.delay!==void 0&&ie(t.delay,"delay",0,3e3,!0),!0}let It=function(t){return t.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",t.AUDIO_METADATA="audio-metadata",t.AUDIO_PTS="audio-pts",t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t.FALLBACK_TO_HLS="fallback-to-hls",t.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",t.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",t.AV1_DECODABLE_RESULT="av1-decodable-result",t}({}),Tf=function(t){return t.CONFIG="config",t.VOSERROR="vos_error",t.AP_ERROR="ap_error",t}({}),pn=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",t}({}),kn=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),Ls=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function Ue(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return t.getListeners(e).length===0?Y.reject(new L(C.UNEXPECTED_ERROR,"can not emit promise")):new Y((o,s)=>{t.emit(e,...i,o,s)})}function se(t,e){if(t.getListeners(e).length===0)return Y.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Ue(t,e,...i)}function di(t,e){if(t.getListeners(e).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return ks(t,e,...i)}function ks(t,e){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{n=a},a=>{i=a}),i!==null)throw i;if(n===null)throw new L(C.UNEXPECTED_ERROR,"handler is not sync");return n}let ve=new class extends ge{set networkState(t){this.emit(Ls.NETWORK_STATE_CHANGE,t,this._networkState),t===kn.ONLINE?this.emit(Ls.ONLINE):t===kn.OFFLINE&&(this.onlineWaiter=new Y(e=>{this.once(Ls.ONLINE,()=>{this.onlineWaiter=void 0,e(kn.ONLINE)})}),this.emit(Ls.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===kn.ONLINE}constructor(){super(),Et(this,"_moduleName","network-indicator"),Et(this,"_networkState",kn.ONLINE),Et(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=kn.ONLINE}),window.addEventListener("offline",()=>{this.networkState=kn.OFFLINE})}},Wn=[];for(let t=0;t<256;++t)Wn.push((t+256).toString(16).slice(1));let Tb=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Rf,e4=new Uint8Array(16);function n4(){return Tb?Tb():function(n,i,r){var o,s,a,c;let d=(o=(s=(n=n||{}).random)!==null&&s!==void 0?s:(a=(c=n).rng)===null||a===void 0?void 0:a.call(c))!==null&&o!==void 0?o:function(){if(!Rf){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Rf=crypto.getRandomValues.bind(crypto)}return Rf(e4)}();if(d.length<16)throw new Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,i){if((r=r||0)<0||r+16>i.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let l=0;l<16;++l)i[r+l]=d[l];return i}return function(l){let u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(Wn[l[u+0]]+Wn[l[u+1]]+Wn[l[u+2]]+Wn[l[u+3]]+"-"+Wn[l[u+4]]+Wn[l[u+5]]+"-"+Wn[l[u+6]]+Wn[l[u+7]]+"-"+Wn[l[u+8]]+Wn[l[u+9]]+"-"+Wn[l[u+10]]+Wn[l[u+11]]+Wn[l[u+12]]+Wn[l[u+13]]+Wn[l[u+14]]+Wn[l[u+15]]).toLowerCase()}(d)}(t,e,void 0);var t,e}function ah(t,e){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}function Za(t){let e=[];return t.forEach(n=>{e.indexOf(n)===-1&&e.push(n)}),e}function ch(t){Y!==void 0?Y.resolve().then(t):setTimeout(t,0)}function he(t){return JSON.parse(JSON.stringify(t))}function Ms(t){try{return he(t)}catch{return t}}let Rb={};function Ko(t,e){Rb[e]||(Rb[e]=!0,t())}function Us(t){let e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let i=0;i<e.length;i+=1)n[i]=e.charCodeAt(i);return n}function Yo(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function Cb(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){let i=new Uint8Array(e);i.set(n),n=i}return n}function vb(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=Pi(e).call(e,(s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(i)),o=0;return e.forEach(s=>{r.set(s,o),o+=s.length}),r}function Yr(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function yb(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(n=>{e+=typeof n=="string"?Yr(n):n.size}),e+138}function i4(t){let e=new L(C.TIMEOUT,"timeout");return new Y((n,i)=>{window.setTimeout(()=>i(e),t)})}function Ye(t){return new Y(e=>{window.setTimeout(e,t)})}function qt(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0,n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+qt(t-n.length,"")}function xs(){let t,e=!1;try{var n;t=kG(n=n4()).call(n,"-","")}catch{e=!0}return!e&&t&&t.length===32||(t=qt(32,"")),t.toUpperCase()}let Md=()=>{},Ib=new class{constructor(){Et(this,"fnMap",new Map)}throttleByKey(t,e,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){let a=this.fnMap.get(e);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);let c=window.setTimeout(()=>{let d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:c,args:o,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,W(W({},a),{},{fn:t,args:o,skipFn:i}))}else{let a=window.setTimeout(()=>{let c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:a,args:o,skipFn:i})}}},Ab=Ib.throttleByKey.bind(Ib);function bb(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function Cf(t,e){if(!bb(t)||!bb(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){let n=[...t];for(let i=0;i<e.length;i++)n[i]=Cf(t[i],e[i]);return n}{let n=W({},t);for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(Object.prototype.hasOwnProperty.call(t,i)?n[i]=Cf(t[i],e[i]):n[i]=e[i]);return n}}function wb(t,e){let n=[0];if(e&&(n=new Array(e).fill(0)),t===0)return n;let i=0;for(;t>0&&(n[i]=255&t,t>>=8,i++,!e||i!==e););return n}function $a(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function vf(t,e){try{return typeof t=="object"&&typeof e=="object"&&JSON.stringify(t)===JSON.stringify(e)}catch{return!1}}function yf(t){return Pi(t).call(t,(e,n)=>e+n,0)}function Ob(t){let e="0123456789abcdef";function n(I){let w,O="";for(w=0;w<=3;w++)O+=e.charAt(I>>8*w+4&15)+e.charAt(I>>8*w&15);return O}function i(I,w){let O=(65535&I)+(65535&w);return(I>>16)+(w>>16)+(O>>16)<<16|65535&O}function r(I,w,O,A,N,k){return i(function(V,J){return V<<J|V>>>32-J}(i(i(w,I),i(A,k)),N),O)}function o(I,w,O,A,N,k,V){return r(w&O|~w&A,I,w,N,k,V)}function s(I,w,O,A,N,k,V){return r(w&A|O&~A,I,w,N,k,V)}function a(I,w,O,A,N,k,V){return r(w^O^A,I,w,N,k,V)}function c(I,w,O,A,N,k,V){return r(O^(w|~A),I,w,N,k,V)}let d=function(I){let w,O=1+(I.length+8>>6),A=new Array(16*O);for(w=0;w<16*O;w++)A[w]=0;for(w=0;w<I.length;w++)A[w>>2]|=I.charCodeAt(w)<<w%4*8;return A[w>>2]|=128<<w%4*8,A[16*O-2]=8*I.length,A}(t),l,u,h,p,S,E=1732584193,f=-271733879,R=-1732584194,v=271733878;for(l=0;l<d.length;l+=16)u=E,h=f,p=R,S=v,E=o(E,f,R,v,d[l+0],7,-680876936),v=o(v,E,f,R,d[l+1],12,-389564586),R=o(R,v,E,f,d[l+2],17,606105819),f=o(f,R,v,E,d[l+3],22,-1044525330),E=o(E,f,R,v,d[l+4],7,-176418897),v=o(v,E,f,R,d[l+5],12,1200080426),R=o(R,v,E,f,d[l+6],17,-1473231341),f=o(f,R,v,E,d[l+7],22,-45705983),E=o(E,f,R,v,d[l+8],7,1770035416),v=o(v,E,f,R,d[l+9],12,-1958414417),R=o(R,v,E,f,d[l+10],17,-42063),f=o(f,R,v,E,d[l+11],22,-1990404162),E=o(E,f,R,v,d[l+12],7,1804603682),v=o(v,E,f,R,d[l+13],12,-40341101),R=o(R,v,E,f,d[l+14],17,-1502002290),f=o(f,R,v,E,d[l+15],22,1236535329),E=s(E,f,R,v,d[l+1],5,-165796510),v=s(v,E,f,R,d[l+6],9,-1069501632),R=s(R,v,E,f,d[l+11],14,643717713),f=s(f,R,v,E,d[l+0],20,-373897302),E=s(E,f,R,v,d[l+5],5,-701558691),v=s(v,E,f,R,d[l+10],9,38016083),R=s(R,v,E,f,d[l+15],14,-660478335),f=s(f,R,v,E,d[l+4],20,-405537848),E=s(E,f,R,v,d[l+9],5,568446438),v=s(v,E,f,R,d[l+14],9,-1019803690),R=s(R,v,E,f,d[l+3],14,-187363961),f=s(f,R,v,E,d[l+8],20,1163531501),E=s(E,f,R,v,d[l+13],5,-1444681467),v=s(v,E,f,R,d[l+2],9,-51403784),R=s(R,v,E,f,d[l+7],14,1735328473),f=s(f,R,v,E,d[l+12],20,-1926607734),E=a(E,f,R,v,d[l+5],4,-378558),v=a(v,E,f,R,d[l+8],11,-2022574463),R=a(R,v,E,f,d[l+11],16,1839030562),f=a(f,R,v,E,d[l+14],23,-35309556),E=a(E,f,R,v,d[l+1],4,-1530992060),v=a(v,E,f,R,d[l+4],11,1272893353),R=a(R,v,E,f,d[l+7],16,-155497632),f=a(f,R,v,E,d[l+10],23,-1094730640),E=a(E,f,R,v,d[l+13],4,681279174),v=a(v,E,f,R,d[l+0],11,-358537222),R=a(R,v,E,f,d[l+3],16,-722521979),f=a(f,R,v,E,d[l+6],23,76029189),E=a(E,f,R,v,d[l+9],4,-640364487),v=a(v,E,f,R,d[l+12],11,-421815835),R=a(R,v,E,f,d[l+15],16,530742520),f=a(f,R,v,E,d[l+2],23,-995338651),E=c(E,f,R,v,d[l+0],6,-198630844),v=c(v,E,f,R,d[l+7],10,1126891415),R=c(R,v,E,f,d[l+14],15,-1416354905),f=c(f,R,v,E,d[l+5],21,-57434055),E=c(E,f,R,v,d[l+12],6,1700485571),v=c(v,E,f,R,d[l+3],10,-1894986606),R=c(R,v,E,f,d[l+10],15,-1051523),f=c(f,R,v,E,d[l+1],21,-2054922799),E=c(E,f,R,v,d[l+8],6,1873313359),v=c(v,E,f,R,d[l+15],10,-30611744),R=c(R,v,E,f,d[l+6],15,-1560198380),f=c(f,R,v,E,d[l+13],21,1309151649),E=c(E,f,R,v,d[l+4],6,-145523070),v=c(v,E,f,R,d[l+11],10,-1120210379),R=c(R,v,E,f,d[l+2],15,718787259),f=c(f,R,v,E,d[l+9],21,-343485551),E=i(E,u),f=i(f,h),R=i(R,p),v=i(v,S);return n(E)+n(f)+n(R)+n(v)}let r4=1,Nb=console,tn=class{static setLogger(t){Nb=t}constructor(t,e){Et(this,"id",void 0),Et(this,"lockingPromise",Y.resolve()),Et(this,"locks",0),Et(this,"name",""),Et(this,"lockId",void 0),this.lockId=r4++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){let n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),i=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");Nb.debug("".concat(n," ").concat(i))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);let n=new Y(r=>{e=()=>{this.locks-=1,this.logger("unlocked",t),r()}}),i=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),i}};function tc(t,e){return function(n,i,r){let o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){let s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));let a=await s.lock("From ".concat(t,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await o.apply(this,d)}finally{a()}},r}}let Pe={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function dh(t,e){let n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function Cr(t,e,n,i){let r=Object.assign({},Pe,i),o=r.timeout,s=async()=>{await function(d){return new Y(l=>{window.setTimeout(l,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)},a=!1,c=new Y(async(d,l)=>{e=e||(()=>!1),n=n||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new L(C.OPERATION_ABORTED));try{let h=await t();if(!e(h,u)||u+1===r.maxRetryCount)return d(h);await s()}catch(h){if(!n(h,u)||u+1===r.maxRetryCount)return l(h);await s()}}});return c.cancel=()=>a=!0,c}let lh,If=class{constructor(t){Et(this,"input",[]),Et(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:Pi(t=this.input).call(t,(e,n)=>e+n)/this.input.length}},uh=0,Af=0;function bf(t,e,n,i){return new Y((r,o)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),uh+=Yr(e.data)):n&&(e.data.size?uh+=e.data.size:e.data instanceof FormData?uh+=yb(e.data):uh+=Yr(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,Gn.request(e).then(s=>{typeof s.data=="string"?Af+=Yr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Af+=s.data.byteLength:Af+=Yr(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Gn.isCancel(s)?o(new L(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new L(C.NETWORK_TIMEOUT,s.message)):s.response?o(new L(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new L(C.NETWORK_ERROR,s.message))})})}async function o4(t,e){let n=new Blob([e.data],{type:"buffer"});return await bf(t,W(W({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}let Db=()=>window.isSecureContext!==void 0;function tr(t){if(Array.isArray(t))return t.map(n=>n);if(!Pb(t))return t;let e={};for(let n in t){let i=t[n];Pb(i)||Array.isArray(i)?e[n]=tr(i):e[n]=i}return e}function Pb(t){return!(typeof t!="object"||Array.isArray(t)||!t)}let wf=class{constructor(t){Et(this,"input",[]),Et(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}},er={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Ud={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:er,remoteCandidate:er},updateInterval:0},Lb={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},kb={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Mb={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},Ub={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0},Of=class{constructor(t,e){Et(this,"onFirstVideoReceived",void 0),Et(this,"onFirstVideoDecoded",void 0),Et(this,"onFirstAudioReceived",void 0),Et(this,"onFirstVideoDecodedTimeout",void 0),Et(this,"onFirstAudioDecoded",void 0),Et(this,"onSelectedLocalCandidateChanged",void 0),Et(this,"onSelectedRemoteCandidateChanged",void 0),Et(this,"videoIsReady",!1),Et(this,"videoIsReady2",{}),Et(this,"pc",void 0),Et(this,"options",void 0),Et(this,"intervalTimer",void 0),Et(this,"stats",tr(Ud)),Et(this,"isFirstVideoReceived",{}),Et(this,"isFirstVideoDecoded",{}),Et(this,"isFirstAudioReceived",{}),Et(this,"isFirstAudioDecoded",{}),Et(this,"isFirstVideoDecodedTimeout",{}),Et(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Y(t=>{t({local:W({},er),remote:W({},er)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let e=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"],i=0,r=0,o=0,s=0;for(let a of n)t[a].forEach((c,d)=>{if(!this.lossRateWindowStats[e-1][a][d]||!this.lossRateWindowStats[0][a][d])return;let l=this.lossRateWindowStats[e-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,u=this.lossRateWindowStats[e-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(i+=l,o+=u):(r+=l,s+=u),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||u<=0?0:u/(l+u)});t.sendPacketLossRate=i<=0||o<=0?0:o/(i+o),t.recvPacketLossRate=r<=0||s<=0?0:s/(r+s)}},s4=class extends Of{constructor(){super(...arguments),Et(this,"_stats",Ud),Et(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=tr(Ud);let n=e.filter(r=>r.type==="ssrc");this.processSSRCStats(n);let i=e.find(r=>r.type==="VideoBwe");i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var n;let i=B(n=e.id).call(n,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{let r=tr(kb);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{let r=tr(Lb),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){let s=o.stats,a=Date.now()-o.lts;r.framesDecodeFreezeTime=s.framesDecodeFreezeTime,r.framesDecodeInterval=s.framesDecodeInterval,r.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:W({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{let r=tr(Ub);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{let r=tr(Mb);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new Y((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){let e=[];return t.result().forEach(n=>{let i={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach(r=>{i[r]=n.stat(r)}),e.push(i)}),e}},ec=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({}),hh=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),Nf=function(t){return t[t.new=0]="new",t[t.connecting=1]="connecting",t[t.connected=2]="connected",t[t.disconnected=3]="disconnected",t[t.failed=4]="failed",t[t.closed=5]="closed",t}({}),fi=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({});var nc=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(nc||{});function xd(t,e,n,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:nc.kNone;if(!e)return;let o=Number(e[n]);if(typeof o!="number")return;let s=Number(e[i]);if(typeof s!="number")return;if(!t)return s?o/s*r:void 0;let a=Number(t[n]);if(typeof a!="number")return;let c=Number(t[i]);if(typeof c!="number")return;let d=s-c;return d?(o-a)/d*r:void 0}let xb=class extends Of{constructor(){super(...arguments),Et(this,"_stats",Ud),Et(this,"report",void 0),Et(this,"lastDecodeVideoReceiverStats",new Map),Et(this,"lastVideoFramesRecv",new Map),Et(this,"lastVideoFramesSent",new Map),Et(this,"lastVideoFramesDecode",new Map),Et(this,"lastVideoFramesOutput",new Map),Et(this,"lastVideoJBDelay",new Map),Et(this,"lastAudioJBDelay",new Map),Et(this,"mediaBytesSent",new Map),Et(this,"mediaBytesRetransmit",new Map),Et(this,"mediaBytesTargetEncode",new Map),Et(this,"lastDecodeAudioReceiverStats",new Map),Et(this,"lastAudioConcealment",new Map),Et(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=tr(Ud),this.report.forEach(t=>{switch(t.type){case fi.OUTBOUND:case fi.INBOUND:{let e=t.mediaType||t.kind,n=!e&&"frameWidth"in t,i=!e&&!("frameWidth"in t);t.type===fi.OUTBOUND?e==="audio"||i?this.processAudioOutboundStats(t):(e==="video"||n)&&this.processVideoOutboundStats(t):t.type===fi.INBOUND&&(e==="audio"||i?this.processAudioInboundStats(t):(e==="video"||n)&&this.processVideoInboundStats(t));break}case fi.TRANSPORT:{this.processTransportStats(t);let e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case fi.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let t=await this.pc.getStats(),e={local:W({},er),remote:W({},er)};return t.forEach(n=>{let i;if(n.type===fi.TRANSPORT&&(i=t.get(n.selectedCandidatePairId)),n.type===fi.CANDIDATE_PAIR&&n.selected&&(i=n),i){let r=(o,s)=>{o.type=s.type,o.id=s.id,s.address&&(o.address=s.address),s.candidateType&&(o.candidateType=s.candidateType),s.port&&(o.port=s.port),s.priority&&(o.priority=s.priority),s.protocol&&(o.protocol=s.protocol),s.relayProtocol&&(o.relayProtocol=s.relayProtocol)};if(i.localCandidateId){let o=t.get(i.localCandidateId);o&&r(e.local,o)}if(i.remoteCandidateId){let o=t.get(i.remoteCandidateId);o&&r(e.remote,o)}}}),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){let e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){let e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===fi.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===fi.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===fi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(W({},e),W({},this.stats.selectedCandidatePair.localCandidate)),t.type===fi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(W({},e),W({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(i=>i.ssrc===t.ssrc);e||(e=tr(Ub),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.packetsDiscarded=t.packetsDiscarded,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.totalProcessingDelay=t.totalProcessingDelay,e.jitterBufferEmittedCount=t.jitterBufferEmittedCount,e.estimatedPlayoutTimestamp=t.estimatedPlayoutTimestamp;let n=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=xd(n,e,"totalProcessingDelay","jitterBufferEmittedCount",nc.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(t,t.trackId,e),this.calculateAudioFreeze(e,n,t),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,W({},e))}calculateAudioFreeze(t,e,n){let i=this.lastAudioConcealment.get(t.ssrc);if(e!=null&&i!=null){let r=i.lts,o=n.timestamp,s=o-r;if(s<=0)return;let a=t.concealedSamples-e.concealedSamples-0,c=i.nonSilent+a,d=t.totalSamplesReceived-e.totalSamplesReceived;if(d<=0)return;let l=80*d/s,u=200*d/s,h=s/d,p=0;t.freezeSamples80=e.freezeSamples80,t.freezeMs80=e.freezeMs80,c>l&&(i.plc80>0?(t.freezeSamples80+=a,t.freezeMs80+=Math.round(a*h)):(t.freezeSamples80+=c,t.freezeMs80+=Math.round(c*h)),p=i.plc80+1);let S=0;t.freezeSamples200=e.freezeSamples200,t.freezeMs200=e.freezeMs200,c>u&&(i.plc200>0?(t.freezeSamples200+=a,t.freezeMs200+=Math.round(a*h)):(t.freezeSamples200+=c,t.freezeMs200+=Math.round(c*h)),S=i.plc200+1),this.lastAudioConcealment.set(t.ssrc,{nonSilent:a,lts:o,plc80:p,plc200:S})}else t.freezeSamples80=0,t.freezeSamples200=0,t.freezeMs80=0,t.freezeMs200=0,this.lastAudioConcealment.set(t.ssrc,{nonSilent:0,lts:n.timestamp,plc80:0,plc200:0})}processVideoInboundStats(t){let e=this._stats.videoRecv.find(s=>s.ssrc===t.ssrc);e||(e=tr(Lb),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.framesDroppedCount=t.framesDropped,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,e.totalFreezesDuration=t.totalFreezesDuration,e.totalProcessingDelay=t.totalProcessingDelay,e.packetsDiscarded=t.packetsDiscarded,e.framesAssembledFromMultiplePackets=t.framesAssembledFromMultiplePackets,e.totalAssemblyTime=t.totalAssemblyTime,e.keyFramesDecoded=t.keyFramesDecoded,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.estimatedPlayoutTimestamp=t.estimatedPlayoutTimestamp;let n=this.lastDecodeVideoReceiverStats.get(e.ssrc),i=this.lastVideoFramesDecode.get(e.ssrc),r=this.lastVideoFramesOutput.get(e.ssrc),o=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){let s=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,s,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(n){let s=n.stats,a=o-n.lts;e.framesDecodeFreezeTime=s.framesDecodeFreezeTime,e.framesDecodeInterval=s.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(n.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<s.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(n.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-n.qpSum)/(t.framesDecoded-n.stats.framesDecodeCount))}t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime,e.avgDecodeMs=xd(n?.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=xd(n?.stats,e,"totalProcessingDelay","framesDecodeCount",nc.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=xd(n?.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",nc.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=xd(n?.stats,e,"totalInterFrameDelay","framesDecodeCount",nc.kMillisecondsFromSeconds),i&&o-i.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-i.count)/((o-i.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:e.decodeFrameRate})):i?e.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:0}),e.framesDroppedCount&&t.framesReceived&&(r&&o-r.lts>=800?(e.outputFrameRate=Math.round((t.framesReceived-e.framesDroppedCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:Math.max(e.outputFrameRate,0)})):r?e.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:0})),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:W({},e),lts:n?n.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(i=>i.ssrc===t.ssrc);e||(e=tr(kb),this._stats.videoSend.push(e));let n=this.mediaBytesSent.get(t.ssrc);if(n)n.add(t.bytesSent);else{let i=new wf(10);i.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,i)}if(t.retransmittedBytesSent!==void 0){let i=this.mediaBytesRetransmit.get(t.ssrc);if(i)i.add(t.retransmittedBytesSent);else{let r=new wf(10);r.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,r)}}if(t.totalEncodedBytesTarget){let i=this.mediaBytesTargetEncode.get(t.ssrc);if(i)i.add(t.totalEncodedBytesTarget);else{let r=new wf(10);r.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,r)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,e.hugeFramesSent=t.hugeFramesSent,e.keyFramesEncoded=t.keyFramesEncoded,e.targetBitrate=t.targetBitrate,t.totalEncodeTime&&t.framesEncoded){let i=this.lastEncoderMs.get(t.ssrc);if(!i||i.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{let r=t.framesEncoded-i.lastFrameCount,o=t.totalEncodeTime-i.lastEncoderTime;e.avgEncodeMs=1e3*o/r}}if(t.framesEncoded&&t.qpSum){let i=this.lastEncoderMs.get(t.ssrc);!i||i.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-i.lastQpSum)/(t.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{let i=this.findRemoteStatsId(t.ssrc,fi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(n=>n.ssrc===t.ssrc);if(e||(e=tr(Mb),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{let n=this.findRemoteStatsId(t.ssrc,fi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}processTransportStats(t){this._stats.transport.bytesReceived=t.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=t.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=t.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=t.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(t,e){var n;let i=Array.from(si(n=this.report).call(n)).find(r=>r.type===e&&r.ssrc===t);return i?i.id:null}processVideoMediaSource(t,e){let n=this.report.get(t);n&&n.width&&n.height&&n.framesPerSecond&&(e.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(t,e){let n=this.report.get(t);n&&(e.inputLevel=n.audioLevel)}processVideoTrackSenderStats(t,e,n){var i,r,o,s;let a=e?this.report.get(e):void 0,c=(i=a?.framesSent)!==null&&i!==void 0?i:t.framesSent;if(typeof c!="number")return;let d=(r=a?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,l=(o=a?.frameHeight)!==null&&o!==void 0?o:t.frameHeight,u=(s=a?.framesPerSecond)!==null&&s!==void 0?s:t.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),u==null){let h=Date.now(),p=this.lastVideoFramesSent.get(n.ssrc);p&&h-p.lts>=800?(u=Math.round((c-p.count)/((h-p.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:h,rate:u})):p?u=p.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:h,rate:0})}n.sentFrame={width:d,height:l,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(t,e,n){var i,r,o,s,a;let c=e?this.report.get(e):void 0,d=(i=c?.framesReceived)!==null&&i!==void 0?i:t.framesReceived,l=(r=c?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,u=(o=c?.frameHeight)!==null&&o!==void 0?o:t.frameHeight,h=(s=c?.jitterBufferDelay)!==null&&s!==void 0?s:t.jitterBufferDelay,p=(a=c?.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount;if(typeof d=="number"){let S=this.lastVideoFramesRecv.get(n.ssrc),E=Date.now();n.framesReceivedCount=d;let f=0;S&&E-S.lts>=800?(f=Math.round((d-S.count)/((E-S.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:E,rate:f})):S?f=S.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:E,rate:0}),n.receivedFrame={width:l||0,height:u||0,frameRate:f||0},n.decodedFrame={width:l||0,height:u||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:l||0,height:u||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(h&&p){let S=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},E=S.jitterBufferMs,f=p-S.jitterBufferEmittedCount;f>0&&(E=1e3*(h-S.jitterBufferDelay)/f),n.jitterBufferMs=E,n.currentDelayMs=Math.round(E),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(t,e,n){var i,r,o,s;let a=e?this.report.get(e):void 0,c=(i=(r=a?.echoReturnLoss)!==null&&r!==void 0?r:t.echoReturnLoss)!==null&&i!==void 0?i:0,d=(o=(s=a?.echoReturnLossEnhancement)!==null&&s!==void 0?s:t.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(t,e,n){var i,r,o,s,a,c,d,l,u;let h=e?this.report.get(e):void 0,p=(i=h?.removedSamplesForAcceleration)!==null&&i!==void 0?i:t.removedSamplesForAcceleration,S=(r=h?.totalSamplesReceived)!==null&&r!==void 0?r:t.totalSamplesReceived,E=(o=h?.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,f=(s=h?.jitterBufferEmittedCount)!==null&&s!==void 0?s:t.jitterBufferEmittedCount,R=(a=h?.audioLevel)!==null&&a!==void 0?a:t?.audioLevel,v=(c=h?.totalSamplesDuration)!==null&&c!==void 0?c:t?.totalSamplesDuration,I=(d=h?.concealedSamples)!==null&&d!==void 0?d:t.concealedSamples,w=(l=h?.silentConcealedSamples)!==null&&l!==void 0?l:t.silentConcealedSamples,O=(u=h?.concealmentEvents)!==null&&u!==void 0?u:t.concealmentEvents;if(typeof S=="number"&&(n.totalSamplesReceived=S),typeof w=="number"&&(n.silentConcealedSamples=w),typeof O=="number"&&(n.concealmentEvents=O),typeof I=="number"&&(n.concealedSamples=I),p&&S&&(n.accelerateRate=p/S),E&&f){let N=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},k=N.jitterBufferMs,V=f-N.jitterBufferEmittedCount;V>0&&(k=1e3*(E-N.jitterBufferDelay)/V),n.jitterBufferMs=Math.round(k),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:E,jitterBufferEmittedCount:f,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=R;let A=1920;v&&S&&(A=S/v/50,n.receivedFrames=Math.round(S/A)),I&&(n.droppedFrames=Math.round(I/A))}processRemoteInboundStats(t,e){let n=this.report.get(t);n&&(e.packetsLost=n.packetsLost,n.roundTripTime&&(e.rttMs=1e3*n.roundTripTime),n.jitter&&(e.jitterMs=1e3*n.jitter),n.timestamp&&(e.timestamp=n.timestamp))}getCodecFromCodecStats(t){let e=this.report.get(t);if(!e)return"";let n=e.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let t=0,e=null,n=null;this.mediaBytesSent.forEach(r=>{t+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{e=e===null?r.diffMean():e+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{n=n===null?r.diffMean():n+r.diffMean()});let i=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},a4=class extends Of{updateStats(){return Y.resolve()}};function ph(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,o=function(){let s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new s4(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new xb(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(s){if(!window.RTCStatsReport)return!1;let a=s.getStats();return!!(a instanceof Y||function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"}(a))}(t)?new xb(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new a4(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}let Vb="websdk_ng_install_id";function Df(){try{if(T("INSTALL_ID"))return T("INSTALL_ID");let t=window.localStorage.getItem(Vb);return t||(t=xs(),window.localStorage.setItem(Vb,t)),$t("INSTALL_ID",t),t}catch{return}}let ki=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;let e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){let n=e[1],i=e[2];return"".concat(n,".").concat(i)}return"4.0.0.999"}("4.24.2"),Pf=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),Vs=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({}),_n=function(){let t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");let i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");let o=r.join(""),s={};return s[t]=i,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=_n;let _h={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},Lf={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},kf="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",Mf={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},zt=W(W(W(W({},Mf),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:Lf,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},_h),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function $t(t,e,n){var i,r,o;B(i=Object.keys(zt)).call(i,t)&&(!n&&B(r=Object.keys(gi)).call(r,t)||(zt[t]=e,t!=="ENABLE_VIDEO_SEI"&&t!=="ENABLE_AUDIO_TOPN"&&t!=="ENABLE_AUDIO_METADATA"&&t!=="ENABLE_AUDIO_PTS"||e!==!0||(zt.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,zt.USE_NEW_NETWORK_CONFIG=o,o&&(zt.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],zt.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],zt.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],zt.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],zt.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",zt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",zt.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&e&&(zt.ENABLE_INSTANT_VIDEO=!0,zt.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&e&&(zt.ENABLE_AUT_CC=!0),t==="NEW_FORCE_TURN"&&e&&(zt.NEW_TURN_MODE||(zt.NEW_TURN_MODE=4))))}function T(t){if(t==="TURN_DOMAINS"){let e=zt.TURN_DOMAINS;return B(e).call(e,T("TURN_DOMAIN"))?e:[T("TURN_DOMAIN")].concat(e)}return zt[t]}Pf||(zt.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],zt.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],zt.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],zt.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],zt.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],zt.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],zt.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",zt.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",zt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",zt.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",zt.AREAS=["NORTH_AMERICA","OVERSEA"]);let Fb=function(t){return t[t.REALTIME=1]="REALTIME",t}({}),gi={};var ht=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_RTE_URL="SET_RTE_URL",t.SET_RTE_SID="SET_RTE_SID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",t.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",t.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",t.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",t.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",t.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",t.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(ht||{});let Fs=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});let Bb=128,c4=96,jb=1e3,ic=10,d4=0;var Gb=(()=>{var t={8:(i,r,o)=>{o.r(r),o.d(r,{Parser:()=>V,Printer:()=>St,parse:()=>K,print:()=>$});let s=`
`,a="".concat("\r").concat(s),c=" ",d;function l(x){return x>="0"&&x<="9"}function u(x){return x>="!"&&x<="~"}function h(x){return u(x)||x>="\x80"&&x<="\xFF"}function p(x){return x==="!"||x>="#"&&x<="'"||x>="*"&&x<="+"||x>="-"&&x<="."||x>="0"&&x<="9"||x>="A"&&x<="Z"||x>="^"&&x<="~"}function S(x){return x>="1"&&x<="9"}function E(x){return x>="A"&&x<="Z"||x>="a"&&x<="z"}function f(x){return x==="d"||x==="h"||x==="m"||x==="s"}function R(x){return x>""&&x<"	"||x>"\v"&&x<"\f"||x>""&&x<"\xFF"}function v(x){return E(x)||l(x)||x==="+"||x==="/"}function I(x){return l(x)||E(x)||x==="+"||x==="/"||x==="-"||x==="_"}function w(x){return E(x)||l(x)||x==="+"||x==="/"}function O(x,m){var y=Object.keys(x);if(Object.getOwnPropertySymbols){var b=Object.getOwnPropertySymbols(x);m&&(b=b.filter(function(G){return Object.getOwnPropertyDescriptor(x,G).enumerable})),y.push.apply(y,b)}return y}function A(x){for(var m=1;m<arguments.length;m++){var y=arguments[m]!=null?arguments[m]:{};m%2?O(Object(y),!0).forEach(function(b){N(x,b,y[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(x,Object.getOwnPropertyDescriptors(y)):O(Object(y)).forEach(function(b){Object.defineProperty(x,b,Object.getOwnPropertyDescriptor(y,b))})}return x}function N(x,m,y){return m in x?Object.defineProperty(x,m,{value:y,enumerable:!0,configurable:!0,writable:!0}):x[m]=y,x}(function(x){x.VERSION="v",x.ORIGIN="o",x.SESSION_NAME="s",x.INFORMATION="i",x.URI="u",x.EMAIL="e",x.PHONE="p",x.CONNECTION="c",x.BANDWIDTH="b",x.TIME="t",x.REPEAT="r",x.ZONE_ADJUSTMENTS="z",x.KEY="k",x.ATTRIBUTE="a",x.MEDIA="m"})(d||(d={}));class k{consumeText(m,y){let b=y;for(;b<m.length;){let G=m[b];if(G==="\0"||G==="\r"||G===s)break;b+=1}if(b-y==0)throw new Error("Invalid text, at ".concat(m));return b}consumeUnicastAddress(m,y,b){return this.consumeTill(m,y,c)}consumeOneOrMore(m,y,b){let G=y;for(;b(m[G]);)G++;if(G-y==0)throw new Error("Invalid rule at ".concat(y,"."));return G}consumeSpace(m,y){if(m[y]===c)return y+1;throw new Error("Invalid space at ".concat(y,"."))}consumeIP4Address(m,y){let b=y;for(let G=0;G<4;G++)if(b=this.consumeDecimalUChar(m,b),G!==3){if(m[b]!==".")throw new Error("Invalid IP4 address.");b++}return b}consumeDecimalUChar(m,y){let b=y;for(let mt=0;mt<3&&l(m[b]);mt++,b++);if(b-y==0)throw new Error("Invalid decimal uchar.");let G=parseInt(m.slice(y,b));if(G>=0&&G<=255)return b;throw new Error("Invalid decimal uchar")}consumeIP6Address(m,y){let b=this.consumeHexpart(m,y);return m[b]===":"&&(b+=1,b=this.consumeIP4Address(m,b)),b}consumeHexpart(m,y){let b=y;if(m[b]===":"&&m[b+1]===":"){b+=2;try{b=this.consumeHexseq(m,b)}catch{}return b}if(b=this.consumeHexseq(m,b),m[b]===":"&&m[b+1]===":"){b+=2;try{b=this.consumeHexseq(m,b)}catch{}return b}return b}consumeHexseq(m,y){let b=y;for(;b=this.consumeHex4(m,b),m[b]===":"&&m[b+1]!==":";)b+=1;return b}consumeHex4(m,y){let b=0;for(;b<4;b++)if(!((G=m[y+b])>="0"&&G<="9"||G>="a"&&G<="f"||G>="A"&&G<="F")){if(b===0)throw new Error("Invalid hex 4");break}var G;return y+b}consumeFQDN(m,y){let b=y;for(;l(m[b])||E(m[b])||m[b]==="-"||m[b]===".";)b+=1;if(b-y<4)throw new Error("Invalid FQDN");return b}consumeExtnAddr(m,y){return this.consumeOneOrMore(m,y,h)}consumeMulticastAddress(m,y,b){switch(b){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(m,y);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(m,y);default:try{return this.consumeFQDN(m,y)}catch{return this.consumeExtnAddr(m,y)}}}consumeIP6MulticastAddress(m,y){let b=this.consumeHexpart(m,y);return m[b]==="/"?this.consumeInteger(m,b+1):b}consumeIP4MulticastAddress(m,y){let b=y+3,G=m.slice(y,b),mt=parseInt(G);if(mt<224||mt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let ce=0;ce<3;ce++){if(m[b]!==".")throw new Error("Invalid IP4 multicast address.");b+=1,b=this.consumeDecimalUChar(m,b)}return m[b]==="/"&&(b+=1),b=this.consumeTTL(m,b),m[b]==="/"&&(b=this.consumeInteger(m,b)),b}consumeInteger(m,y){if(!S(m[y]))throw new Error("Invalid integer.");for(y+=1;l(m[y]);)y+=1;return y}consumeTTL(m,y){if(m[y]==="0")return y+1;if(!S(m[y]))throw new Error("Invalid TTL.");y+=1;for(let b=0;b<2&&l(m[y]);b++)y+=1;return y}consumeToken(m,y){return this.consumeOneOrMore(m,y,p)}consumeTime(m,y){let b=y;if(m[b]==="0")return b+1;for(S(m[b])&&(b+=1);l(m[b]);)b++;if(b-y<10)throw new Error("Invalid time");return b}consumeAddress(m,y){return this.consumeTill(m,y,c)}consumeTypedTime(m,y){let b=y;return b=this.consumeOneOrMore(m,b,l),f(m[b])?b+1:b}consumeRepeatInterval(m,y){if(!S(m[y]))throw new Error("Invalid repeat interval");for(y+=1;l(m[y]);)y+=1;return f(m[y])&&(y+=1),y}consumePort(m,y){return this.consumeOneOrMore(m,y,l)}consume(m,y,b){for(let G=0;G<b.length;G++){if(y+G>=m.length)throw new Error("consume exceeding value length");if(m[y+G]!==b[G])throw new Error("consume ".concat(b," failed at ").concat(G))}return y+b.length}consumeTill(m,y,b){let G=y;for(;G<m.length&&(typeof b!="string"||m[G]!==b)&&(typeof b!="function"||!b(m[G]));)G++;return G}}class V extends k{constructor(){super(),N(this,"records",[]),N(this,"currentLine",0)}parse(m){let y=this.probeEOL(m);this.records=m.split(y).filter(ls=>!!Pn(ls).call(ls)).map(this.parseLine),this.currentLine=0;let b=this.parseVersion(),G=this.parseOrigin(),mt=this.parseSessionName(),ce=this.parseInformation(),Je=this.parseUri(),Wi=this.parseEmail(),ds=this.parsePhone(),bp=this.parseConnection(),xc=this.parseBandWidth(),wp=this.parseTimeFields(),da=this.parseKey(),Cl=this.parseSessionAttribute(),la=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:b,origin:G,sessionName:mt,information:ce,uri:Je,emails:Wi,phones:ds,connection:bp,bandwidths:xc,timeFields:wp,key:da,attributes:Cl,mediaDescriptions:la}}getCurrentRecord(){let m=this.records[this.currentLine];if(!m)throw new Error("Record doesn't exit.");return m}probeEOL(m){for(let y=0;y<m.length;y++)if(m[y]===s)return m[y-1]==="\r"?a:s;throw new Error("Invalid newline character.")}parseLine(m,y){if(m.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let b=m[0];if(m[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:b,value:m.slice(2),line:y,cur:0}}parseSessionAttribute(){let m=new ut;for(;this.currentLine<this.records.length;){let y=this.getCurrentRecord();if(y.type!==d.ATTRIBUTE)break;let b={attField:this.extractOneOrMore(y,G=>p(G)&&G!==":"),_cur:0};y.value[y.cur]===":"&&(y.cur+=1,b.attValue=this.extractOneOrMore(y,R)),m.parse(b),this.currentLine++}return m.digest()}parseMediaAttributes(m){let y=new dt(m);for(;this.currentLine<this.records.length;){let b=this.getCurrentRecord();if(b.type!==d.ATTRIBUTE)break;let G={attField:this.extractOneOrMore(b,mt=>p(mt)&&mt!==":"),_cur:0};b.value[b.cur]===":"&&(b.cur+=1,G.attValue=this.extractOneOrMore(b,R)),y.parse(G),this.currentLine++}return y.digest()}parseKey(){let m=this.getCurrentRecord();if(m.type===d.KEY){if(m.value==="prompt"||m.value==="clear:"||m.value==="base64:"||m.value==="uri:")return m.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let m=this.getCurrentRecord();if(m.type===d.ZONE_ADJUSTMENTS){let y=[];for(;;)try{let b=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);let G=!1;m.value[m.cur]==="-"&&(G=!0,m.cur+=1);let mt=this.extract(m,this.consumeTypedTime);y.push({time:b,typedTime:mt,back:G})}catch{break}if(y.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,y}return[]}parseRepeat(){let m=[];for(;;){let y=this.getCurrentRecord();if(y.type!==d.REPEAT)break;{let b=this.extract(y,this.consumeRepeatInterval),G=this.parseTypedTime(y);m.push({repeatInterval:b,typedTimes:G}),this.currentLine++}}return m}parseTypedTime(m){let y=[];for(;;)try{this.consumeSpaceForRecord(m),y.push(this.extract(m,this.consumeTypedTime))}catch{break}if(y.length===0)throw new Error("Invalid typed time.");return y}parseTime(){let m=this.getCurrentRecord(),y=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);let b=this.extract(m,this.consumeTime);return this.currentLine++,{startTime:y,stopTime:b}}parseBandWidth(){let m=[];for(;this.currentLine<this.records.length;){let y=this.getCurrentRecord();if(y.type!==d.BANDWIDTH)break;{let b=this.extractOneOrMore(y,p);if(y.value[y.cur]!==":")throw new Error("Invalid bandwidth field.");y.cur++;let G=this.extractOneOrMore(y,l);m.push({bwtype:b,bandwidth:G}),this.currentLine++}}return m}parseVersion(){let m=this.getCurrentRecord();if(m.type!==d.VERSION)throw new Error("first sdp record must be version");let y=m.value.slice(0,this.consumeOneOrMore(m.value,0,l));if(y.length!==m.value.length)throw new Error('invalid proto version, "v='.concat(m.value,'"'));return this.currentLine++,y}parseOrigin(){let m=this.getCurrentRecord();if(m.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");let y=this.extractOneOrMore(m,h);this.consumeSpaceForRecord(m);let b=this.extractOneOrMore(m,l);this.consumeSpaceForRecord(m);let G=this.extractOneOrMore(m,l);this.consumeSpaceForRecord(m);let mt=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let ce=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let Je=this.extract(m,this.consumeUnicastAddress);return this.currentLine++,{username:y,sessId:b,sessVersion:G,nettype:mt,addrtype:ce,unicastAddress:Je}}parseSessionName(){let m=this.getCurrentRecord();if(m.type===d.SESSION_NAME){let y=this.extract(m,this.consumeText);return this.currentLine++,y}}parseInformation(){let m=this.getCurrentRecord();if(m.type!==d.INFORMATION)return;let y=this.extract(m,this.consumeText);return this.currentLine++,y}parseUri(){let m=this.getCurrentRecord();if(m.type===d.URI)return this.currentLine++,m.value}parseEmail(){let m=[];for(;;){let y=this.getCurrentRecord();if(y.type!==d.EMAIL)break;m.push(y.value),this.currentLine++}return m}parsePhone(){let m=[];for(;;){let y=this.getCurrentRecord();if(y.type!==d.PHONE)break;m.push(y.value),this.currentLine++}return m}parseConnection(){let m=this.getCurrentRecord();if(m.type===d.CONNECTION){let y=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let b=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let G=this.extract(m,this.consumeAddress);return this.currentLine++,{nettype:y,addrtype:b,address:G}}}parseMedia(){let m=this.getCurrentRecord(),y=this.extract(m,this.consumeToken);this.consumeSpaceForRecord(m);let b=this.extract(m,this.consumePort);m.value[m.cur]==="/"&&(m.cur+=1,b+=this.extract(m,this.consumeInteger)),this.consumeSpaceForRecord(m);let G=[];for(G.push(this.extract(m,this.consumeToken));m.value[m.cur]==="/";)m.cur+=1,G.push(this.extract(m,this.consumeToken));if(G.length===0)throw new Error("Invalid proto");let mt=this.parseFmt(m);return this.currentLine++,{mediaType:y,port:b,protos:G,fmts:mt}}parseTimeFields(){let m=[];for(;this.getCurrentRecord().type===d.TIME;){let y=this.parseTime(),b=this.parseRepeat(),G=this.parseZone();m.push({time:y,repeats:b,zones:G})}return m}parseMediaDescription(){let m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){let y=this.parseMedia(),b=this.parseInformation(),G=this.parseConnections(),mt=this.parseBandWidth(),ce=this.parseKey(),Je=this.parseMediaAttributes(y);m.push({media:y,information:b,connections:G,bandwidths:mt,key:ce,attributes:Je})}return m}parseConnections(){let m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)m.push(this.parseConnection());return m}parseFmt(m){let y=[];for(;;)try{this.consumeSpaceForRecord(m),y.push(this.extract(m,this.consumeToken))}catch{break}if(y.length===0)throw new Error("Invalid fmts");return y}extract(m,y){for(var b=arguments.length,G=new Array(b>2?b-2:0),mt=2;mt<b;mt++)G[mt-2]=arguments[mt];let ce=y.call(this,m.value,m.cur,...G),Je=m.value.slice(m.cur,ce);return m.cur=ce,Je}extractOneOrMore(m,y){let b=this.consumeOneOrMore(m.value,m.cur,y),G=m.value.slice(m.cur,b);return m.cur=b,G}consumeSpaceForRecord(m){if(m.value[m.cur]!==c)throw new Error("Invalid space at ".concat(m.cur,"."));m.cur+=1}}class J extends k{constructor(){super(...arguments),N(this,"attributes",void 0),N(this,"digested",!1)}extractOneOrMore(m,y,b){let G=this.consumeOneOrMore(m.attValue,m._cur,y),mt=m.attValue.slice(m._cur,G),[ce,Je]=b||[];if(typeof ce=="number"&&mt.length<ce)throw new Error("error in length, should be more or equal than ".concat(ce," characters."));if(typeof Je=="number"&&mt.length>Je)throw new Error("error in length, should be less or equal than ".concat(Je," characters."));return m._cur=G,mt}consumeAttributeSpace(m){if(m.attValue[m._cur]!==c)throw new Error("Invalid space at ".concat(m._cur,"."));m._cur+=1}extract(m,y){if(!m.attValue)throw new Error("Nothing to extract from attValue.");for(var b=arguments.length,G=new Array(b>2?b-2:0),mt=2;mt<b;mt++)G[mt-2]=arguments[mt];let ce=y.call(this,m.attValue,m._cur,...G),Je=m.attValue.slice(m._cur,ce);return m._cur=ce,Je}atEnd(m){if(!m.attValue)throw new Error;return m._cur>=m.attValue.length}peekChar(m){if(!m.attValue)throw new Error;return m.attValue[m._cur]}peek(m,y){if(!m.attValue)throw new Error;for(let b=0;b<y.length;b++)if(y[b]!==m.attValue[m._cur+b])return!1;return!0}parseIceUfrag(m){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(m,v,[4,256])}parseIcePwd(m){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(m,v,[22,256])}parseIceOptions(m){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let y=[];for(;!this.atEnd(m);){y.push(this.extractOneOrMore(m,v));try{this.consumeAttributeSpace(m)}catch(b){if(this.atEnd(m))break;throw b}}this.attributes.iceOptions=y}parseFingerprint(m){let y=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let b=this.extract(m,this.consumeTill);this.attributes.fingerprints.push({hashFunction:y,fingerprint:b})}parseExtmap(m){let y=this.extractOneOrMore(m,l),b;this.peekChar(m)==="/"&&(this.extract(m,this.consume,"/"),b=this.extract(m,this.consumeToken)),this.consumeAttributeSpace(m);let G=this.extract(m,this.consumeTill,c),mt=A(A({entry:parseInt(y,10)},b&&{direction:b}),{},{extensionName:G});this.peekChar(m)===c&&(this.consumeAttributeSpace(m),mt.extensionAttributes=this.extract(m,this.consumeTill)),this.attributes.extmaps.push(mt)}parseSetup(m){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let y=this.extract(m,this.consumeTill);if(y!=="active"&&y!=="passive"&&y!=="actpass"&&y!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=y}}class ut extends J{constructor(){super(...arguments),N(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"group":this.parseGroup(m);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"fingerprint":this.parseFingerprint(m);break;case"setup":this.parseSetup(m);break;case"tls-id":this.parseTlsId(m);break;case"identity":this.parseIdentity(m);break;case"extmap":this.parseExtmap(m);break;case"msid-semantic":this.parseMsidSemantic(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(y){throw console.error("parsing session attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),y}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(m){let y=this.extract(m,this.consumeToken),b=[];for(;!this.atEnd(m)&&this.peekChar(m)===c;)this.consumeAttributeSpace(m),b.push(this.extract(m,this.consumeToken));this.attributes.groups.push({semantic:y,identificationTag:b})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(m){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(m,I)}parseIdentity(m){let y=this.extractOneOrMore(m,w),b=[];for(;!this.atEnd(m)&&this.peekChar(m)===c;){this.consumeAttributeSpace(m);let G=this.extract(m,this.consumeToken);this.extract(m,this.consume,"=");let mt=this.extractOneOrMore(m,ce=>ce!==c&&R(ce));b.push({name:G,value:mt})}this.attributes.identities.push({assertionValue:y,extensions:b})}parseMsidSemantic(m){this.peekChar(m)===c&&this.consumeAttributeSpace(m);let y={semantic:this.extract(m,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(m)}catch{break}if(this.peekChar(m)==="*"){this.extract(m,this.consume,"*"),y.applyForAll=!0;break}{let b=this.extract(m,this.consumeTill,c);y.identifierList.push(b)}}this.attributes.msidSemantic=y}}class dt extends J{constructor(m){super(),N(this,"attributes",void 0),m.protos.indexOf("RTP")!==-1||m.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"extmap":this.parseExtmap(m);break;case"setup":this.parseSetup(m);break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"candidate":this.parseCandidate(m);break;case"remote-candidate":this.parseRemoteCandidate(m);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(m);break;case"rtpmap":this.parseRtpmap(m);break;case"ptime":this.parsePtime(m);break;case"maxptime":this.parseMaxPtime(m);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(m);break;case"ssrc":this.parseSSRC(m);break;case"fmtp":this.parseFmtp(m);break;case"rtcp-fb":this.parseRtcpFb(m);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(m);break;case"mid":this.parseMid(m);break;case"msid":this.parseMsid(m);break;case"imageattr":this.parseImageAttr(m);break;case"rid":this.parseRid(m);break;case"simulcast":this.parseSimulcast(m);break;case"sctp-port":this.parseSctpPort(m);break;case"max-message-size":this.parseMaxMessageSize(m);break;case"ssrc-group":this.parseSSRCGroup(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(y){throw console.error("parsing media attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),y}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}parseCandidate(m){let y=this.extractOneOrMore(m,v,[1,32]);this.consumeAttributeSpace(m);let b=this.extractOneOrMore(m,l,[1,5]);this.consumeAttributeSpace(m);let G=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let mt=this.extractOneOrMore(m,l,[1,10]);this.consumeAttributeSpace(m);let ce=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);let Je=this.extract(m,this.consumePort);this.consumeAttributeSpace(m),this.extract(m,this.consume,"typ"),this.consumeAttributeSpace(m);let Wi={foundation:y,componentId:b,transport:G,priority:mt,connectionAddress:ce,port:Je,type:this.extract(m,this.consumeToken),extension:{}};for(this.peek(m," raddr")&&(this.extract(m,this.consume," raddr"),this.consumeAttributeSpace(m),Wi.relAddr=this.extract(m,this.consumeAddress)),this.peek(m," rport")&&(this.extract(m,this.consume," rport"),this.consumeAttributeSpace(m),Wi.relPort=this.extract(m,this.consumePort));this.peekChar(m)===c;){this.consumeAttributeSpace(m);let ds=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m),Wi.extension[ds]=this.extractOneOrMore(m,u)}this.attributes.candidates.push(Wi)}parseRemoteCandidate(m){let y=[];for(;;){let b=this.extractOneOrMore(m,l,[1,5]);this.consumeAttributeSpace(m);let G=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);let mt=this.extract(m,this.consumePort);y.push({componentId:b,connectionAddress:G,port:mt});try{this.consumeAttributeSpace(m)}catch{break}}this.attributes.remoteCandidatesList.push(y)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(m){let y=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let b=this.extract(m,this.consumeTill,"/");this.extract(m,this.consume,"/");let G={encodingName:b,clockRate:this.extractOneOrMore(m,l)};this.atEnd(m)||this.peekChar(m)!=="/"||(this.extract(m,this.consume,"/"),G.encodingParameters=parseInt(this.extract(m,this.consumeTill),10));let mt=this.attributes.payloads.find(ce=>ce.payloadType===parseInt(y,10));mt?mt.rtpMap=G:this.attributes.payloads.push({payloadType:parseInt(y,10),rtpMap:G,rtcpFeedbacks:[]})}parsePtime(m){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(m,this.consumeTill)}parseMaxPtime(m){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(m,this.consumeTill)}parseDirection(m){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=m.attField}parseSSRC(m){let y=this.extractOneOrMore(m,l);this.consumeAttributeSpace(m);let b=this.extract(m,this.consumeTill,":"),G;this.peekChar(m)===":"&&(this.extract(m,this.consume,":"),G=this.extract(m,this.consumeTill));let mt=this.attributes.ssrcs.find(ce=>ce.ssrcId===parseInt(y,10));mt?mt.attributes[b]=G:this.attributes.ssrcs.push({ssrcId:parseInt(y,10),attributes:{[b]:G}})}parseFmtp(m){let y=this.extract(m,this.consumeTill,c);this.consumeAttributeSpace(m);let b=this.extract(m,this.consumeTill),G={};b.split(";").forEach(ce=>{let[Je,Wi]=ce.split("=");Je=Pn(Je).call(Je);let ds=typeof Wi=="string"?Pn(Wi).call(Wi):null;typeof Je=="string"&&Je.length>0&&(G[Je]=ds)});let mt=this.attributes.payloads.find(ce=>ce.payloadType===parseInt(y,10));mt?mt.fmtp={parameters:G}:this.attributes.payloads.push({payloadType:parseInt(y,10),rtcpFeedbacks:[],fmtp:{parameters:G}})}parseFmtParameters(m){let y={},b=this.extract(m,this.consumeTill,"=");m._cur++;let G=this.extract(m,this.consumeTill,";");for(y[b]=G;m.attValue[m._cur]===";";){let mt=this.extract(m,this.consumeTill,"=");m._cur++;let ce=this.extract(m,this.consumeTill,";");y[mt]=ce}return y}parseRtcpFb(m){let y="";y=this.peekChar(m)==="*"?this.extract(m,this.consume,"*"):this.extract(m,this.consumeTill,c),this.consumeAttributeSpace(m);let b=this.extract(m,this.consumeTill,c),G;if(b==="trr-int")G={type:b,interval:this.extract(m,this.consumeTill)};else{let mt={type:b};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),mt.parameter=this.extract(m,this.consumeToken),this.peekChar(m)===c&&(mt.additional=this.extract(m,this.consumeTill))),G=mt}if(y==="*")this.attributes.rtcpFeedbackWildcards.push(G);else{let mt=this.attributes.payloads.find(ce=>ce.payloadType===parseInt(y,10));mt?mt.rtcpFeedbacks.push(G):this.attributes.payloads.push({payloadType:parseInt(y,10),rtcpFeedbacks:[G]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(m){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let y={port:this.extract(m,this.consumePort)};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),y.netType=this.extractOneOrMore(m,p),this.consumeAttributeSpace(m),y.addressType=this.extractOneOrMore(m,p),this.consumeAttributeSpace(m),y.address=this.extract(m,this.consumeAddress)),this.attributes.rtcp=y}parseMsid(m){let y={id:this.extractOneOrMore(m,p,[1,64])};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),y.appdata=this.extractOneOrMore(m,p,[1,64])),this.attributes.msids.push(y)}parseImageAttr(m){this.attributes.imageattr.push(m.attValue)}parseRid(m){let y=this.extractOneOrMore(m,G=>E(G)||l(G)||G==="_"||G==="-");this.consumeAttributeSpace(m);let b={id:y,direction:this.extract(m,this.consumeToken),params:[]};if(this.peekChar(m)===c){if(this.consumeAttributeSpace(m),this.peek(m,"pt=")){this.extract(m,this.consume,"pt=");let G=[];for(;;){let mt=this.extract(m,this.consumeToken);G.push(mt);try{this.extract(m,this.consume,",")}catch{break}}b.payloads=G,this.peekChar(m)===c&&this.extract(m,this.consume,c)}for(;;){let G=this.extract(m,this.consumeToken);switch(G){case"depend":{let mt={type:G,rids:this.extract(m,this.consume,"=").split(",")};b.params.push(mt);break}default:{let mt={type:G};this.peekChar(m)==="="&&(this.extract(m,this.consume,"="),mt.val=this.extract(m,this.consumeTill,";")),b.params.push(mt)}}try{this.extract(m,this.consume,";")}catch{break}}}this.attributes.rids.push(b)}parseSimulcast(m){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=m.attValue,this.extract(m,this.consumeTill)}parseSctpPort(m){this.attributes.sctpPort=this.extractOneOrMore(m,l,[1,5])}parseMaxMessageSize(m){this.attributes.maxMessageSize=this.extractOneOrMore(m,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(m){this.attributes.mid=this.extract(m,this.consumeToken)}parseSSRCGroup(m){let y=this.extract(m,this.consumeToken),b=[];for(;;)try{this.consumeAttributeSpace(m);let G=this.extract(m,this.consumeInteger);b.push(parseInt(G,10))}catch{break}this.attributes.ssrcGroups.push({semantic:y,ssrcIds:b})}}function Ct(x,m,y){return m in x?Object.defineProperty(x,m,{value:y,enumerable:!0,configurable:!0,writable:!0}):x[m]=y,x}class St{constructor(){Ct(this,"eol",a)}print(m,y){let b="";return y&&(this.eol=y),b+=this.printVersion(m.version),b+=this.printOrigin(m.origin),b+=this.printSessionName(m.sessionName),b+=this.printInformation(m.information),b+=this.printUri(m.uri),b+=this.printEmail(m.emails),b+=this.printPhone(m.phones),b+=this.printConnection(m.connection),b+=this.printBandwidth(m.bandwidths),b+=this.printTimeFields(m.timeFields),b+=this.printKey(m.key),b+=this.printSessionAttributes(m.attributes),b+=this.printMediaDescription(m.mediaDescriptions),b}printVersion(m){return"v=".concat(m).concat(this.eol)}printOrigin(m){return"o=".concat(m.username," ").concat(m.sessId," ").concat(m.sessVersion," ").concat(m.nettype," ").concat(m.addrtype," ").concat(m.unicastAddress).concat(this.eol)}printSessionName(m){return m?"s=".concat(m).concat(this.eol):""}printInformation(m){return m?"i=".concat(m).concat(this.eol):""}printUri(m){return m?"u=".concat(m).concat(this.eol):""}printEmail(m){let y="";for(let b of m)y+="e=".concat(b).concat(this.eol);return y}printPhone(m){let y="";for(let b of m)y+="e=".concat(b).concat(this.eol);return y}printConnection(m){return m?"c=".concat(m.nettype," ").concat(m.addrtype," ").concat(m.address).concat(this.eol):""}printBandwidth(m){let y="";for(let b of m)y+="b=".concat(b.bwtype,":").concat(b.bandwidth).concat(this.eol);return y}printTimeFields(m){let y="";for(let b of m){y+="t=".concat(b.time.startTime," ").concat(b.time.startTime).concat(this.eol);for(let G of b.repeats)y+="r=".concat(G.repeatInterval," ").concat(G.typedTimes.join(" ")).concat(this.eol);b.zoneAdjustments&&(y+="z=",y+="z=".concat(b.zoneAdjustments.map(G=>"".concat(G.time," ").concat(G.back?"-":""," ").concat(G.typedTime)).join(" ")).concat(this.eol),y+=this.eol)}return y}printKey(m){return m?"k=".concat(m).concat(this.eol):""}printAttributes(m){let y="";for(let b of m)y+="a=".concat(b.attField).concat(b.attValue?":".concat(b.attValue):"").concat(this.eol);return y}printMediaDescription(m){let y="";for(let b of m)y+=this.printMedia(b.media),y+=this.printInformation(b.information),y+=this.printConnections(b.connections),y+=this.printBandwidth(b.bandwidths),y+=this.printKey(b.key),y+=this.printMediaAttributes(b);return y}printConnections(m){let y="";for(let b of m)y+=this.printConnection(b);return y}printMedia(m){return"m=".concat(m.mediaType," ").concat(m.port," ").concat(m.protos.join("/")," ").concat(m.fmts.join(" ")).concat(this.eol)}printSessionAttributes(m){return new fe(this.eol).print(m)}printMediaAttributes(m){return new U(this.eol).print(m)}}class Gt{constructor(m){Ct(this,"eol",void 0),this.eol=m}printIceUfrag(m){return m===void 0?"":"a=ice-ufrag:".concat(m).concat(this.eol)}printIcePwd(m){return m===void 0?"":"a=ice-pwd:".concat(m).concat(this.eol)}printIceOptions(m){return m===void 0?"":"a=ice-options:".concat(m.join(c)).concat(this.eol)}printFingerprints(m){return m.length>0?m.map(y=>"a=fingerprint:".concat(y.hashFunction).concat(c).concat(y.fingerprint)).join(this.eol)+this.eol:""}printExtmap(m){return m.map(y=>"a=extmap:".concat(y.entry).concat(y.direction?"/".concat(y.direction):"").concat(c).concat(y.extensionName).concat(y.extensionAttributes?"".concat(c).concat(y.extensionAttributes):"").concat(this.eol)).join("")}printSetup(m){return m===void 0?"":"a=setup:".concat(m).concat(this.eol)}printUnrecognized(m){return m.map(y=>"a=".concat(y.attField).concat(y.attValue?":".concat(y.attValue):"").concat(this.eol)).join("")}}class fe extends Gt{print(m){let y="";return y+=this.printGroups(m.groups),y+=this.printMsidSemantic(m.msidSemantic),y+=this.printIceLite(m.iceLite),y+=this.printIceUfrag(m.iceUfrag),y+=this.printIcePwd(m.icePwd),y+=this.printIceOptions(m.iceOptions),y+=this.printFingerprints(m.fingerprints),y+=this.printSetup(m.setup),y+=this.printTlsId(m.tlsId),y+=this.printIdentity(m.identities),y+=this.printExtmap(m.extmaps),y+=this.printUnrecognized(m.unrecognized),y}printGroups(m){let y="";return m.length>0&&(y+=m.map(b=>"a=group:".concat(b.semantic).concat(b.identificationTag.map(G=>"".concat(c).concat(G)).join("")).concat(this.eol)).join("")),y}printIceLite(m){return m===void 0?"":"a=ice-lite"+this.eol}printTlsId(m){return m?"a=tls-id:".concat(m).concat(this.eol):""}printIdentity(m){return m.length===0?"":m.map(y=>"a=identity:".concat(y.assertionValue).concat(y.extensions.map(b=>"".concat(c).concat(b.name).concat(b.value?"=".concat(b.value):"")))).join(this.eol)+this.eol}printMsidSemantic(m){if(!m)return"";let y="a=msid-semantic:".concat(m.semantic);return m.applyForAll?y+="".concat(c,"*"):m.identifierList.length>0&&(y+=m.identifierList.map(b=>"".concat(c).concat(b))),y+this.eol}}class U extends Gt{print(m){let y=m.attributes,b="";return b+=this.printRTCP(y.rtcp),b+=this.printIceUfrag(y.iceUfrag),b+=this.printIcePwd(y.icePwd),b+=this.printIceOptions(y.iceOptions),b+=this.printCandidates(y.candidates),b+=this.printRemoteCandidatesList(y.remoteCandidatesList),b+=this.printEndOfCandidates(y.endOfCandidates),b+=this.printFingerprints(y.fingerprints),b+=this.printSetup(y.setup),b+=this.printMid(y.mid),b+=this.printExtmap(y.extmaps),b+=this.printRTPRelated(y),b+=this.printPtime(y.ptime),b+=this.printMaxPtime(y.maxPtime),b+=this.printDirection(y.direction),b+=this.printSSRCGroups(y.ssrcGroups),b+=this.printSSRC(y.ssrcs),b+=this.printRTCPMux(y.rtcpMux),b+=this.printRTCPMuxOnly(y.rtcpMuxOnly),b+=this.printRTCPRsize(y.rtcpRsize),b+=this.printMSId(y.msids),b+=this.printImageattr(y.imageattr),b+=this.printRid(y.rids),b+=this.printSimulcast(y.simulcast),b+=this.printSCTPPort(y.sctpPort),b+=this.printMaxMessageSize(y.maxMessageSize),b+=this.printUnrecognized(y.unrecognized),b}printCandidates(m){return m.map(y=>"a=candidate:".concat(y.foundation).concat(c).concat(y.componentId).concat(c).concat(y.transport).concat(c).concat(y.priority).concat(c).concat(y.connectionAddress).concat(c).concat(y.port).concat(c,"typ").concat(c).concat(y.type).concat(y.relAddr?"".concat(c,"raddr").concat(c).concat(y.relAddr):"").concat(y.relPort?"".concat(c,"rport").concat(c).concat(y.relPort):"").concat(Object.keys(y.extension).map(b=>"".concat(c).concat(b).concat(c).concat(y.extension[b])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(m){return m.map(y=>"a=remote-candidates:".concat(y.join(c)).concat(this.eol)).join("")}printEndOfCandidates(m){return m===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(m){if(!m.payloads)return"";let y=m.payloads,b="";b+=m.rtcpFeedbackWildcards.map(G=>this.printRTCPFeedback("*",G)).join("");for(let G of y)b+=this.printRtpMap(G.payloadType,G.rtpMap),b+=this.printFmtp(G.payloadType,G.fmtp),b+=G.rtcpFeedbacks.map(mt=>this.printRTCPFeedback(G.payloadType,mt)).join("");return b}printFmtp(m,y){if(!y)return"";let b=Object.keys(y.parameters);return b.length===1&&y.parameters[b[0]]===null?"a=fmtp:".concat(m).concat(c).concat(b[0]).concat(this.eol):"a=fmtp:".concat(m).concat(c).concat(Object.keys(y.parameters).map(G=>"".concat(G,"=").concat(y.parameters[G])).join(";")).concat(this.eol)}printRtpMap(m,y){return y?"a=rtpmap:".concat(m).concat(c).concat(y.encodingName,"/").concat(y.clockRate).concat(y.encodingParameters?"/".concat(y.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(m,y){let b="a=rtcp-fb:".concat(m).concat(c),G=y;return G.type==="trr-int"?b+="ttr-int".concat(c).concat(G.interval):(b+="".concat(G.type),G.parameter&&(b+="".concat(c).concat(G.parameter),G.additional&&(b+="".concat(c).concat(G.additional)))),b+this.eol}printPtime(m){return m===void 0?"":"a=ptime:".concat(m).concat(this.eol)}printMaxPtime(m){return m===void 0?"":"a=maxptime:".concat(m).concat(this.eol)}printDirection(m){return m===void 0?"":"a=".concat(m).concat(this.eol)}printSSRC(m){return m.map(y=>Object.keys(y.attributes).map(b=>"a=ssrc:".concat(y.ssrcId.toString(10)).concat(c).concat(b).concat(y.attributes[b]?":".concat(y.attributes[b]):"").concat(this.eol)).join("")).join("")}printRTCPMux(m){return m===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(m){return m===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(m){return m===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(m){if(m===void 0)return"";let y="a=rtcp:".concat(m.port);return m.netType&&(y+="".concat(c).concat(m.netType)),m.addressType&&(y+="".concat(c).concat(m.addressType)),m.address&&(y+="".concat(c).concat(m.address)),y+this.eol}printMSId(m){return m.map(y=>"a=msid:".concat(y.id).concat(y.appdata?"".concat(c).concat(y.appdata):"").concat(this.eol)).join("")}printImageattr(m){return m.map(y=>"a=imageattr:".concat(y).concat(this.eol)).join("")}printRid(m){return m.map(y=>{let b="a=rid:".concat(y.id).concat(c).concat(y.direction);return y.payloads&&(b+="".concat(c,"pt=").concat(y.payloads.join(","))),y.params.length>0&&(b+="".concat(c).concat(y.params.map(G=>G.type==="depend"?"depend=".concat(G.rids.join(",")):"".concat(G.type,"=").concat(G.val)).join(";"))),b+this.eol}).join("")}printSimulcast(m){return m===void 0?"":"a=simulcast:".concat(m).concat(this.eol)}printSCTPPort(m){return m===void 0?"":"a=sctp-port:".concat(m).concat(this.eol)}printMaxMessageSize(m){return m===void 0?"":"a=max-message-size:".concat(m).concat(this.eol)}printMid(m){return m===void 0?"":"a=mid:".concat(m).concat(this.eol)}printSSRCGroups(m){return m.map(y=>"a=ssrc-group:".concat(y.semantic).concat(y.ssrcIds.map(b=>"".concat(c).concat(b.toString(10))).join("")).concat(this.eol)).join("")}}function K(x){return new V().parse(x)}function $(x,m){return new St().print(x,m)}}},e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={exports:{}};return t[i](r,r.exports,n),r.exports}return n.d=(i,r)=>{for(var o in r)n.o(r,o)&&!n.o(i,o)&&Object.defineProperty(i,o,{enumerable:!0,get:r[o]})},n.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),n.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},n(8)})();function Mn(t){return Gb.parse(t)}function To(t,e){return Gb.print(t,e)}var l4=Di("Array","keys"),u4=ko,h4=yn,p4=At,_4=l4,Uf=Array.prototype,m4={DOMTokenList:!0,NodeList:!0},E4=function(t){var e=t.keys;return t===Uf||p4(Uf,t)&&e===Uf.keys||h4(m4,u4(t))?_4:e},bn=H(E4);function ye(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Wb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Rt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Wb(Object(n),!0).forEach(function(i){ye(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Wb(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function mh(t,e){return mh=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},mh(t,e)}function xf(){xf=function(r,o){return new n(r,void 0,o)};var t=RegExp.prototype,e=new WeakMap;function n(r,o,s){var a=RegExp(r,o);return e.set(a,s||e.get(r)),mh(a,n.prototype)}function i(r,o){var s,a=e.get(o);return Pi(s=Object.keys(a)).call(s,function(c,d){var l=a[d];if(typeof l=="number")c[d]=r[l];else{for(var u=0;r[l[u]]===void 0&&u+1<l.length;)u++;c[d]=r[l[u]]}return c},Object.create(null))}return function(r,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(o&&o.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),o&&mh(r,o)}(n,RegExp),n.prototype.exec=function(r){var o=t.exec.call(this,r);if(o){o.groups=i(o,this);var s=o.indices;s&&(s.groups=i(s,this))}return o},n.prototype[Symbol.replace]=function(r,o){if(typeof o=="string"){var s=e.get(this);return t[Symbol.replace].call(this,r,o.replace(/\$<([^>]+)(>|$)/g,function(c,d,l){if(l==="")return c;var u=s[d];return Array.isArray(u)?"$"+u.join("$"):typeof u=="number"?"$"+u:""}))}if(typeof o=="function"){var a=this;return t[Symbol.replace].call(this,r,function(){var c=arguments;return typeof c[c.length-1]!="object"&&(c=[].slice.call(c)).push(i(c,a)),o.apply(this,c)})}return t[Symbol.replace].call(this,r,o)},xf.apply(this,arguments)}let Hb=new class extends ge{constructor(){super(...arguments),ye(this,"currentUploadLogID",0)}reportLogUploadError(t){let{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class f4{constructor(e){ye(this,"logger",void 0),ye(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function Vf(){let t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function Kb(){let t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?e?.[0]+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}let Mi={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Eh=Date.now(),Vd=t=>{for(let e in Mi)if(Object.prototype.hasOwnProperty.call(Mi,e)&&Mi[e]===t)return e;return"DEFAULT"},_=new class{constructor(){ye(this,"proxyServerURL",void 0),ye(this,"logLevel",Mi.DEBUG),ye(this,"uploadState","collecting"),ye(this,"uploadLogWaitingList",[]),ye(this,"uploadLogUploadingList",[]),ye(this,"uploadErrorCount",0),ye(this,"currentLogID",0),ye(this,"url",void 0),ye(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Mi.DEBUG].concat(e);this.log.apply(this,i)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Mi.INFO].concat(e);this.log.apply(this,i)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Mi.WARNING].concat(e);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Mi.ERROR].concat(e);this.log.apply(this,i)}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];let i=[Mi.DEBUG].concat(e);this.uploadLog.apply(this,i)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){$t("UPLOAD_LOG",!0)}disableLogUpload(){$t("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new f4(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Eh<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Eh);let i=Math.max(0,Math.min(4,e[0]));if(e[0]=Vf()+" Agora-SDK [".concat(Vd(i),"]:"),this.appendLogToWaitingList(i,...e),i<this.logLevel)return;let r=Vf()+" %cAgora-SDK [".concat(Vd(i),"]:"),o=[];if(!T("USE_NEW_LOG"))switch(i){case Mi.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case Mi.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case Mi.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case Mi.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Eh<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Eh);let i=Math.max(0,Math.min(4,e[0]));e[0]=Vf()+" Agora-SDK [".concat(Vd(i),"]:"),this.appendLogToWaitingList(i,...e)}appendLogToWaitingList(t){if(!T("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=Kb()+" Agora-SDK [".concat(Vd(t),"]:"):n[0]=Kb()+" Agora-SDK [".concat(Vd(t),"]:");let r="";n.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){let t=this.uploadLogUploadingList,e={sdk_version:ki,process_id:T("PROCESS_ID"),payload:JSON.stringify(t)};return Cr(async()=>{let n=await Gn.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(T("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(T("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){let i=new Error("unexpected upload log response");throw i.response=n,i}},()=>(this.uploadLogUploadingList=[],!1),n=>{let i={status:-1,message:n.message,errorRange:t.map(r=>r.log_item_id)};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),Hb.reportLogUploadError(i),!0},{timeout:T("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:T("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,T("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),T("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),T("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),T("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var Yb;function g4(t){return dn(t.reportId,"params.reportId",0,100,!1),dn(t.category,"params.category",0,100,!1),dn(t.event,"params.event",0,100,!1),dn(t.label,"params.label",0,100,!1),ie(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(Yb={}).FREE="free",Yb.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});let S4={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},Fe=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.RTE_DETAIL="rte_detail_stats",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t.AB_TEST="ab_test",t}({}),Ee=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t.AB_TEST="io.agora.pb.Wrtc.ABTest",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let T4=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function at(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,i){let r=i.value;if(typeof r=="function"){let o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);i.value=function(){for(var s,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(t.argsMap)try{l=t.argsMap(this,...c)}catch(h){_.warning(h),l=[]}try{JSON.stringify(l)}catch{_.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),l=[]}let u=(t.report||tt).reportApiInvoke(this._sessionId||null,{id:this._clientId||((s=this.store)===null||s===void 0?void 0:s.clientId)||this._ID,name:"".concat(o,".").concat(String(n)),options:l,tag:re.TRACER,reportResult:t.reportResult},t.throttleTime);try{let h=r.apply(this,c);return h instanceof Y?h.then(p=>(u.onSuccess(t.reportResult&&p),p)).catch(p=>{throw u.onError(p),p}):(u.onSuccess(t.reportResult&&h),h)}catch(h){throw u.onError(h),h}}}return i}}let tt=new class{constructor(){ye(this,"baseInfoMap",new Map),ye(this,"proxyServer",void 0),ye(this,"eventUploadTimer",void 0),ye(this,"setSessionIdTimer",void 0),ye(this,"url",void 0),ye(this,"sids",new Set),ye(this,"backupUrl",void 0),ye(this,"_appId",void 0),ye(this,"_aid",0),ye(this,"keyEventUploadPendingItems",[]),ye(this,"normalEventUploadPendingItems",[]),ye(this,"apiInvokeUploadPendingItems",[]),ye(this,"apiInvokeCount",0),ye(this,"apiInvokeLoggedCount",0),ye(this,"ltsList",[]),ye(this,"lastSendNormalEventTime",Date.now()),ye(this,"customReportCounterTimer",void 0),ye(this,"customReportCount",0),ye(this,"extApiInvoke",async t=>{for(let e of t){let n=Rt(Rt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:re.TRACER});this.sendApiInvoke(n)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),T("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),T("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t,this._aid=parseInt(t.replace(/[a-fA-F0-9]{8}/g,e=>{let[n,i]=e;return n+i}),16)||0}reportApiInvoke(t,e,n){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;let i=Date.now();this.apiInvokeCount+=1;let r=this.apiInvokeCount,o=!!T("SHOW_REPORT_INVOKER_LOG"),s=!!T("SHOW_REPORT_USER_INVOKER_LOG"),a=o||s&&e.id;a&&(this.apiInvokeLoggedCount+=1);let c=this.apiInvokeLoggedCount;function d(p,S){if(a){let E="[apiInvoke-".concat(c,"]");if(e.id&&(E+="[".concat(e.id,"]")),e.name&&(E+="[".concat(e.name,"]"),e.name===me.JOIN))return _.info("".concat(E," ").concat(p));_.info("".concat(E," ").concat(p),p==="start"?e.options:S||"")}}let l=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:i,options:e.options,states:e.states||null});d("start");let u=!1;Ye(e.timeout).then(()=>{u||(this.sendApiInvoke(Rt(Rt({},l()),{},{error:C.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});let h=new L(C.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:p=>{let S=()=>{if(u)throw h;return u=!0,this.sendApiInvoke(Rt(Rt({},l()),{},{success:!0},e.reportResult&&{result:p})),d("onSuccess"),p};return n?Ab(S,e.name+"Success",n,()=>u=!0):S()},onError:p=>{let S=()=>{if(u)throw p;u=!0,this.sendApiInvoke(Rt(Rt({},l()),{},{success:!1,error:p})),d("onFailure",p.toString())};return n?Ab(S,e.name+"Error",n,()=>u=!0):S()}}}_send(t,e,n){this.send({type:t,data:e},n)}_sendApiInvoke(t){return this.sendApiInvoke(t)}sessionInit(t,e){if(this.baseInfoMap.has(t))return;let n=Date.now(),i=this.createBaseInfo(t,n);i.cname=e.cname,i.rteUrl=e.rteUrl;let r=Object.assign({},{willUploadConsoleLog:T("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Pf?"global":"oversea",areas:T("AREAS")&&T("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=e,u=Date.now(),h=Rt(Rt({},i),{},{eventType:Fe.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:kf,lts:u,elapse:u-n,extend:JSON.stringify(r),mode:e.mode,process:T("PROCESS_ID"),appType:T("APP_TYPE"),success:!0,version:ki,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientType:B(p=window.navigator.userAgent).call(p,"AgoraWebView")?42:20,clientRole:l,serviceId:T("PROCESS_ID"),extensionID:T("PLUGIN_INFO").join(",")||"",rteUrl:e.rteUrl,rteSid:e.rteSid});var p;this.send({type:Ee.SESSION,data:h},!0)}reportRteDetail(t){let e=this.baseInfoMap.get(t);if(!e)return;let n=e.info,i=Date.now(),r=Rt(Rt({},n),{},{eventType:Fe.RTE_DETAIL,lts:i,success:!0,elapse:i-e.startTime,vid:n.vid===void 0?0:Number(n.vid),ua:navigator.userAgent});this.send({type:Ee.RTE_DETAIL,data:r},!0)}joinChooseServer(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info;e.vid&&(i.vid=e.vid);let r=Date.now(),o=Rt(Rt({},i),{},{role:e.role,eventType:Fe.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-n.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:e.resourceTimingInfo||void 0});this.send({type:Ee.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{eventType:Fe.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-n.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Ee.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info;e.vid&&(i.vid=e.vid),i.uid=e.uid,i.cid=e.cid;let r=Date.now(),{firstSuccess:o,addr:s,isProxy:a}=e,c=r-n.startTime,d=Rt(Rt({},i),{},{eventType:Fe.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:c,eventElapse:r-e.lts,firstSuccess:o,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:Df(),isABTestSuccess:e.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:a?1:0}),l=d.success?1:0;if(e.succ&&(n.lastJoinSuccessTime=r),s)if(d.signalChannel==="1"){let u=xf(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),h=s.match(u);d.gatewayIp=h&&h.groups?h.groups.ip:"",d.gatewayPort=h&&h.groups?h.groups.port:""}else if(a){let u=s.match(/h=(\d{1,3}-){3}\d{1,3}/g),h=s.match(/p=[0-9]{1,6}/g);d.gatewayIp=u&&u.length?u[0].split("=")[1].replace(/-/g,"."):"",d.gatewayPort=h&&h.length?h[0].split("=")[1]:""}else{let u=s.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),h=s.match(/(:|p=)[0-9]{1,6}/g);d.gatewayIp=u&&u.length?u[0].split("//")[1].replace(/-/g,"."):"",d.gatewayPort=h&&h.length?h[0].split(/:|p=/g)[1]:""}if(o)this.send({type:Ee.JOIN_GATEWAY,data:d},!0);else{let u={isSuccess:l,port:d.gatewayPort};delete d.success,delete d.eventType,delete d.firstSuccess,delete d.gatewayPort,d.vid=Number(d.vid);let h=Object.assign({},d,u,{eventType:Fe.REJOIN_GATEWAY});this.send({type:Ee.RE_JOIN_GATEWAY,data:h},!0)}}joinChannelTimeout(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=Date.now(),r=Rt(Rt({},n.info),{},{lts:i,timeout:e,elapse:i-n.startTime});this.send({type:Ee.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{eventType:Fe.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-n.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Ee.PUBLISH,data:o},!0)}subscribe(t,e,n){let i=this.baseInfoMap.get(t);if(!i)return;let r=i.info,o=Date.now(),s=Rt(Rt({},r),{},{eventType:Fe.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-i.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?s.peerSuid=e.peerid:s.peer=e.peerid,this.send({type:Ee.SUBSCRIBE,data:s},!0)}wsCompressorInit(t){var e;let n=[...bn(e=this.baseInfoMap).call(e)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;let o=r.info,s=Date.now(),a=Rt(Rt({},o),{},{eventType:Fe.WS_COMPRESSOR_INIT,lts:s,eventElapse:t.eventElapse,elapse:s-r.startTime,status:t.status?1:2});this.send({type:Ee.WS_COMPRESSOR_INIT,data:a},!0)}firstXLAPeerFirstVideoFrame(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=e.peerPubStatusMs-(n.lastJoinSuccessTime||r),s=Rt(Rt({},i),{},{elapse:r-n.startTime,eventType:Fe.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:e.peer,width:e.width,height:e.height,ssrc:e.ssrc,p2pid:e.p2pid,peerPublishDuration:e.peerPublishDuration,joinChannelSuccessElapse:o,peerPubStatusMs:e.peerPubStatusMs-e.joinChannelStart,availablePublish:e.peerPublishDuration>o?1:0,preloadStart:Math.max(e.preloadStart-e.joinChannelStart,0),preloadEnd:Math.max(e.preloadEnd-e.joinChannelStart,0),encrypt:Math.max(e.apStart-e.joinChannelStart,0),ap:Math.max(e.apEnd-e.joinChannelStart,0),sua:Math.max(e.suaEnd-e.joinChannelStart,0),beforeConnect:Math.max(e.beforeConnect-e.joinChannelStart,0),peerRecevier:Math.max(e.peerReceiver-e.joinChannelStart,0),ice:Math.max(e.ice-e.joinChannelStart,0),pc:Math.max(e.pc-e.joinChannelStart,0),signalConnected:Math.max(e.signalConnected-e.joinChannelStart,0),joinReq:Math.max(e.joinReq-e.joinChannelStart,0),joinRes:Math.max(e.joinRes-e.joinChannelStart,0),userJoinNotify:Math.max(e.userJoinNotify-e.joinChannelStart,0),videoSsrcNotify:Math.max(e.videoAddNotify-e.joinChannelStart,0),subscribeDelayMs:Math.max(e.subscribeStart-e.videoAddNotify,0),subscribeStart:Math.max(e.subscribeStart-e.joinChannelStart,0),subscribeEnd:Math.max(e.subscribeEnd-e.joinChannelStart,0),firstReceived:Math.max(e.firstReceived-e.joinChannelStart,0),firstDecoded:Math.max(e.firstDecoded-e.joinChannelStart,0),firstPreRender:Math.max(e.firstPreRender-e.joinChannelStart,0),firstRender:Math.max(e.firstRender-e.joinChannelStart,0),playDelayMs:Math.max(e.playStart-e.subscribeEnd,0),playStart:Math.max(e.playStart-e.joinChannelStart,0),playEnd:Math.max(e.playEnd-e.joinChannelStart,0),isPreSub:e.isPreSub?1:0,isPrePc:e.isPrePc?1:0,isPreInstantVideo:e.isPreInstantVideo?1:0,firstReceivedEncodedFrame:e.firstReceivedEncodedFrame?Math.max(e.firstReceivedEncodedFrame-e.joinChannelStart,0):void 0,frameType:e.frameType||"",rtpTimestamp:e.rtpTimestamp||0,framePayloadType:e.framePayloadType||0,frameDataLength:e.frameDataLength||0,mimeType:e.mimeType||""});this.send({type:Ee.XLA_PEER_FIRST_VIDEO_FRAME,data:s},!0)}firstRemoteVideoDecode(t,e,n,i){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=Rt(Rt(Rt({},o),i),{},{elapse:s-r.startTime,eventType:e,lts:s,firstDecodeFrame:Math.max((i.firstFrame||s)-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(t,e,n,i){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=Rt(Rt(Rt({},o),i),{},{elapse:s-r.startTime,eventType:e,lts:s});this.send({type:n,data:a},!0)}abTest(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:Fe.AB_TEST,lts:r});this.send({type:Ee.AB_TEST,data:o},!0)}pcStats(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:Fe.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:Ee.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),eventType:Fe.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Ee.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,n,i){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=Rt(Rt(Rt({},o),i),{},{eventType:e,lts:s});this.send({type:n,data:a},!0)}streamSwitch(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{eventType:Fe.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-n.startTime,success:e.succ});this.send({type:Ee.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{eventType:Fe.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ee.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{eventType:Fe.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ee.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?_.debug("reportProxyServerurl: ".concat(t)):_.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt({},i),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Ee.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now();(function(o,s,a){let c=o[s];if(!c||typeof c!="string")return[o];o[s]="";let d=Yr(JSON.stringify(o)),l=0,u=[],h=0;for(let p=0;p<c.length;p++)h+=c.charCodeAt(p)<=127?1:3,h<=a-d||(u[u.length]=W(W({},o),{},{[s]:c.substring(l,p)}),l=p,h=c.charCodeAt(p)<=127?1:3);return l!==c.length-1&&(u[u.length]=W(W({},o),{},{[s]:c.substring(l)})),u})(Rt(Rt(Rt({},i),e),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:Ee.WORKER_EVENT,data:o},!0))}apworkerEvent(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{elapse:r-n.startTime,lts:r});this.send({type:Ee.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{elapse:r-n.startTime,lts:r,extend:e.extend||void 0});this.send({type:Ee.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){let n=this.baseInfoMap.get(t);if(!n)return;let i=n.info,r=Date.now(),o=Rt(Rt(Rt({},i),e),{},{elapse:r-n.startTime,lts:r});this.send({type:Ee.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>T("CUSTOM_REPORT_LIMIT"))throw new L(C.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let n=Date.now(),i=e.map(r=>({type:Ee.USER_ANALYTICS,data:Rt(Rt({sid:t},r),{},{lts:n})}));try{T("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(r){throw _.error("send custom report message failed",r.toString()),new L(C.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(t){let e=T("NOT_REPORT_EVENT");if(t.tag&&B(e)&&B(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;let n=this.baseInfoMap.get(t.sid);if(!n)return this.apiInvokeUploadPendingItems.push(t),!1;let{cname:i,uid:r,cid:o}=n.info,s;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof L){let{code:c,message:d}=t.error;s=c||d||t.error.toString()}else s=t.error.toString();let a={invokeId:t.invokeId,sid:t.sid,cname:i,cid:o,uid:r,lts:t.lts,success:t.success,elapse:t.lts-n.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?s:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Ee.API_INVOKE,data:a},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){let t=this.apiInvokeUploadPendingItems;if(t.length===0)return;let e=Array.from(this.sids).find(n=>n!==null);e&&t.forEach(n=>{n&&(n.sid=e,this.sendApiInvoke(Object.assign({},n)))}),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>T("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){let n=[],i=[];for(;t.length;){let o=t.shift();n.length<20?n.push(o):i.push(o)}t.push(...i);for(let o of[...n]){var r;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Cs(r=this.ltsList).call(r,(s,a)=>s-a))}return e||(this.lastSendNormalEventTime=Date.now()),T("ENABLE_EVENT_REPORT")&&n.length&&(T("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((o=>s=>{T("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>T("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-T("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(n)),t}async postDataToStatsCollector2(t){ve.networkState===kn.OFFLINE&&await Y.race([ve.onlineWaiter,Ye(2*Pe.maxRetryTimeout)]);let e=r=>{let o=new Uint8Array;return r.forEach(s=>{let a=ff(JSON.stringify(s.data)),c=new ArrayBuffer(5),d=(u=>{let h=0;return Object.entries(Ee).forEach(p=>{let[S,E]=p;E===u.type&&(h=T4[S])}),h})(s),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),o=Eb(o,new Uint8Array(c)),o=Eb(o,a)}),o},n="event",i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(T("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(T("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){r===1&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(T("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(T("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await bf(i,{timeout:1e4,data:e(t),headers:Rt(Rt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(r===1)throw o;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=(a=>{let c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(t[0]),i=n?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(a=>JSON.stringify(a)),vid:n,aid:i};ve.networkState===kn.OFFLINE&&await Y.race([ve.onlineWaiter,Ye(2*Pe.maxRetryTimeout)]);let o=e?"/events/proto-raws":"/events/messages",s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(T("EVENT_REPORT_DOMAIN"),"&p=").concat(T("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(T("EVENT_REPORT_DOMAIN"),":").concat(T("STATS_COLLECTOR_PORT")).concat(o));for(let a=0;a<2;a+=1){a===1&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(T("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(T("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(T("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(T("STATS_COLLECTOR_PORT")).concat(o)));try{e?await o4(s,{timeout:1e4,data:r}):await bf(s,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(t,e){let n=Object.assign({},S4);return n.sid=t,this.baseInfoMap.set(t,{info:n,startTime:e}),n}reportResourceTiming(t,e){let n=performance.getEntriesByName(t),i=n[n.length-1];i&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:i,tag:re.TRACER}).onSuccess()}};Hb.on("REPORT_LOG_UPLOAD",t=>{t.networkState=ve.networkState,tt.reportApiInvoke(null,{name:"logUploadError",options:t,tag:re.TRACER}).onSuccess("logUploadError")});let D=class extends L{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),ye(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,_)}throw(){super.throw(_)}},qe={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function wt(){return qe}function qb(){return"setSinkId"in HTMLAudioElement.prototype&&(!T("RESTRICTION_SET_PLAYBACK_DEVICE")||(go()||eb())&&!lb())}function fh(){return!qe.supportUnifiedPlan||T("CHROME_FORCE_PLAN_B")&&Kr()}function Fd(t){return!(ue()||nb(87)||fh()||!T("ENABLE_PRE_SUB")&&(t==null||!t.autoSubscribe||T("FORCE_DISABLE_AUTO_SUB")))}function zb(t){return T("ENABLE_INSTANT_VIDEO")?T("ENABLE_INSTANT_VIDEO"):!(t==null||!t.autoSubscribe||T("FORCE_DISABLE_AUTO_SUB"))}function Xb(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function Jb(){if(Xb()){let t=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in t)||!t.suppressLocalAudioPlayback)}return Rr(141)||Ho(141)||Ds(141)}function Qb(){if(Xb()){let t=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in t)||!t.restrictOwnAudio)}return Rr(141)||Ho(141)||Ds(125)}let ln=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function rc(t,e,n){return{sampleRate:t,stereo:e,bitrate:n}}function Ft(t,e,n,i,r){return{width:t,height:e,frameRate:n,bitrateMin:i,bitrateMax:r}}function nr(t,e,n,i,r){return{width:{max:t},height:{max:e},frameRate:n,bitrateMin:i,bitrateMax:r}}function Ff(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}let R4={"90p":Ft(160,90),"90p_1":Ft(160,90),"120p":Ft(160,120,15,30,65),"120p_1":Ft(160,120,15,30,65),"120p_3":Ft(120,120,15,30,50),"120p_4":Ft(212,120),"180p":Ft(320,180,15,30,140),"180p_1":Ft(320,180,15,30,140),"180p_3":Ft(180,180,15,30,100),"180p_4":Ft(240,180,15,30,120),"240p":Ft(320,240,15,40,200),"240p_1":Ft(320,240,15,40,200),"240p_3":Ft(240,240,15,40,140),"240p_4":Ft(424,240,15,40,220),"360p":Ft(640,360,15,80,400),"360p_1":Ft(640,360,15,80,400),"360p_3":Ft(360,360,15,80,260),"360p_4":Ft(640,360,30,80,600),"360p_6":Ft(360,360,30,80,400),"360p_7":Ft(480,360,15,80,320),"360p_8":Ft(480,360,30,80,490),"360p_9":Ft(640,360,15,80,800),"360p_10":Ft(640,360,24,80,800),"360p_11":Ft(640,360,24,80,1e3),"480p":Ft(640,480,15,100,500),"480p_1":Ft(640,480,15,100,500),"480p_2":Ft(640,480,30,100,1e3),"480p_3":Ft(480,480,15,100,400),"480p_4":Ft(640,480,30,100,750),"480p_6":Ft(480,480,30,100,600),"480p_8":Ft(848,480,15,100,610),"480p_9":Ft(848,480,30,100,930),"480p_10":Ft(640,480,10,100,400),"720p":Ft(1280,720,15,120,1130),"720p_auto":Ft(1280,720,30,900,3e3),"720p_1":Ft(1280,720,15,120,1130),"720p_2":Ft(1280,720,30,120,2e3),"720p_3":Ft(1280,720,30,120,1710),"720p_5":Ft(960,720,15,120,910),"720p_6":Ft(960,720,30,120,1380),"1080p":Ft(1920,1080,15,120,2080),"1080p_1":Ft(1920,1080,15,120,2080),"1080p_2":Ft(1920,1080,30,120,3e3),"1080p_3":Ft(1920,1080,30,120,3150),"1080p_5":Ft(1920,1080,60,120,4780),"1440p":Ft(2560,1440,30,120,4850),"1440p_1":Ft(2560,1440,30,120,4850),"1440p_2":Ft(2560,1440,60,120,7350),"4k":Ft(3840,2160,30,120,8910),"4k_1":Ft(3840,2160,30,120,8910),"4k_3":Ft(3840,2160,60,120,13500)},C4={"480p":nr(640,480,5),"480p_1":nr(640,480,5),"480p_2":nr(640,480,30),"480p_3":nr(640,480,15),"720p":nr(1280,720,5),"720p_auto":Ft(1280,720,30,900,3e3),"720p_1":nr(1280,720,5),"720p_2":nr(1280,720,30),"720p_3":nr(1280,720,15),"1080p":nr(1920,1080,5),"1080p_1":nr(1920,1080,5),"1080p_2":nr(1920,1080,30),"1080p_3":nr(1920,1080,15)},v4={"1SL1TL":Ff(1,1),"3SL3TL":Ff(3,3),"2SL3TL":Ff(2,3)};function ir(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},R4[t]):t}function Bf(t){return typeof t=="string"?Object.assign({},C4[t]):t}function gh(t){return typeof t=="string"?Object.assign({},v4[t]):t}let y4={speech_low_quality:rc(16e3,!1),speech_standard:rc(32e3,!1,18),music_standard:rc(48e3,!1),standard_stereo:rc(48e3,!0,56),high_quality:rc(48e3,!1,128),high_quality_stereo:rc(48e3,!0,192)};function Sh(t){return typeof t=="string"?Object.assign({},y4[t]):t}let Bs=[];function Zb(t){return De(t,"mediaSource",["screen","window","application"]),!0}let et=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),Kt=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),oc=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),I4=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),A4=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),js=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),sc=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),Ui=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t.PLAY_START="play-start",t.PLAY_END="play-end",t.FIRST_FRAME_RENDER="first-frame-render",t}({}),ac=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),Si=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});let jf={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Gf={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},$b={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},b4={uplinkNetworkQuality:0,downlinkNetworkQuality:0},t0={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Un=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),Ti=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Bd=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),Gs=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),gn=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),qr=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({}),Wf={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},Th=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function Lt(t,e,n,i,r){var o,s,a={};return Object.keys(i).forEach(function(c){a[c]=i[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=Pi(o=OT(s=n.slice()).call(s)).call(o,function(c,d){return d(t,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(t,e,a),null):a}function P(t,e,n){return(e=function(i){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(i);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function e0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function le(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?e0(Object(n),!0).forEach(function(i){P(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e0(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class n0 extends ge{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(js.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),P(this,"trackMediaType",void 0),P(this,"_ID",void 0),P(this,"_rtpTransceiver",void 0),P(this,"_lowRtpTransceiver",void 0),P(this,"_hints",[]),P(this,"_isClosed",!1),P(this,"_originMediaStreamTrack",void 0),P(this,"mediaStreamTrack",void 0),P(this,"_external",{}),this._ID=n||qt(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(i){B(Bs).call(Bs,i)||Bs.push(i)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||Ko(()=>{var n;tt.reportApiInvoke(null,{name:me.GET_MEDIA_STREAM_TRACK,options:[],tag:re.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===oc.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){let n=Bs.indexOf(e);n!==-1&&Bs.splice(n,1)}(this),this.emit(sc.CLOSED),this.removeAllListeners(js.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===oc.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(js.TRANSCEIVER_UPDATED,e,n)}}class cc extends n0{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),P(this,"_enabled",!0),P(this,"_muted",!1),P(this,"_isExternalTrack",!1),P(this,"_isClosed",!1),P(this,"_enabledMutex",void 0),P(this,"processor",void 0),P(this,"_processorContext",void 0),P(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new tn("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return(e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(et.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await se(this,et.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(sc.TRACK_ENDED)}stateCheck(e,n){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),$i(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new L(C.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new L(C.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Y.resolve([])}}let i0=window.AudioContext||window.webkitAudioContext,Hf,Ri=null,te=new class extends ge{constructor(){super(...arguments),P(this,"prevState",void 0),P(this,"curState",void 0),P(this,"currentTime",void 0),P(this,"currentTimeStuckAt",void 0),P(this,"interruptDetectorTrack",void 0),P(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(ln.IOS_15_16_INTERRUPTION_START)}),P(this,"onLocalAudioTrackUnmute",async()=>{_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(Ri&&await Ri.suspend(),this.emit(ln.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function dc(){if(!Ri){if(function(){if(!i0)return void _.error("your browser is not support web audio");_.info("create audio context");let t=le({},T("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(t)),Ri=new i0(t),te.curState=Ri.state,Ri.onstatechange=()=>{te.prevState=te.curState,te.curState=Ri?Ri.state:void 0;let{prevState:e,curState:n}=te,i=n==="running",r=n==="interrupted",o=e==="running",s=e==="suspended",a=e==="interrupted",c=Vt().osVersion;(An()||Zi())&&o&&r&&(_.info("ios".concat(c,"-interruption-start")),te.emit(ln.IOS_INTERRUPTION_START)),(An()||Zi())&&(s||a)&&i&&(_.info("ios".concat(c,"-interruption-end")),te.emit(ln.IOS_INTERRUPTION_END)),e!==n&&te.emit(ln.STATE_CHANGE,n,e)},setInterval(()=>{var e;let n=(e=Ri)===null||e===void 0?void 0:e.currentTime;te.currentTime!==n?(te.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(n)),te.currentTimeStuckAt=void 0),te.currentTime=n):(n!==te.currentTimeStuckAt&&(tt.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:re.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(n))),te.currentTimeStuckAt=n)},5e3),async function(e){let n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],i,r,o=!1,s=!1,a=!1;function c(R){e.state==="running"?d(!1):An()||Zi()?e.state==="suspended"&&(d(!0),R&&e.resume().then(l,l)):e.state!=="closed"&&(d(!0),R&&e.resume().then(l,l))}function d(R){if(o!==R){o=R;for(let v=0,I=n;v<I.length;v+=1){let w=I[v];R?window.addEventListener(w,u,{capture:!0,passive:!0}):window.removeEventListener(w,u,{capture:!0,passive:!0})}}}function l(){c(!1)}function u(){c(!0)}function h(){let R;try{R=i.play(),R?R.then(E,E):(i.addEventListener("playing",E),i.addEventListener("abort",E),i.addEventListener("error",E))}catch{E()}}function p(R){a||(i.paused?R?(S(!1),a=!0,h()):S(!0):S(!1))}function S(R){if(s!==R){s=R;for(let v=0,I=n;v<I.length;v++){let w=I[v];R?window.addEventListener(w,f,{capture:!0,passive:!0}):window.removeEventListener(w,f,{capture:!0,passive:!0})}}}function E(){i.removeEventListener("playing",E),i.removeEventListener("abort",E),i.removeEventListener("error",E),a=!1,p(!1)}function f(){p(!0)}if(An()&&T("IOS_BG_TAG")){let R=e.createMediaStreamDestination(),v=document.createElement("div");v.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=v.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=R.stream,r=()=>{if(T("IOS_AUTO_RESTART_BG_TAG")&&i&&i.srcObject&&!a&&(!i.paused||s!==!0)){i.paused||i.pause();try{a=!0,h()}catch{a=!1}return!0}},p(!0)}return te.on(ln.STATE_CHANGE,function(){c(!0)}),c(!1),r}(Ri).then(e=>{Hf=e})}(),!Ri)throw new L(C.NOT_SUPPORTED,"can not create audio context");return Ri}return Ri}function Ws(t){if(function(){if(Kf!==null)return Kf;let i=dc(),r=i.createBufferSource(),o=i.createGain(),s=i.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),Kf=a,a}())return;let e=t.connect,n=t.disconnect;t.connect=(i,r,o)=>{var s;return t._inputNodes||(t._inputNodes=[]),B(s=t._inputNodes).call(s,i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,r,o)):e.call(t,i,r)),t},t.disconnect=(i,r,o)=>{n.call(t),i?ah(t._inputNodes,i):t._inputNodes=[];for(let s of t._inputNodes)e.call(t,s)}}let Kf=null;function Yf(t,e){let n=!1,i=1/e;if(T("DISABLE_WEBAUDIO")){let r=window.setInterval(()=>{n?window.clearInterval(r):t(performance.now()/1e3)},1e3*i)}else{let r=dc(),o=r.createGain();o.gain.value=0,o.connect(r.destination);let s=()=>{if(n)return void(o=null);let a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+i),t(r.currentTime)};s()}return()=>{n=!0}}class r0{constructor(){P(this,"context",void 0),P(this,"analyserNode",void 0),P(this,"sourceNode",void 0),this.context=dc(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||An()||Zi()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{let i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<e.length;++r)e[r]=i[r]/128-1}let n=Pi(e).call(e,(i,r)=>i+r*r,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class o0 extends ge{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),P(this,"outputNode",void 0),P(this,"outputTrack",void 0),P(this,"isPlayed",!1),P(this,"sourceNode",void 0),P(this,"context",void 0),P(this,"audioBufferNode",void 0),P(this,"destNode",void 0),P(this,"audioOutputLevel",0),P(this,"volumeLevelAnalyser",void 0),P(this,"_processedNode",void 0),P(this,"playNode",void 0),P(this,"isDestroyed",!1),P(this,"onNoAudioInput",void 0),P(this,"isNoAudioInput",!1),P(this,"_noAudioInputCount",0),this.context=dc(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Ws(this.outputNode),this.volumeLevelAnalyser=new r0}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(Si.ON_AUDIO_BUFFER,function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){let o=i.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0}return i.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!wt().webAudioMediaStreamDest)throw new L(C.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&ch(()=>{te.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;An()||Zi()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let n=this.volumeLevelAnalyser.getAnalyserNode(),i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let o=0;o<i.length;o++)i[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await Ye(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class qf extends o0{get isFreeze(){return!1}constructor(e,n,i){var r;if(super(),P(this,"sourceNode",void 0),P(this,"track",void 0),P(this,"clonedTrack",void 0),P(this,"audioElement",void 0),P(this,"isCurrentTrackCloned",!1),P(this,"isRemoteTrack",!1),P(this,"originVolumeLevelAnalyser",void 0),P(this,"rebuildWebAudio",async()=>{if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;let c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Ws(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Ws(this.outputNode),this.emit(Si.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),e.kind!=="audio")throw new L(C.UNEXPECTED_ERROR);this.track=e;let o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),Ws(this.sourceNode),i){let a=i.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));let c=this.context.createMediaStreamSource(new MediaStream([a]));Ws(c),this.originVolumeLevelAnalyser=new r0,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;let s=Vt();n&&s.os===Ke.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(te.on(ln.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;let n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),Ws(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Si.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),te.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){let n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),_.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));let i=this.context.createMediaStreamSource(new MediaStream([n]));Ws(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function s0(t,e,n){let i=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function w4(t,e){let n=await a0(t.mediaSource),{sourceId:i,audio:r}=await function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Y((a,c)=>{let d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");let h=document.createElement("div");h.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let p=document.createElement("div");p.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let S=document.createElement("button");S.innerHTML="cancel",S.setAttribute("style","width: 85px;"),S.onclick=()=>{document.body.removeChild(R);let v=new Error("NotAllowedError");v.name="NotAllowedError",c(v)};let E=s,f=document.createElement("div");if(s){let v=document.createElement("input");v.setAttribute("type","checkbox");let I=document.createElement("span");v.setAttribute("style","margin-right: 6px;"),I.innerText="Share audio",v.checked=E,v.onchange=()=>{E=v.checked},f.appendChild(v),f.appendChild(I)}p.appendChild(f),p.appendChild(S),l.appendChild(u),l.appendChild(h),l.appendChild(p);let R=document.createElement("div");R.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),R.appendChild(d),R.appendChild(l),document.body.appendChild(R),o.map(v=>{if(v.id){let I=document.createElement("div");I.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let w=v.thumbnail;try{let{width:O}=w.getSize();O>1920&&(w=w.resize({width:1920}))}catch(O){throw O&&O.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),O}I.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+w.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+v.name.replace(/[\u00A0-\u9999<>\&]/g,function(O){return"&#"+O.charCodeAt(0)+";"})+"</span>",I.onclick=()=>{document.body.removeChild(R),a({sourceId:v.id,audio:E})},h.appendChild(I)}})})}(n,e);return await s0(i,t,r)}async function a0(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);let n=fb();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new L(C.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{i=null}i&&i.then||(i=new Y((o,s)=>{n.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return await i}catch(o){throw new L(C.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}let zf=new tn("safari"),c0=!1,d0=!1;async function Ci(t,e){let n=0,i=null;for(;n<2;)try{i=await O4(t,e,n>0);break}catch(r){if(r instanceof L)throw _.error("[".concat(e,"] ").concat(r.toString())),r;let o=Rh(r.name||r.code||r,r.message);if(o.code===C.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await Ye(500);continue}throw _.error("[".concat(e,"] ").concat(o.toString())),o}if(!i)throw new L(C.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function O4(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new L(C.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));let i=wt(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(fb())t.screen.sourceId?lc(r,await s0(t.screen.sourceId,t.screen,!!t.screenAudio)):lc(r,await w4(t.screen,!!t.screenAudio));else if(go()&&t.screen.extensionId&&t.screen.mandatory){if(!i.getStreamFromExtension)throw new L(C.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));let h=await(s=t.screen.extensionId,a=e,new Y((p,S)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},E=>{if(!E||!E.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),E),void S(new L(C.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(E.streamId)})}catch(E){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),E.toString()),S(new L(C.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=h,lc(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(i.getDisplayMedia){var o;t.screen.mediaSource&&Zb(t.screen.mediaSource);let h={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:S,systemAudio:E,preferCurrentTab:f,windowAudio:R,monitorTypeSurfaces:v}=t.screen,I={selfBrowserSurface:p,surfaceSwitching:S,systemAudio:E,preferCurrentTab:f,windowAudio:R,monitorTypeSurfaces:v};!p&&delete I.selfBrowserSurface,!S&&delete I.surfaceSwitching,!E&&delete I.systemAudio,!f&&delete I.preferCurrentTab,!R&&delete I.windowAudio,!v&&delete I.monitorTypeSurfaces,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:h,audio:t.screenAudio,controls:I})),lc(r,await navigator.mediaDevices.getDisplayMedia(le({video:h,audio:t.screenAudio},I)))}else{if(!ue())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new L(C.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&Zb(t.screen.mediaSource);let h={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(h))),lc(r,await navigator.mediaDevices.getUserMedia(h))}}var s,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=T("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=Cf(c,d)}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Vt();let l,u=null;($e()||An()||sh())&&(u=await zf.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(h){throw u&&u(),h}return c.audio&&(c0=!0),c.video&&(d0=!0),lc(r,l),u&&u(),r}function Rh(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new L(C.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new L(C.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new L(C.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new L(C.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new L(C.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new L(C.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new L(C.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function lc(t,e){let n=t.getVideoTracks()[0],i=t.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(i&&t.removeTrack(i),t.addTrack(o)),r&&(n&&t.removeTrack(n),t.addTrack(r))}let vi=new class extends ge{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Gs.STATE_CHANGE,t),this._state=t)}constructor(){super(),P(this,"_state",Bd.IDLE),P(this,"isAccessMicrophonePermission",!1),P(this,"isAccessCameraPermission",!1),P(this,"lastAccessMicrophonePermission",!1),P(this,"lastAccessCameraPermission",!1),P(this,"checkdeviceMatched",!1),P(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(T("ENUMERATE_DEVICES_INTERVAL")||(Dd()||oh()===Ke.HARMONY_OS)&&Kr())&&this.updateDevicesInfo()},T("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>_.error(t.toString()))}async enumerateDevices(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new L(C.NOT_SUPPORTED,"enumerateDevices() not supported.");let i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i),o=!this.isAccessMicrophonePermission&&t,s=!this.isAccessCameraPermission&&e;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,d=null;if(!n&&(o||s)){if(zf.isLocked&&(_.debug("[device manager] wait GUM lock"),(await zf.lock())(),_.debug("[device manager] GUM unlock")),c0&&(o=!1,this.isAccessMicrophonePermission=!0),d0&&(s=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,o,s),o&&s){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){let u=Rh(l.name||l.code||l,l.message);if(u.code===C.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(l){let u=Rh(l.name||l.code||l,l.message);if(u.code===C.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(l){let u=Rh(l.name||l.code||l,l.message);if(u.code===C.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",t,"cam permission",e)}try{let l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,new L(C.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===t&&(e=n.device.deviceId)}),e}async getDeviceById(t){let e=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===t);if(!e)throw new L(C.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=Bd.INITING;try{await this.updateDevicesInfo(),this.state=Bd.INITEND}catch(t){throw this.state=Bd.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(_.warning("Device Detection functionality cannot start properly.",t.toString()),t):new L(C.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){let t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let r=t.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=t.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):_.debug("[device-check] default input or output not found")}let i=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;let o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){let s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),n.push(s)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",n.push(r))}),this.state!==Bd.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Gs.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Gs.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Gs.PLAYOUT_DEVICE_CHANGED,r)}}),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){let e=t.filter(r=>r.kind==="audioinput"),n=t.filter(r=>r.kind==="videoinput"),i={audio:!1,video:!1};for(let r of e)if(r.label&&r.deviceId){i.audio=!0;break}for(let r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}},Xf=!1,Hn=new class extends ge{constructor(){super(...arguments),P(this,"onAutoplayFailed",void 0),P(this,"onAudioAutoplayFailed",void 0)}};function l0(){if(Xf)return T("FLS_AUTOPLAY_EMITS")?(Hn.onAutoplayFailed&&Hn.onAutoplayFailed(),Hn.emit("autoplay-failed")):void 0;{let t=e=>{e.preventDefault(),Xf=!1,Pd()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Xf=!0,Pd()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Hn.onAutoplayFailed?Hn.onAutoplayFailed():Hn.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Hn.emit("autoplay-failed")}}function u0(t,e,n,i){if(!t)return;let r=tt.getBaseInfoBySessionId(t);if(!r)return;let o=r.info,s=Date.now(),a=le(le({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:Hn.onAutoplayFailed||Hn.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:i,extend:void 0});tt.send({type:Ee.AUTOPLAY_FAILED,data:a},!0)}let N4=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],wn=new class{constructor(){P(this,"onAutoplayFailed",void 0),P(this,"elementMap",new Map),P(this,"elementStateMap",new Map),P(this,"elementsNeedToResume",[]),P(this,"sinkIdMap",new Map),P(this,"autoResumeAfterInterruption",t=>Y.all(Array.from(this.elementMap.entries()).map(async e=>{let[n,i]=e,r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(_.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(t)),s==="live"){if(t)return i.pause(),i.play();if(te.curState==="running")return Ja()?(i.pause(),i.play()):r&&r==="paused"?i.play():void 0}}))),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t,i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),te.on(ln.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),te.on(ln.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),te.on(ln.STATE_CHANGE,()=>{An()&&te.prevState==="suspended"&&te.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(t,e){let n=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),n)try{await n.setSinkId(e)}catch(i){throw new L(C.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(t,e,n,i){if(this.elementMap.has(e))return;let r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,gn.INIT),this.setVolume(e,n);let o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString())}let s=r.play();s&&s.then&&s.catch(a=>{i&&u0(i,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),ch(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),l0()}))})}updateTrack(t,e){let n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){let n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}getVolume(t){let e=this.elementMap.get(t);return e?e.volume:0}stop(t){let e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;let n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){N4.forEach(n=>{e.addEventListener(n,i=>{let r=this.elementStateMap.get(t),o=i.type==="pause"?"paused":i.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(o)),i.type==="error"){let s=e?.error;s&&_.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){let t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{_.debug("Auto resume audio element success")}).catch(n=>{_.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new Y(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{Pd()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function Ie(){return function(t,e,n){let i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new L(C.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=i.apply(this,o);return a instanceof Y?new Y((c,d)=>{a.then(c).catch(d)}):a}),n}}class h0 extends ge{constructor(e){super(),P(this,"name","VideoProcessorDestination"),P(this,"ID","0"),P(this,"_source",void 0),P(this,"videoContext",void 0),P(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new L(C.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new L(C.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Un.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Un.ON_TRACK,void 0)}}class p0 extends ge{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"usageRegistry",[]),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"_chained",!1),this.trackId=e,this.direction=n}async getConstraints(){return await Ue(this,Ti.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),se(this,Ti.REQUEST_UPDATE_CONSTRAINTS,Array.from(si(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),se(this,Ti.REQUEST_UPDATE_CONSTRAINTS,Array.from(si(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){let e=[];for(let{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){_.error(new L(C.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){let n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:n}of this.usageRegistry)try{let i=n();i instanceof Y&&(i=await i),e.push(le(le({},i),{},{direction:this.direction}))}catch(i){_.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class _0 extends ge{constructor(e){super(),P(this,"name","AudioProcessorDestination"),P(this,"ID","0"),P(this,"inputTrack",void 0),P(this,"inputNode",void 0),P(this,"audioProcessorContext",void 0),P(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new L(C.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new L(C.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Un.ON_TRACK,void 0),this.emit(Un.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Un.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Un.ON_NODE,this.inputNode))}}class m0 extends ge{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,i){super(),P(this,"constraintsMap",new Map),P(this,"statsRegistry",[]),P(this,"audioContext",void 0),P(this,"trackId",void 0),P(this,"direction",void 0),P(this,"usageRegistry",[]),P(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=i}async getConstraints(){return Ue(this,Ti.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),se(this,Ti.REQUEST_UPDATE_CONSTRAINTS,Array.from(si(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),se(this,Ti.REQUEST_UPDATE_CONSTRAINTS,Array.from(si(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){let i=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){let e=[];for(let{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){_.error(new L(C.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){let n=this.usageRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){let e=[];if(!this.chained)return[];for(let{cb:n}of this.usageRegistry)try{let i=n();i instanceof Y&&(i=await i),e.push(le(le({},i),{},{direction:this.direction}))}catch(i){_.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class Jf extends ge{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),P(this,"context",void 0),P(this,"processSourceNode",void 0),P(this,"outputTrack",void 0),P(this,"processedNode",void 0),P(this,"clonedTrack",void 0),P(this,"outputNode",void 0),this.outputNode=new D4}setVolume(){}createOutputTrack(){throw new L(C.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class D4{disconnect(){}connect(){}}function E0(t){return new Y((e,n)=>{let i=!1,r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);let o=An()?"canplay":"playing";r.addEventListener(o,()=>{let s=r.videoWidth,a=r.videoHeight;!s&&ue()||(i=!0,r.srcObject=null,r.remove(),e([s,a]))}),r.srcObject=new MediaStream([t]),r.play().catch(Md),setTimeout(()=>{i||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function Ch(t){let e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});let n=ir(t.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!db()&&n.frameRate&&(e.frameRate=n.frameRate),eb()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),ue()&&(e.frameRate={ideal:30,max:30}),e}function f0(t){let e={};return db()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,go()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function g0(t){let e=f0(t);if(t.encoderConfig){let n=Sh(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),Dd()&&(e.sampleRate=void 0),e}let S0=t=>{let e=t._encoderConfig;if(!e)return;let{frameRate:n,width:i,height:r}=t.getMediaStreamTrackSettings(),{frameRate:o=n,width:s=i,height:a=r}=e;if(!o||!s||!a)return;s=$a(s),a=$a(a),o=$a(o);let{max:c,min:d}=function(p,S,E){let f=200*Math.pow(E/15,.6)*Math.pow(p*S/640/360,.75);return{min:Math.floor(f),max:Math.floor(4*f)}}(s,a,o),{bitrateMax:l,bitrateMin:u}=e||{};l||_.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));let{maxFramerate:h}=T("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(o=Math.min(o,h)),{frameRate:o,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},T0=async(t,e,n)=>await(async(i,r,o)=>{let s=function(d){let l=[];for(let u=0;u<d.length;u+=2)l.push(parseInt(d.slice(u,u+2),16));return Uint8Array.from(l)}(Ob(""+r+o)).slice(0,16),a=s.slice(0,12),c=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(t.buffer,e,n),Qf=t=>{let e=document.createElement("canvas");return e.width=2,e.height=2,new Y((n,i)=>{e.toBlob(async r=>{if(e.remove(),r){let o=await R0(r);n({buffer:o,width:e.width,height:e.height})}else i(new L(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,1)})},R0=async t=>{let e=await t.arrayBuffer();return new Uint8Array(e)};var C0,v0,y0,I0,A0,b0,w0,O0,N0,D0,P0,L0,k0,M0,U0,x0,V0,F0,Re,B0,j0,G0,W0,H0,K0,zr,Y0,q0,z0,X0,J0,Q0,Z0,$0,tw,ew,nw,iw,rw,mn;let Ae=(C0=at({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),v0=at({argsMap:(t,e)=>[t.getTrackId(),e]}),y0=Ie(),I0=tc("LocalAudioTrack","_enabledMutex"),A0=at({argsMap:(t,e)=>[t.getTrackId(),e]}),b0=Ie(),w0=tc("LocalAudioTrack","_enabledMutex"),O0=at({argsMap:(t,e)=>[t.getTrackId(),e]}),N0=Ie(),D0=Ie(),P0=Ie(),L0=at({argsMap:t=>[t.getTrackId()]}),k0=Ie(),M0=at({argsMap:t=>[t.getTrackId()]}),U0=Ie(),x0=at({argsMap:t=>[t.getTrackId()]}),V0=at({argsMap:(t,e)=>[t.getTrackId(),e.name]}),F0=at({argsMap:t=>[t.getTrackId()]}),Lt((Re=class extends cc{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?wn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,i){super(t,n),P(this,"trackMediaType",ac.AUDIO),P(this,"_encoderConfig",void 0),P(this,"_trackSource",void 0),P(this,"metadata",[]),P(this,"_enabled",!0),P(this,"_volume",100),P(this,"_useAudioElement",!0),P(this,"_bypassWebAudio",!1),P(this,"processor",void 0),P(this,"_processorContext",void 0),P(this,"_processorDestination",void 0),P(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!i,this._trackSource=new Jf,T("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),T("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),$e()&&!Ri?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){ie(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&wn.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,se(this,et.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!qb())throw new L(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");await wn.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await se(this,et.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(i){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await se(this,et.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await se(this,et.NEED_MUTE_TRACK,this):await se(this,et.NEED_UNMUTE_TRACK,this))}getStats(){return Ko(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),di(this,et.GET_STATS)||le({},jf)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Si.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Si.ON_AUDIO_BUFFER),this._source.on(Si.ON_AUDIO_BUFFER,n=>t(n))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),wn.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?wn.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&wn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await se(this,et.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return Y.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new L(C.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(Un.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await se(this,et.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await se(this,et.NEED_REPLACE_TRACK,this))}),t.on(Un.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(t){t.removeAllListeners(Un.ON_TRACK),t.removeAllListeners(Un.ON_NODE)}bindProcessorContextEvents(t){t.on(Ti.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(t){t.removeAllListeners(Ti.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Jf&&(this._trackSource=new qf(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let t=new m0(this._source.context,this.getTrackId(),"local"),e=new _0(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(Si.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(wn.stop(this.getTrackId()),this._source.play()),se(this,et.NEED_REPLACE_MIXING_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[C0],Object.getOwnPropertyDescriptor(Re.prototype,"setVolume"),Re.prototype),Lt(Re.prototype,"setPlaybackDevice",[v0,y0],Object.getOwnPropertyDescriptor(Re.prototype,"setPlaybackDevice"),Re.prototype),Lt(Re.prototype,"setEnabled",[I0,A0,b0],Object.getOwnPropertyDescriptor(Re.prototype,"setEnabled"),Re.prototype),Lt(Re.prototype,"setMuted",[w0,O0,N0],Object.getOwnPropertyDescriptor(Re.prototype,"setMuted"),Re.prototype),Lt(Re.prototype,"getStats",[D0],Object.getOwnPropertyDescriptor(Re.prototype,"getStats"),Re.prototype),Lt(Re.prototype,"setAudioFrameCallback",[P0],Object.getOwnPropertyDescriptor(Re.prototype,"setAudioFrameCallback"),Re.prototype),Lt(Re.prototype,"play",[L0,k0],Object.getOwnPropertyDescriptor(Re.prototype,"play"),Re.prototype),Lt(Re.prototype,"stop",[M0,U0],Object.getOwnPropertyDescriptor(Re.prototype,"stop"),Re.prototype),Lt(Re.prototype,"close",[x0],Object.getOwnPropertyDescriptor(Re.prototype,"close"),Re.prototype),Lt(Re.prototype,"pipe",[V0],Object.getOwnPropertyDescriptor(Re.prototype,"pipe"),Re.prototype),Lt(Re.prototype,"unpipe",[F0],Object.getOwnPropertyDescriptor(Re.prototype,"unpipe"),Re.prototype),Re),jd=(B0=at({argsMap:(t,e)=>[t.getTrackId(),e]}),j0=Ie(),G0=tc("MicrophoneAudioTrack","_enabledMutex"),W0=at({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),H0=Ie(),K0=at({argsMap:t=>[t.getTrackId()]}),Lt((zr=class extends Ae{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,i){super(t,e.encoderConfig?Sh(e.encoderConfig):{},i,T("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),P(this,"_config",void 0),P(this,"_deviceName","default"),P(this,"_constraints",void 0),P(this,"_originalConstraints",void 0),P(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(Ja()||_f())&&te.bindInterruptDetectorTrack(this)}async setDevice(t){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{let e=await vi.getDeviceById(t),n={};n.audio=le({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let i=null;try{i=await Ci(n,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await Ci({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{let e=await vi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}_.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,n){if(e)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),T("AUTO_RESET_AUDIO_ROUTE")&&(An()||Zi())){let s=navigator.audioSession;s&&(t||(s.type="playback"),s.type="auto")}if(!t){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await se(this,et.NEED_DISABLE_TRACK,this)}catch(s){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}let r=le({},this._constraints),o=vi.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);let s=await Ci({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await se(this,et.NEED_ENABLE_TRACK,this)}catch(s){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}_.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(Ja()||_f())&&te.unbindInterruptDetectorTrack(this),Bs.some(t=>function(e){return"__className__"in e&&e.__className__==="MicrophoneAudioTrack"}(t))||Hf&&Hf()&&(tt.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:re.TRACER}).onSuccess(),_.debug("restart background audio tag success"))}onTrackEnded(){if((An()||Zi())&&this._enabled&&!this._isClosed&&te.duringInterruption){let t=async()=>{te.off(ln.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};te.on(ln.IOS_INTERRUPTION_END,t)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(sc.TRACK_ENDED)}async renewMediaStreamTrack(t){let e=t||this._constraints,n=vi.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();let i=await Ci({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(Ti.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(Ti.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[B0,j0],Object.getOwnPropertyDescriptor(zr.prototype,"setDevice"),zr.prototype),Lt(zr.prototype,"setEnabled",[G0,W0,H0],Object.getOwnPropertyDescriptor(zr.prototype,"setEnabled"),zr.prototype),Lt(zr.prototype,"close",[K0],Object.getOwnPropertyDescriptor(zr.prototype,"close"),zr.prototype),zr),P4=(Y0=at({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),q0=Ie(),z0=at({argsMap:t=>[t.getTrackId()]}),X0=Ie(),J0=at({argsMap:t=>[t.getTrackId()]}),Q0=Ie(),Z0=at({argsMap:t=>[t.getTrackId()]}),$0=Ie(),tw=at({argsMap:t=>[t.getTrackId()]}),ew=Ie(),nw=at({argsMap:t=>[t.getTrackId()]}),iw=at({argsMap:t=>[t.getTrackId()]}),rw=Ie(),Lt((mn=class extends Ae{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,i){super(e.createOutputTrack(),n,i),P(this,"source",void 0),P(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(Si.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(sc.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){ie(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[Y0,q0],Object.getOwnPropertyDescriptor(mn.prototype,"startProcessAudioBuffer"),mn.prototype),Lt(mn.prototype,"pauseProcessAudioBuffer",[z0,X0],Object.getOwnPropertyDescriptor(mn.prototype,"pauseProcessAudioBuffer"),mn.prototype),Lt(mn.prototype,"seekAudioBuffer",[J0,Q0],Object.getOwnPropertyDescriptor(mn.prototype,"seekAudioBuffer"),mn.prototype),Lt(mn.prototype,"resumeProcessAudioBuffer",[Z0,$0],Object.getOwnPropertyDescriptor(mn.prototype,"resumeProcessAudioBuffer"),mn.prototype),Lt(mn.prototype,"stopProcessAudioBuffer",[tw,ew],Object.getOwnPropertyDescriptor(mn.prototype,"stopProcessAudioBuffer"),mn.prototype),Lt(mn.prototype,"close",[nw],Object.getOwnPropertyDescriptor(mn.prototype,"close"),mn.prototype),Lt(mn.prototype,"setAudioBufferPlaybackSpeed",[iw,rw],Object.getOwnPropertyDescriptor(mn.prototype,"setAudioBufferPlaybackSpeed"),mn.prototype),mn);class Be extends Ae{get __className__(){return"MixingAudioTrack"}get isActive(){for(let e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){let e=dc().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,qt(8,"track-mix-")),P(this,"trackList",void 0),P(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}ah(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){let e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof Be?n.emit(js.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)}))}}class L4 extends o0{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(Si.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),P(this,"audioBuffer",void 0),P(this,"sourceNode",void 0),P(this,"startPlayTime",0),P(this,"startPlayOffset",0),P(this,"pausePlayTime",0),P(this,"options",void 0),P(this,"currentLoopCount",0),P(this,"currentPlaybackSpeed",100),P(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let ow=new Map;function sw(t,e){if(t.length===0||e.length===0)return 1/0;let n=yf(t),i=yf(e);return Math.floor(i/n)}class Zf{get rendFrameRate(){let e=Math.max(1,sw(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/e)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:gn.DESTROYED}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(e){P(this,"trackId",void 0),P(this,"config",void 0),P(this,"onFirstVideoFrameDecoded",void 0),P(this,"onFirstVideoFrameRender",void 0),P(this,"onVideoBufferReady",void 0),P(this,"onVideoStateChanged",void 0),P(this,"freezeTimeCounterList",[]),P(this,"renderFreezeAccTime",0),P(this,"renderFreezeAccTime2",0),P(this,"isKeepLastFrame",!1),P(this,"isDestroyed",!1),P(this,"timeUpdatedCount",0),P(this,"freezeTime",0),P(this,"playbackTime",0),P(this,"lastTimeUpdatedTime",0),P(this,"autoplayFailed",!1),P(this,"videoTrack",void 0),P(this,"videoElement",void 0),P(this,"cacheVideoElement",void 0),P(this,"cancelRVFId",void 0),P(this,"internal",!1),P(this,"_render_interframe_delays",[]),P(this,"_render_interframe_delays_sizes",[]),P(this,"_videoState",qr.VideoStateStopped),P(this,"videoElementCheckInterval",void 0),P(this,"videoElementFreezeTimeout",void 0),P(this,"_videoElementStatus",gn.NONE),P(this,"_isInPage",!0),P(this,"isGettingVideoDimensions",!1),P(this,"startGetVideoDimensions",()=>{let n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),P(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&te.curState==="running"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat($A())),ab()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),P(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":n.type==="play"&&_.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=gn.PLAYING;break;case"loadeddata":if(this.videoState=qr.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=gn.CANPLAY;break;case"stalled":this.videoElementStatus=gn.STALLED;break;case"suspend":this.videoElementStatus=gn.SUSPEND;break;case"pause":this.videoElementStatus=gn.PAUSED,An()||Zi()||$e()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=gn.WAITING;break;case"abort":this.videoElementStatus=gn.ABORT;break;case"ended":this.videoElementStatus=gn.ENDED;break;case"emptied":this.videoElementStatus=gn.EMPTIED;break;case"error":{let i=this.videoElement.error;i&&(this.videoElementStatus=gn.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")")));break}case"timeupdate":{let i=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>T("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);let r=i-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,li.lastVisibleTime<li.lastHiddenTime||o<li.lastHiddenTime||o<li.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>T("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;let s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),P(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat($A())),ab()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),te.on(ln.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),te.on(ln.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){let n=this.videoElement.play();n&&n.catch&&n.catch(r=>{e&&u0(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r)});let i=Vt();if((i.name==="Safari"&&Number(i.version)===15||Ja())&&n&&n.then){let r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){let e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;let n=e.getContext("2d");if(!n)return _.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);let i=n.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;let r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new Y((o,s)=>{i.toBlob(async a=>{if(i.remove(),a){let c=await R0(a);o({buffer:c,width:i.width,height:i.height})}else s(new L(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,n<0?.1:n>1?1:n)})):await Qf(e)}destroy(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,te.off(ln.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),te.off(ln.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),e?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=qr.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=gn.INIT,!this.videoElementCheckInterval&&(aw.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{this._isInPage=function(o){return o!==document.body&&document.body.contains(o)}(this.videoElement)},1e3),T("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let o,s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,T("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===qr.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=qr.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,l)=>{if(this.videoElementStatus===gn.PLAYING){if(o){let p=l.presentationTime-o.presentationTime,S=l.presentedFrames-o.presentedFrames;this._render_interframe_delays_sizes.push(S),this._render_interframe_delays.push(p);let E=yf(this._render_interframe_delays_sizes),f=E-this._render_interframe_delays_sizes[0];if(E>30&&f>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===qr.VideoStateStarting&&(this.videoState=qr.VideoStateDecoding),this.videoState===qr.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,T("VIDEO_FREEZE_DURATION"))),p<T("VIDEO_FREEZE_DURATION")&&this.videoState===qr.VideoStateFrozen&&(this.videoState=qr.VideoStateDecoding),p>T("VIDEO_FREEZE_DURATION")&&li.lastVisibleTime>=li.lastHiddenTime&&o.timestamp>li.lastVisibleTime&&o.timestamp>li.lastHiddenTime){let R=Math.min(66,sw(this._render_interframe_delays_sizes,this._render_interframe_delays)),v=Math.max(0,p-(S-1)*R);this.renderFreezeAccTime2+=v>R?v:0,this.renderFreezeAccTime+=p}}o=le(le({},l),{},{timestamp:d})}else this.isSkipCalcRenderFreezeTime()&&(o=le(le({},l),{},{timestamp:d}));var u,h;T("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0?void 0:u.call(h,c))};this.cancelRVFId=(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0?void 0:e.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Dd()&&!T("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let i=Vt();this.config.noStyle||(i.name==="Safari"&&Number(i.version)===15||Ja()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ue()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ue()&&this.videoElement.load());let r=this.videoElement.play();r!==void 0&&r.catch(o=>{_.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){var e,n;aw.forEach(i=>{this.videoElement&&this.videoElement.removeEventListener(i,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((e=(n=this.videoElement).cancelVideoFrameCallback)===null||e===void 0||e.call(n,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=gn.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===gn.DESTROYED||this.internal}handleAutoPlayFailed(){let e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(i=>{_.error(i)}),this.autoplayFailed=!1,Pd()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Pd()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),l0()}}let aw=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class vh extends Zf{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(e),P(this,"container",void 0),P(this,"slot",void 0),this.slot=e.element,this.internal=n,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;let n=e.element;var i;!this.internal||this.slot?(n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()):(this.slot=n,n&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(i=this.slot)===null||i===void 0||i.appendChild(this.container)):this.createElements())}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await Qf(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var e;this.container.remove(),(e=this.slot)===null||e===void 0||e.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var e;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",T("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(e=this.slot)===null||e===void 0||e.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var cw,dw,lw,uw,hw,pw,_w,mw,Ew,fw,gw,Sw,Tw,Rw,Cw,vw,yw,Iw,Aw,bw,ww,Ow,Nw,Dw,Pw,Lw,kw,Mw,Ot,Uw,xw,Vw,Fw,Bw,jw,Gw,Ww,yi;let oe=(cw=at({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),dw=Ie(),lw=at({argsMap:t=>[t.getTrackId()]}),uw=tc("LocalVideoTrack","_enabledMutex"),hw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),pw=Ie(),_w=tc("LocalVideoTrack","_enabledMutex"),mw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),Ew=Ie(),fw=at({argsMap:(t,e)=>[t.getTrackId(),e,t._saveEncodeBitrateRatio]}),gw=Ie(),Sw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),Tw=Ie(),Rw=Ie(),Cw=at({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),vw=Ie(),yw=Ie(),Iw=Ie(),Aw=at({argsMap:t=>[t.getTrackId()]}),bw=Ie(),ww=Ie(),Ow=Ie(),Nw=Ie(),Dw=Ie(),Pw=at({argsMap:(t,e)=>[t.getTrackId(),e.name]}),Lw=at({argsMap:t=>[t.getTrackId()]}),kw=at({argsMap:t=>[t.getTrackId()]}),Mw=at({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),Ot=class SL extends cc{get videoHeight(){if($e()){let{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if($e()){let{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==gn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,i,r,o,s){if(super(e,o),P(this,"trackMediaType",ac.VIDEO),P(this,"_player",void 0),P(this,"isUseScaleResolutionDownBy",!1),P(this,"_videoVisibleTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"_encoderConfig",void 0),P(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),P(this,"_optimizationMode",void 0),P(this,"_saveEncodeBitrateRatio",1),P(this,"_videoHeight",void 0),P(this,"_videoWidth",void 0),P(this,"_forceBitrateLimit",void 0),P(this,"_enabled",!0),P(this,"_processorDestination",void 0),P(this,"_processorContext",void 0),$e()){let{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=i,this._optimizationMode=r,this._hints=s||[],n&&this._hints.indexOf(Kt.CUSTOM_TRACK)!==-1?this._encoderConfig=he(n):this._encoderConfig=n,this._hints.indexOf(Kt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(uf(jt.CHROME,115)&&oh().indexOf("Windows")!==-1){let a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&wt().supportWebRTCInsertableStream){let l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"}),h,p,S=Date.now(),E=()=>{f&&(clearInterval(f),f=void 0),h&&(h.close(),h=void 0),c.stop(),p=void 0,u.removeEventListener("ended",E)},f=window.setInterval(()=>{if(p&&h&&Date.now()-S>(d??1e3))try{u.readyState==="live"?p.enqueue(h.clone()):E()}catch{E()}},d??1e3),R=new TransformStream({transform:(v,I)=>{u.readyState==="live"?(p=I,S=Date.now(),h===void 0?(h=v,I.enqueue(v.clone())):(I.enqueue(h),h=v)):v.close()}});return u.addEventListener("ended",E),l.readable.pipeThrough(R).pipeTo(u.writable),u}}(e);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(Kt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new p0(this.getTrackId(),"local"),this._processorDestination=new h0(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let r=document.getElementById(e);r?e=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));let i=le(le(le({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new Zf(i):this._player=new vh(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let r=this.getVideoElementVisibleStatus();this.safeEmit(sc.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},T("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await se(this,et.NEED_DISABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await se(this,et.NEED_ENABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await se(this,et.NEED_MUTE_TRACK,this):await se(this,et.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*e),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*e),_.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(e)),this._saveEncodeBitrateRatio=1;try{await se(this,et.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=ir(e),T("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){let i=Ch({encoderConfig:e});($e()||An()||Zi())&&(i.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){let o=new L(C.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(Kt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await se(this,et.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(_)}}getStats(){return Ko(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),di(this,et.GET_STATS)||le({},Gf)}async setBeautyEffect(e){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await Qf(e)}async findClosestProfile(){let{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings(),{width:r,height:o,frameRate:s}=this._encoderConfig||{},a=$a(this._videoWidth||e||r||0),c=$a(this._videoHeight||n||o||0),d=function(l,u,h){if(!Array.isArray(T("VIDEO_ENCODER_CONFIG_LIST"))||T("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;let p=Math.min(l,u);return!(p>=480)&&le(le({},T("VIDEO_ENCODER_CONFIG_LIST").find(S=>S.height>p)),{},{frameRate:h})}(a,c,$a(i||s||15));if(d)return _.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(a,"x").concat(c," => ").concat(JSON.stringify(d))),this.setEncoderConfiguration(d)}async setBitrateLimit(e){_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void _.error(C.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let n=this._optimizationMode;try{this._optimizationMode=e,await se(this,et.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return _.error(C.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){E0(this._originMediaStreamTrack).then(e=>{let[n,i]=e;this._videoHeight=i,this._videoWidth=n}).catch(Md)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=ir(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Kt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await se(this,et.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!n||!i)return;let{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){let{max:s,min:a}=function(c,d,l,u,h){let p=T("BITRATE_ADAPTER_TYPE");if(p==="DEFAULT_BITRATE")return{min:u,max:h};if(h===void 0){let S=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));h=p==="STANDARD_BITRATE"?4*S:2*S,u=u??S}else u=u??Math.floor(h/10);return{min:u,max:h}}(e,n,i,o,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,T("VIDEO_STANDARD_BITRATE_VERSION")&&o==null&&r==null){let[c,d]=function(l,u,h){let p=4*Math.floor(2e5*Math.pow(h/15,.6)*Math.pow(l*u/230400,.75)),S=l*u,E=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),f=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]),R=si(E).call(E).next().value,v=1;if(E.has(S))R=E.get(S);else{var I;let J=Cs(I=Array.from(E.entries())).call(I,(dt,Ct)=>{let[St]=dt,[Gt]=Ct;return St-Gt}),ut=J.find(dt=>{let[Ct]=dt;return Ct>S});if(ut){let dt=J.indexOf(ut);if(dt>0){let Ct=J[dt-1],St=(S-Ct[0])/(ut[0]-Ct[0]);R=Ct[1]+St*(ut[1]-Ct[1])}else R=ut[1]}else R=J[J.length-1][1]}if(f.has(S))v=f.get(S);else{var w;let J=Cs(w=Array.from(f.entries())).call(w,(dt,Ct)=>{let[St]=dt,[Gt]=Ct;return St-Gt}),ut=J.find(dt=>{let[Ct]=dt;return Ct>S});if(ut){let dt=J.indexOf(ut);if(dt>0){let Ct=J[dt-1],St=(S-Ct[0])/(ut[0]-Ct[0]);v=Ct[1]+St*(ut[1]-Ct[1])}else v=ut[1]}else v=J[J.length-1][1]}let O=T("VIDEO_NEW_BITRATE_RATIO");O&&O>0&&(R=O/100);let A=Math.floor(p*R),N=Math.floor(65e4*Math.pow(l*u/230400,.5)*Math.pow(h/15,.69)),k=A,V=T("VIDEO_STANDARD_BITRATE_VERSION");return V&&V>0&&(V===1?k=p:V===2?k=A:V===3&&(k=N)),[Math.floor(k/1e3),v]}(e,n,i);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=d,_.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else _.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var e,n;let i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i?.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){let a=mb.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;let d=tt.reportApiInvoke(null,{tag:re.TRACER,name:me.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new L(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=le(le({},i),ir(e))),i=Ms(i);let r=qt(8,"track-video-cloned-"),o=new SL(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,Ms(this._scalabilityMode),this._optimizationMode,r,Ms(this._hints));return e&&i&&o.setEncoderConfiguration(i),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new L(C.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new L(C.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(e){if(Ko(()=>{tt.reportApiInvoke(null,{name:me.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:re.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!T("ENABLE_VIDEO_SEI")||!T("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new L(C.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let n=this.getRTCRtpTransceiver();if(!n)return void _.warning("Video track is not published, SEI can not be send");let i=n.sender.getParameters();if(i.codecs.length===0)return;let r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",e):_.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(Un.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await se(this,et.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await se(this,et.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Un.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ti.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ti.REQUEST_CONSTRAINTS)}},Lt(Ot.prototype,"play",[cw,dw],Object.getOwnPropertyDescriptor(Ot.prototype,"play"),Ot.prototype),Lt(Ot.prototype,"stop",[lw],Object.getOwnPropertyDescriptor(Ot.prototype,"stop"),Ot.prototype),Lt(Ot.prototype,"setEnabled",[uw,hw,pw],Object.getOwnPropertyDescriptor(Ot.prototype,"setEnabled"),Ot.prototype),Lt(Ot.prototype,"setMuted",[_w,mw,Ew],Object.getOwnPropertyDescriptor(Ot.prototype,"setMuted"),Ot.prototype),Lt(Ot.prototype,"setSaveEncodeBitrateRatio",[fw,gw],Object.getOwnPropertyDescriptor(Ot.prototype,"setSaveEncodeBitrateRatio"),Ot.prototype),Lt(Ot.prototype,"setEncoderConfiguration",[Sw,Tw],Object.getOwnPropertyDescriptor(Ot.prototype,"setEncoderConfiguration"),Ot.prototype),Lt(Ot.prototype,"getStats",[Rw],Object.getOwnPropertyDescriptor(Ot.prototype,"getStats"),Ot.prototype),Lt(Ot.prototype,"setBeautyEffect",[Cw,vw],Object.getOwnPropertyDescriptor(Ot.prototype,"setBeautyEffect"),Ot.prototype),Lt(Ot.prototype,"getCurrentFrameData",[yw],Object.getOwnPropertyDescriptor(Ot.prototype,"getCurrentFrameData"),Ot.prototype),Lt(Ot.prototype,"getCurrentFrameImage",[Iw],Object.getOwnPropertyDescriptor(Ot.prototype,"getCurrentFrameImage"),Ot.prototype),Lt(Ot.prototype,"findClosestProfile",[Aw,bw],Object.getOwnPropertyDescriptor(Ot.prototype,"findClosestProfile"),Ot.prototype),Lt(Ot.prototype,"setBitrateLimit",[ww],Object.getOwnPropertyDescriptor(Ot.prototype,"setBitrateLimit"),Ot.prototype),Lt(Ot.prototype,"setOptimizationMode",[Ow],Object.getOwnPropertyDescriptor(Ot.prototype,"setOptimizationMode"),Ot.prototype),Lt(Ot.prototype,"setScalabiltyMode",[Nw],Object.getOwnPropertyDescriptor(Ot.prototype,"setScalabiltyMode"),Ot.prototype),Lt(Ot.prototype,"updateMediaStreamTrackResolution",[Dw],Object.getOwnPropertyDescriptor(Ot.prototype,"updateMediaStreamTrackResolution"),Ot.prototype),Lt(Ot.prototype,"pipe",[Pw],Object.getOwnPropertyDescriptor(Ot.prototype,"pipe"),Ot.prototype),Lt(Ot.prototype,"unpipe",[Lw],Object.getOwnPropertyDescriptor(Ot.prototype,"unpipe"),Ot.prototype),Lt(Ot.prototype,"close",[kw],Object.getOwnPropertyDescriptor(Ot.prototype,"close"),Ot.prototype),Lt(Ot.prototype,"replaceTrack",[Mw],Object.getOwnPropertyDescriptor(Ot.prototype,"replaceTrack"),Ot.prototype),Ot),yh=(Uw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),xw=Ie(),Vw=tc("CameraVideoTrack","_enabledMutex"),Fw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),Bw=Ie(),jw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),Gw=Ie(),Ww=at({argsMap:t=>[t.getTrackId()]}),yi=class TL extends oe{get __className__(){return"CameraVideoTrack"}constructor(e,n,i,r,o,s){super(e,ir(n.encoderConfig),r,o,s),P(this,"_config",void 0),P(this,"_originalConstraints",void 0),P(this,"_constraints",void 0),P(this,"_enabled",!0),P(this,"_deviceName","default"),P(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(Ja()||_f())&&!function(){let a=Vt();if(a.os!==Ke.IOS||!a.osVersion)return!1;let c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&cb()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=ir(this._config.encoderConfig),te.on(ln.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),te.on(ln.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{let n=await vi.getDeviceById(e),i={};i.video=le({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await Ci(i,this.getTrackId())}catch(o){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await Ci({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{let n=await vi.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){_.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));let n={video:le(le({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await Ci(n,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await Ci({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=le({},n.video),_.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let i=await Ci({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await se(this,et.NEED_ENABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await se(this,et.NEED_DISABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=ir(e),T("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);let i=he(this._config);i.encoderConfig=e;let r=Ch(i);($e()||An()||Zi())&&(r.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){let s=new L(C.UNEXPECTED_ERROR,o.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(Kt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await se(this,et.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(_)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((An()||Zi())&&this._enabled&&!this._isClosed&&te.duringInterruption){let e=async()=>{te.off(ln.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};te.on(ln.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(sc.TRACK_ENDED)}async renewMediaStreamTrack(e){let n=e||this._constraints,i=vi.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){let r=await Ci({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),te.off(ln.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),te.off(ln.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=le(le({},i),ir(e))),i=Ms(i);let r=qt(8,"track-cam-cloned-"),o=new TL(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,Ms(le(le({},this._config),{},{encoderConfig:i})),Ms(this._constraints),Ms(this._scalabilityMode),this._optimizationMode,r);return e&&i&&o.setEncoderConfiguration(i),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(Ti.REQUEST_UPDATE_CONSTRAINTS,async(e,n,i)=>{try{let r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}),this.processorContext.on(Ti.REQUEST_CONSTRAINTS,async e=>{e(this._originMediaStreamTrack.getSettings())})}},Lt(yi.prototype,"setDevice",[Uw,xw],Object.getOwnPropertyDescriptor(yi.prototype,"setDevice"),yi.prototype),Lt(yi.prototype,"setEnabled",[Vw,Fw,Bw],Object.getOwnPropertyDescriptor(yi.prototype,"setEnabled"),yi.prototype),Lt(yi.prototype,"setEncoderConfiguration",[jw,Gw],Object.getOwnPropertyDescriptor(yi.prototype,"setEncoderConfiguration"),yi.prototype),Lt(yi.prototype,"close",[Ww],Object.getOwnPropertyDescriptor(yi.prototype,"close"),yi.prototype),yi);function Hw(t){let e=qt(8,"track-cus-"),n=tt.reportApiInvoke(null,{id:e,tag:re.TRACER,name:me.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),i=new Ae(t.mediaStreamTrack,t.encoderConfig?Sh(t.encoderConfig):{},e,!1);return _.info("create custom audio track success with config",t,"trackId",i.getTrackId()),n.onSuccess(i.getTrackId()),i}function $f(t,e,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=le(le({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?_.debug("[".concat(t,"] set content hint to"),n.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var Kw,Yw,qw,zw,xi,Xw,Jw,Qw,Zw,$w,tO,eO,En;class nO extends n0{getUserId(){return this._userId}constructor(e,n,i,r){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(qt(5,""))),P(this,"_userId",void 0),P(this,"_uintId",void 0),P(this,"_isDestroyed",!1),P(this,"store",void 0),P(this,"processor",void 0),P(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let uc=(Kw=at({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),Yw=at({argsMap:t=>[t.getTrackId()]}),qw=at({argsMap:(t,e)=>[t.getTrackId(),e.name]}),zw=at({argsMap:t=>[t.getTrackId()]}),Lt((xi=class extends nO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==gn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,i,r){super(t,e,n,i),P(this,"_videoVisibleTimer",null),P(this,"_previousVideoVisibleStatus",void 0),P(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),P(this,"trackMediaType",ac.VIDEO),P(this,"_videoWidth",void 0),P(this,"_videoHeight",void 0),P(this,"_player",void 0),P(this,"_prePlayer",void 0),P(this,"processorDestination",void 0),P(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new p0(this.getTrackId(),"remote"),this.processorDestination=new h0(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Ko(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),di(this,et.GET_STATS)||le({},t0)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Ui.PLAY_START),typeof t=="string"){let i=document.getElementById(t);i?t=i:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));let n=le(le({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});if(this._player)this._player.updateConfig(n);else{let i=!1,r=!1;t instanceof HTMLVideoElement?(this._player=new Zf(n),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,i=this._player.videoState>0,this._player.updateConfig(n)):this._player=new vh(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Ui.FIRST_FRAME_DECODED),r&&this.safeEmit(Ui.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=o=>{this.safeEmit(Ui.VIDEO_STATE_CHANGED,o)},i&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let i=this.getVideoElementVisibleStatus();this.safeEmit(Ui.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},T("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Ui.PLAY_END)}stop(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(t),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){E0(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Md)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;let n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),i={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n?.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){let s=mb.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;let c=tt.reportApiInvoke(null,{tag:re.TRACER,name:me.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new L(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Un.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Un.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(js.SEI_RECEIVED,t)}}).prototype,"play",[Kw],Object.getOwnPropertyDescriptor(xi.prototype,"play"),xi.prototype),Lt(xi.prototype,"stop",[Yw],Object.getOwnPropertyDescriptor(xi.prototype,"stop"),xi.prototype),Lt(xi.prototype,"pipe",[qw],Object.getOwnPropertyDescriptor(xi.prototype,"pipe"),xi.prototype),Lt(xi.prototype,"unpipe",[zw],Object.getOwnPropertyDescriptor(xi.prototype,"unpipe"),xi.prototype),xi),hc=(Xw=at({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),Jw=at({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),Qw=at({argsMap:(t,e)=>[t.getTrackId(),e]}),Zw=at({argsMap:t=>[t.getTrackId()]}),$w=at({argsMap:t=>[t.getTrackId()]}),tO=at({argsMap:(t,e)=>[t.getTrackId(),e.name]}),eO=at({argsMap:t=>[t.getTrackId()]}),Lt((En=class extends nO{get isPlaying(){return this._useAudioElement?wn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,i){super(t,e,n,i),P(this,"trackMediaType",ac.AUDIO),P(this,"_source",void 0),P(this,"_useAudioElement",!0),P(this,"_volume",100),P(this,"processorContext",void 0),P(this,"processorDestination",void 0),P(this,"_played",!1),P(this,"_bypassWebAudio",!1),T("DISABLE_WEBAUDIO")?(this._source=new Jf,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new qf(t,!0),T("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Si.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Ui.FIRST_FRAME_DECODED)}),this.processorContext=new m0(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new _0(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Si.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Si.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Si.ON_AUDIO_BUFFER),this._source.on(Si.ON_AUDIO_BUFFER,n=>t(n))}setVolume(t){this._volume=t,this._useAudioElement?wn.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}setAmplifiedVolume(t){this._useAudioElement&&this._played&&(wn.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,t=Math.min(t,T("MAX_WEBAUDIO_VOLUME")),this._volume=t,this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!qb())throw new L(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");await wn.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?wn.getVolume(this.getTrackId()):this._source instanceof qf?this._source.getAudioVolume():0}getStats(){return Ko(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),di(this,et.GET_STATS)||le({},$b)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),wn.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(_.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?wn.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&wn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Un.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Un.ON_NODE,t=>{this._source.processedNode=t;let e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Un.ON_TRACK),this.processorDestination.removeAllListeners(Un.ON_NODE)}}).prototype,"setVolume",[Xw],Object.getOwnPropertyDescriptor(En.prototype,"setVolume"),En.prototype),Lt(En.prototype,"setAmplifiedVolume",[Jw],Object.getOwnPropertyDescriptor(En.prototype,"setAmplifiedVolume"),En.prototype),Lt(En.prototype,"setPlaybackDevice",[Qw],Object.getOwnPropertyDescriptor(En.prototype,"setPlaybackDevice"),En.prototype),Lt(En.prototype,"play",[Zw],Object.getOwnPropertyDescriptor(En.prototype,"play"),En.prototype),Lt(En.prototype,"stop",[$w],Object.getOwnPropertyDescriptor(En.prototype,"stop"),En.prototype),Lt(En.prototype,"pipe",[tO],Object.getOwnPropertyDescriptor(En.prototype,"pipe"),En.prototype),Lt(En.prototype,"unpipe",[eO],Object.getOwnPropertyDescriptor(En.prototype,"unpipe"),En.prototype),En),li=new class extends ge{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),P(this,"_lastHiddenTime",0),P(this,"_lastVisibleTime",0),P(this,"needUploadStats",[]),P(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),_.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class iO extends ge{constructor(e,n){super(),P(this,"trackMediaType",ac.DATA),P(this,"_version",1),P(this,"_type",3),P(this,"_config",void 0),P(this,"_originDataChannel",void 0),P(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),P(this,"_dataStreamPacketHandler",{serialize:i=>i,deserialize:i=>i}),P(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return T("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Y((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();let i=setTimeout(()=>{var r;n(new L(C.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new L(C.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new L(C.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){let e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Th.OPEN,Th.CLOSE,Th.ERROR].forEach(n=>{let i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),e.addEventListener(n,i)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[i,r]=n;e.removeEventListener(i,r)}),this._datachannelEventMap.clear()}}class k4 extends iO{constructor(e){super(e),P(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(T("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(Th.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class M4 extends iO{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);let i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function Ih(){let t=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>yu.revokeObjectURL(t),0),new Worker(yu.createObjectURL(t))}let rO=71,tg=1,eg=2,ng=1,oO=2;var qo=function(t){return t[t.AUDIO_LEVEL=1]="AUDIO_LEVEL",t[t.METADATA=2]="METADATA",t[t.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",t}(qo||{});function ig(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=t.getUint8(0);if(n!==rO)return;let i=t.getUint16(1),r=tg+eg+i,o=new Uint8Array(t.byteLength-r);o.set(new Uint8Array(t.buffer,r,t.byteLength-r));let s={m:n,tlvLen:i,tlv:[],frame:o},a=tg+eg;for(;a<r;){let c=t.getUint8(a),d=t.getUint16(a+ng),l=ng+oO;if(c===qo.AUDIO_LEVEL){let u=t.getUint8(a+l);for(let h=1;h<d;h++)u=u<<8|t.getUint8(a+l+h);s.tlv.push({tag:c,length:d,value:e?127^u>>1:127&u})}else if(c===qo.METADATA||c===qo.AUDIO_64_BIT_PTS){let u=new Uint8Array(d);for(let h=0;h<d;h++)u[h]=t.getUint8(a+l+h);s.tlv.push({tag:c,length:d,value:u})}a+=l+d}return s}let Ah=new Map,bh=127,Hs=1e-10,rg=139/13,wh=new Map;function og(t,e,n){let i="".concat(t,"-").concat(e,"-").concat(n),r=0;return wh.has(i)?r=wh.get(i):(r=Math.log(function(s,a){let c=s-a;a<c&&(a=c);let d=1;for(let l=s,u=1;l>a;l--,u++)d=d*l/u;return d}(e,t))+t*Math.log(.5)+(e-t)*Math.log(1-.5)-Math.log(n)+n*t,wh.set(i,r)),r<Hs&&(r=Hs),r}function sO(t,e,n){let i=e.length,r=t.length/i,o=!1;for(let s=0,a=0;s<i;s++){let c=0;for(let d=a+r;a<d;a++)t[a]>n&&c++;e[s]!==c&&(e[s]=c,o=!0)}return o}window.cache=wh;let U4=0;class aO{constructor(e){P(this,"id",void 0),P(this,"immediates",[]),P(this,"lastNonSilence",-1),P(this,"immediateSpeechActivityScore",Hs),P(this,"lastLevelChangedTime",Date.now()),P(this,"levels",[]),P(this,"longs",[]),P(this,"longSpeechActivityScore",Hs),P(this,"mediums",[]),P(this,"mediumSpeechActivityScore",Hs),P(this,"minLevel",0),P(this,"nextMinLevel",0),P(this,"nextMinLevelWindowLength",0),P(this,"energyScore",0),this.id=e||"".concat(U4++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){let e=this.immediates,n=this.levels,i=this.minLevel+rg,r=!1;for(let o=0;o<e.length;++o){let s=n[o];s<i&&(s=0);let a=Math.floor(s/rg);e[o]!==a&&(e[o]=a,r=!0)}return r}computeLongs(){return sO(this.mediums,this.longs,4)}computeMediums(){return sO(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=og(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=og(this.longs[0],10,47),this.longSpeechActivityScore>Hs&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=og(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(OT(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let i=e;return e<0&&(i=0),e>bh&&(i=bh),this.levels.unshift(i),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(i),i>=this.minLevel+rg?i:i/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>bh&&(n=bh),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class x4{constructor(e){P(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{let n=this.algorithm.runInDecisionMaker(this);n<=0?e=!0:setTimeout(this.execute.bind(this),n)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class sg{constructor(e,n,i){P(this,"isDominant",void 0),P(this,"energyRanking",void 0),P(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=n,this.energyScore=i}}class V4 extends ge{constructor(e){super(),P(this,"dominantId",null),P(this,"lastDecisionTime",0),P(this,"lastLevelChangedTime",0),P(this,"lastLevelIdleTime",0),P(this,"relativeSpeechActivities",[]),P(this,"speakers",new Map),P(this,"enableSilence",!1),P(this,"timeoutToSilenceInterval",0),P(this,"decisionMaker",null),P(this,"loudest",[]),P(this,"numLoudestToTrack",3),P(this,"energyExpireTimeMs",250),P(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,n!=null&&(this.energyExpireTimeMs=n),i!=null&&(this.energyAlphaPct=i),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some(n=>n.id===e)}levelChanged(e,n){let i=Date.now(),r=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<i&&(this.lastLevelChangedTime=i,this.maybeStartDecisionMaker());let o=r.levelChanged(n,i);return this.updateLoudestList(r,o,i)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach(n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)})}removeSpeakers(e){e.forEach(n=>{this.speakers.delete(n.id)})}getOrCreateSpeaker(e){let n=this.speakers.get(e);return n||(n=new aO(e),this.speakers.set(e,n),this.maybeStartDecisionMaker()),n}updateLoudestList(e,n,i){let r=e.id===this.dominantId;if(n<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==e;)++c;return new sg(r,c,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new sg(r,0,e.energyScore);let o=i-this.energyExpireTimeMs,s=0;for(;s<this.loudest.length;){let c=this.loudest[s];if(c.getLastLevelChangedTime()<o&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(s,1);else if(c.id!==e.id)++s;else if(this.loudest.splice(s,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<e.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new sg(r,a,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new x4(this),this.decisionMaker.execute())}makeDecision(e){let n=null,i=null,r=this.speakers.size,o=null;if(r===0)o=null;else if(r===1){var s;let a=si(s=this.speakers).call(s).next().value;this.enableSilence&&a&&(o=a.id,a.evaluateSpeechActivityScores(e),e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){let l=this.speakers.entries().next();l.value&&(o=l.value[0],a=l.value[1])}else o=a.id;a?.evaluateSpeechActivityScores(e);let c=this.relativeSpeechActivities,d=2;for(let l of this.speakers.entries()){let[u,h]=l;if(h===a)continue;h.evaluateSpeechActivityScores(e);for(let f=0;f<c.length;++f){let R=a==null?Hs:a.getSpeechActivityScore(f);c[f]=Math.log(h.getSpeechActivityScore(f)/R)}let p=c[0],S=c[1],E=c[2];p>3&&S>2&&E>0&&S>d&&(d=S,o=u)}this.enableSilence&&a!=null&&o===a.id&&e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null)}o==null&&!this.enableSilence||o===this.dominantId||(n=this.dominantId,this.dominantId=o,i=this.dominantId),i==null&&!this.enableSilence||i===n||this.emit("ActiveSpeakerChanged",i)}_runInDecisionMaker(){let e=Date.now(),n=300-(e-this.lastLevelIdleTime),i=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):i=n;let r=300-(e-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=e,this.makeDecision(e),r=300-(Date.now()-e)),r>0&&i>r&&(i=r),i}timeoutIdleLevels(e){let n=[];for(let r of si(i=this.speakers).call(i)){var i;let o=e-r.getLastLevelChangedTime();36e5<o&&(this.dominantId==null||r.id!==this.dominantId)?n.push(r.id):300<o&&r.levelTimedOut()}n.forEach(r=>this.speakers.delete(r))}}let pc=new Map,vr=null,Oh=null,cO=3,Ks=[],yr=new Map,Nh=new Map;class F4{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,n){P(this,"id",void 0),P(this,"track",void 0),P(this,"score",0),P(this,"active",!0),P(this,"muted",!1),P(this,"timer",0),P(this,"actives",0),P(this,"inactives",0),this.id=e,this.track=n,this.setActive(yr.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){let e=this.active;this.active=this.activeRate>=.8;let{actives:n,inactives:i}=function(){let r=[],o=[];return Array.from(si(yr).call(yr)).forEach(s=>{s.active?r.push(s):o.push(s)}),{actives:r,inactives:o}}();if(n.length>3){let r;n.forEach(o=>{(!r||r.score>o.score)&&(r=o)}),r&&r.setActive(!1)}if(n.length<3&&i.length>0){let r;i.forEach(o=>{(!r||r.score<o.score)&&o.id!==this.id&&(r=o)}),r&&e&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){let e=function(n){let i;return Array.from(si(yr).call(yr)).forEach(r=>{!r.active||r.id===n||r.samples<40||(!i||r.score<i.score)&&(i=r)}),i}(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){let e=function(n){let i;return Array.from(si(yr).call(yr)).forEach(r=>{r.active||r.id===n||r.samples<40||(!i||r.score>i.score)&&(i=r)}),i}(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let Dh;function dO(t){let e=yr.get(t);e&&(yr.delete(t),e.clearTimer())}let Ph=new Map,B4=new Map,ag="video/h264",cg="video/h265";function lO(t,e,n){let i=new Uint8Array(t,e,n),r=[],o=0;for(;r.length<n;)o+3<n&&i[o]===0&&i[o+1]===0&&i[o+2]===3&&(i[o+3]===0||i[o+3]===1||i[o+3]===2||i[o+3]===3)?(r.push(i[o],i[o+1],i[o+3]),o+=4):(r.push(i[o]),o++);return new Uint8Array(r)}function uO(t){let e=t.length,n=[],i=0;for(;i<e;)i+2<e&&t[i]===0&&t[i+1]===0&&(t[i+2]===0||t[i+2]===1||t[i+2]===2||t[i+2]===3)?(n.push(t[i],t[i+1],3,t[i+2]),i+=3):(n.push(t[i]),i++);return new Uint8Array(n)}function hO(t){if(t.length<5)return"";let e=-1;for(let r=0;r<t.length-3;r++){if(t[r]===0&&t[r+1]===0&&t[r+2]===1){e=r;break}if(r<t.length-4&&t[r]===0&&t[r+1]===0&&t[r+2]===0&&t[r+3]===1){e=r;break}}if(e===-1)return"";let n=e+(t[e+2]===0?4:3);if(n>=t.length)return"";let i=t[n];return 128&i?"":(i>>1&63)>=32||n+1<t.length&&!(248&t[n+1])?cg:(31&i)<=31?ag:""}let Lh=new Map,Gd=new Map;(function(){let t=Vt();qe.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),qe.getStreamFromExtension=t.name===jt.CHROME&&Number(t.version)>34,qe.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let e=new RTCPeerConnection,n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n}(),qe.supportMinBitrate=t.name===jt.CHROME||t.name===jt.EDGE,qe.supportSetRtpSenderParameters=function(){let e=Vt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Kr()||!(!$e()&&!sh())||e.name===jt.FIREFOX&&Number(e.version)>=64)}(),t.name===jt.SAFARI&&(Number(t.version)>=14?qe.supportDualStream=!0:qe.supportDualStream=!1),qe.webAudioMediaStreamDest=function(){let e=Vt();return!(e.name===jt.SAFARI&&Number(e.version)<12)}(),qe.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",qe.supportWebGL=typeof WebGLRenderingContext<"u",qe.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Kr()||(qe.webAudioWithAEC=!0),qe.supportShareAudio=function(){let e=Vt();return(e.os===Ke.WIN_10||e.os===Ke.WIN_81||e.os===Ke.WIN_7||e.os===Ke.LINUX||e.os===Ke.MAC_OS||e.os===Ke.CHROMIUM_OS)&&e.name===jt.CHROME&&Number(e.version)>=74}(),qe.supportDataChannel=!!(Rr(76)||hf(68)||ib(14)),qe.supportPCSetConfiguration=function(){let e=window.RTCPeerConnection;return!ue()&&!!e&&e.prototype.setConfiguration instanceof Function}(),qe.supportWebRTCEncodedTransform=Rr(87)||tb()||hf(117),qe.supportWebRTCInsertableStream=function(){let e=Vt();return(e.name===jt.CHROME||e.name===jt.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),qe.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,qe.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,qe.supportSuppressLocalAudioPlayback=Jb(),qe.supportRestrictOwnAudio=Qb(),ch(()=>{qe.supportDualStreamEncoding=function(){let e=Vt();return!!T("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&T("CHROME_DUAL_STREAM_USE_ENCODING"))}(),_.debug("browser ua: ",navigator.userAgent),_.info("browser info: ",t),_.info("browser compatibility: ",qe)})})();let j4=["CHINA","GLOBAL"],pO=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Ys=[],_c=[];function qs(t,e){return!!e&&Ys.some(n=>n.uid===t&&n.channelName===e)}function dg(){return _c.length>0}var G4=RI.forEach,_O=Ul("forEach")?[].forEach:function(t){return G4(this,t,arguments.length>1?arguments[1]:void 0)};Yt({target:"Array",proto:!0,forced:[].forEach!==_O},{forEach:_O});var W4=Di("Array","forEach"),H4=ko,K4=yn,Y4=At,q4=W4,lg=Array.prototype,z4={DOMTokenList:!0,NodeList:!0},X4=function(t){var e=t.forEach;return t===lg||Y4(lg,t)&&e===lg.forEach||K4(z4,H4(t))?q4:e},J4=H(X4),Q4=pr,mO=Gl;Yt({target:"Object",stat:!0,forced:z(function(){mO(1)})},{keys:function(t){return mO(Q4(t))}});var Z4=H(pi.Object.keys),$4=H(AT),tH=H(wT),eH=Yt,EO=td,nH=nu,iH=Dn,fO=S_,rH=Lo,oH=Do,sH=Fm,aH=Me,cH=Uo,dH=uI("slice"),lH=aH("species"),ug=Array,uH=Math.max;eH({target:"Array",proto:!0,forced:!dH},{slice:function(t,e){var n,i,r,o=oH(this),s=rH(o),a=fO(t,s),c=fO(e===void 0?s:e,s);if(EO(o)&&(n=o.constructor,(nH(n)&&(n===ug||EO(n.prototype))||iH(n)&&(n=n[lH])===null)&&(n=void 0),n===ug||n===void 0))return cH(o,a,c);for(i=new(n===void 0?ug:n)(uH(c-a,0)),r=0;a<c;a++,r++)a in o&&sH(i,r,o[a]);return i.length=r,i}});var hH=Di("Array","slice"),pH=At,_H=hH,hg=Array.prototype,mH=function(t){var e=t.slice;return t===hg||pH(hg,t)&&e===hg.slice?_H:e},EH=H(mH);function q(t,e,n,i,r){var o,s,a,c={};return J4(o=Z4(i)).call(o,function(d){c[d]=i[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=$4(s=tH(a=EH(n).call(n)).call(a)).call(s,function(d,l){return l(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(aI(t,e,c),null):c}let kh=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),pg=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),Vi=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t[t.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",t}({}),xn=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),st=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),Pt=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),nt=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t.VOS_FALLBACK="vos_fallback",t.VOS_FALLBACK_PROMISE="vos_fallback_promise",t}({}),it=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SET_DUAL_STREAM_MODE="set_dual_stream_mode",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.CONFIGURE="configure",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t.DOWNGRADE_CODEC="downgrade_codec",t}({}),zs=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),pt=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t.ENABLE_MULTI_STREAM="enable_multi_stream",t}({}),Vn=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),Tt=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t.ON_FALLBACK="websocket:on_fallback",t}({});function Mh(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new D(C.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Uh(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||hb(t,1,255)))throw new D(C.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Xr=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({}),fH={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},_g={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function mg(t,e){dn(t.url,"".concat(e,".url"),1,1e3,!1),Ce(t.x)||ie(t.x,"".concat(e,".x"),0,1e4),Ce(t.y)||ie(t.y,"".concat(e,".y"),0,1e4),Ce(t.width)||ie(t.width,"".concat(e,".width"),0,1e4),Ce(t.height)||ie(t.height,"".concat(e,".height"),0,1e4),Ce(t.zOrder)||ie(t.zOrder,"".concat(e,".zOrder"),0,255),Ce(t.alpha)||ie(t.alpha,"".concat(e,".alpha"),0,1,!1)}let gH={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},zo=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),Eg=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),je=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function gO(t){if(!t.channelName)throw new D(C.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new D(C.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&dn(t.token,"info.token",1,2047),Uh(t.uid),Mh(t.channelName),!0}let Kn=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),Ro=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),$n=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),mc=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),Xt=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),we=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t.UPDATE_GATEWAY_CONFIG="update-gateway-config",t.VOS_FALLBACK="vos-fallback",t.VOS_FALLBACK_PROMISE="vos-fallback-promise",t.RESET_SIGNAL="reset-signal",t.DATACHANNEL_FAILBACK="datachannel-failback",t}({}),xh=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),ze=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),Wt=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({}),SO=[Wt.AFRICA,Wt.ASIA,Wt.CHINA,Wt.EUROPE,Wt.GLOBAL,Wt.INDIA,Wt.JAPAN,Wt.NORTH_AMERICA,Wt.OCEANIA,Wt.OVERSEA,Wt.SOUTH_AMERICA],Sn=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({}),Vh={CHINA:{},ASIA:{CODE:Sn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Sn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Sn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Sn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Sn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Sn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Sn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Sn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Sn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Sn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Sn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Sn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Sn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Pf&&(Vh.CHINA={CODE:Sn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Ir=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",t.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",t.FALLBACK_TO_HLS="fallback_to_hls",t.UPDATE_VOS_CONFIGURE="update_vos_configure",t}({});function TO(t){return!!t&&!(!t.uplink||!t.id)&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0}class RO extends ge{constructor(e,n){super(),g(this,"onICEConnectionStateChange",void 0),g(this,"onConnectionStateChange",void 0),g(this,"onDTLSTransportStateChange",void 0),g(this,"onDTLSTransportError",void 0),g(this,"onICETransportStateChange",void 0),g(this,"onFirstAudioReceived",void 0),g(this,"onFirstVideoReceived",void 0),g(this,"onFirstAudioDecoded",void 0),g(this,"onFirstVideoDecoded",void 0),g(this,"onFirstVideoRender",void 0),g(this,"onFirstVideoBufferReady",void 0),g(this,"onFirstVideoDecodedTimeout",void 0),g(this,"onSelectedLocalCandidateChanged",void 0),g(this,"onSelectedRemoteCandidateChanged",void 0),g(this,"onICECandidateError",void 0),g(this,"getLocalVideoStats",void 0)}}class Fh extends RO{constructor(e,n){super(e,n),g(this,"establishPromise",void 0)}}let Z=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),en=function(t){return t.UDP_RELAY="udp_relay",t.UDP_TCP_RELAY="udp_tcp_relay",t.TCP_RELAY="tcp_relay",t.RELAY="relay",t}({}),Co=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.TCP_RESTART=3]="TCP_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),CO=["disconnected","failed"],j=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),Ht=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),rt=function(t){return t.AudioMetadata="audioMetadata",t.AudioPts="audioPts",t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t.FirstVideoPreRender="FirstVideoPreRender",t.FirstVideoBufferReady="FirstVideoBufferReady",t}({}),rr=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),or=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),nn=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Xo=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),Ge=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),Jr=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),Fi=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Ar=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Ec=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),Oe=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),fc=function(t){return t.ABORT="abort",t}({}),Jo=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),SH=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({}),TH={[kh.ACCESS_POINT]:{[xn.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[xn.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[xn.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[xn.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[xn.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[xn.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[xn.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[kh.UNILBS]:{[Vi.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Vi.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Vi.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Vi.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Vi.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Vi.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Vi.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Vi.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Vi.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Vi.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Vi.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Vi.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[Vi.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[kh.STRING_UID_ALLOCATOR]:{[pg.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[pg.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[pg.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function gc(t){let e=TH[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};let n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===kh.ACCESS_POINT){let i=t%1e4;if(i.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}let RH={[st.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[st.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[st.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[st.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[st.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[st.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[st.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[st.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[st.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[st.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[st.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[st.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[st.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[st.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[st.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[st.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[st.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[st.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[st.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[st.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[st.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[st.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[st.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[st.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[st.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[st.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[st.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[st.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[st.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[st.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[st.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[st.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[st.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[st.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[st.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[st.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[st.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[st.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[st.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[st.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[st.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[st.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[st.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[st.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[st.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[st.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[st.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[st.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[st.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[st.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[st.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[st.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[st.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[st.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[st.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[st.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[st.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[st.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[st.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[st.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[st.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[st.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[st.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[st.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[st.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Xs(t){return RH[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function vO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function fg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vO(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function gg(t,e){if(typeof t=="string")return t;let{proxy:n,host:i,port:r}=t;if(e){let o=T("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}let CH=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,vH=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,yH=/wss:\/\/(.+):([0-9]+)\/?/,IH=/wss:\/\/(.[^\/]+)\/?/,AH=0;class bH{constructor(e,n){g(this,"id",0),g(this,"store",void 0),g(this,"recordIndex",void 0),g(this,"websockets",[]),g(this,"try443PortDuration",2e3),g(this,"forceCloseWSDuration",5e3),g(this,"try443PortTimeout",null),g(this,"forceCloseTimeout",null),g(this,"isTry443PortFailed",!1),g(this,"isNormalPortFailed",!1),g(this,"useDoubleDomain",!1),g(this,"useProxy",!1),g(this,"startTime",Date.now()),this.id=++AH,this.try443PortDuration=T("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;let n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];_.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(e,n,i){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:i});let r=T("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(h=>{var p;return B(p=e.host).call(p,h)});a||(this.useDoubleDomain=!1);let c=[];if(this.useDoubleDomain)r.forEach(h=>{c.push(gg(fg(fg({},e),{},{host:e.host.replace(a,h)}),n))});else{let h=fg({},e);if(n&&a){let p=r.find(S=>S!==a);p&&(h.host=h.host.replace(a,p))}c.push(gg(h,n))}try{c.forEach(h=>{let p=new WebSocket(h);p.binaryType="arraybuffer",s.push(p),this.logger("ws is connecting:",p.url)})}catch(h){if(this.logger("ws create failed"),s.forEach(p=>p.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,i);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,i);throw new D(C.WS_ERR,"init websocket failed! Error: ".concat(h.toString()))}let d=Nd();this.store&&this.store.recordJoinChannelService({urls:s.map(h=>h.url),service:"gateway"},this.recordIndex),s.forEach(h=>{h.onopen=()=>{this.logger("onopen: ws ".concat(h.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(p=>{p!==h&&(p.onopen=null,p.onclose=null,p.onmessage=null,p.close(),this.logger("close backup websocket: ".concat(p.url)))}),this.websockets.length=0,d.resolve(h)},h.onclose=p=>{this.logger("onclose: ws ".concat(h.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(h.readyState));let S=s.every(E=>E.readyState===WebSocket.CLOSED||E.readyState===WebSocket.CLOSING);this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(S)),S&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(p.reason)),d.reject({code:p.code,reason:xh.A_ROUND_WS_FAILED})):!n&&S&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),u()),n?this.isTry443PortFailed=S:this.isNormalPortFailed=S},h.onmessage=p=>this.logger("".concat(h.url," onmessage: ").concat(p.data))}),this.websockets.push(...s);let l=()=>{this.websockets.forEach(h=>h.readyState!==WebSocket.OPEN&&h.close())},u=()=>{if(d.isResolved)return l();Vt().os===Ke.MAC_OS&&ue()&&l(),this.createWebSocket(e,!0,!0).then(h=>{d.resolve(h)}).catch(h=>{this.isNormalPortFailed&&d.reject(h),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()},this.forceCloseWSDuration)};return i||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,l()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,u()},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,n,i,r){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=function(o){let s,a,c;return[,s,a,c]=o.match(CH)||[],s||([,a,c]=o.match(vH)||[]),a&&c||([,a,c]=o.match(yH)||[]),a&&c||([,a]=o.match(IH)||[]),a||_.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,i&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally(()=>this.clearTimeout())}}function yO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class IO extends ge{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;B(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Tt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Tt.CONNECTED):this._state==="closed"?this.emit(Tt.CLOSED):this._state==="failed"&&this.emit(Tt.FAILED))}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),g(this,"_websocketUrl",null),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"urls",[]),g(this,"_reconnectMode","tryNext"),g(this,"reconnectReason",void 0),g(this,"_initMutex",void 0),g(this,"name",void 0),g(this,"_state","closed"),g(this,"reconnectInterrupter",void 0),g(this,"websocket",void 0),g(this,"retryConfig",void 0),g(this,"reconnectCount",0),g(this,"forceCloseTimeout",5e3),g(this,"onlineReconnectListener",void 0),g(this,"useCompress",void 0),g(this,"tryDoubleDomain",!1),g(this,"use443PortOnly",!1),g(this,"wsInflateLength",0),g(this,"wsDeflateLength",0),g(this,"closeEstablishingWs",()=>{}),g(this,"store",void 0),g(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(u){for(var h=1;h<arguments.length;h++){var p=arguments[h]!=null?arguments[h]:{};h%2?yO(Object(p),!0).forEach(function(S){g(u,S,p[S])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(p)):yO(Object(p)).forEach(function(S){Object.defineProperty(u,S,Object.getOwnPropertyDescriptor(p,S))})}return u}({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=o,this._initMutex=new tn("websocket",s?s.clientId:void 0);let{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);kn.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),ve.on(Ls.NETWORK_STATE_CHANGE,(u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===kn.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{var r;let o=Nd(),s=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),function(a){return!(fh()||T("USE_NEW_TOKEN")||!T("ENABLE_PREALLOC_PC")&&(a==null||!a.autoSubscribe||T("FORCE_DISABLE_AUTO_SUB")))}(this.store)&&this.emit(Ge.PRE_CONNECT_PC),this.createWebSocketConnection(s).then(o.resolve).catch(o.reject),this.once(Tt.CLOSED,()=>{o.reject(new L(C.WS_DISCONNECT))}),this.once(Tt.CONNECTED,o.resolve),await o.promise}catch{}finally{i()}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let i=this.websocket;n?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0,this._websocketUrl=null}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);let i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new L(C.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(i){throw new L(C.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){let e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var n;let i=Nd();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},o=async l=>{var u;if(_.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new L(C.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let h=di(this,Tt.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return i.reject(new L(C.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve()}},s=l=>{this.emit(Tt.ON_MESSAGE,l)},a=l=>{_.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),T("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=T("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url:"),e);let c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=gg(e);let l=await this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){let u=this.state==="closed",h=l instanceof L,p=h&&l.code===C.WS_ABORT,S=h&&l.code===C.WS_ERR,E=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(E)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||S?(i.reject(u?new L(C.WS_DISCONNECT,"websocket is closed: ".concat(E)):new L(C.WS_ERR,"init websocket failed: ".concat(E))),S&&_.error("[".concat(this.name,"] init websocket failed: ").concat(E))):o&&o(l)}return i.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;_.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||ve.isOnline||!ve.onlineWaiter||(this.onlineReconnectListener=ve.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){let s=dh(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(e)),await Y.race([Ye(s),this.onlineReconnectListener||new Y(()=>{})])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;let r=async(s,a)=>{this.emit(Tt.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s)};try{if(e==="retry")await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],e)}else e==="recover"&&(_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await Ue(this,Tt.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e))}catch(s){var o;_.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));let a=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;if(Array.isArray(a)){if(B(a).call(a,"dynamic key expired"))return this.emit(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(B(a).call(a,"request downgrade fallback"))return this.emit(Tt.ON_FALLBACK),!1}return this.reconnectWithAction(e,n)}return!0}}class Sg extends IO{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){let i=Nd(),r=function(s,a){return new bH(s,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new L(C.WS_ABORT,"choose best websocket aborted"))};let o=T("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Wd extends IO{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){return new Y((i,r)=>{let o=!1,s=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),s.forEach(S=>{S.onclose=null,S.onopen=null,S.onmessage=null,S.close()}),r(new L(C.WS_ABORT,"choose best websocket aborted"))};let a=T("GATEWAY_DOMAINS"),c,d=e.indexOf("?h="),l=a.find(S=>d!==-1?B(e).call(e,S,d):B(e).call(e,S));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;let S=Date.now();try{a.forEach(E=>{let f=d===-1?e.replace(l,E):e.substr(0,d)+e.substr(d).replace(l,E),R=new WebSocket(f);R.binaryType="arraybuffer",s.push(R),_.debug("[choose-best-ws] ws is connecting:",R.url)})}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(f=>f.close());s.length;)s.pop();u=!0}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:s.map(E=>E.url),service:"gateway"},n),s.forEach(E=>{E.onopen=()=>{if(o)return;let f=Date.now()-S;_.debug("[choose-best-ws] ws open cost ".concat(f,"ms")),s.filter(R=>R!==E).forEach(R=>{_.debug("[choose-best-ws]close backup websocket: ".concat(R.url)),R.close()}),o=!0,i(E)},E.onclose=f=>{c=f,!o&&(s.find(R=>!(R.readyState===WebSocket.CLOSED||R.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)))},E.onmessage=f=>{_.debug("[choose-best-ws]".concat(E.url," onmessage: ").concat(f.data))}}),Ye(this.forceCloseTimeout).then(()=>{s.forEach(E=>{E.readyState!==WebSocket.OPEN&&E.close()})})}if(u){var p;let S;_.debug("[choose-best-ws] use single url: ",e),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[e],service:"gateway"},n);try{S=new WebSocket(e),s.push(S),S.binaryType="arraybuffer"}catch(E){let f=new L(C.WS_ERR,"init websocket failed! Error: ".concat(E.toString()));return _.error("[".concat(this.name,"]").concat(f)),void r(f)}S.onopen=()=>{i(S)},S.onclose=E=>{r(E)},S.onmessage=E=>{_.debug("[choose-best-ws]".concat(S.url," onmessage: ").concat(E.data))},Ye(this.forceCloseTimeout).then(()=>{S&&S.readyState!==WebSocket.OPEN&&S.close()})}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class AO extends ge{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Pt.CONNECTED?this.emit(nt.WS_CONNECTED):e===Pt.RECONNECTING?this.emit(nt.WS_RECONNECTING,this._websocketReconnectReason):e===Pt.CLOSED&&this.emit(nt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),g(this,"__name__","AgoraRTCSignal"),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",Pt.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new If(5)),g(this,"pingpongTimer",void 0),g(this,"wsInflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"ortc",void 0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(nt.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===pt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===pt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Dt.UID_BANNED);break;case 15:this.close(Dt.IP_BANNED);break;case 16:this.close(Dt.CHANNEL_BANNED)}if(r._type===pt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case st.ERR_LICENSE_MISSING:this.close(Dt.LICENSE_MISSING);break;case st.ERR_LICENSE_EXPIRED:this.close(Dt.LICENSE_EXPIRED);break;case st.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Dt.LICENSE_MINUTES_EXCEEDED);break;case st.ERR_LICENSE_PERIOD_INVALID:this.close(Dt.LICENSE_PERIOD_INVALID);break;case st.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Dt.LICENSE_MULTIPLE_SDK_SERVICE);break;case st.ERR_LICENSE_ILLEGAL:this.close(Dt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new Sg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Pt.CONNECTED&&this.reconnect("retry",pn.OFFLINE)})}async request(e,n,i,r){let o=qt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new Y((S,E)=>{if(this.connectionState===Pt.CONNECTED)return S();let f=()=>{this.off(nt.WS_CLOSED,R),S()},R=()=>{this.off(nt.WS_CONNECTED,f),E(new D(C.WS_ABORT))};this.once(nt.WS_CONNECTED,f),this.once(nt.WS_CLOSED,R),e!==it.PUBLISH&&e!==it.PUBLISH_DATASTREAM&&e!==it.SUBSCRIBE&&e!==it.SUBSCRIBE_DATASTREAM&&e!==it.UNSUBSCRIBE&&e!==it.UNSUBSCRIBE_DATASTREAM&&e!==it.UNPUBLISH&&e!==it.UNPUBLISH_DATASTREAM&&e!==it.CONTROL&&e!==it.RESTART_ICE||this.once(nt.DISCONNECT_P2P,()=>{E(new D(C.DISCONNECT_P2P))}),e!==it.PUBLISH&&e!==it.RESTART_ICE||this.once(nt.ABORT_P2P_EXECUTION,()=>{E(new D(C.DISCONNECT_P2P))})});if(this.connectionState!==Pt.CONNECTING&&this.connectionState!==Pt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new Y((S,E)=>{let f=!1,R=(I,w)=>{f=!0,S({isSuccess:I==="success",message:w||{}}),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.emit(nt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),R);let v=()=>{E(new D(C.WS_ABORT,"type: ".concat(e))),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.off("res-@".concat(o),R)};this.once(nt.WS_CLOSED,v),this.once(nt.WS_RECONNECTING,v),Ye(T("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(nt.REQUEST_TIMEOUT,e,n))})}),l=null;try{l=await d}catch(S){if(this.connectionState===Pt.CLOSED||e===it.LEAVE)throw new D(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?S.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=Xs(u),p=new D(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===st.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===st.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",pn.MULTI_IP)):this.reconnect(h.action,pn.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Y(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(zs.WRTC_STATS,n)}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{let o=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Pt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},T("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){let i={_type:e,_message:n};this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Y((n,i)=>{this.once(nt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(nt.WS_CLOSED,r=>i(this.initError||new D(C.WS_ABORT,r))),this.connectionState=Pt.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Dt.LEAVE,this.connectionState=Pt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(nt.ABORT_P2P_EXECUTION),this.store.signalConnected();let e=await Ue(this,nt.REQUEST_JOIN_INFO);this.store.joinReq();let n=await this.request(it.JOIN,e);if(this.ortc=e?.ortc,this.store.joinRep(),!n)return this.emit(nt.REPORT_JOIN_GATEWAY,xh.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(nt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Pt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new D(C.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=ks(this,nt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let n=await this.request(it.REJOIN,e);return!!n&&(this.connectionState=Pt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(pt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(pt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(pt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(pt.MUTE_AUDIO,{uid:i.uid}):this.emit(pt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(pt.MUTE_VIDEO,{uid:i.uid}):this.emit(pt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(pt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(pt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(pt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(pt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(pt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){if(!this.ortc)return!1;let n={downgrade_codec:e,ortc:this.ortc};return!!await this.request(it.DOWNGRADE_CODEC,n)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=Xs(e.code);if(e.code===28&&"detail"in e&&(_.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(nt.RECOVER_NOTIFICATION,e.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?e.code===st.ERR_REPEAT_JOIN_CHANNEL&&T("IGNORE_UID_CHECK")?void this.close(Dt.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Dt.UID_BANNED),void this.close()):e.code===st.K_VOS_FALLBACK&&"detail"in e?(_.info("[".concat(this.clientId,"] receive vos fallback notification: "),e.detail),e.detail==="FALLBACKCN"&&T("ENABLE_QUALITY_FALLBACK")?void Ue(this,nt.VOS_FALLBACK_PROMISE,e.detail).then(()=>{this.reconnect("recover",n.desc)}).catch(i=>{_.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),i)}):e.detail==="fallback_hls"&&T("ENABLE_FALLBACK_TO_HLS")?(this.emit(nt.VOS_FALLBACK,e.detail),void this.close(Dt.FALLBACK_TO_HLS)):this.reconnect(n.action,n.desc)):void this.reconnect(n.action,pn.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=T("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",pn.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),T("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(zs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Tt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(nt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Tt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Tt.CLOSED,()=>{this.connectionState=Pt.CLOSED}),this.websocket.on(Tt.FAILED,()=>{this._disconnectedReason=Dt.NETWORK_ERROR,this.connectionState=Pt.CLOSED}),this.websocket.on(Tt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Pt.CONNECTED?this.connectionState=Pt.RECONNECTING:this.connectionState=Pt.CONNECTING}),this.websocket.on(Tt.WILL_RECONNECT,(e,n,i)=>{let r=ks(this,nt.IS_P2P_DISCONNECTED),o=r||e!=="retry";r&&e==="retry"&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=xh.P2P_DISCONNECTED),o&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(nt.REPORT_JOIN_GATEWAY,n||xh.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(nt.DISCONNECT_P2P)),i(e)}),this.websocket.on(Tt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",pn.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(nt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof D){if(e.code===C.UNEXPECTED_RESPONSE&&e.data.code===st.ERR_NO_AUTHORIZED)return this.initError=new D(C.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Dt.TOKEN_EXPIRE);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",pn.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(Tt.REQUEST_NEW_URLS,(e,n)=>{Ue(this,nt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Ge.PRE_CONNECT_PC,()=>{this.emit(nt.PRE_CONNECT_PC)}),this.websocket.on(Tt.ON_FALLBACK,()=>{T("ENABLE_FALLBACK_TO_HLS")&&this.emit(nt.VOS_FALLBACK,"fallback_hls")})}}let wH=function(t){return t.NATIVE_RTC="native_rtc",t.NATIVE_RTM="native_rtm",t.WEB_RTC="web_rtc",t.WEB_RTM="web_rtm",t}({}),Le=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function bO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Bh(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?bO(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):bO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Tg=0;function sr(t){let e=T("TURN_DOMAINS");Tg=(Tg+1)%e.length;let n=e[Tg]||"edge.agora.io";return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(n):(_.debug("Cannot recognized as ip address: ".concat(t,", use as host2")),t)}function jh(t){try{let e=T("TURN_DOMAINS"),n=T("GATEWAY_DOMAINS").concat(e).find(i=>B(t).call(t,i));return n?t.split(".".concat(n))[0].replace(/-/g,"."):t}catch{return _.debug("serverUrlToIp error, fallback to url",t),t}}function Rg(t,e){t.addresses||(t.addresses=[]);let n=function(a,c){if(T("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map(u=>{let{ip:h,port:p}=u;return{address:"".concat(h,":").concat(p)}});let d=T("GATEWAY_DOMAINS"),l=d[1]&&B(c).call(c,d[1])?1:0;return a.map(u=>{let{domain_prefix:h,port:p,ip:S}=u;if(h)return{address:"".concat(h,".").concat(d[l++%d.length],":").concat(p)};let E=/^[\.\:\d]+$/.test(S),f=E?"".concat(S.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(p):"".concat(S,":").concat(p);return E||_.debug("Cannot recognized as ip address: ".concat(S,", use as host3")),{ip:S,port:p,address:f}})}(t.addresses,e),i=Array.isArray(t.detail)&&t.detail[18];if(i&&typeof i=="string"){let a=i.split(";");for(let c=0;c<a.length;c++){var r;let d=Pn(r=a[c]).call(r);n[c]&&d&&(n[c].ip6=d)}}let o=t.detail&&t.detail.candidate,s;if(o){let[a,c]=o.split(":");a&&c&&(s={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:n,apGatewayAddress:s,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Yn(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function wO(t){let e=t._encoderConfig;if(!e)return{};let n={resolution:e.width&&e.height?"".concat(Yn(e.width),"x").concat(Yn(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function Gh(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function Hd(t,e){let n,i,r;switch(e){case Le.CHOOSE_SERVER:i=4096,r="choose server";break;case Le.CLOUD_PROXY:i=1048576,r="proxy";break;case Le.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case Le.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new D(C.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>Bh(Bh({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:Bh(Bh({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!n)throw new D(C.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}async function OO(t,e){return await Y.all(t.addresses.map(async n=>({address:sr(n.ip),tcpport:n.port,udpport:n.port,username:e&&T("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():_n.username,password:e&&T("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await gf(e.toString()):_n.password})))}function Cg(t,e){let n=e.getMediaStreamTrack(!0).getSettings(),i=e.videoHeight||n.height,r=e.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(Yn(t.height),Yn(t.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Qo(t){let{candidateType:e,relayProtocol:n,type:i,address:r,port:o,protocol:s}=t,a={candidateType:e,relayProtocol:n,protocol:s};if(i!=="local-candidate"){let c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=o}return a}function Qr(t){let e=t.split(":"),n=t.split(/[-.]/),i=B(t).call(t,"-")?"-":".",r=t;return e.length>1?n.length>1?(n[1]="**",r=n[0]+i+"**:"+e[e.length-1]):r=e.length>2?e[0]+i+"**:"+e[e.length-1]:"**:"+e[e.length-1]:n.length>1&&(r=n[0]+i+"**"),r}function NO(t,e){return t.getTransceivers().find(n=>n.sender.track===e||n.receiver.track===e)}function Kd(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:T("SVC_MODE");if(T("ENABLE_SVC"))return function(e){return e in hh}(t)?t:hh.L1T3}let DO={[Z.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[Z.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function PO(t){t.send&&(Sc(Z.VIDEO,t.send.videoExtensions),Sc(Z.AUDIO,t.send.audioExtensions)),t.recv&&(Sc(Z.VIDEO,t.recv.videoExtensions),Sc(Z.AUDIO,t.recv.audioExtensions)),t.sendrecv&&(Sc(Z.VIDEO,t.sendrecv.videoExtensions),Sc(Z.AUDIO,t.sendrecv.audioExtensions))}function LO(t,e){t.send&&(Wh(Z.VIDEO,t.send.videoExtensions,e.send.videoExtensions),Wh(Z.AUDIO,t.send.audioExtensions,e.send.audioExtensions)),t.recv&&(Wh(Z.VIDEO,t.recv.videoExtensions,e.recv.videoExtensions),Wh(Z.AUDIO,t.recv.audioExtensions,e.recv.audioExtensions))}function Wh(t,e,n){e.forEach(i=>{var r;let o=DO[t].find(a=>{var c;let{key:d}=a;return B(c=i.extensionName).call(c,d)});if(!o)return;let s=n.find(a=>{let{extensionName:c}=a;return B(c).call(c,o.key)});s&&B(r=s.extensionName).call(r,"gdpr_forbidden")&&(i.extensionName=s.extensionName)})}function Sc(t,e){e.forEach(n=>{var i;let r=DO[t].find(o=>{var s;let{key:a}=o;return B(s=n.extensionName).call(s,a)});B(i=n.extensionName).call(i,"gdpr_forbidden")&&r&&(n.extensionName=r.extensionName)})}function kO(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||B(t).call(t,"abs-send-time")}function Hh(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||B(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function MO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function UO(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?MO(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function Yd(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0,{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c,unsupportedVideoUplinkCodec:d,unsupportedVideoDownlinkCodec:l}=e,{useXR:u}=n,h=[],p=[],S=[],E=[],f=!1,R=!1;if(Mn(t).mediaDescriptions.forEach(I=>{i&&i!==I.attributes.direction||(I.media.mediaType!=="video"||f||(p=I.attributes.payloads,E=I.attributes.extmaps,f=!0),I.media.mediaType!=="audio"||R||(h=I.attributes.payloads,S=I.attributes.extmaps,R=!0))}),!E||p.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!S||h.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(p.forEach(I=>{var w;(w=I.rtpMap)!==null&&w!==void 0&&w.clockRate&&(I.rtpMap.clockRate=parseInt(I.rtpMap.clockRate)),u&&I.rtcpFeedbacks.push({type:"rrtr"})}),h.forEach(I=>{var w;(w=I.rtpMap)!==null&&w!==void 0&&w.clockRate&&(I.rtpMap.clockRate=parseInt(I.rtpMap.clockRate)),u&&I.rtcpFeedbacks.push({type:"rrtr"})}),r&&(h=h.filter(I=>{var w;return((w=I.rtpMap)===null||w===void 0?void 0:w.encodingName.toLowerCase())!=="rtx"}),p=p.filter(I=>{var w;return((w=I.rtpMap)===null||w===void 0?void 0:w.encodingName.toLowerCase())!=="rtx"})),o){let I=p.filter(A=>{var N;return/(red)|(ulpfec)|(flexfec)/i.test(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName)||"")}),w=Zo(I,p).map(A=>A.payloadType),O=[...I.map(A=>A.payloadType),...w];p=p.filter(A=>!B(O).call(O,A.payloadType))}if(s&&(h=h.filter(I=>{var w;return!/(red)|(ulpfec)|(flexfec)/i.test(((w=I.rtpMap)===null||w===void 0?void 0:w.encodingName)||"")})),a&&a?.length>0&&(h=h.filter(I=>{var w;return B(a).call(a,((w=I.rtpMap)===null||w===void 0?void 0:w.encodingName.toLowerCase())||"")})),c&&c?.length>0){let I=p.filter(w=>{var O;return B(c).call(c,((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLowerCase())||"")});p=I.concat(r?[]:Zo(I,p))}let v=T("UNSUPPORTED_VIDEO_CODEC");if(v&&v.length>0){let I=p.filter(A=>A.rtpMap&&B(v).call(v,A.rtpMap.encodingName.toLowerCase())),w=Zo(I,p),O=I.concat(w).map(A=>A.payloadType);p=p.filter(A=>!B(O).call(O,A.payloadType)),_.debug("unsupportedVideoCodec: ".concat(v,", toBeRemoved: ").concat(O))}if(d&&d.length>0&&i==="sendonly"){let I=p.filter(A=>A.rtpMap&&B(d).call(d,A.rtpMap.encodingName.toLowerCase())),w=Zo(I,p),O=I.concat(w).map(A=>A.payloadType);p=p.filter(A=>!B(O).call(O,A.payloadType)),_.debug("unsupportedVideoUplinkCodec: ".concat(d,", toBeRemoved: ").concat(O))}if(l&&l.length>0&&i==="recvonly"){let I=p.filter(A=>A.rtpMap&&B(l).call(l,A.rtpMap.encodingName.toLowerCase())),w=Zo(I,p),O=I.concat(w).map(A=>A.payloadType);p=p.filter(A=>!B(O).call(O,A.payloadType)),_.debug("unsupportedVideoDownlinkCodec: ".concat(l,", toBeRemoved: ").concat(O))}return{audioCodecs:h,videoCodecs:p,audioExtensions:S,videoExtensions:E}}function Zr(t){let e=Mn(t),n,i;for(let r of e.mediaDescriptions){if(!n){let o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s}}if(!i){let o=r.attributes.fingerprints;o.length>0&&(i={fingerprints:o})}}if(!i&&e.attributes.fingerprints.length>0&&(i={fingerprints:e.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function vg(t,e){let n=[],i=t.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=t.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;let c=(a=i.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:s,rtx:e?c:void 0})});else if(i.length>0){let s=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:s,rtx:e?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function xO(t,e,n){let{cname:i}=t,r=[];e&&(r=VO(e)),r.length===0&&(r=t.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}})),_.debug("Using candidates from gateway."));let o={fingerprints:t.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},s={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd},a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}let c=zd(t.rtpCapabilities),d=[];return Array.isArray(n)&&n.length>0&&n.forEach(l=>{d.push({kind:Z.VIDEO,ssrcMsg:[{ssrcId:l.v,rtx:l.v_rtx}],mslabel:"".concat(l.v,"_").concat(l.a)},{kind:Z.AUDIO,ssrcMsg:[{ssrcId:l.a}],mslabel:"".concat(l.v,"_").concat(l.a)})}),{dtlsParameters:o,iceParameters:s,candidates:r,rtpCapabilities:c,setup:a,cname:i,preSSRCs:d}}function VO(t){let e=[];return t.ip&&typeof t.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(Qr(t.ip),":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(Qr(t.ip6),":").concat(t.port)))),e}function qd(t,e,n){let i=[],r=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o,c=qt(8,"track-"),d={ssrcId:s,attributes:UO({label:c,mslabel:n=n||qt(10,""),msid:"".concat(n," ").concat(c)},e&&{cname:e})};if(i.push(d),a!==void 0){let l={ssrcId:a,attributes:UO({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},e&&{cname:e})};i.push(l),r.push({semantic:"FID",ssrcIds:[s,a]})}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:i,ssrcGroups:r}}function Js(t,e){e instanceof Ae&&t.attributes.payloads.forEach(n=>{var i;let r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),r==="opus"&&typeof T("OPUS_PTIME")=="number"?n.fmtp.parameters.ptime=T("OPUS_PTIME"):n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";let o=e._encoderConfig;o&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!ue()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1")),e instanceof jd&&r==="opus"&&e._config.DTX&&(n.fmtp.parameters.usedtx="1"))})}function yg(t){let e=t.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function Ig(t,e){var n;if(t.attributes.payloads.forEach(r=>{var o;((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&T("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),!(e instanceof oe&&e._encoderConfig&&e._hints.indexOf(Kt.SCREEN_TRACK)===-1))return;let i=e._encoderConfig;wt().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach(r=>{var o,s;B(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))}),wt().supportMinBitrate&&!B(n=e._hints).call(n,Kt.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach(r=>{var o,s;B(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(T("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))})}function FO(t){if(t.media.mediaType!=="video")return;let e=Vt();if(e.name!==jt.SAFARI&&e.os!==Ke.IOS)return;let n=t.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));n!==-1&&t.attributes.extmaps.splice(n,1)}function Kh(t,e,n){if(!e)return;let i,r;if(t.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),e.twcc===!0){let o=i.find(s=>Hh(s.extensionName));if(o){let s=o.extensionName;t.attributes.extmaps.find(c=>Hh(c.extensionName))||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="transport-cc")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="transport-cc")||c.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(e.twcc===!1){let o=t.attributes.extmaps.findIndex(s=>Hh(s.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){let o=i.find(s=>kO(s.extensionName));if(o){let s=o.extensionName;t.attributes.extmaps.find(c=>c.extensionName===s)||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="goog-remb")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="goog-remb")||c.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(e.remb===!1){let o=t.attributes.extmaps.findIndex(s=>kO(s.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function Ag(t,e,n){if(ue()||t.media.mediaType!=="video"||!(e instanceof oe)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!T("SIMULCAST")||n==="vp9"&&T("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;let i=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:he(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:he(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s)}async function BO(){try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:hh.L1T3}]});let e=await t.createOffer();if(!e.sdp)return void t.close();let n=Mn(e.sdp).mediaDescriptions[0];if(!n)return;let i=n.attributes.extmaps.find(r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return t.close(),i}catch{return}}async function bg(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});let i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0,l=Yd(d,a,c,"sendonly"),u=Yd(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ar(l,u,"videoExtensions",h,p,S),ar(l,u,"videoCodecs",h,p,S),ar(l,u,"audioExtensions",h,p,S),ar(l,u,"audioCodecs",h,p,S),T("RAISE_H264_BASELINE_PRIORITY")){let E=[],f=[];if(S.videoCodecs.forEach((R,v)=>{var I;if(((I=R.rtpMap)===null||I===void 0?void 0:I.encodingName.toLocaleLowerCase())==="h264"){var w,O;let A=S.videoCodecs[v+1],N=A&&HO(R,A),k=(w=R.fmtp)===null||w===void 0?void 0:w.parameters["profile-level-id"],V=(O=R.fmtp)===null||O===void 0?void 0:O.parameters["packetization-mode"];!k||k!==T("FIRST_H264_PROFILE_LEVEL_ID")||T("FIRST_PACKETIZATION_MODE")&&V!==T("FIRST_PACKETIZATION_MODE")?N?f.push([R,A]):f.push([R]):N?E.push([R,A]):E.push([R])}}),E.length>0&&f.length>0){_.debug("raising H264 baseline profile priority"),S.videoCodecs.forEach((v,I)=>{var w;if(((w=v.rtpMap)===null||w===void 0?void 0:w.encodingName.toLocaleLowerCase())==="h264"){let O=HO(v,S.videoCodecs[I+1]),A=E.shift()||f.shift()||[];A.length>0&&(O?S.videoCodecs.splice(I,2,...A):S.videoCodecs.splice(I,1,...A))}});let R=p.videoCodecs.filter(v=>{var I,w;return((I=v.rtpMap)===null||I===void 0?void 0:I.encodingName.toLocaleLowerCase())==="h264"&&((w=v.fmtp)===null||w===void 0?void 0:w.parameters["profile-level-id"])!==T("FIRST_H264_PROFILE_LEVEL_ID")});if(R.length>0){let v=Zo(R,p.videoCodecs).map(w=>w.payloadType),I=[...R.map(w=>w.payloadType),...v];p.videoCodecs=p.videoCodecs.filter(w=>!B(I).call(I,w.payloadType))}T("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(v=>{var I,w;return!(((I=v.rtpMap)===null||I===void 0?void 0:I.encodingName.toLocaleLowerCase())==="h264"&&((w=v.fmtp)===null||w===void 0?void 0:w.parameters["profile-level-id"])!==T("FIRST_H264_PROFILE_LEVEL_ID"))}))}return{send:h,recv:p,sendrecv:S}}return{send:h,recv:p,sendrecv:S}}(t,e,i);try{n.close()}catch{}return{send:r,recv:o,sendrecv:s}}function jO(){let t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Yd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ar(t,e,"videoExtensions",n,i,r),ar(t,e,"videoCodecs",n,i,r),ar(t,e,"audioExtensions",n,i,r),ar(t,e,"audioCodecs",n,i,r),T("RAISE_H264_BASELINE_PRIORITY")){let o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){let s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){_.debug("raising H264 baseline profile priority");let a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a)}s!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:i,sendrecv:r}}function ar(t,e,n,i,r,o){if(n==="videoExtensions"||n==="audioExtensions"){let s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}if(n==="videoCodecs"||n==="audioCodecs"){let s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void e[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}}function zd(t){let{send:e,recv:n,sendrecv:i}=t;if(!i){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...i.audioCodecs],r.videoCodecs=[...e.videoCodecs,...i.videoCodecs],r.audioExtensions=[...e.audioExtensions,...i.audioExtensions],r.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):r=he(i),n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=he(i),{send:r,recv:o}}function Tc(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var n;return((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Xd(t,e,n,i){let r=[];if(t===Z.VIDEO){if(T("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=e.videoCodecs.filter(o=>{var s;return B(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,i)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===T("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let o=[],s=[],a=[],c=[];if(n.videoCodecs.forEach(d=>{let l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";B(l).call(l,i)?o.push(d):B(l).call(l,"vp9")?s.push(d):B(l).call(l,"vp8")?a.push(d):B(l).call(l,"h264")&&c.push(d)}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}o.length!==0&&(r=e.videoCodecs.filter(d=>o.some(l=>l.payloadType===d.payloadType)))}if(r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),T("USE_PUB_RTX")||T("USE_SUB_RTX")){let o=Zo(r,e.videoCodecs);r=[...r,...o]}}else{r=e.audioCodecs.filter(s=>{var a;return B(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,i)});let o=e.audioCodecs.filter(s=>{var a;return B(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"red")});r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(s=>{var a;return B(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")})),T("ENABLE_AUDIO_RED")&&o.length!==0&&(r=[...o,...r])}return r}function Zo(t,e){let n=t.map(i=>i.payloadType.toString());return e.filter(i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&B(n).call(n,i.fmtp&&i.fmtp.parameters.apt))}async function ti(t,e,n){let i=e.toString(),r=GO(i,"offer","remote","exchangeSDP");await t.setRemoteDescription({type:"offer",sdp:i});let o=await t.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let s=o.sdp;s=wg(s,n||{}),r?.(s||""),await t.setLocalDescription({type:"answer",sdp:s})}function wg(t,e,n){if(T("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;let i=Mn(t),{useXR:r}=e;return i.mediaDescriptions.forEach(o=>{var s;o.attributes.mid&&(Array.isArray(n)&&!B(n).call(n,o.attributes.mid)||(o.media.mediaType==="audio"&&Tc(o),o.media.mediaType==="video"&&function(a){a.media.mediaType==="video"&&T("ENABLE_DOWN_SPS_PPS")&&a.attributes.payloads.filter(c=>{var d;return((d=c.rtpMap)===null||d===void 0?void 0:d.encodingName.toLowerCase())==="h264"}).forEach(c=>{c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"})}(o),r&&B(s=["audio","video"]).call(s,o.media.mediaType)&&o.attributes.payloads.forEach(a=>{a.rtcpFeedbacks.findIndex(c=>c.type==="rrtr")===-1&&a.rtcpFeedbacks.push({type:"rrtr"})})))}),To(i)}function GO(t,e,n,i){if(T("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(e," SDP during P2PConnection.").concat(i,`
`),t),e==="offer"?r=>{GO(r,"answer",n==="local"?"remote":"local",i)}:void 0}async function WO(t,e,n){try{var i;if(!wt().supportSetRtpSenderParameters||!function(c){return c==="vp9"||c==="av1"}(t)||!T("ENABLE_SVC"))return;let r={},o={},s=e.getParameters(),a=(i=s.encodings)===null||i===void 0?void 0:i[0];o.scalabilityMode=Kd(n),a&&Object.assign(a,o),Object.assign(s,r),await e.setParameters(s),_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(s.encodings)))}catch(r){_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function Yh(t){let e=T("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(n=>B(t).call(t,n))}function HO(t,e){try{var n;return((n=t.fmtp)===null||n===void 0?void 0:n.parameters.apt)===e.payloadType.toString()}catch{return!1}}function KO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ui(t,e){return typeof T(t)===e?T(t):void 0}function OH(){try{let t=T("EXPERIMENTS")||{};return typeof t=="string"||Array.isArray(t)?{}:function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?KO(Object(i),!0).forEach(function(r){g(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):KO(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}({},t)}catch(t){return _.debug("handle gateway attributes failed: ",t),{}}}let YO={};function $r(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&_.debug("install service ".concat(t.name)),YO[t.name]=t}function br(t){let e=YO[t];if(!e)throw new L(C.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function qO(t,e){return br("DataStream").create(t,e)}function qh(){return br("InterceptFrame").create()}function zO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function rn(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zO(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Og=new Map;class NH extends ge{get state(){return this._state}set state(e){if(e===this._state)return;let n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(we.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(we.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){var i,r,o;super(),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"key",void 0),g(this,"ntpOffset",0),g(this,"usingProxy",!1),g(this,"signal",void 0),g(this,"role",void 0),g(this,"isPreallocation",void 0),g(this,"isPreSub",void 0),g(this,"inChannelInfo",{joinAt:null,duration:0}),g(this,"spec",void 0),g(this,"_state","DISCONNECTED"),g(this,"_statsCollector",void 0),g(this,"_disconnectedReason",void 0),g(this,"isSignalRecover",!1),g(this,"hasChangeBGPAddress",!1),g(this,"trafficStatsInterval",void 0),g(this,"networkQualityInterval",void 0),g(this,"_joinGatewayStartTime",0),g(this,"_signalTimeout",!1),g(this,"_clientRoleOptions",void 0),g(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?(i={spec:rn(rn({},n),{},{retryConfig:n.websocketRetryConfig}),store:e},(r=(o=br("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(o,i)):this.store.useDcSignal?function(s){return br("DataChannelSignal").create(s)}({spec:rn(rn({},n),{},{retryConfig:n.websocketRetryConfig}),store:e}):new AO(rn(rn({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(e){this.usingProxy=e}async join(e,n,i){if(this.store.useDcSignal){let l=!1;e.cloudProxyServer!=="disabled"?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),l=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),l=!0):e.apResponse.addresses.some(u=>u.fingerprint)||T("FINGERPRINT")||(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),l=!0),l&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let r=Date.now(),o=Og.get(e.cname);if(o||(o=new Map,Og.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){let l=new D(C.UID_CONFLICT);throw tt.joinGateway(e.sid,{lts:r,succ:!1,ec:l.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!e.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:e.preload}),l}o.set(e.uid,!0),this.joinInfo=e,this.key=n;let s=0;this.joinGatewayStartTime=r;let a=e.proxyServer,c=this.store.useDcSignal?"datachannel":"websocket";try{_.debug("[".concat(this.store.clientId,"] use ").concat(c," join uid ").concat(s));let l=e.gatewayAddrs.map(h=>{let{address:p}=h,[S,E]=p.split(":"),f={host:S,port:E};return e.proxyServer&&(f.proxy=e.proxyServer),f}),u;u=this.store.useDcSignal?await this.signal.init(e.apResponse.addresses):await this.signal.init(l),s=u.uid,_.debug("[".concat(this.store.clientId,"] ").concat(c," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(l){var d;throw l.code===C.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||tt.joinGateway(e.sid,{lts:r,succ:!1,ec:((d=l.data)===null||d===void 0?void 0:d.desc)||l.code,errorMsg:l.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:e.preload}),l&&l.code===C.INIT_DATACHANNEL_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join datachannel failed"),l.toString()),this.resetSignal(),l):(_.error("[".concat(this.store.clientId,"] User join failed"),l.toString()),o.delete(e.uid),this.signal.close(),l)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(l=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),l.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(we.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(we.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(we.NETWORK_QUALITY,{uplinkNetworkQuality:Gh(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Gh(this._statsCollector.trafficStats.B_dnq)}):this.emit(we.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==Dt.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Pt.CONNECTED||await function(i,r){return r===1/0?i:Y.race([i,i4(r)])}(this.signal.request(it.LEAVE,void 0,!0),3e3)}catch(i){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==Dt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:T("PUB_EXTEND"),twcc:!!T("PUBLISH_TWCC"),rtx:!!T("USE_PUB_RTX")};try{return(await this.signal.request(it.PUBLISH,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===st.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw o}}async publishDataChannel(e,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(it.PUBLISH_DATASTREAM,o,!0)}catch(s){if(i&&s.data&&s.data.code===st.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw s}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(it.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(i){_.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Y.all(e.map(n=>this.signal.request(it.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){_.warning("unpublish datachannels warning: ",n)}}async presubscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!T("SUBSCRIBE_TWCC"),rtx:!!T("USE_SUB_RTX")||void 0,extend:T("SUB_EXTEND"),svc:Array.isArray(T("SVC"))&&T("SVC").length!==0?T("SVC"):void 0};try{return await this.signal.request(it.PRE_SUBSCRIBE,r,!0)}catch(o){if(i&&o.data&&o.data.code===st.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,n,!1);throw o}}async subscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!T("SUBSCRIBE_TWCC"),rtx:!!T("USE_SUB_RTX"),extend:T("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(T("SVC"))&&T("SVC").length!==0?T("SVC"):void 0};try{return(await this.signal.request(it.SUBSCRIBE,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===st.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw o}}async subscribeDataChannel(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let r={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(it.SUBSCRIBE_DATASTREAM,r,!0)}catch(o){if(i&&o.data&&o.data.code===st.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw o}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!T("USE_SUB_RTX"),twcc:!!T("SUBSCRIBE_TWCC"),svc:Array.isArray(T("SVC"))&&T("SVC").length!==0?T("SVC"):void 0};try{return await this.signal.request(it.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===st.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){let n=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,o=i.width,s=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(e);if(n)return this.signal.request(it.SET_VIDEO_PROFILE,n);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0)}catch(i){_.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Y.all(e.map(i=>this.signal.request(it.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0)))}catch(i){_.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(e){try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){_.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(e){let{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(it.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(it.GATEWAY_INFO)}async renewToken(e){await this.signal.request(it.RENEW_TOKEN,e),this.key=e.token}updateClientRole(e,n){n&&(this._clientRoleOptions=Object.assign({},n)),T("CLIENT_ROLE_OPTIONS")&&(_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(T("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},T("CLIENT_ROLE_OPTIONS"))),this.role=e}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),T("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},T("CLIENT_ROLE_OPTIONS")),_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(T("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let i,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;let o=Object.assign({},n);delete o.delay,delete o.level,await this.signal.request(it.SET_CLIENT_ROLE,rn(rn({role:e,level:r,delay:i},o),{},{client_ts:Date.now()})),this.role=e}async setDualStreamMode(e,n,i){await this.signal.request(it.SET_DUAL_STREAM_MODE,{mode:e},i,n)}async setRemoteVideoStreamType(e,n){await this.signal.request(it.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(it.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,n){await this.signal.request(it.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})}async pickSVCLayer(e,n){await this.signal.request(it.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(e){await this.signal.request(it.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,n,i){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),rn({},this.inChannelInfo)}async setConfigure(e){if(e&&Array.isArray(e)&&e.length!==0)return this.signal.request(it.CONFIGURE,e)}async getGatewayVersion(){return(await this.signal.request(it.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let e=Og.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let e=function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:_n.username,password:_n.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(rn(rn({},_n),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let e=await this.signal.request(it.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(n=>{let i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===n.peer_uid);i&&i.B_st!==n.B_st&&ch(()=>{this.emit(we.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){var n,i,r,o;if(!this.joinInfo||!this.key)throw new D(C.UNEXPECTED_ERROR,"can not generate join message, no join info");let s=Object.assign({},this.joinInfo.apResponse),a=T("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}var c;a&&a.length>128&&(a=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(we.UPDATE_GATEWAY_CONFIG),c=this.store.clientId,B(_c).call(_c,c)||_c.push(c);let d=Fd(this.store),l=!((n=this.isPreallocation)===null||n===void 0||!n.call(this)),u=zb(this.store),h=OH(),p=Rr(87)||tb()||hf(117),S=(function(){let v=Vt();if(v.name!==jt.SAFARI||!v.browserVersion)return!1;let I=v.browserVersion.split(".");return Number(I[0])>18||Number(I[0])===18&&Number(I[1])>=4}()||rb(18,4,!1))&&pf(18,6,!0)&&this.spec.codec==="h264"&&T("ENABLE_ABSSENDTIME_AS_SENTTS"),E=!(((i=s.detail)===null||i===void 0?void 0:i[3])!=="CN"||!T("ENABLE_QUALITY_FALLBACK"))&&T("ENABLE_QUALITY_FALLBACK"),f=!!T("ENABLE_AP_MULTI_IP")&&((r=s.detail)===null||r===void 0?void 0:r[5])==="multi-ip",R=rn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:ki,browser:navigator.userAgent,process_id:T("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:f||this.hasChangeBGPAddress,ap_response:s,extend:T("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:rn(rn({enableEncodedTransform:(!!T("ENABLE_AUDIO_METADATA")||!!T("ENABLE_AUDIO_PTS"))&&p||!!T("ENABLE_AUDIO_TOPN")&&uf(jt.CHROME,87,116)||void 0,enableAudioMetadata:!!T("ENABLE_AUDIO_METADATA")&&p,enableAudioPts:!!T("ENABLE_AUDIO_PTS")&&p,topnSmoothLevel:T("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:T("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:T("TOPN_SWITCH_HOLD_MS"),topnAudioGain:T("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:T("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:T("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:ui("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:ui("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:ui("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:T("USE_PUB_RTX")===!0||T("USE_SUB_RTX")===!0||void 0,disableFEC:T("DISABLE_FEC"),enableNTPReport:!!T("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:u,enableFulllinkAvSync:!!T("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:ui("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!T("FORCE_ENABLE_AUT_CC")||!fh()&&(!!T("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!T("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:ui("USE_XR","boolean"),enableLossbasedBwe:ui("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!T("FORCE_ENABLE_AUT_CC")||!fh()&&(!!T("ENABLE_AUT_CC")||void 0),enableCCFallback:ui("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:l,preSubNum:d?ui("PRE_SUB_NUM","number"):void 0,enablePubTWCC:ui("PUBLISH_TWCC","boolean"),enableSubTWCC:ui("SUBSCRIBE_TWCC","boolean"),enablePubRTX:ui("USE_PUB_RTX","boolean"),enableSubRTX:ui("USE_SUB_RTX","boolean"),enableSubSVC:T("ENABLE_SVC")?T("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(T("SVC"))&&T("SVC").length!==0?T("SVC"):void 0,enableSvcExtended:T("ENABLE_SVC")&&Array.isArray(T("SVC_EXTENDED"))&&T("SVC_EXTENDED").length!==0?T("SVC_EXTENDED"):void 0,enableVosFallback:T("ENABLE_VOS_FALLBACK"),enableQualityFallback:E},h),{},{audioDuplicate:ui("ENABLE_AUDIO_RED","boolean")?(o=ui("AUDIO_DUPLICATE_NUM","number"))!==null&&o!==void 0?o:2:void 0,senttsUsesAbsSendTime:!!S||void 0,enableDualStreamFlag:ui("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(R.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(R.aes_mode=this.joinInfo.aesmode,T("ENCRYPT_AES")?(R.aes_secret=this.joinInfo.aespassword,R.aes_encrypt=!0):R.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(R.aes_salt=this.joinInfo.aessalt)),s.addresses[this.signal.websocket.currentURLIndex]&&(R.ap_response.ticket=s.addresses[this.signal.websocket.currentURLIndex].ticket,delete s.addresses),this.joinInfo.defaultVideoStream!==void 0&&(R.default_video_stream=this.joinInfo.defaultVideoStream),R}getRejoinMessage(){if(!this.joinInfo)throw new D(C.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(nt.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(nt.WS_RECONNECTING,e=>{this.joinInfo&&tt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||pn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",tt.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(nt.WS_CLOSED,e=>{let n;switch(e){case Dt.LEAVE:n=pn.LEAVE;break;case Dt.UID_BANNED:case Dt.IP_BANNED:case Dt.CHANNEL_BANNED:case Dt.SERVER_ERROR:n=pn.SERVER_ERROR;break;case Dt.FALLBACK:n=pn.FALLBACK;break;case Dt.LICENSE_MISSING:case Dt.LICENSE_EXPIRED:case Dt.LICENSE_MINUTES_EXCEEDED:case Dt.LICENSE_PERIOD_INVALID:case Dt.LICENSE_MULTIPLE_SDK_SERVICE:case Dt.LICENSE_ILLEGAL:case Dt.TOKEN_EXPIRE:n=e;break;default:n=pn.NETWORK_ERROR}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+pn.NETWORK_ERROR)),this.joinInfo&&tt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Dt.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==Dt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(nt.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){let e=T("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(tt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){let e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));$t("EVENT_REPORT_DOMAIN",e[1]),$t("EVENT_REPORT_BACKUP_DOMAIN",e[1]),$t("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}}),this.signal.on(pt.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(nt.REQUEST_RECOVER,(e,n,i)=>{if(!this.joinInfo)return i(new D(C.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Ue(this,we.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)}),this.signal.on(nt.REQUEST_JOIN_INFO,async(e,n,i)=>{var r,o,s;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));let a=he((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(T("NEW_TURN_MODE")&&a&&((o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer)==="disabled"){var c;let h=a.servers.map(E=>"turnServerURL"in E&&T("USE_TURN_IP")?rn(rn({},E),{},{turnServerURL:jh(E.turnServerURL)}):E),p=(c=a.serversFromGateway)===null||c===void 0?void 0:c.map(E=>T("USE_TURN_IP")?rn(rn({},E),{},{turnServerURL:jh(E.turnServerURL)}):E),S=this.signal.currentURLIndex;h.length>0&&(h=[h[S%h.length]],a.servers=h),Array.isArray(p)&&p.length>0&&(p=[p[0]],a.serversFromGateway=p),_.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(S))}let{iceParameters:d,dtlsParameters:l,rtpCapabilities:u}=await Ue(this,we.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:a,cloudProxyServer:(s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer});try{e(this.getJoinMessage({ortc:{iceParameters:d,dtlsParameters:l,rtpCapabilities:u,version:"2"}}))}catch(h){n(h)}}),this.signal.on(nt.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(nt.REPORT_JOIN_GATEWAY,(e,n)=>{if(!this.joinInfo)return;let i,r="";var o;e instanceof D?(i=((o=e.data)===null||o===void 0?void 0:o.desc)||e.code,r=e.message):i=e,tt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:r,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})}),this.signal.on(nt.IS_P2P_DISCONNECTED,e=>{e(ks(this,we.IS_P2P_DISCONNECTED))}),this.signal.on(nt.DISCONNECT_P2P,()=>{this.emit(we.DISCONNECT_P2P)}),this.signal.on(nt.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(nt.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(nt.JOIN_RESPONSE,e=>{let n=this.getCurrentGatewayAddress();this.emit(we.JOIN_RESPONSE,e,n)}),this.signal.on(nt.PRE_CONNECT_PC,async(e,n)=>{if(this.joinInfo){var i,r;this.updateTurnConfigFromSignal();let s=this.getCurrentGatewayAddress(),a=he((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(T("NEW_TURN_MODE")&&a&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var o;let d=a.servers.map(h=>"turnServerURL"in h&&T("USE_TURN_IP")?rn(rn({},h),{},{turnServerURL:jh(h.turnServerURL)}):h),l=(o=a.serversFromGateway)===null||o===void 0?void 0:o.map(h=>T("USE_TURN_IP")?rn(rn({},h),{},{turnServerURL:jh(h.turnServerURL)}):h),u=this.signal.currentURLIndex;d.length>0&&(d=[d[u%d.length]],a.servers=d),Array.isArray(l)&&l.length>0&&(l=[l[0]],a.serversFromGateway=l),_.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(u,",in pre pc"))}let c=T("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(s&&c){let d=VO(s);Ue(this,we.PRE_CONNECT_PC,{candidates:d,fingerprint:c,turnServer:a}).then(l=>{e?.(l)}).catch(n||(()=>{}))}}}),this.signal.on(nt.RECOVER_NOTIFICATION,e=>{this.joinInfo&&typeof T("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(T("AP_REQUEST_DETAIL"),";").concat(e))}),this.signal.on(nt.VOS_FALLBACK,e=>{this.emit(we.VOS_FALLBACK,e)}),this.signal.on(nt.DATACHANNEL_FAILBACK,e=>{_.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(we.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(it.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw _.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(it.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(it.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw _.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(e){let n={users:e.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request(it.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(e,n){let i={action:e.find(r=>r.stream_type===Xt.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,n){let i={action:e.find(r=>r.stream_type===Xt.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,n){let i={action:e===Z.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,n){let i={action:e===Z.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(it.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}async restartICE(e){let n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(it.RESTART_ICE,n,!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(e,n){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,n||pn.P2P_FAILED)}getCurrentGatewayAddress(){var e,n;if(!T("GATEWAY_WSS_ADDRESS"))return T("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(_.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(it.SET_PARAMETER,{enablePublishAudioFilter:e})}downgradeCodec(e){this.signal.downgradeCodec(e)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Dt.FALLBACK)),this.store.useDcSignal=!1,this.signal=new AO(rn(rn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(we.RESET_SIGNAL)}}let zh=0,Ng=0;function wr(t,e,n,i){return new Y((r,o)=>{e.timeout=e.timeout||T("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),zh+=Yr(e.data)):n&&(e.data.size?zh+=e.data.size:e.data instanceof FormData?zh+=yb(e.data):zh+=Yr(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,Gn.request(e).then(s=>{typeof s.data=="string"?Ng+=Yr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Ng+=s.data.byteLength:Ng+=Yr(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Gn.isCancel(s)?o(new D(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new D(C.NETWORK_TIMEOUT,s.message)):s.response?o(new D(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new D(C.NETWORK_ERROR,s.message))})})}(function(){var t;function e(U){var K=0;return function(){return K<U.length?{done:!1,value:U[K++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(U,K,$){return U==Array.prototype||U==Object.prototype||(U[K]=$.value),U},i,r=function(U){U=[typeof globalThis=="object"&&globalThis,U,typeof window=="object"&&window,typeof self=="object"&&self,typeof F=="object"&&F];for(var K=0;K<U.length;++K){var $=U[K];if($&&$.Math==Math)return $}throw Error("Cannot find global object")}(this);function o(U,K){if(K)t:{var $=r;U=U.split(".");for(var x=0;x<U.length-1;x++){var m=U[x];if(!(m in $))break t;$=$[m]}(K=K(x=$[U=U[U.length-1]]))!=x&&K!=null&&n($,U,{configurable:!0,writable:!0,value:K})}}function s(U){return(U={next:U})[Symbol.iterator]=function(){return this},U}function a(U){var K=typeof Symbol<"u"&&Symbol.iterator&&U[Symbol.iterator];return K?K.call(U):{next:e(U)}}if(o("Symbol",function(U){function K(m,y){this.A=m,n(this,"description",{configurable:!0,writable:!0,value:y})}if(U)return U;K.prototype.toString=function(){return this.A};var $="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",x=0;return function m(y){if(this instanceof m)throw new TypeError("Symbol is not a constructor");return new K($+(y||"")+"_"+x++,y)}}),o("Symbol.iterator",function(U){if(U)return U;U=Symbol("Symbol.iterator");for(var K="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),$=0;$<K.length;$++){var x=r[K[$]];typeof x=="function"&&typeof x.prototype[U]!="function"&&n(x.prototype,U,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return U}),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}i=c?function(U,K){if(U.__proto__=K,U.__proto__!==K)throw new TypeError(U+" is not extensible");return U}:null}var l=i;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function h(U){if(U.m)throw new TypeError("Generator is already running");U.m=!0}function p(U,K){return U.h=3,{value:K}}function S(U){this.g=new u,this.G=U}function E(U,K,$,x){try{var m=K.call(U.g.j,$);if(!(m instanceof Object))throw new TypeError("Iterator result "+m+" is not an object");if(!m.done)return U.g.m=!1,m;var y=m.value}catch(b){return U.g.j=null,U.g.s(b),f(U)}return U.g.j=null,x.call(U.g,y),f(U)}function f(U){for(;U.g.h;)try{var K=U.G(U.g);if(K)return U.g.m=!1,{value:K.value,done:!1}}catch($){U.g.v=void 0,U.g.s($)}if(U.g.m=!1,U.g.l){if(K=U.g.l,U.g.l=null,K.F)throw K.D;return{value:K.return,done:!0}}return{value:void 0,done:!0}}function R(U){this.next=function(K){return U.o(K)},this.throw=function(K){return U.s(K)},this.return=function(K){return function($,x){h($.g);var m=$.g.j;return m?E($,"return"in m?m.return:function(y){return{value:y,done:!0}},x,$.g.return):($.g.return(x),f($))}(U,K)},this[Symbol.iterator]=function(){return this}}function v(U,K){return K=new R(new S(K)),l&&U.prototype&&l(K,U.prototype),K}if(u.prototype.o=function(U){this.v=U},u.prototype.s=function(U){this.l={D:U,F:!0},this.h=this.C||this.u},u.prototype.return=function(U){this.l={return:U},this.h=this.u},S.prototype.o=function(U){return h(this.g),this.g.j?E(this,this.g.j.next,U,this.g.o):(this.g.o(U),f(this))},S.prototype.s=function(U){return h(this.g),this.g.j?E(this,this.g.j.throw,U,this.g.o):(this.g.s(U),f(this))},o("Array.prototype.entries",function(U){return U||function(){return function(K,$){K instanceof String&&(K+="");var x=0,m=!1,y={next:function(){if(!m&&x<K.length){var b=x++;return{value:$(b,K[b]),done:!1}}return m=!0,{done:!0,value:void 0}}};return y[Symbol.iterator]=function(){return y},y}(this,function(K,$){return[K,$]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var I=function(U,K){for(var $=0;$<U.length;$++)K(U[$])},w=function(U){return U.replace(/\r?\n|\r/g,`\r
`)},O=function(U,K,$){return K instanceof Blob?($=$!==void 0?$+"":typeof K.name=="string"?K.name:"blob",K.name===$&&Object.prototype.toString.call(K)!=="[object Blob]"||(K=new File([K],$)),[String(U),K]):[String(U),String(K)]},A=function(U,K){if(U.length<K)throw new TypeError(K+" argument required, but only "+U.length+" present.")},N=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,k=N.FormData,V=N.XMLHttpRequest&&N.XMLHttpRequest.prototype.send,J=N.Request&&N.fetch,ut=N.navigator&&N.navigator.sendBeacon,dt=N.Element&&N.Element.prototype,Ct=N.Symbol&&Symbol.toStringTag;Ct&&(Blob.prototype[Ct]||(Blob.prototype[Ct]="Blob"),"File"in N&&!File.prototype[Ct]&&(File.prototype[Ct]="File"));try{new File([],"")}catch{N.File=function(K,$,x){return K=new Blob(K,x||{}),Object.defineProperties(K,{name:{value:$},lastModified:{value:+(x&&x.lastModified!==void 0?new Date(x.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ct&&Object.defineProperty(K,Ct,{value:"File"}),K}}var St=function(U){return U.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Gt=function(U){this.i=[];var K=this;U&&I(U.elements,function($){if($.name&&!$.disabled&&$.type!=="submit"&&$.type!=="button"&&!$.matches("form fieldset[disabled] *"))if($.type==="file"){var x=$.files&&$.files.length?$.files:[new File([],"",{type:"application/octet-stream"})];I(x,function(m){K.append($.name,m)})}else $.type==="select-multiple"||$.type==="select-one"?I($.options,function(m){!m.disabled&&m.selected&&K.append($.name,m.value)}):$.type==="checkbox"||$.type==="radio"?$.checked&&K.append($.name,$.value):(x=$.type==="textarea"?w($.value):$.value,K.append($.name,x))})};if((t=Gt.prototype).append=function(U,K,$){A(arguments,2),this.i.push(O(U,K,$))},t.delete=function(U){A(arguments,1);var K=[];U=String(U),I(this.i,function($){$[0]!==U&&K.push($)}),this.i=K},t.entries=function U(){var K,$=this;return v(U,function(x){if(x.h==1&&(K=0),x.h!=3)return K<$.i.length?x=p(x,$.i[K]):(x.h=0,x=void 0),x;K++,x.h=2})},t.forEach=function(U,K){A(arguments,1);for(var $=a(this),x=$.next();!x.done;x=$.next()){var m=a(x.value);x=m.next().value,m=m.next().value,U.call(K,m,x,this)}},t.get=function(U){A(arguments,1);var K=this.i;U=String(U);for(var $=0;$<K.length;$++)if(K[$][0]===U)return K[$][1];return null},t.getAll=function(U){A(arguments,1);var K=[];return U=String(U),I(this.i,function($){$[0]===U&&K.push($[1])}),K},t.has=function(U){A(arguments,1),U=String(U);for(var K=0;K<this.i.length;K++)if(this.i[K][0]===U)return!0;return!1},t.keys=function U(){var K,$,x,m,y=this;return v(U,function(b){if(b.h==1&&(K=a(y),$=K.next()),b.h!=3)return $.done?void(b.h=0):(x=$.value,m=a(x),p(b,m.next().value));$=K.next(),b.h=2})},t.set=function(U,K,$){A(arguments,2),U=String(U);var x=[],m=O(U,K,$),y=!0;I(this.i,function(b){b[0]===U?y&&(y=!x.push(m)):x.push(b)}),y&&x.push(m),this.i=x},t.values=function U(){var K,$,x,m,y=this;return v(U,function(b){if(b.h==1&&(K=a(y),$=K.next()),b.h!=3)return $.done?void(b.h=0):(x=$.value,(m=a(x)).next(),p(b,m.next().value));$=K.next(),b.h=2})},Gt.prototype._asNative=function(){for(var U=new k,K=a(this),$=K.next();!$.done;$=K.next()){var x=a($.value);$=x.next().value,x=x.next().value,U.append($,x)}return U},Gt.prototype._blob=function(){var U="----formdata-polyfill-"+Math.random(),K=[],$="--"+U+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(x,m){return typeof x=="string"?K.push($+St(w(m))+`"\r
\r
`+w(x)+`\r
`):K.push($+St(w(m))+'"; filename="'+St(x.name)+`"\r
Content-Type: `+(x.type||"application/octet-stream")+`\r
\r
`,x,`\r
`)}),K.push("--"+U+"--"),new Blob(K,{type:"multipart/form-data; boundary="+U})},Gt.prototype[Symbol.iterator]=function(){return this.entries()},Gt.prototype.toString=function(){return"[object FormData]"},dt&&!dt.matches&&(dt.matches=dt.matchesSelector||dt.mozMatchesSelector||dt.msMatchesSelector||dt.oMatchesSelector||dt.webkitMatchesSelector||function(U){for(var K=(U=(this.document||this.ownerDocument).querySelectorAll(U)).length;0<=--K&&U.item(K)!==this;);return-1<K}),Ct&&(Gt.prototype[Ct]="FormData"),V){var fe=N.XMLHttpRequest.prototype.setRequestHeader;N.XMLHttpRequest.prototype.setRequestHeader=function(U,K){fe.call(this,U,K),U.toLowerCase()==="content-type"&&(this.B=!0)},N.XMLHttpRequest.prototype.send=function(U){U instanceof Gt?(U=U._blob(),this.B||this.setRequestHeader("Content-Type",U.type),V.call(this,U)):V.call(this,U)}}J&&(N.fetch=function(U,K){return K&&K.body&&K.body instanceof Gt&&(K.body=K.body._blob()),J.call(this,U,K)}),ut&&(N.navigator.sendBeacon=function(U,K){return K instanceof Gt&&(K=K._asNative()),ut.call(this,U,K)}),N.FormData=Gt}})();let Jd=()=>{let t=T("AREAS");return t.length===0&&t.push(Wt.GLOBAL),Pi(t).call(t,(e,n,i)=>{let r=XO(n);return r?i===0?r:"".concat(e,",").concat(r):e},"")},XO=t=>t===Wt.OVERSEA?"".concat(Sn.ASIA,",").concat(Sn.EUROPE,",").concat(Sn.AFRICA,",").concat(Sn.NORTH_AMERICA,",").concat(Sn.SOUTH_AMERICA,",").concat(Sn.OCEANIA):Sn[t],DH=t=>{let e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(n=>{let i=Vh[n],r=Object.keys(i);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(i[o]))})}),e},Xh={GLOBAL:{ASIA:[Wt.CHINA,Wt.JAPAN,Wt.INDIA,Wt.KOREA,Wt.HKMC],EUROPE:[],NORTH_AMERICA:[Wt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Jh=Object.keys(Xh[Wt.GLOBAL]),Dg=[Wt.CHINA,Wt.NORTH_AMERICA,Wt.EUROPE,Wt.ASIA,Wt.JAPAN,Wt.INDIA,Wt.OCEANIA,Wt.SOUTH_AMERICA,Wt.AFRICA,Wt.KOREA,Wt.HKMC,Wt.US],PH=function(t,e){let n=[];if(B(t).call(t,Wt.GLOBAL)){let o=[Wt.GLOBAL,Wt.OVERSEA],s=Object.keys(Vh);if(e===Wt.GLOBAL)throw new D(C.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===Wt.CHINA)n=[Wt.OVERSEA];else if(r=e,B(Jh).call(Jh,r)){let a=(i=e,Xh[Wt.GLOBAL][i]||[]),c=[...o,e,...a];n=s.filter(d=>!B(c).call(c,d))}else if(function(a){let c=!1;return Jh.forEach(d=>{var l;B(l=Xh[Wt.GLOBAL][d]).call(l,a)&&(c=!0)}),c}(e)){let a=function(d){let l;return Jh.forEach(u=>{var h;B(h=Xh[Wt.GLOBAL][u]).call(h,d)&&(l=u)}),l}(e),c=[...o,a,e];n=s.filter(d=>!B(c).call(c,d))}else n=t;n=function(a){let c=[];return Dg.forEach(d=>{B(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!B(Dg).call(Dg,d)))}(n)}else n=t;var i,r;return n};function JO(t){var e,n;if(!t&&B(e=T("AREAS")).call(e,Wt.EXTENSIONS))return _.debug("update area from ap : reset"),void Pg(j4,!0);if(!B(n=T("AREAS")).call(n,Wt.GLOBAL)||!t)return;let i=Vh.EXTENSIONS;i&&(i={CODE:XO(Wt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),i),$t("AREAS",[Wt.EXTENSIONS],!0),Object.keys(i).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?$t(r,i[r][0]):$t(r,i[r])}))}function Pg(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=tt.reportApiInvoke(null,{name:me.SET_AREA,options:t,tag:re.TRACER});try{let i=[];if(typeof t=="string"&&(i=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!B(SO).call(SO,o))throw new D(C.INVALID_PARAMS,"invalid area code")}),i=t),Object.prototype.toString.call(t)==="[object Object]"){let{areaCode:o,excludedArea:s}=t;if(!o)throw new D(C.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),i=s?PH(a,s):a}if(!e){if(gi.AREAS){let o=new D(C.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void _.warning("setArea is prohibited because of config-distribute")}if(B(i).call(i,Wt.GLOBAL)&&T("AREAS")===Wt.EXTENSIONS){let o=new D(C.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void _.warning("setArea is prohibited because of ap extensions")}}$t("AREAS",i,e);let r=DH(i);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?$t(o,r[o][0]):$t(o,r[o])}),_.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}function QO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function to(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?QO(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):QO(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Lg=1;function LH(t,e,n,i,r){Lg+=1;let o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Lg,requestId:Lg,version:ki,cname:n.cname},s={service_name:e,json_body:JSON.stringify(o)},a,c,d=t[0];return Cr(async()=>{a=Date.now();let l=await wr(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){let p=new D(C.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw _.error(p.toString()),p}let u=JSON.parse(l.json_body);if(u.code!==200){let p=new D(C.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw _.error(p.toString()),p}if(!u.servers||u.servers.length===0){let p=new D(C.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw _.error(p.toString()),p}let h=function(p,S){return{addressList:p.servers.map(E=>"wss://".concat(E.address.replace(/\./g,"-"),".").concat(T("WORKER_DOMAIN"),":").concat(E.wss,"?serviceName=").concat(encodeURIComponent(S))),workerToken:p.workerToken,vid:p.vid}}(u,e);return T("LIVE_STREAMING_ADDRESS")&&(h.addressList=T("LIVE_STREAMING_ADDRESS")instanceof Array?T("LIVE_STREAMING_ADDRESS"):[T("LIVE_STREAMING_ADDRESS")]),to(to({},h),{},{responseTime:c})},(l,u)=>(tt.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:t[u%t.length]}),!1),(l,u)=>(tt.apworkerEvent(n.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:t[u%t.length]}),!!(l.code!==C.OPERATION_ABORTED&&l.code!==C.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=t[(u+1)%t.length],!0)),r)}let kg=1;function ZO(t,e,n,i){let{url:r,areaCode:o}=t,{clientId:s,sid:a}=e,c=Date.now(),d,l=e.role,[u,h]=Ug(e,o,[Le.CHOOSE_SERVER]),p=ve.networkState;return Cr(async()=>{p&&ve.networkState===kn.OFFLINE&&ve.onlineWaiter&&await Y.race([ve.onlineWaiter,Ye(i&&i.maxRetryTimeout||Pe.maxRetryTimeout)]),p=ve.networkState;let{data:S,headers:E}=await wr(r,{data:u,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=E.http3==="1"?1:-1,tt.reportResourceTiming(r,a),tN(S,r,e,c,[Le.CHOOSE_SERVER],d);let f=Hd(S,Le.CHOOSE_SERVER);return Mg(f),Rg(f,r)},S=>(S&&tt.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:h,serverList:S.gatewayAddrs.map(E=>E.address),ec:null,cid:S.cid.toString(),uid:S.uid.toString(),csIp:S.csIp,unilbsServerIds:[Le.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:S.res.detail&&S.res.detail[38],vid:S.vid}),!1),S=>S.code!==C.OPERATION_ABORTED&&(S.code===C.CAN_NOT_GET_GATEWAY_SERVER?S.data.retry:(tt.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:h,ec:S.code,csIp:S.data&&S.data.csIp,unilbsServerIds:[Le.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),_.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),S),!0)),i)}function $O(t,e,n,i){let r,{url:o,areaCode:s,serviceIds:a}=t,c=Date.now(),d=e.role,[l,u]=Ug(e,s,a),h;return Cr(async()=>{h&&ve.networkState===kn.OFFLINE&&ve.onlineWaiter&&await Y.race([ve.onlineWaiter,Ye(i&&i.maxRetryTimeout||Pe.maxRetryTimeout)]),h=ve.networkState;let{data:p,headers:S}=await wr(o,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=S.http3==="1"?1:-1,tt.reportResourceTiming(o,e.sid),tN(p,o,e,c,a,r);let E=Hd(p,Le.CHOOSE_SERVER),f=Hd(p,e.cloudProxyServer==="proxy5"?Le.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Le.CLOUD_PROXY:Le.CLOUD_PROXY_FALLBACK),R=performance.getEntriesByName(o),v=R[R.length-1],I;return v&&(I={name:v.name,protocol:"nextHopProtocol"in v?v.nextHopProtocol:"",dnscost:"domainLookupEnd"in v&&"domainLookupStart"in v&&typeof v.domainLookupEnd=="number"&&typeof v.domainLookupStart=="number"?v.domainLookupEnd-v.domainLookupStart:-1,tcpTlsCost:"connectEnd"in v&&"connectStart"in v&&typeof v.connectEnd=="number"&&typeof v.connectStart=="number"?v.connectEnd-v.connectStart:-1,reqCost:"requestStart"in v&&typeof v.requestStart=="number"&&"responseEnd"in v&&typeof v.responseEnd=="number"?v.responseEnd-v.requestStart:-1,handleCost:"leave_ts"in p&&"enter_ts"in p&&typeof p.leave_ts=="number"&&typeof p.enter_ts=="number"?p.leave_ts-p.enter_ts:-1}),Mg(E),{gatewayInfo:Rg(E,o),proxyInfo:f,url:o,resourceTimingInfo:I}},p=>{var S;return p.gatewayInfo&&tt.joinChooseServer(e.sid,{role:d,lts:c,succ:!0,csAddr:o,serverList:p.gatewayInfo.gatewayAddrs.map(E=>E.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:p.gatewayInfo.res.detail&&p.gatewayInfo.res.detail[38],vid:(S=p.gatewayInfo)===null||S===void 0?void 0:S.vid,resourceTimingInfo:p.resourceTimingInfo?JSON.stringify(p.resourceTimingInfo):void 0}),p.proxyInfo&&tt.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:p.proxyInfo.addresses.map(E=>E.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1},p=>p.code!==C.OPERATION_ABORTED&&(p.code===C.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(tt.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:p.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),p),!0)),i)}let tN=(t,e,n,i,r,o)=>{let{sid:s,clientId:a,cloudProxyServer:c}=n,d=[],l=u=>{u.flag===4096?tt.joinChooseServer(s,{role:n.role,lts:i,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o,corssRegionTagReq:n.apRequestDetail}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||tt.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()})};if(t.response_body.forEach(u=>{let h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{let p={error:new D(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:T("NO_EDGES_RETRY"),csIp:t.detail[502]}),flag:u.buffer.flag};d.push(p),l(p)}if(h!==0){let p=gc(h),S={error:new D(C.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:t.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?_.warning(S.error.toString()):d.push(S),l(S)}}),d.length)throw _.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new D(C.CAN_NOT_GET_GATEWAY_SERVER,d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!d.find(u=>u.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},Mg=t=>{var e,n,i,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new D(C.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(T("AP_AREA")&&((i=t.detail)!==null&&i!==void 0&&i[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?JO(t.detail[23].toLowerCase()):JO()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((n=t.detail)===null||n===void 0?void 0:n[19])=="string"){let s=t.detail[19],a=s?.split(";");for(let c=0;c<a.length;c++){var o;let d=Pn(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(T("GATEWAY_ADDRESS")&&T("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",T("GATEWAY_ADDRESS"));let s=T("GATEWAY_ADDRESS").map(a=>{var c,d;let l=(c=(d=t.addresses.find(u=>u.ip===a.ip&&u.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:a.fingerprint||l}});t.addresses=s}},kH=(t,e)=>{if(t.response_body&&t.response_body.length){let n=t.response_body[0];if(n.buffer.code!==0){let i=gc(n.buffer.code);throw new D(C.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new D(C.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Ug=(t,e,n)=>{let i=Math.floor(Math.random()*1e12),r=t.role==="host"?"1":t.role==="audience"?"2":void 0,o={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:to(to(to({6:t.stringUid,11:e,12:T("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};o.request_bodies.forEach(a=>{t.multiIP&&t.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});let s=new FormData;return s.append("request",JSON.stringify(o)),[s,i]},MH=(t,e)=>{let n=Math.floor(Math.random()*1e12),i={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]},Rc=0;function Cc(t){return Y.all(t.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}let Qd=async t=>{let{fragementLength:e,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=t,s=0,a=e,c,d=0,l=async()=>{let u=(()=>{let h=s*a,p=h+a;return n.slice(h,p).map(i)})();o&&o.push(...u);try{c=await Cc(u)}catch(h){if(d+=a,s++,!(d>=n.length))return void await l();r(h)}u.forEach(h=>h.cancel())};return await l(),c},eN=async t=>{let{referenceList:e,asyncMapHandler:n,closeFn:i}=t,r=e.length,o=0,s=async()=>{let a=n(e.shift());try{return await a}catch(c){if(o++,o>=r||i!=null&&i(c))throw c;return s()}};return s()};async function UH(){if(typeof VideoDecoder>"u")return!0;let t,e=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],o=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],s=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new Y((c,d)=>{let l;(async function(){t&&t.state!=="closed"||await async function(){t=new VideoDecoder({output:h=>{h.close(),clearTimeout(l),c(!0)},error:h=>{clearTimeout(l),c(!1)}}),await t.configure({codec:"av01.0.05M.08",width:160,height:90})}();let u=[e,n,i,r,o,s];for(let h=0;h<u.length;h++){let p=new EncodedVideoChunk({type:h==0?"key":"delta",timestamp:33333*h,duration:33333,data:new Uint8Array(u[h])});try{await t.decode(p)}catch{return void c(!1)}}})(),l=setTimeout(()=>{c(!1)},5e3)})}async function Qh(t,e,n,i){return{gatewayInfo:await async function(o,s,a,c){let d=null,l=[],u=async()=>{let p=T("WEBCS_DOMAIN").slice(0,T("AJAX_REQUEST_CONCURRENT")).map(f=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Jd()})),S=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=await Qd({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(o.clientId,"] Connect to choose_server:"),f.url),ZO(f,o,s,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},S),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},S),E},h=async()=>{if(await Ye(1e3),d!==null)return d;let p=T("WEBCS_DOMAIN_BACKUP_LIST").map(f=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Jd()})),S=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=await Qd({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),f.url),ZO(f,o,s,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},S),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},S),E};try{return d=await Cc([u(),h()]),l.length&&l.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),d}catch(p){throw p[0]}}(t,e,n,i)}}async function nN(t,e,n,i,r){let o=t.cloudProxyServer;if(o==="disabled"){if(!i)return;if(t.useLocalAccessPoint)return await Qh(t,e,n,r);if(T("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:h,proxyInfo:p}=await oN(t,e,n,r);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:h};let S=p.map(E=>({turnServerURL:E.address,tcpport:E.tcpport||_n.tcpport,udpport:E.udpport||_n.udpport,username:E.username||_n.username,password:E.password||_n.password,forceturn:!1,security:!0}));if(r.useP2P){var s;let E=(s=t.uid)!==null&&s!==void 0?s:h.uid,f="glb:".concat(E.toString()),R=await gf(f),v=p.map(I=>({turnServerURL:I.address,tcpport:I.tcpport||_n.tcpport,udpport:I.udpport||_n.udpport,username:f,password:R,forceturn:!1,security:!0}));S.push(...v)}return t.turnServer={mode:"manual",servers:S},{gatewayInfo:h}}return await Qh(t,e,n,r)}let{proxyInfo:a,gatewayInfo:c}=await oN(t,e,n,r),d={gatewayInfo:c},l=a.map(h=>({turnServerURL:h.address,tcpport:o==="proxy3"?void 0:h.tcpport?h.tcpport:_n.tcpport,udpport:o==="proxy4"?void 0:h.udpport?h.udpport:_n.udpport,username:h.username||_n.username,password:h.password||_n.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var u;let h=(u=t.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),S=await gf(p),E=a.map(f=>({turnServerURL:f.address,tcpport:o==="proxy3"?void 0:f.tcpport||_n.tcpport,udpport:o==="proxy4"?void 0:f.udpport||_n.udpport,username:p,password:S,forceturn:o!=="proxy4",security:o==="proxy5"}));l.push(...E)}return t.turnServer={mode:"manual",servers:l},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),d}async function iN(t,e,n,i,r){let o=T("ACCOUNT_REGISTER").slice(0,T("AJAX_REQUEST_CONCURRENT")),s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));let a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{let c=await async function(d,l,u,h,p){let S=Date.now(),E={sid:u.sid,opid:10,appid:u.appId,string_uid:l},f=d[0],R=await Cr(()=>wr(f+"".concat(f.indexOf("?")===-1?"?":"&","action=stringuid"),{data:E,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(v,I)=>{if(v.code===0){if(v.uid<=0||v.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(v.uid),v),tt.reqUserAccount(E.sid,{lts:S,success:!1,serverAddr:f,stringUid:E.string_uid,uid:v.uid,errorCode:C.INVALID_UINT_UID_FROM_STRING_UID,extend:E}),new D(C.INVALID_UINT_UID_FROM_STRING_UID);return tt.reqUserAccount(E.sid,{lts:S,success:!0,serverAddr:f,stringUid:E.string_uid,uid:v.uid,errorCode:null,extend:E}),!1}let w=gc(v.code);return w.retry&&(f=d[(I+1)%d.length]),tt.reqUserAccount(E.sid,{lts:S,success:!1,serverAddr:f,stringUid:E.string_uid,uid:v.uid,errorCode:w.desc,extend:E}),w.retry},(v,I)=>v.code!==C.OPERATION_ABORTED&&(tt.reqUserAccount(E.sid,{lts:S,success:!1,serverAddr:f,stringUid:E.string_uid,uid:null,errorCode:v.code,extend:E}),f=d[(I+1)%d.length],!0),p);if(R.code!==0){let v=gc(R.code);throw new D(C.UNEXPECTED_RESPONSE,v.desc)}return R}(s,t,e,n,i);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function xH(t,e,n){let i=T("ACCOUNT_REGISTER"),r=[];r=e.proxyServer?i.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):i.map(o=>"https://".concat(o,"/api/v1"));try{return await eN({referenceList:r,asyncMapHandler:s=>async function(a,c,d,l){let u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{let p=await wr(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){let S=gc(p.code);throw new D(C.UNEXPECTED_RESPONSE,"preload sua error:".concat(S.desc),S)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new D(C.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}}(s,t,e,n),closeFn:s=>s.code===C.OPERATION_ABORTED||s.code===C.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}async function VH(t,e,n){let i=T("CDS_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=i.map(c=>function(d,l,u,h){let p=Vt(),S={flag:64,cipher_method:0,features:to(to(to(to(to({install_id:Df(),device:p.name,system:p.os,system_general:navigator.userAgent,vendor:l.appId,version:ki,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:wH.WEB_RTC,browser_name:p.name,browser_version:p.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),p.os&&{os_name:p.os}),p.osVersion&&{os_version:p.osVersion}),{},{detail:""})};return Cr(()=>wr(d,{data:S,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,E=>E.code!==C.OPERATION_ABORTED,h)}(c,t,e,n)),o=null,s=null,a={};try{o=await Cc(r)}catch(c){if(c.code===C.OPERATION_ABORTED)throw c;s=c}if(r.forEach(c=>c.cancel()),tt.reportApiInvoke(t.sid,{name:me.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return{};let d=c.test_tags,l=Object.keys(d),u={};return l.forEach(h=>{var p;let S=Pn(p=h.slice(4)).call(p),E=JSON.parse(d[h]),f=E[1];u[S]={tag:E[0]||"",value:f}}),u}(o)}catch{}return a}async function rN(t,e){let n=T("WEBCS_DOMAIN").concat(T("WEBCS_DOMAIN_BACKUP_LIST")).map(i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:Jd(),serviceIds:[Le.CHOOSE_SERVER,Le.CLOUD_PROXY_FALLBACK]}));try{return await eN({referenceList:n,asyncMapHandler:r=>async function(o,s,a){let c,{url:d,areaCode:l,serviceIds:u}=o,h=Date.now(),[p,S]=Ug(s,l,u),E=ve.networkState;try{E&&ve.networkState===kn.OFFLINE&&ve.onlineWaiter&&await Y.race([ve.onlineWaiter,Ye(Pe.maxRetryTimeout)]),E=ve.networkState;let{data:f,headers:R}=await wr(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=R.http3==="1"?1:-1,(O=>{let A=[];if(O.response_body.forEach(N=>{let k=N.buffer.code;if(N.uri===23&&k===0&&!N.buffer.edges_services)if(N.buffer.flag===4194310)N.buffer.edges_services=[];else{let V={error:new D(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:T("NO_EDGES_RETRY"),csIp:O.detail[502]}),flag:N.buffer.flag};A.push(V)}if(k!==0){let V=gc(k),J={error:new D(C.CAN_NOT_GET_GATEWAY_SERVER,V.desc,{desc:V.desc,retry:V.retry,csIp:O.detail[502]}),flag:N.buffer.flag};N.buffer.flag===4194310?_.warning(J.error.toString()):A.push(J)}}),A.length)throw new D(C.CAN_NOT_GET_GATEWAY_SERVER,A.map(N=>"flag: ".concat(N.flag,", message: ").concat(N.error.message)).join(" | "),{retry:!!A.find(N=>N.error.data.retry),csIp:O.detail[502],desc:[...new Set(A.map(N=>{var k;return N==null||(k=N.error)===null||k===void 0||(k=k.data)===null||k===void 0?void 0:k.desc}).filter(N=>!!N))]})})(f);let I=Hd(f,Le.CHOOSE_SERVER),w=Hd(f,Le.CLOUD_PROXY_FALLBACK);return Mg(I),{gatewayInfo:Rg(I,d),proxyInfo:w,opid:S,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(f){throw f}}(r,t,e),closeFn:r=>r.code===C.OPERATION_ABORTED||r.code===C.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function oN(t,e,n,i){let r=T("PROXY_SERVER_TYPE3"),o=(p,S,E)=>{let f=E||r;return Array.isArray(f)&&(f=S%2==0&&r[1]||r[0]),"https://".concat(f,"/ap/?url=").concat(p)},s=null,a=[],c=async()=>{let p=T("WEBCS_DOMAIN").slice(0,T("AJAX_REQUEST_CONCURRENT")).map((f,R)=>{let v;return v=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:v,areaCode:Jd(),serviceIds:[Le.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Le.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Le.CLOUD_PROXY:Le.CLOUD_PROXY_FALLBACK]}}),S=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=await Qd({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),f.url),$O(f,t,e,n)),allFailedhandler:f=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},S),f[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},S),E},d=async()=>{if(await Ye(1e3),s!==null)return s;let p=T("WEBCS_DOMAIN_BACKUP_LIST").map((f,R)=>{let v;return v=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:v,areaCode:Jd(),serviceIds:[Le.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Le.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Le.CLOUD_PROXY:Le.CLOUD_PROXY_FALLBACK]}}),S=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=await Qd({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),f.url),$O(f,t,e,n)),allFailedhandler:f=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},S),f[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},S),E},l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await Cc([c(),d()]))}catch(p){throw p[0]}if(a.length&&a.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),!l||!u)throw new D(C.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=h,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){let p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];B(r).call(r,p)&&(t.proxyServer=p,_.setProxyServer(p),tt.setProxyServer(p))}return s={gatewayInfo:l,proxyInfo:await OO(u,l.uid)},s}async function FH(t,e,n){let i=T("UAP_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),r=i.map(o=>function(s,a,c,d){let l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:ki,cname:a.cname,uid:a.uid.toString(),requestId:kg,seq:kg};kg+=1;let u={service_name:"tele_channel",json_body:JSON.stringify(l)};return Cr(async()=>{let h=await wr(s,{data:u,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(h.code!==0){let S=new D(C.UNEXPECTED_RESPONSE,"cross channel ap error, code"+h.code,{retry:!0});throw _.error(S.toString()),S}let p=JSON.parse(h.json_body);if(p.code!==200){let S=new D(C.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw _.error(S.toString()),S}if(!p.servers||p.servers.length===0){let S=new D(C.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(S.toString()),S}return{vid:p.vid,workerToken:p.workerToken,addressList:(T("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(S=>"wss://".concat(S.address.replace(/\./g,"-"),".").concat(T("WORKER_DOMAIN"),":").concat(S.wss))}},void 0,h=>!!(h.code!==C.OPERATION_ABORTED&&h.code!==C.UNEXPECTED_RESPONSE||h.data&&h.data.retry),d)}(o,t,e,n));try{let o=await Cc(r);return r.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}async function BH(t,e,n){let i=null,r=[],o=async s=>{let a=T(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await Ye(1e3),i!==null)?i:await Qd({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,l,u,h){let[p]=MH(l,[Le.CHOOSE_SERVER]),S=ve.networkState;return Cr(async()=>{S&&ve.networkState===kn.OFFLINE&&ve.onlineWaiter&&await Y.race([ve.onlineWaiter,Ye(h&&h.maxRetryTimeout||Pe.maxRetryTimeout)]),S=ve.networkState;let E=await wr(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return kH(E,d)},()=>!1,E=>E.code!==C.OPERATION_ABORTED&&(E.code===C.UPDATE_TICKET_FAILED?E.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),E),!0)),h)}(c,t,e,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await Cc([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),i}catch(s){throw s[0]}}function sN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function xg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?sN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):sN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class jH extends ge{get isSuccess(){return!!this.configs}constructor(e,n){super(),g(this,"configs",void 0),g(this,"store",void 0),g(this,"joinInfo",void 0),g(this,"cancelToken",void 0),g(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),g(this,"interval",void 0),g(this,"mutex",void 0),g(this,"mutableParamsRead",!1),g(this,"configCache",{}),g(this,"limit_bitrate",void 0),this.mutex=new tn("config-distribute",e),this.store=n}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),T("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},T("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,tt.reportApiInvoke(null,{options:void 0,name:me.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:re.TRACER}).onSuccess(JSON.stringify(gi))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let e,n=await this.mutex.lock();try{e=await VH(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(e));let i=function(r){var o;let s=Cs(o=Object.keys(r).filter(d=>/^webrtc_ng_global_parameter/.test(d))).call(o);for(let d=0;d<s.length;d++)for(let l=s.length-1;l>d;l--){let u=s[l],h=r[u].value;if(typeof h.__priority=="number"){let p=h.__priority,S=s[l-1],E=r[S].value;if(typeof E.__priority=="number"){if(!(p>E.__priority))continue;{let f=u;s[l]=s[l-1],s[l-1]=f}}else{let f=u;s[l]=s[l-1],s[l-1]=f}}}let a=Date.now(),c={};return s.forEach(d=>{let l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])}),c}(e);this.cacheGlobalParameterConfig(i),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=i}catch(i){let r=new D(C.NETWORK_RESPONSE_ERROR,i);_.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){TO(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(Ir.UPDATE_BITRATE_LIMIT,e):this.emit(Ir.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&xg({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{let n={},i=Object.keys(e),r=[];i.forEach(o=>{let s=e[o].value;n[o]=s;let a=s.__id;if(a&&this.configCache[o]&&this.configCache[o].__id===a)return;let c=s.__type,d=e[o].value,l=e[o].tag,u=0;c?c===Fb.REALTIME&&(u=1):Object.keys(d).some(h=>Object.prototype.hasOwnProperty.call(Mf,h)||!dg()&&Object.prototype.hasOwnProperty.call(_h,h)?(u=1,!0):void 0),r.push({tag:l,isApplied:u,feature:o,params:JSON.stringify(s)})}),r.forEach(o=>{let{tag:s,feature:a,params:c,isApplied:d}=o;this.store.sessionId&&tt.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:s,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=n}catch(n){_.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(e){let n=function(r){let o={};return Object.keys(r).forEach(s=>{let a=r[s].value,c=a.__expires,d=a.__type;Object.keys(a).forEach(l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(o,l)||(o[l]=xg(xg({value:a[l]},c&&{expires:c}),d&&{type:d}))})}),o}(e);try{var i;let r=(i=n.LIMIT_BITRATE)===null||i===void 0?void 0:i.value;delete n.LIMIT_BITRATE,r&&TO(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(e),function(a){try{let c=Date.now();Object.keys(a).forEach(d=>{let{value:l,type:u,expires:h}=a[d];h&&h<=c||((u===Fb.REALTIME||Object.prototype.hasOwnProperty.call(Mf,d))&&(gi[d]=l,zt[d]=l,_.debug("Update realtime parameters from config distribute",d,l)),u||dg()||!Object.prototype.hasOwnProperty.call(_h,d)||(gi[d]=l,zt[d]=l,_.debug("Update gateway parameters from config distribute",d,l)))})}catch(c){_.error("Error update config immediately: ".concat(a),c.message)}}(n);let o=JSON.stringify(n),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),_.debug("Caching global parameters ".concat(o))}catch(r){_.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(e){try{let n=Date.now();Object.keys(e).forEach(i=>{switch(i){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(zt,i)){let{value:o,expires:s}=e[i];if(s&&s<=n)return;vf(zt[i],o)||(gi[i]=o,zt[i]=o,this.emit(Ir.UPDATE_CLIENT_ROLE_OPTIONS,o),_.debug("Updating client role options: ".concat(JSON.stringify(o))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(zt,i)){var r;let{value:o,expires:s}=e[i];if(s&&s<=n)return;typeof o=="number"&&B(r=[0,1,4,5,6,7,8,9]).call(r,o)&&(gi[i]={value:o},zt[i]=o,this.emit(Ir.UPDATE_REMOTE_VIDEO_STREAM_TYPE,o),_.debug("Updating client remote stream type: ".concat(JSON.stringify(o))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(zt,i)){let{value:o,expires:s}=e[i];if(s&&s<=n)return;vf(zt[i],o)||(gi[i]=o,zt[i]=o,this.emit(Ir.FALLBACK_TO_HLS,o),_.debug("Updating enable force hls: ".concat(JSON.stringify(o))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(zt,i)){let{value:o,expires:s}=e[i];if(s&&s<=n)return;vf(zt[i],o)||(gi[i]=o,zt[i]=o,this.emit(Ir.UPDATE_VOS_CONFIGURE,o),_.debug("Updating vos configure: ".concat(JSON.stringify(o))))}}})}catch(n){_.error("Error handling global parameter config:",n.message)}}}class GH extends ge{constructor(){super(...arguments),g(this,"resultStorage",new Map)}setLocalAudioStats(e,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(e,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i)),!n.muted&&this.record("VIDEO_ENCODE_FAILED",e,this.checResolutionSent(i))}setRemoteAudioStats(e,n){let i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){let i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(e,n,i){if(T("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});let r=this.resultStorage.get(e);if(!r)return;r.result.push(i);let o=e==="VIDEO_ENCODE_FAILED"?T("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=o){var s;let a=B(s=r.result).call(s,!0);r.isPrevNormal&&!a&&this.emit("exception",Vg[e],e,n),!r.isPrevNormal&&a&&this.emit("exception",Vg[e]+2e3,e+"_RECOVER",n),r.isPrevNormal=a,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof Be&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=Yn(n._encoderConfig.frameRate));let r=e.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checResolutionSent(e){var n;return!(!e.codecType||B(n=T("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(n,e.codecType.toLocaleLowerCase()))||!e.captureFrameRate||e.sendFrameRate!==0||e.sendResolutionWidth!==0||e.sendResolutionHeight!==0}checkSendVideoBitrate(e,n){return!!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof Be&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}let Vg={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},Tn=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){let n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){let i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(t,e){let n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){let i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function aN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Qs(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?aN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class Zd{constructor(e){g(this,"store",void 0),g(this,"onStatsException",void 0),g(this,"onUploadPublishDuration",void 0),g(this,"onStatsChanged",void 0),g(this,"onVideoCodecChanged",void 0),g(this,"localStats",new Map),g(this,"remoteStats",new Map),g(this,"updateStatsInterval",void 0),g(this,"trafficStats",void 0),g(this,"trafficStatsPeerList",[]),g(this,"uplinkStats",void 0),g(this,"exceptionMonitor",void 0),g(this,"p2pChannel",void 0),g(this,"scalabilityMode",hh.L1T1),g(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new GH,this.exceptionMonitor.on("exception",(n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(j.LocalAudioTrack)||Qs({},jf)}getLocalVideoTrackStats(){return this.localStats.get(j.LocalVideoTrack)||Qs({},Gf)}getRemoteAudioTrackStats(e){let n=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(i[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRemoteNetworkQualityStats(e){let n={};if(e){var i;let r=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.networkStats;r&&(n[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(n[o]=s)});return n}getNetworkQuality(){let e=0,n=0;return this.trafficStats&&(e=Gh(this.trafficStats.B_unq),n=Gh(this.trafficStats.B_dnq)),{uplinkNetworkQuality:e,downlinkNetworkQuality:n}}getRemoteVideoTrackStats(e){let n=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},i={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(i[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRTCStats(){let e=0,n=0,i=0,r=0,o=this.localStats.get(j.LocalAudioTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);let s=this.localStats.get(j.LocalVideoTrack);s&&(e+=s.sendBytes,n+=s.sendBitrate);let a=this.localStats.get(j.LocalVideoLowTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),u&&(i+=u.receiveBytes,r+=u.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:e,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),e.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var i;let r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),o=r!=null&&r.videoSSRC?Tn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?Tn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,i){if(!e)return!1;let r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,o=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[i,r]=n;switch(i){case j.LocalVideoTrack:case j.LocalVideoLowTrack:{let a=r,c=Qs({},Gf),d=e.getStats(),l=e.getLocalMedia(i);if(d){let u=d.videoSend.find(h=>h.ssrc===l?.ssrcs[0].ssrcId);if(u){let h=e.getLocalVideoSize(),p=e.getEncoderConfig(j.LocalVideoTrack);var o;(u.codec==="H264"||u.codec==="H265"||u.codec==="VP8"||u.codec==="VP9"||u.codec==="AV1X"||u.codec==="AV1")&&(c.codecType=u.codec,a?.codecType!==u.codec&&((o=this.onVideoCodecChanged)===null||o===void 0||o.call(this,u.codec.toLocaleLowerCase()))),c.sendBytes=u.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,u.inputFrame?(c.captureFrameRate=u.inputFrame.frameRate,c.captureResolutionHeight=u.inputFrame.height,c.captureResolutionWidth=u.inputFrame.width):h&&(c.captureResolutionWidth=h.width,c.captureResolutionHeight=h.height),u.sentFrame?(c.sendFrameRate=u.sentFrame.frameRate,c.sendResolutionHeight=u.sentFrame.height,c.sendResolutionWidth=u.sentFrame.width):h&&(c.sendResolutionWidth=h.width,c.sendResolutionHeight=h.height),u.avgEncodeMs&&(c.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax?c.targetSendBitrate=1e3*p.bitrateMax:u.targetBitrate&&(c.targetSendBitrate=u.targetBitrate),c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(c.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(i,c),(a?.sendResolutionWidth!==c.sendResolutionWidth||a?.sendResolutionHeight!==c.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&l&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,l.track,c);break}case j.LocalAudioTrack:{let a=r,c=Qs({},jf),d=e.getStats(),l=e.getLocalMedia(i);if(d){let u=d.audioSend.find(h=>h.ssrc===l?.ssrcs[0].ssrcId);if(u){if(u.codec!=="opus"&&u.codec!=="aac"&&u.codec!=="PCMU"&&u.codec!=="PCMA"&&u.codec!=="G722"||(c.codecType=u.codec),u.inputLevel)c.sendVolumeLevel=Math.round(32767*u.inputLevel);else{let h=e.getLocalAudioVolume();h&&(c.sendVolumeLevel=Math.round(32767*h))}c.sendBytes=u.bytes,c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(j.LocalAudioTrack,c),c&&l&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,l.track,c);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var i,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=n,d=a,l=s,u=c,h=Qs({},$b),p=Qs({},t0),S=Qs({},b4),{audioTrack:E,videoTrack:f,audioSSRC:R,videoSSRC:v}=e.getRemoteMedia(o),I;I=this.store.useP2P?e.getStats(!0):e.getStats();let w=(i=I)===null||i===void 0?void 0:i.audioRecv.find(k=>k.ssrc===R),O=(r=I)===null||r===void 0?void 0:r.videoRecv.find(k=>k.ssrc===v),A=this.trafficStats&&this.trafficStats.peer_delay.find(k=>k.peer_uid===o);if(w&&(w.codec!=="opus"&&w.codec!=="aac"&&w.codec!=="PCMU"&&w.codec!=="PCMA"&&w.codec!=="G722"||(h.codecType=w.codec),w.outputLevel?h.receiveLevel=Math.round(32767*w.outputLevel):E&&(h.receiveLevel=Math.round(32767*E.getVolumeLevel())),h.receiveBytes=w.bytes,h.receivePackets=w.packets,h.receivePacketsLost=w.packetsLost,h.receivePacketsDiscarded=w.packetsDiscarded,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=w.jitterBufferMs,h.totalDuration>10&&Zd.isRemoteAudioFreeze(E)&&(h.totalFreezeTime+=1)),O){var N;O.codec!=="H264"&&O.codec!=="H265"&&O.codec!=="VP8"&&O.codec!=="VP9"&&O.codec!=="AV1X"&&O.codec!=="AV1"||(p.codecType=O.codec),p.receiveBytes=O.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,p.renderFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,O.outputFrame&&(p.renderFrameRate=O.outputFrame.frameRate),O.receivedFrame?(p.receiveFrameRate=O.receivedFrame.frameRate,p.receiveResolutionHeight=O.receivedFrame.height,p.receiveResolutionWidth=O.receivedFrame.width):f&&(p.receiveResolutionHeight=f._videoHeight||0,p.receiveResolutionWidth=f._videoWidth||0),O.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(O.framesRateFirefox)),p.receivePackets=O.packets,p.receivePacketsLost=O.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost);let k=l?l.totalFreezeTime:0,V=l?l.totalDuration:0;p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=(N=O.totalFreezesDuration)!==null&&N!==void 0?N:k||0,p.receiveDelay=O.jitterBufferMs||0;let J=!!v&&e.getRemoteVideoIsReady(v);O.totalFreezesDuration===void 0&&f&&J&&Zd.isRemoteVideoFreeze(f,O,u)&&(p.totalFreezeTime+=1),p.freezeRate=Math.max(0,Math.min((p.totalFreezeTime-k)/(p.totalDuration-V),1))}A&&(h.end2EndDelay=A.B_ad,p.end2EndDelay=A.B_vd,h.transportDelay=A.B_ed,p.transportDelay=A.B_ed,h.currentPacketLossRate=A.B_ealr4/100,p.currentPacketLossRate=A.B_evlr4/100,S.uplinkNetworkQuality=A.B_punq?A.B_punq:0,S.downlinkNetworkQuality=A.B_pdnq?A.B_pdnq:0),this.remoteStats.set(o,{audioStats:h,videoStats:p,videoPcStats:O,networkStats:S}),E&&this.exceptionMonitor.setRemoteAudioStats(E,h),f&&this.exceptionMonitor.setRemoteVideoStats(f,p)})}}class cN{constructor(){g(this,"destChannelMediaInfos",new Map),g(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){gO(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){gO(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Mh(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function dN(t){if(!(t instanceof cN))return new D(C.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();if(!e)return new D(C.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new D(C.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class $o{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){g(this,"uid",void 0),g(this,"_uintid",void 0),g(this,"_trust_in_room_",!0),g(this,"_trust_audio_enabled_state_",!0),g(this,"_trust_video_enabled_state_",!0),g(this,"_trust_audio_mute_state_",!0),g(this,"_trust_video_mute_state_",!0),g(this,"_audio_muted_",!1),g(this,"_video_muted_",!1),g(this,"_audio_enabled_",!0),g(this,"_video_enabled_",!0),g(this,"_audio_added_",!1),g(this,"_video_added_",!1),g(this,"_is_pre_created",!1),g(this,"_video_pre_subscribed",!1),g(this,"_audio_pre_subscribed",!1),g(this,"_trust_video_stream_added_state_",!0),g(this,"_trust_audio_stream_added_state_",!0),g(this,"_audioTrack",void 0),g(this,"_videoTrack",void 0),g(this,"_dataChannels",[]),g(this,"_audioSSRC",void 0),g(this,"_videoSSRC",void 0),g(this,"_audioOrtc",void 0),g(this,"_videoOrtc",void 0),g(this,"_cname",void 0),g(this,"_rtxSsrcId",void 0),g(this,"_videoMid",void 0),g(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}function lN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Fg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let WH=t=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(t?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),Zh="9",Bg=2e4,$h=4e4,uN=class{get localCapabilities(){return he(this._localCapabilities)}get rtpCapabilities(){return he(this._rtpCapabilities)}get candidates(){return he(this._candidates)}get iceParameters(){return he(this._iceParameters)}get dtlsParameters(){return he(this._dtlsParameters)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3];g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_originCandidates",void 0),g(this,"_iceParameters",void 0),g(this,"_isUseExtmapAllowMixed",void 0),g(this,"_isUseLocalCodecs",void 0),g(this,"_isUseDataChannel",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),g(this,"useLocalCodecsMids",[]),g(this,"preloadSsrcs",[]),g(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=e,this._isUseLocalCodecs=n,this._isUseDataChannel=i,t=he(t);let{iceParameters:r,dtlsParameters:o,candidates:s,rtpCapabilities:a,setup:c,localCapabilities:d,cname:l}=t;this._rtpCapabilities=a,this._candidates=s,this._originCandidates=he(s),this._iceParameters=r,this._dtlsParameters=o,this._localCapabilities=d,this.setup=c,this.cname=l,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(t){return t.length===this.preloadSsrcs.length&&t.every(e=>{var n;return B(n=this.preloadSsrcs).call(n,e)})}preloadRemoteMedia(t){let e=0,n=[],i=[];for(;t>0;){let r=[Fg({ssrcId:$h+e},T("USE_SUB_RTX")?{rtx:$h+e+1}:{})],o="".concat($h+e,"_").concat(Bg+e),{ssrcs:s,ssrcGroups:a}=qd(r,this.cname,T("SYNC_GROUP")?o:void 0),c=this.preCreateOrRecycleSendMedia("video",s,a,void 0),d=[{ssrcId:Bg+e}],l="".concat($h+e,"_").concat(Bg+e),{ssrcs:u,ssrcGroups:h}=qd(d,this.cname,T("SYNC_GROUP")?l:void 0),p=this.preCreateOrRecycleSendMedia("audio",u,h,void 0);t--,e+=2,n.push(c,p),i.push(s[0].ssrcId,u[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=i,{mids:n,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(t,e,n,i){let r=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;_.debug("create or recycle send media without remote rtp capabilities, ssrcs ",e[0].ssrcId);let s=t===Z.VIDEO?o.videoCodecs:o.audioCodecs,a=t===Z.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;let c="".concat(this.currentMidIndex),d={media:{mediaType:t,port:Zh,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map(l=>l.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};return d=this.mungSendMediaDesc(d,i),this.sessionDesc.mediaDescriptions.push(d),this.updateBundleMids(),c}toString(){return To(this.sessionDesc)}send(t,e,n,i){let{ssrcs:r,ssrcGroups:o}=qd(e,this.cname,T("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(r);if(s){if(ue()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){let a=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{let a=this.findAvailableMediaIndex(t,r),c;return a===-1||a===1&&($e()||function(){let d=Vt();return!(d.name!==jt.CHROME||!d.osVersion)&&Number(d.version)<=90}()||Rr(143)||Ho(143)||T("RESERVE_MID_1_MLINE")||T("ENABLE_ENCODED_TRANSFORM")&&go())||a===0&&!function(d){let l=Vt();return!(l.name!==jt.FIREFOX||!l.osVersion)&&Number(l.version)===d}(138)&&T("USE_SUB_RTX")||sb()?(c=this.createOrRecycleSendMedia(t,r,o,"sendonly",i),this.updateBundleMids()):(c=he(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,i)),ue()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:t,needExchangeSDP:e}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:t.attributes.mid,needExchangeSDP:e}}batchSend(t){let e=t.map(r=>{let{kind:o,ssrcMsg:s,mslabel:a}=r;return this.send(o,s,a)}),n=[],i=!1;return e.forEach(r=>{let{mid:o,needExchangeSDP:s}=r;s&&(i=!0),n.push(o)}),{mids:n,needExchangeSDP:i}}stopSending(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.mid==="0"||ue()||sb()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")}),this.updateBundleMids()}mute(t){let e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){let e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>B(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>B(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}receive(t,e,n,i){t.forEach((r,o)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",e,n,i[o])}),this.updateBundleMids()}stopReceiving(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(t){let e=this.sessionDesc||Mn((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?WH(n):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var n;this._rtpCapabilities=t;let i=!1,r=this.rtpCapabilities.send,o=this.localCapabilities.send,s=this.localCapabilities.recv,a=s.videoCodecs,c=s.audioCodecs,d=s.videoExtensions,l=s.audioExtensions;for(let S of e.mediaDescriptions){var u;if(S.attributes.direction!=="sendonly"||typeof S.attributes.mid!="string"||!B(u=this.useLocalCodecsMids).call(u,S.attributes.mid)){if(i=!0,S.attributes.iceUfrag=this._iceParameters.iceUfrag,S.attributes.icePwd=this._iceParameters.icePwd,S.attributes.fingerprints=this._dtlsParameters.fingerprints,S.attributes.candidates=this._candidates,S.attributes.setup=this.setup,S.media.mediaType==="application"&&(S.attributes.sctpPort="5000"),S.media.mediaType==="video")if(this._isUseLocalCodecs&&S.attributes.direction==="sendonly"){var h;S.media.fmts=a.map(f=>f.payloadType.toString(10)),S.attributes.payloads=a,S.attributes.extmaps=d;let E=S.attributes.mid;typeof E!="string"||B(h=this.useLocalCodecsMids).call(h,E)||this.useLocalCodecsMids.push(E)}else if(r.videoCodecs.length===0){let E=o.videoCodecs.filter(f=>{var R,v;return(R=f.rtpMap)===null||R===void 0?void 0:B(v=R.encodingName.toLowerCase()).call(v,"vp8")});E.length===0&&E.push(o.videoCodecs[0]),S.media.fmts=E.map(f=>f.payloadType.toString(10)),S.attributes.payloads=E,S.attributes.extmaps=[]}else S.media.fmts=r.videoCodecs.map(E=>E.payloadType.toString(10)),S.attributes.payloads=r.videoCodecs,S.attributes.extmaps=r.videoExtensions;if(S.media.mediaType==="audio")if(this._isUseLocalCodecs&&S.attributes.direction==="sendonly"){var p;S.media.fmts=c.map(f=>f.payloadType.toString(10)),S.attributes.payloads=c,S.attributes.extmaps=l;let E=S.attributes.mid;typeof E!="string"||B(p=this.useLocalCodecsMids).call(p,E)||this.useLocalCodecsMids.push(E)}else if(r.audioCodecs.length===0){let E=o.audioCodecs.filter(f=>{var R,v;return(R=f.rtpMap)===null||R===void 0?void 0:B(v=R.encodingName.toLowerCase()).call(v,"opus")})||[o.audioCodecs[0]];S.media.fmts=E.map(f=>f.payloadType.toString(10)),S.attributes.payloads=E,S.attributes.extmaps=[]}else S.media.fmts=r.audioCodecs.map(E=>E.payloadType.toString(10)),S.attributes.payloads=r.audioCodecs,S.attributes.extmaps=r.audioExtensions,Tc(S)}}return this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(t){let e=this._originCandidates.filter(i=>i.transport==="udp"),n=[];if(e.forEach(i=>{n.push(Fg(Fg({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),e.length!==0){switch(t){case en.TCP_RELAY:this._candidates=n;break;case en.UDP_TCP_RELAY:case en.RELAY:this._candidates=[...e,...n];break;default:this._candidates=e}for(let i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(t){t=he(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}predictReceivingMids(t){let e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex(n=>{let i=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(ue()){if(i){let r=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return i})}createOrRecycleDataChannel(){for(let n of this.sessionDesc.mediaDescriptions)if(n.media.mediaType==="application")return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;let t="".concat(this.currentMidIndex),e={media:{mediaType:"application",port:Zh,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(t),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(e),{mediaDesc:e,needExchangeSDP:!0}}createOrRecycleRecvMedia(t,e,n,i,r,o){let s=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Xd(s,a,this.localCapabilities.send,s===Z.VIDEO?i:r),d=s===Z.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;let l="".concat(this.currentMidIndex),u={media:{mediaType:s,port:Zh,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};u=this.mungRecvMediaDsec(u,t,o);let h=this.findFirstClosedMedia(s);if(h){let p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteDtlsParameters(t){let e=new Set(this._dtlsParameters.fingerprints.map(r=>r.fingerprint)),n=new Set(t.map(r=>r.fingerprint)),i=!1;e.size!==n.size&&(i=!0);for(let r of e)n.has(r)||(i=!0);return i}updateRemoteCodec(t,e,n){let i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").filter(u=>{var h;return B(h=Object.keys(Fs)).call(h,u)}))],r=new Set(e);if(i.every(u=>r.has(u)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;let o=this._rtpCapabilities.recv.videoCodecs.filter(u=>e.some(h=>{var p;return B(p=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(p,h)}));if(o.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(e)),!1;let s=[...new Set(o.map(u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||""))],a;if(_.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),t.length===0)a=this.sessionDesc.mediaDescriptions.filter(u=>u.media.mediaType==="video"&&u.attributes.direction==="recvonly");else if(a=this.sessionDesc.mediaDescriptions.filter(u=>u.attributes.mid&&u.media.mediaType==="video"&&B(t).call(t,u.attributes.mid)&&u.attributes.direction==="recvonly"),a.length!==t.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;if(T("USE_PUB_RTX")||T("USE_SUB_RTX")){let u=Zo(o,this.rtpCapabilities.recv.videoCodecs);o.push(...u)}this._rtpCapabilities.recv.videoCodecs=o;let c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Xd(Z.VIDEO,d,c,n);return a.forEach(u=>{let h=l.map(p=>p.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(u.attributes.mid,", from"),u.attributes.payloads,"to",l),u.attributes.payloads=l,u.media.fmts=h}),_.debug("updateRemoteCodec success, mids: ".concat(t,", codecs: ").concat(e,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(t,e,n,i,r){let o=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||o.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,a=t===Z.VIDEO?s.videoCodecs:s.audioCodecs,c=t===Z.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;let d="".concat(this.currentMidIndex),l={media:{mediaType:t,port:Zh,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,r);let u=this.findFirstClosedMedia(t);if(u){let h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,e,n){let i=he(t);return yg(i),Js(i,e),Ig(i,e),FO(i),Kh(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){let n=he(t);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach(i=>{i.rtpMap&&i.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&T("ENABLE_DOWN_SPS_PPS")&&(i.fmtp&&i.fmtp.parameters||(i.fmtp={parameters:{}}),i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),Kh(n,e,this.localCapabilities.recv),Tc(n),n}updateRecvMedia(t,e){let n=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===t);if(n!==-1){let i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>ue()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}getSSRC(t){var e;return(e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t))===null||e===void 0?void 0:e.attributes.ssrcs}};function hN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function vo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?hN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):hN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}var vc=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(vc||{});let tp=new Map;function pN(t,e,n,i){let{scale:r}=t;if(r===0&&i===vc.UP||r>=e.length-1&&i===vc.DOWN)return t;let o=vo(vo({},t),{},{scale:i===vc.DOWN?++r:--r});switch(n){case"maintain-framerate":o=vo(vo({},o),e[r].motion);break;case"maintain-resolution":o=vo(vo({},o),e[r].detail);break;case"balanced":o=vo(vo({},o),e[r].balanced)}return o}function _N(t,e){if(e){let n={overUse:0,underUse:0,adaptationList:mN(e)};tp.set(t,n)}else tp.delete(t)}function mN(t){let e=vo({},t),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:S,BALANCE_BITRATE_FACTOR:E,BALANCE_FRAMERATE_FACTOR:f,BALANCE_RESOLUTION_FACTOR:R,MOTION_RESOLUTION_FACTOR:v,MOTION_BITRATE_FACTOR:I,DETAIL_FRAMERATE_FACTOR:w,DETAIL_BITRATE_FACTOR:O}=Lf,A=Math.min(e.frameRate,a),N=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(p,1)*A),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o}}];for(let k=1;k<=c;k++){let V={bwe_up:Math.round(Math.pow(u,k)*n),bwe_down:Math.round(Math.pow(h,k+1)*n),fps_up:Math.round(Math.pow(S,k)*A),fps_down:Math.round(Math.pow(p,k+1)*A)},J={scaleResolutionDownBy:r/Math.pow(R,k),frameRate:Math.max(Math.round(Math.pow(f,k)*i),s),bitrateMax:Math.max(Math.round(Math.pow(E,k)*n),l),bitrateMin:Math.max(Math.round(Math.pow(E,k)*o),d)},ut={scaleResolutionDownBy:r/Math.pow(v,k),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(I,k)*n),l),bitrateMin:Math.max(Math.round(Math.pow(I,k)*o),d)},dt={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(w,k)*i),s),bitrateMax:Math.max(Math.round(Math.pow(O,k)*n),l),bitrateMin:Math.max(Math.round(Math.pow(O,k)*o),d)};N.push({scale:k,threshold:V,balanced:J,motion:ut,detail:dt})}return N}function HH(t,e,n,i,r,o){let s=tp.get(t)||{overUse:0,underUse:0,adaptationList:mN(r)},{adaptationList:a}=s;tp.set(t,s);let{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=Lf,{scale:l}=i,u,h;return typeof e=="number"&&e>0&&function(p,S,E,f){if(S>=E.length)return!1;let{threshold:{fps_down:R}}=E[S];return T("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=E[0].threshold.fps_down),p<R}(e,l,a,o)&&(s.overUse++,h=ec.CPU,s.overUse>c)||typeof n=="number"&&n>0&&function(p,S,E){if(S>=E.length)return!1;let{threshold:{bwe_down:f}}=E[S];return p<f}(n,l,a)&&(s.overUse++,h=ec.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,u=pN(i,a,o,vc.DOWN),[u,h]):(typeof e=="number"&&e>0&&typeof n=="number"&&n>0&&function(p,S,E,f){if(S===0)return;let{threshold:{fps_up:R}}=E[S];return T("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=E[1].threshold.fps_up),p>R}(e,l,a,o)&&function(p,S,E){if(S===0)return;let{threshold:{bwe_up:f}}=E[S];return p>f}(n,l,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,u=pN(i,a,o,vc.UP),u.scale===0&&(h=ec.NONE))),[u,h])}function EN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function jg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?EN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):EN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function fN(t){var e;return!!T("ENABLE_AG_ADAPTATION")&&!!(t instanceof yh||B(e=t._hints).call(e,Kt.CUSTOM_TRACK))&&(!!T("FORCE_SUPPORT_AG_ADAPTATION")||!!(rb(14,0,!1)&&ob(17,4,!0)||ib(14)&&pf(17,4,!0)))}let ep=new Map;function gN(t,e,n,i,r,o){if(yc(t,n),r(e),i!=="balanced"&&i!=="maintain-framerate"&&i!=="maintain-resolution")return;let s=-1;_N(t,e);let a=window.setInterval(()=>{let d=ep.get(t);if(!T("ENABLE_AG_ADAPTATION")||!d)return yc(t,n),void r(e);let l=o();if(l.sendPackets>0&&l.OutgoingAvailableBandwidth>0){if(s===-1)return void(s=Date.now());if(Date.now()-s<1e3)return;let u=l.sendFrameRate,h=l.OutgoingAvailableBandwidth,[p,S]=HH(t,u,h,d.adaptationConfig,e,i);S&&(n.qualityLimitationReason=S),p&&d.adaptationConfig.scale!==p.scale&&(_.debug("[".concat(t,"] applyAdaptation: ").concat(n.qualityLimitationReason,`
           sendFps `).concat(u,", bwe ").concat(h,", switch from ").concat(d.adaptationConfig.scale," to ").concat(p.scale," ")),d.adaptationConfig=jg(jg({},d.adaptationConfig),p),r(p))}},T("CHECK_LOCAL_STATS_INTERVAL")),c=jg({},e);ep.set(t,{timer:a,adaptationConfig:c,originConfig:e,adaptationFunc:r}),_.debug("[".concat(t,"] start adaptation, originConfig: ").concat(JSON.stringify(e),", degradationPreference: ").concat(i))}function yc(t,e){let n=ep.get(t);if(n){let{timer:i}=n;window.clearTimeout(i),ep.delete(t)}e.qualityLimitationReason=ec.NONE,_N(t)}function KH(t,e){var n;let i;switch(e){case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoTrack:i=B(n=t._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:i=Xt.Low}return i}function Gg(t){let e=wt();if(t.some(n=>n._bypassWebAudio))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function Wg(t,e){Gg(t);let n=e||new Be;return t.forEach(i=>n.addAudioTrack(i)),n}let YH=!wt().supportUnifiedPlan||T("CHROME_FORCE_PLAN_B")&&Kr();function $d(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(t.useDcSignal)return n={spec:e,store:t},br("DataChannelConnection").create(n);var n;return YH?function(r){return br("PlanBConnection").create(r)}({spec:e,store:t}):new Ii(e,t)}function Hg(t){return t&&(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")}function Kg(t){try{if(t.iceServers)return!1;if(t.turnServer&&t.turnServer.mode!=="off"){if(Ps(t.turnServer.servers))return!1;if(T("FORCE_TURN_TCP")||t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).some(e=>e.forceturn))return!0}return!1}catch{return!1}}var kt;function SN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Or(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?SN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):SN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let Ii=(kt=class ha extends Fh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return B(n=Object.keys(Fs)).call(n,e)}))]}constructor(e,n){super(e,n),g(this,"id",qt(5,"connection-")),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"forceTurn",!1),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"extension",{useXR:T("USE_XR")}),g(this,"localCapabilities",void 0),g(this,"remoteCodecs",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"isPreallocation",!1),g(this,"isPreRender",!1),g(this,"preMediaMap",new Map),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"recoveredDataChannelIds",[]),g(this,"currentDataChannelId",1),g(this,"supportAV1RtpSpec",!1),g(this,"mutex",void 0),g(this,"qualityLimitationReason",ec.NONE),g(this,"isFirstConnected",!1),this.store=n,this.forceTurn=Kg(e),this.mutex=new tn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(ha.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=ph(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,ue()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=Zr(n.sdp),r=await bg({filterRTX:!T("USE_PUB_RTX")&&!T("USE_SUB_RTX"),filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC"),filterVideoCodec:T("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:T("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:T("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=zd(r),this.initialOffer=n,T("ENABLE_SVC")&&this.store.codec=="av1"){let s=await BO();var e;s&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(s))}let o;return n.sdp&&Yh(n.sdp)&&(o=he(r),PO(o)),Or(Or({},i),{},{rtpCapabilities:o||r,offerSDP:n.sdp})}catch(n){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&Yh(this.initialOffer.sdp)&&LO(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new uN(Or(Or({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!T("ENABLE_PRE_SUB_WITH_PRE_PC")||!T("PRE_USE_LOCAL_CODECS"))&&Fd(this.store)),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let n=this.remoteSDP.toString(),i=wg(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});let o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),Fd(this.store))if(e.preallocation&&T("ENABLE_PRE_SUB_WITH_PRE_PC")){let s=T("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(s);await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{let{preSSRCs:s=[]}=e,a=s.map(d=>d.ssrcMsg[0].ssrcId);if(s.length===0)return;let{mids:c}=this.remoteSDP.batchSend(s.map(d=>Object.assign({},d)));await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}presetMedia(e,n){e.forEach((i,r)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&i===o.mid&&o.receiver.track){let s=o.receiver.track,a;s.kind==="video"&&T("ENABLE_PRE_RENDER")&&(a=new vh({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(qt(5,""))},!0),a.updateVideoTrack(s),a.onFirstVideoFrameRender=()=>{var c;let d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(n[r],{mid:i,track:s,player:a,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let n=!1,{rtpCapabilities:i}=e;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){let s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||s}let{preSSRCs:r=[]}=e,o=r.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){let s=[],a=[];if(Array.from(this.preMediaMap.entries()).every(c=>{let[d,{mid:l,player:u,track:h}]=c;return s.push(l),a.push(d),this.preMediaMap.delete(d),u&&u.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await ti(this.peerConnection,this.remoteSDP,this.extension),_.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),tt.reportApiInvoke(this.store.sessionId,{name:me.PRELOAD_MEDIA_FAILED,options:[r,a],tag:re.TRACER}).onSuccess()),r.length>0){let{mids:c}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(c,o)}}n?(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):_.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return jn(function*(){let o=yield yt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=Kd();e.forEach(f=>{let R=r.peerConnection.addTransceiver(f._mediaStreamTrack,Or({direction:"sendonly"},f.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));s.push(R),f._updateRtpTransceiver(R)}),ue()&&T("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(s,e)));let c=yield yt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),u=Mn(l),h=d.map(f=>{let R=u.mediaDescriptions.find(v=>v.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return vg(R,T("USE_PUB_RTX"))}),p;try{p=yield h}catch(f){p=[],r.remoteSDP.receive(e,n,i,p);let R=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield yt(r.stopSending(d,!0)),f}r.remoteSDP.receive(e,n,i,p);let S=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(r.applySimulcastEncodings(s,e)),yield yt(r.applySendEncodings(s,e)),E?.(S),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:S})),s.map((f,R)=>{let v=d[R];return{localSSRC:h[R],id:v,transceiver:f}})}catch(s){throw s instanceof L?s:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")_.debug("[P2PConnection] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:T("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}n.forEach(o=>{o._updateOriginDataChannel(i)});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),_.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof L?i:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof L?n:new L(C.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;yc(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);s&&(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[a,{mid:c,player:d}]=s;if(c===o)return this.preMediaMap.delete(a),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return jn(function*(){let i=yield yt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=wt().supportPCSetConfiguration,o=T("FORCE_TURN_TCP")||n.forceTurn;if(e===en.RELAY&&!r)return;if(r&&!o){let u=e===en.RELAY?"relay":"all",h=n.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,n.peerConnection.setConfiguration(h))}n.remoteSDP.updateCandidates(e);let s=yield yt(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Zr(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);let d=n.remoteSDP.toString(),l=n.logSDPExchange(s.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield yt(n.peerConnection.setLocalDescription(s)),l?.(d),yield yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;let e=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(en.TCP_RELAY),await ti(this.peerConnection,this.remoteSDP,this.extension)}catch(n){_.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{yc(this.id+n.mid,this)}),this.preMediaMap.forEach(n=>{let{player:i}=n;i&&i.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Or(Or({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ue()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Or(Or({},er),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Or(Or({},er),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var n;let i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",o=Qr(e.url||"");_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(o||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let n={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&(Ps(e.turnServer.servers)?n.iceServers=e.turnServer.servers:T("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(T("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&n.iceServers.push(...ha.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):n.iceServers.push(...ha.newTurnServerConfigToIceServers(e.turnServer.servers)),T("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...ha.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...ha.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),T("ENABLE_ENCODED_TRANSFORM")&&wt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!T("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}static newTurnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{let r=T("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":443?transport=tcp")}))}),n}tryBindTransportEvents(e){let n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};let i=n.iceTransport;i&&(i.onstatechange=()=>{let r=n?.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:o}=i.getSelectedCandidatePair()||{};if(r&&o){let s=r.address+":"+r.port,a=o.address+":"+o.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Qr(s)),", remote ").concat(JSON.stringify(Qr(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find(f=>f.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!wt().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let a=NO(this.peerConnection,e._mediaStreamTrack),c=S0(e);if(fN(e)&&a&&n&&c&&this.getLocalVideoStats&&B(i=["vp8","vp9"]).call(i,this.store.codec)){var d;let E=o.degradationPreference||(B(d=e._hints).call(d,Kt.CUSTOM_TRACK)?T("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");gN(this.id+a.mid,c,this,E,f=>{n&&this.updateAdaptation(n,f)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;let{bitrateMax:E,frameRate:f,scaleResolutionDownBy:R}=e._encoderConfig;E&&(s.maxBitrate=1e3*E),(B(l=e._hints).call(l,Kt.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(f&&(s.maxFramerate=Yn(f)),R&&R>=1&&(s.scaleResolutionDownBy=R))}let{maxFramerate:u}=T("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,u):u),T("DSCP_TYPE")&&Kr()){var h;let E=T("DSCP_TYPE");B(h=["very-low","low","medium","high"]).call(h,E)&&(s.networkPriority=E)}let p=n.getParameters(),S=(r=p.encodings)===null||r===void 0?void 0:r[0];ue()&&!S&&(o.encodings=[s]),S&&Object.assign(S,s),Object.assign(p,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await n.setParameters(p),await WO(this.store.codec,n,T("SVC_MODE"))}async updateAdaptation(e,n){var i,r;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!wt().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=n;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Yn(a)),c&&c>=1&&B(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{await e.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!wt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];o instanceof oe&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){if(T("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;let r=Mn(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Js(c,o),Ag(c,o,this.store.codec))}),To(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof oe&&!B(i=l._hints).call(i,Kt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(e,n){if(!ue()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof oe&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof oe&&T("SIMULCAST")&&this.store.codec==="vp8"&&!B(n=e._hints).call(n,Kt.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(T("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(e){if(wt().supportPCSetConfiguration){let n=ha.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}e.isPreallocation&&(this.isPreallocation=!0)}},q(kt.prototype,"updateRemoteRTPCapabilities",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"updateRemoteRTPCapabilities"),kt.prototype),q(kt.prototype,"connect",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"connect"),kt.prototype),q(kt.prototype,"updateRemoteConnect",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"updateRemoteConnect"),kt.prototype),q(kt.prototype,"createDataChannels",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"createDataChannels"),kt.prototype),q(kt.prototype,"receive",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"receive"),kt.prototype),q(kt.prototype,"batchReceive",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"batchReceive"),kt.prototype),q(kt.prototype,"stopReceiving",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"stopReceiving"),kt.prototype),q(kt.prototype,"muteRemote",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"muteRemote"),kt.prototype),q(kt.prototype,"unmuteRemote",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteRemote"),kt.prototype),q(kt.prototype,"muteLocal",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"muteLocal"),kt.prototype),q(kt.prototype,"unmuteLocal",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"unmuteLocal"),kt.prototype),q(kt.prototype,"close",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"close"),kt.prototype),q(kt.prototype,"updateEncoderConfig",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"updateEncoderConfig"),kt.prototype),q(kt.prototype,"updateSendParameters",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"updateSendParameters"),kt.prototype),q(kt.prototype,"replaceTrack",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"replaceTrack"),kt.prototype),q(kt.prototype,"updateAdaptation",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"updateAdaptation"),kt.prototype),q(kt.prototype,"getRemoteSSRC",[qn],Object.getOwnPropertyDescriptor(kt.prototype,"getRemoteSSRC"),kt.prototype),kt);function qn(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function Yg(t,e){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=Yn(e.width),i.height=Yn(e.height);let r=Yn(e.framerate||15);document.body.append(n),document.body.append(i);let o=t._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play().catch(Md);let s=i.getContext("2d");if(!s)throw new D(C.UNEXPECTED_ERROR,"can not get canvas context");let a=wt(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){let l=n.videoWidth,u=n.videoHeight/l,h=i.width*u;Math.abs(h-i.height)>=2&&(_.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(h)),i.height=h)}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,n.srcObject=new MediaStream([o]))},i.stopCapture=Yf(()=>i.startCapture&&i.startCapture(),r);let d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),_.debug("clean low stream renderer")},c}var TN=function(t){return t[t.Video_Send_Type=190]="Video_Send_Type",t}(TN||{}),Nr=function(t){return t[t.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",t[t.Video_Send_Freeze=2082]="Video_Send_Freeze",t[t.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",t[t.Video_Recv_Freeze=2084]="Video_Recv_Freeze",t[t.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",t[t.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",t[t.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",t[t.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",t}(Nr||{}),gt=function(t){return t[t.Video_Send_Retransmit=2062]="Video_Send_Retransmit",t[t.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",t[t.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",t[t.Video_Send_Transmit=2066]="Video_Send_Transmit",t[t.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",t[t.Video_Capture_Height=2033]="Video_Capture_Height",t[t.Video_Capture_Width=2035]="Video_Capture_Width",t[t.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",t[t.Video_Send_Low_Height=2073]="Video_Send_Low_Height",t[t.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",t[t.Video_Send_Low_Width=2077]="Video_Send_Low_Width",t[t.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",t[t.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",t[t.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",t[t.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",t[t.Video_Send_Width=2003]="Video_Send_Width",t[t.Video_Send_Height=2004]="Video_Send_Height",t[t.Video_Send_Disabled=2095]="Video_Send_Disabled",t[t.Video_Send_Adaptation=2032]="Video_Send_Adaptation",t[t.Video_Send_Player_Status=2128]="Video_Send_Player_Status",t[t.Video_Send_Nacks=2009]="Video_Send_Nacks",t[t.Video_Send_Plis=2010]="Video_Send_Plis",t[t.Video_Send_Firs=2011]="Video_Send_Firs",t[t.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",t[t.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",t[t.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",t[t.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",t[t.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",t[t.Video_Send_Bitrate=2012]="Video_Send_Bitrate",t[t.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",t[t.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",t[t.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",t[t.Audio_Send_Level=2038]="Audio_Send_Level",t[t.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",t[t.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",t[t.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",t[t.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",t[t.Audio_Send_Freeze=2081]="Audio_Send_Freeze",t[t.Audio_Send_Disabled=2096]="Audio_Send_Disabled",t[t.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",t[t.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",t[t.Video_Recv_Height=2019]="Video_Recv_Height",t[t.Video_Recv_Width=2018]="Video_Recv_Width",t[t.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",t[t.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",t[t.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",t[t.Video_Recv_Nacks=2026]="Video_Recv_Nacks",t[t.Video_Recv_Plis=2027]="Video_Recv_Plis",t[t.Video_Recv_Firs=2028]="Video_Recv_Firs",t[t.Video_Recv_Disabled=2101]="Video_Recv_Disabled",t[t.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",t[t.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",t[t.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",t[t.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",t[t.Audio_Render_Level=2043]="Audio_Render_Level",t[t.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",t[t.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",t[t.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",t[t.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",t[t.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",t[t.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",t[t.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",t[t.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",t[t.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",t[t.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",t[t.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",t[t.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",t}(gt||{}),Xe=function(t){return t[t.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",t[t.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",t[t.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",t[t.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",t[t.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",t[t.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",t[t.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",t[t.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",t[t.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",t[t.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",t[t.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",t[t.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",t[t.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",t[t.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",t[t.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",t[t.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",t[t.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",t[t.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",t[t.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",t[t.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",t[t.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",t[t.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",t}(Xe||{}),un=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(un||{}),Ic=function(t){return t[t.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t[t.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",t}(Ic||{}),qg=function(t){return t[t.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",t[t.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",t}(qg||{});let Zs=1e3,np=6,tl=3,qH=Math.max(np,tl,60);function ct(t,e,n){n!=null&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)))}function RN(t){let e={[un.CONN_TYPE]:0,[un.RTT]:t.rtt,[un.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{let n=t.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[un.CONN_TYPE]=1),n==="tcp"&&(e[un.CONN_TYPE]=3),n==="tls"&&(e[un.CONN_TYPE]=4);break}case"srflx":e[un.CONN_TYPE]=2;break;case"unknown":e[un.CONN_TYPE]=5;break;default:e[un.CONN_TYPE]=0}return e}function CN(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class vN extends ge{constructor(e){super(),g(this,"store",void 0),g(this,"uploadWRTCStatsTimer",void 0),g(this,"uploadOutboundDenoiserStatsTimer",void 0),g(this,"uploadExtStatsTimer",void 0),g(this,"uploadExtUsageStatsTimer",void 0),g(this,"uploadInboundExtStatsTimer",void 0),g(this,"requestStats",void 0),g(this,"requestTransportStats",void 0),g(this,"requestLocalMedia",void 0),g(this,"requestRemoteMedia",void 0),g(this,"requestAllTracks",void 0),g(this,"requestVideoIsReady",void 0),g(this,"requestUploadStats",void 0),g(this,"requestUpload",void 0),g(this,"uploadOutboundStarted",!1),g(this,"uploadInboundStarted",!1),g(this,"uploadTransportStarted",!1),g(this,"uploadBaseStatsStarted",!1),g(this,"uploadExtensionUsageStarted",!1),g(this,"lastRecvStats",void 0),g(this,"lastSendStats",void 0),g(this,"lastRefRecvStats",void 0),g(this,"lastRefSendStats",void 0),g(this,"lastNormalRecvStats",void 0),g(this,"lastNormalSendStats",void 0),g(this,"lastExtendStats",{}),g(this,"needUploadStats",{}),g(this,"needUploadRenderFreezeTime",!0),g(this,"lastUploadCompensateTime",-1),g(this,"uploadCompensateDeltaTime",0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let n=e%tl==0,i=e%np==0,r=e%60==0,o,s;if(this.uploadTransportStarted&&(o=this.requestStats(),this.store.useP2P&&(s=this.requestStats(!0))),!o&&this.uploadOutboundStarted&&(o=this.requestStats()),!s&&this.uploadInboundStarted&&(s=this.requestStats(!0)),o||s){var a;let c={};if(this.uploadTransportStarted&&o){let l=this.getTransportStats(o,n?this.lastRefSendStats:void 0,s,n);l&&(c.misc=[l])}if(this.uploadOutboundStarted&&o){let l=this.getOutboundStats(o,i?this.lastNormalSendStats:void 0,n?this.lastRefSendStats:void 0,this.lastSendStats,r);l&&(c.outbound=[l])}if(this.uploadInboundStarted&&s){this.uploadCompensateStats(e);let l=this.getInboundStats(s,i?this.lastNormalRecvStats:void 0,n?this.lastRefRecvStats:void 0,this.lastRecvStats);l&&(c.inbound=l)}let d=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;if(d&&(Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Ic.RTC_PEER_CONNECTION_STATE]=Nf[d]):c.misc=[{addition:{[Ic.RTC_PEER_CONNECTION_STATE]:Nf[d]}}]),li.needUploadStats.length>0||i){let l=li.needUploadStats.shift()||(li.visibility==="visible"?1:0);Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Ic.PAGE_VISIBILITY]=l):c.misc=[{addition:{[Ic.PAGE_VISIBILITY]:l}}]}this.needUploadStats.sendType&&(Array.isArray(c.outbound)&&c.outbound[0]&&c.outbound[0].high&&(c.outbound[0].high[TN.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(c)}this.lastRecvStats=s,this.lastSendStats=o,i&&(this.lastNormalRecvStats=s,this.lastNormalSendStats=o),n&&(this.lastRefRecvStats=s,this.lastRefSendStats=o)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,li.startCollectStats();let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,i;let r=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(r&&((i=this.requestUploadStats)===null||i===void 0||i.call(this,{misc:[{addition:{[Ic.RTC_PEER_CONNECTION_STATE]:Nf[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===qH+1&&(e=1)},Zs)}uploadCompensateStats(e){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let n=e%tl==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!n)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());let i=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=i,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;let r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;let o=this.requestStats(!0);new Array(r).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let s={};if(this.uploadInboundStarted&&o){let a=this.requestRemoteMedia()||[],c=[];a.forEach(d=>{let[l,u]=d,h={peer:l.uid};if(l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)&&u.has(Z.VIDEO)&&l.videoTrack){let p=function(S,E,f){if(!E.videoRecv.find(v=>v.ssrc===S))return;let R={};if(f&&f._player){let v=f._player,{renderFreezeAccTime2:I,videoElementStatus:w}=v;if(li.visibility==="visible"&&w===gn.PLAYING&&wt().supportRequestVideoFrameCallback){let O=Math.min(6e3,I);v.renderFreezeAccTime2=Math.max(0,I-O),ct(R,Nr.Video_Render_Freeze_Time_Render2,O),T("USE_NEW_RENDER_FREEZE_TIME")&&ct(R,Nr.Video_Render_Freeze_Time_Render,O)}}return R}(l._videoSSRC,o,l.videoTrack);p&&(h.video=p)}h.video&&c.push(h)}),c.length>0&&(s.inbound=c,this.requestUploadStats(s))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(e,n,i,r){if(!this.requestStats)return;if(!r)return e.rtt==null?void 0:{addition:{[un.RTT]:e.rtt,[un.CONN_TYPE]:void 0,[un.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};let o=RN(e);if(this.store.useP2P){if(i){let s=RN(i);o[un.CONN_TYPE]&&s[un.CONN_TYPE]&&(o[un.CONN_TYPE]+=s[un.CONN_TYPE]<<3)}o[un.CONN_TYPE]?o[un.CONN_TYPE]+=110:o[un.CONN_TYPE]=110}else{o[un.CONN_TYPE]?o[un.CONN_TYPE]+=100:o[un.CONN_TYPE]=100;let s=function(a,c){return c?[Math.ceil(8*(a.transport.bytesSent-c.transport.bytesSent)/(a.timestamp-c.timestamp)),Math.ceil(8*(a.transport.bytesReceived-c.transport.bytesReceived)/(a.timestamp-c.timestamp))]:[0,0]}(e,n);o[qg.Transport_Send_Bitrate]=s[0],o[qg.Transport_Recv_Bitrate]=s[1]}return{addition:o}}getOutboundStats(e,n,i,r,o){if(!this.requestUploadStats||!this.requestLocalMedia)return;let s=this.requestLocalMedia();if(!s||s.length===0)return;let a,c,d;return s.forEach(l=>{let[u,{track:h,ssrcs:p}]=l;switch(u){case j.LocalVideoLowTrack:case j.LocalVideoTrack:if(u===j.LocalVideoTrack){var S;let E=function(I,w,O,A,N,k){let V=w.videoSend.find(Ct=>Ct.ssrc===I);if(!V)return;let J={},{sentFrame:ut,inputFrame:dt}=V;if(A&&(ct(J,Nr.Video_Send_Qp_Sum,V.qpSumPerFrame),dt&&ut)){let Ct=dt.frameRate,St=ut.frameRate;J[Nr.Video_Send_Freeze]=function(Gt,fe){let U=!0;return U=!(Gt<=5)&&(Gt<=10?fe<3:Gt<=20?fe<4:fe<5),U}(Ct,St)?1:0}if(N){switch(ut&&(ct(J,gt.Video_Send_Height,ut.height),ct(J,gt.Video_Send_Width,ut.width),ct(J,gt.Video_Send_Frame_Rate,ut.frameRate)),J[gt.Video_Send_Disabled]=O._originMediaStreamTrack&&!O._originMediaStreamTrack.enabled||O._mediaStreamTrack&&!O._mediaStreamTrack.enabled?1:0,V.adaptionChangeReason){case"none":J[gt.Video_Send_Adaptation]=0;break;case"cpu":J[gt.Video_Send_Adaptation]=1;break;case"bandwidth":J[gt.Video_Send_Adaptation]=2;break;case"other":J[gt.Video_Send_Adaptation]=3}let Ct=0;V.adaptionChangeReason&&(Ct+=CN(V.adaptionChangeReason)),w.qualityLimitationReason&&(Ct+=CN(w.qualityLimitationReason)<<3),J[gt.Video_Send_Adaptation]=Ct,J[gt.Video_Send_Player_Status]=Wf[O._player?O._player.videoElementStatus:"uninit"],ct(J,gt.Video_Send_Nacks,V.nacksCount),ct(J,gt.Video_Send_Plis,V.plisCount),ct(J,gt.Video_Send_Firs,V.firsCount),ct(J,gt.Video_Send_Avg_Encode,V.avgEncodeMs),ct(J,gt.Video_Send_Huge_Frame_Sent,V.hugeFramesSent),ct(J,gt.Video_Send_Bytes_Retransmit,V.retransmittedBytesSent),ct(J,gt.Video_Send_Packages_Retransmit,V.retransmittedPacketsSent),ct(J,gt.Video_Send_Key_Frames_Encoded,V.keyFramesEncoded);let St=N.videoSend.find(Gt=>Gt.ssrc===I);if(St){let Gt=Zs*tl;St.timestamp&&V.timestamp&&(Gt=V.timestamp-St.timestamp),St.packets!=null&&V.packets!=null&&ct(J,gt.Video_Send_Package_Rate,1e3*(V.packets-St.packets)/Gt),V.packetsLost!=null&&St.packetsLost!=null&&ct(J,gt.Video_Send_Package_Lost,V.packetsLost-St.packetsLost),St.bytes!=null&&V.bytes!=null&&ct(J,gt.Video_Send_Bitrate,8*(V.bytes-St.bytes)/Gt)}}return J}(p[0].ssrcId,e,h,n,i),f=h.__className__==="CameraVideoTrack"?3:B(S=h._hints).call(S,Kt.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==f||o)&&(this.needUploadStats={sendType:f},this.lastExtendStats.sendType=f);let R=h&&function(I,w,O,A){let N=w.videoSend.find(V=>V.ssrc===I);if(!N)return null;let k={};if(A){let V=N.inputFrame,J=V&&V.height||O.videoHeight||0,ut=V&&V.width||O.videoWidth||0,dt=V&&V.frameRate||0;ct(k,gt.Video_Capture_Height,J),ct(k,gt.Video_Capture_Width,ut),ct(k,gt.Video_Capture_Frame_Rate,dt)}return k}(p[0].ssrcId,e,h,!!i),v=function(I,w){let O={};return w&&(ct(O,gt.Video_Send_Retransmit,I.bitrate.retransmit),ct(O,gt.Video_Send_Target_Encoded,I.bitrate.targetEncoded),ct(O,gt.Video_Send_Actual_Encoded,I.bitrate.actualEncoded),ct(O,gt.Video_Send_Transmit,I.bitrate.transmit),ct(O,gt.Video_Send_Bandwidth,I.sendBandwidth)),O}(e,!!i);c=Object.assign({},E,R,v)}else d=function(E,f,R,v,I){let w=f.videoSend.find(A=>A.ssrc===E);if(!w)return;let O={};if(v){let A=w.sentFrame;A&&(ct(O,gt.Video_Send_Low_Height,A.height),ct(O,gt.Video_Send_Low_Width,A.width),ct(O,gt.Video_Send_Low_Frame_Rate,A.frameRate));let N=v.videoSend.find(k=>k.ssrc===E);if(N){let k=Zs*np;N.timestamp&&w.timestamp&&(k=w.timestamp-N.timestamp),N.packets!=null&&w.packets!=null&&ct(O,gt.Video_Send_Low_Package_Rate,1e3*(w.packets-N.packets)/k),w.packetsLost!=null&&N.packetsLost!=null&&ct(O,gt.Video_Send_Low_Package_Lost,w.packetsLost-N.packetsLost),N.bytes!=null&&w.bytes!=null&&ct(O,gt.Video_Send_Low_Bitrate,8*(w.bytes-N.bytes)/k)}}return O}(p[0].ssrcId,e,0,i);break;case j.LocalAudioTrack:a=h&&function(E,f,R,v,I,w){let O=f.audioSend.find(N=>N.ssrc===E);if(!O)return;let A={};if(I){A[gt.Audio_Send_Disabled]=R._originMediaStreamTrack&&!R._originMediaStreamTrack.enabled||R._mediaStreamTrack&&!R._mediaStreamTrack.enabled?1:0;let N=100*R._source.getAccurateVolumeLevel(),k=O.inputLevel;if(k!=null){let J=Math.ceil(50*Math.log10(100*k+1));ct(A,gt.Audio_Send_Level,J)}ct(A,gt.Audio_Capture_PCM_Level,N),ct(A,gt.Audio_Send_AEC_Return_Loss,O.aecReturnLoss),ct(A,gt.Audio_Send_AEC_Return_Loss_Enhancement,O.aecReturnLossEnhancement),ct(A,gt.Audio_Send_Bytes_Retransmit,O.retransmittedBytesSent),ct(A,gt.Audio_Send_Packages_Retransmit,O.retransmittedPacketsSent),A[gt.Audio_Send_Freeze]=0;let V=I.audioSend.find(J=>J.ssrc===E);if(V){let J=Zs*np;V.timestamp&&O.timestamp&&(J=O.timestamp-V.timestamp),V.bytes!=null&&O.bytes!=null&&ct(A,gt.Audio_Send_Bitrate,8*(O.bytes-V.bytes)/J),V.packets!=null&&O.packets!=null&&ct(A,gt.Audio_Send_Package_Rate,1e3*(O.packets-V.packets)/J)}}return A}(p[0].ssrcId,e,h,0,i)}}),{high:c,low:d,audio:a}}getInboundStats(e,n,i,r){if(!this.requestRemoteMedia)return;let o=this.requestRemoteMedia()||[],s=[];return o.forEach(a=>{let[c,d]=a,l={peer:c.uid},u;if(d.has(Z.VIDEO)&&c.videoTrack){let h=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,p=c.videoTrack?function(S,E,f,R,v,I,w,O){let A=E.videoRecv.find(St=>St.ssrc===S);if(!A)return;let N={},{receivedFrame:k,outputFrame:V,decodeFrameRate:J}=A;ct(N,Xe.Video_Render_Frame_Rate_Decode,J),A.framesRateFirefox&&ct(N,Xe.Video_Recv_Frame_Rate,A.framesRateFirefox),k&&ct(N,Xe.Video_Recv_Frame_Rate,k.frameRate),ct(N,Xe.Video_Recv_Frame_Dropped,A.framesDroppedCount),ct(N,Xe.Video_Recv_Bytes_Retransmit,A.retransmittedBytesReceived),ct(N,Xe.Video_Recv_Packages_Retransmit,A.retransmittedPacketsReceived),ct(N,Xe.Video_Recv_Packages_Discarded,A.packetsDiscarded),ct(N,Xe.Video_Recv_Avg_Decode,A.avgDecodeMs),ct(N,Xe.Video_Recv_Avg_Processing_Delay,A.avgProcessingDelayMs),ct(N,Xe.Video_Recv_Avg_Assembly_Time,A.avgFramesAssembledFromMultiplePacketsMs),ct(N,Xe.Video_Recv_Avg_Inter_Frame_Delay,A.avgInterFrameDelayMs),ct(N,Xe.Video_Recv_Key_Frames_Decoded,A.keyFramesDecoded);let ut=O&&O.videoRecv.find(St=>St.ssrc===S);if(ut){let St=E.timestamp-O.timestamp||Zs;A.packetsLost!=null&&ut.packetsLost!=null&&ct(N,Xe.Video_Recv_Package_Lost,A.packetsLost-ut.packetsLost),ut.bytes!=null&&A.bytes!=null&&ct(N,Xe.Video_Recv_Bitrate,8*(A.bytes-ut.bytes)/St),ut.packets!=null&&A.packets!=null&&ct(N,Xe.Video_Recv_Package_Rate,1e3*(A.packets-ut.packets)/St)}let dt=I&&I.videoRecv.find(St=>St.ssrc===S);if(dt&&(ct(N,Nr.Video_Recv_Qp_Sum,A.qpSumPerFrame),N[Nr.Video_Recv_Freeze]=R&&Zd.isRemoteVideoFreeze(f,A,dt)?1:0),w){var Ct;let St=w.videoRecv.find(fe=>fe.ssrc===S);k?(ct(N,gt.Video_Recv_Height,k.height),ct(N,gt.Video_Recv_Width,k.width)):f&&(ct(N,gt.Video_Recv_Height,f._videoHeight||0),ct(N,gt.Video_Recv_Width,f._videoWidth||0)),V&&ct(N,gt.Video_Recv_Frame_Rate_Output,V.frameRate);let Gt=(Ct=f._player)===null||Ct===void 0?void 0:Ct.rendFrameRate.toFixed(0);if(Gt&&ct(N,gt.Video_Render_Frame_Rate_Render,+Gt),ct(N,gt.Video_Recv_Jitter_Buffer,A.jitterBufferMs),ct(N,gt.Video_Recv_Current_Delay,A.currentDelayMs),ct(N,gt.Video_Recv_Firs,A.firsCount),ct(N,gt.Video_Recv_Nacks,A.nacksCount),ct(N,gt.Video_Recv_Plis,A.plisCount),f){N[gt.Video_Recv_Disabled]=f._originMediaStreamTrack.enabled&&f._mediaStreamTrack.enabled?0:1;let fe=f._player;if(fe){let{freezeTimeCounterList:U,renderFreezeAccTime:K,renderFreezeAccTime2:$,videoElementStatus:x}=fe;if(U&&U.length>0&&ct(N,Nr.Video_Render_Freeze_Time,U.splice(0,1)[0]),v&&li.visibility==="visible"&&x===gn.PLAYING&&wt().supportRequestVideoFrameCallback){let m=Math.min(6e3,$);fe.renderFreezeAccTime2=Math.max(0,$-m),ct(N,Nr.Video_Render_Freeze_Time_Render2,m);let y=Math.min(6e3,K);fe.renderFreezeAccTime=Math.max(0,K-y),ct(N,Nr.Video_Render_Freeze_Time_Render,T("USE_NEW_RENDER_FREEZE_TIME")?m:y)}if(typeof A.totalFreezesDuration=="number"){let m=St&&St.totalFreezesDuration?A.totalFreezesDuration-St.totalFreezesDuration:A.totalFreezesDuration;ct(N,gt.Video_Render_Freeze_Duration,1e3*m)}}}if(N[gt.Video_Recv_Player_Status]=Wf[f._player?f._player.videoElementStatus:"uninit"],St&&A.totalInterFrameDelay!==void 0&&A.totalSquaredInterFrameDelay!==void 0&&St.totalInterFrameDelay!==void 0&&St.totalSquaredInterFrameDelay!==void 0){let fe=A.totalInterFrameDelay-St.totalInterFrameDelay,U=A.totalSquaredInterFrameDelay-St.totalSquaredInterFrameDelay,K=A.framesDecodeCount-St.framesDecodeCount,$=fe/K*1e3,x=Math.round(1e3*Math.sqrt((U-Math.pow(fe,2)/K)/K));!isNaN(x)&&$+x>Math.max(3*$,$+150)&&(N[gt.Video_Recv_I_Frame_Delay]=x)}}return N}(c._videoSSRC,e,c.videoTrack,h===!0,this.needUploadRenderFreezeTime,n,i,r):void 0;if(p&&(l.video=p),c.videoTrack){let S=e.videoRecv.find(E=>E.ssrc===c._videoSSRC);S&&S.estimatedPlayoutTimestamp&&(u=S.estimatedPlayoutTimestamp)}}if(d.has(Z.AUDIO)&&c.audioTrack){let h=c.audioTrack?function(p,S,E,f,R,v){let I=S.audioRecv.find(N=>N.ssrc===p);if(!I)return;let w={};ct(w,Xe.Audio_Recv_Jitter,I.jitterMs),ct(w,Xe.Audio_Recv_Bytes_Retransmit,I.retransmittedBytesReceived),ct(w,Xe.Audio_Recv_Packages_Retransmit,I.retransmittedPacketsReceived),ct(w,Xe.Audio_Recv_Packages_Discarded,I.packetsDiscarded),ct(w,Xe.Audio_Recv_Avg_Processing_Delay,I.avgProcessingDelayMs);let O=v&&v.audioRecv.find(N=>N.ssrc===p);if(O){let N=Zs;I.packets!=null&&O.packets!=null&&ct(w,Xe.Audio_Recv_Package_Rate,1e3*(I.packets-O.packets)/N),I.packetsLost!=null&&O.packetsLost!=null&&ct(w,Xe.Audio_Recv_Package_Lost,I.packetsLost-O.packetsLost)}if(f){let{receivedFrames:N,droppedFrames:k}=I;N!=null&&k!=null&&(w[Nr.Audio_Recv_Freeze]=(A=N)===0||100*k/A>20?1:0)}var A;if(R){let N=100*E._source.getAccurateVolumeLevel(),k=I.outputLevel;if(k!=null){let J=Math.ceil(50*Math.log10(100*k+1));ct(w,gt.Audio_Render_Level,J)}ct(w,gt.Audio_Recv_PCM_Level,N),E&&(w[gt.Audio_Recv_Disabled]=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?0:1),ct(w,gt.Audio_Recv_Jitter_Buffer,I.jitterBufferMs),ct(w,gt.Audio_Recv_Current_Delay,I.jitterBufferMs),w[gt.Audio_Recv_Player_Status]=Wf[wn.getPlayerState(E.getTrackId())];let V=R.audioRecv.find(J=>J.ssrc===p);if(V){V.bytes!=null&&I.bytes!=null&&ct(w,gt.Audio_Recv_Bitrate,8*(I.bytes-V.bytes)/(Zs*tl));let J=I.concealedSamples-V.concealedSamples;J>0&&ct(w,gt.Audio_Recv_Concealed_Samples,J);let ut=I.totalSamplesReceived-V.totalSamplesReceived;ut>0&&ct(w,gt.Audio_Recv_Total_Samples_Received,ut);let dt=I.freezeSamples80-V.freezeSamples80;dt>0&&ct(w,gt.Audio_Render_Freeze_Samples_80ms,dt);let Ct=I.freezeSamples200-V.freezeSamples200;Ct>0&&ct(w,gt.Audio_Render_Freeze_Samples_200ms,Ct);let St=I.freezeMs80-V.freezeMs80;ct(w,gt.Audio_Render_Freeze_Time_80ms,St<0?0:St);let Gt=I.freezeMs200-V.freezeMs200;ct(w,gt.Audio_Render_Freeze_Time_200ms,Gt<0?0:Gt)}}return w}(c._audioSSRC,e,c.audioTrack,n,i,r):void 0;if(h&&(l.audio=h),c.audioTrack&&u){let p=e.audioRecv.find(S=>S.ssrc===c._audioSSRC);if(p&&p.estimatedPlayoutTimestamp){let S=p.estimatedPlayoutTimestamp-u;l.audio?l.audio[Xe.Audio_Recv_AV_Sync_TIME]=S:l.audio={[Xe.Audio_Recv_AV_Sync_TIME]:S}}}}(l.video||l.audio)&&s.push(l)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let e=(this.requestAllTracks()||[]).find(n=>n instanceof jd);if(e&&e._external.getDenoiserStats){let n=e._external.getDenoiserStats();n&&this.requestUpload(zs.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,i]=e;i.has(Z.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),i.has(Z.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let n=Date.now(),i={connectionInterval:T("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n},r=[],o=this.requestAllTracks&&this.requestAllTracks()||[];for(let d of o)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));let s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[d,l]of s)l.has(Z.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(Z.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,l){let u={};for(let{id:E,value:f,level:R,direction:v}of d){var h;let I=(h=l.get(E))!==null&&h!==void 0?h:0,w=f===2?I+T("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:I;var p,S;l.set(E,w),u[E]?(f===2&&(u[E].value=f),R>u[E].level&&(u[E].level=R),v==="remote"&&(u[E].remoteUidCount+=1),u[E].totalTs=(p=l.get(E))!==null&&p!==void 0?p:0):u[E]={value:f,level:R,remoteUidCount:v==="local"?0:1,totalTs:(S=l.get(E))!==null&&S!==void 0?S:0}}return Object.keys(u).map(E=>{let{level:f,value:R,totalTs:v}=u[E];return{id:E,level:f,value:R,totalTs:v}})}(r,e);let a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(zs.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})},T("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,li.stopCollectStats()}}let zH=T("ICE_RESTART_INTERVAL"),ip=new Map,Ac=new Map,ts=[en.UDP_TCP_RELAY,en.TCP_RELAY,en.RELAY],zg=T("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&wt().supportPCSetConfiguration;function yN(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=ip.get(t.id);n&&(window.clearTimeout(n),ip.delete(t.id));let i=Ac.get(t.id);e&&i&&i.index===ts.length-1&&(_.debug("[".concat(t.id,"] reset ICE restart policy")),Ac.delete(t.id))}function IN(t,e,n){if(ip.size===0&&Ac.size===0&&(Array.isArray(T("RESTART_SEQUENCE"))&&T("RESTART_SEQUENCE").length>0&&!function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){let l=a[d];if(a.filter(u=>u===l).length!==c.filter(u=>u===l).length)return!1}return!0}(ts,T("RESTART_SEQUENCE"))&&(ts=T("RESTART_SEQUENCE").filter(a=>{var c;if(B(c=Object.values(en)).call(c,a))return!0}),_.debug("use reconnection policy from config distribution, queues: ".concat(ts.join(" => ")))),zg=T("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&wt().supportPCSetConfiguration),ts.length===0)return void n();let i,{index:r=0,type:o}=Ac.get(t.id)||{};if(zg&&o===en.RELAY)return void n();let s=o&&r>=ts.length-1;if(zg)o=en.RELAY;else{if(s)return void n();o?(r++,o=ts[r]):(o=ts[0],r=0)}_.debug("[".concat(t.id,"] choose ICE restart policy: ").concat(o,", index: ").concat(r)),e(o),Ac.set(t.id,{index:r,type:o}),i=window.setTimeout(()=>IN(t,e,n),zH),ip.set(t.id,i)}var Nt;function AN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function eo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?AN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):AN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}function bN(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Ju,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new rp(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function rp(t){function e(n){if(Object(n)!==n)return Y.reject(new TypeError(n+" is not an object."));var i=n.done;return Y.resolve(n.value).then(function(r){return{value:r,done:i}})}return rp=function(n){this.s=n,this.n=n.next},rp.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Y.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Y.reject(n):e(i.apply(this.s,arguments))}},new rp(t)}let $s=(Nt=class extends ge{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(rt.StateChange,e,this._state)}constructor(t,e){super(),g(this,"isPlanB",void 0),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"connection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"remoteDataChannelMap",new Map),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"pendingLocalDataChannels",[]),g(this,"pendingRemoteDataChannels",[]),g(this,"statsCollector",void 0),g(this,"shouldForwardP2PCreation",void 0),g(this,"iceFailedCount",0),g(this,"dtlsFailedCount",0),g(this,"mutex",void 0),g(this,"_state",Ht.Disconnected),g(this,"_pcStatsUploadType",T("NEW_ICE_RESTART")?Co.FIRST_CONNECTION:Co.OLD_FIRST_CONNECTION),g(this,"_isStartRestartIce",!1),g(this,"_restartTimer",void 0),g(this,"_isTryConnecting",!1),g(this,"_iceError",null),g(this,"_forceTurn",!1),g(this,"_isWaitPcToRePub",!1),g(this,"handleMuteLocalTrack",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Ht.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let s=this.filterTobeMutedTracks(n);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];this.store.enableInstantMuteRestore?(d.track._originMediaStreamTrack.enabled=!1,_.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):d.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?_.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createMuteMessage(s);await se(this,rt.RequestMuteLocal,c),i()}catch(s){r(s)}finally{o()}}),g(this,"handleUnmuteLocalTrack",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Ht.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];if(this.store.enableInstantMuteRestore)d.track._originMediaStreamTrack.enabled=!0,_.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(d.track._originMediaStreamTrack.stop(),!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding){let l=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{let l=Yg(n,ks(this,rt.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new Y((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0)})}}this.store.enableInstantMuteRestore?_.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createUnmuteMessage(s);await se(this,rt.RequestUnmuteLocal,c),i()}catch(s){r(s)}finally{o()}}),g(this,"handleUpdateVideoEncoder",async(n,i,r,o)=>{let s;o||(s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(j.LocalVideoTrack);if(!this.connection||!c||c.track!==n||this.state!==Ht.Connected)return void i();let{id:d,track:l}=c;await this.connection.updateSendParameters(d,l),await this.connection.updateEncoderConfig(d,l),this.emit(rt.UpdateVideoEncoder,l),i()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}}),g(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(j.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==Ht.Connected)return void i();let{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),g(this,"handleReplaceMixingTrack",async(n,i,r,o)=>{if(!this.connection||this.state!==Ht.Connected)return void i();let s=Wg([n]),a;_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,s),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}}),g(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;_.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.connection||!d||this.state!==Ht.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){let l=d[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===j.LocalVideoTrack&&!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding){let l=this.localTrackMap.get(j.LocalVideoLowTrack);if(l){let u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new Y((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),g(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats())}),g(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),g(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new vN(this.store),this.bindStatsUploaderEvents(),this.mutex=new tn("P2PChannel-mutex",this.store.clientId),this.isPlanB=!wt().supportUnifiedPlan||T("CHROME_FORCE_PLAN_B")&&Kr(),this.shouldForwardP2PCreation=T("FORWARD_P2P_CREATION")&&wt().supportPCSetConfiguration&&lb(),this.shouldForwardP2PCreation&&(this.connection=$d(this.store),this.emit(rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var n;this.state=Ht.New,this._forceTurn=Kg(t),_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));let i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||i||e)&&((i||e)&&this.connection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=$d(this.store,t),this.emit(rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=T("NEW_ICE_RESTART")?Co.FIRST_CONNECTION:Co.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t){if(!this.connection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==Ht.Connected){this.store.peerConnectionStart();let e=await this.connection.connect(t);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ht.Connected,e}if(this.connection instanceof Ii&&this.connection.checkDtlsParameters(t.dtlsParameters.fingerprints))return _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),tt.reportApiInvoke(this.store.sessionId,{name:me.MISMATCH_DTLS_PARAMETERS,options:[t.dtlsParameters.fingerprints],tag:re.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(rt.RequestReconnect)});await this.connection.updateRemoteConnect(t)}updateRemoteRTPCapabilities(t){let e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[s]=r;return B(o=[j.LocalVideoLowTrack,j.LocalVideoTrack]).call(o,s)}),n=e.map(r=>{let[,{id:o}]=r;return o}),i=e.map(r=>{let[o]=r;return o});if(this.connection instanceof Ii||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(tt.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!B(t).call(t,this.store.codec)){let r=["vp9","vp8","h264"].find(o=>B(t).call(t,o));r&&(this.store.codec=r,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}async getEstablishParams(){var t;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Ii&&this.connection.peerConnectionState!=="closed"&&B(t=[Ht.New,Ht.Connected]).call(t,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(t){if(!this.connection||this.state!==Ht.Connected){if(this.state===Ht.Disconnected)throw new L(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(n=>{var i;B(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n)}),[]}let e=this.filterTobePublishedDataChannels(t);return e.length===0?[]:(e.forEach(n=>{let i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(n=>{this.localDataChannels.push(n);let i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)}),t.map(n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId})))}publish(t,e,n){var i=this;return jn(function*(){let r=yield yt(i.mutex.lock("From P2PChannel.publish"));try{var o;let s=i.connection&&B(o=["disconnected","failed"]).call(o,i.connection.peerConnectionState);if(!i.connection||i.state!==Ht.Connected||s){if(i.state===Ht.Disconnected)throw new L(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(t);let c=t.filter(d=>i.pendingLocalTracks.indexOf(d)===-1);return i.pendingLocalTracks=i.pendingLocalTracks.concat(c),void(s&&(i._isWaitPcToRePub=!0))}i.store.pubId=i.store.pubId+1,Tn.markPublishStart(i.store.clientId,i.store.pubId);let a=i.filterTobePublishedTracks(t,e,n);if(a.length===0)return void(yield yt(i.tryToUnmuteAudio(t)));yield*Xa(bN(i.doPublish(i.connection,a)))}finally{r()}})()}doPublish(t,e){var n=this;return jn(function*(){e.forEach(h=>{let{track:p,type:S}=h,E=Date.now();n.store.publish(p.getTrackId(),S===j.LocalAudioTrack?"audio":"video",E)}),n.bindLocalTrackEvents(e);let i=e.map(h=>{let{track:p}=h;return p}),r=yield yt(t.send(i,n.store.codec,n.store.audioCodec)),o=(yield yt(r.next())).value,s=n.createGatewayPublishMessage(e,o),a;try{a=yield s}catch(h){throw r.throw(h),h?.code===C.WS_ABORT&&e.forEach(p=>{let{track:S}=p;n.pendingLocalTracks.indexOf(S)===-1&&n.pendingLocalTracks.push(S)}),n.unbindLocalTrackEvents(e),h}let c=n.mapPubResToRemoteConfig(s,a,i),d=(yield yt(r.next(c))).value;if(n.state===Ht.Disconnected)throw new L(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");T("ENABLE_VIDEO_SEI");let l=T("ENABLE_ENCODED_TRANSFORM"),u=T("ENABLE_AUDIO_METADATA");i.forEach(async h=>{let p=h.getRTCRtpTransceiver();if(!p||!l)return;let{interceptLocalVideoFrame:S,interceptLocalAudioFrame:E}=qh();h.trackMediaType===Z.VIDEO?await S(p.sender,h):h.trackMediaType===Z.AUDIO&&await E(p.sender,{metadata:u?()=>{let f=h.metadata.shift();return f&&f.value}:void 0})}),e.forEach(h=>{let{type:p}=h;n.statsCollector.addLocalStats(p)}),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach(h=>{let{track:p,type:S}=h,E=Date.now();n.store.publish(p.getTrackId(),S===j.LocalAudioTrack?"audio":"video",void 0,E)})})()}async updateVideoStreamParameter(t,e){let n=this.localTrackMap.get(e);if(!n||!this.connection)return;if(!(n.track instanceof oe))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");let{track:i}=n,r=function(o,s){let a={};return o.height&&o.width&&(a.scaleResolutionDownBy=Cg(o,s)),a.maxFramerate=o.framerate?Yn(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(t,i);if(i._encoderConfig||(i._encoderConfig={}),e!==j.LocalVideoLowTrack||!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{let o=i._originMediaStreamTrack;if(!o.canvas)return _.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(s,a){let c=s.canvas;a.width&&(c.width=Yn(a.width)),a.height&&(c.height=Yn(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=Yf(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},Yn(a.framerate)))})(o,t)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),_.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(t){var e=this;return jn(function*(){if(!e.connection||e.state!==Ht.Connected)return;let n=yield yt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let r=e.localTrackMap.get(j.LocalVideoTrack);if(!r)throw new L(C.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(j.LocalVideoLowTrack))throw new L(C.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));let o=[{track:e.getLowVideoTrack(r.track,t),type:j.LocalVideoLowTrack}];if(yield*Xa(bN(e.doPublish(e.connection,o))),r.track.muted||!r.track.enabled){var i;let s=(i=e.localTrackMap.get(j.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;s!==void 0&&(yield yt(e.connection.muteLocal([s])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Ue(this,rt.RequestRePublish,this.pendingLocalTracks),this.emit(rt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Ue(this,rt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){let{user:n,kind:i}=this.pendingRemoteTracks[e];(i!==Z.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==Z.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await Ue(this,rt.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===Z.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:n}=e;this.emit(rt.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==Ht.Connected)return void t.forEach(i=>{let r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)});let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let n=e.find(i=>i[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==Ht.Connected)return void t.forEach(n=>{let i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)});let e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(n=>{let i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Ht.Connected)return;let t=this.localTrackMap.get(j.LocalVideoLowTrack);if(!t)return;t.track.close();let e=[[j.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){let n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(i=>{let[,{id:r}]=i;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(i=>{let[r,{track:o}]=i;return{type:r,track:o}})),e.forEach(i=>{let[r]=i;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==Ht.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let n=e.filter(i=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(i.id))});if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach(i=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(t,new Map([[i.id,i]]));let o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===t.uid&&c===i.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(i=>i.id)}async subscribe(t,e,n,i,r){var o;if(!this.connection||this.state!==Ht.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let s,a,c,d,l=this.connection.getPreMedia(n);if(l)_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),c=l.transceiver,s=l.track,a=l.mid,d=l.player,l.firstVideoRender&&this.store.firstVideoFrameDecoded(t.uid,{firstPreRender:l.firstVideoRender});else if(r){let p=r.find(E=>{let{stream_type:f}=E;return f===e});if(!p)throw new L(C.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));let S=await this.connection.receive(e,p.ssrcs,String(t._uintid),p.attributes);(this.connection instanceof Ii||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=S.transceiver),s=S.track,a=S.id}else{let p=await this.connection.receive(e,[{ssrcId:n,rtx:i}],String(t._uintid),void 0);(this.connection instanceof Ii||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=p.transceiver),s=p.track,a=p.id}if(e===Z.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new hc(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new uc(s,t.uid,t._uintid,this.store,d),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId())),t._videoTrack.once(Ui.PLAY_START,()=>{this.store.firstVideoFrameDecoded(t.uid,{playStart:Date.now()})}),t._videoTrack.once(Ui.PLAY_END,()=>{this.store.firstVideoFrameDecoded(t.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(t)}),d?t._videoTrack.once(Ui.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(t.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(t)}):t._videoTrack.once(Ui.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(t.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(t)})),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),c&&T("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:p,interceptRemoteAudioFrame:S}=qh();e==Z.VIDEO?await p(c.receiver,{onSei:T("ENABLE_VIDEO_SEI")&&(E=>{var f;return(f=t._videoTrack)===null||f===void 0?void 0:f._onSei(E)}),onFirstFrame:E=>{var f;let R=Array.from(bn(f=this.remoteUserMap).call(f)).find(v=>v._videoSSRC===E.ssrc);R&&this.store.firstVideoFrameDecoded(R.uid,{firstReceivedEncodedFrame:Date.now(),frameType:E.type,rtpTimestamp:E.rtpTimestamp,framePayloadType:E.payloadType,frameDataLength:E.length,mimeType:E.mimeType})}}):e==Z.AUDIO&&await S(c.receiver,{enableTopn:!!T("ENABLE_AUDIO_TOPN"),enableMetadata:!!T("ENABLE_AUDIO_METADATA"),enablePts:!!T("ENABLE_AUDIO_PTS"),onMetadata:E=>{this.safeEmit(rt.AudioMetadata,E)},onPts:E=>{this.safeEmit(rt.AudioPts,E)}})}let u=this.remoteUserMap.get(t);u?u.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();let h=this.pendingRemoteTracks.findIndex(p=>{let{user:S,kind:E}=p;return S.uid===t.uid&&e===E});h!==-1&&(this.pendingRemoteTracks.splice(h,1),this.emit(rt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==Ht.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(r=>{var o;let{user:s,mediaType:a}=r;return!((o=this.remoteUserMap.get(s))!==null&&o!==void 0&&o.has(a))});let e=[],n=new Map;t.forEach(r=>{if(!this.connection)return;let o=this.connection.getPreMedia(r.ssrcId);if(o){let{track:s,mid:a,transceiver:c,player:d}=o;n.set(r.ssrcId,{track:s,id:a,transceiver:c,player:d})}else e.push(r)});let i=await this.connection.batchReceive(e.map(r=>{let{user:o,mediaType:s,ssrcId:a,rtxSsrcId:c}=r;return{kind:s,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(o._uintid)}}));e.forEach((r,o)=>{n.set(r.ssrcId,i[o])});for(let{user:r,mediaType:o,ssrcId:s}of t){let a=n.get(s);if(!a)return void _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(o,", ").concat(s));let{track:c,id:d,transceiver:l,player:u}=a;if(l&&T("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:S,interceptRemoteAudioFrame:E}=qh();o==Z.VIDEO?await S(l.receiver,{onSei:T("ENABLE_VIDEO_SEI")&&(f=>{var R;return(R=r._videoTrack)===null||R===void 0?void 0:R._onSei(f)}),onFirstFrame:f=>{var R;let v=Array.from(bn(R=this.remoteUserMap).call(R)).find(I=>I._videoSSRC===f.ssrc);v&&this.store.firstVideoFrameDecoded(v.uid,{firstReceivedEncodedFrame:Date.now(),frameType:f.type,rtpTimestamp:f.rtpTimestamp,framePayloadType:f.payloadType,frameDataLength:f.length,mimeType:f.mimeType})}}):o==Z.AUDIO&&await E(l.receiver,{enableTopn:!!T("ENABLE_AUDIO_TOPN"),enableMetadata:!!T("ENABLE_AUDIO_METADATA"),enablePts:!!T("ENABLE_AUDIO_PTS"),onMetadata:f=>{this.safeEmit(rt.AudioMetadata,f)},onPts:f=>{this.safeEmit(rt.AudioPts,f)}})}if(o===Z.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new hc(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new uc(c,r.uid,r._uintid,this.store,u),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),T("ENABLE_VIDEO_SEI")&&l){let{interceptRemoteVideoFrame:S,interceptRemoteAudioFrame:E}=qh();o==Z.VIDEO?await S(l.receiver,{onSei:f=>{var R;(R=r._videoTrack)===null||R===void 0||R._onSei(f)},onFirstFrame:f=>{var R;let v=Array.from(bn(R=this.remoteUserMap).call(R)).find(I=>I._videoSSRC===f.ssrc);v&&this.store.firstVideoFrameDecoded(v.uid,{firstReceivedEncodedFrame:Date.now(),frameType:f.type,rtpTimestamp:f.rtpTimestamp,framePayloadType:f.payloadType,frameDataLength:f.length,mimeType:f.mimeType})}}):o==Z.AUDIO&&await E(l.receiver)}let h=this.remoteUserMap.get(r);h?h.set(o,d):this.remoteUserMap.set(r,new Map([[o,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();let p=this.pendingRemoteTracks.findIndex(S=>{let{user:E,kind:f}=S;return E.uid===r.uid&&o===f});p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(rt.MediaReconnectEnd,r.uid))}}async unsubscribe(t,e,n){let i=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(i.forEach(s=>{let a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===Ht.Connected||n||i.forEach(s=>{let{kind:a}=s;var c;if(a===Z.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===Z.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==Ht.Connected)return;let r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));let o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===Z.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===Z.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===Z.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(r=>{let o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;let n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach(r=>{r._close()});let i=this.remoteDataChannelMap.get(t);return n.forEach(r=>{i&&i.delete(r.id)}),i&&i.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map(r=>r.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(let{user:r,mediaType:o}of t){let s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{let c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(s)}if(!this.connection||this.state!==Ht.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===Z.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===Z.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});let n=Pi(t).call(t,(r,o)=>{let{user:s,mediaType:a}=o,c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(r=>{let[,{id:o}]=r;return o}));let i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===Z.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===Z.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===Z.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),i}isPreSubScribe(t){return!this.connection||this.state!==Ht.Connected?!1:!!this.connection.getPreMedia(t)}async muteRemote(t,e){if(!this.connection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let i=e===Z.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}addAudioMetadata(t){let e=this.localTrackMap.get(j.LocalAudioTrack),n=e&&e.track;n&&n.metadata.push(t)}getAllTracks(t){let e=this.localTrackMap.get(j.LocalAudioTrack);if(e?.track instanceof Be){let n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==j.LocalAudioTrack}).filter(i=>{let[r]=i;return!(t&&r===j.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(t&&i===j.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,i,r){if(t){let s=this.localTrackMap.get(j.LocalAudioTrack),a=i?this.localTrackMap.get(j.LocalVideoLowTrack):this.localTrackMap.get(j.LocalVideoTrack);tt.publish(this.store.sessionId,{eventElapse:Tn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Kt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);let s=n.find(c=>c instanceof Ae),a=i?(o=this.localTrackMap.get(j.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof oe);tt.publish(this.store.sessionId,{eventElapse:Tn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Kt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){let r=i===Z.VIDEO?n._videoSSRC:n._audioSSRC;r&&tt.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===Z.VIDEO,audio:i===Z.AUDIO,peerid:n.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:Tn.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new tn("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=$d(this.store),this.emit(rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(j.LocalAudioTrack);if(t?.track instanceof Be){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Ht.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(j.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(j.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof oe||e&&e.track instanceof Ae?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;let n=Array.from(bn(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(j.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Cs(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.connection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Ht.Reconnecting,T("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=$d(this.store),this.emit(rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case j.LocalVideoTrack:B(e=i._hints).call(e,Kt.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case j.LocalAudioTrack:i instanceof Be?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case j.LocalVideoLowTrack:}}),this.emit(rt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(bn(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(rt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,n]=t;Array.from(bn(n).call(n)).forEach(i=>{this.setPendingRemoteDataChannel(e,i)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(let n of this.pendingRemoteDataChannels){let{user:i,id:r}=n;if((t instanceof $o?t.uid:t)===i.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(let n of this.pendingRemoteTracks){let{user:i,kind:r}=n;if((t instanceof $o?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return jn(function*(){if(!e.connection||e.state!==Ht.Connected)return;let n=yield yt(e.mutex.lock("From P2PChannel.restartICE")),i;try{i=yield yt(e.connection.restartICE(t));let o=yield yt(i.next());if(o.done)return;let s=o.value,a=yield s;switch(Hg(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),t){case en.UDP_TCP_RELAY:e._pcStatsUploadType=Co.UDP_TCP_RESTART;break;case en.TCP_RELAY:e._pcStatsUploadType=Co.TCP_RESTART;break;case en.RELAY:e._pcStatsUploadType=Co.RELAY_RESTART;break;default:e._pcStatsUploadType=Co.OLD_RESTART}e._isTryConnecting=!0,i.next(a)}catch(o){var r;(r=i)===null||r===void 0||r.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=this.localTrackMap.get(j.LocalVideoTrack),n=this.localTrackMap.get(j.LocalAudioTrack),i=t.videoSend.find(p=>p.ssrc===e?.ssrcs[0].ssrcId),r=t.audioSend.find(p=>p.ssrc===n?.ssrcs[0].ssrcId);if(!i||!r)return 1;let o=di(this,rt.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(Kt.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,S=t.bitrate.actualEncoded;if(p&&S){let E=(1e3*p-S)/(1e3*p);return pO[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n,r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(S=>S.ssrc===r),a=t.videoRecv.find(S=>S.ssrc===o);if(!s&&!a)return void(e+=1);let c=di(this,rt.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new Y((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}async replaceTrack(t,e){var n;if(_.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==Ht.Connected)return;let i=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return t===s});if(!i)return;let r=i[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),i[1].track=e),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(e,i[1].id)),this.isPlanB){let o=i[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,o)}if(r===j.LocalVideoTrack&&!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding){let o=this.localTrackMap.get(j.LocalVideoLowTrack);if(o){let s=t._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new Y((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0)})}}}filterTobePublishedTracks(t,e,n){let i=[],r=this.getAllTracks();t=Za(t=t.filter(c=>r.indexOf(c)===-1));let o,s=!1,a=this.localTrackMap.get(j.LocalAudioTrack);for(let c of t){if(c instanceof oe&&(this.localTrackMap.has(j.LocalVideoTrack)||s?new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:j.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,n);i.push({track:d,type:j.LocalVideoLowTrack})}if(c instanceof Ae)if(a){let d=a.track;if(d instanceof Be)Gg([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{let l=Wg([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else o instanceof Be?(Gg([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&wt().webAudioMediaStreamDest&&!c._bypassWebAudio?o=Wg(o?[c,o]:[c]):o=c}return o&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:j.LocalAudioTrack})),i}filterTobeUnpublishedTracks(t){let e=[],n=this.getAllTracks();t=Za(t=t.filter(i=>n.indexOf(i)!==-1));for(let i of t){if(i instanceof Ae){let r=this.localTrackMap.get(j.LocalAudioTrack);if(!r)continue;r.track instanceof Be?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([j.LocalAudioTrack,r]),r.track.close())):e.push([j.LocalAudioTrack,r])}if(i instanceof oe){let r=this.localTrackMap.get(j.LocalVideoTrack);if(!r)continue;e.push([j.LocalVideoTrack,r]);let o=this.localTrackMap.get(j.LocalVideoLowTrack);o&&e.push([j.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=Za(t)).filter(e=>this.localDataChannels.findIndex(n=>n.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=Za(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case j.LocalVideoTrack:n.addListener(et.GET_STATS,this.handleGetLocalVideoStats),n.addListener(et.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(et.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(et.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case j.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case j.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Be?t.trackList.forEach(n=>{n.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(et.GET_STATS,this.handleGetLocalAudioStats),n.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(et.GET_STATS,this.handleGetLocalAudioStats),t.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(et.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return{track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case j.LocalVideoTrack:n.off(et.GET_STATS,this.handleGetLocalVideoStats),n.off(et.GET_RTC_STATS,this.handleGetRTCStats),n.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(et.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(et.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case j.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case j.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Be?t.trackList.forEach(e=>{e.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(et.GET_STATS,this.handleGetLocalAudioStats),e.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(et.GET_STATS,this.handleGetLocalAudioStats),t.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(et.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof uc&&e.addListener(et.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof hc&&e.addListener(et.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(et.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(Z.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(Z.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,s,{track:a,type:c}=n;switch(c){case j.LocalAudioTrack:o=Xt.Audio,s={dtx:a instanceof jd&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case j.LocalVideoTrack:o=B(r=a._hints).call(r,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High,s=eo(eo({},wO(a)),{},{codec:this.store.codec,svc_mode:Kd()});break;case j.LocalVideoLowTrack:o=Xt.Low,s=eo(eo({},wO(a)),{},{codec:this.store.codec,svc_mode:Kd()})}return{stream_type:o,attributes:s,ssrcs:e[i]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(rt.PeerConnectionStateChange,e),e==="connecting"&&t instanceof Ii&&!ue()&&T("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{e==="connecting"&&t.extendCandidate()},T("FIRST_TCP_CANDIDATE_INTERVAL")),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),t instanceof Ii&&yN(t,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=Co.DISCONNECTED_OR_FAILED,di(this,rt.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){let n=this.pendingLocalTracks.map(r=>r.getTrackId()),i=this.pendingLocalDataChannels.map(r=>"dc_".concat(r.id));tt.reportApiInvoke(this.store.sessionId,{name:me.REPUB_AFTER_PC_CONNECTED,options:n.concat(i),tag:re.TRACER}).onSuccess(),this.republish()}if(T("NEW_ICE_RESTART")&&t instanceof Ii&&!ue()&&!this._forceTurn&&!this.store.useDcSignal){if(B(CO).call(CO,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let n=r=>{Hg(t)&&(_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),di(this,rt.QueryClientConnectionState)==="CONNECTED"&&this.emit(rt.RequestRestartICE,r))},i=()=>{Hg(t)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),_.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(rt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{IN(t,n,i)},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&T("ICE_RESTART")&&di(this,rt.QueryClientConnectionState)==="CONNECTED"&&this.emit(rt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(rt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(rt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),tt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:re.TRACER}).onSuccess(),this.emit(rt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Ui.FIRST_FRAME_DECODED),tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_DECODE,Ee.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_RECEIVED,Ee.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{var r;let o=Array.from(bn(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===e);o&&this.store.firstVideoFrameDecoded(o.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoRender=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&(this.store.firstVideoFrameDecoded(i.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(i),this.emit(rt.FirstVideoPreRender,i.uid,e))},t.onFirstVideoReceived=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&(this.store.firstVideoFrameDecoded(i.uid,{firstReceived:Date.now()}),tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_VIDEO_RECEIVED,Ee.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstVideoBufferReady=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&this.emit(rt.FirstVideoBufferReady,i.uid,e)},t.onSelectedLocalCandidateChanged=(e,n)=>{let i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(rt.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Qo(n))," -> ").concat(JSON.stringify(Qo(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Qo(n))," -> ").concat(JSON.stringify(Qo(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{let e=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return eo(eo({},e),n)},t.onICECandidateError=e=>{this._iceError=e}}fallbackConnection(){_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===Ht.Connected?(_.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=$d(this.store),this.emit(rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(t){t instanceof Ii&&function(e){Ac.delete(e.id),yN(e)}(t),t.close(),this.emit(rt.PeerConnectionStateChange,"closed"),function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}(t),this._isWaitPcToRePub=!1}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let n=this.localTrackMap.get(j.LocalAudioTrack);if(t instanceof Ae&&n?.track instanceof Be)return n.track.isActive||e.push([j.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===j.LocalVideoTrack)){let r=this.localTrackMap.get(j.LocalVideoLowTrack);r&&e.push([j.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){let e=[],n=this.localTrackMap.get(j.LocalAudioTrack);if(t instanceof Ae&&n?.track instanceof Be)return n.track.isActive&&e.push([j.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===j.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(j.LocalVideoLowTrack);r&&e.push([j.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){let r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}])});return n}filterTobeUnSubscribedDataChannels(t,e){let n=[];return e.forEach(i=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)}),n}createUnsubscribeMessage(t){let e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case Z.VIDEO:return void(i._videoSSRC&&e.push({stream_type:Z.VIDEO,ssrcId:i._videoSSRC}));case Z.AUDIO:return void(i._audioSSRC&&e.push({stream_type:Z.AUDIO,ssrcId:i._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){let e=new Map;return t.forEach(n=>{let[i,{kind:r}]=n;if(e.has(i)){let o=e.get(i);r===Z.VIDEO?o|=ze.Video:o|=ze.Audio,e.set(i,o)}else r===Z.VIDEO?e.set(i,ze.Video):e.set(i,ze.Audio)}),{users:Array.from(e.entries()).map(n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e,r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){let e=this.localTrackMap.get(j.LocalVideoTrack),n=this.localTrackMap.get(j.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new Y((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)})),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new Y((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof Ii&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Ii)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof Ii&&this.connection.isPreRender}mapPubResToRemoteConfig(t,e,n){return t.map((i,r)=>{var o;let{stream_type:s}=i,a=(o=e.find(c=>{let{stream_type:d}=c;return s===d}))===null||o===void 0?void 0:o.attributes;if(a&&T("DISABLE_SCREEN_SHARE_REMB")){let c=n[r]._hints;(B(c).call(c,Kt.SCREEN_TRACK)||B(c).call(c,Kt.SCREEN_LOW_TRACK))&&(a.remb=!1,_.debug("disable remb for screen share, hints:",c))}return a})}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof Ae){var e;let i=this.filterTobeUnmutedTracks(t[n]);if(i.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(i.map(o=>{let[,{id:s}]=o;return s})));let r=this.createUnmuteMessage(i);return void await se(this,rt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(rt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(rt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var t;return{connectState:((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Ye(dh(this.dtlsFailedCount,Pe)),this.emit(rt.RequestReconnect)}async reconnectP2P(){let t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await Ue(this,rt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(rt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(j.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof oe)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof oe).length>1)throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Ae).length>1&&(t.some(e=>e instanceof Ae&&e._bypassWebAudio)||!wt().webAudioMediaStreamDest))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof oe&&this.pendingLocalTracks.some(n=>n instanceof oe))throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Ae&&this.pendingLocalTracks.some(n=>n instanceof Ae)&&(!wt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Ae&&n._bypassWebAudio)))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var n;let i=!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding,r=eo(eo({},{width:160,height:120,framerate:15,bitrate:50}),e),o;o=i?t._mediaStreamTrack.clone():Yg(t,r);let s=qt(8,"track-low-"),a=new oe(o,eo(eo({},i&&{scaleResolutionDownBy:Cg(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,s);return a.on(js.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,oc.LOW_STREAM)}),a._hints.push(Kt.LOW_STREAM),B(n=t._hints).call(n,Kt.SCREEN_TRACK)&&a._hints.push(Kt.SCREEN_LOW_TRACK),t.on("sei-to-send",c=>{a.emit("sei-to-send",c)}),t.addListener(et.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Ii){var r,o,s,a;let c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();tt.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:e?1:2,error:this._iceError||i||"",selectedLocalCandidateProtocol:(r=h?.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=h.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:(s=p.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(a=p.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(t){let e=this.store.keyMetrics,n=e.firstVideoFrameDecoded.find(l=>l.userId===t.uid);if(!n)return;let{isInternalUpload:i,isExternalUpload:r}=n;if(i&&r)return;let{subscribeEnd:o,firstPreRender:s,peerPublishDuration:a,peerPubStatusMs:c}=n,{firstRender:d=0}=n;if(o&&(d||s)&&a&&c){n.isInternalUpload=!0;let{playEnd:l}=n;l&&(n.isExternalUpload=!0);let{firstPreRender:u=0}=n;d=u||d;let h=t.videoTrack,p={peer:t._uintid,width:h?._videoWidth||0,height:h?._videoHeight||0,ssrc:t._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:a,peerPubStatusMs:c,joinChannelStart:e.joinStart||0,preloadStart:e.preloadStart||0,preloadEnd:e.preloadEnd||0,apStart:e.requestAPStart||0,apEnd:e.requestAPEnd||0,suaEnd:e.requestSUAEnd||0,beforeConnect:e.beforeConnect||0,peerReceiver:e.peerReceiver||0,ice:e.iceConnectionEnd||0,pc:e.peerConnectionEnd||0,signalConnected:e.signalConnected||0,joinReq:e.joinReq||0,joinRes:e.joinRep||0,userJoinNotify:n.userJoinNotify||0,videoAddNotify:n.videoAddNotify||0,subscribeStart:n.subscribeStart||0,subscribeEnd:n.subscribeEnd||0,firstReceived:n.firstReceived||0,firstDecoded:n.firstDecoded||0,firstPreRender:u||0,firstRender:l?Math.max(d,l):Math.max(d,o),playStart:n.playStart||0,playEnd:n.playEnd||0,isPreSub:!(!t._videoSSRC||!this.isPreSubScribe(t._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:zb(this.store),firstReceivedEncodedFrame:n.firstReceivedEncodedFrame||0,frameType:n.frameType||"",rtpTimestamp:n.rtpTimestamp||0,framePayloadType:n.framePayloadType||0,frameDataLength:n.frameDataLength||0,mimeType:n.mimeType||""};tt.firstXLAPeerFirstVideoFrame(this.store.sessionId,p)}}reportVideoFirstFrameDecoded(t,e,n,i){var r;let o=Array.from(bn(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");tt.firstRemoteVideoDecode(this.store.sessionId,Fe.FIRST_VIDEO_DECODE,Ee.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0,firstFrame:a?.firstFrame||0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return!1;let i=this.remoteUserMap.get(t);if(!i)return!1;let r=i.get(e);if(!r)return!1;let o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===j.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,oc.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},q(Nt.prototype,"startP2PConnection",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"startP2PConnection"),Nt.prototype),q(Nt.prototype,"connect",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"connect"),Nt.prototype),q(Nt.prototype,"updateRemoteRTPCapabilities",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"updateRemoteRTPCapabilities"),Nt.prototype),q(Nt.prototype,"publishDataChannel",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"publishDataChannel"),Nt.prototype),q(Nt.prototype,"unpublish",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unpublish"),Nt.prototype),q(Nt.prototype,"unpublishDataChannel",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unpublishDataChannel"),Nt.prototype),q(Nt.prototype,"unpublishLowStream",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unpublishLowStream"),Nt.prototype),q(Nt.prototype,"subscribeDataChannel",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"subscribeDataChannel"),Nt.prototype),q(Nt.prototype,"subscribe",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"subscribe"),Nt.prototype),q(Nt.prototype,"massSubscribe",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"massSubscribe"),Nt.prototype),q(Nt.prototype,"unsubscribe",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unsubscribe"),Nt.prototype),q(Nt.prototype,"unsubscribeDataChannel",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unsubscribeDataChannel"),Nt.prototype),q(Nt.prototype,"massUnsubscribe",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"massUnsubscribe"),Nt.prototype),q(Nt.prototype,"muteRemote",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"muteRemote"),Nt.prototype),q(Nt.prototype,"unmuteRemote",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"unmuteRemote"),Nt.prototype),q(Nt.prototype,"hasRemoteMediaWithLock",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"hasRemoteMediaWithLock"),Nt.prototype),q(Nt.prototype,"disconnectForReconnect",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"disconnectForReconnect"),Nt.prototype),q(Nt.prototype,"updateBitrateLimit",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"updateBitrateLimit"),Nt.prototype),q(Nt.prototype,"remoteMediaSsrcChanged",[On],Object.getOwnPropertyDescriptor(Nt.prototype,"remoteMediaSsrcChanged"),Nt.prototype),Nt);function On(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function wN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ON(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?wN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let XH=Date.now(),JH=20,Xg=new Map,op=new Map;async function NN(t){let e=Xg.get(t),n=Array.isArray(e)&&e[e.length-1],i=op.get(t);if(!n)return void(i.isSyncing=!1);let r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);let o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(e.pop(),DN(n.context,r),a=0):a=Math.min(a,JH),setTimeout(()=>e.length&&NN(t),a)}function DN(t,e){t.safeEmit(It.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function QH(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return DN(n,{uid:t.uid,payload:t.payload});let i="".concat(n.id,"-").concat(t.uid),r=Xg.get(i)||[],o=r.findIndex(d=>t.sendTs>=d.sendTs),s=ON(ON({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),Xg.set(i,r);let a=!1;var c;op.has(i)?a=!((c=op.get(i))===null||c===void 0||!c.isSyncing):op.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||NN(i)}let ZH=Vt().name;function PN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function LN(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?PN(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):PN(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let bc="websdk_ng_cache_parameter",$H=T("MAX_PRELOAD_ASYNC_LENGTH"),tK=1e4,ta=new Map,ea=[],Jg=null,Qg=0,Zg=0,sp=new Map,kN=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),eK=function(t,e){let n=[],i=0,r=async()=>{let o=n.shift();o&&await o(),n.length>0&&i<e?r():i--};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new Y(async(c,d)=>{n.push(async()=>{try{let l=await t(...s);c(l)}catch(l){d(l)}}),i<e&&(i++,r())})}}(tS,$H),$g=Gn.CancelToken.source();class nK{constructor(){g(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;let e=this._audioContext.sampleRate,n=10*e,i=this._audioContext.createBuffer(2,n,e),r=this._audioContext.createBufferSource();r.buffer=i;let o=this._audioContext.createMediaStreamDestination();return r.connect(o),r.start(),o.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function tS(t,e,n,i,r,o,s){try{if(!T("ENABLE_PRELOAD"))return;if(!wt().supportWebCrypto)return void Ko(()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new L(C.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&dn(n,"token",1,2047),dn(t,"appid",1,2047),Mh(e),i&&Uh(i);let a=xs();_.debug("preload channel ".concat(e,", uid is ").concat(i));let c={appId:t,cname:e,token:n||t,uid:typeof i!="string"?i:null,sid:a,proxyServer:r,role:s},d,l;typeof i=="string"?(c.stringUid=i,[l,d]=await Y.all([xH(i,{sid:a,appId:t},$g.token),rN(LN(LN({},c),{},{token:n||t,uid:0}),$g.token)]),c.uid=l.uid,d.gatewayInfo.uid=c.uid,d.gatewayInfo.res.uid=c.uid):(o&&(c.stringUid=o),d=await rN(c,$g.token));let u={sid:a,appId:t,cname:e,token:n||t,uid:c.stringUid||i,intUid:c.uid||d.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:l,ap:d};await nS(u),Qg++}catch(a){throw Zg++,function(c){Jg||(Jg=window.setTimeout(()=>{let l="";sp.forEach((u,h)=>{l+="".concat(h,": ").concat(u," ;")}),tt.reportApiInvoke(null,{name:me.PRELOAD,options:{success:Qg,failed:Zg,err:l}}).onError(c),Qg=0,Zg=0,sp.clear(),Jg=null},tK));let d=sp.get(c.code)||0;sp.set(c.code,d+1)}(a),a}}async function eS(t){try{if(T("AP_REQUEST_DETAIL")||T("ENABLE_ROLE_SELECT_EDGE"))return;let e=MN(t);if(!e||t.cloudProxyServer!=="disabled")return;let n=await async function(i,r){try{let o=await window.crypto.subtle.importKey("raw",Cb(r),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:kN},o,Us(i));return JSON.parse(window.atob(Yo(new Uint8Array(s))))}catch{return}}(e,t.token||t.appId);if(!n||!function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1}(n,t))return;if(n&&Date.now()-n.ts<T("AP_CACHE_LIFETIME"))return n}catch(e){_.warn("Error get preloadInfo",e.message)}}function MN(t){let e;try{if(e=VN(bc),!e)return;let n=JSON.parse(e),i=FN(t),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(n,s=>i in s);if(r===-1)return;let o=n.splice(r,1)[0];return ap(bc,JSON.stringify(n)),o[i]}catch(n){_.warn("Error delete preload info: ".concat(e),n.message),ap(bc,"")}}async function nS(t){let e;try{t.uid&&MN({appId:t.appId,cname:t.cname,token:t.token,uid:t.uid,stringUid:t.stringUid});let n=FN(t),i=await async function(o,s){try{let a=await window.crypto.subtle.importKey("raw",Cb(s),"AES-GCM",!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:kN},a,Us(window.btoa(JSON.stringify(o))));return Yo(new Uint8Array(c))}catch{return}}(t,t.token||t.appId);if(!i)return;e=VN(bc);let r=e?JSON.parse(e):[];r.push({[n]:i}),r.length>T("AP_CACHE_NUM")&&r.shift(),ap(bc,JSON.stringify(r))}catch(n){_.warn("Error caching server parameters:",n.message),ap(bc,"")}}function iS(t){if(t){let e=ta.get(t);e&&(window.clearTimeout(e),e=null,ta.delete(t)),B(ea).call(ea,t)||t.cloudProxyServer!=="disabled"||ea.push(t)}if(ta.size<T("AP_CACHE_NUM")&&ea.length>0){let e=ea.shift();ta.set(e,window.setTimeout(async()=>{let{appId:n,cname:i,token:r,stringUid:o,uid:s,proxyServer:a,role:c}=e;try{await eK(n,i,r,s,a,o,c),ta.has(e)&&iS(e)}catch(d){_.warn("update preload failed",d.message),UN(e)}},T("AP_UPDATE_INTERVAL")))}}function UN(t){let e=ea.indexOf(t);e!==-1&&ea.splice(e,1);let n=ta.get(t);n&&(window.clearTimeout(n),n=null,ta.delete(t),iS())}function xN(t,e){let n=t.sua,i=t.ap;e&&n&&tt.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),tt.reportResourceTiming(t.ap.url,t.sid),tt.joinWebProxyAP(t.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[Le.CHOOSE_SERVER,Le.CLOUD_PROXY_FALLBACK].toString()}),tt.joinChooseServer(t.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[Le.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function VN(t){return window.atob(window.localStorage.getItem(t)||"")}function ap(t,e){window.localStorage.setItem(t,window.btoa(e))}function FN(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),Ob(e)}function iK(t){let e=function(){let n=sK.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,i){let r=n.appId;r!==void 0&&(ke(i,10),es(i,r));let o=n.cid;o!==void 0&&(ke(i,16),ke(i,o));let s=n.cname;s!==void 0&&(ke(i,26),es(i,s));let a=n.deviceId;a!==void 0&&(ke(i,34),es(i,a));let c=n.elapse;c!==void 0&&(ke(i,40),ns(i,c));let d=n.fileSize;d!==void 0&&(ke(i,48),ns(i,wc(d)));let l=n.height;l!==void 0&&(ke(i,56),ns(i,wc(l)));let u=n.jpg;u!==void 0&&(ke(i,66),ke(i,u.length),jN(i,u));let h=n.networkType;h!==void 0&&(ke(i,72),ns(i,wc(h)));let p=n.osType;p!==void 0&&(ke(i,80),ns(i,wc(p)));let S=n.requestId;S!==void 0&&(ke(i,90),es(i,S));let E=n.sdkVersion;E!==void 0&&(ke(i,98),es(i,E));let f=n.sequence;f!==void 0&&(ke(i,104),ns(i,wc(f)));let R=n.sid;R!==void 0&&(ke(i,114),es(i,R));let v=n.timestamp;v!==void 0&&(ke(i,120),ns(i,v));let I=n.uid;I!==void 0&&(ke(i,128),ke(i,I));let w=n.vid;w!==void 0&&(ke(i,136),ke(i,w));let O=n.width;O!==void 0&&(ke(i,144),ns(i,wc(O)));let A=n.service;A!==void 0&&(ke(i,152),ke(i,A));let N=n.callbackData;N!==void 0&&(ke(i,162),ke(i,N.length),jN(i,N));let k=n.ticket;k!==void 0&&(ke(i,170),es(i,k));let V=n.vendorConfigs;V!==void 0&&(ke(i,178),es(i,V))}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function rK(t){return function(n){let i={};t:for(;!aK(n);){let r=el(n);switch(r>>>3){case 0:break t;case 1:i.code=el(n);break;case 2:i.msg=GN(n,el(n));break;case 3:i.requestId=GN(n,el(n));break;case 4:i.timestamp=cK(n,!1);break;default:oK(n,7&r)}}return i}({bytes:e=t,offset:0,limit:e.length});var e}function oK(t,e){switch(e){case 0:for(;128&cr(t););break;case 2:rS(t,el(t));break;case 5:rS(t,4);break;case 1:rS(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function wc(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let sK=[];function rS(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function aK(t){return t.offset>=t.limit}function cp(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),i}function BN(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function jN(t,e){let n=cp(t,e.length);t.bytes.set(e,n)}function GN(t,e){let n=BN(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h)}return s}function es(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}ke(t,i);let r=cp(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function cr(t){return t.bytes[BN(t,1)]}function WN(t,e){let n=cp(t,1);t.bytes[n]=e}function el(t){let e,n=0,i=0;do e=cr(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function ke(t,e){for(e>>>=0;e>=128;)WN(t,127&e|128),e>>>=7;WN(t,e)}function cK(t,e){let n,i=0,r=0,o=0;return n=cr(t),i=127&n,128&n&&(n=cr(t),i|=(127&n)<<7,128&n&&(n=cr(t),i|=(127&n)<<14,128&n&&(n=cr(t),i|=(127&n)<<21,128&n&&(n=cr(t),r=127&n,128&n&&(n=cr(t),r|=(127&n)<<7,128&n&&(n=cr(t),r|=(127&n)<<14,128&n&&(n=cr(t),r|=(127&n)<<21,128&n&&(n=cr(t),o=127&n,128&n&&(n=cr(t),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:e}}function ns(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=cp(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}let HN={},KN={},dp=4294967296,YN=dp*dp,qN=YN/2,oS=XN(0,!0),zN=XN(0),dK=Oc(0,-2147483648,!1),lK=Oc(-1,2147483647,!1),uK=Oc(-1,-1,!0);function XN(t,e){let n,i,r;return e?(r=0<=(t>>>=0)&&t<256)&&(i=KN[t],i)?i:(n=Oc(t,0,!0),r&&(KN[t]=n),n):(r=-128<=(t|=0)&&t<128)&&(i=HN[t],i)?i:(n=Oc(t,t<0?-1:0,!1),r&&(HN[t]=n),n)}function Oc(t,e,n){return{low:0|t,high:0|e,unsigned:!!n}}function JN(t,e){if(isNaN(t))return e?oS:zN;if(e){if(t<0)return oS;if(t>=YN)return uK}else{if(t<=-qN)return dK;if(t+1>=qN)return lK}return t<0?e?oS:zN:Oc(t%dp|0,t/dp|0,e)}function QN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class sS extends ge{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let n=this._connectionState;this._connectionState=e,this.emit(Ar.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var n;super(),g(this,"name","AgoraRTCImageModeration"),g(this,"_connectionState",Fi.CONNECTING),g(this,"_sequence",0),g(this,"_moderationStartTime",void 0),g(this,"_workerConnection",void 0),g(this,"_workerMessageLengthLimit",void 0),g(this,"_qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",Gn.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"_moderationInterval",void 0),g(this,"_moderationTimer",null),g(this,"_moderationMode",1),g(this,"_quality",1),g(this,"_qualityTimer",null),g(this,"_ticket",void 0),g(this,"_moderationIntervalMinimum",void 0),g(this,"_uploadFailedNum",0),g(this,"_uploadNum",0),g(this,"_uploadTimer",null),g(this,"_extraInfo",void 0),g(this,"_vendor",""),g(this,"_encoder",new TextEncoder),g(this,"_moderationId",void 0),g(this,"inspectImage",()=>{if(this.connectionState!==Fi.CONNECTED)throw new D(C.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Fi.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=qt(5,"image-moderation-"),this._workerMessageLengthLimit=T("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=T("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=T("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Wd("worker-"+this._moderationId,Pe),this.on(Ar.STATE_CHANGE,(i,r)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Ec[i]," ").concat(r||""))}),this.handleWorkerEvents()}async init(e,n){this.emit(Ar.STATE_CHANGE,Ec.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=n,new Y((r,o)=>{this.on(Ar.CONNECTION_STATE_CHANGE,(s,a)=>{s===Fi.CONNECTED&&r()}),this.requestAP(e,i,n).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===Fi.CONNECTED&&this.inspectImage()}async requestAP(e,n,i){let r=T("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,d,l,u){let{appId:h,areaCode:p,cname:S,sid:E,token:f,uid:R}=d;Rc++;let v="moderation_plugin",I={service_name:v,json_body:JSON.stringify({appId:h,areaCode:p,cname:S,command:"allocateEdge",requestId:Rc,seq:Rc,sid:E,appToken:f,ts:Date.now(),uid:R+""})},w,O,A=c[0];return Cr(async()=>{w=Date.now();let N=await wr(A,{data:I,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(O=Date.now()-w,N.code!==0){let dt=new D(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+N.code,{retry:!0,responseTime:O});throw _.error(dt.toString()),dt}let k=JSON.parse(N.json_body);if(k.code!==200){let dt=new D(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:O});throw _.error(dt.toString()),dt}if(!k.servers||!Array.isArray(k.servers)||k.servers.length===0){let dt=new D(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:k.code,responseTime:O});throw _.error(dt.toString()),dt}if(!k.servers.some(dt=>!!dt.wss)){let dt=new D(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:k.code,responseTime:O});throw _.error(dt.toString()),dt}let V=T("IMAGE_MODERATION_WORKER_WSS");if(V)return{addressList:[V],workerToken:k.workerToken,vid:k.vid,responseTime:O};let J=T("IMAGE_MODERATION_WORKER_HOST");return{addressList:k.servers.map(dt=>{let{address:Ct,wss:St}=dt;if(Ct&&St)return"wss://".concat(Ct.replace(/\./g,"-"),".").concat(J,":").concat(St,"/moderation")}).filter(dt=>!!dt),workerToken:k.workerToken,vid:k.vid,ticket:k.appTicket,responseTime:O}},(N,k)=>(tt.apworkerEvent(E,{success:!0,sc:200,serviceName:v,responseDetail:JSON.stringify(N.addressList),firstSuccess:k===0,responseTime:O,serverIp:c[k%c.length]}),!1),(N,k)=>(tt.apworkerEvent(E,{success:!1,sc:N.data&&N.data.code||200,serviceName:v,responseTime:O,serverIp:c[k%c.length]}),!!(N.code!==C.OPERATION_ABORTED&&N.code!==C.UNEXPECTED_RESPONSE||N.data&&N.data.retry)&&(A=c[(k+1)%c.length],!0)),u)}(r,e,n,i);this.emit(Ar.STATE_CHANGE,Ec.AP_CONNECTED);let{addressList:s,ticket:a}=o;return this._ticket=a,s}async connectWorker(e){this.emit(Ar.STATE_CHANGE,Ec.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Tt.CONNECTED,async()=>{this.emit(Ar.STATE_CHANGE,Ec.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Fi.CONNECTED}),this._workerConnection.on(Tt.CLOSED,()=>{this.connectionState=Fi.CLOSED}),this._workerConnection.on(Tt.FAILED,()=>{this.connectionState=Fi.CLOSED}),this._workerConnection.on(Tt.RECONNECTING,()=>{this.connectionState=this.connectionState===Fi.CONNECTED?Fi.RECONNECTING:Fi.CONNECTING}),this._workerConnection.on(Tt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let n=rK(new Uint8Array(e.data));T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,_.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{tt.reportApiInvoke(this._connectInfo.sid||null,{name:me.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:re.TRACER}).onError(new D(C.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},T("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else _.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Tt.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext")}),this._workerConnection.on(Tt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){let e=di(this,Ar.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));this._sequence++;let i=await this.generateRequestData(e,n);this._workerConnection.sendMessage(i,!0,!0)}else T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected")}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await T0(l,i,r),h=this._sequence+"-"+o+"-"+c+"-"+d+"-"+qt(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:sS.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.24.2",sequence:this._sequence,sid:a,timestamp:JN(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;let S=iK(p);if(S.byteLength<this._workerMessageLengthLimit){if(T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let E=function(f){for(var R=1;R<arguments.length;R++){var v=arguments[R]!=null?arguments[R]:{};R%2?QN(Object(v),!0).forEach(function(I){g(f,I,v[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(f,Object.getOwnPropertyDescriptors(v)):QN(Object(v)).forEach(function(I){Object.defineProperty(f,I,Object.getOwnPropertyDescriptor(v,I))})}return f}({},p);delete E.jpg,_.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(E))}return S}{let E=this.quality*this._qualityRatio;return this.quality=E,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Gn.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Fi.CLOSED,this.emit(Ar.STATE_CHANGE,Ec.CLOSED)}}function ZN(t){if(ie(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new D(C.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new D(C.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}let hK={name:"ImageModeration",create:function(t){let{config:e}=t;return ZN(e),new sS(e)}};var $N,tD,eD,nD,iD,rD,oD,sD,aD,cD,dD,lD,uD,hD,pD,_D,mD,ED,fD,gD,SD,TD,RD,CD,vD,yD,ID,AD,bD,wD,OD,ND,DD,PD,LD,kD,MD,UD,xD,VD,FD,BD,Q;function jD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function dr(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?jD(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):jD(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}tn.setLogger(_);let pK=($N=at(),tD=at({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof cc))return[e];e=[e]}return e.map(n=>n?Object(n).toString():"null")}}),eD=at({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==ac.DATA?(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())):[e.getChannelId()])}),nD=at({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),iD=at({argsMap:(t,e,n)=>[e,n]}),rD=at({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return[i?.uid,r]})}),oD=at({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),sD=at({argsMap:(t,e)=>e.map(n=>{let{user:i,mediaType:r}=n;return{uid:i?.uid,mediaType:r}})}),aD=at(),cD=at(),dD=at(),lD=at(),uD=at(),hD=at(),pD=at(),_D=at(),mD=at(),ED=at(),fD=at(),gD=at(),SD=at(),TD=at(),RD=at(),CD=at(),vD=at({argsMap:(t,e)=>[e]}),yD=at(),ID=at(),AD=at(),bD=at(),wD=at(),OD=at(),ND=at(),DD=at(),PD=at({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),LD=at(),kD=at(),MD=at(),UD=at(),xD=at(),VD=at(),FD=at({reportResult:!0}),BD=at(),Q=class extends ge{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){let n;if(super(),g(this,"store",void 0),g(this,"_uid",void 0),g(this,"_channelName",void 0),g(this,"_uintUid",void 0),g(this,"_users",[]),g(this,"_config",void 0),g(this,"_clientId",void 0),g(this,"_appId",void 0),g(this,"_sessionId",null),g(this,"_key",void 0),g(this,"_rtmConfig",{}),g(this,"_joinInfo",void 0),g(this,"_gateway",void 0),g(this,"_statsCollector",void 0),g(this,"_configDistribute",void 0),g(this,"_leaveMutex",void 0),g(this,"_publishMutex",void 0),g(this,"_renewTokenMutex",void 0),g(this,"_subscribeMutex",void 0),g(this,"_encryptionMode","none"),g(this,"_encryptionSecret",null),g(this,"_encryptionSalt",null),g(this,"_encryptDataStream",!1),g(this,"_encryptDataStreamKey",null),g(this,"_encryptDataStreamIv",null),g(this,"_proxyServer",void 0),g(this,"_turnServer",{servers:[],mode:"auto"}),g(this,"_cloudProxyServerMode","disabled"),g(this,"_isDualStreamEnabled",!1),g(this,"_defaultStreamFallbackType",void 0),g(this,"_lowStreamParameter",void 0),g(this,"_streamFallbackTypeCacheMap",new Map),g(this,"_remoteStreamTypeCacheMap",new Map),g(this,"_axiosCancelSource",Gn.CancelToken.source()),g(this,"_audioVolumeIndicationInterval",void 0),g(this,"_networkQualityInterval",void 0),g(this,"_userOfflineTimeout",void 0),g(this,"_streamRemovedTimeout",void 0),g(this,"_rteDetailInterval",void 0),g(this,"_liveTranscodeStreamingClient",void 0),g(this,"_liveRawStreamingClient",void 0),g(this,"_channelMediaRelayClient",void 0),g(this,"_networkQualitySensitivity","normal"),g(this,"_p2pChannel",void 0),g(this,"_useLocalAccessPoint",!1),g(this,"_setLocalAPVersion",void 0),g(this,"_joinAndNotLeaveYet",!1),g(this,"_numberOfJoinCount",0),g(this,"_joinResponse",null),g(this,"_remoteDefaultVideoStreamType",void 0),g(this,"_inspect",void 0),g(this,"_moderation",void 0),g(this,"_license",void 0),g(this,"_pendingPublishedUsers",[]),g(this,"ntpAlignErrorCount",0),g(this,"remoteInboundOffset",0),g(this,"_peerConnectionState",void 0),g(this,"_pendingRtpCapabilityChange",void 0),g(this,"_fallbackServerInfo",void 0),g(this,"_dualStreamMode",void 0),g(this,"_handleLocalTrackEnable",(r,o,s)=>{this.publish(r,!1).then(o).catch(s)}),g(this,"_handleLocalTrackDisable",(r,o,s)=>{this.unpublish(r).then(o).catch(s)}),g(this,"_handleUserOnline",r=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(r.uid,this.channelName))return void _.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let o=this._users.find(s=>s.uid===r.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(It.USER_JOINED,o));else{let s=new $o(r.uid,r.uint_id||r.uid);this._users.push(s),_.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(s.uid,{userJoinNotify:Date.now()}),this.safeEmit(It.USER_JOINED,s)}}),g(this,"_handleUserOffline",r=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(r.uid,this.channelName))return;let o=this._users.find(s=>s.uid===r.uid);o&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:ah(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),_.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(It.USER_LEAVED,o,r.reason))}),g(this,"_handleAddAudioOrVideoStream",(r,o,s,a,c,d,l,u)=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(o,this.channelName))return;let h=this._users.find(E=>E.uid===o);if(!h)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(h.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(h.uid,{videoAddNotify:Date.now()});let p=r==="audio"?h.hasAudio:h.hasVideo;h._uintid||(h._uintid=d||o),r==="audio"?h._trust_audio_stream_added_state_=!0:h._trust_video_stream_added_state_=!0,r==="audio"?(h._audio_added_=!0,s!==void 0&&(h._audioSSRC=s),a!==void 0&&(h._cname=a),l&&(h._audioOrtc=l)):(h._video_added_=!0,s!==void 0&&(h._videoSSRC=s),a!==void 0&&(h._cname=a),u!==void 0&&(h._rtxSsrcId=u),l&&(h._videoOrtc=l)),(r==="audio"?h.hasAudio:h.hasVideo)&&!p&&(_.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,h,r)),r==="video"?tt.onGatewayStream(this._sessionId,Fe.ON_ADD_VIDEO_STREAM,Ee.ON_ADD_VIDEO_STREAM,{peer:d||o,ssrc:h._videoSSRC}):tt.onGatewayStream(this._sessionId,Fe.ON_ADD_AUDIO_STREAM,Ee.ON_ADD_AUDIO_STREAM,{peer:d||o,ssrc:h._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(h,r,s).then(E=>{if(E&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(h.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof $s))return this._p2pChannel.unsubscribe(h,r,!0).then(()=>this._subscribe(h,r,!0).catch(f=>{_.error("[".concat(this._clientId,"] resubscribe error"),f.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(h,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(h.uid," after reconnect.")),this._subscribe(h,r,!0).catch(E=>{_.error("[".concat(this._clientId,"] resubscribe error"),E.toString())}));let S=this._getEncodingName(c);r==="video"&&(S==="unknown"?this.safeEmit(It.AV1_DECODABLE_RESULT,!1):$e()||An()||S?.toLocaleLowerCase()!==Fs.av1||UH().then(E=>{T("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(It.AV1_DECODABLE_RESULT,E),E||this._gateway.downgradeCodec(S)}))}),g(this,"_handleRemoveStream",r=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(r.uid,this.channelName))return;let o=this._users.find(a=>a.uid===r.uid);if(!o)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let s=()=>{};o.hasAudio&&o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof $s&&this._p2pChannel.unsubscribe(o).then(a=>{if(a)return this._gateway.unsubscribe(a,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),tt.onGatewayStream(this._sessionId,Fe.ON_REMOVE_STREAM,Ee.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),s()}),g(this,"_handleSetStreamLocalEnable",(r,o,s)=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(o,this.channelName))return;let a=this._users.find(l=>l.uid===o);if(!a)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(s?"enabled":"disabled"," with uid ").concat(o));let c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;let l=a._audio_enabled_;if(a._audio_enabled_=s,a._audio_enabled_===l)return;{let u=a._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,o,u)}}else{a._trust_video_enabled_state_=!0;let l=a._video_enabled_;if(a._video_enabled_=s,a._video_enabled_===l)return;{let u=a._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,o,u)}}let d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(_.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(r)),void this.safeEmit(It.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),_.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(r)),void this.safeEmit(It.USER_UNPUBLISHED,a,r)):void 0}),g(this,"_handleMuteStream",(r,o,s)=>{if(T("BLOCK_LOCAL_CLIENT")&&qs(r,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),r,o,s);let a=this._users.find(l=>l.uid===r);if(!a)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));let c=o==="audio"?a.hasAudio:a.hasVideo;if(o==="audio"){a._trust_audio_mute_state_=!0;let l=a._audio_muted_;if(a._audio_muted_=s,a._audio_muted_===l)return;{let u=a._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,r,u)}}else{a._trust_video_mute_state_=!0;let l=a._video_muted_;if(a._video_muted_=s,a._video_muted_===l)return;{let u=a._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,r,u)}}let d=o==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(o==="audio"?a._audioSSRC:a._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(o)),void this.safeEmit(It.USER_PUBLISHED,a,o)):void _.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));o==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),o==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,o),_.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(o)),this.safeEmit(It.USER_UNPUBLISHED,a,o)}}),g(this,"_handleP2PLost",async r=>{_.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():_.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)}),g(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(It.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),g(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),g(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(It.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(It.NETWORK_QUALITY,r)}),g(this,"_handleP2PAddAudioOrVideoStream",(r,o,s,a)=>{let c=this._users.find(l=>l.uid===o);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());let d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,s!==void 0&&(c._audioSSRC=s),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,s!==void 0&&(c._videoSSRC=s),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(_.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch(l=>{_.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),this._config=t,this._clientId=e||qt(5,"client-"),this.store=new class{constructor(r,o,s,a,c){Et(this,"state",void 0),this.state={codec:r,audioCodec:o,mode:s,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Vs.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!c}}dispatch(r){this.state=function(o,s){switch(s.type){case ht.SET_SESSION_ID:return W(W({},o),{},{sessionId:s.sessionId});case ht.SET_P2P_ID:return W(W({},o),{},{p2pId:s.p2pId});case ht.SET_UID:return W(W({},o),{},{uid:s.uid});case ht.SET_INT_UID:return W(W({},o),{},{intUid:s.intUid});case ht.SET_PUB_ID:return W(W({},o),{},{pubId:s.pubId});case ht.KEY_METRIC_CLIENT_CREATED:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{clientCreated:s.metric})});case ht.KEY_METRIC_JOIN_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinStart:s.metric})});case ht.KEY_METRIC_PRELOAD_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{preloadStart:s.metric})});case ht.KEY_METRIC_PRELOAD_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{preloadEnd:s.metric})});case ht.KEY_METRIC_JOIN_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinEnd:s.metric})});case ht.KEY_METRIC_REQUEST_AP_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{requestAPStart:s.metric})});case ht.KEY_METRIC_REQUEST_AP_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{requestAPEnd:s.metric})});case ht.KEY_METRIC_REQUEST_SUA_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{requestSUAEnd:s.metric})});case ht.KEY_METRIC_BEFORE_CONNECT:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{beforeConnect:s.metric})});case ht.KEY_METRIC_PEER_RECEIVER:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{peerReceiver:s.metric})});case ht.KEY_METRIC_SIGNAL_CONNECTED:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{signalConnected:s.metric})});case ht.KEY_METRIC_JOIN_REQ:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinReq:s.metric})});case ht.KEY_METRIC_JOIN_REP:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinRep:s.metric})});case ht.KEY_METRIC_JOIN_GATEWAY_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinGatewayStart:s.metric})});case ht.KEY_METRIC_JOIN_GATEWAY_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{joinGatewayEnd:s.metric})});case ht.KEY_METRIC_PEER_CONNECTION_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{peerConnectionStart:s.metric})});case ht.KEY_METRIC_PEER_CONNECTION_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{peerConnectionEnd:s.metric})});case ht.KEY_METRIC_DESCRIPTION_START:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{descriptionStart:s.metric})});case ht.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{signalChannelOpen:s.metric})});case ht.KEY_METRIC_ICE_CONNECTION_END:return W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{iceConnectionEnd:s.metric})});case ht.KEY_METRIC_PUBLISH:{let a=o.keyMetrics.publish,c=a.findIndex(d=>d.trackId===s.metric.trackId);return c!==-1?(a[c]=W(W({},a[c]),s.metric),W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{publish:[...a]})})):W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{publish:[...o.keyMetrics.publish,s.metric]})})}case ht.KEY_METRIC_SUBSCRIBE:{let a=o.keyMetrics.subscribe,c=a.findIndex(d=>d.userId===s.metric.userId&&d.type===s.metric.type);return c!==-1?(a[c]=W(W({},a[c]),s.metric),W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{subscribe:[...a]})})):W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{subscribe:[...o.keyMetrics.subscribe,s.metric]})})}case ht.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{let a=o.keyMetrics.firstVideoFrameDecoded,c=a.findIndex(d=>d.userId===s.metric.userId);return c!==-1?(a[c]=W(W({},a[c]),s.metric),W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{firstVideoFrameDecoded:[...a]})})):W(W({},o),{},{keyMetrics:W(W({},o.keyMetrics),{},{firstVideoFrameDecoded:[...o.keyMetrics.firstVideoFrameDecoded,s.metric]})})}case ht.RESET_FIRST_VIDEO_FRAME_DECODED:return o.keyMetrics.firstVideoFrameDecoded=[],o;case ht.SET_CLOUD_PROXY_SERVER_MODE:return o.cloudProxyServerMode=s.mode,o;case ht.RECORD_JOIN_CHANNEL_SERVICE:return typeof s.index!="number"?o.joinChannelServiceRecords=[...o.joinChannelServiceRecords,s.record]:(o.joinChannelServiceRecords[s.index]=W(W({},o.joinChannelServiceRecords[s.index]),s.record),o.joinChannelServiceRecords=[...o.joinChannelServiceRecords]),o;case ht.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return o.joinChannelServiceRecords=[],o;case ht.RESET_KEY_METRICS:return o.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},o;case ht.SET_USE_P2P:return W(W({},o),{},{useP2P:s.val});case ht.SET_TRANSPORT_TYPE:return W(W({},o),{},{p2pTransport:s.val});case ht.SET_RTE_URL:return W(W({},o),{},{rteUrl:s.rteUrl});case ht.SET_RTE_SID:return W(W({},o),{},{rteSid:s.rteSid});default:return o}}(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:ht.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:ht.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:ht.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:ht.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:ht.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:ht.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:ht.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:ht.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:ht.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:ht.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:ht.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:ht.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:ht.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:ht.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:ht.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:ht.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:ht.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:ht.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:ht.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:ht.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:ht.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:ht.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:ht.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:ht.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:ht.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:ht.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:ht.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:ht.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,o){this.dispatch({type:ht.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:W({userId:r},o)})}descriptionStart(){this.dispatch({type:ht.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:ht.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:ht.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,o,s,a){this.dispatch({type:ht.KEY_METRIC_PUBLISH,metric:W(W({trackId:r,type:o},s&&{publishStart:s}),a&&{publishEnd:a})})}subscribe(r,o,s,a,c,d,l){this.dispatch({type:ht.KEY_METRIC_SUBSCRIBE,metric:W(W(W(W(W({userId:r,type:o},s&&{subscribeStart:s}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),d&&{streamAdded:d}),l&&{firstDecoded:l})})}massSubscribe(r,o,s,a){r.forEach(c=>{this.dispatch({type:ht.KEY_METRIC_SUBSCRIBE,metric:W(W(W({userId:c.userId,type:c.type},o&&{subscribeStart:o}),s&&{subscribeEnd:s}),a&&{firstFrame:a})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,o){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map(s=>s.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof o!="number"?(this.dispatch({type:ht.RECORD_JOIN_CHANNEL_SERVICE,record:W(W({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(o<0||o>=this.state.joinChannelServiceRecords.length||this.dispatch({type:ht.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:o}),o)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:ht.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:ht.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:ht.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(t.codec,t.audioCodec,t.mode,this._clientId,T("SIGNAL_CHANNEL")===1),this._leaveMutex=new tn("client-leave",this._clientId),this._publishMutex=new tn("client-publish",this._clientId),this._renewTokenMutex=new tn("client-renewtoken",this._clientId),this._subscribeMutex=new tn("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(ki," build: ").concat(kf,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Sf(t.clientRoleOptions),n=Object.assign({},t.clientRoleOptions)}catch(r){_.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var i;this._statsCollector=new Zd(this.store),this._statsCollector.onStatsException=(r,o,s)=>{_.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(o,", uid: ").concat(s)),r===Vg.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(a=>{a instanceof yh&&T("ENABLE_ENCODE_EXCEPTION")&&a.findClosestProfile()}),this.safeEmit(It.EXCEPTION,{code:r,msg:o,uid:s})},this._statsCollector.onUploadPublishDuration=(r,o,s,a)=>{let c=this._users.find(d=>d.uid===r);c&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(c.uid,{peerPublishDuration:s,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(c)),tt.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:o,videoPublishDuration:s,peer:c._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(T("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){let o=this.localTracks.find(s=>s instanceof oe);o&&o._saveEncodeBitrateRatio!==1&&o.setSaveEncodeBitrateRatio(r==="h264"?T("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=t.mode==="p2p",this._gateway=new NH(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Pe,httpRetryConfig:t.httpRetryConfig||Pe,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:n}),this._configDistribute=new jH(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(i={store:this.store,statsCollector:this._statsCollector},br("P2PChannel").create(i)),this._handleP2PEvents()):this._p2pChannel=new $s(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,n,i,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];$t("JOIN_GATEWAY_USE_443PORT_ONLY",o),$t("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);let a=this._gateway.signal.websocket;return a instanceof Sg&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(c,d,l){ih.get(c)||ih.set(c,[]),rh.get(c)||rh.set(c,d),Hr.get(c)||Hr.set(c,0);let u=ih.get(c),h=rh.get(c);if(!u||!h)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Hr.get(c)===h){let R=Nd();u.push(R),await R.promise}Hr.set(c,Hr.get(c)+1);for(var p=arguments.length,S=new Array(p>3?p-3:0),E=3;E<p;E++)S[E-3]=arguments[E];let f=await l(...S);return Hr.set(c,Hr.get(c)-1),Hr.get(c)===h-1&&u.length>0&&(u[0].resolve(),u.shift()),Hr.get(c)===0&&(ih.set(c,[]),rh.set(c,0),Hr.set(c,0)),f}("client.join",T("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,i,r)}async join(t,e,n,i,r){let o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);let s=(lh||lh||(lh=(window.location.protocol.split(":")[0]||"").toUpperCase(),lh))==="HTTPS",a=Db()?window.isSecureContext:"Browser Not Support";(!Db()&&!s||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let c;tt.setAppId(t);try{if(!n&&n!==null)throw new D(C.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));if(n&&dn(n,"token",1,2047),dn(t,"appid",1,2047),Mh(e),i&&Uh(i),r)if(typeof r=="string")dn(r,"optionalInfo",1,256),c=r;else{if(typeof r!="object")throw new D(C.INVALID_PARAMS,"Invalid options: options is not a string or object");{let{autoSubscribe:f,enableInstantMuteRestore:R,networkQualityProbe:v}=r;f&&($i(f,"autoSubscribe"),_.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(f)),this.store.autoSubscribe=f),R&&($i(R,"enableInstantMuteRestore"),_.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(R)),this.store.enableInstantMuteRestore=R),v&&($i(v,"networkQualityProbe"),_.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(v)),this.store.networkQualityProbe=v)}}}catch(f){throw tt.reportApiInvoke(xs(),{name:me.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:re.TRACER}).onError(f),f}if(this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let f=new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw tt.reportApiInvoke(xs(),{name:me.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:re.TRACER}).onError(f),f}this._gateway.state="CONNECTING",this.store.preloadStart();let d=await eS({appId:t,cname:e,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||t,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));let l=d?.sid||xs();_.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId);let u=tt.reportApiInvoke(this._sessionId,{id:this._clientId,name:me.JOIN,options:[t,e,n,i],states:{isHttps:s,isSecureContext:a},tag:re.TRACER}),h=dr(dr(dr({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:c,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:T("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(h.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(h.stringUid=i,this._uintUid?(h.uid=this._uintUid,this._uintUid=void 0):h.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(h.aesmode=this._encryptionMode,h.aespassword=await(async f=>{let R=function(O){let A=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),N=new Uint8Array(new ArrayBuffer(A.length));for(let k=0;k<A.length;k+=1)N[k]=A.charCodeAt(k);return N}(),v=await window.crypto.subtle.importKey("spki",R,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),I=ff(f),w=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},v,I);return function(O){let A="";for(let N=0;N<O.length;N+=1)A+=String.fromCharCode(O[N]);return window.btoa(A)}(new Uint8Array(w))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(h.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){let f=new TextEncoder,R=T("USE_PURE_ENCRYPTION_MASTER_KEY")?f.encode(h.appId+this._encryptionSecret+this._encryptionSecret):f.encode(h.appId+h.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(v,I,w){let O=await window.crypto.subtle.importKey("raw",I,"PBKDF2",!1,["deriveBits","deriveKey"]),A=v==="aes-128-gcm2"?128:256,N=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:jb,hash:"SHA-256",salt:w},O,A+c4);return new Uint8Array(N).subarray(A/8)}(this._encryptionMode,R,Us(this._encryptionSalt)),this._encryptDataStreamKey=await async function(v,I,w){let O=await window.crypto.subtle.importKey("raw",I,"PBKDF2",!1,["deriveBits","deriveKey"]),A=v==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:jb,hash:"SHA-256",salt:w},O,{name:"AES-GCM",length:A},!0,["encrypt","decrypt"])}(this._encryptionMode,R,Us(this._encryptionSalt))}else a?_.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):_.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,_.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:h.stringUid});let p=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&p===this._sessionId&&tt.joinChannelTimeout(this._sessionId,5)},5e3);try{var S;let f,R=h.cloudProxyServer;if(B(S=["proxy3","proxy4","proxy5"]).call(S,R)){let A=T("PROXY_SERVER_TYPE3");Array.isArray(A)?h.proxyServer=A[0]:h.proxyServer=A}if(tt.setProxyServer(h.proxyServer),_.setProxyServer(h.proxyServer),this.store.requestAPStart(),d){if(_.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(h.stringUid?", ".concat(h.stringUid," => ").concat(d.intUid):""," ")),h.stringUid&&!h.uid&&(h.uid=d.intUid),f={gatewayInfo:d.ap.gatewayInfo},T("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&h.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{let A=(await OO(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map(N=>({turnServerURL:N.address,tcpport:N.tcpport||_n.tcpport,udpport:N.udpport||_n.udpport,username:N.username||_n.username,password:N.password||_n.password,forceturn:!1,security:!0}));h.turnServer={mode:"manual",servers:A}}xN(d,h.stringUid)}else{if(h.stringUid&&!h.uid){let A;[A,f]=await Y.all([iN(h.stringUid,h,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe,this.store).finally(()=>{this.store.requestSUAEnd()}),nN(h,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),_.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(h.stringUid," => ").concat(A)),h.uid=A,f.gatewayInfo.uid=A,f.gatewayInfo.res.uid=A}else f=await nN(h,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe,!0,this.store);if(!this._joinAndNotLeaveYet)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(h,this._axiosCancelSource.token),this._configDistribute.on(Ir.UPDATE_BITRATE_LIMIT,A=>{this._p2pChannel.updateBitrateLimit(A)}),this._configDistribute.on(Ir.UPDATE_CLIENT_ROLE_OPTIONS,A=>{this._setClientRoleOptions(A)}),this._configDistribute.on(Ir.UPDATE_REMOTE_VIDEO_STREAM_TYPE,A=>{var N;B(N=[0,1,4,5,6,7,8,9]).call(N,A)&&(this.remoteUsers.forEach(k=>{this._remoteStreamTypeCacheMap.get(k.uid)!==A&&this.setRemoteVideoStreamType(k.uid,A)}),this.setRemoteDefaultVideoStreamType(A))}),this._configDistribute.on(Ir.FALLBACK_TO_HLS,A=>{A&&this.safeEmit(It.FALLBACK_TO_HLS,Tf.CONFIG)}),this._configDistribute.on(Ir.UPDATE_VOS_CONFIGURE,A=>{this._gateway.setConfigure(A).catch(N=>{_.debug("[".concat(this._clientId,"] auto set vos config failed"),N)})})},0),this._key=n||t;let v=f.gatewayInfo,I=h.uid?h.uid:v.uid;this._joinInfo=dr(dr({},h),{},{cid:v.cid,uid:I,vid:v.vid,apResponse:v.res,apGatewayAddress:v.apGatewayAddress,uni_lbs_ip:v.uni_lbs_ip,gatewayAddrs:v.gatewayAddrs}),this.store.intUid=I,this.store.cid=v.cid;let w=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(w),this._appId=t,this._channelName=h.cname,this._uid=w,this.store.uid=w,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!$e()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener($e()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);let O=h.stringUid?"string uid: ".concat(h.stringUid,",uid: ").concat(h.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(O)),setTimeout(()=>{_.startUpload()},5e3),this.store.joinEnd(),E=this,B(Ys).call(Ys,E)||Ys.push(E),this._cloudProxyServerMode==="disabled"&&wt().supportWebCrypto&&T("ENABLE_PRELOAD")&&iS(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&tt.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval(()=>{this._sessionId&&tt.reportRteDetail(this._sessionId)},T("RTE_DETAIL_REPORT_INTERVAL")||6e4),w}catch(f){let R=Array.isArray(f)?f[0]:f;throw R&&R.code===C.OPERATION_ABORTED?_.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),R):_.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),R),R.code!==C.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(R),R}var E}async _joinGateway(){if(!this._joinInfo||!this._key)throw new D(C.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!T("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(t){if(t.code===C.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,Dt.FALLBACK),_.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new D(C.INVALID_OPERATION);return tt.reportApiInvoke(this._sessionId,{name:me.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:re.TRACER}).onSuccess(),await this._joinGateway()}throw t}}async leave(){_.info("[".concat(this._clientId,"] Leaving channel"));let t=()=>{!$e()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener($e()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(n){let i=Ys.indexOf(n);i!==-1&&Ys.splice(i,1)}(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||t();let e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED",Dt.LEAVE),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e(),this.store.useDcSignal&&t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof cc))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new D(C.INVALID_PARAMS,"param list is empty");let n=t;if(this._gateway.role==="audience")throw new D(C.INVALID_OPERATION,"audience can not publish stream");for(let r of n){if(!(r instanceof cc))throw new D(C.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new D(C.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));let i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach(r=>{let o=this._configDistribute.getBitrateLimit();r instanceof oe&&o&&r.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),_.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw _.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(t){if(t==null)throw new D(C.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(t)));ie(t.id,"id",0,65535,!0),$i(t.ordered,"ordered"),dn(t.metadata,"metadata",0,512),_.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));let e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===t.id)!==-1)throw new D(C.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new D(C.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&T("FORCE_TURN")&&!T("TURN_ENABLE_TCP")&&!T("TURN_ENABLE_UDP"))throw new D(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let n=function(r){return qO(r,!1)}(t),i=await this._p2pChannel.publishDataChannel([n]);if(i.length>0){if(typeof n._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new D(C.CREATE_DATACHANNEL_ERROR);try{await Y.all(i.map(r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0))),await n._waitTillOpen()}catch(r){if(r.code!==C.DISCONNECT_P2P)throw r}}return _.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw _.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new D(C.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof cc))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(i=>"".concat(i.getTrackId()," "))," "));let n=await this._publishMutex.lock();try{if(this.store.useP2P){let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.sendExtensionMessage(Oe.UNPUBLISH,{unpubMsg:i},!0)}else{let i=await this._p2pChannel.unpublish(e);i&&await this._gateway.unpublish(i,this._uid),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(i){throw _.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),_.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(n=>"".concat(n.id," "))," "));let e=await this._publishMutex.lock();try{let n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),_.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(i=>"".concat(i.id))))}catch(n){throw _.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e()}}async subscribe(t,e,n){if(!(t instanceof $o)){let i=this.remoteUsers.find(r=>r.uid===t);if(!i)throw new D(C.INVALID_REMOTE_USER,"user is not in the channel");t=i}return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(De(e,"mediaType",["audio","video"]),this.store.useP2P)throw new D(C.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new D(C.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let n=e===Z.AUDIO,i=e===Z.VIDEO,r=await this._subscribeMutex.lock();try{let{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new D(C.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(h=>h.uid===t);l||(l=new $o(t,d||t),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||t),n&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,s&&(l._audioOrtc=s)),i&&(l._videoSSRC=o,l._video_pre_subscribed=!0,s&&(l._videoOrtc=s),a!=null&&(l._rtxSsrcId=a)),_.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(l,e,o,a,s);let u=n?l._audioTrack:l._videoTrack;if(!u)throw new D(C.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(o){throw _.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{r()}}async _subscribeDataChannel(t,e){var n;if(ie(e,"channelId",0,65535,!0),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new D(C.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new D(C.INVALID_REMOTE_USER,"user is not published");let r=(n=t._dataChannels)===null||n===void 0?void 0:n.find(a=>a.id===e);if(!r)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new D(C.REMOTE_USER_IS_NOT_PUBLISHED);let o=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{let a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&B(a).call(a,r.id))try{var s;if(typeof r._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new D(C.CREATE_DATACHANNEL_ERROR);let c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(s=r.metadata)!==null&&s!==void 0?s:""};await this._gateway.subscribeDataChannel(t.uid,c,!0),await r._waitTillOpen()}catch(c){if(c?.code!==C.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return _.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{o()}}async _p2pSubscribe(t,e,n){if(De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===t)){let o=new D(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),o}if(!t.hasAudio&&!t.hasVideo){let o=new D(C.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),o}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){let o=new D(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),o}let r=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{let s=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(t,e,s,a)}catch(s){throw s}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(s=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),s)});let o=e==="audio"?t._audioTrack:t._videoTrack;if(!o)throw new D(C.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),o),o}finally{r()}}async _subscribe(t,e,n){if(this.store.useP2P)return this._p2pSubscribe(t,e);if(De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){let d=new D(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){let d=new D(C.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){let d=new D(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?Z.AUDIO:Z.VIDEO,ssrcId:r};e==="video"&&this.store.firstVideoFrameDecoded(t.uid,{subscribeStart:Date.now()});let c=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{let l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==r&&(r=l,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?Z.AUDIO:Z.VIDEO,ssrcId:r}),Tn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,s,o);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(t.uid,a,!0)}catch(u){if(u?.code!==C.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),u;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l?.code,t,e),l}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(l=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),l)});let d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new D(C.UNEXPECTED_ERROR,"can not find remote track in user object");return e==="video"&&(this.store.firstVideoFrameDecoded(t.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(t)),d}catch(d){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if(So(t,"subscribeList"),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let e=Date.now(),n=new Map,i=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c?.uid,", mediaType: ").concat(d)}).join("; ")));let r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),o=await this._p2pChannel.globalLock();try{var s;for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d;if(De(u,"mediaType",["audio","video"]),!l){let E=new D(C.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),E}if(!this._users.find(E=>E===l)){let E=new D(C.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=E,t.splice(c,1);continue}if(u==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||u==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){let E=new D(C.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(u,", remote user is not published")),r[c].error=E,t.splice(c,1);continue}let p=ze.Video|ze.LwoVideo,S=n.get(l);if(S){if(u==="video"?S&p:S&ze.Audio){t.splice(c,1),_.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(u," twice"));continue}n.set(l,S|(u==="video"?p:ze.Audio))}else n.set(l,u==="video"?p:ze.Audio)}for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d,h=ze.Video|ze.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,u)){await this._p2pChannel.unmuteRemoteNoLock(l,u);let p=n.get(l);n.set(l,u==="video"?p^h:p^ze.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);let a=Pi(s=Array.from(n.entries())).call(s,(c,d)=>{let[l,u]=d;if(u===0)return c;let h={stream_id:l.uid,stream_type:u};return u&ze.Audio&&(h.audio_ssrc=l._audioSSRC),u&ze.Video&&(h.video_ssrc=l._videoSSRC),c.push(h),c},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:l,mediaType:u}=d;return{user:l,mediaType:u,ssrcId:u===Z.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:u===Z.VIDEO?l._rtxSsrcId:void 0}}));let c=new Map;if(a=a.filter(d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc),a.length>0){let d=await this._gateway.subscribeAll(a,!0);(d?.users||[]).forEach(l=>{let{stream_id:u,video_error_code:h,audio_error_code:p,error_code:S}=l;(h||p||S)&&c.set(u,{video_error_code:h,audio_error_code:p,error_code:S})})}if(Array.from(c.entries()).length>0){let d=[];Array.from(c.entries()).forEach(l=>{let[u,h]=l,p=this.remoteUsers.find(S=>S.uid===u);if(p){let S;h.error_code||h.video_error_code&&h.audio_error_code?S=void 0:h.video_error_code?S=Z.VIDEO:h.audio_error_code&&(S=Z.AUDIO),d.push({user:p,mediaType:S})}}),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(let d of r){let l=c.get(d.user.uid);if(l){let u=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(u){let h=Xs(u);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(h.desc)),d.error=new D(C.SUBSCRIBE_FAILED,"code ".concat(u,": ").concat(h.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var l;tt.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===Z.VIDEO,audio:d.mediaType===Z.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===Z.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)}),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:l,mediaType:u}=d;return"user: ".concat(l?.uid,", mediaType: ").concat(u)}).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{o(),i()}}async unsubscribe(t,e,n){if(!(t instanceof $o)){let o=this.remoteUsers.find(s=>s.uid===t);if(!o)throw new D(C.INVALID_REMOTE_USER,"user is not in the channel");t=o}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&De(e,"mediaType",["audio","video"]),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===t)){let o=new D(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));let r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(t,e);else{let o=await this._p2pChannel.unsubscribe(t,e);o&&await this._gateway.unsubscribe(o,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&ah(this._users,t),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(o){if(o.code===C.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}finally{r()}}async _unsubscribeDataChannel(t,e){if(e&&ie(e,"id",0,65535,!0),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){let r=new D(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let i;if(typeof e=="number"){let r=t._dataChannels.find(o=>o.id===e);r&&(i=[r])}else i=t._dataChannels;if(i===void 0){let r=new D(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map(r=>r.id)));try{let r=await this._p2pChannel.unsubscribeDataChannel(t,i);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),_.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===C.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(So(t,"unsubscribeList"),!this._joinInfo)throw new D(C.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i?.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];let e=new Map;for(let n=t.length-1;n>=0;n--){let{user:i,mediaType:r}=t[n];if(!i){let a=new D(C.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(De(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===i)){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),t.splice(n,1);continue}let s=ze.Video|ze.LwoVideo;if(e.has(i)){let a=e.get(i),c;switch(r){case"video":c=a&s;break;case"audio":c=a&ze.Audio;break;default:c=a&(ze.Audio|s)}if(c){_.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),t.splice(n,1);continue}r?r==="audio"?e.set(i,a|ze.Audio):r==="video"&&e.set(i,a|s):e.set(i,a|ze.Audio|s)}else r?r==="audio"?e.set(i,ze.Audio):r==="video"&&e.set(i,s):e.set(i,ze.Audio|s)}try{let n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(i=>{let{user:r,mediaType:o}=i;return"user: ".concat(r?.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===C.DISCONNECT_P2P)return void _.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){(function(n){if(!n)throw new L(C.INVALID_PARAMS);Ce(n.width)||mf(n.width,"streamParameter.width"),Ce(n.height)||mf(n.height,"streamParameter.height"),Ce(n.framerate)||mf(n.framerate,"streamParameter.framerate"),Ce(n.bitrate)||ie(n.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));let e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,j.LocalVideoLowTrack)}async setDualStreamMode(t,e){De(t,"mode",[0,1,-1]);try{switch(e&&await this.setLowStreamParameter(e),this._dualStreamMode=t,this._joinInfo?this._gateway.setDualStreamMode(t).catch(n=>{_.warning("[".concat(this._clientId,"] set dual stream mode failed"),n.toString())}):_.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(t)),t){case Qa.AUTO_SIMULCAST_STREAM:_.info("[".concat(this._clientId,"] set dual stream mode to ").concat(t));break;case Qa.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case Qa.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(n){throw _.error("[".concat(this._clientId,"] set dual stream mode error"),n.toString()),n}}async enableDualStream(){if(!wt().supportDualStream)throw tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new D(C.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new D(C.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,this._dualStreamMode=Qa.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(t=>{_.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),t.toString())}),tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void _.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(j.LocalVideoLowTrack))try{let t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,this._dualStreamMode=Qa.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(t=>{_.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),t.toString())}),tt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(i){De(i,"role",["audience","host"])}(t),e&&Sf(e),this.mode==="rtc"||this.mode==="p2p")throw _.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new D(C.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new D(C.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new D(C.INVALID_OPERATION,"can not set client role to audience when publishing stream");let n=this._config.role;if(this._joinInfo&&(this._joinInfo.role=t),t!==n&&T("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(t,e),this._config.role=t,this._gateway.reconnect("recover",pn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(t,e),this._config.role=t),_.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level)),n==="audience"&&t!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof $s){let{video_codec:i}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(i.map(r=>r.toLowerCase()).filter(r=>{var o;return B(o=Object.keys(Fs)).call(o,r)}))}}async _setClientRoleOptions(t){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{t&&Sf(t),await this._gateway.setClientRole(this._config.role,t),e=!0}catch{}finally{_.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(t))}}getRemoteInboundOffset(){var t;let e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;let n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(dn(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new D(C.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new D(C.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,tt.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new D(C.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new D(C.INVALID_OPERATION,"You have already set the proxy")}if(Ps(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>Sb(n)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new D(C.INVALID_OPERATION,"you should set license before join channel");if(dn(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new D(C.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new D(C.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new D(C.INVALID_OPERATION,"You have already set the proxy");let e=[3,4,5],n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new D(C.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new D(C.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new D(C.INVALID_OPERATION,"Stop proxy server after leave channel");tt.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new D(C.INVALID_PARAMS,"accessPoints is required.");So(t.accessPoints.serverList,"accessPoints.serverList"),dn(t.accessPoints.domain,"accessPoints.domain");let e=(h,p)=>{ie(h,p,0,65535,!0)},n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new D(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");T("CLOSE_AFB_FOR_LOCAL_AP")&&($t("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),$t("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(h=>i.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h),s=o.map(h=>"".concat(h,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,$t("WEBCS_DOMAIN",s),$t("WEBCS_DOMAIN_BACKUP_LIST",s),$t("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(So(t.report.hostname,"report.hostname"),$t("EVENT_REPORT_DOMAIN",t.report.hostname[0]),$t("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):($t("EVENT_REPORT_DOMAIN",o[0]),$t("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),$t("STATS_COLLECTOR_PORT",a),t.report?$t("ENABLE_EVENT_REPORT",!0):$t("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(So(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),$t("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(So(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=o;let u=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),u=t.cds.port),$t("CDS_AP",l.map(h=>"".concat(h,":").concat(u))),t.cds?$t("ENABLE_CONFIG_DISTRIBUTE",!0):$t("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(So(t,"serverList"),dn(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new D(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(e):i),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,$t("WEBCS_DOMAIN",t),$t("WEBCS_DOMAIN_BACKUP_LIST",t),$t("GATEWAY_DOMAINS",[e]),$t("EVENT_REPORT_DOMAIN",t[0]),$t("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),$t("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(De(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else _.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){De(e,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{let n=this._users.find(i=>i.uid===t);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){De(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(n){throw _.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,n,i){(function(o){De(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),dn(e,"secret");let r=["aes-128-gcm2","aes-256-gcm2"];if(B(r).call(r,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new D(C.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new D(C.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if($i(i,"encryptDataStream"),!B(r).call(r,t))throw new D(C.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=Yo(n))}async renewToken(t){if(dn(t,"token",1,2047),!this._key||!this._joinInfo)throw new D(C.INVALID_OPERATION,"renewToken should not be called before user join");let e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);let n=await this._renewTokenMutex.lock();try{if(T("USE_NEW_TOKEN")){_.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let i=await BH(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:i})}else _.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});_.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=e,this._joinInfo.token=e,_.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let t=this._p2pChannel.getAudioLevels();this.safeEmit(It.VOLUME_INDICATOR,t)},T("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new D(C.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new D(C.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new D(C.LIVE_STREAMING_TASK_CONFLICT);let n=e?Xr.TRANSCODE:Xr.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient(Xr.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){let e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(t));if(!e.length)throw new D(C.INVALID_PARAMS,"can not find live streaming url to stop");await Y.all(e.map(n=>n&&n.stopLiveStreamingTask(t)))}async startChannelMediaRelay(t){dN(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){dN(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(t){this._p2pChannel instanceof $s&&this._p2pChannel.addAudioMetadata(t)}async sendStreamMessage(t){var e;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new D(C.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){let r=new TextEncoder;t.payload=r.encode(t.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&B(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(i=!0,t.payload=await async function(r,o,s){var a;let c=Pi(a=Array.from(s)).call(a,(E,f)=>E+f,0),d={serverTs:0,seq:d4++,length:s.length,checkSum:c},l=new Uint8Array(wb(c,2)),u=new ArrayBuffer(ic),h=new DataView(u);h.setUint32(0,d.serverTs),h.setUint16(4,d.seq),h.setUint16(6,d.length),h.setUint16(8,d.checkSum);let p=16-s.length%16;s=vb(s,new Uint8Array(p));let S=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:Bb,additionalData:l},o,s);return vb(new Uint8Array(u),new Uint8Array(S))}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new D(C.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(it.DATA_STREAM,{payload:Yo(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-XH},!n)}sendMetadata(t){if(!this._joinInfo)throw new D(C.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new D(C.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(it.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Yo(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(g4),!this._joinInfo)throw new D(C.INVALID_OPERATION,"can not send custom report, not joined");await tt.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){let t=this._statsCollector.getRemoteNetworkQualityStats();if(T("DELETE_NEQ_AFTER_USER_LEAVE")){let e=this._users.map(n=>n.uid+"");Object.keys(t).forEach(n=>{B(e).call(e,n)||delete t[n]})}return t}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(t,e){De(e.spatialLayer,"spatialLayer",[0,1,2,3]),De(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(n){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){let{apRTM:e=!1,rtmFlag:n}=t;if($i(e,"apRTM"),ie(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,_.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),function(t){let e=_c.indexOf(t);e!==-1&&_c.splice(e,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=Gn.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&UN(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&tt.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&tt.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new tn("client-publish",this._clientId),this._subscribeMutex=new tn("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;let i=t||xs();t?_.debug("[".concat(this._clientId,"] new Session ").concat(i)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));let r=t?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i,tt.addSid(i);let o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:e?.stringUid||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};tt.sessionInit(this._sessionId,dr({cname:e.channel,appid:e.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new D(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&T("FORCE_TURN")&&!T("TURN_ENABLE_TCP")&&!T("TURN_ENABLE_UDP"))throw new D(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{let n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){let i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(Oe.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let r of t)r instanceof oe&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch(o=>{_.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,t),n?.code===C.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new D(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new D(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));let t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{let n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw n.throw(o),o}n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,void 0,!0),n?.code===C.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){let e=()=>{if(!this._joinInfo||!this._appId)return new D(C.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let n=(i={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},br("LiveStreaming").create(i));var i;return n.onLiveStreamError=(r,o)=>{tt.reportApiInvoke(this._sessionId,{name:me.ON_LIVE_STREAM_ERROR,options:[r,o],tag:re.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_ERROR,r,o)},n.onLiveStreamWarning=(r,o)=>{tt.reportApiInvoke(this._sessionId,{name:me.ON_LIVE_STREAM_WARNING,options:[r,o],tag:re.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_WARNING,r,o)},n.on(Eg.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new D(C.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,d,l){let u=T("UAP_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map(h=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(h+"/api/v1?action=uap"):"https://".concat(h,"/api/v1?action=uap"));return await LH(u,a,c,d,l)})(r,this._joinInfo,this._axiosCancelSource.token,Pe).then(o).catch(s)}),n};return t===Xr.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new D(C.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:e,sendResolutionHeight:n}=this.getLocalVideoStats(),i=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:n}},br("ChannelMediaRelay").create(t));i.on("state",r=>{r===$n.RELAY_STATE_FAILURE&&i&&i.dispose(),this.safeEmit(It.CHANNEL_MEDIA_RELAY_STATE,r)}),i.on("event",r=>{this.safeEmit(It.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._channelMediaRelayClient=i,this._statsCollector.onStatsChanged=(r,o)=>{var s;r==="resolution"&&((s=this._channelMediaRelayClient)===null||s===void 0||s.setVideoProfile(o))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){let{added:n,deleted:i}=t,r=[];if(e){let o=[];this._users.forEach(s=>{s._dataChannels.forEach(a=>{n.every(c=>c.uid!==s._uintid||c.stream_id!==a.id)&&o.push({uid:s._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(n)&&n.length>0&&n.forEach(o=>{let{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=o,u=this._users.find(h=>h._uintid===s);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),B(r).call(r,u)||r.push(u),u._uintid||(u._uintid=s),u._dataChannels.findIndex(h=>h.id===o.stream_id)===-1){let h={id:a,ordered:!!c,maxRetransmits:d,metadata:l},p=function(S){return qO(S,!0)}(h);u._dataChannels.push(p),_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published datachannel")),e||this.safeEmit(It.USER_PUBLISHED,u,"datachannel",h)}this._p2pChannel.hasPendingRemoteDataChannel(u,o.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(u.uid," after reconnect.")),this._subscribeDataChannel(u,o.stream_id).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),h.toString())}))}),e&&(this.safeEmit(It.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach(o=>{let{uid:s,stream_id:a}=o,c=this._users.find(l=>l._uintid===s);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let d=c._dataChannels.find(l=>l.id===o.stream_id);d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(l=>{if(c._dataChannels=c._dataChannels.filter(u=>u!==d),l)return this._gateway.unsubscribeDataChannel(l,c.uid)}),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(It.USER_UNPUBLISHED,c,"datachannel",d._config))})}_getEncodingName(t){var e,n;if(!this._joinResponse)return;let i=(e=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||e===void 0?void 0:e.videoCodecs;if(!i)return;for(let a of i){var r;if(a.payloadType===t)return a==null||(r=a.rtpMap)===null||r===void 0?void 0:r.encodingName}let o=(n=this._joinResponse.ortc.rtpCapabilities.recv)===null||n===void 0?void 0:n.videoCodecs;if(o)for(let a of o){var s;if(a.payloadType===t)return a==null||(s=a.rtpMap)===null||s===void 0?void 0:s.encodingName}return t===0?"unknown":void 0}_handleRemoveDataChannels(t){let e=this._users.find(n=>n.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));let n=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(i=>{this.safeEmit(It.USER_UNPUBLISHED,e,"datachannel",i._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(i=>{if(i)return this._gateway.unsubscribeDataChannel(i,e.uid)}),n()}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(we.UPDATE_GATEWAY_CONFIG,()=>{(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{let e=JSON.parse(window.atob(t)),n=Date.now();Object.keys(e).forEach(i=>{let{value:r,type:o,expires:s}=e[i];s&&s<=n||o||dg()||!Object.prototype.hasOwnProperty.call(_h,i)||(gi[i]=r,zt[i]=r,_.debug("Update gateway parameters from config distribute",i,r))})}catch(e){_.error("Error update config from local cache",e.message)}})()}),this._gateway.on(we.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(we.CONNECTION_STATE_CHANGE,(t,e,n)=>{var i;if(n===Dt.FALLBACK)return;let r=()=>{this.safeEmit(It.CONNECTION_STATE_CHANGE,t,e,n)};if(tt.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:me.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:re.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),_.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),T("VOS_CONFIGURE")&&Array.isArray(T("VOS_CONFIGURE"))&&T("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(T("VOS_CONFIGURE")).catch(s=>{_.debug("[".concat(this._clientId,"] auto set vos config failed"),s)}),_.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch(s=>{_.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),s)}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,Z.AUDIO,!1)),s._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,Z.VIDEO,!1)),s._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}r()}),this._gateway.on(we.REQUEST_NEW_GATEWAY_LIST,async(t,e)=>{if(!this._joinInfo)return e(new D(C.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;if(this._fallbackServerInfo)n=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,tt.reportApiInvoke(this._sessionId,{name:me.VOS_FALLBACK_CN,options:{cur:n.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:re.TRACER}).onSuccess(),_.info("[".concat(this._clientId,"] use fallback cn server info"));else{let r=await eS(dr(dr({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(n=r.ap,xN(r),this._joinInfo.preload=!0):(n=await Qh(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);let i=[];n.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r,[s,a]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:s,port:a}):i.push({host:s,port:a})}),t(i)}catch(n){e(n)}}),this._gateway.on(we.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(It.NETWORK_QUALITY,t)}),this._gateway.on(we.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(It.STREAM_TYPE_CHANGED,t,e),tt.reportApiInvoke(this._sessionId,{name:me.STREAM_TYPE_CHANGE,options:[t,e],tag:re.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(we.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(we.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,n)=>{try{let i=await this._p2pChannel.getEstablishParams();i&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(i=await this._p2pChannel.startP2PConnection(t)),e(i)}catch(i){n(i)}}),this._gateway.on(we.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;let n;this._joinResponse=t,t.attributes?n=t.attributes.userAttributes.preSubSsrcs:_.debug("no attributes in joinResponse");let i=xO(t.ortc,e,n);this._p2pChannel.connect(i)}),this._gateway.on(we.PRE_CONNECT_PC,async(t,e,n)=>{let{candidates:i,fingerprint:r,turnServer:o}=t;if(this._joinInfo&&i.length>0&&!this._p2pChannel.isPlanB){let{cert:a,cid:c}=this._joinInfo.apResponse,d="".concat(c,"_").concat(a);if(d.length<4||d.length>256)return void _.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(d.length));await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var s;e(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(c,"_").concat(a),icePwd:"".concat(c,"_").concat(a)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(s=T("FINGERPRINT"))!==null&&s!==void 0?s:r}]},candidates:i,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(l){l.code&&l.code===C.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),n(l)}}}),this._gateway.on(we.VOS_FALLBACK,t=>{t==="fallback_hls"&&this.safeEmit(It.FALLBACK_TO_HLS,Tf.VOSERROR)}),this._gateway.on(we.RESET_SIGNAL,()=>{this._p2pChannel instanceof $s&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()}),this._gateway.on(we.DATACHANNEL_FAILBACK,()=>{tt.reportApiInvoke(this._sessionId,{name:me.DATACHANNEL_FAILBACK,options:{},tag:re.TRACER}).onSuccess(),this._joinGateway()})}_handleGatewaySignalEvents(){this._gateway.signal.on(pt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(pt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(pt.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.pt,t.uint_id,t.ortc)),this._gateway.signal.on(pt.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.pt,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(pt.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(pt.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(pt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(pt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(pt.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,Z.AUDIO,!0)),this._gateway.signal.on(pt.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,Z.AUDIO,!1)),this._gateway.signal.on(pt.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,Z.VIDEO,!0)),this._gateway.signal.on(pt.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,Z.VIDEO,!1)),this._gateway.signal.on(pt.RECEIVE_METADATA,t=>{let e=Us(t.metadata);this.safeEmit(It.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(pt.ON_DATA_STREAM,async t=>{var e;if(!t)return;let n=Us(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&B(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<ic)throw new D(C.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(ic));n=await async function(o,s,a){let c=a.subarray(0,ic),d=c.slice(8,ic),l=(d[0]<<8)+d[1],u=(c[6]<<8)+c[7],h=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:Bb,additionalData:new Uint8Array(wb(l,2))},s,a.subarray(ic));return new Uint8Array(h).subarray(0,u)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let i=0;if(t.ordered||t.syncWithAudio){let r=this._p2pChannel.getStats(),o=this.remoteUsers.find(a=>a.uid===t.uid),s=r?.audioRecv.find(a=>a.ssrc===o?._audioSSRC);i=s?.jitterBufferMs}(i==null||Number.isNaN(i))&&(i=0),QH(dr(dr({},t),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(pt.ON_CRYPT_ERROR,()=>{Ko(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(It.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(pt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Dt.TOKEN_EXPIRE),this.safeEmit(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(pt.ON_STREAM_FALLBACK_UPDATE,t=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(It.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(pt.ENABLE_MULTI_STREAM,t=>{this._dualStreamMode===Qa.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch(e=>{_.debug("[".concat(this._clientId,"] set dual stream mode error"),e.toString())})}),this._gateway.signal.on(pt.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(pt.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(pt.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(nt.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case it.PUBLISH:{if(!e)return;let r=e.ortc;if(r){var n,i;let o=r.some(c=>{let{stream_type:d}=c;return d===Xt.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==Xt.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===Xt.Screen||d===Xt.ScreenLow});e.state==="offer"&&tt.publish(this._joinInfo.sid,{eventElapse:Tn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:C.TIMEOUT,audio:o,video:s,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(n=r.find(c=>{let{stream_type:d}=c;return d===Xt.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:s?(i=r.find(c=>{let{stream_type:d}=c;return d!==Xt.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case it.SUBSCRIBE:e&&tt.subscribe(this._joinInfo.sid,{succ:!1,ec:C.TIMEOUT,audio:e.stream_type===Z.AUDIO,video:e.stream_type===Z.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:Tn.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}}),this._gateway.signal.on(pt.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(pt.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;T("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(i=>!qs(i.string_id||i.stream_id,this.channelName)));let e=[],n=[];for(let i of t.users){let r=this._users.find(l=>l._uintid===i.stream_id);r?r._trust_in_room_=!0:(r=new $o(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(It.USER_JOINED,r)));let o=ze.Audio&i.stream_type,s=(ze.Video|ze.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),o&&!c&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(It.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(It.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(i=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())})),this.getListeners(It.PUBLISHED_USER_LIST).length>0?T("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(i=>i.uid).join(", "))),this.safeEmit(It.PUBLISHED_USER_LIST,e)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(i=>i.uid).join(", ")))}),this._gateway.signal.on(pt.ON_RTP_CAPABILITY_CHANGE,t=>{let{video_codec:e}=t;if(this._p2pChannel instanceof $s){if(this.role==="audience"&&T("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=t,void _.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(t)));this._p2pChannel.updateRemoteRTPCapabilities(e.map(n=>n.toLowerCase()).filter(n=>{var i;return B(i=Object.keys(Fs)).call(i,n)}))}}),this._gateway.signal.on(nt.VOS_FALLBACK_PROMISE,async(t,e,n)=>{if(t==="FALLBACKCN"&&T("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return n(new D(C.UNEXPECTED_ERROR,"can not recover, no join info"));_.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));let r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=t;let o=await Qh(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Pe,this.store);if(T("QUALITY_FALLBACK_REHEARSAL"))return tt.reportApiInvoke(this._sessionId,{name:me.VOS_FALLBACK_CN,options:{cur:o.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:re.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void n();this._fallbackServerInfo=o,e()}catch(o){var i;let s=o==null||(i=o.data)===null||i===void 0?void 0:i.desc;T("QUALITY_FALLBACK_REHEARSAL")?(tt.reportApiInvoke(this._sessionId,{name:me.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+s||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:re.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(s)&&B(s).call(s,"request downgrade fallback")&&this.safeEmit(It.FALLBACK_TO_HLS,Tf.AP_ERROR),n(o)}}else n()})}_handleP2PEvents(){this._gateway.signal.on(pt.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Oe.PUBLISH,(t,e,n)=>{let{uid:i}=t;t.forEach(r=>{let{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,i,s[0].ssrcId,a);let d=this._users.find(l=>l.uid===i);return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{e()}).catch(n):e(),this._handleMuteStream(i,o,!!c)})}),this._gateway.signal.on(Oe.CALL,async(t,e,n)=>{if(this.store.useP2P)try{var i;e(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},t))}catch(r){n(r)}}),this._gateway.signal.on(nt.P2P_CONNECTION,async t=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(t)}),this._gateway.signal.on(Oe.UNPUBLISH,async(t,e,n)=>{if(this.store.useP2P){let{unpubMsg:i,uid:r}=t,o=this._users.find(s=>s.uid===r);if(!o)return _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{i.forEach(async s=>{let{stream_type:a}=s,c=a===Xt.Audio?Z.AUDIO:Z.VIDEO;await this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0)}),e()}catch(s){n(s)}}}),this._gateway.signal.on(Oe.CONTROL,async(t,e)=>{let{action:n}=t;switch(n){case Jo.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,Z.VIDEO,!0);break;case Jo.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,Z.AUDIO,!0);break;case Jo.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,Z.VIDEO,!1);break;case Jo.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,Z.AUDIO,!1)}}),this._gateway.signal.on(Oe.RESTART_ICE,async(t,e,n)=>{if(this.store.useP2P)try{let{direction:i,iceParameter:r}=t;i!==Vn.SEND_ONLY||r?e(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),e())}catch(i){n(i)}}),this._gateway.signal.on(Oe.CANDIDATE,t=>{if(this.store.useP2P){let{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n)}}),this._p2pChannel.on(rt.RequestP2PRestartICE,async(t,e,n)=>{try{let{direction:i}=t;e(await this._gateway.sendExtensionMessage(Oe.RESTART_ICE,t,i===Vn.SEND_ONLY))}catch(i){n(i)}}),this._p2pChannel.on(rt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(Oe.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(rt.RequestP2PMuteLocal,async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(Oe.CONTROL,t,!0),e()}catch(i){n(i)}}),this._p2pChannel.on(rt.RequestP2PUnmuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===C.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(rt.RequestP2PMuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===C.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(rt.StateChange,(t,e)=>{e===Ht.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(rt.PeerConnectionStateChange,t=>{let e=this._peerConnectionState;t!==e&&(this.safeEmit(It.PEERCONNECTION_STATE_CHANGE,t,e),this._peerConnectionState=t)}),this._p2pChannel.on(rt.RequestMuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===C.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(rt.RequestUnmuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===C.DISCONNECT_P2P?e():n(i)}else e()}),this._p2pChannel.on(rt.RequestRePublish,(t,e,n)=>{this.publish(t,!1).then(e).catch(n)}),this._p2pChannel.on(rt.RequestRePublishDataChannel,(t,e,n)=>{Y.all(t.map(async i=>{let r=await this._p2pChannel.publishDataChannel([i]);try{r.forEach(o=>{this._uid&&this._gateway.publishDataChannel(this._uid,o,!0)})}catch(o){if(o.code!==C.DISCONNECT_P2P)throw o}})).then(e).catch(n)}),this._p2pChannel.on(rt.RequestReSubscribe,async(t,e,n)=>{try{for(let{user:i,kind:r}of t)r===Z.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");e()}catch(i){n(i)}}),this._p2pChannel.on(rt.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(rt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(rt.MediaReconnectStart,t=>{this.safeEmit(It.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(rt.MediaReconnectEnd,t=>{this.safeEmit(It.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(rt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(rt.RequestRestartICE,async t=>{if(this.store.useP2P)return;let e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;let i=n.value,r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(s){return void e.throw(s)}let{iceParameters:o}=function(s){let a=s.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(rt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(rt.RequestReconnectPC,async()=>{var t;let{iceParameters:e,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:i}),s=xO(r,o);await this._p2pChannel.connect(s),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(rt.RequestUnpublishForReconnectPC,async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n()}),this._p2pChannel.on(rt.P2PLost,()=>{this.safeEmit(It.P2P_LOST,this.store.uid)}),this._p2pChannel.on(rt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(rt.ConnectionTypeChange,t=>{this.safeEmit(It.IS_USING_CLOUD_PROXY,t),this._gateway.setUsingProxy(t)}),this._p2pChannel.on(rt.FirstVideoBufferReady,(t,e)=>{this.safeEmit(It.FIRST_VIDEO_BUFFER_READY,t,e)}),this._p2pChannel.on(rt.FirstVideoPreRender,(t,e)=>{this.safeEmit(It.FIRST_VIDEO_PRE_RENDER,t,e)}),this._p2pChannel.on(rt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(rt.QueryClientConnectionState,t=>{t(this.connectionState)}),this._p2pChannel.on(rt.AudioMetadata,t=>{this.safeEmit(It.AUDIO_METADATA,t)}),this._p2pChannel.on(rt.AudioPts,t=>{this.safeEmit(It.AUDIO_PTS,Number(t))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{let n=(e={config:t},br("ContentInspect").create(e));this._inspect=n,this.handleVideoInspectEvents(n);let{appId:i,cname:r,sid:o,token:s,uid:a,cid:c,vid:d}=this._joinInfo;await n.init({appId:i,areaCode:"",cname:r,sid:o,token:s,uid:a,cid:c,vid:d?Number(d):0},Pe)}catch(n){throw Array.isArray(n)?n[0]:n}var e}handleVideoInspectEvents(t){t.on(nn.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(It.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===rr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(It.CONTENT_INSPECT_ERROR,new D(C.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(nn.INSPECT_RESULT,(e,n)=>{var i;if(n?.code===C.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(It.CONTENT_INSPECT_RESULT,e,n)}),t.on(nn.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if($i(t,"enabled"),t){if(!e)throw new D(C.INVALID_PARAMS,"config is required");if(ZN(e),!this._joinInfo)throw new D(C.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{let i=(n={config:e},br("ImageModeration").create(n));this._moderation=i,this.handleImageModerationEvents(i);let{appId:r,cname:o,sid:s,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:o,sid:s,token:a,uid:c,cid:d,vid:l?Number(l):0},Pe)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var n;if(!this._moderation)throw new D(C.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}handleImageModerationEvents(t){t.on(Ar.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(It.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===Fi.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new D(C.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(Ar.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}setP2PTransport(t){if(function(e){De(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new D(C.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){$i(t,"enabled"),$t("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_setRteInfo(t,e){this.store.rteUrl=t,this.store.rteSid=e}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},q(Q.prototype,"leave",[$N],Object.getOwnPropertyDescriptor(Q.prototype,"leave"),Q.prototype),q(Q.prototype,"publish",[tD],Object.getOwnPropertyDescriptor(Q.prototype,"publish"),Q.prototype),q(Q.prototype,"unpublish",[eD],Object.getOwnPropertyDescriptor(Q.prototype,"unpublish"),Q.prototype),q(Q.prototype,"subscribe",[nD],Object.getOwnPropertyDescriptor(Q.prototype,"subscribe"),Q.prototype),q(Q.prototype,"presubscribe",[iD],Object.getOwnPropertyDescriptor(Q.prototype,"presubscribe"),Q.prototype),q(Q.prototype,"massSubscribe",[rD],Object.getOwnPropertyDescriptor(Q.prototype,"massSubscribe"),Q.prototype),q(Q.prototype,"unsubscribe",[oD],Object.getOwnPropertyDescriptor(Q.prototype,"unsubscribe"),Q.prototype),q(Q.prototype,"massUnsubscribe",[sD],Object.getOwnPropertyDescriptor(Q.prototype,"massUnsubscribe"),Q.prototype),q(Q.prototype,"setLowStreamParameter",[aD],Object.getOwnPropertyDescriptor(Q.prototype,"setLowStreamParameter"),Q.prototype),q(Q.prototype,"setDualStreamMode",[cD],Object.getOwnPropertyDescriptor(Q.prototype,"setDualStreamMode"),Q.prototype),q(Q.prototype,"enableDualStream",[dD],Object.getOwnPropertyDescriptor(Q.prototype,"enableDualStream"),Q.prototype),q(Q.prototype,"disableDualStream",[lD],Object.getOwnPropertyDescriptor(Q.prototype,"disableDualStream"),Q.prototype),q(Q.prototype,"setClientRole",[uD],Object.getOwnPropertyDescriptor(Q.prototype,"setClientRole"),Q.prototype),q(Q.prototype,"_setClientRoleOptions",[hD],Object.getOwnPropertyDescriptor(Q.prototype,"_setClientRoleOptions"),Q.prototype),q(Q.prototype,"setProxyServer",[pD],Object.getOwnPropertyDescriptor(Q.prototype,"setProxyServer"),Q.prototype),q(Q.prototype,"setTurnServer",[_D],Object.getOwnPropertyDescriptor(Q.prototype,"setTurnServer"),Q.prototype),q(Q.prototype,"setLicense",[mD],Object.getOwnPropertyDescriptor(Q.prototype,"setLicense"),Q.prototype),q(Q.prototype,"startProxyServer",[ED],Object.getOwnPropertyDescriptor(Q.prototype,"startProxyServer"),Q.prototype),q(Q.prototype,"stopProxyServer",[fD],Object.getOwnPropertyDescriptor(Q.prototype,"stopProxyServer"),Q.prototype),q(Q.prototype,"setLocalAccessPointsV2",[gD],Object.getOwnPropertyDescriptor(Q.prototype,"setLocalAccessPointsV2"),Q.prototype),q(Q.prototype,"setLocalAccessPoints",[SD],Object.getOwnPropertyDescriptor(Q.prototype,"setLocalAccessPoints"),Q.prototype),q(Q.prototype,"setRemoteDefaultVideoStreamType",[TD],Object.getOwnPropertyDescriptor(Q.prototype,"setRemoteDefaultVideoStreamType"),Q.prototype),q(Q.prototype,"setRemoteVideoStreamType",[RD],Object.getOwnPropertyDescriptor(Q.prototype,"setRemoteVideoStreamType"),Q.prototype),q(Q.prototype,"setStreamFallbackOption",[CD],Object.getOwnPropertyDescriptor(Q.prototype,"setStreamFallbackOption"),Q.prototype),q(Q.prototype,"setEncryptionConfig",[vD],Object.getOwnPropertyDescriptor(Q.prototype,"setEncryptionConfig"),Q.prototype),q(Q.prototype,"renewToken",[yD],Object.getOwnPropertyDescriptor(Q.prototype,"renewToken"),Q.prototype),q(Q.prototype,"enableAudioVolumeIndicator",[ID],Object.getOwnPropertyDescriptor(Q.prototype,"enableAudioVolumeIndicator"),Q.prototype),q(Q.prototype,"startLiveStreaming",[AD],Object.getOwnPropertyDescriptor(Q.prototype,"startLiveStreaming"),Q.prototype),q(Q.prototype,"setLiveTranscoding",[bD],Object.getOwnPropertyDescriptor(Q.prototype,"setLiveTranscoding"),Q.prototype),q(Q.prototype,"stopLiveStreaming",[wD],Object.getOwnPropertyDescriptor(Q.prototype,"stopLiveStreaming"),Q.prototype),q(Q.prototype,"startChannelMediaRelay",[OD],Object.getOwnPropertyDescriptor(Q.prototype,"startChannelMediaRelay"),Q.prototype),q(Q.prototype,"updateChannelMediaRelay",[ND],Object.getOwnPropertyDescriptor(Q.prototype,"updateChannelMediaRelay"),Q.prototype),q(Q.prototype,"stopChannelMediaRelay",[DD],Object.getOwnPropertyDescriptor(Q.prototype,"stopChannelMediaRelay"),Q.prototype),q(Q.prototype,"sendCustomReportMessage",[PD],Object.getOwnPropertyDescriptor(Q.prototype,"sendCustomReportMessage"),Q.prototype),q(Q.prototype,"pickSVCLayer",[LD],Object.getOwnPropertyDescriptor(Q.prototype,"pickSVCLayer"),Q.prototype),q(Q.prototype,"setRTMConfig",[kD],Object.getOwnPropertyDescriptor(Q.prototype,"setRTMConfig"),Q.prototype),q(Q.prototype,"enableContentInspect",[MD],Object.getOwnPropertyDescriptor(Q.prototype,"enableContentInspect"),Q.prototype),q(Q.prototype,"disableContentInspect",[UD],Object.getOwnPropertyDescriptor(Q.prototype,"disableContentInspect"),Q.prototype),q(Q.prototype,"setImageModeration",[xD],Object.getOwnPropertyDescriptor(Q.prototype,"setImageModeration"),Q.prototype),q(Q.prototype,"setP2PTransport",[VD],Object.getOwnPropertyDescriptor(Q.prototype,"setP2PTransport"),Q.prototype),q(Q.prototype,"getJoinChannelServiceRecords",[FD],Object.getOwnPropertyDescriptor(Q.prototype,"getJoinChannelServiceRecords"),Q.prototype),q(Q.prototype,"setPublishAudioFilterEnabled",[BD],Object.getOwnPropertyDescriptor(Q.prototype,"setPublishAudioFilterEnabled"),Q.prototype),Q);function GD(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},n=qt(5,"client-"),i=tt.reportApiInvoke(null,{id:n,name:me.CREATE_CLIENT,options:[e],tag:re.TRACER});try{(function(r){De(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),De(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&De(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&dn(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&Sb(r.turnServer),r.httpRetryConfig!==void 0&&gb(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&gb(r.websocketRetryConfig)})(e)}catch(r){throw i.onError(r),r}return(ob(16,0,!0)||pf(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",_.debug("browser not support vp9, force use vp8")),$t("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),i.onSuccess(),new pK(dr(dr({forceWaitGatewayResponse:!0},e),{},{role:B(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),n)}function _K(){let t=!1,e=Vt();return(e.name===jt.CHROME&&Number(e.version)>=58&&(Tr.engine.name!=="WebKit"||function(){let n=Vt();if(sh()){if(n.os===Ke.MAC_OS)return!0;if(n.os===Ke.IOS){let i=Tr.os.version&&Tr.os.version.split(".");if(i&&Number(i[0])===14&&i[1]&&Number(i[1])>=3||i&&Number(i[0])>14)return!0}}return!1}())||e.name===jt.FIREFOX&&Number(e.version)>=56||e.name===jt.OPERA&&Number(e.version)>=45||e.name===jt.SAFARI&&Number(e.version)>=11||e.name==="WebKit"&&(An()||Zi())&&e.osVersion&&Number(e.osVersion.split(".")[0])>=11||cb()||Vt().name===jt.QQ)&&(t=!0),t}class nl{constructor(e,n){g(this,"id",0),g(this,"element",void 0),g(this,"peerPair",void 0),g(this,"context",void 0),g(this,"audioPlayerElement",void 0),g(this,"audioTrack",void 0),nl.count+=1,this.id=nl.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{let n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;let e=async(i,r)=>{let o=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(o),i.iceGatheringState==="complete"?i.localDescription:new Y(s=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&s(i.localDescription)}})},n=async(i,r)=>await i.setRemoteDescription(r);try{let i=await e(this.peerPair[0],"offer");await n(this.peerPair[1],i);let r=await e(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new D(C.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n)}catch(r){throw new D(C.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new D(C.LOCAL_AEC_ERROR,"no dest node when local aec").print();let i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var WD,lp;g(nl,"count",0);let mK=window.AudioContext||window.webkitAudioContext,EK=new(WD=at({report:tt}),q((lp=class{constructor(){g(this,"units",[]),g(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new mK);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new nl(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Vt().name!==jt.SAFARI}}).prototype,"processExternalMediaAEC",[WD],Object.getOwnPropertyDescriptor(lp.prototype,"processExternalMediaAEC"),lp.prototype),lp);function HD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function KD(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?HD(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):HD(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let aS=window||document;function YD(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!aS)return;let n=xe._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);let i=r=>{if(!(r&&r.blockedURI&&(xe.onSecurityPolicyViolation||xe.getListeners(Jr.SECURITY_POLICY_VIOLATION).length>0)))return;let o=r.blockedURI;T("CSP_DETECTED_HOSTNAME_LIST").some(s=>B(o).call(o,s))&&(xe.onSecurityPolicyViolation&&typeof xe.onSecurityPolicyViolation=="function"&&xe.onSecurityPolicyViolation(r),xe.getListeners(Jr.SECURITY_POLICY_VIOLATION).length>0&&xe.safeEmit(Jr.SECURITY_POLICY_VIOLATION,r))};n&&aS.removeEventListener("securitypolicyviolation",n),(e||t&&typeof t=="function"||xe.getListeners(Jr.SECURITY_POLICY_VIOLATION).length>0)&&aS.addEventListener("securitypolicyviolation",i),xe._cspEventHandlerPointer=i}var fK=At,gK=fE,qD=RegExp.prototype,SK=function(t){return t===qD||fK(qD,t)?gK(t):t.flags},Nn=H(SK);function Nc(t){let e=t.length;for(;--e>=0;)t[e]=0}let cS=256,zD=286,il=30,rl=15,dS=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),up=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),TK=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),XD=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),yo=new Array(576);Nc(yo);let ol=new Array(60);Nc(ol);let sl=new Array(512);Nc(sl);let al=new Array(256);Nc(al);let lS=new Array(29);Nc(lS);let hp=new Array(il);function uS(t,e,n,i,r){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=t&&t.length}let JD,QD,ZD;function hS(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Nc(hp);let $D=t=>t<256?sl[t]:sl[256+(t>>>7)],cl=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},Ai=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,cl(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},no=(t,e,n)=>{Ai(t,n[2*e],n[2*e+1])},tP=(t,e)=>{let n=0;do n|=1&t,t>>>=1,n<<=1;while(--e>0);return n>>>1},eP=(t,e,n)=>{let i=new Array(16),r,o,s=0;for(r=1;r<=rl;r++)s=s+n[r-1]<<1,i[r]=s;for(o=0;o<=e;o++){let a=t[2*o+1];a!==0&&(t[2*o]=tP(i[a]++,a))}},nP=t=>{let e;for(e=0;e<zD;e++)t.dyn_ltree[2*e]=0;for(e=0;e<il;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},iP=t=>{t.bi_valid>8?cl(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},rP=(t,e,n,i)=>{let r=2*e,o=2*n;return t[r]<t[o]||t[r]===t[o]&&i[e]<=i[n]},pS=(t,e,n)=>{let i=t.heap[n],r=n<<1;for(;r<=t.heap_len&&(r<t.heap_len&&rP(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!rP(e,i,t.heap[r],t.depth));)t.heap[n]=t.heap[r],n=r,r<<=1;t.heap[n]=i},oP=(t,e,n)=>{let i,r,o,s,a=0;if(t.sym_next!==0)do i=255&t.pending_buf[t.sym_buf+a++],i+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],i===0?no(t,r,e):(o=al[r],no(t,o+cS+1,e),s=dS[o],s!==0&&(r-=lS[o],Ai(t,r,s)),i--,o=$D(i),no(t,o,n),s=up[o],s!==0&&(i-=hp[o],Ai(t,i,s)));while(a<t.sym_next);no(t,256,e)},_S=(t,e)=>{let n=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,o=e.stat_desc.elems,s,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)n[2*s]!==0?(t.heap[++t.heap_len]=d=s,t.depth[s]=0):n[2*s+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=i[2*c+1]);for(e.max_code=d,s=t.heap_len>>1;s>=1;s--)pS(t,n,s);c=o;do s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],pS(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=a,n[2*c]=n[2*s]+n[2*a],t.depth[c]=(t.depth[s]>=t.depth[a]?t.depth[s]:t.depth[a])+1,n[2*s+1]=n[2*a+1]=c,t.heap[1]=c++,pS(t,n,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((l,u)=>{let h=u.dyn_tree,p=u.max_code,S=u.stat_desc.static_tree,E=u.stat_desc.has_stree,f=u.stat_desc.extra_bits,R=u.stat_desc.extra_base,v=u.stat_desc.max_length,I,w,O,A,N,k,V=0;for(A=0;A<=rl;A++)l.bl_count[A]=0;for(h[2*l.heap[l.heap_max]+1]=0,I=l.heap_max+1;I<573;I++)w=l.heap[I],A=h[2*h[2*w+1]+1]+1,A>v&&(A=v,V++),h[2*w+1]=A,w>p||(l.bl_count[A]++,N=0,w>=R&&(N=f[w-R]),k=h[2*w],l.opt_len+=k*(A+N),E&&(l.static_len+=k*(S[2*w+1]+N)));if(V!==0){do{for(A=v-1;l.bl_count[A]===0;)A--;l.bl_count[A]--,l.bl_count[A+1]+=2,l.bl_count[v]--,V-=2}while(V>0);for(A=v;A!==0;A--)for(w=l.bl_count[A];w!==0;)O=l.heap[--I],O>p||(h[2*O+1]!==A&&(l.opt_len+=(A-h[2*O+1])*h[2*O],h[2*O+1]=A),w--)}})(t,e),eP(n,d,t.bl_count)},sP=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),e[2*(n+1)+1]=65535,i=0;i<=n;i++)r=s,s=e[2*(i+1)+1],++a<c&&r===s||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4))},aP=(t,e,n)=>{let i,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),i=0;i<=n;i++)if(r=s,s=e[2*(i+1)+1],!(++a<c&&r===s)){if(a<d)do no(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==o&&(no(t,r,t.bl_tree),a--),no(t,16,t.bl_tree),Ai(t,a-3,2)):a<=10?(no(t,17,t.bl_tree),Ai(t,a-3,3)):(no(t,18,t.bl_tree),Ai(t,a-11,7));a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4)}},cP=!1,dP=(t,e,n,i)=>{Ai(t,0+(i?1:0),3),iP(t),cl(t,n),cl(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var RK=t=>{cP||((()=>{let e,n,i,r,o,s=new Array(16);for(i=0,r=0;r<28;r++)for(lS[r]=i,e=0;e<1<<dS[r];e++)al[i++]=r;for(al[i-1]=r,o=0,r=0;r<16;r++)for(hp[r]=o,e=0;e<1<<up[r];e++)sl[o++]=r;for(o>>=7;r<il;r++)for(hp[r]=o<<7,e=0;e<1<<up[r]-7;e++)sl[256+o++]=r;for(n=0;n<=rl;n++)s[n]=0;for(e=0;e<=143;)yo[2*e+1]=8,e++,s[8]++;for(;e<=255;)yo[2*e+1]=9,e++,s[9]++;for(;e<=279;)yo[2*e+1]=7,e++,s[7]++;for(;e<=287;)yo[2*e+1]=8,e++,s[8]++;for(eP(yo,287,s),e=0;e<il;e++)ol[2*e+1]=5,ol[2*e]=tP(e,5);JD=new uS(yo,dS,257,zD,rl),QD=new uS(ol,up,0,il,rl),ZD=new uS(new Array(0),TK,0,19,7)})(),cP=!0),t.l_desc=new hS(t.dyn_ltree,JD),t.d_desc=new hS(t.dyn_dtree,QD),t.bl_desc=new hS(t.bl_tree,ZD),t.bi_buf=0,t.bi_valid=0,nP(t)},CK=(t,e,n,i)=>{let r,o,s=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<cS;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),_S(t,t.l_desc),_S(t,t.d_desc),s=(a=>{let c;for(sP(a,a.dyn_ltree,a.l_desc.max_code),sP(a,a.dyn_dtree,a.d_desc.max_code),_S(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*XD[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&e!==-1?dP(t,e,n,i):t.strategy===4||o===r?(Ai(t,2+(i?1:0),3),oP(t,yo,ol)):(Ai(t,4+(i?1:0),3),((a,c,d,l)=>{let u;for(Ai(a,c-257,5),Ai(a,d-1,5),Ai(a,l-4,4),u=0;u<l;u++)Ai(a,a.bl_tree[2*XD[u]+1],3);aP(a,a.dyn_ltree,c-1),aP(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),oP(t,t.dyn_ltree,t.dyn_dtree)),nP(t),i&&iP(t)},vK=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,e===0?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(al[n]+cS+1)]++,t.dyn_dtree[2*$D(e)]++),t.sym_next===t.sym_end),yK=t=>{Ai(t,2,3),no(t,256,yo),(e=>{e.bi_valid===16?(cl(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},IK={_tr_init:RK,_tr_stored_block:dP,_tr_flush_block:CK,_tr_tally:vK,_tr_align:yK},dl=(t,e,n,i)=>{let r=65535&t|0,o=t>>>16&65535|0,s=0;for(;n!==0;){s=n>2e3?2e3:n,n-=s;do r=r+e[i++]|0,o=o+r|0;while(--s);r%=65521,o%=65521}return r|o<<16|0};let AK=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var Fn=(t,e,n,i)=>{let r=AK,o=i+n;t^=-1;for(let s=i;s<o;s++)t=t>>>8^r[255&(t^e[s])];return-1^t},na={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Dc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:bK,_tr_stored_block:mS,_tr_flush_block:wK,_tr_tally:is,_tr_align:OK}=IK,{Z_NO_FLUSH:rs,Z_PARTIAL_FLUSH:NK,Z_FULL_FLUSH:DK,Z_FINISH:lr,Z_BLOCK:lP,Z_OK:zn,Z_STREAM_END:uP,Z_STREAM_ERROR:io,Z_DATA_ERROR:PK,Z_BUF_ERROR:ES,Z_DEFAULT_COMPRESSION:LK,Z_FILTERED:kK,Z_HUFFMAN_ONLY:pp,Z_RLE:MK,Z_FIXED:UK,Z_DEFAULT_STRATEGY:xK,Z_UNKNOWN:VK,Z_DEFLATED:_p}=Dc,fS=286,FK=30,BK=19,jK=2*fS+1,GK=15,ia=258,ro=262,Pc=42,ra=113,ll=666,oa=(t,e)=>(t.msg=na[e],e),hP=t=>2*t-(t>4?9:0),os=t=>{let e=t.length;for(;--e>=0;)t[e]=0},WK=t=>{let e,n,i,r=t.w_size;e=t.hash_size,i=e;do n=t.head[--i],t.head[i]=n>=r?n-r:0;while(--e);e=r,i=e;do n=t.prev[--i],t.prev[i]=n>=r?n-r:0;while(--e)},ss=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask,Bi=t=>{let e=t.state,n=e.pending;n>t.avail_out&&(n=t.avail_out),n!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0))},ji=(t,e)=>{wK(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Bi(t.strm)},be=(t,e)=>{t.pending_buf[t.pending++]=e},ul=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},gS=(t,e,n,i)=>{let r=t.avail_in;return r>i&&(r=i),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),n),t.state.wrap===1?t.adler=dl(t.adler,e,r,n):t.state.wrap===2&&(t.adler=Fn(t.adler,e,r,n)),t.next_in+=r,t.total_in+=r,r)},pP=(t,e)=>{let n,i,r=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match,c=t.strstart>t.w_size-ro?t.strstart-(t.w_size-ro):0,d=t.window,l=t.w_mask,u=t.prev,h=t.strstart+ia,p=d[o+s-1],S=d[o+s];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(n=e,d[n+s]===S&&d[n+s-1]===p&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do;while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<h);if(i=ia-(h-o),o=h-ia,i>s){if(t.match_start=e,s=i,i>=a)break;p=d[o+s-1],S=d[o+s]}}while((e=u[e&l])>c&&--r!=0);return s<=t.lookahead?s:t.lookahead},Lc=t=>{let e=t.w_size,n,i,r;do{if(i=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-ro)&&(t.window.set(t.window.subarray(e,e+e-i),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),WK(t),i+=e),t.strm.avail_in===0)break;if(n=gS(t.strm,t.window,t.strstart+t.lookahead,i),t.lookahead+=n,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=ss(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=ss(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<ro&&t.strm.avail_in!==0)},_P=(t,e)=>{let n,i,r,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,a=t.strm.avail_in;do{if(n=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,i=t.strstart-t.block_start,n>i+t.strm.avail_in&&(n=i+t.strm.avail_in),n>r&&(n=r),n<o&&(n===0&&e!==lr||e===rs||n!==i+t.strm.avail_in)))break;s=e===lr&&n===i+t.strm.avail_in?1:0,mS(t,0,0,s),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Bi(t.strm),i&&(i>n&&(i=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+i),t.strm.next_out),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i,t.block_start+=i,n-=i),n&&(gS(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(s===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==rs&&e!==lr&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(gS(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,o=r>t.w_size?t.w_size:r,i=t.strstart-t.block_start,(i>=o||(i||e===lr)&&e!==rs&&t.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,s=e===lr&&t.strm.avail_in===0&&n===i?1:0,mS(t,t.block_start,n,s),t.block_start+=n,Bi(t.strm)),s?3:1)},SS=(t,e)=>{let n,i;for(;;){if(t.lookahead<ro){if(Lc(t),t.lookahead<ro&&e===rs)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=ss(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),n!==0&&t.strstart-n<=t.w_size-ro&&(t.match_length=pP(t,n)),t.match_length>=3)if(i=is(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=ss(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=ss(t,t.ins_h,t.window[t.strstart+1]);else i=is(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(ji(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===lr?(ji(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(ji(t,!1),t.strm.avail_out===0)?1:2},kc=(t,e)=>{let n,i,r;for(;;){if(t.lookahead<ro){if(Lc(t),t.lookahead<ro&&e===rs)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=ss(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,n!==0&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-ro&&(t.match_length=pP(t,n),t.match_length<=5&&(t.strategy===kK||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,i=is(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=ss(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(ji(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(i=is(t,0,t.window[t.strstart-1]),i&&ji(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=is(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===lr?(ji(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(ji(t,!1),t.strm.avail_out===0)?1:2};function oo(t,e,n,i,r){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=i,this.func=r}let hl=[new oo(0,0,0,0,_P),new oo(4,4,8,4,SS),new oo(4,5,16,8,SS),new oo(4,6,32,32,SS),new oo(4,4,16,16,kc),new oo(8,16,32,32,kc),new oo(8,16,128,128,kc),new oo(8,32,128,256,kc),new oo(32,128,258,1024,kc),new oo(32,258,258,4096,kc)];function HK(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=_p,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*jK),this.dyn_dtree=new Uint16Array(2*(2*FK+1)),this.bl_tree=new Uint16Array(2*(2*BK+1)),os(this.dyn_ltree),os(this.dyn_dtree),os(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(GK+1),this.heap=new Uint16Array(2*fS+1),os(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*fS+1),os(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let pl=t=>{if(!t)return 1;let e=t.state;return!e||e.strm!==t||e.status!==Pc&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==ra&&e.status!==ll?1:0},mP=t=>{if(pl(t))return oa(t,io);t.total_in=t.total_out=0,t.data_type=VK;let e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?Pc:ra,t.adler=e.wrap===2?0:1,e.last_flush=-2,bK(e),zn},EP=t=>{let e=mP(t);return e===zn&&(n=>{n.window_size=2*n.w_size,os(n.head),n.max_lazy_match=hl[n.level].max_lazy,n.good_match=hl[n.level].good_length,n.nice_match=hl[n.level].nice_length,n.max_chain_length=hl[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(t.state),e},fP=(t,e,n,i,r,o)=>{if(!t)return io;let s=1;if(e===LK&&(e=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||n!==_p||i<8||i>15||e<0||e>9||o<0||o>UK||i===8&&s!==1)return oa(t,io);i===8&&(i=9);let a=new HK;return t.state=a,a.strm=t,a.status=Pc,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=n,EP(t)};var KK=(t,e)=>{if(pl(t)||e>lP||e<0)return t?oa(t,io):io;let n=t.state;if(!t.output||t.avail_in!==0&&!t.input||n.status===ll&&e!==lr)return oa(t,t.avail_out===0?ES:io);let i=n.last_flush;if(n.last_flush=e,n.pending!==0){if(Bi(t),t.avail_out===0)return n.last_flush=-1,zn}else if(t.avail_in===0&&hP(e)<=hP(i)&&e!==lr)return oa(t,ES);if(n.status===ll&&t.avail_in!==0)return oa(t,ES);if(n.status===Pc&&n.wrap===0&&(n.status=ra),n.status===Pc){let r=_p+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=pp||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=o<<6,n.strstart!==0&&(r|=32),r+=31-r%31,ul(n,r),n.strstart!==0&&(ul(n,t.adler>>>16),ul(n,65535&t.adler)),t.adler=1,n.status=ra,Bi(t),n.pending!==0)return n.last_flush=-1,zn}if(n.status===57){if(t.adler=0,be(n,31),be(n,139),be(n,8),n.gzhead)be(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),be(n,255&n.gzhead.time),be(n,n.gzhead.time>>8&255),be(n,n.gzhead.time>>16&255),be(n,n.gzhead.time>>24&255),be(n,n.level===9?2:n.strategy>=pp||n.level<2?4:0),be(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(be(n,255&n.gzhead.extra.length),be(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Fn(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(be(n,0),be(n,0),be(n,0),be(n,0),be(n,0),be(n,n.level===9?2:n.strategy>=pp||n.level<2?4:0),be(n,3),n.status=ra,Bi(t),n.pending!==0)return n.last_flush=-1,zn}if(n.status===69){if(n.gzhead.extra){let r=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,Bi(t),n.pending!==0)return n.last_flush=-1,zn;r=0,o-=a}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>r&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-o,o)),Bi(t),n.pending!==0)return n.last_flush=-1,zn;o=0}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,be(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let r,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-o,o)),Bi(t),n.pending!==0)return n.last_flush=-1,zn;o=0}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,be(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>o&&(t.adler=Fn(t.adler,n.pending_buf,n.pending-o,o))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Bi(t),n.pending!==0))return n.last_flush=-1,zn;be(n,255&t.adler),be(n,t.adler>>8&255),t.adler=0}if(n.status=ra,Bi(t),n.pending!==0)return n.last_flush=-1,zn}if(t.avail_in!==0||n.lookahead!==0||e!==rs&&n.status!==ll){let r=n.level===0?_P(n,e):n.strategy===pp?((o,s)=>{let a;for(;;){if(o.lookahead===0&&(Lc(o),o.lookahead===0)){if(s===rs)return 1;break}if(o.match_length=0,a=is(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(ji(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===lr?(ji(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(ji(o,!1),o.strm.avail_out===0)?1:2})(n,e):n.strategy===MK?((o,s)=>{let a,c,d,l,u=o.window;for(;;){if(o.lookahead<=ia){if(Lc(o),o.lookahead<=ia&&s===rs)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=o.strstart+ia;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);o.match_length=ia-(l-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(a=is(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=is(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(ji(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===lr?(ji(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(ji(o,!1),o.strm.avail_out===0)?1:2})(n,e):hl[n.level].func(n,e);if(r!==3&&r!==4||(n.status=ll),r===1||r===3)return t.avail_out===0&&(n.last_flush=-1),zn;if(r===2&&(e===NK?OK(n):e!==lP&&(mS(n,0,0,!1),e===DK&&(os(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Bi(t),t.avail_out===0))return n.last_flush=-1,zn}return e!==lr?zn:n.wrap<=0?uP:(n.wrap===2?(be(n,255&t.adler),be(n,t.adler>>8&255),be(n,t.adler>>16&255),be(n,t.adler>>24&255),be(n,255&t.total_in),be(n,t.total_in>>8&255),be(n,t.total_in>>16&255),be(n,t.total_in>>24&255)):(ul(n,t.adler>>>16),ul(n,65535&t.adler)),Bi(t),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?zn:uP)},YK=(t,e)=>{let n=e.length;if(pl(t))return io;let i=t.state,r=i.wrap;if(r===2||r===1&&i.status!==Pc||i.lookahead)return io;if(r===1&&(t.adler=dl(t.adler,e,n,0)),i.wrap=0,n>=i.w_size){r===0&&(os(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(e.subarray(n-i.w_size,n),0),e=c,n=i.w_size}let o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Lc(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=ss(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,Lc(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,i.wrap=r,zn},_l={deflateInit:(t,e)=>fP(t,e,_p,15,8,xK),deflateInit2:fP,deflateReset:EP,deflateResetKeep:mP,deflateSetHeader:(t,e)=>pl(t)||t.state.wrap!==2?io:(t.state.gzhead=e,zn),deflate:KK,deflateEnd:t=>{if(pl(t))return io;let e=t.state.status;return t.state=null,e===ra?oa(t,PK):zn},deflateSetDictionary:YK,deflateInfo:"pako deflate (from Nodeca project)"};let qK=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var mp={assign:function(t){let e=Array.prototype.slice.call(arguments,1);for(;e.length;){let n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(let i in n)qK(n,i)&&(t[i]=n[i])}}return t},flattenChunks:t=>{let e=0;for(let i=0,r=t.length;i<r;i++)e+=t[i].length;let n=new Uint8Array(e);for(let i=0,r=0,o=t.length;i<o;i++){let s=t[i];n.set(s,r),r+=s.length}return n}};let gP=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{gP=!1}let ml=new Uint8Array(256);for(let t=0;t<256;t++)ml[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;ml[254]=ml[254]=1;var El={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,n,i,r,o,s=t.length,a=0;for(r=0;r<s;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),o=0,r=0;o<a;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<s&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?e[o++]=n:n<2048?(e[o++]=192|n>>>6,e[o++]=128|63&n):n<65536?(e[o++]=224|n>>>12,e[o++]=128|n>>>6&63,e[o++]=128|63&n):(e[o++]=240|n>>>18,e[o++]=128|n>>>12&63,e[o++]=128|n>>>6&63,e[o++]=128|63&n);return e},buf2string:(t,e)=>{let n=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let i,r,o=new Array(2*n);for(r=0,i=0;i<n;){let s=t[i++];if(s<128){o[r++]=s;continue}let a=ml[s];if(a>4)o[r++]=65533,i+=a-1;else{for(s&=a===2?31:a===3?15:7;a>1&&i<n;)s=s<<6|63&t[i++],a--;a>1?o[r++]=65533:s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|1023&s)}}return((s,a)=>{if(a<65534&&s.subarray&&gP)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,r)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+ml[t[n]]>e?n:e}},SP=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let TP=Object.prototype.toString,{Z_NO_FLUSH:zK,Z_SYNC_FLUSH:XK,Z_FULL_FLUSH:JK,Z_FINISH:QK,Z_OK:Ep,Z_STREAM_END:ZK,Z_DEFAULT_COMPRESSION:$K,Z_DEFAULT_STRATEGY:t6,Z_DEFLATED:e6}=Dc;function fl(t){this.options=mp.assign({level:$K,method:e6,chunkSize:16384,windowBits:15,memLevel:8,strategy:t6},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new SP,this.strm.avail_out=0;let n=_l.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==Ep)throw new Error(na[n]);if(e.header&&_l.deflateSetHeader(this.strm,e.header),e.dictionary){let i;if(i=typeof e.dictionary=="string"?El.string2buf(e.dictionary):TP.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=_l.deflateSetDictionary(this.strm,i),n!==Ep)throw new Error(na[n]);this._dict_set=!0}}function TS(t,e){let n=new fl(e);if(n.push(t,!0),n.err)throw n.msg||na[n.err];return n.result}fl.prototype.push=function(t,e){let n=this.strm,i=this.options.chunkSize,r,o;if(this.ended)return!1;for(o=e===~~e?e:e===!0?QK:zK,typeof t=="string"?n.input=El.string2buf(t):TP.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===XK||o===JK)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=_l.deflate(n,o),r===ZK)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=_l.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Ep;if(n.avail_out!==0){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},fl.prototype.onData=function(t){this.chunks.push(t)},fl.prototype.onEnd=function(t){t===Ep&&(this.result=mp.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var n6={Deflate:fl,deflate:TS,deflateRaw:function(t,e){return(e=e||{}).raw=!0,TS(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,TS(t,e)},constants:Dc};let fp=16209;var i6=function(t,e){let n,i,r,o,s,a,c,d,l,u,h,p,S,E,f,R,v,I,w,O,A,N,k,V,J=t.state;n=t.next_in,k=t.input,i=n+(t.avail_in-5),r=t.next_out,V=t.output,o=r-(e-t.avail_out),s=r+(t.avail_out-257),a=J.dmax,c=J.wsize,d=J.whave,l=J.wnext,u=J.window,h=J.hold,p=J.bits,S=J.lencode,E=J.distcode,f=(1<<J.lenbits)-1,R=(1<<J.distbits)-1;t:do{p<15&&(h+=k[n++]<<p,p+=8,h+=k[n++]<<p,p+=8),v=S[h&f];e:for(;;){if(I=v>>>24,h>>>=I,p-=I,I=v>>>16&255,I===0)V[r++]=65535&v;else{if(!(16&I)){if(!(64&I)){v=S[(65535&v)+(h&(1<<I)-1)];continue e}if(32&I){J.mode=16191;break t}t.msg="invalid literal/length code",J.mode=fp;break t}w=65535&v,I&=15,I&&(p<I&&(h+=k[n++]<<p,p+=8),w+=h&(1<<I)-1,h>>>=I,p-=I),p<15&&(h+=k[n++]<<p,p+=8,h+=k[n++]<<p,p+=8),v=E[h&R];n:for(;;){if(I=v>>>24,h>>>=I,p-=I,I=v>>>16&255,!(16&I)){if(!(64&I)){v=E[(65535&v)+(h&(1<<I)-1)];continue n}t.msg="invalid distance code",J.mode=fp;break t}if(O=65535&v,I&=15,p<I&&(h+=k[n++]<<p,p+=8,p<I&&(h+=k[n++]<<p,p+=8)),O+=h&(1<<I)-1,O>a){t.msg="invalid distance too far back",J.mode=fp;break t}if(h>>>=I,p-=I,I=r-o,O>I){if(I=O-I,I>d&&J.sane){t.msg="invalid distance too far back",J.mode=fp;break t}if(A=0,N=u,l===0){if(A+=c-I,I<w){w-=I;do V[r++]=u[A++];while(--I);A=r-O,N=V}}else if(l<I){if(A+=c+l-I,I-=l,I<w){w-=I;do V[r++]=u[A++];while(--I);if(A=0,l<w){I=l,w-=I;do V[r++]=u[A++];while(--I);A=r-O,N=V}}}else if(A+=l-I,I<w){w-=I;do V[r++]=u[A++];while(--I);A=r-O,N=V}for(;w>2;)V[r++]=N[A++],V[r++]=N[A++],V[r++]=N[A++],w-=3;w&&(V[r++]=N[A++],w>1&&(V[r++]=N[A++]))}else{A=r-O;do V[r++]=V[A++],V[r++]=V[A++],V[r++]=V[A++],w-=3;while(w>2);w&&(V[r++]=V[A++],w>1&&(V[r++]=V[A++]))}break}}break}}while(n<i&&r<s);w=p>>3,n-=w,p-=w<<3,h&=(1<<p)-1,t.next_in=n,t.next_out=r,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=r<s?s-r+257:257-(r-s),J.hold=h,J.bits=p};let gp=15,r6=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),o6=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),s6=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),a6=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var gl=(t,e,n,i,r,o,s,a)=>{let c=a.bits,d,l,u,h,p,S,E=0,f=0,R=0,v=0,I=0,w=0,O=0,A=0,N=0,k=0,V=null,J=new Uint16Array(16),ut=new Uint16Array(16),dt,Ct,St,Gt=null;for(E=0;E<=gp;E++)J[E]=0;for(f=0;f<i;f++)J[e[n+f]]++;for(I=c,v=gp;v>=1&&J[v]===0;v--);if(I>v&&(I=v),v===0)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(R=1;R<v&&J[R]===0;R++);for(I<R&&(I=R),A=1,E=1;E<=gp;E++)if(A<<=1,A-=J[E],A<0)return-1;if(A>0&&(t===0||v!==1))return-1;for(ut[1]=0,E=1;E<gp;E++)ut[E+1]=ut[E]+J[E];for(f=0;f<i;f++)e[n+f]!==0&&(s[ut[e[n+f]]++]=f);if(t===0?(V=Gt=s,S=20):t===1?(V=r6,Gt=o6,S=257):(V=s6,Gt=a6,S=0),k=0,f=0,E=R,p=o,w=I,O=0,u=-1,N=1<<I,h=N-1,t===1&&N>852||t===2&&N>592)return 1;for(;;){dt=E-O,s[f]+1<S?(Ct=0,St=s[f]):s[f]>=S?(Ct=Gt[s[f]-S],St=V[s[f]-S]):(Ct=96,St=0),d=1<<E-O,l=1<<w,R=l;do l-=d,r[p+(k>>O)+l]=dt<<24|Ct<<16|St|0;while(l!==0);for(d=1<<E-1;k&d;)d>>=1;if(d!==0?(k&=d-1,k+=d):k=0,f++,--J[E]==0){if(E===v)break;E=e[n+s[f]]}if(E>I&&(k&h)!==u){for(O===0&&(O=I),p+=R,w=E-O,A=1<<w;w+O<v&&(A-=J[w+O],!(A<=0));)w++,A<<=1;if(N+=1<<w,t===1&&N>852||t===2&&N>592)return 1;u=k&h,r[u]=I<<24|w<<16|p-o|0}}return k!==0&&(r[p+k]=E-O<<24|64<<16|0),a.bits=I,0};let{Z_FINISH:RP,Z_BLOCK:c6,Z_TREES:Sp,Z_OK:sa,Z_STREAM_END:d6,Z_NEED_DICT:l6,Z_STREAM_ERROR:ur,Z_DATA_ERROR:CP,Z_MEM_ERROR:vP,Z_BUF_ERROR:u6,Z_DEFLATED:yP}=Dc,Tp=16180,Rp=16190,Io=16191,RS=16192,CS=16194,Cp=16199,vp=16200,vS=16206,on=16209,IP=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function h6(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let aa=t=>{if(!t)return 1;let e=t.state;return!e||e.strm!==t||e.mode<Tp||e.mode>16211?1:0},AP=t=>{if(aa(t))return ur;let e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=Tp,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,sa},bP=t=>{if(aa(t))return ur;let e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,AP(t)},wP=(t,e)=>{let n;if(aa(t))return ur;let i=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?ur:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=n,i.wbits=e,bP(t))},OP=(t,e)=>{if(!t)return ur;let n=new h6;t.state=n,n.strm=t,n.window=null,n.mode=Tp;let i=wP(t,e);return i!==sa&&(t.state=null),i},yS,IS,NP=!0,p6=t=>{if(NP){yS=new Int32Array(512),IS=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(gl(1,t.lens,0,288,yS,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;gl(2,t.lens,0,32,IS,0,t.work,{bits:5}),NP=!1}t.lencode=yS,t.lenbits=9,t.distcode=IS,t.distbits=5},DP=(t,e,n,i)=>{let r,o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(e.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(e.subarray(n-i,n-i+r),o.wnext),(i-=r)?(o.window.set(e.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var _6=(t,e)=>{let n,i,r,o,s,a,c,d,l,u,h,p,S,E,f,R,v,I,w,O,A,N,k=0,V=new Uint8Array(4),J,ut,dt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(aa(t)||!t.output||!t.input&&t.avail_in!==0)return ur;n=t.state,n.mode===Io&&(n.mode=RS),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,u=a,h=c,N=sa;t:for(;;)switch(n.mode){case Tp:if(n.wrap===0){n.mode=RS;break}for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(2&n.wrap&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,V[0]=255&d,V[1]=d>>>8&255,n.check=Fn(n.check,V,2,0),d=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",n.mode=on;break}if((15&d)!==yP){t.msg="unknown compression method",n.mode=on;break}if(d>>>=4,l-=4,A=8+(15&d),n.wbits===0&&(n.wbits=A),A>15||A>n.wbits){t.msg="invalid window size",n.mode=on;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&d?16189:Io,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(n.flags=d,(255&Nn(n))!==yP){t.msg="unknown compression method",n.mode=on;break}if(57344&Nn(n)){t.msg="unknown header flags set",n.mode=on;break}n.head&&(n.head.text=d>>8&1),512&Nn(n)&&4&n.wrap&&(V[0]=255&d,V[1]=d>>>8&255,n.check=Fn(n.check,V,2,0)),d=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.time=d),512&Nn(n)&&4&n.wrap&&(V[0]=255&d,V[1]=d>>>8&255,V[2]=d>>>16&255,V[3]=d>>>24&255,n.check=Fn(n.check,V,4,0)),d=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&Nn(n)&&4&n.wrap&&(V[0]=255&d,V[1]=d>>>8&255,n.check=Fn(n.check,V,2,0)),d=0,l=0,n.mode=16184;case 16184:if(1024&Nn(n)){for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.length=d,n.head&&(n.head.extra_len=d),512&Nn(n)&&4&n.wrap&&(V[0]=255&d,V[1]=d>>>8&255,n.check=Fn(n.check,V,2,0)),d=0,l=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&Nn(n)&&(p=n.length,p>a&&(p=a),p&&(n.head&&(A=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+p),A)),512&Nn(n)&&4&n.wrap&&(n.check=Fn(n.check,i,p,o)),a-=p,o+=p,n.length-=p),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&Nn(n)){if(a===0)break t;p=0;do A=i[o+p++],n.head&&A&&n.length<65536&&(n.head.name+=String.fromCharCode(A));while(A&&p<a);if(512&Nn(n)&&4&n.wrap&&(n.check=Fn(n.check,i,p,o)),a-=p,o+=p,A)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&Nn(n)){if(a===0)break t;p=0;do A=i[o+p++],n.head&&A&&n.length<65536&&(n.head.comment+=String.fromCharCode(A));while(A&&p<a);if(512&Nn(n)&&4&n.wrap&&(n.check=Fn(n.check,i,p,o)),a-=p,o+=p,A)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&Nn(n)){for(;l<16;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(4&n.wrap&&d!==(65535&n.check)){t.msg="header crc mismatch",n.mode=on;break}d=0,l=0}n.head&&(n.head.hcrc=Nn(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=Io;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}t.adler=n.check=IP(d),d=0,l=0,n.mode=Rp;case Rp:if(n.havedict===0)return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,l6;t.adler=n.check=1,n.mode=Io;case Io:if(e===c6||e===Sp)break t;case RS:if(n.last){d>>>=7&l,l-=7&l,n.mode=vS;break}for(;l<3;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}switch(n.last=1&d,d>>>=1,l-=1,3&d){case 0:n.mode=16193;break;case 1:if(p6(n),n.mode=Cp,e===Sp){d>>>=2,l-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=on}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",n.mode=on;break}if(n.length=65535&d,d=0,l=0,n.mode=CS,e===Sp)break t;case CS:n.mode=16195;case 16195:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break t;r.set(i.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,n.length-=p;break}n.mode=Io;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(n.nlen=257+(31&d),d>>>=5,l-=5,n.ndist=1+(31&d),d>>>=5,l-=5,n.ncode=4+(15&d),d>>>=4,l-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=on;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.lens[dt[n.have++]]=7&d,d>>>=3,l-=3}for(;n.have<19;)n.lens[dt[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,J={bits:n.lenbits},N=gl(0,n.lens,0,19,n.lencode,0,n.work,J),n.lenbits=J.bits,N){t.msg="invalid code lengths set",n.mode=on;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;k=n.lencode[d&(1<<n.lenbits)-1],f=k>>>24,R=k>>>16&255,v=65535&k,!(f<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(v<16)d>>>=f,l-=f,n.lens[n.have++]=v;else{if(v===16){for(ut=f+2;l<ut;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(d>>>=f,l-=f,n.have===0){t.msg="invalid bit length repeat",n.mode=on;break}A=n.lens[n.have-1],p=3+(3&d),d>>>=2,l-=2}else if(v===17){for(ut=f+3;l<ut;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}d>>>=f,l-=f,A=0,p=3+(7&d),d>>>=3,l-=3}else{for(ut=f+7;l<ut;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}d>>>=f,l-=f,A=0,p=11+(127&d),d>>>=7,l-=7}if(n.have+p>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=on;break}for(;p--;)n.lens[n.have++]=A}}if(n.mode===on)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=on;break}if(n.lenbits=9,J={bits:n.lenbits},N=gl(1,n.lens,0,n.nlen,n.lencode,0,n.work,J),n.lenbits=J.bits,N){t.msg="invalid literal/lengths set",n.mode=on;break}if(n.distbits=6,n.distcode=n.distdyn,J={bits:n.distbits},N=gl(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,J),n.distbits=J.bits,N){t.msg="invalid distances set",n.mode=on;break}if(n.mode=Cp,e===Sp)break t;case Cp:n.mode=vp;case vp:if(a>=6&&c>=258){t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,i6(t,h),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,n.mode===Io&&(n.back=-1);break}for(n.back=0;k=n.lencode[d&(1<<n.lenbits)-1],f=k>>>24,R=k>>>16&255,v=65535&k,!(f<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(R&&!(240&R)){for(I=f,w=R,O=v;k=n.lencode[O+((d&(1<<I+w)-1)>>I)],f=k>>>24,R=k>>>16&255,v=65535&k,!(I+f<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}d>>>=I,l-=I,n.back+=I}if(d>>>=f,l-=f,n.back+=f,n.length=v,R===0){n.mode=16205;break}if(32&R){n.back=-1,n.mode=Io;break}if(64&R){t.msg="invalid literal/length code",n.mode=on;break}n.extra=15&R,n.mode=16201;case 16201:if(n.extra){for(ut=n.extra;l<ut;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;k=n.distcode[d&(1<<n.distbits)-1],f=k>>>24,R=k>>>16&255,v=65535&k,!(f<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(!(240&R)){for(I=f,w=R,O=v;k=n.distcode[O+((d&(1<<I+w)-1)>>I)],f=k>>>24,R=k>>>16&255,v=65535&k,!(I+f<=l);){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}d>>>=I,l-=I,n.back+=I}if(d>>>=f,l-=f,n.back+=f,64&R){t.msg="invalid distance code",n.mode=on;break}n.offset=v,n.extra=15&R,n.mode=16203;case 16203:if(n.extra){for(ut=n.extra;l<ut;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=on;break}n.mode=16204;case 16204:if(c===0)break t;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=on;break}p>n.wnext?(p-=n.wnext,S=n.wsize-p):S=n.wnext-p,p>n.length&&(p=n.length),E=n.window}else E=r,S=s-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do r[s++]=E[S++];while(--p);n.length===0&&(n.mode=vp);break;case 16205:if(c===0)break t;r[s++]=n.length,c--,n.mode=vp;break;case vS:if(n.wrap){for(;l<32;){if(a===0)break t;a--,d|=i[o++]<<l,l+=8}if(h-=c,t.total_out+=h,n.total+=h,4&n.wrap&&h&&(t.adler=n.check=Nn(n)?Fn(n.check,r,h,s-h):dl(n.check,r,h,s-h)),h=c,4&n.wrap&&(Nn(n)?d:IP(d))!==n.check){t.msg="incorrect data check",n.mode=on;break}d=0,l=0}n.mode=16207;case 16207:if(n.wrap&&Nn(n)){for(;l<32;){if(a===0)break t;a--,d+=i[o++]<<l,l+=8}if(4&n.wrap&&d!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=on;break}d=0,l=0}n.mode=16208;case 16208:N=d6;break t;case on:N=CP;break t;case 16210:return vP;default:return ur}return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=l,(n.wsize||h!==t.avail_out&&n.mode<on&&(n.mode<vS||e!==RP))&&DP(t,t.output,t.next_out,h-t.avail_out),u-=t.avail_in,h-=t.avail_out,t.total_in+=u,t.total_out+=h,n.total+=h,4&n.wrap&&h&&(t.adler=n.check=Nn(n)?Fn(n.check,r,h,t.next_out-h):dl(n.check,r,h,t.next_out-h)),t.data_type=n.bits+(n.last?64:0)+(n.mode===Io?128:0)+(n.mode===Cp||n.mode===CS?256:0),(u===0&&h===0||e===RP)&&N===sa&&(N=u6),N},Ao={inflateReset:bP,inflateReset2:wP,inflateResetKeep:AP,inflateInit:t=>OP(t,15),inflateInit2:OP,inflate:_6,inflateEnd:t=>{if(aa(t))return ur;let e=t.state;return e.window&&(e.window=null),t.state=null,sa},inflateGetHeader:(t,e)=>{if(aa(t))return ur;let n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,sa):ur},inflateSetDictionary:(t,e)=>{let n=e.length,i,r,o;return aa(t)?ur:(i=t.state,i.wrap!==0&&i.mode!==Rp?ur:i.mode===Rp&&(r=1,r=dl(r,e,n,0),r!==i.check)?CP:(o=DP(t,e,n,n),o?(i.mode=16210,vP):(i.havedict=1,sa)))},inflateInfo:"pako inflate (from Nodeca project)"},m6=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let PP=Object.prototype.toString,{Z_NO_FLUSH:E6,Z_FINISH:f6,Z_OK:Sl,Z_STREAM_END:AS,Z_NEED_DICT:bS,Z_STREAM_ERROR:g6,Z_DATA_ERROR:LP,Z_MEM_ERROR:S6}=Dc;function Tl(t){this.options=mp.assign({chunkSize:65536,windowBits:15,to:""},t||{});let e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new SP,this.strm.avail_out=0;let n=Ao.inflateInit2(this.strm,e.windowBits);if(n!==Sl)throw new Error(na[n]);if(this.header=new m6,Ao.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=El.string2buf(e.dictionary):PP.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Ao.inflateSetDictionary(this.strm,e.dictionary),n!==Sl)))throw new Error(na[n])}function wS(t,e){let n=new Tl(e);if(n.push(t),n.err)throw n.msg||na[n.err];return n.result}Tl.prototype.push=function(t,e){let n=this.strm,i=this.options.chunkSize,r=this.options.dictionary,o,s,a;if(this.ended)return!1;for(s=e===~~e?e:e===!0?f6:E6,PP.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=Ao.inflate(n,s),o===bS&&r&&(o=Ao.inflateSetDictionary(n,r),o===Sl?o=Ao.inflate(n,s):o===LP&&(o=bS));n.avail_in>0&&o===AS&&n.state.wrap>0&&t[n.next_in]!==0;)Ao.inflateReset(n),o=Ao.inflate(n,s);switch(o){case g6:case LP:case bS:case S6:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||o===AS))if(this.options.to==="string"){let c=El.utf8border(n.output,n.next_out),d=n.next_out-c,l=El.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(l)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==Sl||a!==0){if(o===AS)return o=Ao.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},Tl.prototype.onData=function(t){this.chunks.push(t)},Tl.prototype.onEnd=function(t){t===Sl&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=mp.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var T6={Inflate:Tl,inflate:wS,inflateRaw:function(t,e){return(e=e||{}).raw=!0,wS(t,e)},ungzip:wS,constants:Dc};let{Deflate:sY,deflate:R6,deflateRaw:C6,gzip:aY}=n6,{Inflate:cY,inflate:v6,inflateRaw:y6,ungzip:dY}=T6;var I6=R6,A6=C6,b6=v6,w6=y6,kP=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(kP||{});class O6{constructor(){g(this,"_sequence",0),g(this,"_startTime",Date.now()),g(this,"isUseOneByte",!0)}get startTime(){let e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){let n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){let a=new Uint8Array(4);a.set([1,0,0,0]);let c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;T("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));let i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),o=new DataView(i),s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){let a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),s),s+=a.byteLength}if(r.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);let n=new DataView(e),i=0,r=n.getUint16(i,!0);i+=2;let o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)},s,a;if(i+=4,T("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(i,!0),i+=2,o.extension){a=this.deserializeExtension(e.slice(i)),i+=2+a.length,s=e.slice(i);let c=!1;if(a.datas.length>0){let d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}s=c?this.decompress(s):s}else s=e.slice(8);return s}serializeExtension(e){let{profile:n,length:i,datas:r}=e,o=new ArrayBuffer(i+2),s=new Uint8Array(o),a=new DataView(o),c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach(d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return o}deserializeExtension(e){let n=new DataView(e),i=0,r=n.getUint8(i);i++;let o=n.getUint8(i);i++;let s=r===kP.TWO_BYTE,a=[],c=new DataView(e,2),d=0;for(;d<o;){let l=0,u=0,h=new ArrayBuffer(0);s?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h})}if(d!==o)throw Error("parse error");return{profile:r,length:o,datas:a}}decompress(e){return b6(new Uint8Array(e))}compress(e){return I6(new Uint8Array(e))}}let N6={name:"DataStream",create:(t,e)=>{let n=e?new k4(t):new M4(t);return n.useDataStream(new O6),n}};class D6 extends ge{constructor(e,n,i){super(),g(this,"ws",void 0),g(this,"requestId",1),g(this,"heartBeatTimer",void 0),g(this,"joinInfo",void 0),g(this,"clientId",void 0),g(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),g(this,"onClose",r=>{this.emit("close"),this.dispose()}),g(this,"onMessage",r=>{let o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=n,this.ws=new Wd("cross-channel-".concat(this.clientId),i),this.ws.on(Tt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Tt.CONNECTED,this.onOpen),this.ws.on(Tt.ON_MESSAGE,this.onMessage),this.ws.on(Tt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){let n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new Y((n,i)=>{let r=window.setTimeout(()=>{i(new D(C.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?i(new D(C.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),i(new D(C.WS_ABORT))})})}async request(e){if(this.ws.state==="closed")throw new D(C.WS_DISCONNECT);let n=()=>new Y((s,a)=>{this.ws.once(Tt.CLOSED,()=>a(new D(C.WS_ABORT))),this.ws.once(Tt.CONNECTED,s)});this.ws.state!=="connected"&&await n();let i=this.sendMessage(e),r=new Y((s,a)=>{let c=()=>{a(new D(C.WS_ABORT))};this.ws.once(Tt.RECONNECTING,c),this.ws.once(Tt.CLOSED,c),this.once("req_".concat(i),s),Ye(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Tt.RECONNECTING,c),this.ws.off(Tt.CLOSED,c),a(new D(C.TIMEOUT,"cross channel ws request timeout"))})}),o=await r;if(!o||o.code!==200)throw new D(C.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(e){this.ws.removeAllListeners(Tt.REQUEST_NEW_URLS),this.ws.on(Tt.REQUEST_NEW_URLS,n=>{n(e)}),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){let n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class P6 extends ge{set state(e){e!==this._state&&(e!==$n.RELAY_STATE_FAILURE&&(this.errorCode=mc.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,i,r,o){super(),g(this,"joinInfo",void 0),g(this,"sid",void 0),g(this,"clientId",void 0),g(this,"cancelToken",Gn.CancelToken.source()),g(this,"workerToken",void 0),g(this,"requestId",0),g(this,"signal",void 0),g(this,"prevChannelMediaConfig",void 0),g(this,"httpRetryConfig",void 0),g(this,"_resolution",void 0),g(this,"_state",$n.RELAY_STATE_IDLE),g(this,"errorCode",mc.RELAY_OK),g(this,"onStatus",s=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",Ro.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",Ro.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=mc.SRC_TOKEN_EXPIRED,this.state=$n.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=mc.DEST_TOKEN_EXPIRED,this.state=$n.RELAY_STATE_FAILURE))}),g(this,"onReconnect",async()=>{_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Ro.NETWORK_DISCONNECTED),this.state=$n.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==$n.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",s.toString()),this.errorCode=mc.SERVER_CONNECTION_LOST,this.state=$n.RELAY_STATE_FAILURE)})}),this.joinInfo=e,this.clientId=n,this.sid=xs(),this.signal=new D6(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==$n.RELAY_STATE_IDLE)throw new D(C.INVALID_OPERATION);this.state=$n.RELAY_STATE_CONNECTING,await this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new D(C.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new D(C.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new D(C.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==$n.RELAY_STATE_RUNNING)throw new D(C.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==$n.RELAY_STATE_RUNNING)throw new D(C.INVALID_OPERATION);let n=this.genMessage(Kn.SetVideoProfile);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=$n.RELAY_STATE_IDLE,this.dispose()}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Gn.CancelToken.source(),this.state=$n.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let e=await FH(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Ro.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){let n=this.genMessage(Kn.SetSdkProfile,e);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let i=this.genMessage(Kn.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Ro.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let r=this.genMessage(Kn.SetSourceUserId,e);await this.signal.request(r),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let o=this.genMessage(Kn.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Ro.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let s=this.genMessage(Kn.StartPacketTransfer,e);await this.signal.request(s),this.emit("event",Ro.PACKET_SENT_TO_DEST_CHANNEL),this.state=$n.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){let n=this.genMessage(Kn.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",Ro.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let e=this.genMessage(Kn.StopPacketTransfer);await this.signal.request(e),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,n){let i=[],r=[],o=[];this.requestId+=1;let s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:ki,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.24.2"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case Kn.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case Kn.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new D(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case Kn.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new D(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case Kn.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new D(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:o},s;case Kn.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case Kn.Reconnect:return s.clientRequest={command:"Reconnect"},s;case Kn.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case Kn.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new D(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:o},s;case Kn.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}let L6={name:"ChannelMediaRelay",create:function(t){return new P6(t.joinInfo,t.clientId,t.websocketRetryConfig||Pe,t.httpRetryConfig||Pe,t.resolution)}};function MP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Rl(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?MP(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MP(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class k6 extends ge{constructor(e,n,i,r){super(),g(this,"spec",void 0),g(this,"token",void 0),g(this,"websocket",void 0),g(this,"pingpongTimer",void 0),g(this,"reconnectMode","retry"),g(this,"serviceMode",void 0),g(this,"reqId",0),g(this,"commandReqId",0),g(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),g(this,"handleWebSocketMessage",o=>{if(!o.data)return;let s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):(tt.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Xr.TRANSCODE?1:2}),this.emit(zo.PUBLISH_STREAM_STATUS,s))}),this.spec=n,this.token=e,this.serviceMode=r,this.websocket=new Wd("live-streaming",i),this.websocket.on(Tt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Tt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Tt.REQUEST_NEW_URLS,(o,s)=>{Ue(this,zo.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(Tt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}async request(e,n,i,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);let o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new D(C.UNEXPECTED_ERROR);let a=Rl({command:e,sdkVersion:ki==="4.24.2"?"0.0.1":ki,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new D(C.WS_DISCONNECT);let c=()=>new Y((h,p)=>{this.websocket.once(Tt.CLOSED,()=>p(new D(C.WS_ABORT))),this.websocket.once(Tt.CONNECTED,h)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);let d=new Y((h,p)=>{let S=()=>{p(new D(C.WS_ABORT))};this.websocket.once(Tt.RECONNECTING,S),this.websocket.once(Tt.CLOSED,S),this.once("@".concat(s,"-").concat(this.spec.sid),E=>{h(E)})});r&&tt.workerEvent(this.spec.sid,Rl(Rl({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));let l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(h){if(this.websocket.state==="closed")throw h;return await c(),await this.request(e,n,i)}return r&&tt.workerEvent(this.spec.sid,Rl(Rl({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let e=ki==="4.24.2"?"0.0.1":ki;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case je.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case je.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case je.LIVE_STREAM_RESPONSE_BAD_STREAM:case je.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new D(C.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case je.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case je.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new D(C.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case je.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let n=new D(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(zo.WARNING,n,e.serverResponse.url)}case je.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let n=new D(C.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(zo.WARNING,n,e.serverResponse.url)}case je.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case je.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new D(C.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case je.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let n=new D(C.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(zo.WARNING,n,e.serverResponse.url)}case je.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case je.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case je.LIVE_STREAM_RESPONSE_WORKER_LOST:case je.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case je.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case je.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new D(C.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Md)},6e3)}}function UP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function ei(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?UP(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):UP(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class M6 extends ge{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Pe,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Pe;super(),g(this,"onLiveStreamWarning",void 0),g(this,"onLiveStreamError",void 0),g(this,"spec",void 0),g(this,"retryTimeout",1e4),g(this,"connection",void 0),g(this,"httpRetryConfig",void 0),g(this,"wsRetryConfig",void 0),g(this,"streamingTasks",new Map),g(this,"isStartingStreamingTask",!1),g(this,"taskMutex",new tn("live-streaming")),g(this,"cancelToken",Gn.CancelToken.source()),g(this,"transcodingConfig",void 0),g(this,"uapResponse",void 0),g(this,"lastTaskId",1),g(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(e){let n=ei(ei({},gH),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(s=>ei(ei(ei({},fH),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){Ce(s.width)||ie(s.width,"config.width",0,1e4),Ce(s.height)||ie(s.height,"config.height",0,1e4),Ce(s.videoBitrate)||ie(s.videoBitrate,"config.videoBitrate",1,1e6),Ce(s.videoFrameRate)||ie(s.videoFrameRate,"config.videoFrameRate"),Ce(s.lowLatency)||$i(s.lowLatency,"config.lowLatency"),Ce(s.audioSampleRate)||De(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Ce(s.audioBitrate)||ie(s.audioBitrate,"config.audioBitrate",1,128),Ce(s.audioChannels)||De(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),Ce(s.videoGop)||ie(s.videoGop,"config.videoGop"),Ce(s.videoCodecProfile)||De(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Ce(s.userCount)||ie(s.userCount,"config.userCount",0,17),Ce(s.backgroundColor)||ie(s.backgroundColor,"config.backgroundColor",0,16777215),Ce(s.userConfigExtraInfo)||dn(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!Ce(s.transcodingUsers)&&(So(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{Uh(a.uid),Ce(a.x)||ie(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Ce(a.y)||ie(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Ce(a.width)||ie(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Ce(a.height)||ie(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Ce(a.zOrder)||ie(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Ce(a.alpha)||ie(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),Ce(s.watermark)||mg(s.watermark,"watermark"),Ce(s.backgroundImage)||mg(s.backgroundImage,"backgroundImage"),s.images&&!Ce(s.images)&&(So(s.images,"config.images"),s.images.forEach((a,c)=>{mg(a,"images[".concat(c,"]"))}))}(n);let i=[];n.images&&i.push(...n.images.map(s=>ei(ei(ei({},_g),s),{},{zOrder:255}))),n.backgroundImage&&(i.push(ei(ei(ei({},_g),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(ei(ei(ei({},_g),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(s=>ei({},s)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);let r=(n.userConfigs||[]).map(s=>typeof s.uid=="number"?Y.resolve(s.uid):iN(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Y.all(r)).forEach((s,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=s)}),this.transcodingConfig=n,this.connection)try{var o;let s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(si(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}async startLiveStreamingTask(e,n,i){if(!this.transcodingConfig&&n===Xr.TRANSCODE)throw new D(C.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));let o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(e)&&!i)return o(),new D(C.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(a){throw o(),a}switch(n){case Xr.TRANSCODE:r.transcodingConfig=ei({},this.transcodingConfig);case Xr.RAW:}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let s=this.lastTaskId++;try{let a=new Y((d,l)=>{Ye(this.retryTimeout).then(()=>{if(i)return l(i);let u=this.statusError.get(e);return u?(this.statusError.delete(e),l(u)):void 0})}),c=await Y.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:n===Xr.TRANSCODE?1:2,requestByUser:!i,tid:s.toString()}),a]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:r,mode:n,url:e,taskId:s}),o()}catch(a){if(o(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,a)):await this.startLiveStreamingTask(e,n,a)}}stopLiveStreamingTask(e){return new Y((n,i)=>{let r=this.streamingTasks.get(e);if(!r||!this.connection)return new D(C.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let o=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===Xr.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()}).catch(i)})}resetAllTask(){var e;let n=Array.from(si(e=this.streamingTasks).call(e));this.terminate();for(let i of n)this.startLiveStreamingTask(i.url,i.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Gn.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new D(C.UNEXPECTED_ERROR,"live streaming connection has already connected");let n=await Ue(this,Eg.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new k6(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(zo.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(zo.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(zo.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new D(C.UNEXPECTED_ERROR,"can not get new live streaming address list"));Ue(this,Eg.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,i(o.addressList)}).catch(r)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){let n=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=e.reason;switch(e.code){case je.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case je.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let s=new D(C.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return _.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,s);if(!this.isStartingStreamingTask)return;this.statusError.set(n,s)}case je.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let s=new D(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,s)}case je.LIVE_STREAM_RESPONSE_WORKER_LOST:case je.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();let s=Array.from(si(o=this.streamingTasks).call(o));for(let a of s)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new D(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}let U6={name:"LiveStreaming",create:function(t){return new M6(t.joinInfo,t.websocketRetryConfig||Pe,t.httpRetryConfig||Pe)}};function x6(t){let e=FP();return function(n,i){let r=n.appId;r!==void 0&&(Qt(i,10),so(i,r));let o=n.cid;o!==void 0&&(Qt(i,16),Qt(i,o));let s=n.cname;s!==void 0&&(Qt(i,26),so(i,s));let a=n.deviceId;a!==void 0&&(Qt(i,34),so(i,a));let c=n.elapse;c!==void 0&&(Qt(i,40),as(i,c));let d=n.fileSize;d!==void 0&&(Qt(i,48),as(i,Mc(d)));let l=n.height;l!==void 0&&(Qt(i,56),as(i,Mc(l)));let u=n.jpg;u!==void 0&&(Qt(i,66),Qt(i,u.length),function(fe,U){let K=Uc(fe,U.length);fe.bytes.set(U,K)}(i,u));let h=n.networkType;h!==void 0&&(Qt(i,72),as(i,Mc(h)));let p=n.osType;p!==void 0&&(Qt(i,80),as(i,Mc(p)));let S=n.requestId;S!==void 0&&(Qt(i,90),so(i,S));let E=n.sdkVersion;E!==void 0&&(Qt(i,98),so(i,E));let f=n.sequence;f!==void 0&&(Qt(i,104),as(i,Mc(f)));let R=n.sid;R!==void 0&&(Qt(i,114),so(i,R));let v=n.timestamp;v!==void 0&&(Qt(i,120),as(i,v));let I=n.uid;I!==void 0&&(Qt(i,128),Qt(i,I));let w=n.vid;w!==void 0&&(Qt(i,136),Qt(i,w));let O=n.width;O!==void 0&&(Qt(i,144),as(i,Mc(O)));let A=n.service;A!==void 0&&(Qt(i,152),Qt(i,A));let N=n.callbackData;N!==void 0&&(Qt(i,162),so(i,N));let k=n.jpgEncryption;k!==void 0&&(Qt(i,168),Qt(i,k));let V=n.requestType;V!==void 0&&(Qt(i,176),Qt(i,V));let J=n.scorePorn;J!==void 0&&(Qt(i,185),LS(i,J));let ut=n.scoreSexy;ut!==void 0&&(Qt(i,193),LS(i,ut));let dt=n.scoreNeutral;dt!==void 0&&(Qt(i,201),LS(i,dt));let Ct=n.scene;Ct!==void 0&&(Qt(i,208),Qt(i,Ct));let St=n.ossFilePrefix;St!==void 0&&(Qt(i,218),so(i,St));let Gt=n.serviceVendor;if(Gt!==void 0)for(let fe of Gt){Qt(i,226);let U=FP();B6(fe,U),Qt(i,U.limit),H6(i,U),W6(U)}}(t,e),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(e)}function V6(t){return function(n){let i={};t:for(;!BP(n);){let r=ao(n);switch(r>>>3){case 0:break t;case 1:i.code=ao(n);break;case 2:i.msg=jP(n,ao(n));break;case 3:{let o=j6(n);i.data=F6(n),n.limit=o;break}default:xP(n,7&r)}}return i}({bytes:e=t,offset:0,limit:e.length});var e}function F6(t){let e={};t:for(;!BP(t);){let n=ao(t);switch(n>>>3){case 0:break t;case 1:e.requestId=jP(t,ao(t));break;case 2:e.requestType=ao(t)>>>0;break;case 3:e.scorePorn=PS(t);break;case 4:e.scoreSexy=PS(t);break;case 5:e.scoreNeutral=PS(t);break;case 6:e.requestScene=ao(t)>>>0;break;case 7:e.scene=ao(t)>>>0;break;default:xP(t,7&n)}}return e}function B6(t,e){let n=t.service;n!==void 0&&(Qt(e,8),Qt(e,n));let i=t.vendor;i!==void 0&&(Qt(e,16),Qt(e,i));let r=t.token;r!==void 0&&(Qt(e,26),so(e,r));let o=t.callbackUrl;o!==void 0&&(Qt(e,34),so(e,o))}function j6(t){let e=ao(t),n=t.limit;return t.limit=t.offset+e,n}function xP(t,e){switch(e){case 0:for(;128&GP(t););break;case 2:NS(t,ao(t));break;case 5:NS(t,4);break;case 1:NS(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let G6=new Float32Array(1);new Uint8Array(G6.buffer);let OS=new Float64Array(1),ni=new Uint8Array(OS.buffer);function Mc(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let VP=[];function FP(){let t=VP.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function W6(t){VP.push(t)}function NS(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function BP(t){return t.offset>=t.limit}function Uc(t,e){let n=t.bytes,i=t.offset,r=t.limit,o=i+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),i}function DS(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function jP(t,e){let n=DS(t,e),i=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=e?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h)}return s}function so(t,e){let n=e.length,i=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}Qt(t,i);let r=Uc(t,i),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function H6(t,e){let n=Uc(t,e.limit),i=t.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)i[o+n]=r[o]}function GP(t){return t.bytes[DS(t,1)]}function WP(t,e){let n=Uc(t,1);t.bytes[n]=e}function PS(t){let e=DS(t,8),n=t.bytes;return ni[0]=n[e++],ni[1]=n[e++],ni[2]=n[e++],ni[3]=n[e++],ni[4]=n[e++],ni[5]=n[e++],ni[6]=n[e++],ni[7]=n[e++],OS[0]}function LS(t,e){let n=Uc(t,8),i=t.bytes;OS[0]=e,i[n++]=ni[0],i[n++]=ni[1],i[n++]=ni[2],i[n++]=ni[3],i[n++]=ni[4],i[n++]=ni[5],i[n++]=ni[6],i[n++]=ni[7]}function ao(t){let e,n=0,i=0;do e=GP(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function Qt(t,e){for(e>>>=0;e>=128;)WP(t,127&e|128),e>>>=7;WP(t,e)}function as(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Uc(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}function HP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}let K6=new Map([["moderation",1],["supervise",2]]);class Y6 extends ge{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let n=this._connectionState;this._connectionState=e,this.emit(nn.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=Pi(n=e.map(i=>K6.get(i)||0)).call(n,(i,r)=>i+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),g(this,"name","AgoraRTCVideoContentInspect"),g(this,"_connectionState",rr.CONNECTING),g(this,"_innerConnectionState",void 0),g(this,"sequence",0),g(this,"inspectStartTime",void 0),g(this,"workerManagerConnection",void 0),g(this,"workerConnection",void 0),g(this,"workerMessageLengthLimit",void 0),g(this,"inspectIntervalMinimum",void 0),g(this,"qualityRatio",void 0),g(this,"_connectInfo",void 0),g(this,"_cancelTokenSource",Gn.CancelToken.source()),g(this,"_retryConfig",void 0),g(this,"wmSequence",0),g(this,"inspectInterval",void 0),g(this,"inspectTimer",null),g(this,"ossFilePrefix",void 0),g(this,"extraInfo",void 0),g(this,"_inspectType",void 0),g(this,"_inspectMode",void 0),g(this,"_quality",1),g(this,"qualityTimer",null),g(this,"_inspectId",void 0),g(this,"_needWorkUrlOnly",!1),g(this,"inspectImage",()=>{if(this.connectionState!==rr.CONNECTED)throw new D(C.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===rr.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=qt(5,"inspect-"),this.workerMessageLengthLimit=T("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=T("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=T("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Wd("worker-manager-"+this._inspectId,Pe),this.on(nn.STATE_CHANGE,(n,i)=>{this._innerConnectionState=n,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(or[n]," ").concat(i||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Wd("worker-"+this._inspectId,Pe),this.handleWorkerEvents()}async init(e,n){this.emit(nn.STATE_CHANGE,or.CONNECT_AP),this._connectInfo=e;let i=this._cancelTokenSource.token;return this._retryConfig=n,new Y((r,o)=>{this.on(nn.CONNECTION_STATE_CHANGE,(s,a)=>{a===rr.CONNECTED&&r()}),this.requestAP(e,i,n).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(e,n,i){let r=T("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:S,token:E,uid:f}=c;Rc++;let R="image_moderation_api",v={service_name:R,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:Rc,seq:Rc,sid:S,token:E,ts:Date.now(),uid:f+""})},I,w,O=a[0];return Cr(async()=>{I=Date.now();let A=await wr(O,{data:v,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(w=Date.now()-I,A.code!==0){let dt=new D(C.UNEXPECTED_RESPONSE,"image inspect ap error, code"+A.code,{retry:!0,responseTime:w});throw _.error(dt.toString()),dt}let N=JSON.parse(A.json_body);if(N.code!==200){let dt=new D(C.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(N.code,", reason: ").concat(N.reason),{code:N.code,responseTime:w});throw _.error(dt.toString()),dt}if(!N.servers||!Array.isArray(N.servers)||N.servers.length===0){let dt=new D(C.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:N.code,responseTime:w});throw _.error(dt.toString()),dt}let k=T("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(k)return{addressList:[k],workerToken:N.workerToken,vid:N.vid,responseTime:w};let V=T("VIDEO_INSPECT_WORKER_MANAGER_HOST"),J=T("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:N.servers.map(dt=>{let{address:Ct,wss:St}=dt;if(Ct&&St)return"wss://".concat(Ct.replace(/\./g,"-"),".").concat(V,":").concat(J||St)}).filter(dt=>!!dt),workerToken:N.workerToken,vid:N.vid,responseTime:w}},(A,N)=>(tt.apworkerEvent(S,{success:!0,sc:200,serviceName:R,responseDetail:JSON.stringify(A.addressList),firstSuccess:N===0,responseTime:w,serverIp:a[N%a.length]}),!1),(A,N)=>(tt.apworkerEvent(S,{success:!1,sc:A.data&&A.data.code||200,serviceName:R,responseTime:w,serverIp:a[N%a.length]}),!!(A.code!==C.OPERATION_ABORTED&&A.code!==C.UNEXPECTED_RESPONSE||A.data&&A.data.retry)&&(O=a[(N+1)%a.length],!0)),l)}(r,e,n,i);this.emit(nn.STATE_CHANGE,or.AP_CONNECTED);let{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(nn.STATE_CHANGE,or.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Tt.CONNECTED,async()=>{this.emit(nn.STATE_CHANGE,or.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Tt.CLOSED,()=>{this._innerConnectionState<or.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Tt.FAILED,()=>{this._innerConnectionState<or.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Tt.RECONNECTING,()=>{this._innerConnectionState<or.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Tt.ON_MESSAGE,async e=>{this.emit(nn.STATE_CHANGE,or.GET_WORKER_MANAGER_RESPONSE);let n=this.workerManagerConnection.url;this.workerManagerConnection.close();let i=JSON.parse(e.data);if(i.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new D(C.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new D(C.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{let r=T("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(r));this.emit(nn.STATE_CHANGE,or.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(nn.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(Tt.WILL_RECONNECT,(e,n,i)=>{i(e)}),this.workerManagerConnection.on(Tt.REQUEST_NEW_URLS,(e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)})}handleWorkerEvents(){this.workerConnection.on(Tt.CONNECTED,async()=>{this.emit(nn.STATE_CHANGE,or.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=rr.CONNECTED}),this.workerConnection.on(Tt.ON_MESSAGE,async e=>{if(e.data instanceof ArrayBuffer){let i=V6(new Uint8Array(e.data));if(T("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(nn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;let r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},o=Pi(n=Object.keys(r)).call(n,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(nn.INSPECT_RESULT,s)}else this.emit(nn.INSPECT_RESULT,void 0,new D(C.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(nn.INSPECT_RESULT,void 0,new D(C.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(nn.INSPECT_RESULT,void 0,new D(C.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Tt.CLOSED,()=>{this.connectionState=rr.CLOSED}),this.workerConnection.on(Tt.FAILED,()=>{this.connectionState=rr.CLOSED}),this.workerConnection.on(Tt.RECONNECTING,()=>{this.connectionState=this.connectionState===rr.CONNECTED?rr.RECONNECTING:rr.CONNECTING}),this.workerConnection.on(Tt.WILL_RECONNECT,(e,n,i)=>{e==="recover"&&i(e),i("tryNext")}),this.workerConnection.on(Tt.REQUEST_NEW_URLS,(e,n)=>{this.workerManagerConnection.close(),this.once(nn.REQUEST_NEW_WORKER_URL,i=>{e([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{n(i)})})}async requestToInspectImage(){this.sequence++;let e=di(this,nn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(nn.INSPECT_RESULT,void 0,new D(C.INVALID_OPERATION,"Only the track being played can be inspected"));let i=await this.generateRequestData(e,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(nn.INSPECT_RESULT,void 0,new D(C.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n,d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),u=await T0(l,i,r),h=this.sequence+"-"+o+"-"+c+"-"+d+"-"+qt(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:(S=Number(d-this.inspectStartTime),{low:S|=0,high:S>>31,unsigned:S>=0}),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.24.2",sequence:this.sequence,sid:a,timestamp:JN(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var S;this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;let E=x6(p);if(E.byteLength<this.workerMessageLengthLimit){if(T("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let f=function(R){for(var v=1;v<arguments.length;v++){var I=arguments[v]!=null?arguments[v]:{};v%2?HP(Object(I),!0).forEach(function(w){g(R,w,I[w])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(I)):HP(Object(I)).forEach(function(w){Object.defineProperty(R,w,Object.getOwnPropertyDescriptor(I,w))})}return R}({},p);delete f.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return E}{let f=this.quality*this.qualityRatio;return this.quality=f,await this.generateRequestData(e,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Gn.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=rr.CLOSED,this.emit(nn.STATE_CHANGE,or.CLOSED)}}let q6={name:"ContentInspect",create:function(t){let{config:e}=t;return function(n){if(!n)throw new D(C.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new D(C.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{let i=[...new Set(n.inspectType)];i.forEach(r=>{var o;if(!B(o=["supervise","moderation"]).call(o,r))throw new D(C.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))}),n.inspectType=i}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new D(C.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new Y6(e)}};var KP=H(pi.Object.getOwnPropertySymbols),z6=Yt,X6=T_.indexOf,J6=Ul,kS=zc([].indexOf),YP=!!kS&&1/kS([1],1,-0)<0;z6({target:"Array",proto:!0,forced:YP||!J6("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return YP?kS(this,t,e)||0:X6(this,t,e)}});var Q6=Di("Array","indexOf"),Z6=At,$6=Q6,MS=Array.prototype,t8=function(t){var e=t.indexOf;return t===MS||Z6(MS,t)&&e===MS.indexOf?$6:e},qP=H(t8);function e8(t,e){if(t==null)return{};var n,i,r=function(s,a){if(s==null)return{};var c={};for(var d in s)if({}.hasOwnProperty.call(s,d)){if(qP(a).call(a,d)!==-1)continue;c[d]=s[d]}return c}(t,e);if(KP){var o=KP(t);for(i=0;i<o.length;i++)n=o[i],qP(e).call(e,n)===-1&&{}.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}let zP=class{get localCapabilities(){return he(this._localCapabilities)}get rtpCapabilities(){return he(this._rtpCapabilities)}get candidates(){return he(this._candidates)}get iceParameters(){return he(this._iceParameters)}get dtlsParameters(){return he(this._dtlsParameters)}constructor(t){g(this,"sessionDesc",void 0),g(this,"_localCapabilities",void 0),g(this,"_rtpCapabilities",void 0),g(this,"_candidates",void 0),g(this,"_iceParameters",void 0),g(this,"_dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname","o/i14u9pJrxRKAsu"),g(this,"firefoxSsrcMidMap",new Map),t=he(t);let{remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=t,l;this.setup=a,l=s===Vn.RECEIVE_ONLY?Mn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Mn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=o;let u=s===Vn.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===Vn.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===Vn.RECEIVE_ONLY?r.send.videoCodecs:Xd(Z.VIDEO,u,h,c),S=s===Vn.RECEIVE_ONLY?r.send.audioCodecs:Xd(Z.AUDIO,u,h,d);for(let E of l.mediaDescriptions)E.attributes.iceUfrag=e.iceUfrag,E.attributes.icePwd=e.icePwd,E.attributes.fingerprints=n.fingerprints,E.attributes.candidates=i,E.attributes.setup=this.setup,E.media.mediaType==="application"&&(E.attributes.sctpPort="5000"),E.media.mediaType==="video"&&(E.media.fmts=p.map(f=>f.payloadType.toString(10)),E.attributes.payloads=p,E.attributes.extmaps=u.videoExtensions),E.media.mediaType==="audio"&&(E.media.fmts=S.map(f=>f.payloadType.toString(10)),E.attributes.payloads=S,E.attributes.extmaps=u.audioExtensions,Tc(E));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return To(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,n,i,r){n=n.replace(/ /g,"-");let{ssrcs:o,ssrcGroups:s}=qd(e,this.cname,T("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ue()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){let c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{let c=this.findAvailableMediaIndex(t,o,i),d;return c===-1?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",i,r),this.updateBundleMids()):(d=he(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),ue()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,n){let i=[];return t.forEach(r=>{let o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o),a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,n),this.updateBundleMids()):(a=he(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})}),i}stopReceiving(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){let{foundation:e,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,n,i,r){let o=t._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Xd(o,s,this.localCapabilities.send,o===Z.AUDIO?r:i),c=o===Z.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex),l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,t);let u=this.findFirstClosedMedia(o);if(u){let h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>B(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(n=>B(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{let r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(ue()){if(r){let o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{let n=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n})}predictReceivingMids(t){let e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=he(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,n,i,r,o){let s=this.rtpCapabilities.send,a=t===Z.VIDEO?s.videoCodecs:s.audioCodecs,c=t===Z.VIDEO?s.videoExtensions:s.audioExtensions;ue()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);let l=this.findFirstClosedMedia(t);if(l){let u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,n){let i=he(t);return yg(i),Js(i,e),Ig(i,e),FO(i),Kh(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){let n=he(t);return Kh(n,e,this.localCapabilities.recv),Tc(n),n}updateRecvMedia(t,e){let n=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===t);if(n!==-1){let i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>ue()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}},n8=["sdp"];var pe;function XP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function cs(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?XP(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):XP(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let JP=(pe=class Fc extends RO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,i){super(e,n),g(this,"direction",void 0),g(this,"name",void 0),g(this,"store",void 0),g(this,"spec",void 0),g(this,"peerConnection",void 0),g(this,"initialOffer",void 0),g(this,"transport",void 0),g(this,"statsFilter",void 0),g(this,"localCandidateCount",0),g(this,"_isInRestartIce",!1),g(this,"mutex",void 0),g(this,"onLocalCandidate",void 0),g(this,"remoteSDP",void 0),g(this,"pendingCandidates",[]),g(this,"localCapabilities",void 0),g(this,"isReady",!1),g(this,"restartCnt",0),g(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.mutex=new tn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Fc.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??Vn.SEND_ONLY,this.name=this.direction===Vn.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=ph(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,ue()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{let n=await bg();if(this.localCapabilities=zd(n),e){let{sdp:i}=e,r=e8(e,n8),o=function(){let l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=Yd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ar(u,l,"videoExtensions",h,p,S),ar(u,l,"videoCodecs",h,p,S),ar(u,l,"audioExtensions",h,p,S),ar(u,l,"audioCodecs",h,p,S),T("RAISE_H264_BASELINE_PRIORITY")){let E=S.videoCodecs.findIndex(f=>f.rtpMap&&f.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&f.fmtp&&f.fmtp.parameters["profile-level-id"]==="42001f");if(E!==-1){let f=S.videoCodecs.findIndex(R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(f<E){_.debug("raising H264 baseline profile priority");let R=S.videoCodecs[E];S.videoCodecs.splice(E,1),S.videoCodecs.splice(f,0,R)}f!==-1&&T("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>!(R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:h,recv:p,sendrecv:S}}({},{},i);this.remoteSDP=new zP({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let a=Zr(s.sdp);await this.peerConnection.setLocalDescription(s);let c=await jO({},{},s.sdp);this.localCapabilities=zd(c);let d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),cs(cs({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=Zr(i.sdp);return this.initialOffer=i,cs(cs({},r),{},{sdp:i.sdp})}}catch(n){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:n,iceParameters:i,dtlsParameters:r}=e,o=await jO({},{},n);this.remoteSDP=new zP({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new L(C.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return jn(function*(){let o=yield yt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=r.remoteSDP.receive(e,n,i);e.forEach((f,R)=>{if(a[R].needCreateTransceiver){let v=r.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});s.push(v),f._updateRtpTransceiver(v)}else{let v=r.peerConnection.getTransceivers().find(I=>I.mid===a[R].mid);if(!v)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[R].mid));s.push(v),f._updateRtpTransceiver(v)}}),ue()&&T("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(s,e)));let c=a.map(f=>f.mid),d=yield yt(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),u=Mn(l),h=c.map(f=>{let R=u.mediaDescriptions.find(v=>v.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return vg(R,T("USE_PUB_RTX"))}),p=s.map((f,R)=>{let v=c[R];return{localSSRC:h[R],id:v}});yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p}catch(f){let R=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield yt(r.stopSending(c,!0)),f}yield yt(r.applySimulcastEncodings(s,e)),yield yt(r.applySendEncodings(s,e));let S=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return E?.(S),yield yt(r.setRemoteDescription({type:"answer",sdp:S})),s.map((f,R)=>{let v=c[R];return{localSSRC:h[R],id:v}})}catch(s){throw s instanceof L?s:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});let l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,e);d?.(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);if(s){let a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});let d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,o,e);c?.(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===Vs.Auto&&(this.store.p2pTransport=Vs.SdRtn,wt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Fc.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,wt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Fc.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;let n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:i}=Zr(n.sdp);return this.store.descriptionStart(),this.direction===Vn.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===Vn.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:i}=Zr(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ue()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:cs(cs({},er),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:cs(cs({},er),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;B(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else _.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r={iceServers:[]};var o;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ps(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...Fc.turnServerConfigToIceServers(e.turnServer.servers,n,i)),T("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...Fc.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,i)),B(o=[Vs.Relay,Vs.SdRtn]).call(o,n)&&(r.iceTransportPolicy="relay"),T("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(r.iceTransportPolicy="relay")}))),T("ENABLE_ENCODED_TRANSFORM")&&wt().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r=[],o=e.filter(a=>a.tcpport);_.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(i));let s=o.length>i?o[i]:o[0];switch(n){case Vs.SdRtn:let a=e.filter(d=>{var l;return B(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(sr(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(sr(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Vs.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(sr(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(sr(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var i;e!=null&&e.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,e.state))},e.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};let n=e.iceTransport;n&&(n.onstatechange=()=>{let i=e?.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){let{local:i,remote:r}=n.getSelectedCandidatePair()||{};if(i&&r){let o=i.address+":"+i.port,s=r.address+":"+r.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Qr(o)),", remote ").concat(JSON.stringify(Qr(s))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!wt().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var s;let{bitrateMax:l,frameRate:u,scaleResolutionDownBy:h}=e._encoderConfig;l&&(o.maxBitrate=1e3*l),B(s=e._hints).call(s,Kt.LOW_STREAM)&&(u&&(o.maxFramerate=Yn(u)),h&&h>=1&&(o.scaleResolutionDownBy=h))}if(T("DSCP_TYPE")&&Kr()){var a;let l=T("DSCP_TYPE");B(a=["very-low","low","medium","high"]).call(a,l)&&(o.networkPriority=l)}let c=n.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];ue()&&!d&&(r.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(e,n){try{if(!wt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];o instanceof oe&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){let r=Mn(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Js(c,o),Ag(c,o,this.store.codec))}),To(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof oe&&!B(i=l._hints).call(i,Kt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(e,n){if(!ue()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof oe&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof oe&&T("SIMULCAST")&&this.store.codec==="vp8"&&!B(n=e._hints).call(n,Kt.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(T("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async s=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var i;if(n=n??((i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp)){var r;let o=(r=Mn(n).mediaDescriptions.find(s=>s.attributes.mid===e))===null||r===void 0?void 0:r.attributes.ssrcs;return o?.[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),B(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,n,i){let r=Mn(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===Z.AUDIO&&o.media.mediaType==="audio"&&Tc(o),To(r)}},q(pe.prototype,"establish",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"establish"),pe.prototype),q(pe.prototype,"connect",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"connect"),pe.prototype),q(pe.prototype,"receive",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"receive"),pe.prototype),q(pe.prototype,"mockReceive",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"mockReceive"),pe.prototype),q(pe.prototype,"stopReceiving",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"stopReceiving"),pe.prototype),q(pe.prototype,"restartICE",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"restartICE"),pe.prototype),q(pe.prototype,"close",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"close"),pe.prototype),q(pe.prototype,"updateEncoderConfig",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"updateEncoderConfig"),pe.prototype),q(pe.prototype,"updateSendParameters",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"updateSendParameters"),pe.prototype),q(pe.prototype,"replaceTrack",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"replaceTrack"),pe.prototype),q(pe.prototype,"muteLocal",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"muteLocal"),pe.prototype),q(pe.prototype,"unmuteLocal",[hr],Object.getOwnPropertyDescriptor(pe.prototype,"unmuteLocal"),pe.prototype),pe);function hr(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}let Dr=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});var QP,ZP,$P,tL,eL,nL,iL,rL,oL,sL,aL,Se;function cL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function yp(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?cL(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):cL(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let i8=(QP=Pr(Dr.SEND_ONLY),ZP=Pr(Dr.SEND_ONLY),$P=Pr(),tL=Pr(Dr.RECEIVE_ONLY),eL=Pr(Dr.RECEIVE_ONLY),nL=Pr(Dr.RECEIVE_ONLY),iL=Pr(Dr.RECEIVE_ONLY),rL=Pr(Dr.RECEIVE_ONLY),oL=Pr(Dr.RECEIVE_ONLY),sL=Pr(),aL=Pr(Dr.RECEIVE_ONLY),Se=class extends ge{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(rt.StateChange,e,this._state)}constructor(t,e){super(),g(this,"isPlanB",!1),g(this,"store",void 0),g(this,"statsUploader",void 0),g(this,"sendConnection",void 0),g(this,"recvConnection",void 0),g(this,"localTrackMap",new Map),g(this,"remoteUserMap",new Map),g(this,"localDataChannels",[]),g(this,"pendingLocalTracks",[]),g(this,"pendingRemoteTracks",[]),g(this,"statsCollector",void 0),g(this,"dtlsFailedCount",0),g(this,"sendMutex",void 0),g(this,"recvMutex",void 0),g(this,"_state",Ht.Disconnected),g(this,"_restartStates",["disconnected","failed"]),g(this,"reconnectInterval",void 0),g(this,"uploadUnplinkStarted",!1),g(this,"uploadDownlinkStarted",!1),g(this,"uplinkStateUploadInterval",void 0),g(this,"downlinkStatsUploadInterval",void 0),g(this,"handleMuteLocalTrack",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Ht.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();let d=c.find(p=>p[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(p=>{let[,{id:S}]=p;return S}));let l=!1;var s,a;n.trackMediaType==="video"?l=!((s=this.localTrackMap.get(j.LocalAudioTrack))===null||s===void 0||!s.track._muted):l=((a=this.localTrackMap.get(j.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;let u=this.createMuteMessage(c);await se(this,rt.RequestMuteLocal,u);let h=n.trackMediaType==="video"?Jo.MUTE_LOCAL_VIDEO:Jo.MUTE_LOCAL_AUDIO;await se(this,rt.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),i()}catch(c){r(c)}finally{o()}}),g(this,"handleUnmuteLocalTrack",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Ht.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();await this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let a=this.createUnmuteMessage(s),c=n.trackMediaType==="video"?Jo.UNMUTE_LOCAL_VIDEO:Jo.UNMUTE_LOCAL_AUDIO;await se(this,rt.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(s){r(s)}finally{o()}}),g(this,"handleUpdateVideoEncoder",async(n,i,r,o)=>{let s;typeof o=="boolean"&&o||(s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(j.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==n||this.state!==Ht.Connected)return void i();let{id:d,track:l}=c;d&&(await this.sendConnection.updateSendParameters(d,l),await this.sendConnection.updateEncoderConfig(d,l),this.emit(rt.UpdateVideoEncoder,l)),i()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}}),g(this,"handleUpdateVideoSendParameters",async(n,i,r)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(j.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==Ht.Connected)return void i();let{id:a,track:c}=s;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}}),g(this,"handleReplaceTrack",async(n,i,r,o)=>{let s;_.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==Ht.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===j.LocalVideoTrack&&wt().supportDualStreamEncoding){let l=this.localTrackMap.get(j.LocalVideoLowTrack);if(l){let u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new Y((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}}),g(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),g(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),g(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),g(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new vN(t),this.bindStatsUploaderEvents(),this.sendMutex=new tn("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new tn("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},T("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new L(C.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new JP(t,this.store,Vn.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let i=await this.recvConnection.establish(e);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=Ht.New,this.sendConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new JP(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(t){if(!this.sendConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Ht.Connected}async addRemoteCandidate(t,e){if(e===Vn.RECEIVE_ONLY){if(!this.sendConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,n){var i=this;return jn(function*(){let r=yield yt(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==Ht.Connected){i.throwIfTrackTypeNotMatch(t);let d=t.filter(l=>i.pendingLocalTracks.indexOf(l)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,Tn.markPublishStart(i.store.clientId,i.store.pubId);let o=i.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield yt(i.tryToUnmuteAudio(t)));o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();i.store.publish(l.getTrackId(),u===j.LocalAudioTrack?"audio":"video",h)}),i.bindLocalTrackEvents(o);let s=yield yt(i.sendConnection.send(o.map(d=>{let{track:l}=d;return l}),i.store.codec,i.store.audioCodec)),a=(yield yt(s.next())).value,c=i.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),d?.code===C.WS_ABORT&&o.forEach(l=>{let{track:u}=l;i.pendingLocalTracks.indexOf(u)===-1&&i.pendingLocalTracks.push(u)}),i.unbindLocalTrackEvents(o),d}yield yt(s.next()),o.forEach(d=>{let{type:l}=d;i.statsCollector.addLocalStats(l)}),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(o,a),o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();i.store.publish(l.getTrackId(),u===j.LocalAudioTrack?"audio":"video",void 0,h)}),i.startUploadUplinkState()}finally{r()}})()}async unpublish(t){if(!this.sendConnection||this.state!==Ht.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!B(t).call(t,r)));let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let n=e.find(r=>r[0]==="videoLowTrack");n&&n[1].track.close();let i=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Ht.Connected)return n&&n[1].track.close(),i;t.forEach(r=>{let o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let t=()=>{let e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(i=>{let[r,{track:o,ssrcs:s}]=i,a={stream_type:KH(o,r),ssrcs:s};o._muted||!o._enabled?e.push(a):n.push(a)}),e.length>0&&e.forEach(i=>{se(this,rt.RequestMuteLocal,[i])}),n.length>0&&n.forEach(i=>{se(this,rt.RequestUnmuteLocal,[i])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return jn(function*(){throw new L(C.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Ue(this,rt.RequestRePublish,this.pendingLocalTracks),this.emit(rt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new L(C.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,i){var r;if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;let{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),i);e===Z.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new hc(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new uc(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));let c=this.remoteUserMap.get(t);c?c.set(e,s):this.remoteUserMap.set(t,new Map([[e,s]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let d=this.pendingRemoteTracks.findIndex(l=>{let{user:u,kind:h}=l;return u.uid===t.uid&&e===h});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(rt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,n,i){if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),i)}async unsubscribe(t,e,n){let i=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return e!==void 0?s.uid===t.uid&&e===a:s.uid===t.uid});if(i.forEach(o=>{let s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||n||i.forEach(o=>{let{kind:s}=o;var a;if(s===Z.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(s===Z.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;let r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===Z.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===Z.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),n||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===Z.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),!n&&((l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:s}]=o;se(this,rt.RequestP2PMuteRemote,s)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[Z.VIDEO,Z.AUDIO].forEach(i=>{n.has(i)?se(this,rt.RequestP2PUnmuteRemote,i):se(this,rt.RequestP2PMuteRemote,i)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let i=e===Z.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;let n=this.remoteUserMap.get(t);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){let e=this.localTrackMap.get(j.LocalAudioTrack);if(e?.track instanceof Be){let n=e.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==j.LocalAudioTrack}).filter(i=>{let[r]=i;return!(t&&r===j.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(t&&i===j.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}reportPublishEvent(t,e,n,i,r){if(t){let s=this.localTrackMap.get(j.LocalAudioTrack),a=i?this.localTrackMap.get(j.LocalVideoLowTrack):this.localTrackMap.get(j.LocalVideoTrack);tt.publish(this.store.sessionId,{eventElapse:Tn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Kt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);let s=n.find(c=>c instanceof Ae),a=i?(o=this.localTrackMap.get(j.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof oe);tt.publish(this.store.sessionId,{eventElapse:Tn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Kt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){let r=i===Z.VIDEO?n._videoSSRC:n._audioSSRC;r&&tt.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===Z.VIDEO,audio:i===Z.AUDIO,peerid:n.uid,subscribeRequestid:i===Z.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Tn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new tn("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new tn("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(j.LocalAudioTrack);if(t?.track instanceof Be){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Ht.Disconnected}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(j.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(j.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof oe||e&&e.track instanceof Ae?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;let n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;let n=Array.from(bn(e=this.remoteUserMap).call(e)).find(i=>i.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(j.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Cs(t).call(t,(n,i)=>n.level-i.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Ht.Reconnecting,T("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:i}]=t;switch(n){case j.LocalVideoTrack:B(e=i._hints).call(e,Kt.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case j.LocalAudioTrack:i instanceof Be?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case j.LocalVideoLowTrack:}}),this.emit(rt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(bn(n).call(n)).forEach(i=>{this.setPendingRemoteMedia(e,i)}),this.emit(rt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(let n of this.pendingRemoteTracks){let{user:i,kind:r}=n;if((t instanceof $o?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let n,i;if(t===Vn.SEND_ONLY){if(!this.sendConnection)throw new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(e){let r=await i.restartICE(e);return i.isInRestartIce=!1,r}{let r=await i.restartICE();if(r){let o=await Ue(this,rt.RequestP2PRestartICE,{direction:Vn.RECEIVE_ONLY,iceParameter:r});await i.restartICE(o),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let t=this.sendConnection.getStats(),e=this.localTrackMap.get(j.LocalVideoTrack),n=this.localTrackMap.get(j.LocalAudioTrack),i=t.videoSend.find(p=>{var S;return p.ssrc===(e==null||(S=e.ssrcs)===null||S===void 0?void 0:S[0].ssrcId)}),r=t.audioSend.find(p=>{var S;return p.ssrc===(n==null||(S=n.ssrcs)===null||S===void 0?void 0:S[0].ssrcId)});if(!i||!r)return 1;let o=di(this,rt.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(Kt.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,S=t.bitrate.actualEncoded;if(p&&S){let E=(1e3*p-S)/(1e3*p);return pO[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let t=this.recvConnection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n,r=i._audioSSRC,o=i._videoSSRC,s=t.audioRecv.find(S=>S.ssrc===r),a=t.videoRecv.find(S=>S.ssrc===o);if(!s&&!a)return void(e+=1);let c=di(this,rt.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new Y((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}filterTobePublishedTracks(t,e,n){let i=[],r=wt(),o=this.getAllTracks();t=Za(t=t.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(let c of t){if(c instanceof oe&&(this.localTrackMap.has(j.LocalVideoTrack)||s?new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:j.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,n);i.push({track:d,type:j.LocalVideoLowTrack})}if(c instanceof Ae){let d=this.localTrackMap.get(j.LocalAudioTrack);if(d){if(!(d.track instanceof Be))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){let l=i.find(u=>{let{type:h}=u;return h===j.LocalAudioTrack});if(!(l.track instanceof Be))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Be||c._bypassWebAudio)i.push({track:c,type:j.LocalAudioTrack});else{let l=new Be;l.addAudioTrack(c),i.push({track:l,type:j.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(t){let e=[],n=this.getAllTracks();t=Za(t=t.filter(i=>n.indexOf(i)!==-1));for(let i of t){if(i instanceof Ae){let r=this.localTrackMap.get(j.LocalAudioTrack);if(!r)continue;r.track instanceof Be?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([j.LocalAudioTrack,r]),r.track.close())):e.push([j.LocalAudioTrack,r])}if(i instanceof oe){let r=this.localTrackMap.get(j.LocalVideoTrack);if(!r)continue;e.push([j.LocalVideoTrack,r]);let o=this.localTrackMap.get(j.LocalVideoLowTrack);o&&e.push([j.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:i}=e;switch(i){case j.LocalVideoTrack:n.addListener(et.GET_STATS,this.handleGetLocalVideoStats),n.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(et.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(et.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case j.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case j.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Be?t.trackList.forEach(n=>{n.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(et.GET_STATS,this.handleGetLocalAudioStats),n.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(et.GET_STATS,this.handleGetLocalAudioStats),t.addListener(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(et.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:i}]=e;return{track:i,type:n}})),t.forEach(e=>{let{track:n,type:i}=e;switch(i){case j.LocalVideoTrack:n.off(et.GET_STATS,this.handleGetLocalVideoStats),n.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(et.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(et.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case j.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case j.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Be?t.trackList.forEach(e=>{e.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(et.GET_STATS,this.handleGetLocalAudioStats),e.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(et.GET_STATS,this.handleGetLocalAudioStats),t.off(et.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(et.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(et.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(et.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(et.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof uc&&e.addListener(et.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof hc&&e.addListener(et.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(et.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(Z.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(Z.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,i)=>{var r;let o,{track:s,type:a}=n;switch(a){case j.LocalAudioTrack:o=Xt.Audio;break;case j.LocalVideoTrack:o=B(r=s._hints).call(r,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:o=Xt.Low}return{kind:a===j.LocalAudioTrack?Z.AUDIO:Z.VIDEO,stream_type:o,mid:e[i].id,ssrcs:e[i].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(rt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),B(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await Ye(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),tt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:re.TRACER}).onSuccess(),this.emit(rt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Ui.FIRST_FRAME_DECODED),tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_DECODE,Ee.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);i&&tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_RECEIVED,Ee.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoReceived=e=>{var n;let i=Array.from(bn(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);i&&tt.firstRemoteFrame(this.store.sessionId,Fe.FIRST_VIDEO_RECEIVED,Ee.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{let i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(rt.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Qo(n))," -> ").concat(JSON.stringify(Qo(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Qo(n))," -> ").concat(JSON.stringify(Qo(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(rt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){let e=t===Vn.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,_.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===Vn.SEND_ONLY?this.restartICE(t):Ue(this,rt.RequestP2PRestartICE,{direction:Vn.SEND_ONLY}))}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let n=this.localTrackMap.get(j.LocalAudioTrack);if(t instanceof Ae&&n?.track instanceof Be)return n.track.isActive||e.push([j.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i&&(e.push(i),i[0]===j.LocalVideoTrack)){let r=this.localTrackMap.get(j.LocalVideoLowTrack);r&&e.push([j.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){let e=[],n=this.localTrackMap.get(j.LocalAudioTrack);if(t instanceof Ae&&n?.track instanceof Be)return n.track.isActive&&e.push([j.LocalAudioTrack,n]),e;let i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(i)if(i[0]===j.LocalVideoTrack){e.push(i);let r=this.localTrackMap.get(j.LocalVideoLowTrack);r&&e.push([j.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let i,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case j.LocalAudioTrack:i=Xt.Audio;break;case j.LocalVideoTrack:i=B(n=o._hints).call(n,Kt.SCREEN_TRACK)?Xt.Screen:Xt.High;break;case j.LocalVideoLowTrack:i=Xt.Low}return{stream_type:i,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){let r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([t,{kind:o,id:s}])});return n}createUnsubscribeMessage(t){let e=[];return t.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case Z.VIDEO:return void(i._videoSSRC&&e.push({stream_type:Z.VIDEO,ssrcId:i._videoSSRC}));case Z.AUDIO:return void(i._audioSSRC&&e.push({stream_type:Z.AUDIO,ssrcId:i._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:i}]=e,r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){let e=this.localTrackMap.get(j.LocalVideoTrack),n=this.localTrackMap.get(j.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new Y((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)})),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new Y((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof Ae){let n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;let i=this.createUnmuteMessage(n);return void await se(this,rt.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(rt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(rt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Ye(dh(this.dtlsFailedCount,Pe)),this.emit(rt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(j.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof oe)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof oe).length>1)throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Ae).length>1&&(t.some(e=>e instanceof Ae&&e._bypassWebAudio)||!wt().webAudioMediaStreamDest))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof oe&&this.pendingLocalTracks.some(n=>n instanceof oe))throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Ae&&this.pendingLocalTracks.some(n=>n instanceof Ae)&&(!wt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Ae&&n._bypassWebAudio)))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){let n=!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&wt().supportDualStreamEncoding,i=yp(yp({},{width:160,height:120,framerate:15,bitrate:50}),e),r;r=n?t._mediaStreamTrack.clone():Yg(t,i);let o=qt(8,"track-low-"),s=new oe(r,yp(yp({},n&&{scaleResolutionDownBy:Cg(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(js.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,oc.LOW_STREAM)}),s._hints.push(Kt.LOW_STREAM),t.addListener(et.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,i){var r;let o=Array.from(bn(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");tt.firstRemoteVideoDecode(this.store.sessionId,Fe.FIRST_VIDEO_DECODE,Ee.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Tn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return!1;let i=this.remoteUserMap.get(t);if(!i)return!1;let r=i.get(e);if(!r)return!1;let o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==n}isPreSubScribe(t){return!1}async publishDataChannel(t){throw new L(C.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new L(C.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new L(C.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new L(C.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new L(C.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new L(C.NOT_SUPPORTED)}async preConnect(t){throw new L(C.NOT_SUPPORTED)}getEstablishParams(){throw new L(C.NOT_SUPPORTED)}async reSubscribe(t){throw new L(C.NOT_SUPPORTED)}reportVideoFirstFrameRender(t){}async updateVideoStreamParameter(t,e){throw new L(C.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===j.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,oc.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},q(Se.prototype,"p2pConnect",[QP],Object.getOwnPropertyDescriptor(Se.prototype,"p2pConnect"),Se.prototype),q(Se.prototype,"unpublish",[ZP],Object.getOwnPropertyDescriptor(Se.prototype,"unpublish"),Se.prototype),q(Se.prototype,"unpublishLowStream",[$P],Object.getOwnPropertyDescriptor(Se.prototype,"unpublishLowStream"),Se.prototype),q(Se.prototype,"subscribe",[tL],Object.getOwnPropertyDescriptor(Se.prototype,"subscribe"),Se.prototype),q(Se.prototype,"mockSubscribe",[eL],Object.getOwnPropertyDescriptor(Se.prototype,"mockSubscribe"),Se.prototype),q(Se.prototype,"unsubscribe",[nL],Object.getOwnPropertyDescriptor(Se.prototype,"unsubscribe"),Se.prototype),q(Se.prototype,"muteRemote",[iL],Object.getOwnPropertyDescriptor(Se.prototype,"muteRemote"),Se.prototype),q(Se.prototype,"unmuteRemote",[rL],Object.getOwnPropertyDescriptor(Se.prototype,"unmuteRemote"),Se.prototype),q(Se.prototype,"hasRemoteMediaWithLock",[oL],Object.getOwnPropertyDescriptor(Se.prototype,"hasRemoteMediaWithLock"),Se.prototype),q(Se.prototype,"disconnectForReconnect",[sL],Object.getOwnPropertyDescriptor(Se.prototype,"disconnectForReconnect"),Se.prototype),q(Se.prototype,"remoteMediaSsrcChanged",[aL],Object.getOwnPropertyDescriptor(Se.prototype,"remoteMediaSsrcChanged"),Se.prototype),Se);function Pr(t){return function(e,n,i){let r=e[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(t){case Dr.SEND_ONLY:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}case Dr.RECEIVE_ONLY:{let c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}default:{let c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c(),d()}}}},i}}class ca extends ge{constructor(e,n){super(),g(this,"signal",void 0),g(this,"token",void 0),g(this,"tokenTimeout",void 0),g(this,"tokenInterval",void 0),g(this,"_sequence",0),g(this,"userMap",new Map),g(this,"encoder",new TextEncoder),this.signal=e,this.token=n;let i=()=>{this.signal.connectionState===Pt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*T("P2P_TOKEN_INTERVAL"))};i()}async send(e,n,i,r,o){var s;if(this.userMap.size===0)return;let a=Array.from(si(s=this.userMap).call(s))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=r??qt(6,""),o=o??this._sequence++;let c={_id:r,_type:e,_seq:o,_message:n,token:"".concat(this.token,"_").concat(a)};T("SHOW_P2P_LOG")&&_.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach(l=>{this.signal.request(it.DATA_STREAM,{payload:Yo(this.encoder.encode(l))})});let d=new Y((l,u)=>{let h=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),E),this.off(fc.ABORT,S),_.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?u(new L(C.INVALID_REMOTE_USER)):u(new L(C.TIMEOUT))},T("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),p=()=>{h&&window.clearTimeout(h),this.off(fc.ABORT,S),i&&l()},S=()=>{h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),E),u(new L(C.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once(fc.ABORT,S),this.once("res-@".concat(r,"_ack"),p);let E=(R,v)=>{f=!0,h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off(fc.ABORT,S),R==="success"?l(v):u(new L(C.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))},f=!1;i||(this.once("res-@".concat(r),E),Ye(T("SIGNAL_REQUEST_TIMEOUT")).then(()=>{f||_.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(c))}))});try{return await d}catch(l){if(l.code===C.TIMEOUT)return await this.send(e,n,i,r,o);throw l}}onMessage(e){var n;let{_uid:i}=e,r,o=this.userMap.get(i);if(o)r=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==Oe.CHECK)return;let{token:d}=e;r=new Map,o={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,o),this.signal.emit(pt.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;let{id:d,total:l}=e,u=(s=r.get(d))!==null&&s!==void 0?s:[];if(u.push(e),r.has(d)||r.set(d,u),u.length!==l)return;{let h=Cs(u).call(u,(p,S)=>p.index-S.index).map(p=>p.payload).join("");r.delete(d),(e=JSON.parse(h))._uid=i}}let{_type:a,token:c}=e;if(B(n=[Oe.ACK,Oe.CHECK]).call(n,a))return a===Oe.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){let e={_id:qt(6,""),token:this.token,_type:Oe.CHECK};T("SHOW_P2P_LOG")&&_.debug("send message",e),this.signal.request(it.DATA_STREAM,{payload:Yo(this.encoder.encode(JSON.stringify(e)))})}ack(e){let n={_id:e,_type:Oe.ACK,token:this.token};T("SHOW_P2P_LOG")&&_.debug("send message",n),this.signal.request(it.DATA_STREAM,{payload:Yo(this.encoder.encode(JSON.stringify(n)))})}response(e,n,i){this.send(Oe.RESPONSE,JSON.stringify({success:!i,message:n}),!0,e)}handleReceivedMessage(e){let n=()=>{this.userMap.forEach(d=>{let{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){let h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++}})};if(!e)return void n();let{_uid:i,_seq:r}=e,o=this.userMap.get(i),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(e._id),void _.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));s.set(r,e),a&&r===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,n())}receiveMessage(e){let{_id:n,_type:i,_message:r,_uid:o}=e;if(T("SHOW_P2P_LOG")&&_.debug("receive message",e),n){let s;switch(e._type!==Oe.ACK&&(r&&(s=JSON.parse(r)),this.ack(e._id)),e._type){case Oe.CANDIDATE:case Oe.CONTROL:this.signal.emit(i,s,o);break;case Oe.PUBLISH:case Oe.UNPUBLISH:case Oe.RESTART_ICE:case Oe.CALL:s.uid=o,Ue(this.signal,i,s).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case Oe.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case Oe.RESPONSE:{let{success:a,message:c}=s;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<ca.MAX_MESSAGE_SIZE)return[e];let n=[],{remoteToken:i}=JSON.parse(e),r=qt(6,""),o=0,s=800,a=Math.ceil(e.length/s);for(;e.length>0;){o++;let c={id:r,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>ca.MAX_MESSAGE_SIZE?s-=50:(n.push(c),e=e.slice(s))}return n.map(c=>JSON.stringify(c))}handleCheckToken(e,n){return e.token!==n?(_.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{_.debug("token timeout, ".concat(n)),this.reset(e.uid)},T("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let e=await Ue(this.signal,Oe.CALL,void 0),n=await this.send(Oe.CALL,e);this.signal.emit(nt.P2P_CONNECTION,n,!0)}async reset(e,n){let i=this.userMap.get(e);i&&(this.emit(fc.ABORT),this.signal.emit(pt.ON_USER_OFFLINE,{uid:i.uid,reason:SH.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(_.debug("change local token from ".concat(n," to ").concat(n)),this.token=qt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(fc.ABORT)}}g(ca,"MAX_SIZE",1),g(ca,"MAX_MESSAGE_SIZE",1024);class r8 extends ge{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Pt.CONNECTED?this.emit(nt.WS_CONNECTED):e===Pt.RECONNECTING?this.emit(nt.WS_RECONNECTING,this._websocketReconnectReason):e===Pt.CLOSED&&this.emit(nt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),g(this,"__name__","P2PSignal"),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",Pt.CLOSED),g(this,"reconnectToken",void 0),g(this,"p2pToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new If(5)),g(this,"pingpongTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"_external_signal",void 0),g(this,"onWebsocketMessage",i=>{if(i.data instanceof ArrayBuffer)return void this.emit(nt.ON_BINARY_DATA,i.data);let r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case pt.ON_DATA_STREAM:return void this.handleDataStream(r._message);case pt.MUTE_AUDIO:case pt.MUTE_VIDEO:case pt.ON_P2P_LOST:case pt.ON_USER_ONLINE:return;case pt.ON_USER_OFFLINE:let{uid:o}=r._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===pt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===pt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Dt.UID_BANNED);break;case 15:this.close(Dt.IP_BANNED);break;case 16:this.close(Dt.CHANNEL_BANNED)}if(r._type===pt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case st.ERR_LICENSE_MISSING:this.close(Dt.LICENSE_MISSING);break;case st.ERR_LICENSE_EXPIRED:this.close(Dt.LICENSE_EXPIRED);break;case st.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Dt.LICENSE_MINUTES_EXCEEDED);break;case st.ERR_LICENSE_PERIOD_INVALID:this.close(Dt.LICENSE_PERIOD_INVALID);break;case st.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Dt.LICENSE_MULTIPLE_SDK_SERVICE);break;case st.ERR_LICENSE_ILLEGAL:this.close(Dt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new Sg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Pt.CONNECTED&&this.reconnect("retry",pn.OFFLINE)}),this.p2pToken=qt(6,""),this._external_signal=new ca(this,this.p2pToken)}async request(e,n,i,r){let o=qt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new Y((S,E)=>{if(this.connectionState===Pt.CONNECTED)return S();let f=()=>{this.off(nt.WS_CLOSED,R),S()},R=()=>{this.off(nt.WS_CONNECTED,f),E(new L(C.WS_ABORT))};this.once(nt.WS_CONNECTED,f),this.once(nt.WS_CLOSED,R)});if(this.connectionState!==Pt.CONNECTING&&this.connectionState!==Pt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;let d=new Y((S,E)=>{let f=!1,R=(I,w)=>{f=!0,S({isSuccess:I==="success",message:w||{}}),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.emit(nt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),R);let v=()=>{E(new L(C.WS_ABORT,"type: ".concat(e))),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.off("res-@".concat(o),R)};this.once(nt.WS_CLOSED,v),this.once(nt.WS_RECONNECTING,v),Ye(T("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(nt.REQUEST_TIMEOUT,e,n))})}),l=null;try{l=await d}catch(S){if(this.connectionState===Pt.CLOSED||e===it.LEAVE)throw new L(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?S.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=Xs(u),p=new L(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===st.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===st.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",pn.MULTI_IP)):this.reconnect(h.action,pn.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Y(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(zs.WRTC_STATS,n)}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{let o=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Pt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},T("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){let i={_type:e,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(e,n,i){return await this._external_signal.send(e,n,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Y((n,i)=>{this.once(nt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(nt.WS_CLOSED,()=>i(this.initError||new L(C.WS_ABORT))),this.connectionState=Pt.CONNECTING,this.websocket.init(e).catch(i)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Dt.LEAVE,this.connectionState=Pt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=qt(6,""),this._external_signal.clear(),this._external_signal=new ca(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(nt.ABORT_P2P_EXECUTION);let e=await Ue(this,nt.REQUEST_JOIN_INFO),n=await this.request(it.JOIN,e);if(!n)return this.emit(nt.REPORT_JOIN_GATEWAY,C.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(nt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Pt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){return!1}handleDataStream(e){try{var n;let i=Us(e.payload),r=new TextDecoder().decode(i),o=JSON.parse(r);"total"in o&&"id"in o||B(n=Object.values(Oe)).call(n,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(pt.ON_DATA_STREAM,e)}catch{this.emit(pt.ON_DATA_STREAM,e)}}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=Xs(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?e.code===st.ERR_REPEAT_JOIN_CHANNEL&&T("IGNORE_UID_CHECK")?void this.close(Dt.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Dt.UID_BANNED),void this.close()):void this.reconnect(n.action,pn.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=T("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",pn.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),T("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWebsocketEvents(){this.websocket.on(Tt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(nt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Tt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Tt.CLOSED,()=>{this.connectionState=Pt.CLOSED}),this.websocket.on(Tt.FAILED,()=>{this._disconnectedReason=Dt.NETWORK_ERROR,this.connectionState=Pt.CLOSED}),this.websocket.on(Tt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Pt.CONNECTED?this.connectionState=Pt.RECONNECTING:this.connectionState=Pt.CONNECTING}),this.websocket.on(Tt.WILL_RECONNECT,(e,n,i)=>{e!=="retry"?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)}),this.websocket.on(Tt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(nt.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof L&&e.code===C.UNEXPECTED_RESPONSE&&e.data.code===st.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",pn.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",pn.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Tt.REQUEST_NEW_URLS,(e,n)=>{Ue(this,nt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let o8={name:"P2PChannel",create:function(t){let{store:e,statsCollector:n}=t;return new i8(e,n)},createSubmodule:function(t){let{store:e,spec:n}=t;return new r8(n,e)}};function dL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function lL(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?dL(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):dL(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}class s8{constructor(e){g(this,"sessionDesc",void 0),g(this,"localCapabilities",void 0),g(this,"rtpCapabilities",void 0),g(this,"candidates",void 0),g(this,"_originCandidates",void 0),g(this,"iceParameters",void 0),g(this,"dtlsParameters",void 0),g(this,"setup",void 0),g(this,"currentMidIndex",void 0),g(this,"cname",void 0),e=he(e);let{iceParameters:n,dtlsParameters:i,candidates:r,rtpCapabilities:o,setup:s,localCapabilities:a,sdkCodec:c,cname:d}=e,l=Mn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=r,this._originCandidates=he(r),this.iceParameters=n,this.dtlsParameters=i,this.setup=s,this.localCapabilities=a,this.cname=d;for(let u=0;u<l.mediaDescriptions.length;u++){let h=l.mediaDescriptions[u];if(h.attributes.iceUfrag=n.iceUfrag,h.attributes.icePwd=n.icePwd,h.attributes.fingerprints=i.fingerprints,h.attributes.candidates=r,h.attributes.setup=s,h.media.mediaType==="video"){h.media.fmts=o.videoCodecs.map(E=>E.payloadType.toString(10));let p=o.videoCodecs.filter(E=>{var f,R;return(f=E.rtpMap)===null||f===void 0?void 0:B(R=f.encodingName.toLowerCase()).call(R,c)}),S=o.videoCodecs.filter(E=>!B(p).call(p,E));h.attributes.payloads=[...p,...S],h.attributes.extmaps=o.videoExtensions}h.media.mediaType==="audio"&&(h.media.fmts=o.audioCodecs.map(p=>p.payloadType.toString(10)),h.attributes.payloads=o.audioCodecs,h.attributes.extmaps=o.audioExtensions),l.mediaDescriptions[u]=this.mungMediaDesc(h)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return To(this.sessionDesc)}send(e,n,i){let{ssrcs:r,ssrcGroups:o}=qd(n,this.cname),s=this.sessionDesc.mediaDescriptions.find(d=>e===Z.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),a=r[0].attributes.label,c=r[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(r),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(o),{id:a,mslabel:c}}batchSend(e){return e.map(n=>{let{kind:i,ssrcMsg:r}=n;return this.send(i,r,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(n=>{let i=[],r=[],o=[];n.attributes.ssrcs.forEach(s=>{B(e).call(e,s.attributes.label||"")?o.push(s):i.push(s)}),n.attributes.ssrcGroups.forEach(s=>{var a;B(a=o.map(c=>c.ssrcId)).call(a,s.ssrcIds[0])||r.push(s)}),n.attributes.ssrcs=i,n.attributes.ssrcGroups=r})}mute(e){let n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){let n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(e,n,i){e.forEach((r,o)=>{let s=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===s.kind),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c})}stopReceiving(e){}updateCandidates(e){let n=this._originCandidates.filter(r=>r.transport==="udp"),i=[];if(n.forEach(r=>{i.push(lL(lL({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),n.length!==0){switch(e){case en.TCP_RELAY:this.candidates=i;break;case en.UDP_TCP_RELAY:case en.RELAY:this.candidates=[...n,...i];break;default:this.candidates=n}for(let r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=he(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd})}predictReceivingMids(e){let n=[];for(let i=0;i<e;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}mungRecvMediaDsec(e,n){let i=he(e);return Js(i,n),Ig(i,n),i}updateRecvMedia(e,n){let i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){let r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,n,i){let r=this.sessionDesc.mediaDescriptions.find(s=>e===Z.VIDEO?s.attributes.mid==="video":s.attributes.mid==="audio");if(r){let s=r.attributes.ssrcs.find(a=>a.attributes.label===n);var o;s&&(s.attributes.label=i,(o=s.attributes.msid)===null||o===void 0||o.replace(n,i))}}mungMediaDesc(e){let n=he(e);return yg(n),function(i){let r=i.attributes.extmaps.find(o=>Hh(o.extensionName));r&&i.attributes.extmaps.splice(i.attributes.extmaps.indexOf(r),1),i.attributes.payloads.forEach(o=>{let s=o.rtcpFeedbacks.findIndex(a=>a.type==="transport-cc");s!==-1&&o.rtcpFeedbacks.splice(s,1)})}(n),n}getSSRC(e){for(let n of this.sessionDesc.mediaDescriptions)for(let i of n.attributes.ssrcs)if(i.attributes.label===e)return[i]}}var ae;function uL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Ip(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?uL(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):uL(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let a8=(ae=class vl extends Fh{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return B(n=Object.keys(Fs)).call(n,e)}))]}constructor(e,n){super(e,n),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"statsFilter",void 0),g(this,"useRTX",!1),g(this,"localCapabilities",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"establishPromise",void 0),g(this,"mutex",void 0),this.store=n,this.mutex=new tn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(vl.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=ph(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,ue()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let n=Zr(e.sdp),i=Yd(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,Ip(Ip({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new s8(Ip(Ip({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));let n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new L(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,n){var i=this;return jn(function*(){let r=yield yt(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let o=e.map(h=>i.peerConnection.addTrack(h._mediaStreamTrack)),s=yield yt(i.peerConnection.createOffer()),a=Mn(s.sdp),c=e.map(h=>{let p=h._mediaStreamTrack,S=a.mediaDescriptions.find(E=>E.attributes.mid===p.kind);if(!S)throw new Error("Cannot extract ssrc from mediaDescription.");return function(E,f,R){let v=E.attributes.ssrcs.filter(w=>w.attributes.label===f),I=E.attributes.ssrcGroups;if(v.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(I&&v.length>1){let w=I.find(O=>O.ssrcIds.indexOf(v[0].ssrcId)!==-1);return w?[{ssrcId:w.ssrcIds[0],rtx:R?w.ssrcIds[1]:void 0}]:[{ssrcId:v[0].ssrcId}]}return[{ssrcId:v[0].ssrcId}]}(S,p.id,i.useRTX)}),d;try{d=yield c}catch(h){throw o.forEach(p=>{$e()&&p.replaceTrack(null),i.peerConnection.removeTrack(p)}),h}let l=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,n,d);let u=i.remoteSDP.toString();return yield yt(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(i.applySendEncodings(o,e)),yield yt(i.peerConnection.setRemoteDescription({type:"answer",sdp:u})),e.map((h,p)=>{let S=h._mediaStreamTrack.id;return{localSSRC:c[p],id:S}})}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{$e()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{id:o,mslabel:s}=this.remoteSDP.send(e,n,r),a=new Y((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(o)))},1e4),p=S=>{let E=Vt();if((E.name==="Safari"&&Number(E.version)===11||An())&&S.track.id!==o&&S.streams[0].id===s){var f;let R=S.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(e,o,S.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(R)}if(S.track.id===o)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(S.track)};this.peerConnection.addEventListener("track",p)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let n=this.peerConnection.getSenders().filter(i=>{var r;return e.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map(i=>{if($e()&&i.track)i.track.enabled=!1;else{let r=i.getParameters();r.encodings.forEach(o=>o.active=!1),i.setParameters(r)}})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let n=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if($e()&&o.track)o.track.enabled=!0;else{let s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s)}});let i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);let r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return jn(function*(){let i=yield yt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=wt().supportPCSetConfiguration;if(e===en.RELAY&&!r)return;if(r){let d=n.peerConnection.getConfiguration(),l=e===en.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d))}e!==en.RELAY&&n.remoteSDP.updateCandidates(e);let o=yield yt(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let s=Zr(o.sdp),{remoteIceParameters:a}=yield s.iceParameters;n.remoteSDP.restartICE(a);let c=n.remoteSDP.toString();yield yt(n.peerConnection.setLocalDescription(o)),yield yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);let o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===e});i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){let i=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===n});i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,n){throw new L(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new L(C.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ps(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...vl.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...vl.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id})),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!wt().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");let r={},o={};if(e instanceof oe)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(T("DSCP_TYPE")&&Kr()){var s;let d=T("DSCP_TYPE");B(s=["very-low","low","medium","high"]).call(s,d)&&(o.networkPriority=d)}let a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,o),Object.assign(a,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a)}async applySendEncodings(e,n){try{if(!wt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];r&&o&&await this.updateRtpSenderEncodings(o,r)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n){let i=Mn(e);return n.forEach((r,o)=>{let s=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&Js(a,r)}),To(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let n=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o,{kind:d}=e[s];return new Y((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)))},1e4),p=S=>{let E=Vt();if(E.name==="Safari"&&Number(E.version)===11&&S.track.id!==a&&S.streams[0].id===c){var f;let R=S.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(d,a,S.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:R,id:a})}if(S.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:S.track,id:a})};this.peerConnection.addEventListener("track",p)})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await Y.all(n)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n?.[0].ssrcId}setConfiguration(e){if(wt().supportPCSetConfiguration){let n=vl.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},q(ae.prototype,"connect",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"connect"),ae.prototype),q(ae.prototype,"stopSending",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"stopSending"),ae.prototype),q(ae.prototype,"receive",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"receive"),ae.prototype),q(ae.prototype,"stopReceiving",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"stopReceiving"),ae.prototype),q(ae.prototype,"muteRemote",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"muteRemote"),ae.prototype),q(ae.prototype,"unmuteRemote",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"unmuteRemote"),ae.prototype),q(ae.prototype,"muteLocal",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"muteLocal"),ae.prototype),q(ae.prototype,"unmuteLocal",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"unmuteLocal"),ae.prototype),q(ae.prototype,"close",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"close"),ae.prototype),q(ae.prototype,"updateEncoderConfig",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"updateEncoderConfig"),ae.prototype),q(ae.prototype,"updateSendParameters",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"updateSendParameters"),ae.prototype),q(ae.prototype,"replaceTrack",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"replaceTrack"),ae.prototype),q(ae.prototype,"getRemoteSSRC",[Gi],Object.getOwnPropertyDescriptor(ae.prototype,"getRemoteSSRC"),ae.prototype),ae);function Gi(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}let c8={name:"PlanBConnection",create:function(t){let{store:e,spec:n}=t;return new a8(n,e)}},d8={interceptLocalAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!wt().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Ah.has(t)||!t.track)return;let n={track:t.track};if(go()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(s){return void _.error("create audio-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));let c=e.metadata&&e.metadata();c?function(d,l){let{chunk:u,controller:h}=l,p=qo.METADATA;u.data=function(S,E,f){let R=f.byteLength,v=R+ng+oO,I=tg+eg+v,w=new ArrayBuffer(S.byteLength+I),O=new DataView(w);O.setUint8(0,rO),O.setUint16(1,v),O.setUint8(3,E),O.setUint16(4,R);for(let N=0;N<R;N++)O.setUint8(6+N,f[N]);let A=new Uint8Array(O.buffer);return A.set(new Uint8Array(S),I),A.buffer}(u.data,p,d),h.enqueue(u)}(c,{sender:t,chunk:s,controller:a}):a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if($e()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Ih(),o=new MessageChannel;await new Y(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:o.port2},[o.port2]);t.transform=s,await new Y(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;if(a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id)_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i);else if(a.data.getMetadata){let d=e.metadata&&e.metadata();d&&o.port1.postMessage({metadata:d})}},n.worker=r}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}let r=Ah.get(t);if(r){Ah.delete(t);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){_.warning(a&&a.message)}}}Ah.set(t,n),t.track.addEventListener("ended",i)},interceptRemoteAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!wt().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Ph.has(t))return;let n={track:t.track,onMetadata:e.onMetadata,onPts:e.onPts};if(go()&&!An()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");uf(jt.CHROME,87,116)||(e.enableTopn=!1);let r=null;try{r=t.createEncodedStreams()}catch(s){return void _.error("create audio-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)),e.enableTopn?function(c,d,l){var u;let h=ig(new DataView(d.data));if(!h)return l.enqueue(d);let p=c.track.id;B4.set(p,c.track);let S=(u=h.tlv.find(w=>w.tag===qo.AUDIO_LEVEL))===null||u===void 0?void 0:u.value,E=0;typeof S=="number"&&(E=127-S);let f=Math.round(Math.pow(10,E/60)-1),{selected:R,speaker:v}=function(w,O){let A=pc.get(w);if(A||(A=function(N){let k=new aO;return pc.set(N,k),vr||(vr=new V4(T("TOPN_SILENCE_THRESHOLD")||500),vr.on("ActiveSpeakerChanged",V=>{V!=null&&(Oh=V)})),vr.addSpeakers([k]),k}(w)),pc.size<=cO)return{selected:!0,speaker:A};if(!vr)throw new Error("no active speaker detector");return vr.levelChanged(A.id,O),Ks=vr.loudest.map(N=>N.id),Oh&&!B(Ks).call(Ks,Oh)&&Ks.length>=cO&&Ks.pop(),{selected:B(Ks).call(Ks,A.id)||A.id===Oh,speaker:A}}(c,f),I=function(w,O,A){let N=yr.get(w)||new F4(w,O);return N.score=A,yr.set(w,N),function(k){if(Nh.set(k,!0),!Dh)return void(Dh=Date.now());let V=Date.now();V-Dh>1e3&&(Nh.get(k)?Nh.set(k,!1):(dO(k),Nh.delete(k)),Dh=V)}(w),N}(p,c.track,v.energyScore);I.addSample(R),I.active&&(d.data=h.frame.buffer,l.enqueue(d))}(t,s,a):e.enableMetadata||e.enablePts?function(c,d,l,u){let h=new DataView(c.data),p=h.getUint8(0),S;if(128&p&&p!==71){let R=function(v){if(v.byteLength<=0)return[];let I=[],w=0;for(;w<v.byteLength;){let A=(128&v.getUint8(w))>>7,N=127&v.getUint8(w);if(!(A&&w+4<=v.byteLength)){w++;break}{let k=v.getUint32(w,!1),V=(16776192&k)>>10,J=1023&k;I.push({pt:N,ts_offset:V,length:J,data:new Uint8Array}),w+=4}}let O=v.byteLength-w;for(let A of I){if(A.length>O)return console.warn("Broken red payload"),[];A.length>0&&(A.data=new Uint8Array(v.buffer,v.byteOffset+w,A.length),w+=A.length,O-=A.length)}if(O>0){let A={pt:I.length>0?I[I.length-1].pt:0,ts_offset:0,length:O,data:new Uint8Array(v.buffer,v.byteOffset+w,O)};I.push(A)}return I}(h);if(R.length>0){let v=function(I){let w=0;for(let N=0;N<I.length;N++)w+=N<I.length-1?4:1,w+=I[N].length;let O=new Uint8Array(w),A=0;for(let N=0;N<I.length;N++)if(N<I.length-1){let k=(2147483648|(127&I[N].pt)<<24|(262143&I[N].ts_offset)<<10|1023&I[N].length)>>>0;O[A++]=k>>24&255,O[A++]=k>>16&255,O[A++]=k>>8&255,O[A++]=255&k}else O[A++]=127&I[N].pt;for(let N of I)O.set(N.data,A),A+=N.length;return O}(R.map(I=>{let w=new Uint8Array(I.length);w.set(I.data);let O=ig(new DataView(w.buffer));return O!=null&&O.frame&&(I.data=O?.frame),S=O,I}));c.data=v.buffer}}else S=ig(h),S&&(c.data=S.frame.buffer);if(d.enqueue(c),!S)return;let E=S.tlv.find(R=>R.tag===qo.METADATA);E&&l&&E.value instanceof Uint8Array&&l(E.value);let f=S.tlv.find(R=>R.tag===qo.AUDIO_64_BIT_PTS);f&&u&&f.value instanceof Uint8Array&&f.value.length==8&&u(new DataView(f.value.buffer).getBigUint64(0,!0))}(s,a,e.onMetadata,e.onPts):a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Ih(),o=new MessageChannel;await new Y(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:o.port2},[o.port2]);t.transform=s,await new Y(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id?(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)):a.data.metadata&&n.onMetadata?n.onMetadata(a.data.metadata):a.data.pts&&n.onPts&&n.onPts(a.data.pts)},n.worker=r}function i(){t.track.removeEventListener("ended",i),function(r){let o=Ph.get(r);if(o){(function(c){let d=pc.get(c);d&&(pc.delete(c),vr&&(vr.removeSpeakers([d]),pc.size===0&&(vr.destroy(),vr=null)))})(r),dO(r.track.id),Ph.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}}(t)}Ph.set(t,n),t.track.addEventListener("ended",i)},interceptLocalVideoFrame:async function(t,e){if(!wt().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(Lh.has(t)||!t.track)return;let n={track:t.track};if(go()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a)});let s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));let d=hO(new Uint8Array(a.data)),l=o.shift();if(l){let u=function(h,p,S){switch(S){case ag:return function(E,f){let R=uO(f),v=R.length,I=Math.floor(v/255),w=v%255,O=new Uint8Array(6+I+1+v+E.byteLength);O[0]=0,O[1]=0,O[2]=0,O[3]=1,O[4]=6,O[5]=101;let A=0;for(;A<I;)O[6+A]=255,A++;return O[6+A]=w,A++,O.set(R,6+A),O.set(new Uint8Array(E),6+A+v),O.buffer}(h,p);case cg:return function(E,f){let R=uO(f),v=R.length,I=Math.floor(v/255),w=v%255,O=new Uint8Array(7+I+1+v+1+E.byteLength);O[0]=0,O[1]=0,O[2]=0,O[3]=1,O[4]=78,O[5]=1,O[6]=101;let A=0;for(;A<I;)O[7+A]=255,A++;return O[7+A]=w,A++,O.set(R,7+A),A+=v,O[7+A]=128,A++,O.set(new Uint8Array(E),7+A),O.buffer}(h,p);default:return null}}(a.data,l,d);u&&(a.data=u)}c.enqueue(a)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!$e())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Ih(),o=new MessageChannel;await new Y(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"sei-tx",port:o.port2},[o.port2]);t.transform=s,await new Y(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}let r=Lh.get(t);if(r){Lh.delete(t);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){_.warning(a&&a.message)}}}Lh.set(t,n),t.track.addEventListener("ended",i)},interceptRemoteVideoFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!wt().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!t.track)return;if(Gd.has(t)){let r=Gd.get(t);return void(r&&(r.onSei=e.onSei))}let n={track:t.track,onSei:e.onSei};if(go()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(s){return void _.error("create video-encoded-streams error",s&&s.message)}let o=new TransformStream({transform(s,a){if(n.controller||(n.controller=a),!n.firstFrameInfo){var c;let l=s.getMetadata()||{};n.firstFrameInfo=le({type:s.type,rtpTimestamp:s.timestamp,payloadType:l.payloadType||0,ssrc:l.synchronizationSource||0,length:s.data.byteLength},"mimeType"in l?{mimeType:l.mimeType}:{}),(c=e.onFirstFrame)===null||c===void 0||c.call(e,n.firstFrameInfo)}t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));let d=function(l,u){switch(u){case ag:return function(h){let p=new DataView(h.data),S=0;for(;S+4<h.data.byteLength;){if(p.getUint8(S+0)===0&&p.getUint8(S+1)===0&&p.getUint8(S+2)===0&&p.getUint8(S+3)===1&&p.getUint8(S+4)===6){let E=S+6,f=0,R=0;for(;(R=p.getUint8(E++))===255;)f+=255;f+=R;let v=lO(h.data,E,f);return new Uint8Array(v)}S++}return null}(l);case cg:return function(h){let p=new DataView(h.data),S=0;for(;S+5<h.data.byteLength;){if(p.getUint8(S+0)===0&&p.getUint8(S+1)===0&&p.getUint8(S+2)===0&&p.getUint8(S+3)===1&&p.getUint8(S+4)===78&&p.getUint8(S+5)===1&&p.getUint8(S+6)===101){let E=S+7,f=0,R=0;for(;(R=p.getUint8(E++))===255;)f+=255;f+=R;let v=lO(h.data,E,f);return new Uint8Array(v)}S++}return null}(l);default:return null}}(s,hO(new Uint8Array(s.data)));d&&n.onSei&&n.onSei(d),a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if($e()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Ih(),o=new MessageChannel;await new Y(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"sei-rx",port:o.port2},[o.port2]);t.transform=s,await new Y(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;if(a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id)_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i);else if(a.data.sei&&n.onSei)n.onSei(a.data.sei);else if(a.data.firstFrameInfo&&e.onFirstFrame){var d;(d=e.onFirstFrame)===null||d===void 0||d.call(e,a.data.firstFrameInfo)}},n.worker=r}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}(function(r){let o=Gd.get(r);if(o){Gd.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}})(t)}Gd.set(t,n),t.track.addEventListener("ended",i)}},l8={name:"InterceptFrame",create:()=>d8};var Mt;function hL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}function Lr(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?hL(Object(n),!0).forEach(function(i){g(t,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):hL(Object(n)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))})}return t}let u8=(Mt=class Bc extends Fh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return B(n=Object.keys(Fs)).call(n,e)}))]}constructor(e,n,i){super(e,n),g(this,"id",qt(5,"connection-")),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"forceTurn",!1),g(this,"remoteSDP",void 0),g(this,"initialOffer",void 0),g(this,"transportEventReceiver",void 0),g(this,"statsFilter",void 0),g(this,"extension",{useXR:T("USE_XR")}),g(this,"localCapabilities",void 0),g(this,"remoteCodecs",void 0),g(this,"localCandidateCount",0),g(this,"allCandidatesReceived",!1),g(this,"isPreallocation",!1),g(this,"preMediaMap",new Map),g(this,"dataStreamChannelMap",new Map),g(this,"establishPromise",void 0),g(this,"recoveredDataChannelIds",[]),g(this,"currentDataChannelId",1),g(this,"supportAV1RtpSpec",!1),g(this,"mutex",void 0),g(this,"qualityLimitationReason",ec.NONE),g(this,"isFirstConnected",!1),this.store=n,this.forceTurn=Kg(e),this.mutex=new tn("NVConnectionExtension-mutex",n.clientId),this.peerConnection=i,this.isFirstConnected=!1,this.statsFilter=ph(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,ue()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else _.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=Zr(n.sdp),r=await bg({filterRTX:!T("USE_PUB_RTX")&&!T("USE_SUB_RTX"),filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC"),filterVideoCodec:T("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:T("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:T("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=zd(r),this.initialOffer=n,T("ENABLE_SVC")&&this.store.codec=="av1"){let s=await BO();var e;s&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(s))}let o;return n.sdp&&Yh(n.sdp)&&(o=he(r),PO(o)),Lr(Lr({},i),{},{rtpCapabilities:o||r,offerSDP:n.sdp})}catch(n){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&Yh(this.initialOffer.sdp)&&LO(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new uN(Lr(Lr({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!T("ENABLE_PRE_SUB_WITH_PRE_PC")||!T("PRE_USE_LOCAL_CODECS"))&&Fd(this.store),!0),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let n=this.remoteSDP.toString(),i=wg(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});let o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),Fd(this.store))if(e.preallocation&&T("ENABLE_PRE_SUB_WITH_PRE_PC")){let s=T("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(s);await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{let{preSSRCs:s=[]}=e,a=s.map(d=>d.ssrcMsg[0].ssrcId);if(s.length===0)return;let{mids:c}=this.remoteSDP.batchSend(s.map(d=>Object.assign({},d)));await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(n.toString()))}}presetMedia(e,n){e.forEach((i,r)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&i===o.mid&&o.receiver.track){let s=o.receiver.track,a;s.kind==="video"&&T("ENABLE_PRE_RENDER")&&(a=new vh({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(qt(5,""))},!0),a.updateVideoTrack(s),a.onFirstVideoFrameRender=()=>{var c;let d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0)),this.preMediaMap.set(n[r],{mid:i,track:s,player:a,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let n=!1,{rtpCapabilities:i}=e;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){let s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||s}let{preSSRCs:r=[]}=e,o=r.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){let s=[],a=[];if(Array.from(this.preMediaMap.entries()).every(c=>{let[d,{mid:l,player:u,track:h}]=c;return s.push(l),a.push(d),this.preMediaMap.delete(d),u&&u.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await ti(this.peerConnection,this.remoteSDP,this.extension),_.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),tt.reportApiInvoke(this.store.sessionId,{name:me.PRELOAD_MEDIA_FAILED,options:[r,a],tag:re.TRACER}).onSuccess()),r.length>0){let{mids:c}=this.remoteSDP.batchSend(r.map(d=>Object.assign({},d)));await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(c,o)}}n?(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):_.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return jn(function*(){let o=yield yt(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");let s=[],a=Kd();e.forEach(f=>{let R=r.peerConnection.addTransceiver(f._mediaStreamTrack,Lr({direction:"sendonly"},f.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));s.push(R),f._updateRtpTransceiver(R)}),ue()&&T("SIMULCAST")===!0&&(yield yt(r.applySimulcastForFirefox(s,e)));let c=yield yt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),u=Mn(l),h=d.map(f=>{let R=u.mediaDescriptions.find(v=>v.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return vg(R,T("USE_PUB_RTX"))}),p;try{p=yield h}catch(f){p=[],r.remoteSDP.receive(e,n,i,p);let R=r.remoteSDP.toString();throw yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield yt(r.stopSending(d,!0)),f}r.remoteSDP.receive(e,n,i,p);let S=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return yield yt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield yt(r.applySimulcastEncodings(s,e)),yield yt(r.applySendEncodings(s,e)),E?.(S),yield yt(r.peerConnection.setRemoteDescription({type:"answer",sdp:S})),s.map((f,R)=>{let v=d[R];return{localSSRC:h[R],id:v,transceiver:f}})}catch(s){throw s instanceof L?s:new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")_.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:T("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}n.forEach(o=>{o._updateOriginDataChannel(i)});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),_.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else _.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof L?i:new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{let n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof L?n:new L(C.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){let i=n?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map(c=>{var d;yc(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,n,i,r);s&&(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(e," by exchanging SDP.")));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(o.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");let{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await ti(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[a,{mid:c,player:d}]=s;if(c===o)return this.preMediaMap.delete(a),d&&d.destroy(),!0})}),this.remoteSDP.stopSending(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");let n=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});let i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);let o=this.remoteSDP.toString();r?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return jn(function*(){let i=yield yt(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=wt().supportPCSetConfiguration,o=T("FORCE_TURN_TCP")||n.forceTurn;if(e===en.RELAY&&!r)return;if(r&&!o){let u=e===en.RELAY?"relay":"all",h=n.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,n.peerConnection.setConfiguration(h))}n.remoteSDP.updateCandidates(e);let s=yield yt(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Zr(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);let d=n.remoteSDP.toString(),l=n.logSDPExchange(s.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield yt(n.peerConnection.setLocalDescription(s)),l?.(d),yield yt(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;let e=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(en.TCP_RELAY),await ti(this.peerConnection,this.remoteSDP,this.extension)}catch(n){_.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{yc(this.id+n.mid,this)}),this.preMediaMap.forEach(n=>{let{player:i}=n;i&&i.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Lr(Lr({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");let i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){let i=this.peerConnection.getTransceivers().filter(r=>r.mid===e);i.length===1&&(this.isVP8Simulcast(n)?ue()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){let i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Lr(Lr({},er),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Lr(Lr({},er),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var n;let i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",o=Qr(e.url||"");_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(o||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let n={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&(Ps(e.turnServer.servers)?n.iceServers=e.turnServer.servers:T("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(T("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&n.iceServers.push(...Bc.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):n.iceServers.push(...Bc.newTurnServerConfigToIceServers(e.turnServer.servers)),T("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Bc.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Bc.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),T("ENABLE_ENCODED_TRANSFORM")&&wt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!T("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}static newTurnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{let r=T("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":443?transport=tcp")}))}),n}tryBindTransportEvents(e){let n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};let i=n.iceTransport;i&&(i.onstatechange=()=>{let r=n?.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:o}=i.getSelectedCandidatePair()||{};if(r&&o){let s=r.address+":"+r.port,a=o.address+":"+o.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Qr(s)),", remote ").concat(JSON.stringify(Qr(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find(f=>f.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!wt().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let a=NO(this.peerConnection,e._mediaStreamTrack),c=S0(e);if(fN(e)&&a&&n&&c&&this.getLocalVideoStats&&B(i=["vp8","vp9"]).call(i,this.store.codec)){var d;let E=o.degradationPreference||(B(d=e._hints).call(d,Kt.CUSTOM_TRACK)?T("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");gN(this.id+a.mid,c,this,E,f=>{n&&this.updateAdaptation(n,f)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;let{bitrateMax:E,frameRate:f,scaleResolutionDownBy:R}=e._encoderConfig;E&&(s.maxBitrate=1e3*E),(B(l=e._hints).call(l,Kt.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(f&&(s.maxFramerate=Yn(f)),R&&R>=1&&(s.scaleResolutionDownBy=R))}let{maxFramerate:u}=T("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,u):u),T("DSCP_TYPE")&&Kr()){var h;let E=T("DSCP_TYPE");B(h=["very-low","low","medium","high"]).call(h,E)&&(s.networkPriority=E)}let p=n.getParameters(),S=(r=p.encodings)===null||r===void 0?void 0:r[0];ue()&&!S&&(o.encodings=[s]),S&&Object.assign(S,s),Object.assign(p,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await n.setParameters(p),await WO(this.store.codec,n,T("SVC_MODE"))}async updateAdaptation(e,n){var i,r;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!wt().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=n;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Yn(a)),c&&c>=1&&B(i=["vp8","vp9"]).call(i,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{await e.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!wt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){let r=e[i],o=n[i];o instanceof oe&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){let r=Mn(e);return n.forEach((o,s)=>{let a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Js(c,o),Ag(c,o,this.store.codec))}),To(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,o,s,a;let d=e[c],l=n[c];if(l instanceof oe&&!B(i=l._hints).call(i,Kt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(e,n){if(!ue()&&e.length===n.length)for(let i=0;i<e.length;i++){let r=n[i];if(r instanceof oe&&this.isVP8Simulcast(r)){let o=e[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(e){var n,i,r,o,s;return!!(e instanceof oe&&T("SIMULCAST")&&this.store.codec==="vp8"&&!B(n=e._hints).call(n,Kt.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(T("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during NVConnectionExtension.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;let n=this.remoteSDP.getSSRC(e);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(e){if(wt().supportPCSetConfiguration){let n=Bc.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}e.isPreallocation&&(this.isPreallocation=!0)}},q(Mt.prototype,"updateRemoteRTPCapabilities",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"updateRemoteRTPCapabilities"),Mt.prototype),q(Mt.prototype,"connect",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"connect"),Mt.prototype),q(Mt.prototype,"updateRemoteConnect",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"updateRemoteConnect"),Mt.prototype),q(Mt.prototype,"createDataChannels",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"createDataChannels"),Mt.prototype),q(Mt.prototype,"receive",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"receive"),Mt.prototype),q(Mt.prototype,"batchReceive",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"batchReceive"),Mt.prototype),q(Mt.prototype,"stopReceiving",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"stopReceiving"),Mt.prototype),q(Mt.prototype,"muteRemote",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"muteRemote"),Mt.prototype),q(Mt.prototype,"unmuteRemote",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"unmuteRemote"),Mt.prototype),q(Mt.prototype,"muteLocal",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"muteLocal"),Mt.prototype),q(Mt.prototype,"unmuteLocal",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"unmuteLocal"),Mt.prototype),q(Mt.prototype,"close",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"close"),Mt.prototype),q(Mt.prototype,"updateEncoderConfig",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"updateEncoderConfig"),Mt.prototype),q(Mt.prototype,"updateSendParameters",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"updateSendParameters"),Mt.prototype),q(Mt.prototype,"replaceTrack",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"replaceTrack"),Mt.prototype),q(Mt.prototype,"updateAdaptation",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"updateAdaptation"),Mt.prototype),q(Mt.prototype,"getRemoteSSRC",[Xn],Object.getOwnPropertyDescriptor(Mt.prototype,"getRemoteSSRC"),Mt.prototype),Mt);function Xn(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From NVConnectionExtension.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}var Zt;function pL(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Ju,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new Ap(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Ap(t){function e(n){if(Object(n)!==n)return Y.reject(new TypeError(n+" is not an object."));var i=n.done;return Y.resolve(n.value).then(function(r){return{value:r,done:i}})}return Ap=function(n){this.s=n,this.n=n.next},Ap.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Y.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Y.reject(n):e(i.apply(this.s,arguments))}},new Ap(t)}let h8=(Zt=class Lp extends Fh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),g(this,"name","DataChannelConnection"),g(this,"store",void 0),g(this,"peerConnection",void 0),g(this,"cname",void 0),g(this,"mutex",new tn("DataChannelConnection-mutex")),g(this,"dataChannel",void 0),g(this,"_p2pConnection",void 0),g(this,"establishPromise",void 0),g(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Lp.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new u8(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(e){var n;return(n=this._p2pConnection)===null||n===void 0?void 0:n.getPreMedia(e)}isPreSub(){var e,n;return(e=(n=this._p2pConnection)===null||n===void 0?void 0:n.isPreSub())!==null&&e!==void 0&&e}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(e){return this._p2pConnection.updateRtpSenderEncodings(e)}async connect(e){return this.cname=e.cname,await this._p2pConnection.connect(e),await new Y((n,i)=>{let r=setTimeout(()=>{this.closeSignal(),i(new D(C.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(e.candidates))))},T("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void n()},this.dataChannel.onerror=o=>{this.closeSignal(),i(o)},this.dataChannel.addEventListener("close",()=>{i(new D(C.DATACHANNEL_CONNECTION_TIMEOUT))})}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,n){return this._p2pConnection.updateRemoteRTPCapabilities(e,n)}send(e,n,i){var r=this;return jn(function*(){let o=yield yt(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Xa(pL(r._p2pConnection.send(e,n,i)))}finally{o()}})()}async stopSending(e,n){return this._p2pConnection.stopSending(e,n)}async createDataChannels(e,n){return this._p2pConnection.createDataChannels(e,n)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,n,i,r){return this._nvMedia?(_.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,n,this.cname)):(_.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,n,i,r))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var n=this;return jn(function*(){return yield*Xa(pL(n._p2pConnection.restartICE(e)))})()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var n;return(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,n){return await this._p2pConnection.updateEncoderConfig(e,n)}async updateSendParameters(e,n){return await this._p2pConnection.updateSendParameters(e,n)}setStatsRemoteVideoIsReady(e,n){this._p2pConnection.setStatsRemoteVideoIsReady(e,n)}async replaceTrack(e,n){return await this._p2pConnection.replaceTrack(e,n)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,n,i,r){if(T("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),e),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(e){let n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ps(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Lp.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Lp.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),T("ENABLE_ENCODED_TRANSFORM")&&wt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){let n=[];return e.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(sr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!T("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoRender=e=>{var n;return(n=this.onFirstVideoRender)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoBufferReady=e=>{var n;return(n=this.onFirstVideoBufferReady)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},q(Zt.prototype,"connect",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"connect"),Zt.prototype),q(Zt.prototype,"updateRemoteRTPCapabilities",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"updateRemoteRTPCapabilities"),Zt.prototype),q(Zt.prototype,"createDataChannels",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"createDataChannels"),Zt.prototype),q(Zt.prototype,"receive",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"receive"),Zt.prototype),q(Zt.prototype,"stopReceiving",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"stopReceiving"),Zt.prototype),q(Zt.prototype,"muteRemote",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"muteRemote"),Zt.prototype),q(Zt.prototype,"unmuteRemote",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"unmuteRemote"),Zt.prototype),q(Zt.prototype,"muteLocal",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"muteLocal"),Zt.prototype),q(Zt.prototype,"unmuteLocal",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"unmuteLocal"),Zt.prototype),q(Zt.prototype,"close",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"close"),Zt.prototype),q(Zt.prototype,"updateEncoderConfig",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"updateEncoderConfig"),Zt.prototype),q(Zt.prototype,"updateSendParameters",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"updateSendParameters"),Zt.prototype),q(Zt.prototype,"replaceTrack",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"replaceTrack"),Zt.prototype),q(Zt.prototype,"getRemoteSSRC",[bi],Object.getOwnPropertyDescriptor(Zt.prototype,"getRemoteSSRC"),Zt.prototype),Zt);function bi(t,e,n){let i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function _L(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),n.push.apply(n,i)}return n}class p8 extends ge{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;B(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Ge.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ge.CONNECTED):this._state==="closed"?this.emit(Ge.CLOSED):this._state==="failed"&&this.emit(Ge.FAILED))}constructor(e,n,i,r){super(),g(this,"connectionID",0),g(this,"currentURLIndex",0),g(this,"reconnectReason",void 0),g(this,"_reconnectMode","tryNext"),g(this,"_initMutex",void 0),g(this,"_name",void 0),g(this,"_state","closed"),g(this,"_reconnectInterrupter",void 0),g(this,"_url",void 0),g(this,"_retryConfig",void 0),g(this,"_reconnectCount",0),g(this,"_forceCloseTimeout",5e3),g(this,"_onlineReconnectListener",void 0),g(this,"_closeEstablishingTransmitter",()=>{}),g(this,"_store",void 0),g(this,"_joinChannelServiceRecordIndex",void 0),g(this,"_transmitter",void 0),g(this,"_useCompress",void 0),g(this,"_inflateLength",0),g(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?_L(Object(a),!0).forEach(function(c){g(o,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(a)):_L(Object(a)).forEach(function(c){Object.defineProperty(o,c,Object.getOwnPropertyDescriptor(a,c))})}return o}({},n),this._useCompress=i}resetReconnectCount(e){_.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let i=this._transmitter;n?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,n){if(!this._transmitter)return void _.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));let r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){let e=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:n}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let kr=function(t){return t[t.Default=0]="Default",t[t.Ack=1]="Ack",t}({});class _8{constructor(e,n,i){g(this,"version",1),g(this,"initialRTO",void 0),g(this,"maxBatchAckCount",void 0),g(this,"maxRTO",void 0),g(this,"initialRTT",void 0),g(this,"ID",void 0),g(this,"rtt",void 0),g(this,"packetNumber",1),g(this,"rtoRatioMap",new Map),g(this,"timeoutMap",new Map),g(this,"unorderedPacketQueue",[]),g(this,"batchAckPacketQueue",[]),g(this,"lastOrderedPacketNumber",0),g(this,"batchAckTimer",void 0),g(this,"sendImpl",void 0),g(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=n,this.ID=qt(7,"transmitter-"),this.initialRTO=i?.initialRTO!==void 0?i.initialRTO:T("TRANSMITTER_INITIAL_RTO"),this.initialRTT=i?.initialRTT!==void 0?i.initialRTT:T("TRANSMITTER_INITIAL_RTT"),this.rtt=i?.initialRTT!==void 0?i.initialRTT:T("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=i?.maxBatchAckCount!==void 0?i.maxBatchAckCount:T("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=i?.maxRTO!==void 0?i.maxRTO:T("TRANSMITTER_MAX_RTO")}packetize(e,n){return{type:kr.Default,version:this.version,packetNumber:n,payload:e}}serialize(e){switch(e.type){case kr.Default:{let n;typeof e.payload=="string"?n=new TextEncoder().encode(e.payload):n=e.payload;let i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),_b(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case kr.Ack:{let n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),_b(i,8,BigInt(e.ackSendTs)),n}}}deserialize(e){let n=new DataView(e),i=n.getUint16(0),r=n.getUint8(2);switch(r){case kr.Default:{let o=n.getUint32(3),s=pb(n,7),a=e.slice(15),c=new Uint8Array(a);return{version:i,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case kr.Ack:{let o=n.getUint32(3),s=n.getUint8(7),a=pb(n,8);return{version:i,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw _.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){T("DC_DEBUG_LOG")&&typeof e=="string"&&_.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(e));let n=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let i=this.calculateRTO(n),r=window.setTimeout(()=>{this.resendMessage(n)},i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(e){let n=this.deserialize(e);n.type===kr.Default?this.ack(n):n.type===kr.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(e=>{let[n,i]=e;window.clearTimeout(i)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){let n=this.calculateRTO(e),i=window.setTimeout(()=>{T("DC_DEBUG_LOG")&&typeof e.payload=="string"&&_.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(e.payload),"timeout: ".concat(n)),this.resendMessage(e)},n);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){let n=this.rtoRatioMap.get(e.packetNumber);if(n===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{let i=9*this.rtt/8*n;return this.rtoRatioMap.set(e.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,n){let i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){let n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){let n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:kr.Ack,version:this.version};T("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(n)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;let n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:kr.Ack,version:this.version};T("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:kr.Ack,version:this.version};T("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending batch ack packet"),e,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===kr.Default&&(e.sendTs=Math.round(performance.now()));let n=this.serialize(e);this.sendImpl(n)}clearRTO(e){for(let n=e.maxAckPacketNumber-e.shift;n<=e.maxAckPacketNumber;n++){let i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class mL extends p8{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),g(this,"_initMutex",void 0),g(this,"_reconnectInterrupter",void 0),g(this,"_url",void 0),g(this,"_transmitter",void 0),g(this,"_addresses",void 0),g(this,"_reliableTransmission",void 0),g(this,"_textEncoder",void 0),g(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new tn("datachannel");let{timeout:i,timeoutFactor:r}=n,o=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*r)/10);kn.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),ve.on(Ls.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===kn.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;let i=(r,o)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||T("FINGERPRINT"));let s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(Ge.CLOSED,()=>o(new D(C.WS_DISCONNECT))),this.once(Ge.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new Y((o,s)=>{i(o,s)}).then(()=>{r()}).catch(()=>{r()}))}async sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new D(C.WS_ABORT,"datachannel is not ready");try{n||(e=JSON.stringify(e));let i=this._textEncoder.encode(e),r=A6(i,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(i){throw new D(C.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){let n=JSON.stringify(e);return{compressed:n,compressedLength:n.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Y((n,i)=>{var r;let o=()=>{_.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),n()},s=async l=>{var u;if((u=this._closeEstablishingTransmitter)===null||u===void 0||u.call(this),_.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let h=di(this,Ge.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!p)return i(new D(C.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);n()}else i(new D(C.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=async l=>{try{var u;(u=this._reliableTransmission)===null||u===void 0||u.onData(l.data)}catch(h){console.log(h)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),_.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));let c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Ue(this,Ge.TO_CONNECT_DATACHANNEL).then(l=>{var u,h;if(!l)throw new Error("transmissonInfo not exist yet");let{transmitter:p,close:S}=l;this._transmitter=p,(u=this._store)===null||u===void 0||u.signalChannelOpen();let E=Date.now()-d;_.debug("[choose dc] dc open cost ".concat(E,"ms")),this._reliableTransmission=new _8(f=>{var R;this._transmitter&&this._transmitter.readyState==="open"&&((R=this._transmitter)===null||R===void 0||R.send(f))},f=>{if(typeof f=="string")this.emit(Ge.ON_MESSAGE,f);else{let R=w6(f,{raw:!0}).buffer,v=this._textDecoder.decode(R);this.emit(Ge.ON_MESSAGE,v)}}),this._closeEstablishingTransmitter=()=>{var f;(f=this._reliableTransmission)===null||f===void 0||f.close(),this._reliableTransmission=void 0,S()},o&&o(),p.onclose=s,p.onmessage=a,(h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(l=>{var u;if((u=this._store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:l instanceof D&&l.code===C.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof D&&l.code===C.WS_ERR){let h=new D(C.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return _.error("[".concat(this._name,"]").concat(h)),void i(h)}s&&s(l)}else i(new D(C.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))})})}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||ve.networkState!==kn.OFFLINE||(this._onlineReconnectListener=ve.onlineWaiter&&ve.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){let a=dh(this._reconnectCount,this._retryConfig);_.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(e)),await Y.race([Ye(a),this._onlineReconnectListener||new Y(()=>{})])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;let r=async(a,c)=>{this.emit(Ge.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(e==="retry"){let a=this._addresses[this.currentURLIndex];await r(a,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||T("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return _.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);_.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let a=this._addresses[this.currentURLIndex];await r(a,e)}else e==="recover"&&(_.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Ge.FAILBACK));return!0}catch(a){var o,s;return _.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(o=a.data)!==null&&o!==void 0&&o.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&B(s=a.data.desc).call(s,"dynamic key expired")?(this.emit(Ge.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,n)}}}class m8 extends ge{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Pt.CONNECTED?this.emit(nt.WS_CONNECTED):e===Pt.RECONNECTING?this.emit(nt.WS_RECONNECTING,this._websocketReconnectReason):e===Pt.CLOSED&&this.emit(nt.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(_.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach(e=>{let{type:n,message:i}=e;this.emit(n,i),n===pt.ON_NOTIFICATION&&this.handleNotification(i),n===pt.ON_USER_BANNED&&this.handleUserBanned(i)}),this.pendingNotifications=[])}handleUserBanned(e){switch(e.error_code){case 14:this.close(Dt.UID_BANNED);break;case 15:this.close(Dt.IP_BANNED);break;case 16:this.close(Dt.CHANNEL_BANNED)}}constructor(e,n){super(),g(this,"__name__","DataChannelSignal"),g(this,"_disconnectedReason",void 0),g(this,"_websocketReconnectReason",void 0),g(this,"_connectionState",Pt.CLOSED),g(this,"reconnectToken",void 0),g(this,"websocket",void 0),g(this,"openConnectionTime",void 0),g(this,"clientId",void 0),g(this,"lastMsgTime",Date.now()),g(this,"uploadCache",[]),g(this,"uploadCacheInterval",void 0),g(this,"rttRolling",new If(5)),g(this,"pingpongTimer",void 0),g(this,"inflateDataTimer",void 0),g(this,"pingpongTimeoutCount",0),g(this,"ortc",void 0),g(this,"joinResponse",void 0),g(this,"multiIpOption",void 0),g(this,"initError",void 0),g(this,"spec",void 0),g(this,"store",void 0),g(this,"isJoining",!1),g(this,"pendingNotifications",[]),g(this,"onWebsocketMessage",i=>{if(i instanceof ArrayBuffer)return void this.emit(nt.ON_BINARY_DATA,i);let r=JSON.parse(i);if(T("DC_DEBUG_LOG")&&_.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===pt.ON_NOTIFICATION||r._type===pt.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===pt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===pt.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),_.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===pt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===pt.ON_USER_BANNED&&this.handleUserBanned(r._message)))}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new mL("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Pt.CONNECTED&&this.reconnect("retry",Xo.OFFLINE)})}async request(e,n,i,r){let o=qt(6,""),s={_id:o,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new Y((S,E)=>{if(this.connectionState===Pt.CONNECTED)return S();let f=()=>{this.off(nt.WS_CLOSED,R),S()},R=()=>{this.off(nt.WS_CONNECTED,f),E(new D(C.WS_ABORT))};this.once(nt.WS_CONNECTED,f),this.once(nt.WS_CLOSED,R),e!==it.PUBLISH&&e!==it.SUBSCRIBE&&e!==it.UNSUBSCRIBE&&e!==it.UNPUBLISH&&e!==it.CONTROL&&e!==it.RESTART_ICE||this.once(nt.DISCONNECT_P2P,()=>{E(new D(C.DISCONNECT_P2P))}),e!==it.PUBLISH&&e!==it.RESTART_ICE||this.once(nt.ABORT_P2P_EXECUTION,()=>{E(new D(C.DISCONNECT_P2P))})});if(this.connectionState!==Pt.CONNECTING&&this.connectionState!==Pt.RECONNECTING||e===it.JOIN||e===it.REJOIN||await c(),e===it.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),T("DC_DEBUG_LOG")&&_.debug("[datachannel-signal] sendMessage",s),await this.websocket.sendMessage(s,!0,!1),r)return;let d=new Y((S,E)=>{let f=!1,R=(I,w)=>{f=!0,S({isSuccess:I==="success",message:w||{}}),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.emit(nt.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(o),R);let v=()=>{E(new D(C.WS_ABORT,"type: ".concat(e))),this.off(nt.WS_CLOSED,v),this.off(nt.WS_RECONNECTING,v),this.off("res-@".concat(o),R)};this.once(nt.WS_CLOSED,v),this.once(nt.WS_RECONNECTING,v),Ye(T("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("dc request timeout, type: ".concat(e)),this.emit(nt.REQUEST_TIMEOUT,e,n))})}),l=null;try{l=await d}catch(S){if(this.connectionState===Pt.CLOSED||e===it.LEAVE)throw new D(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?S.throw():e===it.JOIN||e===it.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=Xs(u),p=new D(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(_.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===st.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===st.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Xo.MULTI_IP)):this.reconnect(h.action,Xo.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new Y(i=>{let r=o=>{(!n||n(o))&&(this.off(e,r),i(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(zs.WRTC_STATS,n)}upload(e,n){let i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{let o=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Pt.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},T("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(e,n){let i={_type:e,_message:n};await this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Y((n,i)=>{this.once(nt.WS_CONNECTED,()=>n(this.joinResponse)),this.once(nt.WS_CLOSED,()=>i(this.initError||new D(C.WS_ABORT))),this.connectionState=Pt.CONNECTING,this.websocket.init(e).catch(i),this.websocket.once(Ge.FAILBACK,()=>{i(new D(C.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{this.openConnectionTime===void 0&&(_.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new D(C.INIT_DATACHANNEL_TIMEOUT)))},T("DC_JOIN_WITH_FAILBACK"))})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=e||Dt.LEAVE,this.connectionState=Pt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===Dt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new mL("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),T("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(nt.ABORT_P2P_EXECUTION),this.store.signalConnected();let e=await Ue(this,nt.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];let n=await this.request(it.JOIN,e);if(this.store.joinRep(),this.ortc=e?.ortc,!n)return this.emit(nt.REPORT_JOIN_GATEWAY,C.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(nt.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Pt.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new D(C.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=ks(this,nt.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let n=await this.request(it.REJOIN,e);return!!n&&(this.connectionState=Pt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),T("DC_PINGPONG_INTERVAL")),n.peers&&n.peers.forEach(i=>{this.emit(pt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(pt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(pt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(pt.MUTE_AUDIO,{uid:i.uid}):this.emit(pt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(pt.MUTE_VIDEO,{uid:i.uid}):this.emit(pt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(pt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(pt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(pt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(pt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(pt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){if(!this.ortc)return!1;let n={downgrade_codec:e,ortc:this.ortc};return!!await this.request(it.DOWNGRADE_CODEC,n)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let n=Xs(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Dt.UID_BANNED),void this.close()):void this.reconnect(n.action,Xo.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,T("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));let e=T("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",Xo.FALLBACK):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let i=Date.now()-n;this.rttRolling.add(i),T("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleInflateData(){let{inflateLength:e,deflateLength:n}=this.websocket.getInflateData();e!==0&&n!==0&&this.upload(zs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ge.RECONNECT_CREATE_CONNECTION,e=>{this.emit(nt.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Ge.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ge.CLOSED,()=>{this.connectionState=Pt.CLOSED}),this.websocket.on(Ge.FAILED,()=>{this._disconnectedReason=Dt.NETWORK_ERROR,this.connectionState=Pt.CLOSED}),this.websocket.on(Ge.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Pt.CONNECTED?this.connectionState=Pt.RECONNECTING:this.connectionState=Pt.CONNECTING}),this.websocket.on(Ge.WILL_RECONNECT,(e,n)=>{if(ks(this,nt.IS_P2P_DISCONNECTED)&&e==="retry")return _.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(nt.NEED_RENEW_SESSION),this.emit(nt.DISCONNECT_P2P),n("tryNext");e!=="retry"&&(_.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(nt.NEED_RENEW_SESSION),this.emit(nt.DISCONNECT_P2P)),n(e)}),this.websocket.on(Ge.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Xo.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(nt.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof D&&e.code===C.UNEXPECTED_RESPONSE&&e.data.code===st.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Xo.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Xo.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Ge.REQUEST_NEW_URLS,(e,n)=>{Ue(this,nt.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(Ge.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(Ge.TO_CONNECT_DATACHANNEL,(e,n)=>{Ue(this,nt.PRE_CONNECT_PC).then(e).catch(n)}),this.websocket.on(Ge.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(nt.DATACHANNEL_FAILBACK)})}}let E8={name:"DataChannelConnection",create:function(t){let{store:e,spec:n}=t;return new h8(n,e)}},f8={name:"DataChannelSignal",create:function(t){let{store:e,spec:n}=t;return new m8(n,e)}};Df(),$t("PROCESS_ID","process-".concat(qt(8,""),"-").concat(qt(4,""),"-").concat(qt(4,""),"-").concat(qt(4,""),"-").concat(qt(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{let e=JSON.parse(window.atob(t)),n=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(i=>{if(Object.prototype.hasOwnProperty.call(zt,i)){let{value:r,expires:o}=e[i];if(o&&o<=n)return;gi[i]=r,zt[i]=r}})}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(gi.AREAS)&&gi.AREAS.length>0&&Pg(gi.AREAS,!0);let EL=(t,e,n)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),$t(t,e,n)};$r(L6,!1),$r(U6,!1),$r(hK,!1),$r(q6,!1),$r(N6,!1),$r(o8,!1),$r(c8,!1),$r(l8,!1),$r(E8,!1),$r(f8,!1);let xe=function(t){let e=new ge,n=t,i={getListeners:e.getListeners.bind(e),on:(r,o)=>(function(s,a){s===Jr.SECURITY_POLICY_VIOLATION&&YD(a,!0)}(r,o),e.on.bind(e)(r,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return KD(KD({},n),i)}({__TRACK_LIST__:Bs,VERSION:ki,BUILD:kf,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:EL,getParameter:T,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection,n=await async function(i){let r;return wt().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r}(e);if(!n)return t;e.close(),e=null,t=function(i){let r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r}(n)}catch(e){throw new D(C.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],e=tt.reportApiInvoke(null,{name:me.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:re.TRACER}),n=function(){let o=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],s=!1;try{let a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;s=!(!a||!d),o&&!c&&(s=!1),s&&Dd()&&nb(75)&&new a().close()}catch(a){_.error("check system requirement failed: ",a),s=!1}return s}(t),i=_K();_.debug("checkSystemRequirements, api:",n,"browser",i);let r=n&&i;return e.onSuccess(r),T("IGNORE_RTC_DEVICE_CHECK")?n:r},getDevices:function(t){return vi.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return vi.getRecordingDevices(t)},getCameras:function(t){return vi.getCamerasDevices(t)},getElectronScreenSources:a0,getPlaybackDevices:function(t){return vi.getSpeakers(t)},createClient:GD,createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=T("CAMERA_CAPTURE_CONFIG"),n=qt(8,"track-cam-"),i=tt.reportApiInvoke(null,{id:n,tag:re.TRACER,name:me.CREATE_CAM_VIDEO_TRACK,options:[le({},t),e]});e&&(t.encoderConfig=e);let r=Ch(t),o=null;_.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{o=(await Ci({video:r},n)).getVideoTracks()[0]||null}catch(a){throw i.onError(a),a}if(!o){let a=new L(C.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(_)}if(t.optimizationMode&&$f(n,o,t,ir(t.encoderConfig)),T("USE_STANDARD_BITRATE_DEFAULT")){let a=ir(t.encoderConfig);t.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}let s=new yh(o,t,r,t.scalabiltyMode?gh(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return i.onSuccess(s.getTrackId()),_.info("create camera video success, trackId:",n),s},createCustomVideoTrack:function(t){let e=qt(8,"track-cus-"),n=tt.reportApiInvoke(null,{id:e,tag:re.TRACER,name:me.CREATE_CUSTOM_VIDEO_TRACK,options:[t]});T("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin);let i=new oe(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?gh(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[Kt.CUSTOM_TRACK]);return n.onSuccess(i.getTrackId()),_.info("create custom video track success with config",t,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",n=typeof e=="object"?function(h){let p=f0(h);return Jb()&&h.suppressLocalAudioPlayback&&(p.suppressLocalAudioPlayback=h.suppressLocalAudioPlayback),Qb()&&h.restrictOwnAudio&&(p.restrictOwnAudio=!0),p}(e):void 0;n&&(e="auto");let i=qt(8,"track-scr-v-"),r=tt.reportApiInvoke(null,{id:i,tag:re.TRACER,name:me.CREATE_SCREEN_VIDEO_TRACK,options:[le({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";let o=function(h){let p={};h.screenSourceType&&(p.mediaSource=h.screenSourceType),h.extensionId&&go()&&(p.extensionId=h.extensionId);let{displaySurface:S,selfBrowserSurface:E,surfaceSwitching:f,systemAudio:R,preferCurrentTab:v,windowAudio:I,monitorTypeSurfaces:w}=h;(Rr(107)||Ho(107)||Ds(93))&&(S&&(De(S,"displaySurface",["browser","window","monitor"]),p.displaySurface=S),E?(De(E,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=E):p.selfBrowserSurface="include",f&&(De(f,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=f)),(Rr(105)||Ho(105)||Ds(91))&&R&&(De(R,"systemAudio",["exclude","include"]),p.systemAudio=R),(Rr(94)||Ho(94)||Ds(80))&&v&&(p.preferCurrentTab=!0),(Rr(141)||Ho(141)||Ds(125))&&I&&(De(I,"windowAudio",["exclude","system"]),p.windowAudio=I),(Rr(119)||Ho(119)||Ds(105))&&w&&(De(w,"monitorTypeSurfaces",["exclude","include"]),p.monitorTypeSurfaces=w),h.electronScreenSourceId&&(p.sourceId=h.electronScreenSourceId);let O=h.encoderConfig?Bf(h.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:O?O.width:void 0,maxHeight:O?O.height:void 0},O&&(O.frameRate&&(typeof O.frameRate=="number"?(p.mandatory.maxFrameRate=O.frameRate,p.mandatory.minFrameRate=O.frameRate):(p.mandatory.maxFrameRate=O.frameRate.max||O.frameRate.ideal||O.frameRate.exact||void 0,p.mandatory.minFrameRate=O.frameRate.min||O.frameRate.ideal||O.frameRate.exact||void 0),p.frameRate=O.frameRate),O.width&&(p.width=O.width),O.height&&(p.height=O.height)),p}(t),s=null,a=null,c=wt();if(!c.supportShareAudio&&e==="enable"){let h=new L(C.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(h),h.throw(_)}_.info("start create screen video track with config",t,"withAudio",e,"trackId",i);let d=c.supportShareAudio&&e!=="disable";try{let h=await Ci({screen:o,screenAudio:d?n||!0:void 0},i);s=h.getVideoTracks()[0]||null,a=h.getAudioTracks()[0]||null}catch(h){throw r.onError(h),h}if(!s){let h=new L(C.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(h),h.throw(_)}if(!a&&e==="enable"){s&&s.stop();let h=new L(C.SHARE_AUDIO_NOT_ALLOWED);return r.onError(h),h.throw(_)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&($f(i,s,t,t.encoderConfig&&Bf(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));let l=new oe(s,t.encoderConfig?Bf(t.encoderConfig):{},t.scalabiltyMode?gh(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,i,[Kt.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),_.info("create screen video track success","video:",l.getTrackId()),l;let u=new Ae(a,void 0,qt(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create screen video track success","video:",l.getTrackId(),"audio:",u.getTrackId()),[l,u]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=T("CAMERA_CAPTURE_CONFIG"),i=qt(8,"track-mic-"),r=qt(8,"track-cam-"),o=tt.reportApiInvoke(null,{id:"".concat(i,"-").concat(r),tag:re.TRACER,name:me.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,n]});n&&(e.encoderConfig=n);let s=Ch(e),a=g0(t),c=null,d=null;_.info("start create camera video track(".concat(r,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{let h=await Ci({audio:a,video:s},"".concat(i,"-").concat(r));c=h.getAudioTracks()[0],d=h.getVideoTracks()[0]}catch(h){throw o.onError(h),h}if(!c||!d){let h=new L(C.UNEXPECTED_ERROR,"can not find tracks in media stream");return o.onError(h),h.throw(_)}if(e.optimizationMode&&$f(r,d,e,ir(e.encoderConfig)),T("USE_STANDARD_BITRATE_DEFAULT")){let h=ir(e.encoderConfig);e.encoderConfig=h,delete h.bitrateMax,delete h.bitrateMin}let l=new jd(c,t,a,i),u=new yh(d,e,s,e.scalabiltyMode?gh(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return o.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create camera video track(".concat(r,") and microphone audio track(").concat(i,") success")),[l,u]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=qt(8,"track-mic-"),n=tt.reportApiInvoke(null,{id:e,tag:re.TRACER,name:me.CREATE_MIC_AUDIO_TRACK,options:[t]}),i=g0(t),r=null;_.info("start create microphone audio track with config",JSON.stringify(t),"trackId",e);try{r=(await Ci({audio:i},e)).getAudioTracks()[0]||null}catch(s){throw n.onError(s),s}if(!r){let s=new L(C.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(s),s.throw(_)}let o=new jd(r,t,i,e);return n.onSuccess(o.getTrackId()),_.info("create microphone audio track success, trackId:",e),o},createCustomAudioTrack:Hw,createBufferSourceAudioTrack:async function(t){var e;let{cacheOnlineFile:n,encoderConfig:i}=t,{source:r}=t,o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:n,encoderConfig:i},s=qt(8,"track-buf-"),a=tt.reportApiInvoke(null,{id:s,tag:re.TRACER,name:me.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(T("DISABLE_WEBAUDIO"))throw new L(C.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");_.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",s);let c=r;if(!(r instanceof AudioBuffer))try{r=await async function(u,h){let p=null;if(typeof u=="string"){let E=ow.get(u);if(E)return _.debug("use cached audio resource: ",u),E;try{p=(await Cr(()=>Gn.get(u,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(f){throw new L(C.FETCH_AUDIO_FILE_FAILED,f.toString())}}else p=await new Y((f,R)=>{let v=new FileReader;v.onload=I=>{I.target?f(I.target.result):R(new L(C.READ_LOCAL_AUDIO_FILE_ERROR))},v.onerror=()=>{R(new L(C.READ_LOCAL_AUDIO_FILE_ERROR))},v.readAsArrayBuffer(u)});let S=await function(E){let f=dc();return new Y((R,v)=>{f.decodeAudioData(E,I=>{R(I)},I=>{v(new L(C.DECODE_AUDIO_FILE_FAILED,I.toString()))})})}(p);return typeof u=="string"&&h&&ow.set(u,S),S}(r,n)}catch(u){return a.onError(u),u.throw(_)}let d=new L4(r),l=new P4(c,d,i?Sh(i):{},s);return _.info("create buffer source audio track success, trackId:",s),a.onSuccess(l.getTrackId()),l},setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new D(C.INVALID_PARAMS,"invalid app type",t);$t("APP_TYPE",Math.floor(t))},setLogLevel:function(t){_.setLogLevel(t)},enableLogUpload:function(){T("USE_NEW_LOG")?$t("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){T("USE_NEW_LOG")?$t("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new cN},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=tt.reportApiInvoke(null,{tag:re.TRACER,name:me.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof Ae||t instanceof hc)){let c=new D(C.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}e&&e<1e3&&(e=1e3);let i=t instanceof Ae?t.getTrackLabel():"remote_track",r=t.getVolumeLevel(),o=r,s=r,a=Date.now();return new Y(c=>{let d=setInterval(()=>{let l=t.getVolumeLevel();o=l>o?l:o,s=l<s?l:s;let u=o-s>1e-4,h=Date.now()-a;if(u||h>e){clearInterval(d);let p=u,S={duration:h,deviceLabel:i,maxVolumeLevel:o,result:p};_.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(S))),n.onSuccess(S),c(p)}},200)})},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=tt.reportApiInvoke(null,{tag:re.TRACER,name:me.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof oe||t instanceof uc)){let u=new D(C.INVALID_TRACK,"the parameter is not a video track");return n.onError(u),u.throw()}e&&e<1e3&&(e=1e3);let i=t instanceof oe?t.getTrackLabel():"remote_track",r=t.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,($e()||sh())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();let s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{let u=Date.now();a=await function(h,p,S,E){let f,R=0,v=null;return new Y((I,w)=>{function O(){R>E&&f&&(f(),I(R));let A=S.getContext("2d");if(!A){let V=new D(C.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(V.toString()),void w(V)}A.drawImage(h,0,0,160,120);let N=A.getImageData(0,0,S.width,S.height),k=Math.floor(N.data.length/3);if(v){for(let V=0;V<k;V+=3)if(N.data[V]!==v[V])return R+=1,void(v=N.data);v=N.data}else v=N.data}setTimeout(()=>{f&&(f(),I(R))},p),f=Yf(()=>{O()},30)})}(o,e,s,4),c=Date.now()-u}catch(u){throw n.onError(u),u}ZH===jt.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;let d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return _.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),n.onSuccess(l),d},setArea:Pg,audioElementPlayCenter:wn,resumeAudioContext:function(){return wn.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){EK.processExternalMediaAEC(t)},registerExtensions:function(t){let e=T("PLUGIN_INFO")||[];t.forEach(n=>{"name"in n&&!B(e).call(e,n.name)&&e.push(n.name);let i=n;i.__registered__=!0,i.logger.hookLog=_.extLog,i.reporter.hookApiInvoke=tt.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach(r=>{i.parameters[r]=T(r)})}),EL("PLUGIN_INFO",e)},ChannelMediaRelayError:mc,ChannelMediaRelayEvent:Ro,ChannelMediaRelayState:$n,RemoteStreamFallbackType:A4,RemoteStreamType:I4,ConnectionDisconnectedReason:Dt,AudienceLatencyLevelType:t4,AREAS:Wt,preload:async function(t,e,n,i){return tS(t,e,n,i)},startLastmileProbeTest:async function(t,e,n,i){let r={state:"unavailable"};await tS(t,e,n,i);let o=await eS({appId:t,cname:e,token:n||t,uid:i,cloudProxyServer:"disabled"});if(!o)return r;await nS(o);let s,a=GD({mode:"rtc",codec:"vp8"});try{s=await a.join(t,e,n,i,{networkQualityProbe:!0})}catch{return r}let c=new nK,d=c.createMuteAudioTrack(),l=await Hw({mediaStreamTrack:d});await a.publish([l]);let[u,h,p]=await new Y((I,w)=>{let O=setTimeout(()=>{clearTimeout(O),I([!0,null,"audio"])},5e3);a.on("user-published",async(A,N)=>{A.uid===s&&(clearTimeout(O),I([!1,A,N]))})});if(u||!h)return await a.unpublish([l]),await a.leave(),l.close(),c.close(),r;await a.subscribe(h,p),await new Y((I,w)=>{let O=setTimeout(()=>{clearTimeout(O),I(null)},5e3)});let S=a.getRTCStats(),E=a.getLocalAudioStats(),f=S.RTT,R=E.sendJitterMs,v=E.currentPacketLossRate;return r={state:"complete",rtt:f,packetLossRate:v,jitter:R,networkQuality:((I,w,O)=>{let A=1;if(O>0){let ut=Math.log(100*O)/Math.log(2)+1;ut=Math.min(5,Math.max(0,ut)),A=1-ut/5}let N=1;if(I>0){let ut=Math.log(I/40)/Math.log(2)+1;ut=Math.min(5,Math.max(0,ut)),N=1-ut/5}let k=1;if(w>0){let ut=Math.log(w/10)/Math.log(2.5)+1;ut=Math.min(5,Math.max(0,ut)),k=1-ut/5}let V=.5*A+.3*N+.2*k,J=0;return J=V>=.8?1:V>=.6?2:V>=.4?3:V>=.2?4:5,J})(f,R,v)},await a.unsubscribe(h),await a.unpublish([l]),await a.leave(),l.close(),c.close(),await nS(o),r}});return Object.defineProperties(xe,{onAudioAutoplayFailed:{get:()=>Hn.onAudioAutoplayFailed,set:t=>{Hn.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>Hn.onAutoplayFailed,set:t=>{Hn.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>xe._onSecurityPolicyViolation,set(t){xe._onSecurityPolicyViolation=t,YD(t)}},__CLIENT_LIST__:{get:()=>T("SHOW_GLOBAL_CLIENT_LIST")?Ys:[]}}),vi.on(Gs.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),xe.onCameraChanged&&xe.onCameraChanged(t),xe.safeEmit(Jr.CAMERA_CHANGED,t)}),vi.on(Gs.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),xe.onMicrophoneChanged&&xe.onMicrophoneChanged(t),xe.safeEmit(Jr.MICROPHONE_CHANGED,t)}),vi.on(Gs.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),xe.onPlaybackDeviceChanged&&xe.onPlaybackDeviceChanged(t),xe.safeEmit(Jr.PLAYBACK_DEVICE_CHANGED,t)}),wn.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),Hn.onAudioAutoplayFailed&&Hn.onAudioAutoplayFailed()},te.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),Hn.onAudioAutoplayFailed&&Hn.onAudioAutoplayFailed(),xe.safeEmit(Jr.AUTOPLAY_FAILED)}),te.on(ln.STATE_CHANGE,(t,e)=>{_.info("audio context state changed: ".concat(e," => ").concat(t)),xe.onAudioContextStateChanged&&xe.onAudioContextStateChanged(t,e),xe.safeEmit(Jr.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),ve.on(Ls.NETWORK_STATE_CHANGE,(t,e)=>{_.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=xe),xe})});var He=Pp((qY,RL)=>{"use strict";RL.exports=React});var IL=Pp(Mp=>{"use strict";var N8=He(),D8=Symbol.for("react.element"),P8=Symbol.for("react.fragment"),L8=Object.prototype.hasOwnProperty,k8=N8.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,M8={key:!0,ref:!0,__self:!0,__source:!0};function yL(M,F,H){var z,ot={},bt=null,_t=null;H!==void 0&&(bt=""+H),F.key!==void 0&&(bt=""+F.key),F.ref!==void 0&&(_t=F.ref);for(z in F)L8.call(F,z)&&!M8.hasOwnProperty(z)&&(ot[z]=F[z]);if(M&&M.defaultProps)for(z in F=M.defaultProps,F)ot[z]===void 0&&(ot[z]=F[z]);return{$$typeof:D8,type:M,key:bt,ref:_t,props:ot,_owner:k8.current}}Mp.Fragment=P8;Mp.jsx=yL;Mp.jsxs=yL});var Rn=Pp((nq,AL)=>{"use strict";AL.exports=IL()});var Fr={};v8(Fr,{AgoraRTCProvider:()=>U8,AgoraRTCReactError:()=>Ze,AgoraRTCScreenShareProvider:()=>V8,LocalAudioTrack:()=>FS,LocalUser:()=>nY,LocalVideoTrack:()=>BS,RemoteAudioTrack:()=>GS,RemoteUser:()=>iY,RemoteVideoTrack:()=>WS,TrackBoundary:()=>$8,VERSION:()=>rY,default:()=>oY,useAutoPlayAudioTrack:()=>Al,useAutoPlayVideoTrack:()=>Il,useClientEvent:()=>w8,useConnectionState:()=>B8,useCurrentUID:()=>j8,useIsConnected:()=>Vr,useJoin:()=>G8,useLocalCameraTrack:()=>q8,useLocalMicrophoneTrack:()=>Y8,useLocalScreenTrack:()=>Q8,useNetworkQuality:()=>W8,usePublish:()=>H8,useRTCClient:()=>Cn,useRTCScreenShareClient:()=>F8,useRemoteAudioTracks:()=>z8,useRemoteUserTrack:()=>Kp,useRemoteUsers:()=>J8,useRemoteVideoTracks:()=>X8,useTrackEvent:()=>O8,useVolumeLevel:()=>K8});var GL=Bt(us());var Wc=Bt(He());function Qe(M,F,H){return M.on(F,H),()=>M.off(F,H)}var Hi=Bt(He());function I8(M){try{return M()}catch(F){console.error(F)}}function wi(M){return()=>M.forEach(I8)}function CL(M,F){let H=setInterval(M,F);return()=>clearInterval(H)}function hs(M,F){let H=setTimeout(M,F);return()=>clearTimeout(H)}function jc(){let M,F,H;function z(){if(F){let ft=F;F=void 0,ft()}}async function ot(){if(H){let ft=H;H=void 0;try{await ft()}catch(At){console.error(At)}}}async function bt(ft){M=!0,await ot();try{H=await ft()}catch(At){console.error(At)}M=!1,z()}async function _t(){M=!0,await ot(),M=!1,z()}function de(ft){M?F=()=>bt(ft):bt(ft)}function Jt(){M?F=_t:_t()}return{run:de,dispose:Jt}}var Gc=typeof document<"u"?Hi.useLayoutEffect:Hi.useEffect;function A8(M){return M!=null&&typeof M.then=="function"}function hi(){let M=(0,Hi.useRef)(!1);return(0,Hi.useEffect)(()=>(M.current=!1,()=>{M.current=!0}),[]),M}function b8(){let M=hi();function F(H,z){return new Promise(async(ot,bt)=>{try{let _t=await H;M.current||ot(_t)}catch(_t){M.current?z&&z(_t):bt(_t)}})}return(0,Hi.useCallback)(F,[M])}function kp(M){let F=b8(),[H,z]=(0,Hi.useState)();return Gc(()=>{A8(M)?F(M).then(z):z(M)},[M,F]),H}function Oi(M,F){let H=(0,Hi.useRef)();(0,Hi.useEffect)(()=>{let{run:z,dispose:ot}=H.current||=jc();return z(M),ot},F)}function vL(M,F){let H=M.split("."),z=F.split("."),ot=Math.max(H.length,z.length);for(let bt=0;bt<ot;bt++){let _t=parseInt(H[bt]||"0"),de=parseInt(z[bt]||"0");if(_t>de)return 1;if(_t<de)return-1}return 0}function w8(M,F,H){let z=(0,Wc.useRef)(H);Gc(()=>{z.current=H},[H]),(0,Wc.useEffect)(()=>{if(M)return Qe(M,F,(...ot)=>{z.current&&z.current(...ot)})},[F,M])}function O8(M,F,H){let z=(0,Wc.useRef)(H);Gc(()=>{z.current=H},[H]),(0,Wc.useEffect)(()=>{if(M)return Qe(M,F,(...ot)=>{z.current&&z.current(...ot)})},[F,M])}var Up=Bt(He()),wL=Bt(Rn()),bL=(0,Up.createContext)(null);function U8({client:M,children:F}){return(0,wL.jsx)(bL.Provider,{value:M,children:F})}function x8(M){let F=(0,Up.useContext)(bL);return M||F}function Cn(M){let F=x8(M);if(!F)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return F}var xp=Bt(He()),NL=Bt(Rn()),OL=(0,xp.createContext)(null);function V8({client:M,children:F}){return(0,NL.jsx)(OL.Provider,{value:M,children:F})}function F8(M){let F=(0,xp.useContext)(OL);return M||F}var Vp=Bt(He());function B8(M){let F=Cn(M),[H,z]=(0,Vp.useState)(F?F.connectionState:"DISCONNECTED");return(0,Vp.useEffect)(()=>{if(F){z(F.connectionState);let ot;return wi([Qe(F,"connection-state-change",bt=>{ot?.(),bt==="CONNECTED"?ot=hs(()=>z(bt),0):z(bt)}),()=>ot?.()])}else z("DISCONNECTED")},[F]),H}var Fp=Bt(He());function Vr(M){let F=Cn(M),[H,z]=(0,Fp.useState)(F?F.connectionState==="CONNECTED":!1);return(0,Fp.useEffect)(()=>{if(F){z(F.connectionState==="CONNECTED");let ot;return wi([Qe(F,"connection-state-change",bt=>{ot?.(),ot=hs(()=>z(bt==="CONNECTED"),0)}),()=>ot?.()])}else z(!1)},[F]),H}var Bp=Bt(He());function j8(M){let F=Cn(M),[H,z]=(0,Bp.useState)(F?.uid);return(0,Bp.useEffect)(()=>{if(F)return Qe(F,"connection-state-change",ot=>{if(ot==="CONNECTED")return hs(()=>z(F.uid),0);ot==="DISCONNECTED"&&z(void 0)})},[F]),H}var Hc=Bt(He());var Ze=class extends Error{rtcMethod;rtcError;name="AgoraRTCReactException";constructor(F,H){typeof H=="string"?super(H):super(H.message),this.rtcMethod=F,this.rtcError=H}log(F){console[F](this)}};function G8(M,F=!0,H){let z=Cn(H),ot=Vr(H),bt=(0,Hc.useRef)(),[_t,de]=(0,Hc.useState)(!1),[Jt,ft]=(0,Hc.useState)(0),[At,ee]=(0,Hc.useState)(null),xt=hi();return Oi(async()=>{if(xt.current||(ee(null),ft(0),de(!1)),F&&z){try{xt.current||de(!0);let{appid:sn,channel:lt,token:vt,uid:Te}=typeof M=="function"?await M():M,Ni=await z.join(sn,lt,vt,Te);xt.current||ft(Ni)}catch(sn){console.error(sn),xt.current||ee(new Ze("IAgoraRTCClient.join",sn))}xt.current||de(!1);let fn=bt.current||=jc();return wi([()=>{fn.dispose()},()=>{fn.run(()=>z.unpublish(z.localTracks))},()=>{for(let sn of z.localTracks)sn.isPlaying&&sn.stop(),sn.close();fn.run(()=>z.leave())}])}},[F,H]),{data:Jt,isLoading:_t,isConnected:ot,error:At}}var jp=Bt(He());var DL=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function W8(M){let F=Cn(M),[H,z]=(0,jp.useState)(DL);return(0,jp.useEffect)(()=>{if(F)return Qe(F,"network-quality",ot=>z({uplinkNetworkQuality:ot.uplinkNetworkQuality,downlinkNetworkQuality:ot.downlinkNetworkQuality,delay:F.getRTCStats().RTT??0}));z(DL())},[F]),H}var PL=Bt(us()),yl=Bt(He());function H8(M,F=!0,H){let z=Cn(H),ot=Vr(H),bt=(0,yl.useRef)([]),[_t,de]=(0,yl.useState)(!1),[Jt,ft]=(0,yl.useState)(null),At=hi();return Oi(async()=>{if(At.current||(de(!1),ft(null)),!z||!ot||!F)return;let ee=M.filter(Boolean),xt=lt=>{let vt=vL(PL.default.VERSION,"4.18.2")>=0;return vt||new Ze("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),vt?z.mode!=="live"||z.role!=="audience":!0},fn=lt=>bt.current.some(vt=>vt&&vt.getTrackId()===lt.getTrackId()),sn=lt=>xt(lt)&&lt.enabled&&F&&!fn(lt);for(let lt=0;lt<ee.length;lt++){let vt=ee[lt];if(vt&&sn(vt)){await z.unpublish(bt.current.filter(Te=>Te?.trackMediaType===vt.trackMediaType));try{At.current||de(!0),await z.publish(vt)}catch(Te){console.error(Te),At.current||ft(new Ze("IAgoraRTCClient.publish",Te))}At.current||de(!1)}}bt.current=ee},[ot,F,z,M]),{isLoading:_t,error:Jt}}var Gp=Bt(He());function K8(M){let[F,H]=(0,Gp.useState)(0);return(0,Gp.useEffect)(()=>{if(M)return CL(()=>{H(M.getVolumeLevel())},1e3)},[M]),F}var LL=Bt(us()),Wp=Bt(He());function Y8(M=!0,F={ANS:!0,AEC:!0}){let[H,z]=(0,Wp.useState)(null),[ot,bt]=(0,Wp.useState)(!1),[_t,de]=(0,Wp.useState)(null),Jt=hi();return Oi(async()=>{if(Jt.current||(bt(!1),de(null)),M&&!H){try{Jt.current||bt(!0);let ft=await LL.default.createMicrophoneAudioTrack(F);Jt.current||z(ft)}catch(ft){console.error(ft),Jt.current||de(new Ze("IAgoraRTC.createMicrophoneAudioTrack",ft))}Jt.current||bt(!1)}},[M]),{localMicrophoneTrack:H,isLoading:ot,error:_t}}var kL=Bt(us()),Hp=Bt(He());function q8(M=!0,F){let[H,z]=(0,Hp.useState)(null),[ot,bt]=(0,Hp.useState)(!1),[_t,de]=(0,Hp.useState)(null),Jt=hi();return Oi(async()=>{if(Jt.current||(bt(!1),de(null)),M&&!H){try{Jt.current||bt(!0);let ft=await kL.default.createCameraVideoTrack(F);Jt.current||z(ft)}catch(ft){console.error(ft),Jt.current||de(new Ze("IAgoraRTC.createCameraVideoTrack",ft))}Jt.current||bt(!1)}},[M]),{localCameraTrack:H,isLoading:ot,error:_t}}var Kc=Bt(He());function z8(M,F){let H=Cn(F),[z,ot]=(0,Kc.useState)([]),bt=Vr(),_t=(0,Kc.useRef)([]),[de,Jt]=(0,Kc.useState)(!1),[ft,At]=(0,Kc.useState)(null),ee=hi();return Oi(async()=>{if(ee.current||At(null),!Array.isArray(M)||!bt)return;let xt=async lt=>{if(!lt.audioTrack&&M.some(({uid:vt})=>lt.uid===vt)){try{ee.current||Jt(!0),await H.subscribe(lt,"audio")}catch(vt){console.error(vt),ee.current||At(new Ze("IAgoraRTCClient.subscribe",vt))}lt.audioTrack&&!_t.current.some(vt=>vt.getUserId()===lt.uid)&&_t.current.push(lt.audioTrack),_t.current=_t.current.map(vt=>lt.audioTrack&&vt.getUserId()===lt.uid&&vt.getTrackId()!==lt.audioTrack.getTrackId()?lt.audioTrack:vt),ee.current||(ot([..._t.current]),Jt(!1))}},fn=async lt=>{if(M.some(({uid:vt})=>lt.uid===vt)){ee.current||(_t.current=_t.current.filter(vt=>vt.getUserId()!==lt.uid),ot([..._t.current]));try{ee.current||Jt(!0),await H.unsubscribe(lt,"audio")}catch(vt){console.error(vt),ee.current||At(new Ze("IAgoraRTCClient.unsubscribe",vt))}ee.current||Jt(!1)}};M.map(lt=>{!lt.audioTrack&&lt.hasAudio&&xt(lt)});let sn=[];for(let lt=0;lt<_t.current.length;lt++){let vt=_t.current[lt];if(!M.some(Te=>Te.uid===vt.getUserId())){let Te=H.remoteUsers.find(Ni=>Ni.uid===vt.getUserId());Te&&sn.push({user:Te,mediaType:"audio"}),_t.current.splice(lt,1),lt--}}if(sn.length>0){try{ee.current||Jt(!0),await H.massUnsubscribe(sn)}catch(lt){console.error(lt),ee.current||At(new Ze("IAgoraRTCClient.massUnsubscribe",lt))}ee.current||(ot(_t.current.slice()),Jt(!1))}return wi([Qe(H,"user-published",(lt,vt)=>{M.find(Te=>Te.uid===lt.uid)&&vt==="audio"&&xt(lt)}),Qe(H,"user-unpublished",(lt,vt)=>{M.find(Te=>Te.uid===lt.uid)&&vt==="audio"&&fn(lt)})])},[bt,H,M]),{audioTracks:z,isLoading:de,error:ft}}var Yc=Bt(He());function X8(M,F){let H=Cn(F),[z,ot]=(0,Yc.useState)([]),bt=Vr(),_t=(0,Yc.useRef)([]),[de,Jt]=(0,Yc.useState)(!1),[ft,At]=(0,Yc.useState)(null),ee=hi();return Oi(async()=>{if(ee.current||At(null),!Array.isArray(M)||!bt)return;let xt=async lt=>{if(!lt.videoTrack&&M.some(({uid:vt})=>lt.uid===vt)){try{ee.current||Jt(!0),await H.subscribe(lt,"video")}catch(vt){console.error(vt),ee.current||At(new Ze("IAgoraRTCClient.subscribe",vt))}lt.videoTrack&&!_t.current.some(vt=>vt.getUserId()===lt.uid)&&_t.current.push(lt.videoTrack),_t.current=_t.current.map(vt=>lt.videoTrack&&vt.getUserId()===lt.uid&&vt.getTrackId()!==lt.videoTrack.getTrackId()?lt.videoTrack:vt),ee.current||(ot([..._t.current]),Jt(!1))}},fn=async lt=>{if(M.some(({uid:vt})=>lt.uid===vt)){ee.current||(_t.current=_t.current.filter(vt=>vt.getUserId()!==lt.uid),ot([..._t.current]));try{ee.current||Jt(!0),await H.unsubscribe(lt,"video")}catch(vt){console.error(vt),ee.current||At(new Ze("IAgoraRTCClient.unsubscribe",vt))}ee.current||Jt(!1)}};M.map(lt=>{!lt.videoTrack&&lt.hasVideo&&xt(lt)});let sn=[];for(let lt=0;lt<_t.current.length;lt++){let vt=_t.current[lt];if(!M.some(Te=>Te.uid===vt.getUserId())){let Te=H.remoteUsers.find(Ni=>Ni.uid===vt.getUserId());Te&&sn.push({user:Te,mediaType:"video"}),_t.current.splice(lt,1),lt--}}if(sn.length>0){try{ee.current||Jt(!0),await H.massUnsubscribe(sn)}catch(lt){console.error(lt),ee.current||At(new Ze("IAgoraRTCClient.massUnsubscribe",lt))}ee.current||(ot(_t.current.slice()),Jt(!1))}return wi([Qe(H,"user-published",(lt,vt)=>{M.find(Te=>Te.uid===lt.uid)&&vt==="video"&&xt(lt)}),Qe(H,"user-unpublished",(lt,vt)=>{M.find(Te=>Te.uid===lt.uid)&&vt==="video"&&fn(lt)})])},[bt,H,M]),{videoTracks:z,isLoading:de,error:ft}}var ps=Bt(He());function Kp(M,F,H){let z=Cn(H),ot=F==="audio"?"audioTrack":"videoTrack",[bt,_t]=(0,ps.useState)(M&&M[ot]),de=Vr(),Jt=(0,ps.useRef)(),[ft,At]=(0,ps.useState)(!1),[ee,xt]=(0,ps.useState)(null);return(0,ps.useEffect)(()=>{if(!M||!de)return;let fn=!1;fn||xt(null);let sn=F==="audio"?"hasAudio":"hasVideo",lt=M.uid,vt=async(Jn,ho)=>{if(Jn[ot]&&z.remoteUsers.some(({uid:vn})=>Jn.uid===vn))try{fn||At(!0),await z.unsubscribe(Jn,ho)}catch(vn){fn||xt(new Ze("IAgoraRTCClient.unsubscribe",vn)),console.error(vn)}fn||(_t(void 0),At(!1))},Te=async(Jn,ho)=>{try{!Jn[ot]&&z.remoteUsers.some(({uid:vn})=>Jn.uid===vn)&&(fn||At(!0),await z.subscribe(Jn,ho)),fn||_t(Jn[ot])}catch(vn){fn||xt(new Ze("IAgoraRTCClient.subscribe",vn)),console.error(vn)}fn||At(!1)},Ni=Jt.current||=jc();return!M[ot]&&M[sn]?Ni.run(()=>Te(M,F)):_t(M[ot]),wi([()=>{fn=!0,Ni.dispose()},Qe(z,"user-published",(Jn,ho)=>{Jn.uid===lt&&ho===F&&Ni.run(()=>Te(Jn,F))}),Qe(z,"user-unpublished",(Jn,ho)=>{Jn.uid===lt&&ho===F&&Ni.run(()=>vt(Jn,F))})])},[de,z,M,F,ot]),{track:bt,isLoading:ft,error:ee}}var Yp=Bt(He());function J8(M){let F=Cn(M),[H,z]=(0,Yp.useState)(F?F.remoteUsers:[]);return(0,Yp.useEffect)(()=>{if(F){let ot=()=>z(F.remoteUsers.slice());return wi([Qe(F,"user-joined",ot),Qe(F,"user-left",ot),Qe(F,"user-published",ot),Qe(F,"user-unpublished",ot)])}},[F]),H}var ML=Bt(us()),qp=Bt(He());function Q8(M=!0,F,H){let[z,ot]=(0,qp.useState)(null),[bt,_t]=(0,qp.useState)(!1),[de,Jt]=(0,qp.useState)(null),ft=hi();return Oi(async()=>{if(ft.current||(_t(!1),Jt(null)),M&&!z){try{ft.current||_t(!0);let At=await ML.default.createScreenVideoTrack(F,H);ft.current||ot(At)}catch(At){console.error(At),ft.current||Jt(new Ze("IAgoraRTC.createScreenVideoTrack",At))}ft.current||_t(!1)}},[M]),{screenTrack:z,isLoading:bt,error:de}}var zp=Bt(He());var uo=Bt(He());var UL=Bt(Rn());function Z8(){let M=new Map,F=1500;return{onMount:H=>{let z=M.get(H);z&&(z(),M.delete(H))},onUnmount:H=>{let z=M.get(H);z&&z(),M.set(H,hs(()=>{H.isPlaying&&H.stop(),M.delete(H)},F))},dispose:()=>{for(let[H,z]of M)H.isPlaying&&H.stop(),z&&z();M.clear()}}}var VS=(0,uo.createContext)(void 0);function $8({children:M}){let[F]=(0,uo.useState)(Z8);return(0,uo.useEffect)(()=>F.dispose,[F]),(0,UL.jsx)(VS.Provider,{value:F,children:M})}function Il(M,F,H,z){let ot=(0,uo.useContext)(VS);(0,uo.useEffect)(()=>{if(M)return z&&F?M.play(z,H||void 0):M.stop(),ot?(ot.onMount(M),()=>ot.onUnmount(M)):()=>{M.isPlaying&&M.stop()}},[M,z,F,ot,H])}function Al(M,F){let H=(0,uo.useContext)(VS);Gc(()=>{if(M)return F?M.play():M.stop(),H?(H.onMount(M),()=>H.onUnmount(M)):()=>{M.isPlaying&&M.stop()}},[M,F,H])}var Xp=Bt(Rn());function FS({track:M,play:F=!1,volume:H,disabled:z,muted:ot,children:bt}){let _t=kp(M);return Al(_t,F),(0,zp.useEffect)(()=>{_t&&H!=null&&_t.setVolume(H)},[_t,H]),(0,zp.useEffect)(()=>{_t&&z!=null&&_t.setEnabled(!z).catch(console.warn)},[z,_t]),(0,zp.useEffect)(()=>{_t&&ot!=null&&_t.setMuted(ot).catch(console.warn)},[ot,_t]),bt?(0,Xp.jsx)(Xp.Fragment,{children:bt}):null}var bl=Bt(He());var xL=Bt(He()),Jp={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},Qp={width:"100%",height:"100%"},qc={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},_s=(M,F)=>(0,xL.useMemo)(()=>({...M,...F}),[M,F]);var VL=Bt(Rn());function BS({track:M,play:F,disabled:H,muted:z,style:ot,videoPlayerConfig:bt,..._t}){let de=_s(Qp,ot),[Jt,ft]=(0,bl.useState)(null),At=kp(M);return Il(At,F,bt,Jt),(0,bl.useEffect)(()=>{At&&H!=null&&At.setEnabled(!H).catch(console.warn)},[H,At]),(0,bl.useEffect)(()=>{At&&z!=null&&At.setMuted(z).catch(console.warn)},[z,At]),(0,VL.jsx)("div",{..._t,ref:ft,style:de})}var ms=Bt(Rn()),tY={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},eY={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function Zp({cover:M}){return(0,ms.jsx)("div",{style:qc,children:typeof M=="string"?(0,ms.jsxs)(ms.Fragment,{children:[(0,ms.jsx)("div",{style:{...tY,backgroundImage:`url(${M})`}}),(0,ms.jsx)("img",{src:M,style:eY})]}):M()})}var pa=Bt(Rn());function nY({micOn:M,cameraOn:F,audioTrack:H,videoTrack:z,playAudio:ot,playVideo:bt,volume:_t,cover:de,children:Jt,style:ft,...At}){let ee=_s(Jp,ft);return bt=bt??!!F,ot=ot??!!M,(0,pa.jsxs)("div",{...At,style:ee,children:[(0,pa.jsx)(BS,{disabled:!F,play:bt,track:z}),(0,pa.jsx)(FS,{disabled:!M,play:ot,track:H,volume:_t}),de&&!F&&(0,pa.jsx)(Zp,{cover:de}),(0,pa.jsx)("div",{style:qc,children:Jt})]})}var jS=Bt(He());var $p=Bt(Rn());function GS({track:M,play:F=!1,playbackDeviceId:H,volume:z,children:ot}){return Al(M,F),(0,jS.useEffect)(()=>{M&&H!=null&&M.setPlaybackDevice(H).catch(console.warn)},[M,H]),(0,jS.useEffect)(()=>{M&&z!=null&&M.setVolume(z)},[M,z]),ot?(0,$p.jsx)($p.Fragment,{children:ot}):null}var FL=Bt(He());var BL=Bt(Rn());function WS({track:M,play:F,style:H,videoPlayerConfig:z,...ot}){let bt=_s(Qp,H),[_t,de]=(0,FL.useState)(null);return Il(M,F,z,_t),(0,BL.jsx)("div",{...ot,ref:de,style:bt})}var _a=Bt(Rn());function iY({user:M,playVideo:F,playAudio:H,playbackDeviceId:z,volume:ot,cover:bt,style:_t,children:de,videoPlayerConfig:Jt,...ft}){let At=_s(Jp,_t),{track:ee}=Kp(M,"video"),{track:xt}=Kp(M,"audio");return F=F??M?.hasVideo,H=H??M?.hasAudio,(0,_a.jsxs)("div",{...ft,style:At,children:[(0,_a.jsx)(WS,{play:F,track:ee,videoPlayerConfig:Jt}),(0,_a.jsx)(GS,{play:H,playbackDeviceId:z,track:xt,volume:ot}),bt&&!F&&(0,_a.jsx)(Zp,{cover:bt}),(0,_a.jsx)("div",{style:qc,children:de})]})}var jL=Bt(us()),HS=class{appType=1001;constructor(){jL.default.setAppType(this.appType)}};new HS;var rY="2.5.1";lo(Fr,Bt(us()));var oY=GL.default;return y8(Fr);})();
/*! Bundled license information:

agora-rtc-sdk-ng/AgoraRTC_N-production.js:
  (*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> *)

react/cjs/react-jsx-runtime.production.min.js:
  (**
   * @license React
   * react-jsx-runtime.production.min.js
   *
   * Copyright (c) Facebook, Inc. and its affiliates.
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   *)
*/
